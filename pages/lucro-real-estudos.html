<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IMPOST — Estudo Tributário Lucro Real | Inteligência em Modelagem de Otimização Tributária</title>
  <meta name="description" content="Estudo tributário profissional do regime Lucro Real — IMPOST — Inteligência em Modelagem de Otimização Tributária">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300..700;1,9..40,300..700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">

  <style>
    /* ═══════════════════════════════════════════════════════════════════════════
       RESET & BASE
       ═══════════════════════════════════════════════════════════════════════════ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --primary: #2D8C4E;
      --primary-dark: #1E6B38;
      --primary-light: #38A85C;
      --secondary: #E8A838;
      --secondary-light: #F0C060;
      --accent: #2ECC71;
      --accent-dark: #27AE60;
      --danger: #E74C3C;
      --danger-light: #FADBD8;
      --warning: #F39C12;
      --warning-light: #FEF5E7;
      --info: #3498DB;
      --info-light: #EBF5FB;
      --purple: #9B59B6;

      --bg: #f4f6f8;
      --bg-gradient: linear-gradient(135deg, #f4f6f8 0%, #eef1f4 100%);
      --card-bg: #ffffff;
      --card-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
      --card-shadow-hover: 0 4px 24px rgba(0, 0, 0, 0.1);
      --card-radius: 12px;
      --input-border: #d0d5dd;
      --input-focus: #2D8C4E;
      --text: #1a1a2e;
      --text-secondary: #5a6170;
      --text-muted: #8b95a5;
      --border: #e2e6ea;
      --table-header: #2D8C4E;
      --table-stripe: #f7f9fb;
      --table-hover: #edf7f0;

      --font-body: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      --font-mono: 'JetBrains Mono', 'Fira Code', monospace;
      --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    html { scroll-behavior: smooth; }

    body {
      font-family: var(--font-body);
      background: var(--bg-gradient);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       LAYOUT PRINCIPAL
       ═══════════════════════════════════════════════════════════════════════════ */
    .app-header {
      background: #ffffff;
      color: var(--text);
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      position: relative;
      z-index: 100;
      border-bottom: 1px solid var(--border);
    }
    .app-header .logo {
      font-size: 1.6rem;
      font-weight: 700;
      letter-spacing: 1px;
      color: var(--text);
    }
    .app-header .logo-dot { color: var(--accent); }
    .app-header .header-sep {
      width: 1px;
      height: 24px;
      background: var(--border);
    }
    .app-header .header-title {
      font-size: 0.95rem;
      font-weight: 400;
      color: var(--text-secondary);
    }
    .app-header .header-version {
      /* margin-left: auto; — removido v1.1: coexiste com btn-dashboard */
      font-family: var(--font-mono);
      font-size: 0.75rem;
      background: var(--primary);
      color: #fff;
      padding: 0.2rem 0.6rem;
      border-radius: 12px;
      font-weight: 600;
    }
    .app-header .header-btn-dashboard {
      margin-left: auto;
      padding: 0.5rem 1.2rem;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-family: var(--font-body);
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      transition: var(--transition);
    }
    .app-header .header-btn-dashboard:hover {
      background: var(--primary-dark);
    }

    .app-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1.5rem 4rem;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       WIZARD — PROGRESS BAR
       ═══════════════════════════════════════════════════════════════════════════ */
    .wz-progress {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1.5rem 1rem;
      margin-bottom: 1.5rem;
      overflow-x: auto;
      gap: 0;
    }

    .wz-step-indicator {
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      min-width: 80px;
      transition: var(--transition);
    }
    .wz-step-indicator:hover .wz-step-num {
      transform: scale(1.1);
      box-shadow: 0 0 0 4px rgba(45, 140, 78, 0.15);
    }

    .wz-step-num {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.9rem;
      background: #e2e6ea;
      color: var(--text-muted);
      transition: var(--transition);
      border: 3px solid transparent;
    }
    .wz-step-indicator.active .wz-step-num {
      background: var(--primary);
      color: #fff;
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(45, 140, 78, 0.2);
    }
    .wz-step-indicator.done .wz-step-num {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent-dark);
    }

    .wz-step-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 6px;
      text-align: center;
      max-width: 90px;
      line-height: 1.3;
      font-weight: 500;
    }
    .wz-step-indicator.active .wz-step-label { color: var(--primary); font-weight: 700; }
    .wz-step-indicator.done .wz-step-label { color: var(--accent-dark); }

    .wz-step-line {
      flex: 1;
      height: 3px;
      background: #e2e6ea;
      min-width: 20px;
      max-width: 60px;
      margin: 0 4px;
      margin-bottom: 22px;
      border-radius: 2px;
      transition: var(--transition);
    }
    .wz-step-line.done {
      background: var(--accent);
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       WIZARD — CONTENT AREA
       ═══════════════════════════════════════════════════════════════════════════ */
    .wz-content {
      background: var(--card-bg);
      border-radius: var(--card-radius);
      box-shadow: var(--card-shadow);
      padding: 2rem;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .wz-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--border);
    }
    .wz-header-icon {
      font-size: 2rem;
      line-height: 1;
    }
    .wz-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--primary);
      margin: 0;
    }
    .wz-subtitle {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin: 2px 0 0;
    }

    .wz-form {
      margin-bottom: 1.5rem;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       WIZARD — SECTION TITLES
       ═══════════════════════════════════════════════════════════════════════════ */
    .wz-section-title {
      font-size: 1.05rem;
      font-weight: 700;
      color: var(--primary);
      margin: 1.8rem 0 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--accent);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .wz-section-title::before {
      content: '';
      display: inline-block;
      width: 4px;
      height: 20px;
      background: var(--accent);
      border-radius: 2px;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       WIZARD — ROWS & FIELDS
       ═══════════════════════════════════════════════════════════════════════════ */
    .wz-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 0;
    }

    .wz-field {
      margin-bottom: 1rem;
    }
    .wz-field > label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
    }

    .wz-input {
      width: 100%;
      padding: 0.6rem 0.85rem;
      border: 1.5px solid var(--input-border);
      border-radius: 8px;
      font-family: var(--font-body);
      font-size: 0.9rem;
      color: var(--text);
      background: #fff;
      transition: var(--transition);
      outline: none;
    }
    .wz-input:focus {
      border-color: var(--input-focus);
      box-shadow: 0 0 0 3px rgba(45, 140, 78, 0.12);
    }
    .wz-input:disabled {
      background: #f5f5f5;
      cursor: not-allowed;
      opacity: 0.7;
    }
    select.wz-input {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%235a6170' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 2rem;
    }
    textarea.wz-input {
      resize: vertical;
      min-height: 70px;
    }

    .wz-input-prefix, .wz-input-suffix {
      display: flex;
      align-items: stretch;
    }
    .wz-input-prefix > span, .wz-input-suffix > span {
      display: flex;
      align-items: center;
      padding: 0 0.7rem;
      background: var(--table-stripe);
      border: 1.5px solid var(--input-border);
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-secondary);
    }
    .wz-input-prefix > span {
      border-right: none;
      border-radius: 8px 0 0 8px;
    }
    .wz-input-prefix .wz-input {
      border-radius: 0 8px 8px 0;
    }
    .wz-input-suffix > span {
      border-left: none;
      border-radius: 0 8px 8px 0;
    }
    .wz-input-suffix .wz-input {
      border-radius: 8px 0 0 8px;
    }

    .wz-tip {
      display: block;
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 3px;
      line-height: 1.4;
    }

    .wz-field-error .wz-input {
      border-color: var(--danger);
      box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.12);
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       WIZARD — CHECKBOXES & RADIOS
       ═══════════════════════════════════════════════════════════════════════════ */
    .wz-field-check {
      margin-bottom: 0.8rem;
    }
    .wz-check-label {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      cursor: pointer;
      font-size: 0.88rem;
      font-weight: 500;
      user-select: none;
      padding: 0.4rem 0;
    }
    .wz-check-label input[type="checkbox"] {
      display: none;
    }
    .wz-checkmark {
      width: 20px;
      height: 20px;
      border: 2px solid var(--input-border);
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
      flex-shrink: 0;
      background: #fff;
    }
    .wz-check-label input:checked + .wz-checkmark {
      background: var(--primary);
      border-color: var(--primary);
    }
    .wz-check-label input:checked + .wz-checkmark::after {
      content: '✓';
      color: #fff;
      font-size: 0.7rem;
      font-weight: 700;
    }

    .wz-radio-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.3rem;
    }
    .wz-radio-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      font-size: 0.85rem;
      user-select: none;
      padding: 0.5rem 0.8rem;
      border: 1.5px solid var(--border);
      border-radius: 8px;
      transition: var(--transition);
      background: #fff;
    }
    .wz-radio-label:hover {
      border-color: var(--primary);
      background: var(--info-light);
    }
    .wz-radio-label input[type="radio"] {
      display: none;
    }
    .wz-radio-mark {
      width: 18px;
      height: 18px;
      border: 2px solid var(--input-border);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
      flex-shrink: 0;
    }
    .wz-radio-label input:checked + .wz-radio-mark {
      border-color: var(--primary);
    }
    .wz-radio-label input:checked + .wz-radio-mark::after {
      content: '';
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--primary);
    }
    .wz-radio-label:has(input:checked) {
      border-color: var(--primary);
      background: var(--info-light);
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       WIZARD — INFO BOXES & BADGES
       ═══════════════════════════════════════════════════════════════════════════ */
    .wz-info-box {
      padding: 0.85rem 1rem;
      border-radius: 8px;
      font-size: 0.85rem;
      line-height: 1.55;
      margin-bottom: 1rem;
      border-left: 4px solid var(--info);
      background: var(--info-light);
      color: var(--text);
    }
    .wz-info-box strong { color: var(--primary); }
    .wz-info-default { border-left-color: var(--info); background: var(--info-light); }
    .wz-info-success { border-left-color: var(--accent); background: #eafaf1; }
    .wz-info-warning { border-left-color: var(--warning); background: var(--warning-light); }
    .wz-info-gray { border-left-color: #bbb; background: #f5f5f5; }

    .wz-badge {
      display: inline-block;
      padding: 0.3rem 0.7rem;
      border-radius: 6px;
      font-size: 0.78rem;
      font-weight: 600;
      margin-top: 0.4rem;
    }
    .wz-badge-green { background: #eafaf1; color: var(--accent-dark); border: 1px solid #c3e6cb; }
    .wz-badge-red { background: var(--danger-light); color: var(--danger); border: 1px solid #f5c6cb; }
    .wz-badge-gray { background: #f5f5f5; color: #666; border: 1px solid #ddd; }
    .wz-badge-blue { background: var(--info-light); color: var(--info); border: 1px solid #b8daff; }

    /* ═══════════════════════════════════════════════════════════════════════════
       WIZARD — AUTO CALC BOXES
       ═══════════════════════════════════════════════════════════════════════════ */
    .wz-auto-calc {
      background: linear-gradient(135deg, #f7f9fb 0%, #edf2f7 100%);
      border: 1px solid var(--border);
      border-left: 4px solid var(--primary);
      border-radius: 8px;
      padding: 0.8rem 1rem;
      margin: 1rem 0;
      font-size: 0.85rem;
      line-height: 1.6;
      color: var(--text);
      font-family: var(--font-mono);
    }
    .wz-auto-calc strong { color: var(--primary); }

    /* ═══════════════════════════════════════════════════════════════════════════
       WIZARD — NAVIGATION
       ═══════════════════════════════════════════════════════════════════════════ */
    .wz-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.8rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border);
      flex-wrap: wrap;
    }

    .wz-btn {
      padding: 0.65rem 1.4rem;
      border: none;
      border-radius: 8px;
      font-family: var(--font-body);
      font-size: 0.88rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }
    .wz-btn:hover { transform: translateY(-1px); }
    .wz-btn:active { transform: translateY(0); }

    .wz-btn-next {
      background: var(--primary);
      color: #fff;
      box-shadow: 0 2px 8px rgba(45, 140, 78, 0.3);
    }
    .wz-btn-next:hover { background: var(--primary-light); }

    .wz-btn-back {
      background: transparent;
      color: var(--text-secondary);
      border: 1.5px solid var(--border);
    }
    .wz-btn-back:hover { background: var(--table-stripe); }

    .wz-btn-analyze {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
      color: #fff;
      font-size: 1rem;
      padding: 0.8rem 2rem;
      box-shadow: 0 4px 16px rgba(46, 204, 113, 0.35);
    }
    .wz-btn-analyze:hover { box-shadow: 0 6px 24px rgba(46, 204, 113, 0.45); }

    .wz-btn-fill {
      background: transparent;
      color: var(--warning);
      border: 1.5px solid var(--warning);
      font-size: 0.8rem;
      padding: 0.5rem 1rem;
    }
    .wz-btn-fill:hover { background: var(--warning-light); }

    .wz-btn-small {
      font-size: 0.78rem;
      padding: 0.35rem 0.7rem;
      background: transparent;
      color: var(--primary);
      border: 1px solid var(--border);
      border-radius: 6px;
    }
    .wz-btn-small:hover { background: var(--info-light); }

    /* ═══════════════════════════════════════════════════════════════════════════
       WIZARD — MISC
       ═══════════════════════════════════════════════════════════════════════════ */
    .wz-error {
      background: var(--danger-light);
      border: 2px solid var(--danger);
      border-radius: var(--card-radius);
      padding: 2rem;
      text-align: center;
      color: var(--danger);
    }
    .wz-error h2 { margin-bottom: 0.5rem; }

    .wz-resumo {
      background: var(--table-stripe);
      border-radius: 8px;
      padding: 1.2rem;
      margin-bottom: 1.5rem;
    }
    .wz-resumo-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    .wz-resumo-table td {
      padding: 0.4rem 0.6rem;
      border-bottom: 1px solid var(--border);
    }
    .wz-resumo-table strong { color: var(--primary); }
    .wz-resumo-editar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .wz-municipio-loading {
      font-size: 0.8rem;
      color: var(--info);
      padding: 0.3rem 0;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .wz-iss-dica {
      font-size: 0.8rem;
      padding: 0.4rem 0;
    }

    .wz-adm-impact {
      font-size: 0.8rem;
      color: var(--danger);
      font-weight: 600;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       ACTION BAR (FIXED WHEN REPORT VISIBLE)
       ═══════════════════════════════════════════════════════════════════════════ */
    .action-bar {
      position: sticky;
      top: 0;
      z-index: 200;
      background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
      padding: 0.7rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.6rem;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      flex-wrap: wrap;
      margin: -2rem -1.5rem 2rem;
      border-radius: 0 0 var(--card-radius) var(--card-radius);
    }
    .action-bar .action-label {
      font-size: 0.82rem;
      color: rgba(255,255,255,0.6);
      font-weight: 600;
      margin-right: 0.5rem;
      white-space: nowrap;
    }
    .action-bar .ab-btn {
      padding: 0.5rem 1rem;
      border: 1.5px solid rgba(255,255,255,0.25);
      border-radius: 8px;
      background: rgba(255,255,255,0.08);
      color: #fff;
      font-family: var(--font-body);
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }
    .ab-btn:hover {
      background: rgba(255,255,255,0.18);
      border-color: rgba(255,255,255,0.5);
      transform: translateY(-1px);
    }
    .ab-btn.ab-btn-primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }
    .ab-btn.ab-btn-primary:hover {
      background: var(--accent-dark);
    }
    .ab-btn.ab-btn-success {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }
    .ab-btn.ab-btn-success:hover {
      background: var(--accent-dark);
    }
    .action-bar .ab-spacer { flex: 1; }

    /* ═══════════════════════════════════════════════════════════════════════════
       RESULTADOS — HEADER
       ═══════════════════════════════════════════════════════════════════════════ */
    .res-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: #fff;
      padding: 2rem 2.5rem;
      border-radius: var(--card-radius);
      margin-bottom: 2rem;
      position: relative;
      overflow: hidden;
    }
    .res-header::after {
      content: '';
      position: absolute;
      top: 0; right: 0; bottom: 0;
      width: 40%;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='80' cy='20' r='40' fill='rgba(232,168,56,0.06)'/%3E%3Ccircle cx='60' cy='70' r='30' fill='rgba(46,204,113,0.04)'/%3E%3C/svg%3E") no-repeat center;
      background-size: cover;
      pointer-events: none;
    }
    .res-logo { margin-bottom: 0.8rem; }
    .res-logo img { max-height: 50px; }
    .res-title {
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: 0.5px;
      margin-bottom: 0.3rem;
    }
    .res-subtitle { font-size: 0.9rem; opacity: 0.8; }
    .res-header-line {
      width: 60px;
      height: 3px;
      background: var(--accent);
      border-radius: 2px;
      margin: 1rem 0;
    }
    .res-company {
      font-size: 0.88rem;
      line-height: 1.8;
    }
    .res-company-row strong { color: var(--accent); }
    .res-elaborador {
      margin-top: 1rem;
      padding-top: 0.8rem;
      border-top: 1px solid rgba(255,255,255,0.15);
      font-size: 0.82rem;
      opacity: 0.9;
    }
    .res-powered {
      margin-top: 0.8rem;
      font-size: 0.72rem;
      font-family: var(--font-mono);
      opacity: 0.5;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       RESULTADOS — SECTIONS
       ═══════════════════════════════════════════════════════════════════════════ */
    .res-section {
      background: var(--card-bg);
      border-radius: var(--card-radius);
      box-shadow: var(--card-shadow);
      margin-bottom: 1.5rem;
      overflow: hidden;
    }
    .res-section-title {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: #fff;
      padding: 1rem 1.5rem;
      font-size: 1.05rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.7rem;
      margin: 0;
    }
    .res-section-num {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      font-size: 0.85rem;
      font-weight: 700;
      flex-shrink: 0;
    }
    .res-section-body {
      padding: 1.5rem;
    }
    .res-section-body h3 {
      font-size: 1rem;
      font-weight: 700;
      color: var(--primary);
      margin: 1.5rem 0 0.8rem;
      padding-bottom: 0.4rem;
      border-bottom: 1px solid var(--border);
    }
    .res-section-body h3:first-child { margin-top: 0; }
    .res-section-body h4 {
      font-size: 0.92rem;
      font-weight: 700;
      color: var(--primary);
      margin: 1.2rem 0 0.6rem;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       RESULTADOS — SUMMARY CARDS
       ═══════════════════════════════════════════════════════════════════════════ */
    .res-summary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin-bottom: 0.5rem;
    }
    .res-summary-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1.2rem;
      text-align: center;
      transition: var(--transition);
    }
    .res-summary-card:hover {
      box-shadow: var(--card-shadow-hover);
      transform: translateY(-2px);
    }
    .res-card-hero {
      border-color: var(--accent);
      border-width: 2px;
      background: linear-gradient(135deg, #eafaf1 0%, #fff 100%);
    }
    .res-card-label {
      font-size: 0.68rem;
      font-weight: 700;
      letter-spacing: 0.8px;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 0.5rem;
    }
    .res-card-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      font-family: var(--font-mono);
      line-height: 1.2;
    }
    .res-card-economia { color: var(--accent-dark) !important; }
    .res-card-sub {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.3rem;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       RESULTADOS — TABLES
       ═══════════════════════════════════════════════════════════════════════════ */
    .res-table-wrap {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .res-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      margin-bottom: 1rem;
    }
    .res-table thead th {
      background: var(--table-header);
      color: #fff;
      padding: 0.65rem 0.8rem;
      text-align: left;
      font-weight: 600;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: sticky;
      top: 0;
    }
    .res-table thead th:first-child { border-radius: 8px 0 0 0; }
    .res-table thead th:last-child { border-radius: 0 8px 0 0; }
    .res-table td {
      padding: 0.55rem 0.8rem;
      border-bottom: 1px solid var(--border);
    }
    .res-table tbody tr:nth-child(even) { background: var(--table-stripe); }
    .res-table tbody tr:hover { background: var(--table-hover); }
    .res-table tfoot td, .res-table tfoot th {
      padding: 0.7rem 0.8rem;
      font-weight: 700;
    }

    .res-valor {
      text-align: right;
      font-family: var(--font-mono);
      font-weight: 600;
      white-space: nowrap;
    }
    .res-artigo {
      font-size: 0.7rem;
      color: var(--text-muted);
      font-style: italic;
    }

    .res-sub td { padding-left: 1.5rem; font-size: 0.82rem; }
    .res-subtotal td { font-weight: 700; background: var(--table-stripe) !important; }
    .res-total td, .res-total th { font-weight: 700; background: var(--primary) !important; color: #fff !important; }
    .res-total .res-valor { color: #fff !important; }
    .res-destaque { background: linear-gradient(90deg, #eafaf1, #fff) !important; }
    .res-economia { color: var(--accent-dark) !important; }
    .res-economia .res-valor { color: var(--accent-dark) !important; }
    .res-group-header td { font-weight: 700; background: #f0f4f8 !important; color: var(--primary); padding-top: 0.8rem; }
    .res-info-row td { font-size: 0.8rem; color: var(--text-muted); font-style: italic; background: var(--table-stripe) !important; }
    .res-tag-tipo-t { font-size: 0.68rem; padding: 0.15rem 0.4rem; border-radius: 4px; background: var(--warning-light); color: var(--warning); font-weight: 600; }
    .res-tag-tipo-c { font-size: 0.68rem; padding: 0.15rem 0.4rem; border-radius: 4px; background: var(--info-light); color: var(--info); font-weight: 600; }

    /* .res-table-dre, .res-table-lalur — reservado para estilos futuros */
    /* .res-dre, .res-lalur — reservado para estilos futuros */

    .res-info-msg {
      font-size: 0.88rem;
      color: var(--text-muted);
      font-style: italic;
      padding: 1rem;
      text-align: center;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       RESULTADOS — DETAIL GRID (Tributos)
       ═══════════════════════════════════════════════════════════════════════════ */
    .res-detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.2rem;
    }
    .res-detail-card {
      background: var(--table-stripe);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1.2rem;
    }
    .res-detail-card h3 {
      margin-top: 0 !important;
      border-bottom: none !important;
    }
    .res-detail-wide {
      grid-column: span 2;
    }
    .res-detail-row { display: flex; justify-content: space-between; padding: 0.3rem 0; }
    .res-detail-label { font-size: 0.85rem; color: var(--text-secondary); }
    .res-detail-value { font-family: var(--font-mono); font-weight: 600; }
    .res-detail-total { font-weight: 700; border-top: 2px solid var(--primary); padding-top: 0.5rem; margin-top: 0.5rem; }

    /* ═══════════════════════════════════════════════════════════════════════════
       RESULTADOS — COMPOSIÇÃO VISUAL BAR
       ═══════════════════════════════════════════════════════════════════════════ */
    .res-composicao-visual { margin-bottom: 1.5rem; }
    .res-comp-bar {
      display: flex;
      height: 36px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }
    .res-comp-seg {
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 0.7rem;
      font-weight: 700;
      letter-spacing: 0.5px;
      min-width: 40px;
      transition: var(--transition);
    }
    .res-comp-seg:hover { filter: brightness(1.15); }

    /* ═══════════════════════════════════════════════════════════════════════════
       RESULTADOS — MAPA DE ECONOMIA (Antes × Depois)
       ═══════════════════════════════════════════════════════════════════════════ */
    /* .res-mapa-economia — reservado para estilos futuros */
    .res-mapa-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1.5rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }
    .res-mapa-card {
      flex: 1;
      min-width: 200px;
      max-width: 280px;
      padding: 1.5rem;
      border-radius: 12px;
      text-align: center;
    }
    .res-mapa-card-label { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem; }
    .res-mapa-card-value { font-size: 1.6rem; font-weight: 700; font-family: var(--font-mono); }
    .res-mapa-card-sub { font-size: 0.8rem; margin-top: 0.3rem; }
    .res-mapa-antes {
      background: linear-gradient(135deg, #fdecea, #fff);
      border: 2px solid var(--danger);
      color: var(--danger);
    }
    .res-mapa-antes .res-mapa-card-label { color: var(--danger); }
    .res-mapa-depois {
      background: linear-gradient(135deg, #eafaf1, #fff);
      border: 2px solid var(--accent);
      color: var(--accent-dark);
    }
    .res-mapa-depois .res-mapa-card-label { color: var(--accent-dark); }
    .res-mapa-seta {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.3rem;
      flex-shrink: 0;
    }
    .res-mapa-seta-valor {
      font-family: var(--font-mono);
      font-weight: 700;
      color: var(--accent-dark);
      font-size: 0.95rem;
    }
    .res-mapa-seta-icon {
      font-size: 2rem;
      color: var(--accent);
    }
    .res-mapa-breakdown { margin-top: 1rem; }
    .res-mapa-projecoes { margin-top: 1.5rem; }

    /* ═══════════════════════════════════════════════════════════════════════════
       RESULTADOS — OPORTUNIDADES
       ═══════════════════════════════════════════════════════════════════════════ */
    /* .res-oportunidades — reservado para estilos futuros */
    .res-oport-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-bottom: 1rem;
      overflow: hidden;
      transition: var(--transition);
    }
    .res-oport-card:hover { box-shadow: var(--card-shadow-hover); }
    .res-oport-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem 1.2rem;
      background: var(--table-stripe);
      border-bottom: 1px solid var(--border);
    }
    .res-oport-rank {
      font-family: var(--font-mono);
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--primary);
      background: #fff;
      width: 42px;
      height: 42px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--primary);
      flex-shrink: 0;
    }
    .res-oport-titulo {
      flex: 1;
      font-weight: 700;
      font-size: 0.95rem;
      color: var(--text);
    }
    .res-oport-valor {
      font-family: var(--font-mono);
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--accent-dark);
      white-space: nowrap;
    }
    .res-oport-valor span { font-size: 0.72rem; color: var(--text-muted); font-family: var(--font-body); }
    .res-oport-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      padding: 0.6rem 1.2rem;
    }
    .res-tag {
      font-size: 0.7rem;
      font-weight: 600;
      padding: 0.25rem 0.6rem;
      border-radius: 20px;
      color: #fff;
    }
    /* .res-tag-tipo — reservado */
    /* .res-tag-compl — reservado */
    /* .res-tag-risco — reservado */
    .res-oport-body {
      padding: 0.8rem 1.2rem 1rem;
      font-size: 0.85rem;
      line-height: 1.6;
    }
    .res-oport-legal {
      font-size: 0.78rem;
      color: var(--text-muted);
      font-style: italic;
      margin-top: 0.5rem;
    }
    .res-oport-acao {
      background: #eafaf1;
      border-radius: 6px;
      padding: 0.5rem 0.8rem;
      margin-top: 0.6rem;
      font-size: 0.82rem;
      border-left: 3px solid var(--accent);
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       RESULTADOS — ALERTAS
       ═══════════════════════════════════════════════════════════════════════════ */
    /* .res-alertas — reservado para estilos futuros */
    .res-alerta {
      display: flex;
      align-items: flex-start;
      gap: 0.7rem;
      padding: 0.8rem 1rem;
      border-radius: 8px;
      margin-bottom: 0.7rem;
      font-size: 0.85rem;
      line-height: 1.5;
      border-left: 4px solid;
    }
    .res-alerta-icon { font-size: 1.1rem; flex-shrink: 0; line-height: 1.3; }
    .res-alerta-critico { border-left-color: var(--danger); background: var(--danger-light); }
    .res-alerta-aviso { border-left-color: var(--warning); background: var(--warning-light); }
    .res-alerta-info { border-left-color: var(--info); background: var(--info-light); }
    .res-alerta-economia { border-left-color: var(--accent); background: #eafaf1; }

    /* ═══════════════════════════════════════════════════════════════════════════
       RESULTADOS — CENÁRIOS
       ═══════════════════════════════════════════════════════════════════════════ */
    /* .res-cenarios — reservado para estilos futuros */
    .res-cenario-base td { font-weight: 700; }
    .res-cenario-pessimista td { color: var(--danger); }
    .res-cenario-otimista td { color: var(--accent-dark); }

    /* ═══════════════════════════════════════════════════════════════════════════
       RESULTADOS — FLUXO MENSAL
       ═══════════════════════════════════════════════════════════════════════════ */
    .res-fluxo-mensal { font-size: 0.8rem; }
    .res-fluxo-mensal td { padding: 0.4rem 0.5rem; }

    /* ═══════════════════════════════════════════════════════════════════════════
       RESULTADOS — RECOMENDAÇÃO
       ═══════════════════════════════════════════════════════════════════════════ */
    .res-recomendacao, .res-trimestral-recomendacao {
      background: linear-gradient(135deg, #edf2f7, #fff);
      border-radius: 10px;
      padding: 1.2rem;
      margin-top: 1rem;
    }
    .res-recomendacao h4, .res-trimestral-recomendacao h4 {
      color: var(--primary);
      margin-bottom: 0.5rem;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       RESULTADOS — OBRIGAÇÕES
       ═══════════════════════════════════════════════════════════════════════════ */
    /* .res-obrigacoes — reservado para estilos futuros */
    /* .res-darf-table — reservado para estilos futuros */

    /* ═══════════════════════════════════════════════════════════════════════════
       RESULTADOS — TIMELINE
       ═══════════════════════════════════════════════════════════════════════════ */
    .res-timeline {
      position: relative;
      padding-left: 40px;
    }
    .res-timeline::before {
      content: '';
      position: absolute;
      left: 18px;
      top: 0;
      bottom: 0;
      width: 3px;
      background: var(--border);
      border-radius: 2px;
    }
    .res-timeline-item {
      position: relative;
      margin-bottom: 1.5rem;
      display: flex;
      gap: 1rem;
    }
    .res-timeline-marker {
      position: absolute;
      left: -40px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--primary);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.85rem;
      z-index: 1;
      box-shadow: 0 2px 8px rgba(45, 140, 78, 0.3);
    }
    .res-timeline-content {
      flex: 1;
      background: var(--table-stripe);
      border-radius: 8px;
      padding: 0.8rem 1rem;
      border-left: 3px solid var(--primary);
    }
    .res-timeline-titulo { font-weight: 700; color: var(--text); margin-bottom: 0.3rem; }
    .res-timeline-prazo {
      font-size: 0.75rem;
      color: var(--info);
      font-family: var(--font-mono);
    }
    .res-timeline-desc { font-size: 0.83rem; color: var(--text-secondary); }

    /* ═══════════════════════════════════════════════════════════════════════════
       RESULTADOS — CHARTS
       ═══════════════════════════════════════════════════════════════════════════ */
    .res-chart-container {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1.2rem;
      margin: 1rem 0;
    }
    .res-chart-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    .res-chart-aliquota {
      max-width: 250px;
      margin: 0 auto 2rem;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       RESULTADOS — FOOTER & ACTIONS
       ═══════════════════════════════════════════════════════════════════════════ */
    .res-footer {
      text-align: center;
      padding-top: 1rem;
    }
    .res-footer-elaborador { font-weight: 600; margin-bottom: 0.3rem; }
    .res-footer-data { font-size: 0.82rem; color: var(--text-secondary); }
    .res-footer-base { font-size: 0.72rem; color: var(--text-muted); margin-top: 0.8rem; }
    .res-footer-disclaimer {
      font-size: 0.75rem;
      color: var(--text-muted);
      font-style: italic;
      margin-top: 0.5rem;
      padding: 0.8rem;
      background: var(--table-stripe);
      border-radius: 6px;
    }
    .res-footer-marca {
      font-size: 0.7rem;
      font-family: var(--font-mono);
      color: var(--text-muted);
      margin-top: 0.5rem;
    }
    .res-actions {
      display: flex;
      justify-content: center;
      gap: 0.8rem;
      flex-wrap: wrap;
      margin-top: 1.5rem;
    }
    .res-btn {
      padding: 0.6rem 1.4rem;
      border: 1.5px solid var(--primary);
      border-radius: 8px;
      background: transparent;
      color: var(--primary);
      font-family: var(--font-body);
      font-size: 0.88rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }
    .res-btn:hover {
      background: var(--primary);
      color: #fff;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       TOTAL DESTAQUE
       ═══════════════════════════════════════════════════════════════════════════ */
    .res-total-destaque {
      font-size: 1rem;
      font-weight: 700;
      color: var(--primary);
      margin-top: 0.5rem;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       LOADING OVERLAY
       ═══════════════════════════════════════════════════════════════════════════ */
    .export-loading {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }
    .export-loading-inner {
      background: #fff;
      border-radius: 12px;
      padding: 2rem 3rem;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    .export-loading-inner .spinner {
      width: 40px; height: 40px;
      border: 4px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 1rem;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ═══════════════════════════════════════════════════════════════════════════
       CNAE AUTOCOMPLETE — Override tema escuro injetado pelo JS
       O JS injeta .cnae-dropdown com cores escuras (bg #1a2236). Aqui
       sobrescrevemos com o design system claro usando especificidade maior.
       ═══════════════════════════════════════════════════════════════════════════ */
    .app-container .cnae-dropdown {
      background: var(--card-bg);
      border: 1.5px solid var(--input-border);
      box-shadow: var(--card-shadow-hover);
    }
    .app-container .cnae-dropdown-item {
      color: var(--text);
      border-bottom-color: var(--border);
    }
    .app-container .cnae-dropdown-item:hover,
    .app-container .cnae-dropdown-item.active {
      background: var(--table-hover);
      color: var(--primary);
    }
    .app-container .cnae-dropdown-item .cnae-code {
      color: var(--primary);
    }
    .app-container .cnae-dropdown-item .cnae-cat {
      color: var(--text-muted);
    }
    .app-container .cnae-dropdown-empty {
      color: var(--text-muted);
    }
    .app-container .cnae-dropdown::-webkit-scrollbar {
      width: 6px;
    }
    .app-container .cnae-dropdown::-webkit-scrollbar-track {
      background: var(--table-stripe);
      border-radius: 3px;
    }
    .app-container .cnae-dropdown::-webkit-scrollbar-thumb {
      background: var(--input-border);
      border-radius: 3px;
    }
    .app-container .cnae-dropdown::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       RESPONSIVE
       ═══════════════════════════════════════════════════════════════════════════ */
    @media (max-width: 768px) {
      .app-container { padding: 1rem 0.8rem 3rem; }
      .wz-row { grid-template-columns: 1fr; }
      .wz-content { padding: 1.2rem; }
      .wz-progress { gap: 0; padding: 1rem 0.5rem; }
      .wz-step-indicator { min-width: 50px; }
      .wz-step-label { font-size: 0.6rem; max-width: 55px; }
      .wz-step-num { width: 32px; height: 32px; font-size: 0.75rem; }
      .wz-nav { gap: 0.5rem; }
      .wz-btn { font-size: 0.8rem; padding: 0.55rem 1rem; }

      .res-summary { grid-template-columns: 1fr 1fr; }
      .res-card-value { font-size: 1.1rem; }
      .res-detail-grid { grid-template-columns: 1fr; }
      .res-detail-wide { grid-column: span 1; }
      .res-chart-row { grid-template-columns: 1fr; }
      .res-mapa-row { flex-direction: column; }
      .res-mapa-seta { transform: rotate(90deg); }
      .res-oport-header { flex-wrap: wrap; }
      .res-oport-valor { width: 100%; text-align: right; }
      .res-header { padding: 1.5rem; }
      .res-title { font-size: 1.1rem; }

      .action-bar { padding: 0.5rem 0.8rem; gap: 0.4rem; }
      .action-bar .action-label { display: none; }
      .ab-btn { font-size: 0.72rem; padding: 0.4rem 0.7rem; }
    }
    @media (max-width: 480px) {
      .res-summary { grid-template-columns: 1fr; }
      .res-table { font-size: 0.75rem; }
      .res-table td, .res-table th { padding: 0.4rem 0.5rem; }
      .wz-radio-group { flex-direction: column; }
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       PRINT STYLES
       ═══════════════════════════════════════════════════════════════════════════ */
    @media print {
      body { background: #fff !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .app-header, .action-bar, .wz-nav, .res-actions, .res-btn, .ab-btn { display: none !important; }
      #wizardContainer { display: none !important; }
      #resultadosContainer { display: block !important; }
      .app-container { max-width: 100%; padding: 0; margin: 0; }

      .res-section {
        page-break-inside: avoid;
        break-inside: avoid;
        box-shadow: none !important;
        border: 1px solid #ddd;
        margin-bottom: 1rem;
      }
      .res-header {
        page-break-after: avoid;
        background: var(--primary) !important;
      }
      .res-chart-container {
        page-break-inside: avoid;
        break-inside: avoid;
        max-height: 350px;
      }
      .res-oport-card { page-break-inside: avoid; break-inside: avoid; }
      .res-summary-card { border: 1px solid #ccc; }
      .res-total td { background: var(--primary) !important; color: #fff !important; }
      .res-section-title { background: var(--primary) !important; color: #fff !important; }

      @page {
        margin: 1.5cm;
        size: A4;
      }
    }
  </style>
</head>
<body>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       APP HEADER
       ═══════════════════════════════════════════════════════════════════════════ -->
  <header class="app-header">
    <div class="logo">IMPOST<span class="logo-dot">.</span></div>
    <div class="header-sep"></div>
    <span class="header-title">Estudo Tributário — Lucro Real</span>
    <span class="header-version" id="versionBadge">v3.4</span>
    <a class="header-btn-dashboard" href="dashboard.html">← Dashboard</a>
  </header>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       CONTAINERS PRINCIPAIS
       ═══════════════════════════════════════════════════════════════════════════ -->
  <div class="app-container">
    <div id="wizardContainer"></div>
    <div id="resultadosContainer" style="display:none"></div>
  </div>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       SCRIPTS — Ordem OBRIGATÓRIA (dependências em cascata)
       
       1. estados.js       → window.Estados (dados de 27 UFs)
       2. municipios.js    → API IBGE (depende de estados.js para siglas)
       3. motor v4.6       → window.MotorLR (cálculos puros, sem dependência)
       4. mapeamento v3.3  → window.LR (ponte motor↔HTML, lê de Estados via LR.setEstado)
       5-7. Libs externas  → Chart.js, html2pdf, SheetJS
       8. estudos.js       → window.LucroRealEstudos (wizard, depende de TODOS acima)
       9. Script inline    → Ponte HTML↔LR.setEstado + action bar
       
       ⚠ NÃO reordenar: mapeamento.js usa estados.js e motor; estudos.js usa todos.
       ═══════════════════════════════════════════════════════════════════════════ -->
  <!-- ═══ AUTH ═══ -->
  <script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore-compat.js"></script>
  <script src="../scripts/auth/firebase-config.js"></script>
  <script src="../scripts/auth/auth-guard.js"></script>
  <script src="../scripts/auth/user-service.js"></script>

  <!-- 1. Dados de estados (window.Estados / window.EstadosBR) -->
  <!-- v3.3 FIX E3#2: onerror handler para dependências -->
  <script src="../scripts/dados/estados.js" onerror="console.warn('[IMPOST] estados.js não carregado — ISS/SUDAM/SUDENE usarão dados estáticos do mapeamento'); window._depFalha = (window._depFalha||[]); window._depFalha.push('estados.js');"></script>
  <!-- 2. Municípios via API IBGE (depende de estados.js) -->
  <script src="../scripts/dados/municipios.js" onerror="console.warn('[IMPOST] municipios.js não carregado — municípios indisponíveis'); window._depFalha = (window._depFalha||[]); window._depFalha.push('municipios.js');"></script>
  <!-- 3. Motor fiscal unificado v4.6 (cálculos puros, sem dependência) -->
  <!-- v3.3 FIX E3#1: onerror handler para motor fiscal — ativa fallback silencioso -->
  <script src="../scripts/calculadoras/lucro-real/motor-lucro-real-v4.6-unificado.js" onerror="console.error('[IMPOST] Motor fiscal não carregado — todos os cálculos usarão fallback simplificado'); window._motorFiscalFalhou = true; window._depFalha = (window._depFalha||[]); window._depFalha.push('motor-lucro-real-v4.6-unificado.js');"></script>
  <!-- 4. Mapeamento unificado v3.3 (ponte motor↔HTML, lê de estados.js via LR.setEstado) -->
  <script src="../scripts/calculadoras/lucro-real/lucro-real-mapeamento.js" onerror="console.error('[IMPOST] Mapeamento não carregado — sistema não funcional'); window._depFalha = (window._depFalha||[]); window._depFalha.push('lucro-real-mapeamento.js');"></script>
  <!-- 5. Chart.js 4.4 CDN com fallback -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"
    onerror="this.onerror=null;this.src='https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.7/chart.umd.min.js';console.warn('[IMPOST] Chart.js CDN primário falhou, tentando fallback');"></script>
  <!-- 6. html2pdf.js para exportação PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"
    onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js';console.warn('[IMPOST] html2pdf CDN primário falhou, tentando fallback');window._depFalha=(window._depFalha||[]);window._depFalha.push('html2pdf.js');"></script>
  <!-- 7. SheetJS para exportação Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"
    onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';console.warn('[IMPOST] SheetJS CDN primário falhou, tentando fallback');window._depFalha=(window._depFalha||[]);window._depFalha.push('xlsx.js');"></script>
  <!-- 8. Motor principal do wizard (depende de TODOS acima) -->
  <script src="../scripts/calculadoras/lucro-real/lucro-real-estudos.js" onerror="console.error('[IMPOST] estudos.js não carregado — wizard não funcional'); window._depFalha = (window._depFalha||[]); window._depFalha.push('lucro-real-estudos.js');"></script>

  <!-- Sincronizar versão do badge com o JS -->
  <script>
  (function() {
    'use strict';
    function syncVersion() {
      var badge = document.getElementById('versionBadge');
      if (!badge) return;
      if (typeof LucroRealEstudos !== 'undefined' && LucroRealEstudos.VERSAO) {
        badge.textContent = 'v' + LucroRealEstudos.VERSAO;
      }
    }
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', syncVersion);
    } else {
      setTimeout(syncVersion, 50);
    }
  })();
  </script>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       BARRA DE AÇÕES — Injeção via MutationObserver
       (Exportação PDF/Excel delegada ao lucro-real-estudos.js v2.1.0)
       ═══════════════════════════════════════════════════════════════════════════ -->
  <script>
  (function () {
    'use strict';

    // ═══════════════════════════════════════════════════════════════════════
    //  HELPERS
    //  NOTA v1.1: _m e _pp removidos — eram cópias de LR.helpers.formatarMoeda()
    //  e LR.helpers.formatarPercentual(), nunca utilizados neste inline.
    // ═══════════════════════════════════════════════════════════════════════

    // ═══════════════════════════════════════════════════════════════════════
    //  INJETAR BARRA DE AÇÕES QUANDO RESULTADOS APARECEM
    // ═══════════════════════════════════════════════════════════════════════

    // REMOVIDO v1.1: var originalRender = null; — código morto da refatoração v2.0

    function injectActionBar() {
      var resContainer = document.getElementById('resultadosContainer');
      if (!resContainer) return;

      // Observar quando resultados ficam visíveis
      var observer = new MutationObserver(function (mutations) {
        mutations.forEach(function (m) {
          if (m.attributeName === 'style') {
            var visible = resContainer.style.display !== 'none';
            var existingBar = document.getElementById('actionBar');
            if (visible && !existingBar) {
              createActionBar(resContainer);
            } else if (!visible && existingBar) {
              existingBar.remove();
            }
          }
        });
      });
      observer.observe(resContainer, { attributes: true, attributeFilter: ['style'] });

      // Observar childList para quando innerHTML é setado
      var childObserver = new MutationObserver(function () {
        if (resContainer.style.display !== 'none' && resContainer.children.length > 0) {
          if (!document.getElementById('actionBar')) {
            createActionBar(resContainer);
          }
        }
      });
      childObserver.observe(resContainer, { childList: true });
    }

    function createActionBar(container) {
      var bar = document.createElement('div');
      bar.id = 'actionBar';
      bar.className = 'action-bar';
      bar.innerHTML =
        '<span class="action-label">AÇÕES</span>' +
        '<button class="ab-btn" onclick="typeof LucroRealEstudos!==\'undefined\'&&LucroRealEstudos.voltarWizard()" title="Voltar ao formulário">← Editar Dados</button>' +
        '<button class="ab-btn ab-btn-primary" onclick="typeof LucroRealEstudos!==\'undefined\'&&LucroRealEstudos.pdfSimplificado()" title="PDF resumido para o empresário">📄 Relatório Simplificado</button>' +
        '<button class="ab-btn ab-btn-primary" onclick="typeof LucroRealEstudos!==\'undefined\'&&LucroRealEstudos.pdfCompleto()" title="PDF técnico completo para o contador">📋 Relatório Completo</button>' +
        '<button class="ab-btn ab-btn-success" onclick="typeof LucroRealEstudos!==\'undefined\'&&LucroRealEstudos.exportarExcel()" title="Planilha com 14 abas">📊 Exportar Excel</button>' +
        '<span class="ab-spacer"></span>' +
        '<button class="ab-btn" onclick="typeof LucroRealEstudos!==\'undefined\'&&LucroRealEstudos.exportarJSON()" title="Dados brutos em JSON">💾 JSON</button>' +
        '<button class="ab-btn" onclick="typeof LucroRealEstudos!==\'undefined\'&&LucroRealEstudos.novoEstudo()" title="Limpar e iniciar novo">🔄 Novo Estudo</button>';
      container.insertBefore(bar, container.firstChild);
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  NOTA: Funções de exportação (pdfSimplificado, pdfCompleto,
    //  exportarExcel, pdfHeader, pdfFooter) removidas deste inline.
    //  São fornecidas pelo lucro-real-estudos.js v2.1.0 via
    //  window.LucroRealEstudos e window.IMPOSTExport.
    // ═══════════════════════════════════════════════════════════════════════

    // Iniciar observação quando DOM estiver pronto
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', injectActionBar);
    } else {
      injectActionBar();
    }
  })();
  </script>

  <!-- 9. Ponte HTML ↔ Mapeamento v3.4: Integração de estado dinâmico -->
  <script>
  (function() {
    'use strict';

    // ═══════════════════════════════════════════════════════════════════════
    //  PONTE: Seleção de estado → LR.setEstado()
    //
    //  O wizard (lucro-real-estudos.js) gera o <select> de estado dinamicamente.
    //  Este bloco observa quando o select é criado e conecta ao LR.setEstado().
    //  Assim, ISS, SUDAM, SUDENE e todos os dados estaduais ficam dinâmicos.
    // ═══════════════════════════════════════════════════════════════════════

    /**
     * IDs possíveis do select de estado no wizard.
     * O lucro-real-estudos.js pode usar qualquer um desses.
     * Adicione mais IDs aqui se o wizard mudar no futuro.
     */
    var ESTADO_SELECT_IDS = [
      'campo-estado',
      'estado',
      'select-estado',
      'empresa-estado',
      'uf'
    ];

    /**
     * Tenta encontrar o select de estado no DOM
     * @returns {HTMLSelectElement|null}
     */
    function encontrarSelectEstado() {
      for (var i = 0; i < ESTADO_SELECT_IDS.length; i++) {
        var el = document.getElementById(ESTADO_SELECT_IDS[i]);
        if (el && el.tagName === 'SELECT') return el;
      }
      // Fallback: procurar qualquer select com name contendo 'estado' ou 'uf'
      var selects = document.querySelectorAll('select[name*="estado"], select[name*="uf"], select[data-field="estado"]');
      return selects.length > 0 ? selects[0] : null;
    }

    /**
     * Conecta o select de estado ao LR.setEstado()
     * @param {HTMLSelectElement} selectEl
     */
    function conectarSelectEstado(selectEl) {
      if (selectEl._lrConectado) return; // Evitar duplicação

      selectEl.addEventListener('change', function() {
        var sigla = this.value;
        if (sigla && typeof LR !== 'undefined' && typeof LR.setEstado === 'function') {
          var ok = LR.setEstado(sigla);
          console.log('[HTML→LR] Estado definido:', sigla, ok ? '✓' : '✗ (estados.js ausente)');
        }
      });

      // Se já tem valor selecionado, carregar imediatamente
      if (selectEl.value && typeof LR !== 'undefined' && typeof LR.setEstado === 'function') {
        LR.setEstado(selectEl.value);
      }

      // v3.3 FIX BUG MÉDIO 1: Observar mudanças no select para capturar preenchimento via JS
      // Quando o wizard restaura dados do localStorage, select.value é definido via JS
      // sem disparar evento 'change'. Este observer detecta options sendo adicionadas
      // ou atributos mudando e sincroniza o estado.
      var selectObserver = new MutationObserver(function() {
        if (selectEl.value && typeof LR !== 'undefined' && typeof LR.setEstado === 'function') {
          var estadoAtual = (typeof LR._estadoAtual !== 'undefined') ? LR._estadoAtual : '';
          if (estadoAtual !== selectEl.value) {
            LR.setEstado(selectEl.value);
            console.log('[HTML→LR] Estado sincronizado via observer:', selectEl.value);
          }
        }
      });
      selectObserver.observe(selectEl, { childList: true, attributes: true, subtree: true });

      // Fallback: polling por 5 segundos para capturar preenchimento tardio via JS
      var _checkCount = 0;
      var _checkInterval = setInterval(function() {
        _checkCount++;
        if (selectEl.value && typeof LR !== 'undefined' && typeof LR.setEstado === 'function') {
          var estadoAtual = (typeof LR._estadoAtual !== 'undefined') ? LR._estadoAtual : '';
          if (estadoAtual !== selectEl.value) {
            LR.setEstado(selectEl.value);
            console.log('[HTML→LR] Estado sincronizado via polling:', selectEl.value);
          }
          clearInterval(_checkInterval);
        }
        if (_checkCount > 10) clearInterval(_checkInterval);
      }, 500);

      selectEl._lrConectado = true;
    }

    /**
     * Observer: fica escutando o DOM para quando o wizard criar o select
     */
    function iniciarObservacao() {
      // Tentar imediatamente (caso o select já exista)
      var sel = encontrarSelectEstado();
      if (sel) {
        conectarSelectEstado(sel);
        return;
      }

      // Observar o wizardContainer para quando o select for criado
      var wizardContainer = document.getElementById('wizardContainer');
      if (!wizardContainer) return;

      var observer = new MutationObserver(function() {
        var sel = encontrarSelectEstado();
        if (sel && !sel._lrConectado) {
          conectarSelectEstado(sel);
        }
        // v3.3 FIX BUG MÉDIO 1: Verificar se select já conectado teve valor definido via JS
        if (sel && sel._lrConectado && sel.value) {
          if (typeof LR !== 'undefined' && typeof LR.setEstado === 'function') {
            var estadoAtual = (typeof LR._estadoAtual !== 'undefined') ? LR._estadoAtual : '';
            if (estadoAtual !== sel.value) {
              LR.setEstado(sel.value);
            }
          }
        }
      });

      observer.observe(wizardContainer, { childList: true, subtree: true });
    }

    // Iniciar quando DOM estiver pronto
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', iniciarObservacao);
    } else {
      iniciarObservacao();
    }
  })();
  </script>

  <!-- v3.3 FIX E2#5 + E3#1: Banner de aviso quando motor fiscal não carregou -->
  <script>
  (function() {
    'use strict';
    function verificarDependencias() {
      var falhas = window._depFalha || [];
      var motorFalhou = window._motorFiscalFalhou || (typeof MotorLR === 'undefined');
      
      if (falhas.length > 0 || motorFalhou) {
        var banner = document.createElement('div');
        banner.id = 'fallbackBanner';
        banner.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:9999;padding:10px 20px;'
          + 'background:#FEF3CD;border-bottom:2px solid #F0AD4E;color:#856404;font-size:14px;'
          + 'font-family:DM Sans,sans-serif;display:flex;align-items:center;justify-content:space-between;';
        
        var msg = '⚠ Modo simplificado ativo';
        if (motorFalhou) {
          msg += ' — motor fiscal não carregado. Resultados podem divergir do cálculo fiscal completo.';
        }
        if (falhas.length > 0) {
          msg += ' Dependências ausentes: ' + falhas.join(', ') + '.';
        }
        
        banner.innerHTML = '<span>' + msg + '</span>'
          + '<button onclick="this.parentElement.remove()" style="background:none;border:1px solid #856404;'
          + 'border-radius:4px;padding:2px 8px;cursor:pointer;color:#856404;font-size:12px;">✕ Fechar</button>';
        
        document.body.insertBefore(banner, document.body.firstChild);
      }
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', verificarDependencias);
    } else {
      // Atraso mínimo para scripts async terminarem
      setTimeout(verificarDependencias, 100);
    }
  })();
  </script>
</body>
</html>
