<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IMPOST — Estudo Tributário Lucro Real | Inteligência em Modelagem de Otimização Tributária</title>
  <meta name="description" content="Estudo tributário profissional do regime Lucro Real — IMPOST — Inteligência em Modelagem de Otimização Tributária">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300..700;1,9..40,300..700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">

  <style>
    /* ═══════════════════════════════════════════════════════════════════════════
       RESET & BASE
       ═══════════════════════════════════════════════════════════════════════════ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --primary: #2D8C4E;
      --primary-dark: #1E6B38;
      --primary-light: #38A85C;
      --secondary: #E8A838;
      --secondary-light: #F0C060;
      --accent: #2ECC71;
      --accent-dark: #27AE60;
      --danger: #E74C3C;
      --danger-light: #FADBD8;
      --warning: #F39C12;
      --warning-light: #FEF5E7;
      --info: #3498DB;
      --info-light: #EBF5FB;
      --purple: #9B59B6;

      --bg: #f4f6f8;
      --bg-gradient: linear-gradient(135deg, #f4f6f8 0%, #eef1f4 100%);
      --card-bg: #ffffff;
      --card-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
      --card-shadow-hover: 0 4px 24px rgba(0, 0, 0, 0.1);
      --card-radius: 12px;
      --input-border: #d0d5dd;
      --input-focus: #2D8C4E;
      --text: #1a1a2e;
      --text-secondary: #5a6170;
      --text-muted: #8b95a5;
      --border: #e2e6ea;
      --table-header: #2D8C4E;
      --table-stripe: #f7f9fb;
      --table-hover: #edf7f0;

      --font-body: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      --font-mono: 'JetBrains Mono', 'Fira Code', monospace;
      --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    html { scroll-behavior: smooth; }

    body {
      font-family: var(--font-body);
      background: var(--bg-gradient);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       LAYOUT PRINCIPAL
       ═══════════════════════════════════════════════════════════════════════════ */
    .app-header {
      background: #ffffff;
      color: var(--text);
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      position: relative;
      z-index: 100;
      border-bottom: 1px solid var(--border);
    }
    .app-header .logo {
      font-size: 1.6rem;
      font-weight: 700;
      letter-spacing: 1px;
      color: var(--text);
    }
    .app-header .logo-dot { color: var(--accent); }
    .app-header .header-sep {
      width: 1px;
      height: 24px;
      background: var(--border);
    }
    .app-header .header-title {
      font-size: 0.95rem;
      font-weight: 400;
      color: var(--text-secondary);
    }
    .app-header .header-version {
      /* margin-left: auto; — removido v1.1: coexiste com btn-dashboard */
      font-family: var(--font-mono);
      font-size: 0.75rem;
      background: var(--primary);
      color: #fff;
      padding: 0.2rem 0.6rem;
      border-radius: 12px;
      font-weight: 600;
    }
    .app-header .header-btn-dashboard {
      margin-left: auto;
      padding: 0.5rem 1.2rem;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-family: var(--font-body);
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      transition: var(--transition);
    }
    .app-header .header-btn-dashboard:hover {
      background: var(--primary-dark);
    }

    .app-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1.5rem 4rem;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       WIZARD — PROGRESS BAR
       ═══════════════════════════════════════════════════════════════════════════ */
    .wz-progress {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1.5rem 1rem;
      margin-bottom: 1.5rem;
      overflow-x: auto;
      gap: 0;
    }

    .wz-step-indicator {
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      min-width: 80px;
      transition: var(--transition);
    }
    .wz-step-indicator:hover .wz-step-num {
      transform: scale(1.1);
      box-shadow: 0 0 0 4px rgba(45, 140, 78, 0.15);
    }

    .wz-step-num {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.9rem;
      background: #e2e6ea;
      color: var(--text-muted);
      transition: var(--transition);
      border: 3px solid transparent;
    }
    .wz-step-indicator.active .wz-step-num {
      background: var(--primary);
      color: #fff;
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(45, 140, 78, 0.2);
    }
    .wz-step-indicator.done .wz-step-num {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent-dark);
    }

    .wz-step-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 6px;
      text-align: center;
      max-width: 90px;
      line-height: 1.3;
      font-weight: 500;
    }
    .wz-step-indicator.active .wz-step-label { color: var(--primary); font-weight: 700; }
    .wz-step-indicator.done .wz-step-label { color: var(--accent-dark); }

    .wz-step-line {
      flex: 1;
      height: 3px;
      background: #e2e6ea;
      min-width: 20px;
      max-width: 60px;
      margin: 0 4px;
      margin-bottom: 22px;
      border-radius: 2px;
      transition: var(--transition);
    }
    .wz-step-line.done {
      background: var(--accent);
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       WIZARD — CONTENT AREA
       ═══════════════════════════════════════════════════════════════════════════ */
    .wz-content {
      background: var(--card-bg);
      border-radius: var(--card-radius);
      box-shadow: var(--card-shadow);
      padding: 2rem;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .wz-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--border);
    }
    .wz-header-icon {
      font-size: 2rem;
      line-height: 1;
    }
    .wz-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--primary);
      margin: 0;
    }
    .wz-subtitle {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin: 2px 0 0;
    }

    .wz-form {
      margin-bottom: 1.5rem;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       WIZARD — SECTION TITLES
       ═══════════════════════════════════════════════════════════════════════════ */
    .wz-section-title {
      font-size: 1.05rem;
      font-weight: 700;
      color: var(--primary);
      margin: 1.8rem 0 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--accent);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .wz-section-title::before {
      content: '';
      display: inline-block;
      width: 4px;
      height: 20px;
      background: var(--accent);
      border-radius: 2px;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       WIZARD — ROWS & FIELDS
       ═══════════════════════════════════════════════════════════════════════════ */
    .wz-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 0;
    }

    .wz-field {
      margin-bottom: 1rem;
    }
    .wz-field > label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
    }

    .wz-input {
      width: 100%;
      padding: 0.6rem 0.85rem;
      border: 1.5px solid var(--input-border);
      border-radius: 8px;
      font-family: var(--font-body);
      font-size: 0.9rem;
      color: var(--text);
      background: #fff;
      transition: var(--transition);
      outline: none;
    }
    .wz-input:focus {
      border-color: var(--input-focus);
      box-shadow: 0 0 0 3px rgba(45, 140, 78, 0.12);
    }
    .wz-input:disabled {
      background: #f5f5f5;
      cursor: not-allowed;
      opacity: 0.7;
    }
    select.wz-input {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%235a6170' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 2rem;
    }
    textarea.wz-input {
      resize: vertical;
      min-height: 70px;
    }

    .wz-input-prefix, .wz-input-suffix {
      display: flex;
      align-items: stretch;
    }
    .wz-input-prefix > span, .wz-input-suffix > span {
      display: flex;
      align-items: center;
      padding: 0 0.7rem;
      background: var(--table-stripe);
      border: 1.5px solid var(--input-border);
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-secondary);
    }
    .wz-input-prefix > span {
      border-right: none;
      border-radius: 8px 0 0 8px;
    }
    .wz-input-prefix .wz-input {
      border-radius: 0 8px 8px 0;
    }
    .wz-input-suffix > span {
      border-left: none;
      border-radius: 0 8px 8px 0;
    }
    .wz-input-suffix .wz-input {
      border-radius: 8px 0 0 8px;
    }

    .wz-tip {
      display: block;
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 3px;
      line-height: 1.4;
    }

    .wz-field-error .wz-input {
      border-color: var(--danger);
      box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.12);
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       WIZARD — CHECKBOXES & RADIOS
       ═══════════════════════════════════════════════════════════════════════════ */
    .wz-field-check {
      margin-bottom: 0.8rem;
    }
    .wz-check-label {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      cursor: pointer;
      font-size: 0.88rem;
      font-weight: 500;
      user-select: none;
      padding: 0.4rem 0;
    }
    .wz-check-label input[type="checkbox"] {
      display: none;
    }
    .wz-checkmark {
      width: 20px;
      height: 20px;
      border: 2px solid var(--input-border);
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
      flex-shrink: 0;
      background: #fff;
    }
    .wz-check-label input:checked + .wz-checkmark {
      background: var(--primary);
      border-color: var(--primary);
    }
    .wz-check-label input:checked + .wz-checkmark::after {
      content: '✓';
      color: #fff;
      font-size: 0.7rem;
      font-weight: 700;
    }

    .wz-radio-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.3rem;
    }
    .wz-radio-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      font-size: 0.85rem;
      user-select: none;
      padding: 0.5rem 0.8rem;
      border: 1.5px solid var(--border);
      border-radius: 8px;
      transition: var(--transition);
      background: #fff;
    }
    .wz-radio-label:hover {
      border-color: var(--primary);
      background: var(--info-light);
    }
    .wz-radio-label input[type="radio"] {
      display: none;
    }
    .wz-radio-mark {
      width: 18px;
      height: 18px;
      border: 2px solid var(--input-border);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
      flex-shrink: 0;
    }
    .wz-radio-label input:checked + .wz-radio-mark {
      border-color: var(--primary);
    }
    .wz-radio-label input:checked + .wz-radio-mark::after {
      content: '';
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--primary);
    }
    .wz-radio-label:has(input:checked) {
      border-color: var(--primary);
      background: var(--info-light);
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       WIZARD — INFO BOXES & BADGES
       ═══════════════════════════════════════════════════════════════════════════ */
    .wz-info-box {
      padding: 0.85rem 1rem;
      border-radius: 8px;
      font-size: 0.85rem;
      line-height: 1.55;
      margin-bottom: 1rem;
      border-left: 4px solid var(--info);
      background: var(--info-light);
      color: var(--text);
    }
    .wz-info-box strong { color: var(--primary); }
    .wz-info-default { border-left-color: var(--info); background: var(--info-light); }
    .wz-info-success { border-left-color: var(--accent); background: #eafaf1; }
    .wz-info-warning { border-left-color: var(--warning); background: var(--warning-light); }
    .wz-info-gray { border-left-color: #bbb; background: #f5f5f5; }

    .wz-badge {
      display: inline-block;
      padding: 0.3rem 0.7rem;
      border-radius: 6px;
      font-size: 0.78rem;
      font-weight: 600;
      margin-top: 0.4rem;
    }
    .wz-badge-green { background: #eafaf1; color: var(--accent-dark); border: 1px solid #c3e6cb; }
    .wz-badge-red { background: var(--danger-light); color: var(--danger); border: 1px solid #f5c6cb; }
    .wz-badge-gray { background: #f5f5f5; color: #666; border: 1px solid #ddd; }
    .wz-badge-blue { background: var(--info-light); color: var(--info); border: 1px solid #b8daff; }

    /* ═══════════════════════════════════════════════════════════════════════════
       WIZARD — AUTO CALC BOXES
       ═══════════════════════════════════════════════════════════════════════════ */
    .wz-auto-calc {
      background: linear-gradient(135deg, #f7f9fb 0%, #edf2f7 100%);
      border: 1px solid var(--border);
      border-left: 4px solid var(--primary);
      border-radius: 8px;
      padding: 0.8rem 1rem;
      margin: 1rem 0;
      font-size: 0.85rem;
      line-height: 1.6;
      color: var(--text);
      font-family: var(--font-mono);
    }
    .wz-auto-calc strong { color: var(--primary); }

    /* ═══════════════════════════════════════════════════════════════════════════
       WIZARD — NAVIGATION
       ═══════════════════════════════════════════════════════════════════════════ */
    .wz-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.8rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border);
      flex-wrap: wrap;
    }

    .wz-btn {
      padding: 0.65rem 1.4rem;
      border: none;
      border-radius: 8px;
      font-family: var(--font-body);
      font-size: 0.88rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }
    .wz-btn:hover { transform: translateY(-1px); }
    .wz-btn:active { transform: translateY(0); }

    .wz-btn-next {
      background: var(--primary);
      color: #fff;
      box-shadow: 0 2px 8px rgba(45, 140, 78, 0.3);
    }
    .wz-btn-next:hover { background: var(--primary-light); }

    .wz-btn-back {
      background: transparent;
      color: var(--text-secondary);
      border: 1.5px solid var(--border);
    }
    .wz-btn-back:hover { background: var(--table-stripe); }

    .wz-btn-analyze {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
      color: #fff;
      font-size: 1rem;
      padding: 0.8rem 2rem;
      box-shadow: 0 4px 16px rgba(46, 204, 113, 0.35);
    }
    .wz-btn-analyze:hover { box-shadow: 0 6px 24px rgba(46, 204, 113, 0.45); }

    .wz-btn-fill {
      background: transparent;
      color: var(--warning);
      border: 1.5px solid var(--warning);
      font-size: 0.8rem;
      padding: 0.5rem 1rem;
    }
    .wz-btn-fill:hover { background: var(--warning-light); }

    .wz-btn-small {
      font-size: 0.78rem;
      padding: 0.35rem 0.7rem;
      background: transparent;
      color: var(--primary);
      border: 1px solid var(--border);
      border-radius: 6px;
    }
    .wz-btn-small:hover { background: var(--info-light); }

    /* ═══════════════════════════════════════════════════════════════════════════
       WIZARD — MISC
       ═══════════════════════════════════════════════════════════════════════════ */
    .wz-error {
      background: var(--danger-light);
      border: 2px solid var(--danger);
      border-radius: var(--card-radius);
      padding: 2rem;
      text-align: center;
      color: var(--danger);
    }
    .wz-error h2 { margin-bottom: 0.5rem; }

    .wz-resumo {
      background: var(--table-stripe);
      border-radius: 8px;
      padding: 1.2rem;
      margin-bottom: 1.5rem;
    }
    .wz-resumo-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    .wz-resumo-table td {
      padding: 0.4rem 0.6rem;
      border-bottom: 1px solid var(--border);
    }
    .wz-resumo-table strong { color: var(--primary); }
    .wz-resumo-editar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .wz-municipio-loading {
      font-size: 0.8rem;
      color: var(--info);
      padding: 0.3rem 0;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .wz-iss-dica {
      font-size: 0.8rem;
      padding: 0.4rem 0;
    }

    .wz-adm-impact {
      font-size: 0.8rem;
      color: var(--danger);
      font-weight: 600;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       ACTION BAR (FIXED WHEN REPORT VISIBLE)
       ═══════════════════════════════════════════════════════════════════════════ */
    .action-bar {
      position: sticky;
      top: 0;
      z-index: 200;
      background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
      padding: 0.7rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.6rem;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      flex-wrap: wrap;
      margin: -2rem -1.5rem 2rem;
      border-radius: 0 0 var(--card-radius) var(--card-radius);
    }
    .action-bar .action-label {
      font-size: 0.82rem;
      color: rgba(255,255,255,0.6);
      font-weight: 600;
      margin-right: 0.5rem;
      white-space: nowrap;
    }
    .action-bar .ab-btn {
      padding: 0.5rem 1rem;
      border: 1.5px solid rgba(255,255,255,0.25);
      border-radius: 8px;
      background: rgba(255,255,255,0.08);
      color: #fff;
      font-family: var(--font-body);
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }
    .ab-btn:hover {
      background: rgba(255,255,255,0.18);
      border-color: rgba(255,255,255,0.5);
      transform: translateY(-1px);
    }
    .ab-btn.ab-btn-primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }
    .ab-btn.ab-btn-primary:hover {
      background: var(--accent-dark);
    }
    .ab-btn.ab-btn-success {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }
    .ab-btn.ab-btn-success:hover {
      background: var(--accent-dark);
    }
    .action-bar .ab-spacer { flex: 1; }

    /* ═══════════════════════════════════════════════════════════════════════════
       RESULTADOS — HEADER
       ═══════════════════════════════════════════════════════════════════════════ */
    .res-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: #fff;
      padding: 2rem 2.5rem;
      border-radius: var(--card-radius);
      margin-bottom: 2rem;
      position: relative;
      overflow: hidden;
    }
    .res-header::after {
      content: '';
      position: absolute;
      top: 0; right: 0; bottom: 0;
      width: 40%;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='80' cy='20' r='40' fill='rgba(232,168,56,0.06)'/%3E%3Ccircle cx='60' cy='70' r='30' fill='rgba(46,204,113,0.04)'/%3E%3C/svg%3E") no-repeat center;
      background-size: cover;
      pointer-events: none;
    }
    .res-logo { margin-bottom: 0.8rem; }
    .res-logo img { max-height: 50px; }
    .res-title {
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: 0.5px;
      margin-bottom: 0.3rem;
    }
    .res-subtitle { font-size: 0.9rem; opacity: 0.8; }
    .res-header-line {
      width: 60px;
      height: 3px;
      background: var(--accent);
      border-radius: 2px;
      margin: 1rem 0;
    }
    .res-company {
      font-size: 0.88rem;
      line-height: 1.8;
    }
    .res-company-row strong { color: var(--accent); }
    .res-elaborador {
      margin-top: 1rem;
      padding-top: 0.8rem;
      border-top: 1px solid rgba(255,255,255,0.15);
      font-size: 0.82rem;
      opacity: 0.9;
    }
    .res-powered {
      margin-top: 0.8rem;
      font-size: 0.72rem;
      font-family: var(--font-mono);
      opacity: 0.5;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       RESULTADOS — SECTIONS
       ═══════════════════════════════════════════════════════════════════════════ */
    .res-section {
      background: var(--card-bg);
      border-radius: var(--card-radius);
      box-shadow: var(--card-shadow);
      margin-bottom: 1.5rem;
      overflow: hidden;
    }
    .res-section-title {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: #fff;
      padding: 1rem 1.5rem;
      font-size: 1.05rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.7rem;
      margin: 0;
    }
    .res-section-num {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      font-size: 0.85rem;
      font-weight: 700;
      flex-shrink: 0;
    }
    .res-section-body {
      padding: 1.5rem;
    }
    .res-section-body h3 {
      font-size: 1rem;
      font-weight: 700;
      color: var(--primary);
      margin: 1.5rem 0 0.8rem;
      padding-bottom: 0.4rem;
      border-bottom: 1px solid var(--border);
    }
    .res-section-body h3:first-child { margin-top: 0; }
    .res-section-body h4 {
      font-size: 0.92rem;
      font-weight: 700;
      color: var(--primary);
      margin: 1.2rem 0 0.6rem;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       RESULTADOS — SUMMARY CARDS
       ═══════════════════════════════════════════════════════════════════════════ */
    .res-summary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin-bottom: 0.5rem;
    }
    .res-summary-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1.2rem;
      text-align: center;
      transition: var(--transition);
    }
    .res-summary-card:hover {
      box-shadow: var(--card-shadow-hover);
      transform: translateY(-2px);
    }
    .res-card-hero {
      border-color: var(--accent);
      border-width: 2px;
      background: linear-gradient(135deg, #eafaf1 0%, #fff 100%);
    }
    .res-card-label {
      font-size: 0.68rem;
      font-weight: 700;
      letter-spacing: 0.8px;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 0.5rem;
    }
    .res-card-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      font-family: var(--font-mono);
      line-height: 1.2;
    }
    .res-card-economia { color: var(--accent-dark) !important; }
    .res-card-sub {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.3rem;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       RESULTADOS — TABLES
       ═══════════════════════════════════════════════════════════════════════════ */
    .res-table-wrap {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .res-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      margin-bottom: 1rem;
    }
    .res-table thead th {
      background: var(--table-header);
      color: #fff;
      padding: 0.65rem 0.8rem;
      text-align: left;
      font-weight: 600;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: sticky;
      top: 0;
    }
    .res-table thead th:first-child { border-radius: 8px 0 0 0; }
    .res-table thead th:last-child { border-radius: 0 8px 0 0; }
    .res-table td {
      padding: 0.55rem 0.8rem;
      border-bottom: 1px solid var(--border);
    }
    .res-table tbody tr:nth-child(even) { background: var(--table-stripe); }
    .res-table tbody tr:hover { background: var(--table-hover); }
    .res-table tfoot td, .res-table tfoot th {
      padding: 0.7rem 0.8rem;
      font-weight: 700;
    }

    .res-valor {
      text-align: right;
      font-family: var(--font-mono);
      font-weight: 600;
      white-space: nowrap;
    }
    .res-artigo {
      font-size: 0.7rem;
      color: var(--text-muted);
      font-style: italic;
    }

    .res-sub td { padding-left: 1.5rem; font-size: 0.82rem; }
    .res-subtotal td { font-weight: 700; background: var(--table-stripe) !important; }
    .res-total td, .res-total th { font-weight: 700; background: var(--primary) !important; color: #fff !important; }
    .res-total .res-valor { color: #fff !important; }
    .res-destaque { background: linear-gradient(90deg, #eafaf1, #fff) !important; }
    .res-economia { color: var(--accent-dark) !important; }
    .res-economia .res-valor { color: var(--accent-dark) !important; }
    .res-group-header td { font-weight: 700; background: #f0f4f8 !important; color: var(--primary); padding-top: 0.8rem; }
    .res-info-row td { font-size: 0.8rem; color: var(--text-muted); font-style: italic; background: var(--table-stripe) !important; }
    .res-tag-tipo-t { font-size: 0.68rem; padding: 0.15rem 0.4rem; border-radius: 4px; background: var(--warning-light); color: var(--warning); font-weight: 600; }
    .res-tag-tipo-c { font-size: 0.68rem; padding: 0.15rem 0.4rem; border-radius: 4px; background: var(--info-light); color: var(--info); font-weight: 600; }

    /* .res-table-dre, .res-table-lalur — reservado para estilos futuros */
    /* .res-dre, .res-lalur — reservado para estilos futuros */

    .res-info-msg {
      font-size: 0.88rem;
      color: var(--text-muted);
      font-style: italic;
      padding: 1rem;
      text-align: center;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       RESULTADOS — DETAIL GRID (Tributos)
       ═══════════════════════════════════════════════════════════════════════════ */
    .res-detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.2rem;
    }
    .res-detail-card {
      background: var(--table-stripe);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1.2rem;
    }
    .res-detail-card h3 {
      margin-top: 0 !important;
      border-bottom: none !important;
    }
    .res-detail-wide {
      grid-column: span 2;
    }
    .res-detail-row { display: flex; justify-content: space-between; padding: 0.3rem 0; }
    .res-detail-label { font-size: 0.85rem; color: var(--text-secondary); }
    .res-detail-value { font-family: var(--font-mono); font-weight: 600; }
    .res-detail-total { font-weight: 700; border-top: 2px solid var(--primary); padding-top: 0.5rem; margin-top: 0.5rem; }

    /* ═══════════════════════════════════════════════════════════════════════════
       RESULTADOS — COMPOSIÇÃO VISUAL BAR
       ═══════════════════════════════════════════════════════════════════════════ */
    .res-composicao-visual { margin-bottom: 1.5rem; }
    .res-comp-bar {
      display: flex;
      height: 36px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }
    .res-comp-seg {
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 0.7rem;
      font-weight: 700;
      letter-spacing: 0.5px;
      min-width: 40px;
      transition: var(--transition);
    }
    .res-comp-seg:hover { filter: brightness(1.15); }

    /* ═══════════════════════════════════════════════════════════════════════════
       RESULTADOS — MAPA DE ECONOMIA (Antes × Depois)
       ═══════════════════════════════════════════════════════════════════════════ */
    /* .res-mapa-economia — reservado para estilos futuros */
    .res-mapa-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1.5rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }
    .res-mapa-card {
      flex: 1;
      min-width: 200px;
      max-width: 280px;
      padding: 1.5rem;
      border-radius: 12px;
      text-align: center;
    }
    .res-mapa-card-label { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem; }
    .res-mapa-card-value { font-size: 1.6rem; font-weight: 700; font-family: var(--font-mono); }
    .res-mapa-card-sub { font-size: 0.8rem; margin-top: 0.3rem; }
    .res-mapa-antes {
      background: linear-gradient(135deg, #fdecea, #fff);
      border: 2px solid var(--danger);
      color: var(--danger);
    }
    .res-mapa-antes .res-mapa-card-label { color: var(--danger); }
    .res-mapa-depois {
      background: linear-gradient(135deg, #eafaf1, #fff);
      border: 2px solid var(--accent);
      color: var(--accent-dark);
    }
    .res-mapa-depois .res-mapa-card-label { color: var(--accent-dark); }
    .res-mapa-seta {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.3rem;
      flex-shrink: 0;
    }
    .res-mapa-seta-valor {
      font-family: var(--font-mono);
      font-weight: 700;
      color: var(--accent-dark);
      font-size: 0.95rem;
    }
    .res-mapa-seta-icon {
      font-size: 2rem;
      color: var(--accent);
    }
    .res-mapa-breakdown { margin-top: 1rem; }
    .res-mapa-projecoes { margin-top: 1.5rem; }

    /* ═══════════════════════════════════════════════════════════════════════════
       RESULTADOS — OPORTUNIDADES
       ═══════════════════════════════════════════════════════════════════════════ */
    /* .res-oportunidades — reservado para estilos futuros */
    .res-oport-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-bottom: 1rem;
      overflow: hidden;
      transition: var(--transition);
    }
    .res-oport-card:hover { box-shadow: var(--card-shadow-hover); }
    .res-oport-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem 1.2rem;
      background: var(--table-stripe);
      border-bottom: 1px solid var(--border);
    }
    .res-oport-rank {
      font-family: var(--font-mono);
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--primary);
      background: #fff;
      width: 42px;
      height: 42px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--primary);
      flex-shrink: 0;
    }
    .res-oport-titulo {
      flex: 1;
      font-weight: 700;
      font-size: 0.95rem;
      color: var(--text);
    }
    .res-oport-valor {
      font-family: var(--font-mono);
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--accent-dark);
      white-space: nowrap;
    }
    .res-oport-valor span { font-size: 0.72rem; color: var(--text-muted); font-family: var(--font-body); }
    .res-oport-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      padding: 0.6rem 1.2rem;
    }
    .res-tag {
      font-size: 0.7rem;
      font-weight: 600;
      padding: 0.25rem 0.6rem;
      border-radius: 20px;
      color: #fff;
    }
    /* .res-tag-tipo — reservado */
    /* .res-tag-compl — reservado */
    /* .res-tag-risco — reservado */
    .res-oport-body {
      padding: 0.8rem 1.2rem 1rem;
      font-size: 0.85rem;
      line-height: 1.6;
    }
    .res-oport-legal {
      font-size: 0.78rem;
      color: var(--text-muted);
      font-style: italic;
      margin-top: 0.5rem;
    }
    .res-oport-acao {
      background: #eafaf1;
      border-radius: 6px;
      padding: 0.5rem 0.8rem;
      margin-top: 0.6rem;
      font-size: 0.82rem;
      border-left: 3px solid var(--accent);
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       RESULTADOS — ALERTAS
       ═══════════════════════════════════════════════════════════════════════════ */
    /* .res-alertas — reservado para estilos futuros */
    .res-alerta {
      display: flex;
      align-items: flex-start;
      gap: 0.7rem;
      padding: 0.8rem 1rem;
      border-radius: 8px;
      margin-bottom: 0.7rem;
      font-size: 0.85rem;
      line-height: 1.5;
      border-left: 4px solid;
    }
    .res-alerta-icon { font-size: 1.1rem; flex-shrink: 0; line-height: 1.3; }
    .res-alerta-critico { border-left-color: var(--danger); background: var(--danger-light); }
    .res-alerta-aviso { border-left-color: var(--warning); background: var(--warning-light); }
    .res-alerta-info { border-left-color: var(--info); background: var(--info-light); }
    .res-alerta-economia { border-left-color: var(--accent); background: #eafaf1; }

    /* ═══════════════════════════════════════════════════════════════════════════
       RESULTADOS — CENÁRIOS
       ═══════════════════════════════════════════════════════════════════════════ */
    /* .res-cenarios — reservado para estilos futuros */
    .res-cenario-base td { font-weight: 700; }
    .res-cenario-pessimista td { color: var(--danger); }
    .res-cenario-otimista td { color: var(--accent-dark); }

    /* ═══════════════════════════════════════════════════════════════════════════
       RESULTADOS — FLUXO MENSAL
       ═══════════════════════════════════════════════════════════════════════════ */
    .res-fluxo-mensal { font-size: 0.8rem; }
    .res-fluxo-mensal td { padding: 0.4rem 0.5rem; }

    /* ═══════════════════════════════════════════════════════════════════════════
       RESULTADOS — RECOMENDAÇÃO
       ═══════════════════════════════════════════════════════════════════════════ */
    .res-recomendacao, .res-trimestral-recomendacao {
      background: linear-gradient(135deg, #edf2f7, #fff);
      border-radius: 10px;
      padding: 1.2rem;
      margin-top: 1rem;
    }
    .res-recomendacao h4, .res-trimestral-recomendacao h4 {
      color: var(--primary);
      margin-bottom: 0.5rem;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       RESULTADOS — OBRIGAÇÕES
       ═══════════════════════════════════════════════════════════════════════════ */
    /* .res-obrigacoes — reservado para estilos futuros */
    /* .res-darf-table — reservado para estilos futuros */

    /* ═══════════════════════════════════════════════════════════════════════════
       RESULTADOS — TIMELINE
       ═══════════════════════════════════════════════════════════════════════════ */
    .res-timeline {
      position: relative;
      padding-left: 40px;
    }
    .res-timeline::before {
      content: '';
      position: absolute;
      left: 18px;
      top: 0;
      bottom: 0;
      width: 3px;
      background: var(--border);
      border-radius: 2px;
    }
    .res-timeline-item {
      position: relative;
      margin-bottom: 1.5rem;
      display: flex;
      gap: 1rem;
    }
    .res-timeline-marker {
      position: absolute;
      left: -40px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--primary);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.85rem;
      z-index: 1;
      box-shadow: 0 2px 8px rgba(45, 140, 78, 0.3);
    }
    .res-timeline-content {
      flex: 1;
      background: var(--table-stripe);
      border-radius: 8px;
      padding: 0.8rem 1rem;
      border-left: 3px solid var(--primary);
    }
    .res-timeline-titulo { font-weight: 700; color: var(--text); margin-bottom: 0.3rem; }
    .res-timeline-prazo {
      font-size: 0.75rem;
      color: var(--info);
      font-family: var(--font-mono);
    }
    .res-timeline-desc { font-size: 0.83rem; color: var(--text-secondary); }

    /* ═══════════════════════════════════════════════════════════════════════════
       RESULTADOS — CHARTS
       ═══════════════════════════════════════════════════════════════════════════ */
    .res-chart-container {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1.2rem;
      margin: 1rem 0;
    }
    .res-chart-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    .res-chart-aliquota {
      max-width: 250px;
      margin: 0 auto 2rem;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       RESULTADOS — FOOTER & ACTIONS
       ═══════════════════════════════════════════════════════════════════════════ */
    .res-footer {
      text-align: center;
      padding-top: 1rem;
    }
    .res-footer-elaborador { font-weight: 600; margin-bottom: 0.3rem; }
    .res-footer-data { font-size: 0.82rem; color: var(--text-secondary); }
    .res-footer-base { font-size: 0.72rem; color: var(--text-muted); margin-top: 0.8rem; }
    .res-footer-disclaimer {
      font-size: 0.75rem;
      color: var(--text-muted);
      font-style: italic;
      margin-top: 0.5rem;
      padding: 0.8rem;
      background: var(--table-stripe);
      border-radius: 6px;
    }
    .res-footer-marca {
      font-size: 0.7rem;
      font-family: var(--font-mono);
      color: var(--text-muted);
      margin-top: 0.5rem;
    }
    .res-actions {
      display: flex;
      justify-content: center;
      gap: 0.8rem;
      flex-wrap: wrap;
      margin-top: 1.5rem;
    }
    .res-btn {
      padding: 0.6rem 1.4rem;
      border: 1.5px solid var(--primary);
      border-radius: 8px;
      background: transparent;
      color: var(--primary);
      font-family: var(--font-body);
      font-size: 0.88rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }
    .res-btn:hover {
      background: var(--primary);
      color: #fff;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       TOTAL DESTAQUE
       ═══════════════════════════════════════════════════════════════════════════ */
    .res-total-destaque {
      font-size: 1rem;
      font-weight: 700;
      color: var(--primary);
      margin-top: 0.5rem;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       LOADING OVERLAY
       ═══════════════════════════════════════════════════════════════════════════ */
    .export-loading {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }
    .export-loading-inner {
      background: #fff;
      border-radius: 12px;
      padding: 2rem 3rem;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    .export-loading-inner .spinner {
      width: 40px; height: 40px;
      border: 4px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 1rem;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ═══════════════════════════════════════════════════════════════════════════
       CNAE AUTOCOMPLETE — Override tema escuro injetado pelo JS
       O JS injeta .cnae-dropdown com cores escuras (bg #1a2236). Aqui
       sobrescrevemos com o design system claro usando especificidade maior.
       ═══════════════════════════════════════════════════════════════════════════ */
    .app-container .cnae-dropdown {
      background: var(--card-bg);
      border: 1.5px solid var(--input-border);
      box-shadow: var(--card-shadow-hover);
    }
    .app-container .cnae-dropdown-item {
      color: var(--text);
      border-bottom-color: var(--border);
    }
    .app-container .cnae-dropdown-item:hover,
    .app-container .cnae-dropdown-item.active {
      background: var(--table-hover);
      color: var(--primary);
    }
    .app-container .cnae-dropdown-item .cnae-code {
      color: var(--primary);
    }
    .app-container .cnae-dropdown-item .cnae-cat {
      color: var(--text-muted);
    }
    .app-container .cnae-dropdown-empty {
      color: var(--text-muted);
    }
    .app-container .cnae-dropdown::-webkit-scrollbar {
      width: 6px;
    }
    .app-container .cnae-dropdown::-webkit-scrollbar-track {
      background: var(--table-stripe);
      border-radius: 3px;
    }
    .app-container .cnae-dropdown::-webkit-scrollbar-thumb {
      background: var(--input-border);
      border-radius: 3px;
    }
    .app-container .cnae-dropdown::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       RESPONSIVE
       ═══════════════════════════════════════════════════════════════════════════ */
    @media (max-width: 768px) {
      .app-container { padding: 1rem 0.8rem 3rem; }
      .wz-row { grid-template-columns: 1fr; }
      .wz-content { padding: 1.2rem; }
      .wz-progress { gap: 0; padding: 1rem 0.5rem; }
      .wz-step-indicator { min-width: 50px; }
      .wz-step-label { font-size: 0.6rem; max-width: 55px; }
      .wz-step-num { width: 32px; height: 32px; font-size: 0.75rem; }
      .wz-nav { gap: 0.5rem; }
      .wz-btn { font-size: 0.8rem; padding: 0.55rem 1rem; }

      .res-summary { grid-template-columns: 1fr 1fr; }
      .res-card-value { font-size: 1.1rem; }
      .res-detail-grid { grid-template-columns: 1fr; }
      .res-detail-wide { grid-column: span 1; }
      .res-chart-row { grid-template-columns: 1fr; }
      .res-mapa-row { flex-direction: column; }
      .res-mapa-seta { transform: rotate(90deg); }
      .res-oport-header { flex-wrap: wrap; }
      .res-oport-valor { width: 100%; text-align: right; }
      .res-header { padding: 1.5rem; }
      .res-title { font-size: 1.1rem; }

      .action-bar { padding: 0.5rem 0.8rem; gap: 0.4rem; }
      .action-bar .action-label { display: none; }
      .ab-btn { font-size: 0.72rem; padding: 0.4rem 0.7rem; }
    }
    @media (max-width: 480px) {
      .res-summary { grid-template-columns: 1fr; }
      .res-table { font-size: 0.75rem; }
      .res-table td, .res-table th { padding: 0.4rem 0.5rem; }
      .wz-radio-group { flex-direction: column; }
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       PRINT STYLES
       ═══════════════════════════════════════════════════════════════════════════ */
    @media print {
      body { background: #fff !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .app-header, .action-bar, .wz-nav, .res-actions, .res-btn, .ab-btn { display: none !important; }
      #wizardContainer { display: none !important; }
      #resultadosContainer { display: block !important; }
      .app-container { max-width: 100%; padding: 0; margin: 0; }

      .res-section {
        page-break-inside: avoid;
        break-inside: avoid;
        box-shadow: none !important;
        border: 1px solid #ddd;
        margin-bottom: 1rem;
      }
      .res-header {
        page-break-after: avoid;
        background: var(--primary) !important;
      }
      .res-chart-container {
        page-break-inside: avoid;
        break-inside: avoid;
        max-height: 350px;
      }
      .res-oport-card { page-break-inside: avoid; break-inside: avoid; }
      .res-summary-card { border: 1px solid #ccc; }
      .res-total td { background: var(--primary) !important; color: #fff !important; }
      .res-section-title { background: var(--primary) !important; color: #fff !important; }

      @page {
        margin: 1.5cm;
        size: A4;
      }
    }
  </style>
</head>
<body>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       APP HEADER
       ═══════════════════════════════════════════════════════════════════════════ -->
  <header class="app-header">
    <div class="logo">IMPOST<span class="logo-dot">.</span></div>
    <div class="header-sep"></div>
    <span class="header-title">Estudo Tributário — Lucro Real</span>
    <span class="header-version" id="versionBadge">v3.4</span>
    <a class="header-btn-dashboard" href="#" onclick="return false;" style="display:none;">← Dashboard</a>
  </header>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       CONTAINERS PRINCIPAIS
       ═══════════════════════════════════════════════════════════════════════════ -->
  <div class="app-container">
    <div id="wizardContainer"></div>
    <div id="resultadosContainer" style="display:none"></div>
  </div>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       SCRIPTS — Ordem OBRIGATÓRIA (dependências em cascata)
       
       1. estados.js       → window.Estados (dados de 27 UFs)
       2. municipios.js    → API IBGE (depende de estados.js para siglas)
       3. motor v4.6       → window.MotorLR (cálculos puros, sem dependência)
       4. mapeamento v3.3  → window.LR (ponte motor↔HTML, lê de Estados via LR.setEstado)
       5-7. Libs externas  → Chart.js, html2pdf, SheetJS
       8. estudos.js       → window.LucroRealEstudos (wizard, depende de TODOS acima)
       9. Script inline    → Ponte HTML↔LR.setEstado + action bar
       
       ⚠ MODO STANDALONE: todos os scripts embutidos inline.
       ═══════════════════════════════════════════════════════════════════════════ -->
  <!-- estados.js: dados embutidos nos JS abaixo (fallback interno) -->
  <!-- municipios.js: API IBGE via fetch direto (fallback interno) -->
  <!-- 3. Motor fiscal unificado v5.3 (INLINE) -->
  <script>
/**
 * ============================================================================
 * MOTOR DE CÁLCULO UNIFICADO — LUCRO REAL (IRPJ + CSLL)  v5.3
 * Base Legal: Decreto nº 9.580/2018 (RIR/2018) — Artigos 217 a 290+
 * Ano-Base: 2026
 * ============================================================================
 *
 * CHANGELOG v5.3 (correções fiscais e de interface):
 *
 * --- v5.3 (correções de interface e robustez) ---
 *
 * [FIX CRÍTICO] calcularIRPJLucroReal agora retorna aliases (irpjNormal,
 *   irpjDevido, irpjAPagar, compensacaoPrejuizo, baseCalculo) além dos nomes
 *   passo*_ — garante compatibilidade com consumidores sem mapeamento correto.
 *
 * [FIX CRÍTICO] calcularIncentivos aceita AMBAS convenções de chamada:
 *   (irpjNormal, despesas) e ({irpjNormal, despesas}). Resolve BUG MÉDIO 5
 *   (limiteGlobal.valor = null quando mapeamento passa objeto como 1º arg).
 *
 * [FIX MÉDIO] compensarPrejuizo retorna economiaTotal: 0 no path de prejuízo
 *   (antes retornava apenas economiaIRPJ/economiaCSLL, economiaTotal era undefined).
 *
 * [FIX MÉDIO] calcularCSLL retorna aliases csllAPagar, baseCSLL, csllNormal.
 *
 * [FIX MÉDIO] calcularEstimativaMensal aceita 'receitaBruta' como alias de
 *   'receitaBrutaMensal' — compatibilidade com consumidores.
 *
 * [FIX MÉDIO] Validação defensiva de inputs (Number() + || 0) em todas as
 *   funções de cálculo: calcularIRPJLucroReal, calcularCSLL, calcularJCP,
 *   calcularEstimativaMensal, compensarIntegrado.
 *
 * [FIX MENOR] _safe() wrapper previne NaN/Infinity nos campos de retorno.
 *
 * [FIX MENOR] Aliases de export: calcularIRPJ, irpj, csll, incentivos, jcp, etc.
 *
 * --- v5.2 (correções de bugs relatados) ---
 *
 * [FIX BUG #1] CRÍTICO: Cálculo de JCP zerava compensação de prejuízo indevidamente
 *   - Adicionado cenário intermediário (irpjSemJCPComCompensacao / csllSemJCP) em simularLucroReal
 *   - economia.jcp agora é calculado como diferença incremental real ao adicionar JCP,
 *     mantendo a trava de 30% ativa e recalculada sobre o lucro ajustado após dedução do JCP
 *   - Antes: economia.jcp = jcpDedutivel × 34% − IRRF (taxa fixa, ignorava interação com compensação)
 *   - Agora: economia.jcp = (IRPJ+CSLL sem JCP, com comp) − (IRPJ+CSLL com JCP, com comp) − IRRF
 *
 * [FIX BUG #6] Inconsistência .economia vs .economiaEstimada/.economiaAnual em gerarMapaEconomia
 *   - Todos os objetos de oportunidade agora expõem .economia e .economiaAnual como aliases
 *     de .economiaEstimada, evitando undefined silencioso em funções de exportação
 *
 * --- v5.1 (LC 224/2025 e teto global de incentivos) ---
 *
 * [FIX #8] IRRF sobre JCP atualizado para 17,5% (LC 224/2025, vigente 01/01/2026)
 *   - JCP_IRRF_ALIQUOTA alterada de 0.15 para 0.175
 *   - Economia líquida de JCP recalculada: 34% − 17,5% = 16,5% (antes 19%)
 *   - Ref: LC 224/2025, Art. 9º — nova alíquota de IRRF sobre JCP
 *
 * [FIX #9] Limite global de 4% para incentivos fiscais (Art. 625)
 *   - LIMITE_GLOBAL_INCENTIVOS agora define percentual numérico (0.04) e lista de incentivos sujeitos
 *   - calcularIncentivos aplica teto global: PAT + FIA + Idoso + Rouanet + Audiovisual + Esporte ≤ 4% IRPJ normal
 *   - Rateio proporcional automático quando a soma excede o teto, com alerta detalhado
 *
 * [FIX #10] PIS/COFINS para produtos de alíquota zero/reduzida (LC 224/2025, abr/2026+)
 *   - Novas constantes: PIS_ALIQUOTA_REDUZIDA_LC224 (0,165%) e COFINS_ALIQUOTA_REDUZIDA_LC224 (0,76%)
 *   - Novo parâmetro receitasAliquotaReduzidaLC224 em calcularPISCOFINSNaoCumulativo
 *   - Débitos segregados entre alíquota padrão e alíquota reduzida LC 224/2025
 *
 * --- v5.0 ---
 *
 * [FIX #1] Gratificações a Administradores — tratamento detalhado
 *   - Distinção entre: (a) administradores estatutários (indedutível IRPJ, dedutível CSLL),
 *     (b) diretores-empregados CLT (controvertido), (c) empregados gerais (dedutível).
 *   - Ref: Art. 315 RIR/2018, IN RFB 1.700/17 Anexo I item 85, CARF Ac. 1301003.760
 *   - analisarDedutibilidade agora distingue ajuste LALUR vs LACS (CSLL)
 *
 * [FIX #2] Créditos PIS/COFINS — Aluguel PF vs PJ
 *   - Novo parâmetro alugueisPF (sem crédito) com alerta automático
 *   - Ref: Lei 10.637/2002, Art. 3º, IV — "aluguéis pagos a pessoa jurídica"
 *
 * [FIX #3] Taxa TJLP não hardcoded
 *   - Removido default de 6% a.a. — TJLP agora é parâmetro OBRIGATÓRIO
 *   - Validação com mensagem orientadora e referência a taxas recentes (Q1/2025: 7,97%)
 *   - Ref: TJLP Q1/2025 = 7,97%, acumulado 12m até jan/2026 ≈ 8,77%
 *
 * [FIX #4] Créditos PIS/COFINS sobre depreciação
 *   - Novo cálculo fiscal (1/48 ou 1/60 do custo de aquisição) vs taxa contábil
 *   - Parâmetros: depreciacaoBensMetodo, custoAquisicaoImobilizado, mesesUsoImobilizado
 *   - Alertas quando usado método contábil (pode divergir do crédito fiscal)
 *   - Ref: Lei 10.637/02, Art. 3º, VI; Lei 14.592/2023 (1/48 a partir de jan/2024)
 *
 * [FIX #5] Alíquota efetiva PIS/COFINS — dois números claros
 *   - aliquotaEfetiva = líquida (a pagar / receita bruta) — carga REAL
 *   - aliquotaEfetivaBruta = (débitos / receita bruta) — composição analítica
 *   - Objeto aliquotaEfetivaDescricao explica cada métrica
 *
 * [FIX #6] Carga total no cenário base — bruta vs líquida
 *   - totalAPagar agora contém cargaTotalBruta e cargaTotalLiquida com descrições
 *   - PIS/COFINS integrado em simularLucroRealCompleto (antes ausente)
 *
 * [FIX #7] PIS/COFINS proporcional nos cenários
 *   - Cenários pessimista/otimista agora recalculam PIS/COFINS proporcionalmente
 *   - Antes: PIS/COFINS era fixo mesmo com receita variando ±5%
 *
 * ARQUIVO CONSOLIDADO — Contém todos os módulos:
 *   • Motor Principal (IRPJ/CSLL, Estimativa, JCP, PIS/COFINS)
 *   • Bloco A — Compensação de Prejuízos Fiscais (Art. 580-590)
 *   • Bloco D — Despesas Dedutíveis, PDD, Depreciação (Art. 311-365)
 *   • Bloco D2 — Valor Justo, MEP, Operações Exterior (CPC 18/46/02)
 *   • Bloco E — Lucro da Exploração SUDAM/SUDENE (Art. 615-627)
 *   • Bloco G — Retenções na Fonte IRRF/CSRF/ISS (Art. 714-786)
 *   • Bloco H — Acréscimos Moratórios e Multas (Lei 9.430/96, Arts. 44, 47, 61, 63)
 *   • Bloco I — Compensação Tributária PER/DCOMP (Lei 9.430/96, Arts. 73, 74, 74-A)
 *
 * INSTRUÇÕES:
 *   1. Arquivo único — basta importar: const motor = require('./motor-lucro-real-v5.0');
 *   2. Cada função documenta o artigo do RIR/2018 que a fundamenta
 *   3. Valores monetários em R$ (reais); taxas em decimal (0.15 = 15%)
 *   4. Todas as funções públicas exportadas no final do arquivo
 *   5. ATENÇÃO v5.0: TJLP deve ser informada explicitamente (sem default)
 *
 * TOTAL DE FUNÇÕES: 80
 * ============================================================================
 */

'use strict';

/** Sanitiza resultado numérico: NaN/Infinity/undefined → 0 */
function _safe(v) { return (typeof v === 'number' && isFinite(v)) ? v : 0; }

// ============================================================================
// BLOCO 1 — CONSTANTES E ALÍQUOTAS
// ============================================================================

const CONSTANTES = {
  // --- IRPJ ---
  IRPJ_ALIQUOTA_NORMAL: 0.15,           // Art. 225: 15%
  IRPJ_ALIQUOTA_ADICIONAL: 0.10,        // Art. 225, parágrafo único: 10%
  IRPJ_LIMITE_ADICIONAL_MES: 20000.00,  // Art. 225, parágrafo único: R$ 20.000/mês
  IRPJ_LIMITE_ADICIONAL_TRIMESTRE: 60000.00,  // R$ 60.000/trimestre
  IRPJ_LIMITE_ADICIONAL_ANO: 240000.00, // R$ 240.000/ano

  // --- CSLL ---
  CSLL_ALIQUOTA_GERAL: 0.09,            // 9% para empresas em geral
  CSLL_ALIQUOTA_FINANCEIRAS: 0.15,      // 15% para instituições financeiras

  // --- Compensação de Prejuízos ---
  TRAVA_COMPENSACAO_PREJUIZO: 0.30,     // Art. 261, III: 30%

  // --- PIS/COFINS Não-Cumulativo ---
  PIS_ALIQUOTA: 0.0165,                 // 1,65%
  COFINS_ALIQUOTA: 0.076,               // 7,6%
  PIS_COFINS_TOTAL: 0.0925,             // 9,25%

  // --- PIS/COFINS — Alíquota reduzida LC 224/2025 (vigente a partir de abr/2026) ---
  // Itens antes com alíquota zero ou reduzida passam a recolher 10% das alíquotas padrão
  PIS_ALIQUOTA_REDUZIDA_LC224: 0.00165,   // 10% de 1,65% = 0,165%
  COFINS_ALIQUOTA_REDUZIDA_LC224: 0.0076, // 10% de 7,60% = 0,76%
  PIS_COFINS_REDUZIDA_LC224_TOTAL: 0.00925, // 10% de 9,25% = 0,925%

  // --- JCP ---
  JCP_IRRF_ALIQUOTA: 0.175,             // 17,5% IRRF sobre JCP (LC 224/2025, vigente a partir de 01/01/2026)
  JCP_LIMITE_LUCRO_LIQUIDO: 0.50,       // 50% do lucro líquido
  JCP_LIMITE_LUCROS_ACUMULADOS: 0.50,   // 50% de lucros acumulados + reservas

  // --- TJLP — v5.0: Referência informativa, NÃO usar como default ---
  // A TJLP deve ser informada pelo usuário com base na taxa vigente no período.
  // Consultar: https://www.gov.br/receitafederal/pt-br/assuntos/orientacao-tributaria/pagamentos-e-parcelamentos/taxa-de-juros-de-longo-prazo-tjlp
  TJLP_REFERENCIA: {
    nota: 'Taxas de referência — consultar BACEN para valor atualizado',
    Q1_2025: 0.0797,   // 7,97% a.a. (Comunicado BCB 42.642)
    Q2_2025: 0.0850,   // ~8,50% a.a.
    Q3_2025: 0.0877,   // ~8,77% a.a.
    Q4_2025: 0.0877,   // ~8,77% a.a.
    Q1_2026: null,      // Consultar BACEN
  },

  // --- Limites de Obrigatoriedade ---
  LIMITE_RECEITA_LUCRO_REAL: 78000000.00, // Art. 257, I: R$ 78 milhões

  // --- Períodos Trimestrais ---
  TRIMESTRES: [
    { numero: 1, inicio: '01-01', fim: '03-31', meses: 3 },
    { numero: 2, inicio: '04-01', fim: '06-30', meses: 3 },
    { numero: 3, inicio: '07-01', fim: '09-30', meses: 3 },
    { numero: 4, inicio: '10-01', fim: '12-31', meses: 3 },
  ],
};

// ============================================================================
// BLOCO 2 — PERCENTUAIS DE PRESUNÇÃO PARA ESTIMATIVA MENSAL
// Base Legal: Art. 220 (IRPJ) + Art. 15 Lei 9.249/95
// ============================================================================

const PRESUNCOES = {
  /**
   * Cada atividade tem:
   *   irpj: percentual de presunção para IRPJ
   *   csll: percentual de presunção para CSLL (Lei 9.249/95, Art. 20)
   *   artigo: fundamentação legal
   */
  COMERCIO_INDUSTRIA: {
    irpj: 0.08,
    csll: 0.12,
    artigo: 'Art. 220, caput',
    descricao: 'Comércio, indústria, transporte de carga',
    aliquotaEfetivaIRPJ: 0.08 * 0.15, // 1,20%
    aliquotaEfetivaCSLL: 0.12 * 0.09, // 1,08%
  },
  REVENDA_COMBUSTIVEIS: {
    irpj: 0.016,
    csll: 0.12,
    artigo: 'Art. 220, §1º, I',
    descricao: 'Revenda de combustível derivado de petróleo, álcool, gás natural',
    aliquotaEfetivaIRPJ: 0.016 * 0.15, // 0,24%
    aliquotaEfetivaCSLL: 0.12 * 0.09,
  },
  TRANSPORTE_PASSAGEIROS: {
    irpj: 0.16,
    csll: 0.12,
    artigo: 'Art. 220, §1º, II, a',
    descricao: 'Transporte de passageiros',
    aliquotaEfetivaIRPJ: 0.16 * 0.15, // 2,40%
    aliquotaEfetivaCSLL: 0.12 * 0.09,
  },
  INSTITUICOES_FINANCEIRAS: {
    irpj: 0.16,
    csll: 0.12,
    artigo: 'Art. 220, §1º, II, b + Art. 223',
    descricao: 'Bancos, financeiras, seguradoras, etc.',
    aliquotaEfetivaIRPJ: 0.16 * 0.15,
    aliquotaEfetivaCSLL: 0.12 * 0.15,
  },
  SERVICOS_GERAL: {
    irpj: 0.32,
    csll: 0.32,
    artigo: 'Art. 220, §1º, III, a',
    descricao: 'Prestação de serviços em geral',
    aliquotaEfetivaIRPJ: 0.32 * 0.15, // 4,80%
    aliquotaEfetivaCSLL: 0.32 * 0.09, // 2,88%
  },
  SERVICOS_HOSPITALARES: {
    irpj: 0.08,
    csll: 0.12,
    artigo: 'Art. 220, §2º (exceção do §1º, III, a)',
    descricao: 'Serviços hospitalares (sociedade empresária + normas ANVISA)',
    aliquotaEfetivaIRPJ: 0.08 * 0.15,
    aliquotaEfetivaCSLL: 0.12 * 0.09,
    requisitos: ['Sociedade empresária', 'Atender normas ANVISA'],
  },
  INTERMEDIACAO_NEGOCIOS: {
    irpj: 0.32,
    csll: 0.32,
    artigo: 'Art. 220, §1º, III, b',
    descricao: 'Intermediação de negócios',
    aliquotaEfetivaIRPJ: 0.32 * 0.15,
    aliquotaEfetivaCSLL: 0.32 * 0.09,
  },
  ADMINISTRACAO_LOCACAO: {
    irpj: 0.32,
    csll: 0.32,
    artigo: 'Art. 220, §1º, III, c',
    descricao: 'Administração, locação ou cessão de bens e direitos',
    aliquotaEfetivaIRPJ: 0.32 * 0.15,
    aliquotaEfetivaCSLL: 0.32 * 0.09,
  },
  FACTORING: {
    irpj: 0.32,
    csll: 0.32,
    artigo: 'Art. 220, §1º, III, d',
    descricao: 'Factoring, assessoria creditícia',
    aliquotaEfetivaIRPJ: 0.32 * 0.15,
    aliquotaEfetivaCSLL: 0.32 * 0.09,
  },
  CONSTRUCAO_CONCESSAO: {
    irpj: 0.32,
    csll: 0.32,
    artigo: 'Art. 220, §1º, III, e',
    descricao: 'Construção vinculada a concessão de serviço público',
    aliquotaEfetivaIRPJ: 0.32 * 0.15,
    aliquotaEfetivaCSLL: 0.32 * 0.09,
  },
  SERVICOS_ATE_120K: {
    irpj: 0.16,
    csll: 0.32,
    artigo: 'Art. 220, §4º',
    descricao: 'Serviços em geral com receita bruta anual até R$ 120.000',
    aliquotaEfetivaIRPJ: 0.16 * 0.15,
    aliquotaEfetivaCSLL: 0.32 * 0.09,
    requisitos: [
      'Receita bruta anual <= R$ 120.000',
      'Não se aplica a serviços hospitalares',
      'Não se aplica a profissões regulamentadas (Art. 220 §5º, II)',
    ],
  },
  ATIVIDADE_IMOBILIARIA: {
    irpj: 0.08,
    csll: 0.12,
    artigo: 'Art. 220, §7º + Art. 224',
    descricao: 'Loteamento, incorporação, construção p/ venda',
    aliquotaEfetivaIRPJ: 0.08 * 0.15,
    aliquotaEfetivaCSLL: 0.12 * 0.09,
    nota: 'Receita = montante efetivamente recebido (regime de caixa)',
  },
  TRANSPORTE_CARGA: {
    irpj: 0.08,
    csll: 0.12,
    artigo: 'Art. 220, caput',
    descricao: 'Transporte de carga',
    aliquotaEfetivaIRPJ: 0.08 * 0.15,
    aliquotaEfetivaCSLL: 0.12 * 0.09,
  },
};

// ============================================================================
// BLOCO 3 — ADIÇÕES AO LUCRO LÍQUIDO (Art. 260)
// Tipo: T = temporária, D = definitiva, C = condicional
// ============================================================================

const ADICOES = [
  {
    id: 1,
    descricao: 'Custos/despesas/encargos não dedutíveis',
    artigo: 'Art. 260, I',
    tipo: 'D',
    operacao: '+',
    estrategia: 'Revisar classificação contábil; reclassificar se possível',
  },
  {
    id: 2,
    descricao: 'Resultados/receitas não incluídos no lucro líquido mas tributáveis',
    artigo: 'Art. 260, II',
    tipo: 'D',
    operacao: '+',
    estrategia: 'Garantir que todas as receitas estejam na contabilidade',
  },
  {
    id: 3,
    descricao: 'Quantias retiradas de lucros/fundos não tributados p/ aumento de capital',
    artigo: 'Art. 260, parágrafo único, I',
    tipo: 'D',
    operacao: '+',
    estrategia: 'Planejar distribuição de lucros tributados',
  },
  {
    id: 4,
    descricao: 'Pagamentos a sociedade simples controlada por diretores/parentes',
    artigo: 'Art. 260, parágrafo único, II',
    tipo: 'D',
    operacao: '+',
    estrategia: 'Evitar pagamentos a sociedades controladas por diretores',
  },
  {
    id: 5,
    descricao: 'Perdas em operações day-trade',
    artigo: 'Art. 260, parágrafo único, III',
    tipo: 'C',
    operacao: '+',
    estrategia: 'Compensar apenas com ganhos de day-trade (Art. 261, IV)',
  },
  {
    id: 6,
    descricao: 'Alimentação de sócios, acionistas e administradores',
    artigo: 'Art. 260, parágrafo único, IV (Lei 9.249/95, Art. 13, IV)',
    tipo: 'D',
    operacao: '+',
    estrategia: 'Usar PAT para alimentação dedutível; excluir sócios do benefício',
  },
  {
    id: 7,
    descricao: 'Contribuições não compulsórias (exceto seguro/saúde/previdência)',
    artigo: 'Art. 260, parágrafo único, V (Lei 9.249/95, Art. 13, V)',
    tipo: 'D',
    operacao: '+',
    estrategia: 'Direcionar contribuições para planos de saúde/previdência (dedutíveis)',
  },
  {
    id: 8,
    descricao: 'Doações não enquadradas nos Art. 377 e Art. 385',
    artigo: 'Art. 260, parágrafo único, VI (Lei 9.249/95, Art. 13, VI)',
    tipo: 'D',
    operacao: '+',
    estrategia: 'Doar dentro dos limites legais (até 2% lucro operacional)',
  },
  {
    id: 9,
    descricao: 'Despesas com brindes',
    artigo: 'Art. 260, parágrafo único, VII (Lei 9.249/95, Art. 13, VII)',
    tipo: 'D',
    operacao: '+',
    estrategia: 'Reclassificar como material de propaganda/publicidade se possível',
  },
  {
    id: 10,
    descricao: 'CSLL registrada como despesa operacional',
    artigo: 'Art. 260, parágrafo único, VIII (Lei 9.316/96, Art. 1º)',
    tipo: 'D',
    operacao: '+',
    estrategia: 'Inevitável; CSLL nunca é dedutível do IRPJ',
  },
  {
    id: 11,
    descricao: 'Perdas em renda variável e swap que excedem ganhos',
    artigo: 'Art. 260, parágrafo único, IX (Lei 8.981/95, Art. 76, §4º)',
    tipo: 'T',
    operacao: '+',
    estrategia: 'Controlar na Parte B do LALUR; compensar quando houver ganhos futuros',
  },
  {
    id: 12,
    descricao: 'Receitas de previdência complementar (regime competência vs realização)',
    artigo: 'Art. 260, parágrafo único, X (Lei 11.948/09, Art. 5º)',
    tipo: 'T',
    operacao: '+',
    estrategia: 'Excluir quando da realização (Art. 261, VI)',
  },
  {
    id: 13,
    descricao: 'Resultados negativos de cooperativas com não-associados',
    artigo: 'Art. 260, parágrafo único, XI',
    tipo: 'D',
    operacao: '+',
    estrategia: 'Segregar atos cooperativos dos não-cooperativos',
  },
  {
    id: 14,
    descricao: 'Depreciação/amortização contábil após atingir custo de aquisição',
    artigo: 'Art. 260, parágrafo único, XII',
    tipo: 'D',
    operacao: '+',
    estrategia: 'Controlar depreciação acumulada por bem; não depreciar além do custo',
  },
  {
    id: 15,
    descricao: 'Saldo de depreciação acelerada incentivada na alienação do bem',
    artigo: 'Art. 260, parágrafo único, XIII',
    tipo: 'T',
    operacao: '+',
    estrategia: 'Planejar alienação considerando saldo de depreciação acelerada',
  },
  // --- Adições adicionais comuns (referenciadas em outros artigos do RIR) ---
  {
    id: 16,
    descricao: 'Multas por infrações fiscais (punitivas)',
    artigo: 'Art. 311, §5º',
    tipo: 'D',
    operacao: '+',
    estrategia: 'Evitar multas; distinguir multas compensatórias (dedutíveis) de punitivas',
  },
  {
    id: 17,
    descricao: 'Provisões não dedutíveis (exceto férias, 13º, PDD permitida)',
    artigo: 'Art. 340 a 352',
    tipo: 'T',
    operacao: '+',
    estrategia: 'Reverter quando liquidada → gera exclusão futura',
  },
  {
    id: 18,
    descricao: 'Resultado negativo de equivalência patrimonial',
    artigo: 'Art. 389',
    tipo: 'T',
    operacao: '+',
    estrategia: 'Controlado na Parte B; excluir na realização do investimento',
  },
  {
    id: 19,
    descricao: 'Gratificações/participações no resultado a dirigentes/administradores estatutários (indedutíveis p/ IRPJ)',
    artigo: 'Art. 315 + Art. 527 (Lei 4.506/64, Art. 45, §3º; DL 1.598/77, Art. 58, p.ú.)',
    tipo: 'D',
    operacao: '+',
    estrategia: 'Converter em pró-labore (dedutível) ou JCP. ATENÇÃO: (1) Gratificações a empregados em geral são '
      + 'dedutíveis sem limite (IN 1.700/17, Art. 80). (2) Para CSLL, gratificações a administradores SÃO dedutíveis '
      + '(IN 1.700/17, Anexo I, item 85 — "não aplicável à CSLL"). (3) Diretores-empregados CLT: tema controvertido '
      + '— CARF tem decisões favoráveis à dedutibilidade (Ac. 1301003.760); STJ diverge (REsp 1.948.478/SP). '
      + 'Avaliar risco antes de adicionar ou excluir.',
    subtipos: {
      ADMINISTRADOR_ESTATUTARIO: {
        descricao: 'Dirigente/administrador estatutário (sem vínculo CLT)',
        dedutivelIRPJ: false,
        dedutivelCSLL: true,
        artigo: 'Art. 315 (IRPJ) / IN 1.700/17, Anexo I, item 85 (CSLL)',
      },
      DIRETOR_EMPREGADO_CLT: {
        descricao: 'Diretor com vínculo empregatício CLT e subordinação',
        dedutivelIRPJ: 'CONTROVERTIDO',
        dedutivelCSLL: true,
        artigo: 'CARF Ac. 9101-004.773 / REsp 1.746.268/SP (STJ favorável) / REsp 1.948.478/SP (STJ desfavorável)',
        nota: 'Risco médio — favorável no CARF, oscilante no STJ. Documentar subordinação CLT.',
      },
      EMPREGADO_GERAL: {
        descricao: 'Gratificações a empregados em geral (não administradores)',
        dedutivelIRPJ: true,
        dedutivelCSLL: true,
        artigo: 'IN RFB 1.700/2017, Art. 80 — dedutível sem limite',
      },
    },
  },
  {
    id: 20,
    descricao: 'Pagamento sem causa / beneficiário não identificado',
    artigo: 'Art. 674',
    tipo: 'D',
    operacao: '+',
    estrategia: 'SEMPRE identificar beneficiário; tributação exclusiva 35%',
  },
  {
    id: 21,
    descricao: 'Excesso de JCP acima dos limites legais',
    artigo: 'Art. 355 a 358',
    tipo: 'D',
    operacao: '+',
    estrategia: 'Calcular JCP dentro dos limites de PL × TJLP e 50% lucro/reservas',
  },
  {
    id: 22,
    descricao: 'Depreciação contábil acima das taxas fiscais',
    artigo: 'Art. 311 a 323',
    tipo: 'T',
    operacao: '+',
    estrategia: 'Usar taxas fiscais = contábeis quando possível; controlar diferença',
  },
  {
    id: 23,
    descricao: 'Despesas com tributos contestados judicialmente (sem depósito)',
    artigo: 'Art. 311, §2º',
    tipo: 'T',
    operacao: '+',
    estrategia: 'Depositar judicialmente o valor integral permite dedução imediata',
  },
  {
    id: 24,
    descricao: 'Royalties pagos acima dos limites a vinculadas',
    artigo: 'Art. 362 a 365',
    tipo: 'D',
    operacao: '+',
    estrategia: 'Respeitar limites de dedutibilidade de royalties',
  },
  {
    id: 25,
    descricao: 'Excesso de preço de transferência (importações de vinculadas)',
    artigo: 'Art. 242, §8º',
    tipo: 'D',
    operacao: '+',
    estrategia: 'Documentar preços com métodos PIC, PRL ou CPL',
  },
  {
    id: 26,
    descricao: 'Juros de subcapitalização acima dos limites',
    artigo: 'Art. 250 a 251',
    tipo: 'D',
    operacao: '+',
    estrategia: 'Manter dívida/PL dentro dos limites (2:1 vinculada; 0.3:1 paraíso)',
  },
  {
    id: 27,
    descricao: 'Despesas não comprovadas ou sem documentação',
    artigo: 'Art. 311',
    tipo: 'D',
    operacao: '+',
    estrategia: 'Sempre manter documentação fiscal completa',
  },
  {
    id: 28,
    descricao: 'Perdas em créditos não enquadradas nos critérios legais',
    artigo: 'Art. 340 a 345',
    tipo: 'D',
    operacao: '+',
    estrategia: 'Enquadrar perdas nos critérios da PDD fiscal',
  },
];

// ============================================================================
// BLOCO 4 — EXCLUSÕES DO LUCRO LÍQUIDO (Art. 261)
// ============================================================================

const EXCLUSOES = [
  {
    id: 1,
    descricao: 'Valores dedutíveis não computados no lucro líquido',
    artigo: 'Art. 261, I',
    tipo: 'D',
    operacao: '-',
    economia: 'Até 25% do valor excluído',
    requisitos: 'Autorizado pelo RIR',
  },
  {
    id: 2,
    descricao: 'Resultados/receitas incluídos no LL mas não tributáveis',
    artigo: 'Art. 261, II',
    tipo: 'D',
    operacao: '-',
    economia: 'Até 25% do valor',
    requisitos: 'Previsto no RIR como não tributável',
  },
  {
    id: 3,
    descricao: 'Compensação de prejuízos fiscais (trava 30%)',
    artigo: 'Art. 261, III',
    tipo: 'D',
    operacao: '-',
    economia: 'Até 25% da compensação (7,5% do lucro ajustado)',
    requisitos: 'Manter livros/documentos comprobatórios; limite 30%',
  },
  {
    id: 4,
    descricao: 'Rendimentos de reforma agrária (desapropriação)',
    artigo: 'Art. 261, parágrafo único, I (CF Art. 184, §5º)',
    tipo: 'D',
    operacao: '-',
    economia: '25% do ganho',
    requisitos: 'Ser desapropriado para fins de reforma agrária',
  },
  {
    id: 5,
    descricao: 'Dividendos do FND',
    artigo: 'Art. 261, parágrafo único, II',
    tipo: 'D',
    operacao: '-',
    economia: '25% dos dividendos',
    requisitos: 'Dividendos anuais mínimos do FND',
  },
  {
    id: 6,
    descricao: 'Juros reais de NTN (PND) — na realização',
    artigo: 'Art. 261, parágrafo único, III',
    tipo: 'T',
    operacao: '-',
    economia: '25% dos juros',
    requisitos: 'Controlar na Parte B do LALUR',
  },
  {
    id: 7,
    descricao: 'Perdas de renda variável/swap adicionadas anteriormente',
    artigo: 'Art. 261, parágrafo único, IV',
    tipo: 'T',
    operacao: '-',
    economia: '25% das perdas recuperadas',
    requisitos: 'Até o limite de ganhos - perdas > 0 no período',
  },
  {
    id: 8,
    descricao: 'Reversão de provisões não dedutíveis',
    artigo: 'Art. 261, parágrafo único, V',
    tipo: 'T',
    operacao: '-',
    economia: '25% da reversão',
    requisitos: 'Provisão deve ter sido adicionada anteriormente',
  },
  {
    id: 9,
    descricao: 'Receitas de previdência complementar (na realização)',
    artigo: 'Art. 261, parágrafo único, VI',
    tipo: 'T',
    operacao: '-',
    economia: '25% do valor',
    requisitos: 'Adicionado anteriormente no regime de competência',
  },
  {
    id: 10,
    descricao: 'Compensação fiscal — horário gratuito rádio/TV',
    artigo: 'Art. 261, parágrafo único, VII',
    tipo: 'D',
    operacao: '-',
    economia: '25% da compensação',
    requisitos: 'Emissoras de rádio/TV obrigadas',
  },
  {
    id: 11,
    descricao: 'Créditos de ICMS/ISS (programas nota fiscal)',
    artigo: 'Art. 261, parágrafo único, VIII',
    tipo: 'D',
    operacao: '-',
    economia: '25% dos créditos',
    requisitos: 'Programas estaduais/municipais de estímulo fiscal',
  },
  {
    id: 12,
    descricao: 'Redução de multas/juros/encargos (REFIS/parcelamentos)',
    artigo: 'Art. 261, parágrafo único, IX (Lei 11.941/09, Art. 4º)',
    tipo: 'D',
    operacao: '-',
    economia: '25% da redução obtida',
    requisitos: 'Adesão ao programa de parcelamento',
  },
  {
    id: 13,
    descricao: 'Quotas de fundo de cobertura de seguro rural',
    artigo: 'Art. 261, parágrafo único, X',
    tipo: 'D',
    operacao: '-',
    economia: '25% das quotas',
    requisitos: 'Seguradoras, resseguradoras, empresas agroindustriais',
  },
  {
    id: 14,
    descricao: 'Crédito presumido IPI — Inovar-Auto',
    artigo: 'Art. 261, parágrafo único, XI',
    tipo: 'D',
    operacao: '-',
    economia: '25% do crédito',
    requisitos: 'Programa Inovar-Auto vigente',
  },
  // --- Exclusões comuns referenciadas em outros artigos ---
  {
    id: 15,
    descricao: 'Resultado positivo de equivalência patrimonial',
    artigo: 'Art. 389 (c/c Art. 261, II)',
    tipo: 'D',
    operacao: '-',
    economia: '25% do resultado MEP positivo',
    requisitos: 'Investimento em controlada/coligada avaliada por MEP',
  },
  {
    id: 16,
    descricao: 'Lucros e dividendos recebidos de PJ brasileira',
    artigo: 'Art. 261, II + Lei 9.249/95, Art. 10',
    tipo: 'D',
    operacao: '-',
    economia: '25% dos dividendos',
    requisitos: 'Dividendos de PJ tributada no Brasil',
    nota: 'ATENÇÃO: Verificar LC 214/2025 — possível tributação de dividendos a partir de 2026',
  },
  {
    id: 17,
    descricao: 'Depreciação acelerada incentivada (SUDAM/SUDENE)',
    artigo: 'Art. 324 a 328',
    tipo: 'T',
    operacao: '-',
    economia: 'Antecipação de 25% do valor do bem',
    requisitos: 'Projeto aprovado SUDAM/SUDENE; máquinas/equipamentos novos',
  },
  {
    id: 18,
    descricao: 'Subvenção para investimento (Art. 30, Lei 12.973/14)',
    artigo: 'Art. 261, II + Lei 12.973/14, Art. 30',
    tipo: 'C',
    operacao: '-',
    economia: '25% da subvenção',
    requisitos: 'Registrar como reserva de lucros; não distribuir',
    nota: 'VERIFICAR: LC 214/2025 pode ter alterado estas regras',
  },
  {
    id: 19,
    descricao: 'Ganho de capital diferido — permuta imobiliária',
    artigo: 'Art. 261, II (atividades imobiliárias)',
    tipo: 'T',
    operacao: '-',
    economia: '25% do ganho diferido',
    requisitos: 'PJ com atividade imobiliária; permuta sem torna ou com torna parcial',
  },
];

// ============================================================================
// BLOCO 5 — TAXAS DE DEPRECIAÇÃO FISCAL (Art. 311 a 330)
// ============================================================================

const DEPRECIACAO = {
  tabela: [
    { bem: 'Edifícios e construções', taxaAnual: 0.04, vidaUtil: 25, artigo: 'Art. 311 + IN RFB 1.700/17' },
    { bem: 'Instalações', taxaAnual: 0.10, vidaUtil: 10, artigo: 'Art. 311' },
    { bem: 'Máquinas e equipamentos', taxaAnual: 0.10, vidaUtil: 10, artigo: 'Art. 311' },
    { bem: 'Móveis e utensílios', taxaAnual: 0.10, vidaUtil: 10, artigo: 'Art. 311' },
    { bem: 'Veículos de passageiros', taxaAnual: 0.20, vidaUtil: 5, artigo: 'Art. 311' },
    { bem: 'Veículos de carga', taxaAnual: 0.20, vidaUtil: 5, artigo: 'Art. 311' },  // pode ser 25% (4 anos)
    { bem: 'Computadores e periféricos', taxaAnual: 0.20, vidaUtil: 5, artigo: 'Art. 311' },
    { bem: 'Software (adquirido)', taxaAnual: 0.20, vidaUtil: 5, artigo: 'Art. 311' },
    { bem: 'Equipamentos de comunicação', taxaAnual: 0.10, vidaUtil: 10, artigo: 'Art. 311' },
    { bem: 'Ferramentas', taxaAnual: 0.20, vidaUtil: 5, artigo: 'Art. 311' },
    { bem: 'Tratores', taxaAnual: 0.25, vidaUtil: 4, artigo: 'Art. 311' },
    { bem: 'Semoventes e rebanho (reprodutores)', taxaAnual: 0.20, vidaUtil: 5, artigo: 'Art. 311' },
  ],
  // Art. 323 — Depreciação acelerada por turnos
  aceleracaoTurnos: [
    { turno: 1, horas: 8, multiplicador: 1.0, artigo: 'Art. 323' },
    { turno: 2, horas: 16, multiplicador: 1.5, artigo: 'Art. 323' },
    { turno: 3, horas: 24, multiplicador: 2.0, artigo: 'Art. 323' },
  ],
  // Art. 322 — Bens usados
  bensUsados: {
    artigo: 'Art. 322',
    regra: 'Vida útil = MAX(metade da vida útil normal, restante da vida útil)',
  },
};

// ============================================================================
// BLOCO 6 — INCENTIVOS FISCAIS (Deduções do IRPJ Devido)
// Base Legal: Art. 226 (mensal) + Art. 228 (anual) + Art. 625-646
// ============================================================================

const INCENTIVOS_FISCAIS = [
  {
    id: 'PAT',
    descricao: 'Programa de Alimentação do Trabalhador',
    artigo: 'Art. 226, I + Art. 641-646',
    limitePercentualIRPJ: 0.04, // 4% do IRPJ devido (sem adicional)
    base: 'IRPJ_NORMAL',
    requisitos: ['Registro no MTE', 'Beneficiar trabalhadores com até 5 SM'],
    calculoDeducao: 'despesa_PAT × 0.15 (limitado a 4% do IRPJ normal)',
  },
  {
    id: 'FIA',
    descricao: 'Fundo da Criança e do Adolescente',
    artigo: 'Art. 226, II + Art. 636',
    limitePercentualIRPJ: 0.01, // 1% do IRPJ devido
    base: 'IRPJ_NORMAL',
    requisitos: ['Depósito no FIA federal/estadual/municipal'],
  },
  {
    id: 'FUNDO_IDOSO',
    descricao: 'Fundo do Idoso',
    artigo: 'Art. 226, II + Lei 12.213/10, Art. 3º',
    limitePercentualIRPJ: 0.01,
    base: 'IRPJ_NORMAL',
    requisitos: ['Depósito no Fundo do Idoso'],
  },
  {
    id: 'ROUANET',
    descricao: 'Lei Rouanet — Atividades Culturais/Artísticas',
    artigo: 'Art. 226, III + Lei 8.313/91',
    limitePercentualIRPJ: 0.04,
    base: 'IRPJ_NORMAL',
    requisitos: ['Projeto aprovado pelo MinC', 'Doação ou patrocínio'],
  },
  {
    id: 'VALE_CULTURA',
    descricao: 'Vale-Cultura',
    artigo: 'Art. 226, IV + Lei 12.761/12',
    limitePercentualIRPJ: 0.01,
    base: 'IRPJ_NORMAL',
    requisitos: ['Programa de Cultura do Trabalhador'],
  },
  {
    id: 'AUDIOVISUAL',
    descricao: 'Atividades Audiovisuais (FUNCINES)',
    artigo: 'Art. 226, V + MP 2.228-1/01',
    limitePercentualIRPJ: 0.03,
    base: 'IRPJ_NORMAL',
    requisitos: ['Investimentos/patrocínios em audiovisual'],
  },
  {
    id: 'ESPORTE',
    descricao: 'Lei do Esporte — Projetos Desportivos',
    artigo: 'Art. 226, VI + Lei 11.438/06',
    limitePercentualIRPJ: 0.01,
    base: 'IRPJ_NORMAL',
    requisitos: ['Projeto desportivo aprovado'],
  },
  {
    id: 'LICENCA_MATERNIDADE',
    descricao: 'Prorrogação Licença-Maternidade/Paternidade',
    artigo: 'Art. 226, VII + Lei 11.770/08',
    limitePercentualIRPJ: null, // sem limite percentual; é o valor total da remuneração
    base: 'VALOR_TOTAL',
    requisitos: ['Empresa Cidadã', 'Remuneração no período de prorrogação'],
  },
  {
    id: 'PRONON',
    descricao: 'PRONON — Programa Nacional de Apoio à Oncologia',
    artigo: 'Art. 628 + Lei 12.715/12',
    limitePercentualIRPJ: 0.01,
    base: 'IRPJ_NORMAL',
    requisitos: ['Doação/patrocínio aprovado pelo Ministério da Saúde'],
  },
  {
    id: 'PRONAS_PCD',
    descricao: 'PRONAS/PCD — Pessoa com Deficiência',
    artigo: 'Art. 628 + Lei 12.715/12',
    limitePercentualIRPJ: 0.01,
    base: 'IRPJ_NORMAL',
    requisitos: ['Doação/patrocínio aprovado pelo Ministério da Saúde'],
  },
  {
    id: 'PESQUISA_TECNOLOGICA',
    descricao: 'P&D — Pesquisa e Desenvolvimento (Lei do Bem)',
    artigo: 'Lei 11.196/05 (Lei do Bem)',
    limitePercentualIRPJ: null,
    base: 'EXCLUSAO_LUCRO_REAL',
    requisitos: ['Empresa com lucro real', 'Dispêndios com P&D'],
    nota: 'Exclusão de 60% a 80% dos dispêndios com P&D da base do IRPJ/CSLL',
  },
];

// Limite global combinado (Art. 625)
const LIMITE_GLOBAL_INCENTIVOS = {
  artigo: 'Art. 625',
  percentual: 0.04, // 4% do IRPJ normal (sem adicional)
  incentivosSujeitos: ['PAT', 'FIA', 'FUNDO_IDOSO', 'ROUANET', 'AUDIOVISUAL', 'ESPORTE'],
  regra: 'PAT + FIA + Idoso + Rouanet + Audiovisual + Esporte <= 4% do IRPJ normal (sem adicional)',
  nota: 'Cada incentivo tem seu limite individual, mas a soma dos sujeitos ao teto global não pode ultrapassar 4% do IRPJ normal.',
};

// ============================================================================
// BLOCO 7 — SUBCAPITALIZAÇÃO (Art. 249 a 251)
// ============================================================================

const SUBCAPITALIZACAO = {
  vinculadaComParticipacao: {
    artigo: 'Art. 250, I',
    limiteDividaPL: 2.0, // 2:1 (dívida ≤ 2× participação da vinculada no PL)
    descricao: 'Endividamento com vinculada que tem participação societária',
  },
  vinculadaSemParticipacao: {
    artigo: 'Art. 250, II',
    limiteDividaPL: 2.0, // 2:1 (dívida ≤ 2× PL total)
    descricao: 'Endividamento com vinculada sem participação societária',
  },
  somatorioVinculadas: {
    artigo: 'Art. 250, III',
    limiteDividaPL: 2.0, // Somatório ≤ 2× somatório participações
    descricao: 'Total de endividamento com todas vinculadas',
  },
  paraisoFiscal: {
    artigo: 'Art. 251',
    limiteDividaPL: 0.30, // 30% do PL
    descricao: 'Endividamento com entidades em paraísos fiscais',
  },
};

// ============================================================================
// BLOCO 8 — FUNÇÕES DE CÁLCULO
// ============================================================================

/**
 * FÓRMULA MESTRE — Cálculo do IRPJ pelo Lucro Real
 * Base Legal: Art. 258 a 261
 *
 * @param {Object} dados
 * @param {number} dados.lucroLiquidoContabil   - Lucro líquido antes de IRPJ/CSLL
 * @param {number} dados.totalAdicoes            - Soma de todas as adições (Art. 260)
 * @param {number} dados.totalExclusoes          - Soma de todas as exclusões (Art. 261, I e II)
 * @param {number} dados.saldoPrejuizoFiscal     - Saldo de prejuízo fiscal acumulado (LALUR Parte B)
 * @param {number} dados.numMeses                - Nº de meses do período (1 a 12)
 * @param {number} dados.incentivosDedutiveis    - Total de incentivos que deduzem do IRPJ (Art. 226/228)
 * @param {number} dados.retencoesFonte          - IRRF retido na fonte compensável
 * @param {number} dados.estimativasPagas        - Estimativas já pagas (se anual)
 * @returns {Object} Resultado completo do cálculo
 */
function calcularIRPJLucroReal(dados) {
  const {
    lucroLiquidoContabil = 0,
    totalAdicoes = 0,
    totalExclusoes = 0,
    saldoPrejuizoFiscal = 0,
    numMeses = 12,
    incentivosDedutiveis = 0,
    retencoesFonte = 0,
    estimativasPagas = 0,
  } = dados;

  // ═══ FIX: Garantir tipos numéricos em todas as entradas ═══
  const _lc = Number(lucroLiquidoContabil) || 0;
  const _ta = Number(totalAdicoes) || 0;
  const _te = Number(totalExclusoes) || 0;
  const _sp = Number(saldoPrejuizoFiscal) || 0;
  const _nm = Number(numMeses) || 12;
  const _id = Number(incentivosDedutiveis) || 0;
  const _rf = Number(retencoesFonte) || 0;
  const _ep = Number(estimativasPagas) || 0;

  // PASSO 1: Lucro Líquido Contábil — Art. 259
  const passo1_lucroLiquido = _lc;

  // PASSO 2: + Adições obrigatórias — Art. 260
  const passo2_adicoes = _ta;

  // PASSO 3: - Exclusões permitidas — Art. 261
  const passo3_exclusoes = _te;

  // PASSO 4: = Lucro Real antes da compensação
  const passo4_lucroAntesCompensacao = passo1_lucroLiquido + passo2_adicoes - passo3_exclusoes;

  // PASSO 5: - Compensação de prejuízos — Art. 261, III (trava 30%)
  const resultadoCompensacao = compensarPrejuizo(passo4_lucroAntesCompensacao, _sp);
  const passo5_compensacao = resultadoCompensacao.compensacao;

  // PASSO 6: = Lucro Real (base de cálculo do IRPJ)
  const passo6_lucroReal = resultadoCompensacao.lucroRealFinal;

  // PASSO 7: × 15% = IRPJ normal — Art. 225
  const passo7_irpjNormal = Math.max(passo6_lucroReal, 0) * CONSTANTES.IRPJ_ALIQUOTA_NORMAL;

  // PASSO 8: Adicional de 10% — Art. 225, parágrafo único
  const limiteAdicional = CONSTANTES.IRPJ_LIMITE_ADICIONAL_MES * _nm;
  const baseAdicional = Math.max(passo6_lucroReal - limiteAdicional, 0);
  const passo8_adicionalIRPJ = baseAdicional * CONSTANTES.IRPJ_ALIQUOTA_ADICIONAL;

  // PASSO 9: IRPJ Devido = normal + adicional
  const passo9_irpjDevido = passo7_irpjNormal + passo8_adicionalIRPJ;

  // PASSO 10: - Deduções do IRPJ (incentivos fiscais) — Art. 226 / Art. 228
  const passo10_deducoes = Math.min(_id, passo7_irpjNormal);
  // NOTA: Incentivos geralmente só deduzem do IRPJ normal, NÃO do adicional

  // PASSO 11: - Retenções na fonte (IRRF) + estimativas pagas
  const passo11_retencoes = _rf + _ep;

  // PASSO 12: = IRPJ a Pagar (ou saldo negativo)
  const passo12_irpjAPagar = passo9_irpjDevido - passo10_deducoes - passo11_retencoes;

  return {
    // Detalhamento dos passos
    passo1_lucroLiquido,
    passo2_adicoes,
    passo3_exclusoes,
    passo4_lucroAntesCompensacao,
    passo5_compensacao,
    passo6_lucroReal,
    passo7_irpjNormal,
    passo8_adicionalIRPJ,
    passo8_baseAdicional: baseAdicional,
    passo8_limiteAdicional: limiteAdicional,
    passo9_irpjDevido,
    passo10_deducoes,
    passo11_retencoes,
    passo12_irpjAPagar,

    // Dados auxiliares
    saldoPrejuizoRemanescente: resultadoCompensacao.saldoRemanescente,
    economiaCompensacao: resultadoCompensacao.economiaIRPJ,

    // Indicadores
    aliquotaEfetiva: passo6_lucroReal > 0
      ? (passo9_irpjDevido / passo6_lucroReal * 100).toFixed(2) + '%'
      : '0%',
    saldoNegativo: passo12_irpjAPagar < 0,
    valorSaldoNegativo: passo12_irpjAPagar < 0 ? Math.abs(passo12_irpjAPagar) : 0,

    // ═══ ALIASES — compatibilidade com consumidores que esperam nomes curtos ═══
    // Mantém os nomes passo*_ para compatibilidade retroativa
    irpjNormal: _safe(passo7_irpjNormal),
    irpjAdicional: _safe(passo8_adicionalIRPJ),
    baseCalculo: _safe(passo6_lucroReal),
    lucroAntesCompensacao: _safe(passo4_lucroAntesCompensacao),
    compensacaoPrejuizo: _safe(passo5_compensacao),
    irpjDevido: _safe(passo9_irpjDevido),
    deducaoIncentivos: _safe(passo10_deducoes),
    irpjAPagar: _safe(passo12_irpjAPagar),
    retencoes: _safe(passo11_retencoes),
  };
}

/**
 * COMPENSAÇÃO DE PREJUÍZOS FISCAIS — Trava dos 30%
 * Base Legal: Art. 261, III + Art. 580-583
 *
 * @param {number} lucroRealAntes - Lucro Real antes da compensação
 * @param {number} saldoPrejuizo  - Saldo de prejuízo fiscal (LALUR Parte B)
 * @returns {Object}
 */
function compensarPrejuizo(lucroRealAntes, saldoPrejuizo) {
  // Se houver prejuízo no período, acumula
  if (lucroRealAntes <= 0) {
    return {
      lucroAntes: lucroRealAntes,
      limite30: 0,
      compensacao: 0,
      lucroRealFinal: 0, // Não há lucro real negativo; o prejuízo vai p/ Parte B
      saldoRemanescente: saldoPrejuizo + Math.abs(lucroRealAntes),
      prejuizoPeriodo: Math.abs(lucroRealAntes),
      economiaIRPJ: 0,
      economiaCSLL: 0,
      economiaTotal: 0,
    };
  }

  // Limite de 30% — Art. 261, III
  const limite30 = lucroRealAntes * CONSTANTES.TRAVA_COMPENSACAO_PREJUIZO;
  const compensacao = Math.min(limite30, saldoPrejuizo);
  const lucroRealFinal = lucroRealAntes - compensacao;
  const novoSaldo = saldoPrejuizo - compensacao;

  return {
    lucroAntes: lucroRealAntes,
    limite30,
    compensacao,
    lucroRealFinal,
    saldoRemanescente: novoSaldo,
    prejuizoPeriodo: 0,
    economiaIRPJ: _calcularIRPJ(lucroRealAntes) - _calcularIRPJ(lucroRealFinal),
    economiaCSLL: compensacao * 0.09,
    economiaTotal: (_calcularIRPJ(lucroRealAntes) - _calcularIRPJ(lucroRealFinal)) + (compensacao * 0.09),
  };
}

/**
 * CSLL — Cálculo em paralelo ao IRPJ
 * Base Legal: Lei 7.689/88 + Lei 9.249/95
 *
 * @param {Object} dados
 * @param {number} dados.lucroLiquidoContabil
 * @param {number} dados.adicoesCSLL           - Adições específicas para CSLL
 * @param {number} dados.exclusoesCSLL         - Exclusões específicas para CSLL
 * @param {number} dados.saldoBaseNegativa     - Base negativa de CSLL acumulada
 * @param {boolean} dados.ehInstituicaoFinanceira
 * @returns {Object}
 */
function calcularCSLL(dados) {
  const {
    lucroLiquidoContabil = 0,
    adicoesCSLL = 0,
    exclusoesCSLL = 0,
    saldoBaseNegativa = 0,
    ehInstituicaoFinanceira = false,
  } = dados;

  // ═══ FIX: Garantir tipos numéricos ═══
  const _lc = Number(lucroLiquidoContabil) || 0;
  const _ad = Number(adicoesCSLL) || 0;
  const _ex = Number(exclusoesCSLL) || 0;
  const _bn = Number(saldoBaseNegativa) || 0;

  const aliquota = ehInstituicaoFinanceira
    ? CONSTANTES.CSLL_ALIQUOTA_FINANCEIRAS
    : CONSTANTES.CSLL_ALIQUOTA_GERAL;

  // Base de cálculo ajustada
  const baseAjustada = _lc + _ad - _ex;

  // Compensação de base negativa (mesma trava de 30%)
  const compensacaoBaseNeg = compensarPrejuizo(baseAjustada, _bn);

  // CSLL devida
  const basePositiva = Math.max(compensacaoBaseNeg.lucroRealFinal, 0);
  const csllDevida = basePositiva * aliquota;

  return {
    baseAjustada,
    compensacaoBaseNegativa: compensacaoBaseNeg.compensacao,
    basePositiva,
    aliquota,
    aliquotaPercentual: (aliquota * 100).toFixed(0) + '%',
    csllDevida,
    saldoBaseNegativaRemanescente: compensacaoBaseNeg.saldoRemanescente,
    nota: 'CSLL NÃO tem incentivos dedutíveis (diferente do IRPJ)',

    // ═══ ALIAS — compatibilidade ═══
    csllAPagar: csllDevida,                    // Alias: mesmo valor pois CSLL não tem retenções deduzidas neste nível
    baseCSLL: basePositiva,                    // Alias
    csllNormal: csllDevida,                    // Alias
  };
}

/**
 * ESTIMATIVA MENSAL — Cálculo do IRPJ mensal por estimativa
 * Base Legal: Art. 219 a 225
 *
 * @param {Object} dados
 * @param {number} dados.receitaBrutaMensal     - Receita bruta do mês
 * @param {string} dados.tipoAtividade          - Chave da tabela PRESUNCOES
 * @param {number} dados.ganhosCapital           - Ganhos de capital no mês (Art. 222)
 * @param {number} dados.demaisReceitas          - Outras receitas não incluídas na RB (Art. 222)
 * @param {number} dados.irrfCompensavel         - IRRF retido no mês
 * @param {number} dados.incentivosDedutiveis    - Incentivos dedutíveis no mês
 * @returns {Object}
 */
function calcularEstimativaMensal(dados) {
  const {
    receitaBrutaMensal = 0,
    tipoAtividade = 'COMERCIO_INDUSTRIA',
    ganhosCapital = 0,
    demaisReceitas = 0,
    irrfCompensavel = 0,
    incentivosDedutiveis = 0,
  } = dados;

  // ═══ FIX: Aceitar 'receitaBruta' como alias de 'receitaBrutaMensal' ═══
  const _rbm = receitaBrutaMensal || Number(dados.receitaBruta) || 0;

  const presuncao = PRESUNCOES[tipoAtividade];
  if (!presuncao) {
    throw new Error(`Tipo de atividade "${tipoAtividade}" não encontrado em PRESUNCOES`);
  }

  // Base de cálculo estimada — Art. 220
  const basePresumida = _rbm * presuncao.irpj;
  const baseTotalEstimada = basePresumida + ganhosCapital + demaisReceitas;

  // IRPJ — Art. 225
  const irpjNormal = baseTotalEstimada * CONSTANTES.IRPJ_ALIQUOTA_NORMAL;

  // Adicional — Art. 225, parágrafo único
  const baseAdicional = Math.max(baseTotalEstimada - CONSTANTES.IRPJ_LIMITE_ADICIONAL_MES, 0);
  const irpjAdicional = baseAdicional * CONSTANTES.IRPJ_ALIQUOTA_ADICIONAL;

  // Total devido
  const irpjDevido = irpjNormal + irpjAdicional;

  // Deduções — Art. 226
  const deducoes = Math.min(incentivosDedutiveis, irpjNormal);
  const irpjAPagar = Math.max(irpjDevido - deducoes - irrfCompensavel, 0);

  // CSLL estimada (mesma lógica mas com presunção CSLL)
  // CORREÇÃO: Usar alíquota correta de CSLL (15% para inst. financeiras, 9% demais)
  const baseCSLL = _rbm * presuncao.csll + ganhosCapital + demaisReceitas;
  const ehFinanceira = dados.financeira === true || tipoAtividade === 'INSTITUICOES_FINANCEIRAS';
  const aliqCSLLEstimativa = ehFinanceira ? CONSTANTES.CSLL_ALIQUOTA_FINANCEIRAS : CONSTANTES.CSLL_ALIQUOTA_GERAL;
  const csllDevida = baseCSLL * aliqCSLLEstimativa;

  return {
    presuncaoUtilizada: presuncao.descricao,
    percentualPresuncaoIRPJ: (presuncao.irpj * 100).toFixed(1) + '%',
    percentualPresuncaoCSLL: (presuncao.csll * 100).toFixed(1) + '%',
    receitaBruta: _rbm,
    basePresumidaIRPJ: basePresumida,
    ganhosCapital,
    demaisReceitas,
    baseTotalEstimada,
    irpjNormal,
    irpjAdicional,
    irpjDevido,
    deducoes,
    irrfCompensavel,
    irpjAPagar,
    csll: {
      baseCSLL,
      csllDevida,
    },
    totalAPagar: irpjAPagar + csllDevida,
    artigos: 'Art. 219-225',
  };
}

/**
 * ATIVIDADES DIVERSIFICADAS — Art. 220, §3º
 * Quando a empresa tem múltiplas atividades, aplica presunção de cada uma.
 *
 * @param {Array} atividades - Array de { tipoAtividade, receitaBruta }
 * @param {number} ganhosCapital
 * @param {number} demaisReceitas
 * @returns {Object}
 */
function calcularEstimativaAtividadesDiversificadas(atividades, ganhosCapital = 0, demaisReceitas = 0) {
  let basePresumidaIRPJ = 0;
  let basePresumidaCSLL = 0;
  const detalhamento = [];

  for (const atv of atividades) {
    const presuncao = PRESUNCOES[atv.tipoAtividade];
    if (!presuncao) {
      throw new Error(`Tipo de atividade "${atv.tipoAtividade}" não encontrado`);
    }
    const parcIRPJ = atv.receitaBruta * presuncao.irpj;
    const parcCSLL = atv.receitaBruta * presuncao.csll;
    basePresumidaIRPJ += parcIRPJ;
    basePresumidaCSLL += parcCSLL;
    detalhamento.push({
      atividade: presuncao.descricao,
      receita: atv.receitaBruta,
      presuncaoIRPJ: presuncao.irpj,
      baseIRPJ: parcIRPJ,
      presuncaoCSLL: presuncao.csll,
      baseCSLL: parcCSLL,
    });
  }

  const baseTotalIRPJ = basePresumidaIRPJ + ganhosCapital + demaisReceitas;
  const baseTotalCSLL = basePresumidaCSLL + ganhosCapital + demaisReceitas;

  return {
    detalhamento,
    basePresumidaIRPJ,
    basePresumidaCSLL,
    baseTotalIRPJ,
    baseTotalCSLL,
    artigo: 'Art. 220, §3º',
  };
}

/**
 * BALANÇO DE SUSPENSÃO / REDUÇÃO — Art. 227
 * Mecanismo mais poderoso de economia no Lucro Real anual.
 *
 * @param {Object} dados
 * @param {number} dados.estimativaDevidaMes     - Estimativa calculada para o mês corrente
 * @param {number} dados.irpjRealAcumulado       - IRPJ pelo lucro real acumulado até o mês
 * @param {number} dados.irpjPagoAcumulado       - Soma das estimativas já pagas nos meses anteriores
 * @param {number} dados.csllRealAcumulada        - CSLL pelo lucro real acumulado até o mês
 * @param {number} dados.csllPagaAcumulada        - Soma das CSLLs já pagas
 * @returns {Object}
 */
function calcularSuspensaoReducao(dados) {
  const {
    estimativaDevidaMes = 0,
    irpjRealAcumulado = 0,
    irpjPagoAcumulado = 0,
    csllRealAcumulada = 0,
    csllPagaAcumulada = 0,
  } = dados;

  let irpjMes, situacaoIRPJ;
  let csllMes, situacaoCSLL;

  // --- IRPJ ---
  if (irpjRealAcumulado <= irpjPagoAcumulado) {
    // SUSPENSÃO TOTAL — Art. 227, caput
    irpjMes = 0;
    situacaoIRPJ = 'SUSPENSAO';
  } else if (irpjRealAcumulado < irpjPagoAcumulado + estimativaDevidaMes) {
    // REDUÇÃO — paga apenas a diferença
    irpjMes = irpjRealAcumulado - irpjPagoAcumulado;
    situacaoIRPJ = 'REDUCAO';
  } else {
    // Paga estimativa integral
    irpjMes = estimativaDevidaMes;
    situacaoIRPJ = 'INTEGRAL';
  }

  // --- CSLL (mesma lógica) ---
  const estimativaCSLLMes = dados.estimativaCSLLMes || 0;
  if (csllRealAcumulada <= csllPagaAcumulada) {
    csllMes = 0;
    situacaoCSLL = 'SUSPENSAO';
  } else if (csllRealAcumulada < csllPagaAcumulada + estimativaCSLLMes) {
    csllMes = csllRealAcumulada - csllPagaAcumulada;
    situacaoCSLL = 'REDUCAO';
  } else {
    csllMes = estimativaCSLLMes;
    situacaoCSLL = 'INTEGRAL';
  }

  const economiaMes = estimativaDevidaMes - irpjMes + estimativaCSLLMes - csllMes;

  return {
    irpj: {
      estimativaDevida: estimativaDevidaMes,
      irpjRealAcumulado,
      irpjPagoAcumulado,
      valorAPagar: Math.max(irpjMes, 0),
      situacao: situacaoIRPJ,
    },
    csll: {
      estimativaDevida: estimativaCSLLMes,
      csllRealAcumulada,
      csllPagaAcumulada,
      valorAPagar: Math.max(csllMes, 0),
      situacao: situacaoCSLL,
    },
    economiaMes,
    requisitos: [
      'Balanço/balancete mensal levantado e transcrito no Diário (Art. 227, §1º, I)',
      'Observar leis comerciais e fiscais (Art. 227, §1º, I)',
      'Efeitos apenas para o período em curso (Art. 227, §1º, II)',
    ],
    artigos: 'Art. 227 a 230',
  };
}

/**
 * JCP — Juros sobre Capital Próprio
 * Base Legal: Art. 355 a 358
 *
 * ATENÇÃO v5.0: A TJLP é divulgada TRIMESTRALMENTE pelo BACEN e varia significativamente.
 * NÃO usar valor fixo — consultar taxa vigente no período em:
 *   https://www.gov.br/receitafederal/pt-br/assuntos/orientacao-tributaria/pagamentos-e-parcelamentos/taxa-de-juros-de-longo-prazo-tjlp
 *
 * Referência de taxas recentes:
 *   Q1/2025: 7,97% a.a.  |  Q2/2025: ~8,50% a.a.  |  Q3-Q4/2025: ~8,77% a.a.
 *   Q1/2026: consultar BACEN (publicação até último dia útil do trimestre anterior)
 *
 * @param {Object} dados
 * @param {number} dados.patrimonioLiquido      - PL da empresa
 * @param {number} dados.tjlp                   - TJLP do período (ex: 0.0797 = 7,97% a.a.) — OBRIGATÓRIO, sem default
 * @param {number} dados.lucroLiquidoAntes      - Lucro líquido antes do JCP e IRPJ/CSLL
 * @param {number} dados.lucrosAcumulados        - Lucros acumulados + reservas de lucros
 * @param {number} dados.numMeses                - Meses do período
 * @returns {Object}
 */
function calcularJCP(dados) {
  const {
    patrimonioLiquido = 0,
    tjlp,
    lucroLiquidoAntes = 0,
    lucrosAcumulados = 0,
    numMeses = 12,
  } = dados;

  // ═══ FIX: Garantir tipos numéricos ═══
  const _pl = Number(patrimonioLiquido) || 0;
  const _ll = Number(lucroLiquidoAntes) || 0;
  const _la = Number(lucrosAcumulados) || 0;
  const _nm = Number(numMeses) || 12;

  // v5.0: Validação obrigatória da TJLP — não usar default
  if (tjlp === undefined || tjlp === null) {
    return {
      erro: true,
      mensagem: 'TJLP é OBRIGATÓRIA e não possui valor default. '
        + 'A TJLP para JCP é divulgada trimestralmente pelo BACEN. '
        + 'Consulte: https://www.gov.br/receitafederal/pt-br/assuntos/orientacao-tributaria/'
        + 'pagamentos-e-parcelamentos/taxa-de-juros-de-longo-prazo-tjlp',
      taxasReferencia: {
        'Q1_2025': '7,97% a.a. (0.0797)',
        'Q2_2025': '~8,50% a.a.',
        'Q3_Q4_2025': '~8,77% a.a.',
        'Q1_2026': 'Consultar BACEN',
      },
      artigo: 'Art. 355 c/c Lei 9.249/95, Art. 9º',
      jcpDedutivel: 0,
      economiaLiquida: 0,
    };
  }

  if (tjlp <= 0 || tjlp > 0.30) {
    return {
      erro: true,
      mensagem: `TJLP informada (${(tjlp * 100).toFixed(2)}%) parece incorreta. `
        + 'Valor deve ser decimal entre 0.01 e 0.30 (1% a 30% a.a.). '
        + 'Em 2025, a TJLP variou entre 7,97% e 8,77% a.a.',
      jcpDedutivel: 0,
      economiaLiquida: 0,
    };
  }

  // JCP máximo pela TJLP
  const tjlpProporcional = tjlp * (_nm / 12);
  const jcpMaximoTJLP = _pl * tjlpProporcional;

  // Limite 1: 50% do lucro líquido do exercício (antes do JCP e IRPJ)
  const limite1 = _ll * CONSTANTES.JCP_LIMITE_LUCRO_LIQUIDO;

  // Limite 2: 50% de (lucros acumulados + reservas de lucros)
  const limite2 = _la * CONSTANTES.JCP_LIMITE_LUCROS_ACUMULADOS;

  // CORREÇÃO: Lei 9.249/95, Art. 9°, §1° — JCP limitado ao MAIOR entre
  // 50% do lucro líquido do período OU 50% de lucros acumulados + reservas
  const limiteLegal = Math.max(limite1, limite2);
  const jcpDedutivel = Math.max(0, Math.min(jcpMaximoTJLP, limiteLegal));

  // Economia tributária — diferença incremental de IRPJ (respeita faixa do adicional)
  const limiteAdicionalPeriodo = CONSTANTES.IRPJ_LIMITE_ADICIONAL_MES * _nm;
  const lucroBaseAntesJCP = Math.max(0, _ll);
  const lucroBaseAposJCP = Math.max(0, _ll - jcpDedutivel);
  const irpjAntesJCP = lucroBaseAntesJCP * CONSTANTES.IRPJ_ALIQUOTA_NORMAL
    + Math.max(0, lucroBaseAntesJCP - limiteAdicionalPeriodo) * CONSTANTES.IRPJ_ALIQUOTA_ADICIONAL;
  const irpjAposJCP = lucroBaseAposJCP * CONSTANTES.IRPJ_ALIQUOTA_NORMAL
    + Math.max(0, lucroBaseAposJCP - limiteAdicionalPeriodo) * CONSTANTES.IRPJ_ALIQUOTA_ADICIONAL;
  const economiaIRPJ = irpjAntesJCP - irpjAposJCP;
  const economiaCSLL = jcpDedutivel * CONSTANTES.CSLL_ALIQUOTA_GERAL;
  const economiaTotal = economiaIRPJ + economiaCSLL;

  // Custo do JCP (IRRF 17,5% retido do beneficiário — LC 224/2025)
  const custoIRRF = jcpDedutivel * CONSTANTES.JCP_IRRF_ALIQUOTA;

  // Economia líquida
  const economiaLiquida = economiaTotal - custoIRRF;  // 34% - 17,5% = 16,5% do JCP (LC 224/2025)

  return {
    patrimonioLiquido: _pl,
    tjlp,
    tjlpProporcional,
    jcpMaximoTJLP,
    limite1_50LL: limite1,
    limite2_50Reservas: limite2,
    jcpDedutivel,
    economiaIRPJ,
    economiaCSLL,
    economiaTotal,
    custoIRRF,
    economiaLiquida,
    percentualEconomia: jcpDedutivel > 0
      ? ((economiaLiquida / jcpDedutivel) * 100).toFixed(1) + '%'
      : '0%',
    limiteUtilizado: jcpDedutivel === jcpMaximoTJLP ? 'TJLP'
      : jcpDedutivel === limiteLegal ? (limite1 >= limite2 ? '50% Lucro Líquido' : '50% Lucros Acumulados')
      : 'TJLP',
    artigos: 'Art. 355 a 358',
  };
}

/**
 * DEPRECIAÇÃO — Cálculo fiscal
 * Base Legal: Art. 311 a 330
 *
 * @param {Object} bem
 * @param {string} bem.tipo              - Chave da tabela DEPRECIACAO
 * @param {number} bem.custoAquisicao    - Valor de aquisição
 * @param {number} bem.depAcumulada      - Depreciação já acumulada
 * @param {number} bem.turnos            - 1, 2 ou 3 turnos (Art. 323)
 * @param {boolean} bem.usado             - Se é bem usado (Art. 322)
 * @param {number} bem.vidaUtilRestante   - Vida útil restante (se usado)
 * @param {boolean} bem.aceleradaIncentivada - Se tem depreciação acelerada incentivada
 * @returns {Object}
 */
function calcularDepreciacao(bem) {
  const {
    tipo = 'Máquinas e equipamentos',
    custoAquisicao = 0,
    depAcumulada = 0,
    turnos = 1,
    usado = false,
    vidaUtilRestante = null,
    aceleradaIncentivada = false,
  } = bem;

  // Buscar taxa na tabela
  const itemTabela = DEPRECIACAO.tabela.find(t => t.bem === tipo);
  let taxaNormal = itemTabela ? itemTabela.taxaAnual : 0.10;
  let vidaUtilNormal = itemTabela ? itemTabela.vidaUtil : 10;

  // Bem usado — Art. 322
  if (usado) {
    const metadeVidaUtil = vidaUtilNormal / 2;
    const restante = vidaUtilRestante || metadeVidaUtil;
    const vidaUtilFinal = Math.max(metadeVidaUtil, restante);
    taxaNormal = 1 / vidaUtilFinal;
  }

  // Aceleração por turnos — Art. 323
  const multiplicadorTurno = DEPRECIACAO.aceleracaoTurnos.find(t => t.turno === turnos);
  const taxaComTurnos = taxaNormal * (multiplicadorTurno ? multiplicadorTurno.multiplicador : 1);

  // Depreciação acelerada incentivada — Art. 324-328
  // (SUDAM/SUDENE: dedução integral no ano de aquisição)
  const taxaFinal = aceleradaIncentivada ? 1.0 : taxaComTurnos;

  // Valor depreciável restante
  const baseDepreciavel = Math.max(custoAquisicao - depAcumulada, 0);
  const depreciacaoAno = Math.min(baseDepreciavel, custoAquisicao * taxaFinal);

  return {
    tipo,
    custoAquisicao,
    depAcumulada,
    baseDepreciavel,
    taxaNormal,
    taxaComTurnos,
    turnos,
    multiplicadorTurno: multiplicadorTurno ? multiplicadorTurno.multiplicador : 1,
    aceleradaIncentivada,
    taxaFinal,
    depreciacaoAno,
    novaDepAcumulada: depAcumulada + depreciacaoAno,
    totalmenteDepreciado: (depAcumulada + depreciacaoAno) >= custoAquisicao,
    economiaIRPJ: bem.lucroReal != null
      ? _calcularIRPJ(bem.lucroReal) - _calcularIRPJ(bem.lucroReal - depreciacaoAno)
      : depreciacaoAno * CONSTANTES.IRPJ_ALIQUOTA_NORMAL,
    economiaCSLL: depreciacaoAno * CONSTANTES.CSLL_ALIQUOTA_GERAL,
    artigos: 'Art. 311-330',
  };
}

/**
 * INCENTIVOS FISCAIS — Cálculo das deduções do IRPJ devido
 * Base Legal: Art. 226 + Art. 228 + Art. 625-646
 *
 * @param {number} irpjNormal     - IRPJ normal (15%, sem adicional)
 * @param {Object} despesas       - Despesas com cada incentivo
 * @returns {Object}
 */
function calcularIncentivos(irpjNormal, despesas = {}) {
  // ═══ FIX: Aceitar AMBAS as convenções de chamada ═══
  // Convenção 1 (motor direto): calcularIncentivos(150000, { PAT: 10000 })
  // Convenção 2 (via mapeamento): calcularIncentivos({ irpjNormal: 150000, despesas: { PAT: 10000 } })
  if (typeof irpjNormal === 'object' && irpjNormal !== null) {
    despesas = irpjNormal.despesas || {};
    irpjNormal = irpjNormal.irpjNormal || 0;
  }
  // Garantir tipo numérico
  irpjNormal = Number(irpjNormal) || 0;

  const resultado = [];
  let totalDeducao = 0;
  let totalSujeitoLimiteGlobal = 0;

  // ---------- Fase 1: calcular dedução individual de cada incentivo ----------
  for (const incentivo of INCENTIVOS_FISCAIS) {
    const despesaIncentivo = despesas[incentivo.id] || 0;
    if (despesaIncentivo <= 0) continue;

    let deducaoCalculada = 0;

    if (incentivo.id === 'PAT') {
      // PAT: despesa × 15% da alíquota, limitado a 4% do IRPJ normal
      deducaoCalculada = despesaIncentivo * 0.15;
    } else if (incentivo.id === 'LICENCA_MATERNIDADE') {
      deducaoCalculada = despesaIncentivo; // Valor total da remuneração
    } else {
      deducaoCalculada = despesaIncentivo; // Doações diretas
    }

    const limiteIndividual = incentivo.limitePercentualIRPJ
      ? irpjNormal * incentivo.limitePercentualIRPJ
      : deducaoCalculada;

    const deducaoFinal = Math.min(deducaoCalculada, limiteIndividual);

    resultado.push({
      incentivo: incentivo.id,
      descricao: incentivo.descricao,
      despesa: despesaIncentivo,
      deducaoCalculada,
      limiteIndividual,
      deducaoFinal,
      sujeitoLimiteGlobal: LIMITE_GLOBAL_INCENTIVOS.incentivosSujeitos.includes(incentivo.id),
      artigo: incentivo.artigo,
    });

    totalDeducao += deducaoFinal;
  }

  // ---------- Fase 2: aplicar limite global de 4% (Art. 625) ----------
  const limiteGlobal = irpjNormal * LIMITE_GLOBAL_INCENTIVOS.percentual;
  let alertaGlobal = null;

  // Somar apenas os incentivos sujeitos ao teto global
  for (const item of resultado) {
    if (item.sujeitoLimiteGlobal) {
      totalSujeitoLimiteGlobal += item.deducaoFinal;
    }
  }

  if (totalSujeitoLimiteGlobal > limiteGlobal) {
    // Reduzir proporcionalmente cada incentivo sujeito ao teto global
    const fatorReducao = limiteGlobal / totalSujeitoLimiteGlobal;
    let totalReduzido = 0;

    for (const item of resultado) {
      if (item.sujeitoLimiteGlobal) {
        const deducaoOriginal = item.deducaoFinal;
        item.deducaoAntesLimiteGlobal = deducaoOriginal;
        item.deducaoFinal = Math.round(deducaoOriginal * fatorReducao * 100) / 100;
        totalReduzido += deducaoOriginal - item.deducaoFinal;
      }
    }

    // Recalcular totalDeducao após rateio
    totalDeducao = resultado.reduce((soma, item) => soma + item.deducaoFinal, 0);

    alertaGlobal = {
      tipo: 'LIMITE_GLOBAL_EXCEDIDO',
      mensagem: `Soma dos incentivos sujeitos ao teto global (R$ ${totalSujeitoLimiteGlobal.toFixed(2)}) `
        + `excede 4% do IRPJ normal (R$ ${limiteGlobal.toFixed(2)}). `
        + `Reduções proporcionais aplicadas — total cortado: R$ ${totalReduzido.toFixed(2)}.`,
      artigo: LIMITE_GLOBAL_INCENTIVOS.artigo,
      limiteGlobal,
      somaOriginal: totalSujeitoLimiteGlobal,
      fatorReducao,
    };
  }

  // Limite adicional: total não pode exceder o IRPJ normal
  const totalFinal = Math.min(totalDeducao, irpjNormal);

  return {
    incentivos: resultado,
    totalDeducaoCalculada: totalDeducao,
    totalDeducaoFinal: _safe(totalFinal),
    limiteGlobal: {
      percentual: LIMITE_GLOBAL_INCENTIVOS.percentual,
      valor: _safe(limiteGlobal),
      somaSujeita: _safe(totalSujeitoLimiteGlobal > limiteGlobal ? limiteGlobal : totalSujeitoLimiteGlobal),
      excedeu: totalSujeitoLimiteGlobal > limiteGlobal,
    },
    alertaGlobal,
    irpjNormal,
    percentualUtilizado: irpjNormal > 0
      ? ((totalFinal / irpjNormal) * 100).toFixed(2) + '%'
      : '0%',
    artigos: 'Art. 226, 228, 625-646',
  };
}

/**
 * PIS/COFINS NÃO-CUMULATIVO — Créditos
 * Base Legal: Lei 10.637/2002 e Lei 10.833/2003
 *
 * v5.0 — Correções:
 *   - Distingue aluguel PJ (gera crédito) de aluguel PF (NÃO gera crédito)
 *   - Crédito sobre depreciação: escolha entre método contábil e fiscal (1/48 ou 1/60)
 *   - Duas métricas de alíquota efetiva (líquida vs bruta)
 *   - Alertas automáticos para configurações de risco
 *
 * @param {Object} dados
 * @param {number} dados.receitaBruta             - Receita bruta total
 * @param {number} [dados.receitasIsentas=0]      - Receitas isentas / não tributáveis
 * @param {number} [dados.receitasExportacao=0]   - Receitas de exportação
 * @param {number} [dados.comprasBensRevenda=0]   - Compras para revenda
 * @param {number} [dados.insumosProducao=0]      - Insumos de produção (conceito amplo — STJ)
 * @param {number} [dados.energiaEletrica=0]      - Energia elétrica consumida
 * @param {number} [dados.alugueisPJ=0]           - Aluguéis pagos a PESSOA JURÍDICA (gera crédito)
 * @param {number} [dados.alugueisPF=0]           - Aluguéis pagos a PESSOA FÍSICA (NÃO gera crédito — Lei 10.637/02, Art. 3º, IV)
 * @param {number} [dados.depreciacaoBensCredito=0] - Depreciação para crédito (método contábil)
 * @param {string} [dados.depreciacaoBensMetodo='CONTABIL'] - 'CONTABIL', 'FISCAL_1_48' ou 'FISCAL_1_60'
 * @param {number} [dados.custoAquisicaoImobilizado=0] - Custo de aquisição (para método fiscal)
 * @param {number} [dados.mesesUsoImobilizado=0]       - Meses de uso (para método fiscal)
 * @param {number} [dados.devolucoes=0]            - Devoluções de vendas
 * @param {number} [dados.freteArmazenagem=0]      - Frete e armazenagem
 * @param {number} [dados.leasing=0]               - Contraprestações de leasing
 * @param {number} [dados.outrosCreditos=0]        - Outros créditos admitidos
 * @param {number} [dados.receitasAliquotaReduzidaLC224=0] - Receitas antes com alíquota zero/reduzida que,
 *   a partir de abr/2026, passam a recolher 10% das alíquotas padrão de PIS/COFINS (LC 224/2025).
 *   Informar o valor bruto dessas receitas; o motor aplica 0,165% (PIS) e 0,76% (COFINS).
 * @returns {Object} Cálculo completo com alertas
 */
function calcularPISCOFINSNaoCumulativo(dados) {
  const {
    receitaBruta = 0,
    receitasIsentas = 0,
    receitasExportacao = 0,
    // Créditos
    comprasBensRevenda = 0,
    insumosProducao = 0,
    energiaEletrica = 0,
    alugueisPJ = 0,
    alugueisPF = 0,          // v5.0: Aluguel pago a Pessoa Física — NÃO gera crédito (Lei 10.637/02, Art. 3º, IV)
    depreciacaoBensCredito = 0,     // v5.0: Renomeado para distinguir de depreciação contábil
    depreciacaoBensMetodo = 'CONTABIL', // v5.0: 'CONTABIL' ou 'FISCAL_1_48' ou 'FISCAL_1_60'
    custoAquisicaoImobilizado = 0,  // v5.0: Para cálculo pelo método fiscal (1/48 ou 1/60 por mês)
    mesesUsoImobilizado = 0,        // v5.0: Meses de uso do imobilizado para crédito fiscal
    devolucoes = 0,
    freteArmazenagem = 0,
    leasing = 0,
    outrosCreditos = 0,
    // v5.1: LC 224/2025 — receitas antes isentas que passam a 10% da alíquota padrão (abr/2026+)
    receitasAliquotaReduzidaLC224 = 0,
    // v5.0: Manter retrocompatibilidade com parâmetro antigo
    depreciacaoBens,
  } = dados;

  // v5.0: Retrocompatibilidade — se depreciacaoBens informado no formato antigo, usar como crédito contábil
  const depreciacaoCredito = depreciacaoBensCredito > 0 ? depreciacaoBensCredito : (depreciacaoBens || 0);

  // v5.0: Calcular crédito de depreciação pelo método adequado
  let depreciacaoBaseCredito = depreciacaoCredito;
  let depreciacaoMetodoUsado = depreciacaoBensMetodo;
  const alertasCredito = [];

  if (depreciacaoBensMetodo === 'FISCAL_1_48' && custoAquisicaoImobilizado > 0) {
    // Lei 10.637/02, Art. 3º, VI — crédito de 1/48 por mês sobre custo de aquisição
    // (Redação dada pela Lei 14.592/2023 para bens adquiridos a partir de jan/2024)
    depreciacaoBaseCredito = (custoAquisicaoImobilizado / 48) * Math.min(mesesUsoImobilizado, 48);
    depreciacaoMetodoUsado = 'FISCAL_1_48';
    alertasCredito.push({
      tipo: 'INFO_DEPRECIACAO_FISCAL',
      mensagem: `Crédito PIS/COFINS calculado pelo método fiscal: 1/48 do custo de aquisição `
        + `(R$ ${custoAquisicaoImobilizado.toFixed(2)}) × ${Math.min(mesesUsoImobilizado, 48)} meses `
        + `= R$ ${depreciacaoBaseCredito.toFixed(2)}`,
      artigo: 'Lei 10.637/02, Art. 3º, VI (redação Lei 14.592/2023)',
    });
  } else if (depreciacaoBensMetodo === 'FISCAL_1_60' && custoAquisicaoImobilizado > 0) {
    // Método antigo — 1/60 por mês (anterior à Lei 14.592/2023)
    depreciacaoBaseCredito = (custoAquisicaoImobilizado / 60) * Math.min(mesesUsoImobilizado, 60);
    depreciacaoMetodoUsado = 'FISCAL_1_60';
    alertasCredito.push({
      tipo: 'INFO_DEPRECIACAO_FISCAL',
      mensagem: `Crédito PIS/COFINS calculado pelo método fiscal antigo: 1/60 do custo de aquisição `
        + `(R$ ${custoAquisicaoImobilizado.toFixed(2)}) × ${Math.min(mesesUsoImobilizado, 60)} meses `
        + `= R$ ${depreciacaoBaseCredito.toFixed(2)}`,
      artigo: 'Lei 10.637/02, Art. 3º, VI (redação anterior)',
    });
  } else if (depreciacaoCredito > 0) {
    depreciacaoMetodoUsado = 'CONTABIL';
    alertasCredito.push({
      tipo: 'ALERTA_DEPRECIACAO_CONTABIL',
      mensagem: 'Crédito de PIS/COFINS sobre depreciação calculado pela taxa contábil. '
        + 'ATENÇÃO: o crédito fiscal correto segue regras próprias (1/48 do custo de aquisição '
        + 'para bens adquiridos a partir de jan/2024, ou 1/60 para anteriores). '
        + 'Informe custoAquisicaoImobilizado e mesesUsoImobilizado para cálculo preciso.',
      artigo: 'Lei 10.637/02, Art. 3º, VI',
      risco: 'Crédito calculado pode divergir do crédito fiscal permitido.',
    });
  }

  // v5.0: Alerta sobre aluguéis pagos a PF
  if (alugueisPF > 0) {
    alertasCredito.push({
      tipo: 'ALERTA_ALUGUEL_PF',
      mensagem: `Aluguel pago a Pessoa Física (R$ ${alugueisPF.toFixed(2)}) NÃO gera crédito PIS/COFINS. `
        + 'Apenas aluguéis pagos a Pessoa Jurídica permitem aproveitamento de crédito.',
      artigo: 'Lei 10.637/2002, Art. 3º, IV — "aluguéis de prédios, máquinas e equipamentos, '
        + 'pagos a pessoa jurídica"',
      valorSemCredito: alugueisPF,
    });
  }

  // Receita tributável
  const receitaTributavel = receitaBruta - receitasIsentas - receitasExportacao;

  // Débitos
  const pisSobreReceita = receitaTributavel * CONSTANTES.PIS_ALIQUOTA;
  const cofinsSobreReceita = receitaTributavel * CONSTANTES.COFINS_ALIQUOTA;

  // v5.1: LC 224/2025 — débitos sobre receitas antes com alíquota zero/reduzida (10% da alíquota padrão)
  let pisLC224 = 0;
  let cofinsLC224 = 0;
  if (receitasAliquotaReduzidaLC224 > 0) {
    pisLC224 = receitasAliquotaReduzidaLC224 * CONSTANTES.PIS_ALIQUOTA_REDUZIDA_LC224;
    cofinsLC224 = receitasAliquotaReduzidaLC224 * CONSTANTES.COFINS_ALIQUOTA_REDUZIDA_LC224;
    alertasCredito.push({
      tipo: 'INFO_LC224_ALIQUOTA_REDUZIDA',
      mensagem: `Receitas antes com alíquota zero/reduzida (R$ ${receitasAliquotaReduzidaLC224.toFixed(2)}) `
        + `agora recolhem 10% das alíquotas padrão: PIS 0,165% (R$ ${pisLC224.toFixed(2)}) `
        + `+ COFINS 0,76% (R$ ${cofinsLC224.toFixed(2)}) = R$ ${(pisLC224 + cofinsLC224).toFixed(2)}.`,
      artigo: 'LC 224/2025 — vigente a partir de abr/2026',
    });
  }

  // Débitos totais (padrão + LC 224/2025)
  const pisTotalDebito = pisSobreReceita + pisLC224;
  const cofinsTotalDebito = cofinsSobreReceita + cofinsLC224;

  // Base de créditos — somente aluguéis PJ e depreciação calculada
  const totalBaseCreditos = comprasBensRevenda + insumosProducao + energiaEletrica
    + alugueisPJ + depreciacaoBaseCredito + devolucoes + freteArmazenagem + leasing + outrosCreditos;

  // Créditos
  const creditoPIS = totalBaseCreditos * CONSTANTES.PIS_ALIQUOTA;
  const creditoCOFINS = totalBaseCreditos * CONSTANTES.COFINS_ALIQUOTA;

  // PIS/COFINS a pagar
  const pisAPagar = Math.max(pisTotalDebito - creditoPIS, 0);
  const cofinsAPagar = Math.max(cofinsTotalDebito - creditoCOFINS, 0);

  // Crédito excedente (saldo credor)
  const saldoCredorPIS = Math.max(creditoPIS - pisTotalDebito, 0);
  const saldoCredorCOFINS = Math.max(creditoCOFINS - cofinsTotalDebito, 0);

  // v5.0: Métricas claras de alíquota efetiva
  const totalBruto = pisTotalDebito + cofinsTotalDebito;
  const totalLiquido = pisAPagar + cofinsAPagar;

  return {
    receitaBruta,
    receitaTributavel,
    debitos: {
      pis: pisTotalDebito,
      cofins: cofinsTotalDebito,
      total: totalBruto,
      // Detalhamento por regime
      padrao: {
        pis: pisSobreReceita,
        cofins: cofinsSobreReceita,
        total: pisSobreReceita + cofinsSobreReceita,
      },
      lc224_aliquotaReduzida: {
        pis: pisLC224,
        cofins: cofinsLC224,
        total: pisLC224 + cofinsLC224,
        receitaBase: receitasAliquotaReduzidaLC224,
        nota: 'LC 224/2025 — 10% das alíquotas padrão sobre receitas antes com alíquota zero/reduzida (abr/2026+)',
      },
    },
    creditos: {
      baseTotal: totalBaseCreditos,
      pis: creditoPIS,
      cofins: creditoCOFINS,
      total: creditoPIS + creditoCOFINS,
      detalhamento: {
        comprasBensRevenda,
        insumosProducao,
        energiaEletrica,
        alugueisPJ,
        alugueisPF_semCredito: alugueisPF,
        depreciacaoBaseCredito,
        depreciacaoMetodoUsado,
        devolucoes,
        freteArmazenagem,
        leasing,
        outrosCreditos,
      },
    },
    aPagar: {
      pis: pisAPagar,
      cofins: cofinsAPagar,
      total: totalLiquido,
    },
    saldoCredor: {
      pis: saldoCredorPIS,
      cofins: saldoCredorCOFINS,
      total: saldoCredorPIS + saldoCredorCOFINS,
    },
    // v5.0: Duas métricas de alíquota efetiva com labels claros (Fix #5)
    aliquotaEfetiva: receitaBruta > 0
      ? (((pisAPagar + cofinsAPagar) / receitaBruta) * 100).toFixed(2) + '%'
      : '0%',
    aliquotaEfetivaBruta: receitaBruta > 0
      ? ((totalBruto / receitaBruta) * 100).toFixed(2) + '%'
      : '0%',
    aliquotaEfetivaDescricao: {
      liquida: 'Alíquota efetiva LÍQUIDA = (PIS+COFINS a pagar) ÷ Receita Bruta — representa a carga real após créditos',
      bruta: 'Alíquota efetiva BRUTA = (débitos PIS+COFINS) ÷ Receita Bruta — antes dos créditos',
      nota: 'Use a alíquota LÍQUIDA para comparar carga tributária real. '
        + 'Use a BRUTA para análise de composição e benchmarking setorial.',
    },
    economiaCreditos: creditoPIS + creditoCOFINS,
    alertas: alertasCredito,
    artigos: 'Lei 10.637/02, Lei 10.833/03',
  };
}

/**
 * SUBCAPITALIZAÇÃO — Verificação de limites
 * Base Legal: Art. 249 a 251
 *
 * @param {Object} dados
 * @returns {Object}
 */
function verificarSubcapitalizacao(dados) {
  const {
    patrimonioLiquido = 0,
    dividaVinculadaComParticipacao = 0,
    participacaoVinculadaPL = 0,
    dividaVinculadaSemParticipacao = 0,
    dividaParaisoFiscal = 0,
    jurosVinculada = 0,
    jurosParaiso = 0,
  } = dados;

  const alertas = [];

  // Art. 250, I — Vinculada com participação
  const limiteVinculadaComPart = participacaoVinculadaPL * SUBCAPITALIZACAO.vinculadaComParticipacao.limiteDividaPL;
  const excessoVinculadaComPart = Math.max(dividaVinculadaComParticipacao - limiteVinculadaComPart, 0);
  if (excessoVinculadaComPart > 0) {
    alertas.push({
      tipo: 'SUBCAPITALIZACAO_VINCULADA_PARTICIPACAO',
      artigo: 'Art. 250, I',
      excesso: excessoVinculadaComPart,
      jurosIndedutiveisEstimados: jurosVinculada * (excessoVinculadaComPart / dividaVinculadaComParticipacao),
    });
  }

  // Art. 250, II — Vinculada sem participação
  const limiteVinculadaSemPart = patrimonioLiquido * SUBCAPITALIZACAO.vinculadaSemParticipacao.limiteDividaPL;
  const excessoVinculadaSemPart = Math.max(dividaVinculadaSemParticipacao - limiteVinculadaSemPart, 0);
  if (excessoVinculadaSemPart > 0) {
    alertas.push({
      tipo: 'SUBCAPITALIZACAO_VINCULADA_SEM_PARTICIPACAO',
      artigo: 'Art. 250, II',
      excesso: excessoVinculadaSemPart,
    });
  }

  // Art. 251 — Paraíso fiscal
  const limiteParaiso = patrimonioLiquido * SUBCAPITALIZACAO.paraisoFiscal.limiteDividaPL;
  const excessoParaiso = Math.max(dividaParaisoFiscal - limiteParaiso, 0);
  if (excessoParaiso > 0) {
    alertas.push({
      tipo: 'SUBCAPITALIZACAO_PARAISO_FISCAL',
      artigo: 'Art. 251',
      excesso: excessoParaiso,
      jurosIndedutiveisEstimados: jurosParaiso * (excessoParaiso / dividaParaisoFiscal),
    });
  }

  return {
    patrimonioLiquido,
    limites: {
      vinculadaComParticipacao: limiteVinculadaComPart,
      vinculadaSemParticipacao: limiteVinculadaSemPart,
      paraisoFiscal: limiteParaiso,
    },
    excessos: {
      vinculadaComParticipacao: excessoVinculadaComPart,
      vinculadaSemParticipacao: excessoVinculadaSemPart,
      paraisoFiscal: excessoParaiso,
    },
    temExcesso: alertas.length > 0,
    alertas,
  };
}

// ============================================================================
// BLOCO 9 — COMPLIANCE E ALERTAS (Art. 293-309)
// ============================================================================

/**
 * Verifica indicadores de omissão de receita e riscos fiscais
 *
 * @param {Object} dados
 * @returns {Array} Lista de alertas
 */
function verificarCompliance(dados) {
  const {
    saldoCaixa = 0,
    entradasCaixa = 0,
    saidasCaixa = 0,
    depositosBancarios = 0,
    receitaDeclarada = 0,
    estoqueContabil = 0,
    estoqueFisico = 0,
    passivoBaixado = 0,
    suprimentosCaixaSemOrigem = 0,
  } = dados;

  const alertas = [];

  // Art. 293-295: Saldo credor de caixa
  if (saidasCaixa > entradasCaixa + saldoCaixa) {
    alertas.push({
      nivel: 'CRITICO',
      tipo: 'SALDO_CREDOR_CAIXA',
      artigo: 'Art. 293-295',
      descricao: 'Saídas de caixa excedem entradas sem justificativa',
      acao: 'Verificar e justificar todos os lançamentos de caixa',
      valorDiscrepancia: saidasCaixa - entradasCaixa - saldoCaixa,
    });
  }

  // Art. 296-298: Passivo fictício
  if (passivoBaixado > 0) {
    alertas.push({
      nivel: 'ALTO',
      tipo: 'PASSIVO_FICTICIO',
      artigo: 'Art. 296-298',
      descricao: 'Dívidas já pagas não baixadas do passivo',
      acao: 'Reconciliar passivo e baixar obrigações liquidadas',
      valor: passivoBaixado,
    });
  }

  // Suprimento de caixa sem origem
  if (suprimentosCaixaSemOrigem > 0) {
    alertas.push({
      nivel: 'CRITICO',
      tipo: 'SUPRIMENTO_SEM_ORIGEM',
      artigo: 'Art. 299-301',
      descricao: 'Depósitos/suprimentos no caixa sem documentação de origem',
      acao: 'Documentar origem de todos os recursos',
      valor: suprimentosCaixaSemOrigem,
    });
  }

  // Depósitos bancários incompatíveis
  if (depositosBancarios > receitaDeclarada * 1.1) {
    alertas.push({
      nivel: 'ALTO',
      tipo: 'DEPOSITOS_INCOMPATIVEIS',
      artigo: 'Art. 302-304',
      descricao: 'Depósitos bancários superam receita declarada em mais de 10%',
      acao: 'Justificar diferença entre depósitos e receita',
      valorDiscrepancia: depositosBancarios - receitaDeclarada,
    });
  }

  // Diferença de estoque
  if (Math.abs(estoqueContabil - estoqueFisico) > estoqueContabil * 0.05) {
    alertas.push({
      nivel: 'MEDIO',
      tipo: 'DIFERENCA_ESTOQUE',
      artigo: 'Art. 305',
      descricao: 'Estoque físico diverge do contábil em mais de 5%',
      acao: 'Realizar inventário e ajustar escrituração',
      diferenca: estoqueContabil - estoqueFisico,
    });
  }

  return alertas;
}

// ============================================================================
// BLOCO 10 — DECISÃO: TRIMESTRAL vs ANUAL (Art. 217 vs Art. 218)
// ============================================================================

/**
 * Recomenda o regime de apuração mais vantajoso
 * Base Legal: Art. 217 (trimestral) vs Art. 218-219 (anual por estimativa)
 *
 * @param {Object} dados
 * @param {Array}  dados.lucrosMensais      - Array com 12 lucros mensais estimados
 * @param {number} dados.prejuizoAcumulado  - Prejuízo fiscal acumulado
 * @param {boolean} dados.temInvestimento   - Se empresa faz investimentos significativos
 * @returns {Object}
 */
function recomendarRegime(dados) {
  const {
    lucrosMensais = [],
    prejuizoAcumulado = 0,
    temInvestimento = false,
  } = dados;

  // Análise de padrão de lucros
  const lucroTotal = lucrosMensais.reduce((a, b) => a + b, 0);
  const temPrejuizoEmAlgunsMeses = lucrosMensais.some(l => l < 0);
  const lucroConcentradoNoFinal = lucrosMensais.slice(9, 12).reduce((a, b) => a + b, 0) > lucroTotal * 0.5;
  const lucroConstante = (() => {
    if (lucroTotal <= 0) return false;
    const media = lucroTotal / 12;
    const desvio = lucrosMensais.reduce((sum, l) => sum + Math.pow(l - media, 2), 0) / 12;
    return Math.sqrt(desvio) / media < 0.3; // CV < 30%
  })();

  // Simulação Trimestral
  const trimestres = [
    lucrosMensais.slice(0, 3).reduce((a, b) => a + b, 0),
    lucrosMensais.slice(3, 6).reduce((a, b) => a + b, 0),
    lucrosMensais.slice(6, 9).reduce((a, b) => a + b, 0),
    lucrosMensais.slice(9, 12).reduce((a, b) => a + b, 0),
  ];

  let irpjTrimestral = 0;
  let saldoPrejTri = prejuizoAcumulado;
  for (const lucroTri of trimestres) {
    const comp = compensarPrejuizo(lucroTri, saldoPrejTri);
    saldoPrejTri = comp.saldoRemanescente;
    if (comp.lucroRealFinal > 0) {
      irpjTrimestral += comp.lucroRealFinal * 0.15;
      irpjTrimestral += Math.max(comp.lucroRealFinal - 60000, 0) * 0.10;
    }
  }

  // Simulação Anual
  const compAnual = compensarPrejuizo(lucroTotal, prejuizoAcumulado);
  let irpjAnual = 0;
  if (compAnual.lucroRealFinal > 0) {
    irpjAnual = compAnual.lucroRealFinal * 0.15;
    irpjAnual += Math.max(compAnual.lucroRealFinal - 240000, 0) * 0.10;
  }

  // Decisão
  let recomendacao, motivos = [];

  if (lucroConcentradoNoFinal || temPrejuizoEmAlgunsMeses) {
    recomendacao = 'ANUAL';
    motivos.push('Lucro concentrado no final ou meses com prejuízo → suspensão/redução economiza');
  } else if (lucroConstante && !temInvestimento) {
    recomendacao = 'TRIMESTRAL';
    motivos.push('Lucro constante e sem investimentos → trimestral é mais simples');
  } else {
    recomendacao = irpjAnual <= irpjTrimestral ? 'ANUAL' : 'TRIMESTRAL';
    motivos.push(`Simulação: IRPJ Trimestral = R$ ${irpjTrimestral.toFixed(2)} vs Anual = R$ ${irpjAnual.toFixed(2)}`);
  }

  if (temPrejuizoEmAlgunsMeses) {
    motivos.push('ANUAL permite suspensão de estimativas com balanço mensal (Art. 227)');
  }

  if (prejuizoAcumulado > 0) {
    motivos.push('Prejuízo acumulado: no trimestral, trava de 30% aplica por trimestre (4 vezes); no anual, aplica uma vez');
  }

  return {
    recomendacao,
    motivos,
    simulacao: {
      trimestral: {
        irpjTotal: irpjTrimestral,
        detalhamentoTrimestres: trimestres,
        saldoPrejuizoRemanescente: saldoPrejTri,
      },
      anual: {
        irpjTotal: irpjAnual,
        lucroRealFinal: compAnual.lucroRealFinal,
        compensacao: compAnual.compensacao,
        saldoPrejuizoRemanescente: compAnual.saldoRemanescente,
      },
      economia: Math.abs(irpjTrimestral - irpjAnual),
      regimeMaisBarato: irpjAnual <= irpjTrimestral ? 'ANUAL' : 'TRIMESTRAL',
    },
    alerta: 'Art. 229: A opção é IRRETRATÁVEL para todo o ano-calendário',
    artigos: 'Art. 217-219, Art. 227-229',
  };
}

// ============================================================================
// BLOCO 11 — OBRIGATORIEDADE DO LUCRO REAL (Art. 257)
// ============================================================================

/**
 * Verifica se a empresa é obrigada ao Lucro Real
 * Base Legal: Art. 257
 *
 * @param {Object} dados
 * @returns {Object}
 */
function verificarObrigatoriedadeLucroReal(dados) {
  const {
    receitaTotalAnterior = 0,
    ehInstituicaoFinanceira = false,
    temLucroExterior = false,
    temBeneficioFiscalIsencao = false,
    pagaEstimativa = false,
    ehFactoring = false,
    ehSecuritizadora = false,
  } = dados;

  const obrigada = (
    receitaTotalAnterior > CONSTANTES.LIMITE_RECEITA_LUCRO_REAL  // Art. 257, I
    || ehInstituicaoFinanceira    // Art. 257, II
    || temLucroExterior           // Art. 257, III
    || temBeneficioFiscalIsencao  // Art. 257, IV
    || pagaEstimativa             // Art. 257, V
    || ehFactoring                // Art. 257, VI
    || ehSecuritizadora           // Art. 257, VII
  );

  const motivos = [];
  if (receitaTotalAnterior > CONSTANTES.LIMITE_RECEITA_LUCRO_REAL)
    motivos.push(`Receita > R$ ${CONSTANTES.LIMITE_RECEITA_LUCRO_REAL.toLocaleString('pt-BR')} (Art. 257, I)`);
  if (ehInstituicaoFinanceira) motivos.push('Instituição financeira (Art. 257, II)');
  if (temLucroExterior) motivos.push('Lucros do exterior (Art. 257, III)');
  if (temBeneficioFiscalIsencao) motivos.push('Benefício fiscal de isenção/redução (Art. 257, IV)');
  if (pagaEstimativa) motivos.push('Paga por estimativa mensal (Art. 257, V)');
  if (ehFactoring) motivos.push('Atividade de factoring (Art. 257, VI)');
  if (ehSecuritizadora) motivos.push('Securitizadora de créditos (Art. 257, VII)');

  return { obrigada, motivos, artigo: 'Art. 257' };
}

// ============================================================================
// BLOCO 12 — SALDO NEGATIVO DE IRPJ (Art. 235)
// ============================================================================

/**
 * Calcula saldo negativo de IRPJ (crédito da empresa)
 *
 * @param {number} irpjDevido       - IRPJ calculado no período
 * @param {number} retencoesFonte   - IRRF retido na fonte
 * @param {number} estimativasPagas - Estimativas pagas durante o ano
 * @param {number} taxaSelic        - Taxa SELIC acumulada para atualização
 * @returns {Object}
 */
function calcularSaldoNegativo(irpjDevido, retencoesFonte, estimativasPagas, taxaSelic = 0) {
  const totalPago = retencoesFonte + estimativasPagas;
  const saldoNegativo = totalPago - irpjDevido;

  if (saldoNegativo <= 0) {
    return {
      temSaldoNegativo: false,
      irpjAPagar: Math.abs(saldoNegativo),
    };
  }

  return {
    temSaldoNegativo: true,
    valorOriginal: saldoNegativo,
    atualizacaoSelic: saldoNegativo * taxaSelic,
    valorAtualizado: saldoNegativo * (1 + taxaSelic),
    compensacao: 'Via PER/DCOMP (compensação com outros tributos federais)',
    restituicao: 'Possível via PER/DCOMP (mais demorado)',
    prazoDecadencial: '5 anos',
    alerta: 'Verificar retenções não compensadas — dinheiro potencialmente "esquecido"',
    artigo: 'Art. 235',
  };
}

// ============================================================================
// BLOCO 13 — SIMULADOR COMPLETO + OTIMIZADOR
// ============================================================================

/**
 * SIMULAÇÃO COMPLETA — Calcula tudo e identifica economia
 *
 * @param {Object} empresa - Todos os dados da empresa
 * @returns {Object} Resultado completo com otimizações
 */
function simularLucroRealCompleto(empresa) {
  const {
    // Dados contábeis
    lucroLiquidoContabil = 0,
    receitaBruta = 0,

    // Adições e Exclusões
    totalAdicoes = 0,
    totalExclusoes = 0,

    // Prejuízos
    saldoPrejuizoFiscal = 0,
    saldoBaseNegativaCSLL = 0,

    // JCP
    patrimonioLiquido = 0,
    tjlp,                            // v5.0: Sem default — obrigatório se PL > 0
    lucrosAcumulados = 0,

    // Incentivos
    despesasIncentivos = {},

    // Retenções
    retencoesFonte = 0,
    estimativasPagas = 0,

    // Configuração
    numMeses = 12,
    ehInstituicaoFinanceira = false,

    // v5.0: PIS/COFINS — integrar na simulação completa (Fix #6/#7)
    dadosPISCOFINS = null,       // Objeto com dados para calcularPISCOFINSNaoCumulativo
    retencoesPISCOFINS = 0,      // Retenções na fonte de PIS/COFINS (Art. 30 Lei 10.833/03)

    // v5.0: Cenários — variação percentual de receita (Fix #7)
    variacaoCenarios = { pessimista: -0.05, otimista: 0.05 },
  } = empresa;

  // 1. Calcular JCP máximo
  const jcp = calcularJCP({
    patrimonioLiquido,
    tjlp,
    lucroLiquidoAntes: lucroLiquidoContabil,
    lucrosAcumulados,
    numMeses,
  });

  // Se JCP retornou erro (TJLP não informada), tratar graciosamente
  const jcpValido = !jcp.erro;
  const jcpDedutivel = jcpValido ? jcp.jcpDedutivel : 0;

  // 2. Lucro líquido ajustado pelo JCP (JCP é dedutível como despesa financeira)
  const lucroAjustadoJCP = lucroLiquidoContabil - jcpDedutivel;

  // 3. Calcular IRPJ SEM otimização (baseline puro)
  const irpjSemOtimizacao = calcularIRPJLucroReal({
    lucroLiquidoContabil,
    totalAdicoes,
    totalExclusoes,
    saldoPrejuizoFiscal: 0,
    numMeses,
    incentivosDedutiveis: 0,
    retencoesFonte,
    estimativasPagas,
  });

  // 4. Calcular IRPJ COM otimização completa (JCP + compensação + incentivos)
  const irpjNormalParaIncentivos = Math.max(
    (lucroAjustadoJCP + totalAdicoes - totalExclusoes) * 0.70 * CONSTANTES.IRPJ_ALIQUOTA_NORMAL,
    0
  );
  const incentivos = calcularIncentivos(irpjNormalParaIncentivos, despesasIncentivos);

  const irpjComOtimizacao = calcularIRPJLucroReal({
    lucroLiquidoContabil: lucroAjustadoJCP,
    totalAdicoes,
    totalExclusoes,
    saldoPrejuizoFiscal,
    numMeses,
    incentivosDedutiveis: incentivos.totalDeducaoFinal,
    retencoesFonte,
    estimativasPagas,
  });

  // 4b. [FIX BUG #1] Cenário intermediário: COM compensação/incentivos, SEM JCP
  //     Necessário para calcular a economia REAL do JCP, pois a trava de 30%
  //     sobre o lucro ajustado muda quando o JCP reduz a base.
  //     Sem este cenário, a economia do JCP era calculada com taxa fixa de 34%,
  //     ignorando a interação com a compensação de prejuízos.
  const irpjNormalParaIncentivosSemJCP = Math.max(
    (lucroLiquidoContabil + totalAdicoes - totalExclusoes) * 0.70 * CONSTANTES.IRPJ_ALIQUOTA_NORMAL,
    0
  );
  const incentivosSemJCP = calcularIncentivos(irpjNormalParaIncentivosSemJCP, despesasIncentivos);

  const irpjSemJCPComCompensacao = calcularIRPJLucroReal({
    lucroLiquidoContabil,     // SEM dedução do JCP
    totalAdicoes,
    totalExclusoes,
    saldoPrejuizoFiscal,      // COM compensação de prejuízo (recalcula trava de 30%)
    numMeses,
    incentivosDedutiveis: incentivosSemJCP.totalDeducaoFinal,
    retencoesFonte,
    estimativasPagas,
  });

  const csllSemJCP = calcularCSLL({
    lucroLiquidoContabil,     // SEM dedução do JCP
    adicoesCSLL: totalAdicoes,
    exclusoesCSLL: totalExclusoes,
    saldoBaseNegativa: saldoBaseNegativaCSLL,  // COM compensação de base negativa
    ehInstituicaoFinanceira,
  });

  // 5. CSLL (com JCP)
  const csll = calcularCSLL({
    lucroLiquidoContabil: lucroAjustadoJCP,
    adicoesCSLL: totalAdicoes,
    exclusoesCSLL: totalExclusoes,
    saldoBaseNegativa: saldoBaseNegativaCSLL,
    ehInstituicaoFinanceira,
  });

  // v5.0: 5b. PIS/COFINS integrado (Fix #6)
  let pisCofins = null;
  let pisCofinsLiquido = 0;
  let pisCofinsBruto = 0;
  if (dadosPISCOFINS) {
    pisCofins = calcularPISCOFINSNaoCumulativo(dadosPISCOFINS);
    pisCofinsBruto = pisCofins.debitos.total;
    pisCofinsLiquido = pisCofins.aPagar.total;
  }

  // 6. Economia total
  const economiaTotalIRPJ = irpjSemOtimizacao.passo9_irpjDevido - irpjComOtimizacao.passo9_irpjDevido;

  // [FIX BUG #1] Economia REAL do JCP = diferença incremental ao adicionar JCP
  //   sobre o cenário que já tem compensação + incentivos.
  //   IRPJ: (devido sem JCP, com comp) - (devido com JCP, com comp)
  //   CSLL: (devida sem JCP, com comp) - (devida com JCP, com comp)
  //   Líquida: economia IRPJ+CSLL - custo IRRF do JCP
  const economiaJCP_IRPJ = jcpValido
    ? (irpjSemJCPComCompensacao.passo9_irpjDevido - irpjComOtimizacao.passo9_irpjDevido)
    : 0;
  const economiaJCP_CSLL = jcpValido
    ? (csllSemJCP.csllDevida - csll.csllDevida)
    : 0;
  const custoIRRF_JCP = jcpValido ? jcp.custoIRRF : 0;
  const economiaJCP = jcpValido
    ? (economiaJCP_IRPJ + economiaJCP_CSLL - custoIRRF_JCP)
    : 0;

  // v5.0: Carga total com labels claros (Fix #6)
  const irpjAPagar = Math.max(irpjComOtimizacao.passo12_irpjAPagar, 0);
  const csllDevida = csll.csllDevida;

  const cargaIRPJ_CSLL = irpjAPagar + csllDevida;
  const cargaTotalBruta = cargaIRPJ_CSLL + pisCofinsBruto;        // Inclui PIS/COFINS bruto (antes de retenções)
  const cargaTotalLiquida = cargaIRPJ_CSLL + Math.max(pisCofinsLiquido - retencoesPISCOFINS, 0); // Líquida de retenções

  // v5.0: Cenários com PIS/COFINS proporcional (Fix #7)
  const cenarios = {};
  const cenarioLabels = { base: 0, pessimista: variacaoCenarios.pessimista, otimista: variacaoCenarios.otimista };

  for (const [nomeCenario, variacao] of Object.entries(cenarioLabels)) {
    const fator = 1 + variacao;
    const receitaCenario = receitaBruta * fator;
    const lucroCenario = lucroLiquidoContabil * fator;

    // PIS/COFINS varia proporcionalmente à receita
    let pisCofinsCenario = pisCofinsLiquido;
    let pisCofinsCenarioBruto = pisCofinsBruto;
    if (dadosPISCOFINS && variacao !== 0) {
      const dadosPISCenario = { ...dadosPISCOFINS, receitaBruta: receitaCenario };
      const pcCenario = calcularPISCOFINSNaoCumulativo(dadosPISCenario);
      pisCofinsCenario = pcCenario.aPagar.total;
      pisCofinsCenarioBruto = pcCenario.debitos.total;
    }

    // IRPJ/CSLL variam com o lucro
    let irpjCenario, csllCenario;
    if (variacao === 0) {
      irpjCenario = irpjAPagar;
      csllCenario = csllDevida;
    } else {
      const irpjCalc = calcularIRPJLucroReal({
        lucroLiquidoContabil: lucroCenario - jcpDedutivel,
        totalAdicoes: totalAdicoes * fator,
        totalExclusoes: totalExclusoes * fator,
        saldoPrejuizoFiscal,
        numMeses,
        incentivosDedutiveis: incentivos.totalDeducaoFinal,
        retencoesFonte,
        estimativasPagas,
      });
      const csllCalc = calcularCSLL({
        lucroLiquidoContabil: lucroCenario - jcpDedutivel,
        adicoesCSLL: totalAdicoes * fator,
        exclusoesCSLL: totalExclusoes * fator,
        saldoBaseNegativa: saldoBaseNegativaCSLL,
        ehInstituicaoFinanceira,
      });
      irpjCenario = Math.max(irpjCalc.passo12_irpjAPagar, 0);
      csllCenario = csllCalc.csllDevida;
    }

    const totalCenarioBruto = irpjCenario + csllCenario + pisCofinsCenarioBruto;
    const totalCenarioLiquido = irpjCenario + csllCenario + Math.max(pisCofinsCenario - retencoesPISCOFINS, 0);

    cenarios[nomeCenario] = {
      variacao: `${(variacao * 100).toFixed(1)}%`,
      receita: receitaCenario,
      irpj: irpjCenario,
      csll: csllCenario,
      pisCofins: pisCofinsCenario,
      pisCofinsNota: variacao !== 0
        ? 'PIS/COFINS recalculado proporcionalmente à receita do cenário'
        : 'Cenário base — valores originais',
      cargaTotalBruta: Math.round(totalCenarioBruto * 100) / 100,
      cargaTotalLiquida: Math.round(totalCenarioLiquido * 100) / 100,
      cargaEfetiva: receitaCenario > 0
        ? ((totalCenarioLiquido / receitaCenario) * 100).toFixed(2) + '%'
        : '0%',
    };
  }

  return {
    // Resultado sem otimização
    semOtimizacao: {
      irpjDevido: irpjSemOtimizacao.passo9_irpjDevido,
      aliquotaEfetiva: irpjSemOtimizacao.aliquotaEfetiva,
    },

    // Resultado com otimização
    comOtimizacao: {
      irpj: irpjComOtimizacao,
      csll,
      jcp: jcpValido ? jcp : { ...jcp, nota: 'JCP não calculado — TJLP não informada' },
      incentivos,
      pisCofins,
    },

    // Mapa de economia
    economia: {
      jcp: economiaJCP,
      compensacaoPrejuizo: irpjComOtimizacao.economiaCompensacao,
      incentivos: incentivos.totalDeducaoFinal,
      totalIRPJ: economiaTotalIRPJ + economiaJCP,
      percentualEconomia: irpjSemOtimizacao.passo9_irpjDevido > 0
        ? (((economiaTotalIRPJ + economiaJCP) / irpjSemOtimizacao.passo9_irpjDevido) * 100).toFixed(2) + '%'
        : '0%',
    },

    // v5.0: Tributos totais com labels claros (Fix #6)
    totalAPagar: {
      irpj: irpjAPagar,
      csll: csllDevida,
      subtotalIRPJ_CSLL: cargaIRPJ_CSLL,
      pisCofins: {
        bruto: pisCofinsBruto,
        creditos: pisCofins ? pisCofins.creditos.total : 0,
        liquido: pisCofinsLiquido,
        retencoesFonte: retencoesPISCOFINS,
        aPagar: Math.max(pisCofinsLiquido - retencoesPISCOFINS, 0),
      },
      // Labels claros para evitar confusão (Fix #6)
      cargaTotalBruta: Math.round(cargaTotalBruta * 100) / 100,
      cargaTotalBrutaDescricao: 'IRPJ + CSLL + PIS/COFINS débitos (antes de créditos e retenções)',
      cargaTotalLiquida: Math.round(cargaTotalLiquida * 100) / 100,
      cargaTotalLiquidaDescricao: 'IRPJ + CSLL + PIS/COFINS a pagar (após créditos e retenções)',
      nota: 'A carga LÍQUIDA é o valor efetivamente desembolsado. A carga BRUTA inclui PIS/COFINS '
        + 'antes da dedução de créditos sobre insumos — use-a apenas para análise de composição.',
    },

    // v5.0: Cenários com PIS/COFINS proporcional (Fix #7)
    cenarios,
    cenarioNota: 'PIS/COFINS é recalculado proporcionalmente à receita em cada cenário. '
      + 'IRPJ/CSLL variam com o lucro ajustado. Adições/exclusões escalam proporcionalmente à receita.',

    // Saldo negativo
    saldoNegativo: irpjComOtimizacao.saldoNegativo
      ? calcularSaldoNegativo(
          irpjComOtimizacao.passo9_irpjDevido - irpjComOtimizacao.passo10_deducoes,
          retencoesFonte,
          estimativasPagas
        )
      : null,
  };
}

// ============================================================================
// BLOCO 14 — MAPA DE ECONOMIA TRIBUTÁRIA
// ============================================================================

/**
 * Gera o mapa completo de oportunidades de economia tributária
 *
 * @param {Object} empresa - Dados da empresa
 * @returns {Array} Lista de estratégias ordenadas por impacto
 */
function gerarMapaEconomia(empresa) {
  const estrategias = [];

  // 1. JCP
  if (empresa.patrimonioLiquido > 0) {
    const jcp = calcularJCP(empresa);
    estrategias.push({
      id: 1,
      estrategia: 'JCP — Juros sobre Capital Próprio',
      tipo: 'Dedução',
      economiaEstimada: jcp.economiaLiquida,
      complexidade: 'Baixa',
      riscoFiscal: 'Baixo',
      bloco: '5 — JCP',
      artigos: 'Art. 355-358',
      acao: `Pagar JCP de até R$ ${jcp.jcpDedutivel.toFixed(2)} no exercício`,
    });
  }

  // 2. Compensação de Prejuízos
  if (empresa.saldoPrejuizoFiscal > 0) {
    const lucroEstimado = empresa.lucroLiquidoContabil + (empresa.totalAdicoes || 0) - (empresa.totalExclusoes || 0);
    const comp = compensarPrejuizo(lucroEstimado, empresa.saldoPrejuizoFiscal);
    estrategias.push({
      id: 2,
      estrategia: 'Compensação de Prejuízos Fiscais (30%)',
      tipo: 'Dedução',
      economiaEstimada: comp.economiaTotal,
      complexidade: 'Baixa',
      riscoFiscal: 'Baixo',
      bloco: '4 — Prejuízos',
      artigos: 'Art. 261, III',
      acao: `Compensar R$ ${comp.compensacao.toFixed(2)} de prejuízos acumulados`,
    });
  }

  // 3. Incentivos Fiscais
  const incentivosDisponiveis = [
    { nome: 'PAT', impacto: 'Até 4% do IRPJ normal' },
    { nome: 'FIA + Idoso', impacto: 'Até 2% do IRPJ normal' },
    { nome: 'Lei Rouanet', impacto: 'Até 4% do IRPJ normal' },
    { nome: 'Lei do Esporte', impacto: 'Até 1% do IRPJ normal' },
  ];
  estrategias.push({
    id: 3,
    estrategia: 'Incentivos Fiscais (PAT, FIA, Rouanet, Esporte)',
    tipo: 'Dedução do IRPJ',
    economiaEstimada: null,
    impactoDescrito: 'Até ~10% do IRPJ normal combinados',
    complexidade: 'Média',
    riscoFiscal: 'Baixo',
    bloco: '7 — Incentivos',
    artigos: 'Art. 226, Art. 228, Art. 625-646',
    acao: 'Implementar PAT; fazer doações para FIA/Idoso/Rouanet',
    detalhes: incentivosDisponiveis,
  });

  // 4. Balanço de Suspensão/Redução (se anual)
  estrategias.push({
    id: 4,
    estrategia: 'Balanço de Suspensão/Redução (anual)',
    tipo: 'Timing',
    economiaEstimada: null,
    impactoDescrito: 'Variável — pode suspender 100% da estimativa em meses com prejuízo',
    complexidade: 'Média',
    riscoFiscal: 'Baixo',
    bloco: '1.4 — Suspensão/Redução',
    artigos: 'Art. 227-230',
    acao: 'Levantar balanço/balancete mensal; comparar IRPJ real vs estimativa',
  });

  // 5. Depreciação Acelerada
  estrategias.push({
    id: 5,
    estrategia: 'Depreciação Acelerada (turnos + incentivada)',
    tipo: 'Timing',
    economiaEstimada: null,
    impactoDescrito: '1% a 5% da receita em antecipação de despesa',
    complexidade: 'Média',
    riscoFiscal: 'Baixo',
    bloco: '6 — Depreciação',
    artigos: 'Art. 311-330',
    acao: 'Verificar turnos de operação; aplicar incentivos SUDAM/SUDENE se elegível',
  });

  // 6. Créditos PIS/COFINS
  estrategias.push({
    id: 6,
    estrategia: 'Maximização de Créditos PIS/COFINS',
    tipo: 'Crédito',
    economiaEstimada: null,
    impactoDescrito: '3% a 7% dos custos/insumos',
    complexidade: 'Alta',
    riscoFiscal: 'Médio',
    bloco: '11 — PIS/COFINS',
    artigos: 'Lei 10.637/02, Lei 10.833/03',
    acao: 'Revisar conceito de insumo (STJ — conceito amplo); creditar energia, aluguéis, etc.',
  });

  // 7. SUDAM/SUDENE (se aplicável)
  estrategias.push({
    id: 7,
    estrategia: 'SUDAM/SUDENE — Redução 75% IRPJ',
    tipo: 'Redução do IRPJ',
    economiaEstimada: null,
    impactoDescrito: 'Até 75% do IRPJ sobre lucro da exploração',
    complexidade: 'Alta',
    riscoFiscal: 'Baixo',
    bloco: '7.2 — SUDAM/SUDENE',
    artigos: 'Art. 615-627',
    acao: 'Verificar elegibilidade do projeto; calcular lucro da exploração',
    nota: 'Aplicável a empresas em região SUDAM/SUDENE — VERIFICAR PROJETO APROVADO',
  });

  // 8. Revisão de despesas indedutíveis
  estrategias.push({
    id: 8,
    estrategia: 'Reclassificação de Despesas Indedutíveis',
    tipo: 'Dedução',
    economiaEstimada: null,
    impactoDescrito: 'Variável',
    complexidade: 'Alta',
    riscoFiscal: 'Médio',
    bloco: '8 — Despesas',
    artigos: 'Art. 311',
    acao: 'Reclassificar brindes como propaganda; usar PAT ao invés de alimentação de sócios',
  });

  // Ordenar por complexidade (Baixa primeiro)
  const ordemComplexidade = { 'Baixa': 1, 'Média': 2, 'Alta': 3 };
  estrategias.sort((a, b) => ordemComplexidade[a.complexidade] - ordemComplexidade[b.complexidade]);

  // [FIX BUG #6] Normalizar campos de economia — garantir que .economia e .economiaAnual
  //   existam como aliases de .economiaEstimada para evitar undefined silencioso
  //   em funções de exportação (Excel/PDF/JSON) que possam acessar qualquer campo.
  estrategias.forEach(e => {
    e.economia = e.economiaEstimada;
    e.economiaAnual = e.economiaEstimada;
  });

  return estrategias;
}

// ============================================================================
// BLOCO 15 — ÁRVORE DE DECISÃO PARA OTIMIZAÇÃO
// ============================================================================

/**
 * Árvore de decisão automatizada
 * Analisa os dados da empresa e retorna um plano de ação priorizado
 *
 * @param {Object} empresa
 * @returns {Object}
 */
function arvoreDecisaoOtimizacao(empresa) {
  const acoes = [];

  // 1. Tem lucro?
  if (empresa.lucroLiquidoContabil <= 0) {
    acoes.push({
      prioridade: 1,
      acao: 'Acumular prejuízo fiscal no LALUR Parte B',
      motivo: 'Empresa com prejuízo — não há IRPJ a pagar',
      artigo: 'Art. 261, III',
    });
    acoes.push({
      prioridade: 2,
      acao: 'Considerar regime ANUAL com balanço de suspensão',
      motivo: 'Permite suspender estimativas mensais mostrando prejuízo',
      artigo: 'Art. 227',
    });
    return { situacao: 'PREJUIZO', acoes };
  }

  // 2. Tem PL significativo?
  if (empresa.patrimonioLiquido > 0) {
    const jcp = calcularJCP(empresa);
    if (jcp.jcpDedutivel > 0) {
      acoes.push({
        prioridade: 1,
        acao: `Pagar JCP de R$ ${jcp.jcpDedutivel.toFixed(2)}`,
        economia: `R$ ${jcp.economiaLiquida.toFixed(2)} líquidos`,
        artigo: 'Art. 355-358',
      });
    }
  }

  // 3. Tem SUDAM/SUDENE?
  if (empresa.temSUDAM || empresa.temSUDENE) {
    acoes.push({
      prioridade: 2,
      acao: 'Calcular Lucro da Exploração para redução de 75% do IRPJ',
      economia: 'Até 75% do IRPJ sobre lucro da exploração',
      artigo: 'Art. 615-627',
    });
  }

  // 4. Tem investimentos em ativos?
  if (empresa.temInvestimentoAtivos) {
    acoes.push({
      prioridade: 3,
      acao: 'Aplicar depreciação acelerada (turnos + incentivada)',
      artigo: 'Art. 311-330',
    });
  }

  // 5. Tem prejuízos acumulados?
  if (empresa.saldoPrejuizoFiscal > 0) {
    acoes.push({
      prioridade: 4,
      acao: 'Compensar prejuízos fiscais (até 30%)',
      saldo: empresa.saldoPrejuizoFiscal,
      artigo: 'Art. 261, III',
    });
  }

  // 6. Incentivos
  acoes.push({
    prioridade: 5,
    acao: 'Implementar incentivos fiscais (PAT, FIA, Rouanet)',
    artigo: 'Art. 226, Art. 228',
  });

  // 7. PIS/COFINS
  acoes.push({
    prioridade: 6,
    acao: 'Maximizar créditos PIS/COFINS não-cumulativo',
    artigo: 'Lei 10.637/02, Lei 10.833/03',
  });

  return { situacao: 'LUCRO', acoes };
}

// ============================================================================
// BLOCO 16 — OBRIGAÇÕES ACESSÓRIAS (Art. 262-287)
// ============================================================================

const OBRIGACOES_ACESSORIAS = [
  {
    obrigacao: 'LALUR (Livro de Apuração do Lucro Real)',
    artigo: 'Art. 277',
    prazo: 'Anual (entregue via ECF)',
    digital: true,
    descricao: 'Parte A: ajustes; Parte B: controle de valores',
  },
  {
    obrigacao: 'Livro Diário',
    artigo: 'Art. 273',
    prazo: 'Contínuo (SPED ECD)',
    digital: true,
    descricao: 'Todas as operações dia a dia',
  },
  {
    obrigacao: 'Livro Razão',
    artigo: 'Art. 274',
    prazo: 'Contínuo (SPED ECD)',
    digital: true,
    descricao: 'Totalização por conta. Ausência = arbitramento (Art. 274, §2º)',
  },
  {
    obrigacao: 'Livro de Registro de Inventário',
    artigo: 'Art. 275, I + Art. 276',
    prazo: 'Ao final de cada período de apuração',
    digital: true,
    descricao: 'Arrolamento de mercadorias, matérias-primas, produtos',
  },
  {
    obrigacao: 'Livro de Registro de Entradas',
    artigo: 'Art. 275, II',
    prazo: 'Contínuo',
    digital: true,
    descricao: 'Registro de compras',
  },
  {
    obrigacao: 'ECF (Escrituração Contábil Fiscal)',
    artigo: 'Art. 277 + IN RFB',
    prazo: 'Último dia útil de julho do ano seguinte',
    digital: true,
    descricao: 'Substitui LALUR + DIPJ. Demonstração do lucro real.',
  },
  {
    obrigacao: 'ECD (Escrituração Contábil Digital)',
    artigo: 'Art. 265, §2º + Decreto 6.022/07',
    prazo: 'Último dia útil de maio do ano seguinte',
    digital: true,
    descricao: 'Diário e Razão digitais via SPED',
  },
  {
    obrigacao: 'Demonstração do Lucro Real',
    artigo: 'Art. 287',
    prazo: 'Ao final de cada período de apuração',
    digital: true,
    descricao: 'Lucro líquido → ajustes → lucro real (transcrita no LALUR)',
  },
  {
    obrigacao: 'Conservação de livros e documentos',
    artigo: 'Art. 278',
    prazo: 'Enquanto não prescrever/decair (mínimo 5 anos)',
    digital: false,
    descricao: 'Manter escrituração e comprovantes em boa guarda',
  },
];

// ============================================================================
// EXPORTS
// ============================================================================

// ============================================================================
// CONSTANTES
// ============================================================================

/**
 * Regras gerais de compensação de prejuízos fiscais (Art. 579-580)
 * Decreto-Lei 1.598/1977, art. 64; Lei 9.065/1995, art. 15
 */
const COMPENSACAO_GERAL = {
  artigo: 'Art. 579-580',
  baseLegal: [
    'Decreto-Lei 1.598/1977, art. 64 §§1º-3º',
    'Lei 9.249/1995, art. 6º, caput e parágrafo único',
    'Lei 9.065/1995, art. 15'
  ],
  limitePorcentual: 0.30, // 30% do lucro real ajustado do período
  observacoes: [
    'O prejuízo compensável é o apurado na demonstração do lucro real e registrado no LALUR (Art. 579)',
    'A compensação pode ser total ou parcial, em um ou mais períodos, à opção do contribuinte (Art. 579 §1º)',
    'Absorção contábil de prejuízos (reservas, capital) NÃO prejudica o direito à compensação fiscal (Art. 579 §2º)',
    'O limite de 30% aplica-se somente a quem mantiver livros e documentos comprobatórios (Art. 580 §único)',
    'Não há prazo prescricional para compensação (limite é apenas percentual)'
  ],
  registroLALUR: {
    parte: 'B',
    descricao: 'O saldo de prejuízos fiscais deve ser controlado na Parte B do LALUR',
    registrosECF: {
      irpj: 'Registro M300 (Demonstração do Lucro Real — Parte A)',
      csll: 'Registro M350 (Demonstração da Base de Cálculo da CSLL — Parte A)',
      parteB: 'Registro M410/M500 (Parte B do LALUR/LACS)',
      contaReferencial: '79.01 (Prejuízo Fiscal a Compensar) / 79.02 (Base Negativa CSLL a Compensar)'
    }
  }
};

/**
 * Prejuízos não-operacionais (Art. 581-582)
 * Lei 12.973/2014, art. 43
 */
const PREJUIZOS_NAO_OPERACIONAIS = {
  artigo: 'Art. 581-582',
  baseLegal: 'Lei 12.973/2014, art. 43',
  regra: 'Prejuízos na alienação de bens do ativo imobilizado, investimento e intangível somente compensam com lucros de mesma natureza',
  limitePorcentual: 0.30, // também se aplica o limite de 30%
  tiposAtivo: [
    'Ativo imobilizado',
    'Investimento',
    'Ativo intangível',
    'Bens do ativo circulante reclassificados com intenção de venda (originalmente imobilizado/investimento/intangível)'
  ],
  excecao: {
    artigo: 'Art. 581 §único',
    descricao: 'NÃO se aplica a perdas por baixa de bens imprestáveis, obsoletos ou em desuso (mesmo que posteriormente vendidos como sucata)',
    baseLegal: 'Lei 12.973/2014, art. 43, parágrafo único'
  },
  disposicaoTransitoria: {
    artigo: 'Art. 582',
    descricao: 'Saldo de prejuízos não-operacionais formados durante vigência do art. 31 da Lei 9.249/95 segue regra do Art. 581',
    baseLegal: 'Lei 12.973/2014, art. 70'
  }
};

/**
 * Atividade rural — compensação integral (Art. 583)
 * Lei 8.023/1990, art. 14
 */
const ATIVIDADE_RURAL = {
  artigo: 'Art. 583',
  baseLegal: 'Lei 8.023/1990, art. 14',
  regra: 'Prejuízo da exploração de atividade rural pode ser compensado integralmente (sem limite de 30%)',
  semLimite30: true,
  condicao: 'Somente com resultado positivo obtido na mesma atividade rural em períodos posteriores',
  observacao: 'A atividade rural deve ser contabilizada separadamente das demais atividades da empresa'
};

/**
 * Vedações à compensação (Art. 584-586)
 */
const VEDACOES = {
  mudancaControleRamo: {
    artigo: 'Art. 584',
    baseLegal: 'Decreto-Lei 2.341/1987, art. 32',
    regra: 'VEDADA a compensação se, entre a data da apuração e da compensação, houver ocorrido CUMULATIVAMENTE: (a) modificação do controle societário E (b) mudança do ramo de atividade',
    cumulativo: true,
    observacao: 'Ambas condições devem ocorrer simultaneamente; apenas uma delas NÃO impede a compensação'
  },
  incorporacaoFusaoCisao: {
    artigo: 'Art. 585',
    baseLegal: 'Decreto-Lei 2.341/1987, art. 33',
    regra: 'A pessoa jurídica SUCESSORA por incorporação, fusão ou cisão NÃO poderá compensar prejuízos fiscais da SUCEDIDA',
    cisaoParcial: {
      artigo: 'Art. 585 §único',
      regra: 'Na cisão parcial, a CINDIDA pode compensar seus próprios prejuízos proporcionalmente à parcela REMANESCENTE do PL',
      baseLegal: 'Decreto-Lei 2.341/1987, art. 33, parágrafo único'
    }
  },
  scp: {
    artigo: 'Art. 586',
    baseLegal: 'Decreto-Lei 2.303/1986, art. 7º; Decreto-Lei 2.308/1968, art. 3º',
    regra: 'Prejuízo fiscal de SCP somente compensa com lucro real da MESMA SCP',
    vedacoes: [
      'VEDADA compensação de prejuízos entre duas ou mais SCPs',
      'VEDADA compensação entre SCP e sócio ostensivo'
    ]
  }
};

/**
 * Base negativa da CSLL — regras análogas
 * Lei 9.065/1995, art. 16; IN SRF 390/2004
 */
const BASE_NEGATIVA_CSLL = {
  artigo: 'Lei 9.065/1995, art. 16',
  normaInfralegal: 'IN SRF 390/2004',
  limitePorcentual: 0.30, // 30% da base de cálculo positiva da CSLL
  regra: 'A base de cálculo negativa da CSLL pode ser compensada com base positiva apurada em períodos subsequentes, limitada a 30%',
  registroLACS: {
    parte: 'B',
    descricao: 'O saldo de base negativa da CSLL deve ser controlado na Parte B do LACS (Livro de Apuração da CSLL)',
    registroECF: 'Registro M350 / M500'
  },
  observacoes: [
    'As mesmas vedações dos Art. 584-586 aplicam-se por analogia à CSLL',
    'Prejuízos não-operacionais da CSLL seguem mesma regra de compensação restrita',
    'Não há prazo prescricional para compensação da base negativa'
  ]
};

/**
 * Alíquotas utilizadas nos cálculos de economia
 */
const ALIQUOTAS = {
  irpj: {
    normal: 0.15,
    adicional: 0.10,
    limiteAdicionalMensal: 20000, // R$ 20.000/mês
    limiteAdicionalTrimestral: 60000, // R$ 60.000/trimestre
    limiteAdicionalAnual: 240000 // R$ 240.000/ano
  },
  csll: {
    aliquota: 0.09
  }
};

// ============================================================================
// FUNÇÕES DE CÁLCULO
// ============================================================================

/**
 * Calcula o lucro real ajustado ANTES da compensação de prejuízos.
 * Este é o valor-base sobre o qual se aplica o limite de 30%.
 *
 * @param {Object} dados
 * @param {number} dados.lucroLiquido - Lucro líquido contábil do período
 * @param {number} [dados.adicoes=0] - Total de adições ao lucro líquido (Parte A do LALUR)
 * @param {number} [dados.exclusoes=0] - Total de exclusões do lucro líquido (Parte A do LALUR)
 * @returns {Object} Lucro real ajustado antes da compensação
 *
 * Base Legal: Art. 579-580 do RIR/2018
 */
function calcularLucroRealAjustado(dados) {
  const {
    lucroLiquido = 0,
    adicoes = 0,
    exclusoes = 0
  } = dados;

  const lucroAjustado = lucroLiquido + adicoes - exclusoes;

  return {
    lucroLiquido,
    adicoes,
    exclusoes,
    lucroRealAjustado: lucroAjustado,
    temLucro: lucroAjustado > 0,
    temPrejuizo: lucroAjustado < 0,
    artigo: 'Art. 579-580',
    observacao: lucroAjustado < 0
      ? 'Prejuízo fiscal do período — registrar na Parte B do LALUR para compensação futura'
      : 'Lucro real positivo — verificar possibilidade de compensação de prejuízos acumulados'
  };
}

/**
 * Calcula a compensação de prejuízos fiscais operacionais.
 * Aplica o limite de 30% do lucro real ajustado (Art. 580).
 *
 * @param {Object} dados
 * @param {number} dados.lucroRealAjustado - Lucro real ajustado antes da compensação (deve ser > 0)
 * @param {number} dados.saldoPrejuizoFiscal - Saldo acumulado de prejuízos fiscais operacionais na Parte B do LALUR
 * @param {boolean} [dados.atividadeRural=false] - Se o prejuízo é exclusivamente de atividade rural (Art. 583)
 * @returns {Object} Detalhamento da compensação com economia tributária
 *
 * Base Legal: Art. 580 (limite 30%) / Art. 583 (rural sem limite)
 */
function compensarPrejuizoFiscal(dados) {
  const {
    lucroRealAjustado,
    saldoPrejuizoFiscal,
    atividadeRural = false
  } = dados;

  const resultado = {
    lucroRealAjustado,
    saldoPrejuizoAnterior: saldoPrejuizoFiscal,
    compensacaoPermitida: 0,
    compensacaoEfetiva: 0,
    lucroRealAposCompensacao: lucroRealAjustado,
    saldoPrejuizoRemanescente: saldoPrejuizoFiscal,
    limitePorcentual: atividadeRural ? 1.0 : COMPENSACAO_GERAL.limitePorcentual,
    atividadeRural,
    economia: { irpj: 0, csll: 0, total: 0 },
    ajusteLalur: { tipo: 'COMPENSACAO', valor: 0, parteB: 'Baixa parcial/total do saldo de prejuízo fiscal' },
    artigo: atividadeRural ? 'Art. 583' : 'Art. 580',
    observacoes: []
  };

  // Se não há lucro, não há o que compensar
  if (lucroRealAjustado <= 0) {
    resultado.observacoes.push('Lucro real ajustado <= 0. Não há compensação possível neste período.');
    return resultado;
  }

  // Se não há saldo de prejuízo, nada a compensar
  if (saldoPrejuizoFiscal <= 0) {
    resultado.observacoes.push('Saldo de prejuízo fiscal = 0. Nada a compensar.');
    return resultado;
  }

  // Calcular compensação permitida
  if (atividadeRural) {
    // Art. 583: atividade rural — compensação integral sem limite de 30%
    resultado.compensacaoPermitida = lucroRealAjustado;
    resultado.observacoes.push('Atividade rural (Art. 583): compensação integral sem limite de 30%');
  } else {
    // Art. 580: limite de 30% do lucro real ajustado
    resultado.compensacaoPermitida = lucroRealAjustado * COMPENSACAO_GERAL.limitePorcentual;
    resultado.observacoes.push(`Limite de compensação: 30% de R$ ${lucroRealAjustado.toFixed(2)} = R$ ${resultado.compensacaoPermitida.toFixed(2)}`);
  }

  // Compensação efetiva = menor entre (limite permitido, saldo disponível)
  resultado.compensacaoEfetiva = Math.min(resultado.compensacaoPermitida, saldoPrejuizoFiscal);
  resultado.lucroRealAposCompensacao = lucroRealAjustado - resultado.compensacaoEfetiva;
  resultado.saldoPrejuizoRemanescente = saldoPrejuizoFiscal - resultado.compensacaoEfetiva;

  // Ajuste LALUR
  resultado.ajusteLalur.valor = resultado.compensacaoEfetiva;

  // Calcular economia tributária (IRPJ)
  const irpjSemCompensacao = _calcularIRPJ(lucroRealAjustado);
  const irpjComCompensacao = _calcularIRPJ(resultado.lucroRealAposCompensacao);
  resultado.economia.irpj = irpjSemCompensacao - irpjComCompensacao;

  // Observações adicionais
  if (resultado.compensacaoEfetiva < saldoPrejuizoFiscal && !atividadeRural) {
    resultado.observacoes.push(
      `Saldo remanescente de R$ ${resultado.saldoPrejuizoRemanescente.toFixed(2)} disponível para compensação em períodos futuros (sem prazo prescricional)`
    );
  }
  if (resultado.compensacaoEfetiva === saldoPrejuizoFiscal) {
    resultado.observacoes.push('Saldo de prejuízos fiscais totalmente compensado neste período');
  }

  return resultado;
}

/**
 * Calcula a compensação de base negativa da CSLL.
 * Aplica o limite de 30% da base de cálculo positiva (Lei 9.065/1995, art. 16).
 *
 * @param {Object} dados
 * @param {number} dados.baseCalculoCSLL - Base de cálculo positiva da CSLL antes da compensação
 * @param {number} dados.saldoBaseNegativa - Saldo acumulado de base negativa da CSLL no LACS
 * @returns {Object} Detalhamento da compensação com economia tributária
 *
 * Base Legal: Lei 9.065/1995, art. 16
 */
function compensarBaseNegativaCSLL(dados) {
  const {
    baseCalculoCSLL,
    saldoBaseNegativa
  } = dados;

  const resultado = {
    baseCalculoCSLL,
    saldoBaseNegativaAnterior: saldoBaseNegativa,
    compensacaoPermitida: 0,
    compensacaoEfetiva: 0,
    baseCSLLAposCompensacao: baseCalculoCSLL,
    saldoBaseNegativaRemanescente: saldoBaseNegativa,
    limitePorcentual: BASE_NEGATIVA_CSLL.limitePorcentual,
    economia: { csll: 0, total: 0 },
    ajusteLalur: { tipo: 'COMPENSACAO_CSLL', valor: 0, parteB: 'Baixa parcial/total do saldo de base negativa CSLL' },
    artigo: 'Lei 9.065/1995, art. 16',
    observacoes: []
  };

  if (baseCalculoCSLL <= 0) {
    resultado.observacoes.push('Base de cálculo da CSLL <= 0. Não há compensação possível neste período.');
    return resultado;
  }

  if (saldoBaseNegativa <= 0) {
    resultado.observacoes.push('Saldo de base negativa da CSLL = 0. Nada a compensar.');
    return resultado;
  }

  // Limite de 30%
  resultado.compensacaoPermitida = baseCalculoCSLL * BASE_NEGATIVA_CSLL.limitePorcentual;
  resultado.compensacaoEfetiva = Math.min(resultado.compensacaoPermitida, saldoBaseNegativa);
  resultado.baseCSLLAposCompensacao = baseCalculoCSLL - resultado.compensacaoEfetiva;
  resultado.saldoBaseNegativaRemanescente = saldoBaseNegativa - resultado.compensacaoEfetiva;

  // Ajuste
  resultado.ajusteLalur.valor = resultado.compensacaoEfetiva;

  // Economia CSLL
  resultado.economia.csll = resultado.compensacaoEfetiva * ALIQUOTAS.csll.aliquota;
  resultado.economia.total = resultado.economia.csll;

  resultado.observacoes.push(
    `Compensação de base negativa CSLL: 30% de R$ ${baseCalculoCSLL.toFixed(2)} = R$ ${resultado.compensacaoPermitida.toFixed(2)}`
  );
  if (resultado.saldoBaseNegativaRemanescente > 0) {
    resultado.observacoes.push(
      `Saldo remanescente de R$ ${resultado.saldoBaseNegativaRemanescente.toFixed(2)} para períodos futuros`
    );
  }

  return resultado;
}

/**
 * Calcula a compensação de prejuízos NÃO-OPERACIONAIS.
 * Art. 581: Somente compensam com lucros de mesma natureza (alienação de ativo
 * imobilizado, investimento e intangível), observado o limite de 30%.
 *
 * @param {Object} dados
 * @param {number} dados.lucroNaoOperacional - Lucro não-operacional do período (ganhos de capital em ativos)
 * @param {number} dados.saldoPrejuizoNaoOperacional - Saldo acumulado de prejuízo não-operacional na Parte B
 * @param {boolean} [dados.perdaPorObsolescencia=false] - Se a perda é por obsolescência/desuso (exceção Art. 581 §único)
 * @returns {Object} Detalhamento da compensação
 *
 * Base Legal: Art. 581 do RIR/2018 (Lei 12.973/2014, art. 43)
 */
function compensarPrejuizoNaoOperacional(dados) {
  const {
    lucroNaoOperacional,
    saldoPrejuizoNaoOperacional,
    perdaPorObsolescencia = false
  } = dados;

  const resultado = {
    lucroNaoOperacional,
    saldoPrejuizoAnterior: saldoPrejuizoNaoOperacional,
    compensacaoPermitida: 0,
    compensacaoEfetiva: 0,
    lucroNaoOperacionalAposCompensacao: lucroNaoOperacional,
    saldoPrejuizoRemanescente: saldoPrejuizoNaoOperacional,
    limitePorcentual: PREJUIZOS_NAO_OPERACIONAIS.limitePorcentual,
    economia: { irpj: 0, csll: 0, total: 0 },
    ajusteLalur: { tipo: 'COMPENSACAO_NAO_OPERACIONAL', valor: 0, parteB: 'Baixa de prejuízo não-operacional' },
    artigo: 'Art. 581',
    observacoes: []
  };

  // Exceção: obsolescência/desuso
  if (perdaPorObsolescencia) {
    resultado.observacoes.push(
      'Art. 581 §único: Perdas por bens imprestáveis, obsoletos ou em desuso NÃO são tratadas como prejuízo não-operacional'
    );
    resultado.artigo = 'Art. 581 §único';
    resultado.observacoes.push('Esta perda segue a regra geral de compensação (Art. 580) — compensável com qualquer lucro');
    return resultado;
  }

  if (lucroNaoOperacional <= 0) {
    resultado.observacoes.push('Não há lucro não-operacional no período. Compensação impossível.');
    return resultado;
  }

  if (saldoPrejuizoNaoOperacional <= 0) {
    resultado.observacoes.push('Saldo de prejuízo não-operacional = 0.');
    return resultado;
  }

  // Limite de 30% aplicável sobre o lucro não-operacional
  resultado.compensacaoPermitida = lucroNaoOperacional * PREJUIZOS_NAO_OPERACIONAIS.limitePorcentual;
  resultado.compensacaoEfetiva = Math.min(resultado.compensacaoPermitida, saldoPrejuizoNaoOperacional);
  resultado.lucroNaoOperacionalAposCompensacao = lucroNaoOperacional - resultado.compensacaoEfetiva;
  resultado.saldoPrejuizoRemanescente = saldoPrejuizoNaoOperacional - resultado.compensacaoEfetiva;

  resultado.ajusteLalur.valor = resultado.compensacaoEfetiva;

  // Economia
  resultado.economia.irpj = _calcularIRPJ(lucroNaoOperacional)
    - _calcularIRPJ(lucroNaoOperacional - resultado.compensacaoEfetiva);
  resultado.economia.total = resultado.economia.irpj;

  resultado.observacoes.push(
    `Prejuízo não-operacional compensa SOMENTE com lucro não-operacional (Art. 581)`,
    `Limite: 30% de R$ ${lucroNaoOperacional.toFixed(2)} = R$ ${resultado.compensacaoPermitida.toFixed(2)}`
  );

  return resultado;
}

/**
 * Verifica vedações à compensação de prejuízos fiscais (Art. 584-586).
 *
 * @param {Object} dados
 * @param {boolean} [dados.houveMudancaControle=false] - Se houve mudança de controle societário
 * @param {boolean} [dados.houveMudancaRamo=false] - Se houve mudança de ramo de atividade
 * @param {string} [dados.eventoSocietario=null] - 'INCORPORACAO', 'FUSAO', 'CISAO_TOTAL', 'CISAO_PARCIAL' ou null
 * @param {number} [dados.percentualPLRemanescente=1.0] - Percentual do PL remanescente (cisão parcial)
 * @param {boolean} [dados.ehSCP=false] - Se é Sociedade em Conta de Participação
 * @param {string} [dados.identificadorSCP=null] - Identificador da SCP (para controle)
 * @param {number} [dados.saldoPrejuizoFiscal=0] - Saldo de prejuízo para ajuste (cisão parcial)
 * @returns {Object} Análise de vedações com impactos
 *
 * Base Legal: Art. 584-586 do RIR/2018
 */
function verificarVedacoes(dados) {
  const {
    houveMudancaControle = false,
    houveMudancaRamo = false,
    eventoSocietario = null,
    percentualPLRemanescente = 1.0,
    ehSCP = false,
    identificadorSCP = null,
    saldoPrejuizoFiscal = 0
  } = dados;

  const resultado = {
    compensacaoPermitida: true,
    vedacoes: [],
    restricoes: [],
    saldoAjustado: saldoPrejuizoFiscal,
    artigos: [],
    alertas: []
  };

  // Art. 584: Mudança de controle + ramo (cumulativo)
  if (houveMudancaControle && houveMudancaRamo) {
    resultado.compensacaoPermitida = false;
    resultado.vedacoes.push({
      tipo: 'MUDANCA_CONTROLE_RAMO',
      artigo: 'Art. 584',
      baseLegal: 'Decreto-Lei 2.341/1987, art. 32',
      descricao: 'VEDADA compensação: houve modificação cumulativa de controle societário E ramo de atividade',
      saldoPerdido: saldoPrejuizoFiscal
    });
    resultado.saldoAjustado = 0;
    resultado.artigos.push('Art. 584');
  } else if (houveMudancaControle || houveMudancaRamo) {
    resultado.alertas.push({
      tipo: 'MUDANCA_PARCIAL',
      descricao: houveMudancaControle
        ? 'Houve mudança de controle societário, mas NÃO de ramo — compensação mantida (Art. 584 exige as duas condições cumulativas)'
        : 'Houve mudança de ramo de atividade, mas NÃO de controle — compensação mantida (Art. 584 exige as duas condições cumulativas)',
      artigo: 'Art. 584'
    });
    resultado.artigos.push('Art. 584');
  }

  // Art. 585: Incorporação, fusão ou cisão
  if (eventoSocietario) {
    const evento = eventoSocietario.toUpperCase();
    if (evento === 'INCORPORACAO' || evento === 'FUSAO' || evento === 'CISAO_TOTAL') {
      resultado.compensacaoPermitida = false;
      resultado.vedacoes.push({
        tipo: 'SUCESSAO',
        artigo: 'Art. 585',
        baseLegal: 'Decreto-Lei 2.341/1987, art. 33',
        descricao: `VEDADA compensação: pessoa jurídica SUCESSORA (${evento}) não pode compensar prejuízos da SUCEDIDA`,
        saldoPerdido: saldoPrejuizoFiscal
      });
      resultado.saldoAjustado = 0;
      resultado.artigos.push('Art. 585');
    } else if (evento === 'CISAO_PARCIAL') {
      // Na cisão parcial, a cindida pode compensar proporcionalmente ao PL remanescente
      const saldoAjustadoCisao = saldoPrejuizoFiscal * percentualPLRemanescente;
      const saldoPerdido = saldoPrejuizoFiscal - saldoAjustadoCisao;

      resultado.restricoes.push({
        tipo: 'CISAO_PARCIAL',
        artigo: 'Art. 585 §único',
        baseLegal: 'Decreto-Lei 2.341/1987, art. 33, parágrafo único',
        descricao: `Cisão parcial: compensação proporcional ao PL remanescente (${(percentualPLRemanescente * 100).toFixed(1)}%)`,
        saldoOriginal: saldoPrejuizoFiscal,
        saldoAjustado: saldoAjustadoCisao,
        saldoPerdido
      });
      resultado.saldoAjustado = saldoAjustadoCisao;
      resultado.artigos.push('Art. 585 §único');
    }
  }

  // Art. 586: SCP
  if (ehSCP) {
    resultado.restricoes.push({
      tipo: 'SCP',
      artigo: 'Art. 586',
      baseLegal: 'Decreto-Lei 2.303/1986, art. 7º',
      descricao: `Prejuízo da SCP ${identificadorSCP || '(não identificada)'} somente compensa com lucro da MESMA SCP`,
      vedacoes: [
        'VEDADA compensação entre SCPs distintas',
        'VEDADA compensação entre SCP e sócio ostensivo'
      ]
    });
    resultado.artigos.push('Art. 586');
  }

  return resultado;
}

/**
 * Realiza a compensação integrada de prejuízos fiscais (operacionais + não-operacionais)
 * e base negativa da CSLL em um único período de apuração.
 *
 * @param {Object} dados
 * @param {number} dados.lucroLiquido - Lucro líquido contábil do período
 * @param {number} [dados.adicoes=0] - Adições ao LALUR (Parte A)
 * @param {number} [dados.exclusoes=0] - Exclusões do LALUR (Parte A)
 * @param {number} [dados.saldoPrejuizoOperacional=0] - Saldo na Parte B: prejuízos operacionais
 * @param {number} [dados.saldoPrejuizoNaoOperacional=0] - Saldo na Parte B: prejuízos não-operacionais
 * @param {number} [dados.saldoBaseNegativaCSLL=0] - Saldo na Parte B do LACS: base negativa CSLL
 * @param {number} [dados.lucroNaoOperacional=0] - Lucro não-operacional do período (ganhos de capital)
 * @param {boolean} [dados.atividadeRural=false] - Se se trata de atividade rural (Art. 583)
 * @param {boolean} [dados.trimestral=true] - Se apuração é trimestral
 * @returns {Object} Resultado completo da compensação integrada
 *
 * Base Legal: Art. 579-586 do RIR/2018
 */
function compensarIntegrado(dados) {
  const {
    lucroLiquido = 0,
    adicoes = 0,
    exclusoes = 0,
    saldoPrejuizoOperacional = 0,
    saldoPrejuizoNaoOperacional = 0,
    saldoBaseNegativaCSLL = 0,
    lucroNaoOperacional = 0,
    atividadeRural = false,
    trimestral = true
  } = dados;

  // 1. Calcular lucro real ajustado antes da compensação
  const lucroAjustado = calcularLucroRealAjustado({ lucroLiquido, adicoes, exclusoes });

  const resultado = {
    etapa1_lucroAjustado: lucroAjustado,
    etapa2_compensacaoNaoOperacional: null,
    etapa3_compensacaoOperacional: null,
    etapa4_compensacaoCSLL: null,
    resumo: {
      lucroRealAntes: lucroAjustado.lucroRealAjustado,
      totalCompensado: 0,
      lucroRealFinal: lucroAjustado.lucroRealAjustado,
      baseCSLLFinal: lucroAjustado.lucroRealAjustado,
      saldosPosCompensacao: {
        prejuizoOperacional: saldoPrejuizoOperacional,
        prejuizoNaoOperacional: saldoPrejuizoNaoOperacional,
        baseNegativaCSLL: saldoBaseNegativaCSLL
      },
      economia: { irpj: 0, csll: 0, total: 0 }
    },
    artigo: 'Art. 579-586',
    trimestral
  };

  // Se lucro ajustado <= 0, registra prejuízo e retorna
  if (lucroAjustado.lucroRealAjustado <= 0) {
    const novoPrejuizo = Math.abs(lucroAjustado.lucroRealAjustado);

    // Classificar o prejuízo: separar operacional de não-operacional
    // Simplificação: se há prejuízo não-operacional no período, ele é segregado
    const prejNaoOp = lucroNaoOperacional < 0 ? Math.abs(lucroNaoOperacional) : 0;
    const prejOp = novoPrejuizo - prejNaoOp;

    resultado.resumo.novoPrejuizoOperacional = Math.max(0, prejOp);
    resultado.resumo.novoPrejuizoNaoOperacional = prejNaoOp;
    resultado.resumo.saldosPosCompensacao.prejuizoOperacional = saldoPrejuizoOperacional + Math.max(0, prejOp);
    resultado.resumo.saldosPosCompensacao.prejuizoNaoOperacional = saldoPrejuizoNaoOperacional + prejNaoOp;
    resultado.resumo.saldosPosCompensacao.baseNegativaCSLL = saldoBaseNegativaCSLL + novoPrejuizo;
    resultado.resumo.lucroRealFinal = 0;
    resultado.resumo.baseCSLLFinal = 0;
    resultado.resumo.observacao = `Prejuízo fiscal no período: R$ ${novoPrejuizo.toFixed(2)} — registrar na Parte B do LALUR/LACS`;

    return resultado;
  }

  let lucroRealCorrente = lucroAjustado.lucroRealAjustado;
  let baseCSLLCorrente = lucroAjustado.lucroRealAjustado;

  // 2. Compensar prejuízos NÃO-OPERACIONAIS primeiro (se houver lucro não-operacional)
  if (lucroNaoOperacional > 0 && saldoPrejuizoNaoOperacional > 0) {
    const compNaoOp = compensarPrejuizoNaoOperacional({
      lucroNaoOperacional,
      saldoPrejuizoNaoOperacional
    });
    resultado.etapa2_compensacaoNaoOperacional = compNaoOp;

    lucroRealCorrente -= compNaoOp.compensacaoEfetiva;
    resultado.resumo.totalCompensado += compNaoOp.compensacaoEfetiva;
    resultado.resumo.saldosPosCompensacao.prejuizoNaoOperacional = compNaoOp.saldoPrejuizoRemanescente;
  }

  // 3. Compensar prejuízos OPERACIONAIS (sobre lucro restante, com limite de 30%)
  if (lucroRealCorrente > 0 && saldoPrejuizoOperacional > 0) {
    const compOp = compensarPrejuizoFiscal({
      lucroRealAjustado: lucroRealCorrente,
      saldoPrejuizoFiscal: saldoPrejuizoOperacional,
      atividadeRural
    });
    resultado.etapa3_compensacaoOperacional = compOp;

    lucroRealCorrente = compOp.lucroRealAposCompensacao;
    // baseCSLLCorrente -= compOp.compensacaoEfetiva; // REMOVIDO: prejuízo fiscal operacional (Art. 580-581 RIR/2018) é exclusivo do IRPJ; CSLL usa base negativa própria (Lei 9.065/1995, art. 16)
    resultado.resumo.totalCompensado += compOp.compensacaoEfetiva;
    resultado.resumo.saldosPosCompensacao.prejuizoOperacional = compOp.saldoPrejuizoRemanescente;
    resultado.resumo.economia.irpj += compOp.economia.irpj;
  }

  // 4. Compensar base negativa da CSLL (análogo, sobre base da CSLL)
  if (baseCSLLCorrente > 0 && saldoBaseNegativaCSLL > 0) {
    const compCSLL = compensarBaseNegativaCSLL({
      baseCalculoCSLL: baseCSLLCorrente,
      saldoBaseNegativa: saldoBaseNegativaCSLL
    });
    resultado.etapa4_compensacaoCSLL = compCSLL;

    baseCSLLCorrente = compCSLL.baseCSLLAposCompensacao;
    resultado.resumo.saldosPosCompensacao.baseNegativaCSLL = compCSLL.saldoBaseNegativaRemanescente;
    resultado.resumo.economia.csll += compCSLL.economia.csll;
  }

  // Resumo final
  resultado.resumo.lucroRealFinal = Math.max(0, lucroRealCorrente);
  resultado.resumo.baseCSLLFinal = Math.max(0, baseCSLLCorrente);
  resultado.resumo.economia.total = resultado.resumo.economia.irpj + resultado.resumo.economia.csll;

  return resultado;
}

/**
 * Simula a compensação de prejuízos ao longo de múltiplos períodos (planejamento plurianual).
 * Projeta quantos períodos serão necessários para absorver o saldo de prejuízos.
 *
 * @param {Object} dados
 * @param {number} dados.saldoPrejuizoFiscal - Saldo atual de prejuízo fiscal operacional
 * @param {number} dados.saldoBaseNegativaCSLL - Saldo atual de base negativa CSLL
 * @param {number} dados.lucroProjetadoAnual - Lucro real anual projetado (antes da compensação)
 * @param {number} [dados.saldoPrejuizoNaoOperacional=0] - Saldo de prejuízo não-operacional
 * @param {number} [dados.lucroNaoOperacionalProjetado=0] - Lucro não-op anual projetado
 * @param {number} [dados.anosProjecao=10] - Número de anos para projetar
 * @param {boolean} [dados.atividadeRural=false] - Se é atividade rural
 * @returns {Object} Projeção plurianual de compensação
 *
 * Base Legal: Art. 579-586 do RIR/2018
 */
function simularCompensacaoPluranual(dados) {
  const {
    saldoPrejuizoFiscal,
    saldoBaseNegativaCSLL,
    lucroProjetadoAnual,
    saldoPrejuizoNaoOperacional = 0,
    lucroNaoOperacionalProjetado = 0,
    anosProjecao = 10,
    atividadeRural = false
  } = dados;

  const projecao = [];
  let saldoPF = saldoPrejuizoFiscal;
  let saldoBN = saldoBaseNegativaCSLL;
  let saldoPNO = saldoPrejuizoNaoOperacional;
  let totalEconomiaIRPJ = 0;
  let totalEconomiaCSLL = 0;
  let anoZeroPrejuizoFiscal = null;
  let anoZeroBaseNegativa = null;

  for (let ano = 1; ano <= anosProjecao; ano++) {
    let lucroOp = lucroProjetadoAnual;
    let lucroNO = lucroNaoOperacionalProjetado;

    // Compensação não-operacional
    let compNO = 0;
    if (lucroNO > 0 && saldoPNO > 0) {
      const limNO = lucroNO * 0.30;
      compNO = Math.min(limNO, saldoPNO);
      saldoPNO -= compNO;
      lucroOp -= compNO;
    }

    // Compensação operacional
    let compOp = 0;
    if (lucroOp > 0 && saldoPF > 0) {
      const limite = atividadeRural ? lucroOp : lucroOp * 0.30;
      compOp = Math.min(limite, saldoPF);
      saldoPF -= compOp;
    }

    // Compensação CSLL
    let compCSLL = 0;
    const baseCSLL = lucroProjetadoAnual - compNO - compOp;
    if (baseCSLL > 0 && saldoBN > 0) {
      const limCSLL = baseCSLL * 0.30;
      compCSLL = Math.min(limCSLL, saldoBN);
      saldoBN -= compCSLL;
    }

    const economiaIRPJ = _calcularIRPJ(lucroProjetadoAnual) - _calcularIRPJ(lucroProjetadoAnual - compOp - compNO);
    const economiaCSLL = compCSLL * ALIQUOTAS.csll.aliquota;
    totalEconomiaIRPJ += economiaIRPJ;
    totalEconomiaCSLL += economiaCSLL;

    if (saldoPF <= 0 && anoZeroPrejuizoFiscal === null) anoZeroPrejuizoFiscal = ano;
    if (saldoBN <= 0 && anoZeroBaseNegativa === null) anoZeroBaseNegativa = ano;

    projecao.push({
      ano,
      lucroProjetado: lucroProjetadoAnual,
      compensacaoOperacional: compOp,
      compensacaoNaoOperacional: compNO,
      compensacaoCSLL: compCSLL,
      lucroRealFinal: lucroProjetadoAnual - compOp - compNO,
      baseCSLLFinal: Math.max(0, baseCSLL - compCSLL),
      saldoPrejuizoFiscal: saldoPF,
      saldoBaseNegativaCSLL: saldoBN,
      saldoPrejuizoNaoOperacional: saldoPNO,
      economiaIRPJ,
      economiaCSLL,
      economiaTotalAno: economiaIRPJ + economiaCSLL
    });

    // Se tudo compensado, parar
    if (saldoPF <= 0 && saldoBN <= 0 && saldoPNO <= 0) break;
  }

  return {
    projecao,
    resumo: {
      saldoInicialPrejuizoFiscal: saldoPrejuizoFiscal,
      saldoInicialBaseNegativaCSLL: saldoBaseNegativaCSLL,
      saldoInicialPrejuizoNaoOperacional: saldoPrejuizoNaoOperacional,
      anosParaZerarPrejuizo: anoZeroPrejuizoFiscal || `>${anosProjecao}`,
      anosParaZerarBaseNegativa: anoZeroBaseNegativa || `>${anosProjecao}`,
      totalEconomiaIRPJ,
      totalEconomiaCSLL,
      totalEconomia: totalEconomiaIRPJ + totalEconomiaCSLL,
      saldoFinal: {
        prejuizoFiscal: saldoPF,
        baseNegativaCSLL: saldoBN,
        prejuizoNaoOperacional: saldoPNO
      }
    },
    artigo: 'Art. 579-586',
    atividadeRural
  };
}

/**
 * Registra o prejuízo fiscal do período na Parte B do LALUR.
 *
 * @param {Object} dados
 * @param {number} dados.prejuizoFiscal - Prejuízo fiscal apurado no período (valor positivo)
 * @param {number} [dados.saldoAnterior=0] - Saldo anterior na Parte B do LALUR
 * @param {string} [dados.tipoPrejuizo='OPERACIONAL'] - 'OPERACIONAL' ou 'NAO_OPERACIONAL'
 * @param {string} [dados.periodoApuracao=''] - Período de apuração (ex: '1T2025', '2T2025')
 * @param {boolean} [dados.ehCSLL=false] - Se é base negativa da CSLL (LACS) ao invés de IRPJ (LALUR)
 * @returns {Object} Registro para Parte B do LALUR/LACS
 *
 * Base Legal: Art. 579 do RIR/2018
 */
function registrarPrejuizoParteB(dados) {
  const {
    prejuizoFiscal,
    saldoAnterior = 0,
    tipoPrejuizo = 'OPERACIONAL',
    periodoApuracao = '',
    ehCSLL = false
  } = dados;

  const livro = ehCSLL ? 'LACS' : 'LALUR';
  const contaRef = ehCSLL ? '79.02' : (tipoPrejuizo === 'NAO_OPERACIONAL' ? '79.03' : '79.01');

  return {
    livro,
    parte: 'B',
    contaReferencial: contaRef,
    tipoPrejuizo,
    periodoApuracao,
    saldoAnterior,
    valorRegistrado: prejuizoFiscal,
    saldoAtual: saldoAnterior + prejuizoFiscal,
    natureza: 'CREDORA',
    descricao: ehCSLL
      ? `Base negativa da CSLL — ${periodoApuracao}`
      : `Prejuízo fiscal ${tipoPrejuizo.toLowerCase()} — ${periodoApuracao}`,
    registroECF: ehCSLL ? 'M500' : 'M410',
    artigo: 'Art. 579',
    observacao: 'O saldo deve ser mantido enquanto não integralmente compensado (sem prazo prescricional)'
  };
}

/**
 * Registra a utilização (baixa) de prejuízo fiscal na Parte B do LALUR.
 *
 * @param {Object} dados
 * @param {number} dados.valorCompensado - Valor efetivamente compensado
 * @param {number} dados.saldoAnterior - Saldo anterior na Parte B
 * @param {string} [dados.tipoPrejuizo='OPERACIONAL'] - 'OPERACIONAL' ou 'NAO_OPERACIONAL'
 * @param {string} [dados.periodoApuracao=''] - Período de apuração
 * @param {boolean} [dados.ehCSLL=false] - Se é LACS ao invés de LALUR
 * @returns {Object} Registro de baixa na Parte B
 *
 * Base Legal: Art. 580 do RIR/2018
 */
function registrarUtilizacaoParteB(dados) {
  const {
    valorCompensado,
    saldoAnterior,
    tipoPrejuizo = 'OPERACIONAL',
    periodoApuracao = '',
    ehCSLL = false
  } = dados;

  const livro = ehCSLL ? 'LACS' : 'LALUR';
  const novoSaldo = Math.max(0, saldoAnterior - valorCompensado);

  return {
    livro,
    parte: 'B',
    tipoPrejuizo,
    periodoApuracao,
    saldoAnterior,
    valorBaixado: valorCompensado,
    saldoAtual: novoSaldo,
    natureza: 'DEVEDORA',
    tipo: 'UTILIZACAO',
    descricao: ehCSLL
      ? `Compensação de base negativa da CSLL — ${periodoApuracao}`
      : `Compensação de prejuízo fiscal ${tipoPrejuizo.toLowerCase()} — ${periodoApuracao}`,
    registroECF: ehCSLL ? 'M500' : 'M410',
    artigo: 'Art. 580',
    comprovacao: 'Manter livros e documentos comprobatórios do prejuízo utilizado (Art. 580 §único)'
  };
}

/**
 * Gera o relatório consolidado do Bloco A.
 *
 * @param {Object} dados
 * @param {Object} [dados.compensacao] - Resultado de compensarIntegrado()
 * @param {Object} [dados.vedacoes] - Resultado de verificarVedacoes()
 * @param {Object} [dados.projecao] - Resultado de simularCompensacaoPluranual()
 * @returns {Object} Relatório consolidado
 */
function gerarRelatorioA(dados) {
  const { compensacao, vedacoes, projecao } = dados;

  const resultado = {
    bloco: 'A — Compensação de Prejuízos Fiscais',
    artigos: 'Art. 579-586 do RIR/2018',
    dataGeracao: new Date().toISOString(),
    secoes: {},
    economia: { irpj: 0, csll: 0, total: 0 }
  };

  if (compensacao) {
    resultado.secoes.compensacao = {
      lucroRealAntes: compensacao.resumo.lucroRealAntes,
      totalCompensado: compensacao.resumo.totalCompensado,
      lucroRealFinal: compensacao.resumo.lucroRealFinal,
      baseCSLLFinal: compensacao.resumo.baseCSLLFinal,
      saldosRemanescentes: compensacao.resumo.saldosPosCompensacao,
      economia: compensacao.resumo.economia
    };
    resultado.economia = compensacao.resumo.economia;
  }

  if (vedacoes) {
    resultado.secoes.vedacoes = {
      compensacaoPermitida: vedacoes.compensacaoPermitida,
      vedacoesIdentificadas: vedacoes.vedacoes.length,
      restricoes: vedacoes.restricoes.length,
      detalhes: vedacoes.vedacoes.concat(vedacoes.restricoes)
    };
  }

  if (projecao) {
    resultado.secoes.projecao = {
      anosParaZerarPrejuizo: projecao.resumo.anosParaZerarPrejuizo,
      anosParaZerarBaseNegativa: projecao.resumo.anosParaZerarBaseNegativa,
      totalEconomiaProjetada: projecao.resumo.totalEconomia,
      saldoFinal: projecao.resumo.saldoFinal,
      anosSimulados: projecao.projecao.length
    };
  }

  return resultado;
}

// ============================================================================
// FUNÇÕES AUXILIARES
// ============================================================================

/**
 * Calcula o IRPJ (15% + adicional 10%) sobre um valor de lucro real.
 * @param {number} lucroReal - Valor do lucro real (anual)
 * @returns {number} Valor do IRPJ devido
 * @private
 */
function _calcularIRPJ(lucroReal) {
  if (lucroReal <= 0) return 0;
  const normal = lucroReal * ALIQUOTAS.irpj.normal;
  const baseAdicional = Math.max(0, lucroReal - ALIQUOTAS.irpj.limiteAdicionalAnual);
  const adicional = baseAdicional * ALIQUOTAS.irpj.adicional;
  return normal + adicional;
}

/**
 * Calcula o IRPJ trimestral.
 * @param {number} lucroReal - Valor do lucro real (trimestral)
 * @returns {number} Valor do IRPJ devido
 * @private
 */
function _calcularIRPJTrimestral(lucroReal) {
  if (lucroReal <= 0) return 0;
  const normal = lucroReal * ALIQUOTAS.irpj.normal;
  const baseAdicional = Math.max(0, lucroReal - ALIQUOTAS.irpj.limiteAdicionalTrimestral);
  const adicional = baseAdicional * ALIQUOTAS.irpj.adicional;
  return normal + adicional;
}

// ============================================================================
// EXPORTS
// ============================================================================


// ============================================================================
// EXEMPLOS DE USO
// ============================================================================


// ============================================================================
// CONSTANTES
// ============================================================================

/**
 * Limites para PDD — Perdas no Recebimento de Créditos (Art. 347)
 * Contratos inadimplidos A PARTIR de 08/10/2014
 */
const LIMITES_PDD_ATUAIS = {
  semGarantia: [
    { limiteInferior: 0, limiteSuperior: 15000, prazoMeses: 6, exigeJudicial: false, exigeAdministrativa: false, descricao: 'Até R$ 15.000 — vencidos > 6 meses — sem exigência judicial' },
    { limiteInferior: 15000.01, limiteSuperior: 100000, prazoMeses: 12, exigeJudicial: false, exigeAdministrativa: true, descricao: 'R$ 15.000 a R$ 100.000 — vencidos > 1 ano — cobrança administrativa mantida' },
    { limiteInferior: 100000.01, limiteSuperior: Infinity, prazoMeses: 12, exigeJudicial: true, exigeAdministrativa: false, descricao: '> R$ 100.000 — vencidos > 1 ano — exige procedimentos judiciais' }
  ],
  comGarantia: [
    { limiteInferior: 0, limiteSuperior: 50000, prazoMeses: 24, exigeJudicial: false, descricao: 'Até R$ 50.000 — vencidos > 2 anos — sem exigência judicial' },
    { limiteInferior: 50000.01, limiteSuperior: Infinity, prazoMeses: 24, exigeJudicial: true, descricao: '> R$ 50.000 — vencidos > 2 anos — exige procedimentos judiciais' }
  ]
};

/**
 * Limites para PDD — Contratos inadimplidos ANTES de 08/10/2014 (Art. 347 §2º)
 */
const LIMITES_PDD_ANTIGOS = {
  semGarantia: [
    { limiteInferior: 0, limiteSuperior: 5000, prazoMeses: 6, exigeJudicial: false, exigeAdministrativa: false, descricao: 'Até R$ 5.000 — vencidos > 6 meses' },
    { limiteInferior: 5000.01, limiteSuperior: 30000, prazoMeses: 12, exigeJudicial: false, exigeAdministrativa: true, descricao: 'R$ 5.000 a R$ 30.000 — vencidos > 1 ano — cobrança administrativa' },
    { limiteInferior: 30000.01, limiteSuperior: Infinity, prazoMeses: 12, exigeJudicial: true, exigeAdministrativa: false, descricao: '> R$ 30.000 — vencidos > 1 ano — exige judicial' }
  ],
  comGarantia: [
    { limiteInferior: 0, limiteSuperior: Infinity, prazoMeses: 24, exigeJudicial: true, descricao: 'Qualquer valor — vencidos > 2 anos — exige judicial' }
  ]
};

/**
 * Provisões dedutíveis vs indedutíveis (Art. 339-346)
 */
const PROVISOES = {
  dedutiveis: [
    { id: 'FERIAS', nome: 'Férias de empregados', artigo: 'Art. 342', regra: 'Proporcional à remuneração × dias de direito + encargos sociais' },
    { id: '13_SALARIO', nome: 'Décimo terceiro salário', artigo: 'Art. 343', regra: '1/12 da remuneração × nº meses do período + encargos sociais' },
    { id: 'TECNICAS_SEGURO', nome: 'Provisões técnicas — seguradoras', artigo: 'Art. 340', regra: 'Exigidas pela legislação especial (SUSEP/ANS/PREVIC)' },
    { id: 'ESTOQUE_LIVROS', nome: 'Perda de estoques de livros', artigo: 'Art. 341', regra: '1/3 do valor do estoque no último dia do período' },
    { id: 'PDD', nome: 'Perdas no recebimento de créditos', artigo: 'Art. 347', regra: 'Conforme faixas de valor, prazo e garantia' }
  ],
  indedutiveis: [
    { id: 'IR', nome: 'Provisão para Imposto de Renda', artigo: 'Art. 344 §único', regra: 'Obrigatória mas NÃO dedutível' },
    { id: 'CSLL', nome: 'CSLL', artigo: 'Art. 352 §6º', regra: 'Valor da CSLL não dedutível do lucro real' },
    { id: 'CONTINGENCIAS', nome: 'Contingências trabalhistas/cíveis/tributárias', artigo: 'Art. 339', regra: 'Somente provisões expressamente autorizadas são dedutíveis' },
    { id: 'IMPAIRMENT', nome: 'Redução ao valor recuperável (impairment)', artigo: 'Art. 345', regra: 'Só reconhecida no lucro real na alienação/baixa do bem' },
    { id: 'DESMONTAGEM', nome: 'Gastos estimados de desmontagem', artigo: 'Art. 346', regra: 'Só dedutíveis quando efetivamente incorridos' },
    { id: 'OSCILACAO_PRECOS', nome: 'Oscilação de preços de estoques', artigo: 'Art. 310 II', regra: 'Proibida redução por provisão para oscilação' },
    { id: 'DESVALORIZACAO_ESTOQUE', nome: 'Desvalorização global de estoques', artigo: 'Art. 310 I', regra: 'Proibidas reduções globais de valores inventariados' }
  ]
};

/**
 * Despesas indedutíveis explícitas (Art. 311-316, 352)
 */
const DESPESAS_INDEDUTIVEIS = [
  {
    id: 'GRATIFICACAO_DIRIGENTES_ESTATUTARIOS',
    artigo: 'Art. 315',
    descricao: 'Gratificações ou participações no resultado a dirigentes/administradores ESTATUTÁRIOS (sem vínculo CLT)',
    nota: 'Indedutível para IRPJ. Dedutível para CSLL (IN 1.700/17, Anexo I, item 85). '
      + 'Gratificações a empregados em geral (incluindo diretores-empregados CLT) NÃO se enquadram nesta vedação '
      + '— usar ID "GRATIFICACAO_EMPREGADOS" ou "GRATIFICACAO_DIRETOR_CLT".',
    aplicavelCSLL: false,
  },
  {
    id: 'GRATIFICACAO_DIRETOR_CLT',
    artigo: 'Art. 315 (controvertido)',
    descricao: 'Gratificações a diretores-empregados CLT — dedutibilidade controvertida no IRPJ',
    nota: 'CARF majoritariamente favorável; STJ oscilante. Dedutível para CSLL sem controvérsia. '
      + 'Avaliar perfil de risco da empresa antes de deduzir para IRPJ.',
    riscoFiscal: 'MEDIO',
    aplicavelCSLL: false,
  },
  { id: 'PAGAMENTO_SEM_CAUSA', artigo: 'Art. 316 I', descricao: 'Pagamentos sem indicação da operação ou causa' },
  { id: 'BENEFICIARIO_NAO_IDENTIFICADO', artigo: 'Art. 316 II', descricao: 'Pagamentos cujo beneficiário não é individualizado no comprovante' },
  { id: 'IRPJ_PROPRIO', artigo: 'Art. 352 §2º', descricao: 'IRPJ de que a PJ é sujeito passivo (contribuinte ou substituto)' },
  { id: 'CSLL', artigo: 'Art. 352 §6º', descricao: 'Valor da CSLL' },
  { id: 'MULTAS_FISCAIS_PUNITIVAS', artigo: 'Art. 352 §5º', descricao: 'Multas por infrações fiscais que resultem em falta/insuficiência de pagamento' },
  { id: 'ATIVO_IMOBILIZADO_DIRETO', artigo: 'Art. 313', descricao: 'Custo de aquisição de bens do ativo imobilizado e intangível (> R$ 1.200 e vida > 1 ano)' },
  { id: 'DEPRECIACAO_SEM_RELACAO', artigo: 'Art. 317 §5º', descricao: 'Depreciação de bens não relacionados com produção/comercialização' },
  { id: 'DEPRECIACAO_LEASING', artigo: 'Art. 317 §6º', descricao: 'Depreciação de bem em arrendamento mercantil pela arrendatária' },
  { id: 'DESPESAS_PESSOAIS_TITULAR', artigo: 'Art. 314 §2º', descricao: 'Despesas pessoais do titular de empresa individual sem relação com atividade' },
  { id: 'PROVISOES_NAO_AUTORIZADAS', artigo: 'Art. 339', descricao: 'Provisões não expressamente autorizadas pelo RIR' },
  { id: 'TRIBUTOS_EXIGIBILIDADE_SUSPENSA', artigo: 'Art. 352 §1º', descricao: 'Impostos/contribuições com exigibilidade suspensa (depósito judicial, liminar, etc.)' }
];

/**
 * Despesas dedutíveis com limites ou condições (Art. 311-316)
 */
const DESPESAS_COM_LIMITES = [
  { id: 'BEM_PEQUENO_VALOR', artigo: 'Art. 313 §1º I', limite: 1200, descricao: 'Bem com valor unitário ≤ R$ 1.200 pode ser despesa direta (não ativar)' },
  { id: 'BEM_VIDA_CURTA', artigo: 'Art. 313 §1º II', limite: null, descricao: 'Bem com vida útil ≤ 1 ano pode ser despesa direta' },
  { id: 'CONSUMO_EVENTUAL', artigo: 'Art. 302 §1º', limite: 0.05, descricao: 'Bens de consumo eventual ≤ 5% do custo total dos produtos vendidos' },
  { id: 'MULTAS_COMPENSATORIAS', artigo: 'Art. 352 §5º', limite: null, descricao: 'Multas compensatórias e por infrações SEM falta/insuficiência de pagamento são dedutíveis' },
  { id: 'REPAROS_CONSERVACAO', artigo: 'Art. 354', limite: null, descricao: 'Dedutíveis se para manter condições eficientes; se aumentar vida útil > 1 ano, capitalizar' },
  { id: 'FGTS', artigo: 'Art. 353', limite: null, descricao: 'Depósitos FGTS são despesa operacional, incluindo diretores não empregados' }
];

/**
 * Tipos de garantia para classificação de créditos (Art. 347 §4º)
 */
const TIPOS_GARANTIA = [
  { id: 'RESERVA_DOMINIO', descricao: 'Venda com reserva de domínio' },
  { id: 'ALIENACAO_FIDUCIARIA', descricao: 'Alienação fiduciária em garantia' },
  { id: 'GARANTIA_REAL', descricao: 'Operações com outras garantias reais' }
];

/**
 * Indicadores de omissão de receita (Art. 293-299) — complementa verificarCompliance do motor
 */
const INDICADORES_OMISSAO = [
  { id: 'SALDO_CREDOR_CAIXA', artigo: 'Art. 293 I', gravidade: 'CRITICO', descricao: 'Indicação na escrituração de saldo credor de caixa' },
  { id: 'FALTA_ESCRITURACAO_PAGAMENTO', artigo: 'Art. 293 II', gravidade: 'CRITICO', descricao: 'Falta de escrituração de pagamentos efetuados' },
  { id: 'PASSIVO_FICTICIO', artigo: 'Art. 293 III', gravidade: 'CRITICO', descricao: 'Manutenção no passivo de obrigações já pagas ou inexigíveis' },
  { id: 'SUPRIMENTO_CAIXA', artigo: 'Art. 294', gravidade: 'ALTO', descricao: 'Recursos fornecidos por sócios/administradores sem comprovação de origem' },
  { id: 'FALTA_NOTA_FISCAL', artigo: 'Art. 295', gravidade: 'CRITICO', descricao: 'Falta de emissão de NF ou emissão com valor inferior à operação' },
  { id: 'DEPOSITOS_SEM_ORIGEM', artigo: 'Art. 299', gravidade: 'ALTO', descricao: 'Créditos em conta bancária sem comprovação de origem' },
  { id: 'DIVERGENCIA_ESTOQUE', artigo: 'Art. 298', gravidade: 'MEDIO', descricao: 'Diferença no levantamento quantitativo de matérias-primas/produtos' }
];

/**
 * Métodos de avaliação de estoques aceitos (Art. 304-310)
 */
const METODOS_ESTOQUE = {
  permitidos: [
    { id: 'CUSTO_MEDIO', artigo: 'Art. 307', descricao: 'Custo médio ponderado' },
    { id: 'PEPS', artigo: 'Art. 307', descricao: 'Custo dos bens adquiridos/produzidos mais recentemente (PEPS/FIFO)' },
    { id: 'PRECO_VENDA_MARGEM', artigo: 'Art. 307', descricao: 'Preço de venda menos margem de lucro' },
    { id: 'MERCADO_RURAL', artigo: 'Art. 309', descricao: 'Preços correntes de mercado — apenas produtos agrícolas, animais e extrativos' }
  ],
  semCustoIntegrado: {
    materiaisProcessamento: { artigo: 'Art. 308 I', formula: 'MAX(1,5 × maior custo MP no período; 80% do valor produtos acabados)' },
    produtosAcabados: { artigo: 'Art. 308 II', formula: '70% do maior preço de venda no período (com ICMS)' }
  },
  vedacoes: [
    'Reduções globais de valores inventariados (Art. 310 I)',
    'Depreciações estimadas ou provisões para oscilação de preços (Art. 310 II)',
    'Estoques básicos a preços constantes ou nominais (Art. 310 III)',
    'Provisão de ajuste ao valor de mercado se menor que custo (Art. 310 IV)'
  ]
};

/**
 * Taxas de depreciação fiscal (Art. 317-329) — tabela expandida
 */
const DEPRECIACAO_FISCAL = {
  taxasAnuais: {
    edificios: { taxa: 0.04, vidaUtil: 25, artigo: 'Art. 318 I' },
    instalacoes: { taxa: 0.10, vidaUtil: 10, artigo: 'Art. 319' },
    maquinas: { taxa: 0.10, vidaUtil: 10, artigo: 'Art. 319' },
    moveis: { taxa: 0.10, vidaUtil: 10, artigo: 'Art. 319' },
    veiculosPassageiro: { taxa: 0.20, vidaUtil: 5, artigo: 'Art. 319' },
    veiculosCarga: { taxa: 0.20, vidaUtil: 5, artigo: 'Art. 319' },
    computadores: { taxa: 0.20, vidaUtil: 5, artigo: 'Art. 319' },
    software: { taxa: 0.20, vidaUtil: 5, artigo: 'Art. 319' },
    ferramentas: { taxa: 0.20, vidaUtil: 5, artigo: 'Art. 319' },
    tratores: { taxa: 0.25, vidaUtil: 4, artigo: 'Art. 319' },
    drones: { taxa: 0.20, vidaUtil: 5, artigo: 'Art. 319' },
    gps_topografia: { taxa: 0.20, vidaUtil: 5, artigo: 'Art. 319' }
  },
  aceleracaoTurnos: {
    1: 1.0,   // Art. 323 I
    2: 1.5,   // Art. 323 II
    3: 2.0    // Art. 323 III
  },
  aceleradaIncentivada: {
    atividadeRural: { taxa: 1.0, artigo: 'Art. 325', descricao: 'Depreciação integral no ano (exceto terra nua)' },
    pesquisaInovacao: { taxa: 1.0, artigo: 'Art. 326', descricao: 'Depreciação integral no ano — máquinas novas para P&D' },
    sudamSudene: { taxa: 1.0, artigo: 'Art. 329', descricao: 'Depreciação integral no ano ou até 4º ano subsequente', prazoMaximo: 5 },
    veiculosCarga3x: { taxa: null, multiplicador: 3, artigo: 'Art. 328', descricao: 'Taxa normal × 3 — veículos de carga (Lei 12.788/2013)', vigencia: '01/09/2012 a 31/12/2012' }
  }
};

/**
 * Limites de ativo que pode ir direto para despesa (Art. 313 §1º)
 */
const LIMITE_ATIVO_DESPESA = 1200; // R$ 1.200,00

// ============================================================================
// FUNÇÕES DE CÁLCULO
// ============================================================================

/**
 * Analisa a dedutibilidade de uma despesa segundo o RIR/2018.
 * Retorna se a despesa é dedutível, parcialmente dedutível, ou indedutível.
 *
 * @param {Object} dados
 * @param {string} dados.tipo - Tipo da despesa (ID de DESPESAS_INDEDUTIVEIS ou DESPESAS_COM_LIMITES)
 * @param {number} dados.valor - Valor da despesa em R$
 * @param {number} [dados.custoTotalProdutosVendidos] - CPV do período anterior (para consumo eventual)
 * @param {number} [dados.vidaUtilAnos] - Vida útil do bem em anos (para decisão ativar vs despesa)
 * @param {boolean} [dados.relacionadoProducao=true] - Se o bem/despesa está relacionado à produção
 * @returns {Object} Análise de dedutibilidade
 *
 * Base Legal: Art. 311-316 do RIR/2018
 */
function analisarDedutibilidade(dados) {
  const { tipo, valor = 0, custoTotalProdutosVendidos, vidaUtilAnos, relacionadoProducao = true } = dados;

  if (!tipo || valor < 0) {
    return { erro: 'Tipo de despesa e valor positivo são obrigatórios' };
  }

  // Verificar se está na lista de indedutíveis
  const indedutivel = DESPESAS_INDEDUTIVEIS.find(d => d.id === tipo);
  if (indedutivel) {
    // Tratamento especial para gratificações — distinguir IRPJ vs CSLL
    const ehGratificacao = tipo === 'GRATIFICACAO_DIRIGENTES_ESTATUTARIOS' || tipo === 'GRATIFICACAO_DIRETOR_CLT';
    return {
      tipo,
      valor,
      dedutivel: false,
      dedutivelCSLL: ehGratificacao ? true : false,
      valorDedutivel: 0,
      valorIndedutivel: valor,
      valorIndeditivelIRPJ: valor,
      valorIndeditivelCSLL: ehGratificacao ? 0 : valor,
      motivoIndedutibilidade: indedutivel.descricao,
      artigo: indedutivel.artigo,
      ajusteLalur: 'ADICAO',
      ajusteLacs: ehGratificacao ? null : 'ADICAO',
      descricaoAjuste: ehGratificacao
        ? `Adicionar R$ ${valor.toFixed(2)} ao LALUR (IRPJ). NÃO adicionar ao LACS (CSLL) — IN 1.700/17, Anexo I, item 85.`
        : `Adicionar R$ ${valor.toFixed(2)} ao lucro líquido na Parte A do LALUR e LACS`,
      nota: indedutivel.nota || null,
    };
  }

  // Verificar limites especiais
  const resultado = {
    tipo,
    valor,
    dedutivel: true,
    valorDedutivel: valor,
    valorIndedutivel: 0,
    artigo: 'Art. 311',
    ajusteLalur: null,
    observacoes: []
  };

  // Art. 313 §1º: Bem de pequeno valor
  if (tipo === 'ATIVO_IMOBILIZADO') {
    if (valor <= LIMITE_ATIVO_DESPESA) {
      resultado.dedutivel = true;
      resultado.valorDedutivel = valor;
      resultado.artigo = 'Art. 313 §1º I';
      resultado.observacoes.push(`Valor unitário ≤ R$ ${LIMITE_ATIVO_DESPESA} — pode ser despesa direta`);
    } else if (vidaUtilAnos && vidaUtilAnos <= 1) {
      resultado.dedutivel = true;
      resultado.valorDedutivel = valor;
      resultado.artigo = 'Art. 313 §1º II';
      resultado.observacoes.push('Vida útil ≤ 1 ano — pode ser despesa direta');
    } else {
      resultado.dedutivel = false;
      resultado.valorDedutivel = 0;
      resultado.valorIndedutivel = valor;
      resultado.artigo = 'Art. 313';
      resultado.ajusteLalur = 'ATIVAR';
      resultado.observacoes.push('Deve ser ativado e depreciado/amortizado. Não pode ser despesa direta.');
    }
  }

  // Art. 302 §1º: Consumo eventual
  if (tipo === 'CONSUMO_EVENTUAL' && custoTotalProdutosVendidos) {
    const limite = custoTotalProdutosVendidos * 0.05;
    if (valor <= limite) {
      resultado.dedutivel = true;
      resultado.valorDedutivel = valor;
      resultado.artigo = 'Art. 302 §1º';
      resultado.observacoes.push(`Dentro do limite de 5% do CPV anterior (R$ ${limite.toFixed(2)})`);
    } else {
      resultado.dedutivel = true;
      resultado.valorDedutivel = limite;
      resultado.valorIndedutivel = valor - limite;
      resultado.artigo = 'Art. 302 §1º';
      resultado.ajusteLalur = 'ADICAO_PARCIAL';
      resultado.observacoes.push(`Excesso de R$ ${(valor - limite).toFixed(2)} sobre limite de 5% do CPV`);
    }
  }

  // Art. 354: Reparos e conservação
  if (tipo === 'REPARO_CONSERVACAO') {
    if (!relacionadoProducao) {
      resultado.dedutivel = false;
      resultado.valorDedutivel = 0;
      resultado.valorIndedutivel = valor;
      resultado.artigo = 'Art. 354 §3º';
      resultado.observacoes.push('Não relacionado com produção/comercialização — indedutível');
    } else if (vidaUtilAnos && vidaUtilAnos > 1) {
      resultado.dedutivel = false;
      resultado.valorDedutivel = 0;
      resultado.valorIndedutivel = valor;
      resultado.artigo = 'Art. 354 §1º';
      resultado.ajusteLalur = 'ATIVAR';
      resultado.observacoes.push('Reparo que aumenta vida útil > 1 ano — deve capitalizar');
    }
  }

  // Art. 352 §5º: Multas
  if (tipo === 'MULTA_FISCAL') {
    resultado.artigo = 'Art. 352 §5º';
    resultado.observacoes.push('Apenas multas compensatórias e por infrações sem falta de pagamento são dedutíveis');
  }

  return resultado;
}

/**
 * Calcula a PDD (Provisão para Devedores Duvidosos) dedutível segundo Art. 347.
 * Analisa cada crédito individualmente e determina se pode ser registrado como perda.
 *
 * @param {Array<Object>} creditos - Lista de créditos a analisar
 * @param {number} creditos[].valor - Valor do crédito
 * @param {string} creditos[].dataVencimento - Data de vencimento (ISO)
 * @param {boolean} creditos[].possuiGarantia - Se possui garantia real
 * @param {string} [creditos[].tipoGarantia] - Tipo da garantia (RESERVA_DOMINIO, ALIENACAO_FIDUCIARIA, GARANTIA_REAL)
 * @param {boolean} [creditos[].devedorInsolvente=false] - Declaração judicial de insolvência
 * @param {boolean} [creditos[].devedorFalido=false] - Devedor declarado falido
 * @param {boolean} [creditos[].devedorRecuperacaoJudicial=false] - Devedor em recuperação judicial
 * @param {number} [creditos[].valorComprometidoRJ=0] - Valor comprometido a pagar na RJ
 * @param {boolean} [creditos[].cobrandoJudicialmente=false] - Se há procedimentos judiciais em curso
 * @param {boolean} [creditos[].cobrandoAdministrativamente=false] - Se há cobrança administrativa
 * @param {boolean} [creditos[].devedorParteRelacionada=false] - Se devedor é parte relacionada (Art. 347 §7º)
 * @param {string} [creditos[].dataInadimplencia] - Data da inadimplência (para regime antigo/novo)
 * @param {string} [creditos[].identificacao] - Identificação do crédito
 * @param {string} dataReferencia - Data de referência para cálculo (ISO)
 * @returns {Object} Análise completa da PDD
 *
 * Base Legal: Art. 347-351 do RIR/2018 (Lei 9.430/96, art. 9º a 12)
 */
function calcularPDD(creditos, dataReferencia) {
  if (!creditos || !Array.isArray(creditos) || creditos.length === 0) {
    return { erro: 'Informe ao menos um crédito para análise' };
  }

  const dataRef = new Date(dataReferencia || new Date().toISOString());
  const DATA_CORTE = new Date('2014-10-08');

  const resultado = {
    dataReferencia: dataRef.toISOString().split('T')[0],
    totalCreditos: 0,
    totalDedutivel: 0,
    totalIndedutivel: 0,
    creditosAnalisados: [],
    resumoPorMotivo: {},
    alertas: [],
    baseLegal: 'Art. 347-351 do RIR/2018 (Lei 9.430/96, art. 9º a 12)'
  };

  creditos.forEach((credito, idx) => {
    const analise = _analisarCreditoPDD(credito, dataRef, DATA_CORTE, idx);
    resultado.creditosAnalisados.push(analise);
    resultado.totalCreditos += credito.valor || 0;

    if (analise.dedutivel) {
      resultado.totalDedutivel += analise.valorDedutivel;
    }
    resultado.totalIndedutivel += analise.valorIndedutivel;

    // Resumo por motivo
    const motivo = analise.motivo || 'NAO_ATENDE_REQUISITOS';
    if (!resultado.resumoPorMotivo[motivo]) {
      resultado.resumoPorMotivo[motivo] = { quantidade: 0, valor: 0 };
    }
    resultado.resumoPorMotivo[motivo].quantidade++;
    resultado.resumoPorMotivo[motivo].valor += analise.valorDedutivel;
  });

  resultado.economia = {
    irpj: resultado.totalDedutivel * 0.25,
    csll: resultado.totalDedutivel * 0.09,
    total: resultado.totalDedutivel * 0.34,
    descricao: 'Economia tributária por reconhecer perdas dedutíveis (IRPJ 25% + CSLL 9%)'
  };

  return resultado;
}

/**
 * Analisa um crédito individual para fins de PDD
 * @private
 */
function _analisarCreditoPDD(credito, dataRef, dataCorteLei, idx) {
  const {
    valor = 0,
    dataVencimento,
    possuiGarantia = false,
    devedorInsolvente = false,
    devedorFalido = false,
    devedorRecuperacaoJudicial = false,
    valorComprometidoRJ = 0,
    cobrandoJudicialmente = false,
    cobrandoAdministrativamente = false,
    devedorParteRelacionada = false,
    dataInadimplencia,
    identificacao = `Crédito #${idx + 1}`
  } = credito;

  const analise = {
    identificacao,
    valor,
    dedutivel: false,
    valorDedutivel: 0,
    valorIndedutivel: valor,
    motivo: null,
    artigo: null,
    requisitosAtendidos: [],
    requisitosNaoAtendidos: [],
    observacoes: []
  };

  // Art. 347 §7º: Partes relacionadas — VEDADO
  if (devedorParteRelacionada) {
    analise.motivo = 'PARTE_RELACIONADA_VEDADO';
    analise.artigo = 'Art. 347 §7º';
    analise.requisitosNaoAtendidos.push('Devedor é parte relacionada (controladora, controlada, coligada, sócio, administrador ou parente até 3º grau)');
    return analise;
  }

  // Art. 347 §1º I: Devedor insolvente por sentença judicial
  if (devedorInsolvente) {
    analise.dedutivel = true;
    analise.valorDedutivel = valor;
    analise.valorIndedutivel = 0;
    analise.motivo = 'INSOLVENCIA_JUDICIAL';
    analise.artigo = 'Art. 347 §1º I';
    analise.requisitosAtendidos.push('Declaração de insolvência por sentença judicial');
    return analise;
  }

  // Art. 347 §1º IV: Devedor falido ou em recuperação judicial
  if (devedorFalido || devedorRecuperacaoJudicial) {
    const valorDedutivel = Math.max(0, valor - valorComprometidoRJ);
    analise.dedutivel = valorDedutivel > 0;
    analise.valorDedutivel = valorDedutivel;
    analise.valorIndedutivel = valor - valorDedutivel;
    analise.motivo = devedorFalido ? 'DEVEDOR_FALIDO' : 'RECUPERACAO_JUDICIAL';
    analise.artigo = 'Art. 347 §1º IV';
    analise.requisitosAtendidos.push(
      devedorFalido ? 'Devedor declarado falido' : 'Devedor em recuperação judicial'
    );
    if (valorComprometidoRJ > 0) {
      analise.observacoes.push(`Parcela comprometida na RJ: R$ ${valorComprometidoRJ.toFixed(2)} — não dedutível. Dedutível: R$ ${valorDedutivel.toFixed(2)}`);
    }
    if (!cobrandoJudicialmente) {
      analise.observacoes.push('ATENÇÃO: Art. 347 §5º exige adoção de procedimentos judiciais para recebimento');
    }
    return analise;
  }

  // Determinar se usa limites novos ou antigos
  const dataInadimpl = dataInadimplencia ? new Date(dataInadimplencia) : new Date(dataVencimento);
  const usarLimitesAntigos = dataInadimpl < dataCorteLei;
  const limites = usarLimitesAntigos ? LIMITES_PDD_ANTIGOS : LIMITES_PDD_ATUAIS;

  if (usarLimitesAntigos) {
    analise.observacoes.push('Usando limites antigos (inadimplência anterior a 08/10/2014)');
  }

  // Calcular meses vencidos
  if (!dataVencimento) {
    analise.requisitosNaoAtendidos.push('Data de vencimento não informada');
    analise.motivo = 'SEM_DATA_VENCIMENTO';
    return analise;
  }

  const dataVenc = new Date(dataVencimento);
  const mesesVencidos = _calcularMesesEntre(dataVenc, dataRef);

  // Selecionar faixa
  const tipoCredito = possuiGarantia ? 'comGarantia' : 'semGarantia';
  const faixas = limites[tipoCredito];
  const faixa = faixas.find(f => valor >= f.limiteInferior && valor <= f.limiteSuperior);

  if (!faixa) {
    analise.motivo = 'FAIXA_NAO_ENCONTRADA';
    return analise;
  }

  analise.artigo = usarLimitesAntigos ? 'Art. 347 §2º' : 'Art. 347 §1º';

  // Verificar prazo
  if (mesesVencidos < faixa.prazoMeses) {
    analise.requisitosNaoAtendidos.push(`Prazo insuficiente: ${mesesVencidos} meses (mínimo: ${faixa.prazoMeses} meses)`);
    analise.motivo = 'PRAZO_INSUFICIENTE';
    analise.observacoes.push(`Faltam ${faixa.prazoMeses - mesesVencidos} meses para atingir prazo mínimo`);
    return analise;
  }
  analise.requisitosAtendidos.push(`Prazo atendido: ${mesesVencidos} meses ≥ ${faixa.prazoMeses} meses`);

  // Verificar exigência judicial
  if (faixa.exigeJudicial && !cobrandoJudicialmente) {
    analise.requisitosNaoAtendidos.push('Exige procedimentos judiciais iniciados e mantidos');
    analise.motivo = 'FALTA_COBRANCA_JUDICIAL';
    analise.observacoes.push('Iniciar e manter cobrança judicial para tornar dedutível');
    return analise;
  }
  if (faixa.exigeJudicial) {
    analise.requisitosAtendidos.push('Cobrança judicial em curso');
  }

  // Verificar exigência administrativa
  if (faixa.exigeAdministrativa && !cobrandoAdministrativamente) {
    analise.requisitosNaoAtendidos.push('Exige cobrança administrativa mantida');
    analise.motivo = 'FALTA_COBRANCA_ADMINISTRATIVA';
    return analise;
  }
  if (faixa.exigeAdministrativa) {
    analise.requisitosAtendidos.push('Cobrança administrativa mantida');
  }

  // Todos os requisitos atendidos
  analise.dedutivel = true;
  analise.valorDedutivel = valor;
  analise.valorIndedutivel = 0;
  analise.motivo = possuiGarantia ? 'COM_GARANTIA_ATENDE' : 'SEM_GARANTIA_ATENDE';
  analise.observacoes.push(faixa.descricao);

  return analise;
}

/**
 * Calcula meses entre duas datas
 * @private
 */
function _calcularMesesEntre(dataInicio, dataFim) {
  const anos = dataFim.getFullYear() - dataInicio.getFullYear();
  const meses = dataFim.getMonth() - dataInicio.getMonth();
  return anos * 12 + meses;
}

/**
 * Calcula provisões dedutíveis de férias e 13º salário (Art. 342-343).
 *
 * @param {Array<Object>} empregados - Lista de empregados
 * @param {number} empregados[].remuneracaoMensal - Remuneração mensal bruta
 * @param {number} empregados[].diasFeriasDevidos - Dias de férias já adquiridos
 * @param {number} empregados[].meses13Devidos - Meses trabalhados para 13º no período
 * @param {number} [taxaEncargos=0.36] - % encargos sociais (INSS patronal + RAT + terceiros + FGTS)
 * @param {number} numMesesPeriodo - Número de meses do período de apuração (1-12)
 * @returns {Object} Cálculo das provisões
 *
 * Base Legal: Art. 342 e 343 do RIR/2018
 */
function calcularProvisoesTrabalhistas(empregados, taxaEncargos = 0.36, numMesesPeriodo = 12) {
  if (!empregados || !Array.isArray(empregados) || empregados.length === 0) {
    return { erro: 'Informe ao menos um empregado' };
  }

  let totalProvisaoFerias = 0;
  let totalProvisao13 = 0;
  const detalhes = [];

  empregados.forEach((emp, idx) => {
    const { remuneracaoMensal = 0, diasFeriasDevidos = 0, meses13Devidos = 0 } = emp;

    // Art. 342: Férias — base na remuneração × dias de direito / 30 + 1/3 constitucional + encargos
    const feriasBruto = (remuneracaoMensal / 30) * diasFeriasDevidos;
    const tercoFerias = feriasBruto / 3;
    const feriasComTerco = feriasBruto + tercoFerias;
    const encargosFerias = feriasComTerco * taxaEncargos;
    const provisaoFerias = feriasComTerco + encargosFerias;

    // Art. 343: 13º — 1/12 da remuneração × meses + encargos
    const base13 = (remuneracaoMensal / 12) * meses13Devidos;
    const encargos13 = base13 * taxaEncargos;
    const provisao13 = base13 + encargos13;

    totalProvisaoFerias += provisaoFerias;
    totalProvisao13 += provisao13;

    detalhes.push({
      empregado: emp.nome || `Empregado #${idx + 1}`,
      remuneracaoMensal,
      provisaoFerias: Math.round(provisaoFerias * 100) / 100,
      provisao13: Math.round(provisao13 * 100) / 100,
      diasFeriasDevidos,
      meses13Devidos
    });
  });

  totalProvisaoFerias = Math.round(totalProvisaoFerias * 100) / 100;
  totalProvisao13 = Math.round(totalProvisao13 * 100) / 100;
  const totalGeral = totalProvisaoFerias + totalProvisao13;

  return {
    provisaoFerias: {
      total: totalProvisaoFerias,
      artigo: 'Art. 342',
      dedutivel: true,
      descricao: 'Provisão para férias (remuneração + 1/3 + encargos sociais)'
    },
    provisao13Salario: {
      total: totalProvisao13,
      artigo: 'Art. 343',
      dedutivel: true,
      descricao: 'Provisão para 13º salário (1/12 × meses + encargos sociais)'
    },
    totalProvisoes: totalGeral,
    economia: {
      irpj: totalGeral * 0.25,
      csll: totalGeral * 0.09,
      total: totalGeral * 0.34,
      descricao: 'Economia por dedução das provisões trabalhistas'
    },
    taxaEncargosUtilizada: taxaEncargos,
    numEmpregados: empregados.length,
    detalhes,
    baseLegal: 'Art. 342-343 do RIR/2018'
  };
}

/**
 * Calcula depreciação fiscal completa de um bem conforme Art. 317-329.
 * Inclui: normal, turnos, incentivada, bens usados.
 *
 * @param {Object} bem
 * @param {string} bem.tipo - Tipo do bem (chave de DEPRECIACAO_FISCAL.taxasAnuais)
 * @param {number} bem.custoAquisicao - Custo de aquisição em R$
 * @param {number} [bem.depreciacaoAcumulada=0] - Depreciação já acumulada
 * @param {boolean} [bem.usado=false] - Se é bem usado
 * @param {number} [bem.vidaUtilRestante] - Vida útil restante (anos) para bens usados
 * @param {number} [bem.turnos=1] - Número de turnos (1, 2 ou 3)
 * @param {string} [bem.incentivo] - Tipo de incentivo (atividadeRural, pesquisaInovacao, sudamSudene)
 * @param {number} [bem.mesesUso=12] - Meses de uso no período
 * @param {boolean} [bem.relacionadoProducao=true] - Se é relacionado à produção
 * @returns {Object} Cálculo completo da depreciação
 *
 * Base Legal: Art. 317-329 do RIR/2018
 */
function calcularDepreciacaoCompleta(bem) {
  const {
    tipo,
    custoAquisicao = 0,
    depreciacaoAcumulada = 0,
    usado = false,
    vidaUtilRestante,
    turnos = 1,
    incentivo,
    mesesUso = 12,
    relacionadoProducao = true
  } = bem;

  if (!tipo || custoAquisicao <= 0) {
    return { erro: 'Tipo do bem e custo de aquisição positivo são obrigatórios' };
  }

  // Art. 317 §5º: Verificar relação com produção
  if (!relacionadoProducao) {
    return {
      tipo,
      custoAquisicao,
      depreciacaoPeriodo: 0,
      dedutivel: false,
      artigo: 'Art. 317 §5º',
      motivo: 'Bem não relacionado com produção/comercialização — depreciação indedutível'
    };
  }

  // Art. 313 §1º: Bem de pequeno valor — despesa direta
  if (custoAquisicao <= LIMITE_ATIVO_DESPESA) {
    return {
      tipo,
      custoAquisicao,
      depreciacaoPeriodo: custoAquisicao,
      dedutivel: true,
      artigo: 'Art. 313 §1º I',
      motivo: `Valor ≤ R$ ${LIMITE_ATIVO_DESPESA} — dedução integral como despesa`
    };
  }

  const infoBem = DEPRECIACAO_FISCAL.taxasAnuais[tipo];
  if (!infoBem) {
    return { erro: `Tipo de bem '${tipo}' não encontrado na tabela de depreciação` };
  }

  // Art. 322: Taxa para bens usados
  let taxaAnual = infoBem.taxa;
  let vidaUtilEfetiva = infoBem.vidaUtil;

  if (usado) {
    const metadeVidaNovo = infoBem.vidaUtil / 2;
    const restante = vidaUtilRestante || metadeVidaNovo;
    vidaUtilEfetiva = Math.max(metadeVidaNovo, restante);
    taxaAnual = 1 / vidaUtilEfetiva;
  }

  // Art. 323: Aceleração por turnos (apenas bens móveis, não edificios)
  let multiplicadorTurnos = 1;
  if (tipo !== 'edificios' && turnos >= 2) {
    multiplicadorTurnos = DEPRECIACAO_FISCAL.aceleracaoTurnos[turnos] || 1;
  }

  // Depreciação normal ajustada
  const taxaEfetiva = taxaAnual * multiplicadorTurnos;
  const depreciacaoAnualBruta = custoAquisicao * taxaEfetiva;

  // Proporcional ao período de uso
  const fatorProporcional = mesesUso / 12;
  let depreciacaoPeriodo = depreciacaoAnualBruta * fatorProporcional;

  // Art. 317 §3º: Limite — não ultrapassar custo de aquisição
  const saldoDepreciavel = Math.max(0, custoAquisicao - depreciacaoAcumulada);
  depreciacaoPeriodo = Math.min(depreciacaoPeriodo, saldoDepreciavel);

  // Depreciação incentivada (Art. 324-329)
  let depreciacaoIncentivada = 0;
  let exclusaoLalur = 0;
  let adicaoFuturaLalur = false;

  if (incentivo && DEPRECIACAO_FISCAL.aceleradaIncentivada[incentivo]) {
    const inc = DEPRECIACAO_FISCAL.aceleradaIncentivada[incentivo];

    if (inc.taxa === 1.0) {
      // Depreciação integral no ano
      depreciacaoIncentivada = Math.max(0, saldoDepreciavel - depreciacaoPeriodo);
      exclusaoLalur = depreciacaoIncentivada;
    } else if (inc.multiplicador) {
      const depreciacaoAcelerada = custoAquisicao * taxaAnual * inc.multiplicador * fatorProporcional;
      depreciacaoIncentivada = Math.max(0, Math.min(depreciacaoAcelerada - depreciacaoPeriodo, saldoDepreciavel - depreciacaoPeriodo));
      exclusaoLalur = depreciacaoIncentivada;
    }

    adicaoFuturaLalur = true;
  }

  const depreciacaoTotalPeriodo = depreciacaoPeriodo + depreciacaoIncentivada;
  const novaDepreciacaoAcumulada = depreciacaoAcumulada + depreciacaoTotalPeriodo;

  // Art. 324 §3º / 321 §único: Quando acumulada atinge custo, depreciação contábil vira adição
  const limiteAtingido = novaDepreciacaoAcumulada >= custoAquisicao;

  return {
    tipo,
    custoAquisicao,
    depreciacaoAcumuladaAnterior: depreciacaoAcumulada,
    saldoDepreciavelAnterior: saldoDepreciavel,
    taxaNormal: infoBem.taxa,
    taxaEfetiva,
    multiplicadorTurnos,
    mesesUso,
    depreciacaoNormal: Math.round(depreciacaoPeriodo * 100) / 100,
    depreciacaoIncentivada: Math.round(depreciacaoIncentivada * 100) / 100,
    exclusaoLalur: Math.round(exclusaoLalur * 100) / 100,
    depreciacaoTotalPeriodo: Math.round(depreciacaoTotalPeriodo * 100) / 100,
    novaDepreciacaoAcumulada: Math.round(novaDepreciacaoAcumulada * 100) / 100,
    saldoDepreciavelRestante: Math.round(Math.max(0, custoAquisicao - novaDepreciacaoAcumulada) * 100) / 100,
    limiteAtingido,
    adicaoFuturaLalur,
    dedutivel: true,
    vidaUtilEfetiva,
    bemUsado: usado,
    incentivo: incentivo || null,
    artigos: _montarArtigosDepreciacao(usado, turnos, incentivo),
    economia: {
      irpj: depreciacaoTotalPeriodo * 0.25,
      csll: depreciacaoTotalPeriodo * 0.09,
      total: depreciacaoTotalPeriodo * 0.34
    },
    alertas: limiteAtingido
      ? ['Limite de depreciação atingido. A partir do próximo período, depreciação contábil deverá ser ADICIONADA ao lucro real (Art. 324 §3º / Art. 321 §único)']
      : []
  };
}

/**
 * Monta lista de artigos relevantes para a depreciação
 * @private
 */
function _montarArtigosDepreciacao(usado, turnos, incentivo) {
  const artigos = ['Art. 317 (dedutibilidade)', 'Art. 319 (quota)', 'Art. 320 (taxa anual)'];
  if (usado) artigos.push('Art. 322 (bens usados)');
  if (turnos > 1) artigos.push('Art. 323 (aceleração por turnos)');
  if (incentivo === 'atividadeRural') artigos.push('Art. 325 (atividade rural)');
  if (incentivo === 'pesquisaInovacao') artigos.push('Art. 326 (P&D)');
  if (incentivo === 'sudamSudene') artigos.push('Art. 329 (SUDAM/SUDENE)');
  return artigos;
}

/**
 * Calcula amortização de bens intangíveis e direitos (Art. 330-335).
 *
 * @param {Object} ativo
 * @param {string} ativo.descricao - Descrição do ativo
 * @param {string} ativo.tipo - Tipo (PATENTE, LICENCA, CONTRATO, BENFEITORIA, SOFTWARE, FLORESTA, PD_INOVACAO, INTANGIVEL)
 * @param {number} ativo.custoAquisicao - Custo de aquisição em R$
 * @param {number} ativo.prazoAnos - Prazo de vida útil/contratual em anos
 * @param {number} [ativo.amortizacaoAcumulada=0] - Amortização acumulada
 * @param {number} [ativo.mesesUso=12] - Meses de uso no período
 * @param {boolean} [ativo.pesquisaInovacao=false] - Se é vinculado a P&D/inovação (Art. 335)
 * @param {boolean} [ativo.relacionadoProducao=true] - Se relacionado com produção/comercialização
 * @returns {Object} Cálculo da amortização
 *
 * Base Legal: Art. 330-335 do RIR/2018
 */
function calcularAmortizacao(ativo) {
  const {
    descricao = 'Ativo intangível',
    tipo = 'INTANGIVEL',
    custoAquisicao = 0,
    prazoAnos = 0,
    amortizacaoAcumulada = 0,
    mesesUso = 12,
    pesquisaInovacao = false,
    relacionadoProducao = true
  } = ativo;

  if (custoAquisicao <= 0 || prazoAnos <= 0) {
    return { erro: 'Custo de aquisição e prazo (em anos) devem ser positivos' };
  }

  // Art. 330 §4º: Somente se relacionado à produção/comercialização
  if (!relacionadoProducao) {
    return {
      descricao,
      custoAquisicao,
      amortizacaoPeriodo: 0,
      dedutivel: false,
      artigo: 'Art. 330 §4º',
      motivo: 'Não relacionado com produção/comercialização'
    };
  }

  // Art. 333: Taxa anual = 1 / prazo restante
  const taxaAnual = 1 / prazoAnos;
  const saldoAmortizavel = Math.max(0, custoAquisicao - amortizacaoAcumulada);

  // Amortização normal proporcional
  const fatorProporcional = mesesUso / 12;
  let amortizacaoNormal = custoAquisicao * taxaAnual * fatorProporcional;
  amortizacaoNormal = Math.min(amortizacaoNormal, saldoAmortizavel);

  // Art. 335: Amortização acelerada incentivada — P&D/Inovação
  let amortizacaoIncentivada = 0;
  let exclusaoLalur = 0;

  if (pesquisaInovacao) {
    // Dedução integral no próprio período
    amortizacaoIncentivada = Math.max(0, saldoAmortizavel - amortizacaoNormal);
    exclusaoLalur = amortizacaoIncentivada;
  }

  const amortizacaoTotal = amortizacaoNormal + amortizacaoIncentivada;
  const novaAmortizacaoAcumulada = amortizacaoAcumulada + amortizacaoTotal;

  // Art. 330 §3º: Se o direito se extinguir antes da amortização integral
  const direitoExtinto = novaAmortizacaoAcumulada < custoAquisicao && prazoAnos <= 0;
  const saldoADeduzir = direitoExtinto ? (custoAquisicao - novaAmortizacaoAcumulada) : 0;

  return {
    descricao,
    tipo,
    custoAquisicao,
    prazoAnos,
    taxaAnual: Math.round(taxaAnual * 10000) / 10000,
    amortizacaoNormal: Math.round(amortizacaoNormal * 100) / 100,
    amortizacaoIncentivada: Math.round(amortizacaoIncentivada * 100) / 100,
    exclusaoLalur: Math.round(exclusaoLalur * 100) / 100,
    amortizacaoTotalPeriodo: Math.round(amortizacaoTotal * 100) / 100,
    novaAmortizacaoAcumulada: Math.round(novaAmortizacaoAcumulada * 100) / 100,
    saldoAmortizavelRestante: Math.round(Math.max(0, custoAquisicao - novaAmortizacaoAcumulada) * 100) / 100,
    dedutivel: true,
    direitoExtinto,
    saldoADeduzirExtincao: Math.round(saldoADeduzir * 100) / 100,
    artigos: pesquisaInovacao
      ? ['Art. 330 (dedutibilidade)', 'Art. 333 (taxa anual)', 'Art. 335 (acelerada P&D)']
      : ['Art. 330 (dedutibilidade)', 'Art. 332-333 (quota e taxa)'],
    economia: {
      irpj: amortizacaoTotal * 0.25,
      csll: amortizacaoTotal * 0.09,
      total: amortizacaoTotal * 0.34
    }
  };
}

/**
 * Calcula exaustão de recursos minerais ou florestais (Art. 336-337).
 *
 * @param {Object} recurso
 * @param {string} recurso.tipo - 'MINERAL' ou 'FLORESTAL'
 * @param {number} recurso.custoAquisicao - Custo de aquisição/prospecção
 * @param {number} recurso.volumeTotal - Volume total estimado (possança da mina ou nº árvores)
 * @param {number} recurso.volumeExplorado - Volume explorado no período
 * @param {number} [recurso.exaustaoAcumulada=0] - Exaustão já acumulada
 * @param {number} [recurso.prazoConcessao] - Prazo da concessão em anos (alternativo)
 * @param {number} [recurso.mesesUso=12] - Meses de uso no período
 * @returns {Object} Cálculo da exaustão
 *
 * Base Legal: Art. 336-337 do RIR/2018
 */
function calcularExaustao(recurso) {
  const {
    tipo = 'MINERAL',
    custoAquisicao = 0,
    volumeTotal = 0,
    volumeExplorado = 0,
    exaustaoAcumulada = 0,
    prazoConcessao,
    mesesUso = 12
  } = recurso;

  if (custoAquisicao <= 0) {
    return { erro: 'Custo de aquisição deve ser positivo' };
  }

  const saldoExaurivel = Math.max(0, custoAquisicao - exaustaoAcumulada);
  let quotaExaustao = 0;
  let metodoCalculo = '';

  if (volumeTotal > 0 && volumeExplorado > 0) {
    // Método por volume (Art. 336 §2º / Art. 337 §2º)
    const percentualExplorado = volumeExplorado / volumeTotal;
    quotaExaustao = custoAquisicao * percentualExplorado;
    metodoCalculo = 'VOLUME_PRODUCAO';
  } else if (prazoConcessao && prazoConcessao > 0) {
    // Método pelo prazo de concessão
    const taxaAnual = 1 / prazoConcessao;
    quotaExaustao = custoAquisicao * taxaAnual * (mesesUso / 12);
    metodoCalculo = 'PRAZO_CONCESSAO';
  } else {
    return { erro: 'Informe volumeTotal + volumeExplorado OU prazoConcessao' };
  }

  quotaExaustao = Math.min(quotaExaustao, saldoExaurivel);
  const novaExaustaoAcumulada = exaustaoAcumulada + quotaExaustao;

  return {
    tipo,
    custoAquisicao,
    metodoCalculo,
    volumeTotal,
    volumeExplorado,
    percentualExplorado: volumeTotal > 0 ? Math.round((volumeExplorado / volumeTotal) * 10000) / 100 : null,
    quotaExaustao: Math.round(quotaExaustao * 100) / 100,
    novaExaustaoAcumulada: Math.round(novaExaustaoAcumulada * 100) / 100,
    saldoExaurivelRestante: Math.round(Math.max(0, custoAquisicao - novaExaustaoAcumulada) * 100) / 100,
    dedutivel: true,
    artigo: tipo === 'MINERAL' ? 'Art. 336' : 'Art. 337',
    economia: {
      irpj: quotaExaustao * 0.25,
      csll: quotaExaustao * 0.09,
      total: quotaExaustao * 0.34
    }
  };
}

/**
 * Calcula despesas pré-operacionais e sua amortização (Art. 338).
 *
 * @param {Object} dados
 * @param {string} dados.tipo - 'PRE_OPERACIONAL' ou 'EXPANSAO'
 * @param {number} dados.totalDespesas - Total das despesas pré-operacionais
 * @param {string} dados.dataInicio - Data de início das operações ou novas instalações
 * @param {string} dados.dataReferencia - Data do período de apuração atual
 * @param {number} [dados.prazoAmortizacaoAnos=5] - Prazo mínimo 5 anos
 * @param {number} [dados.amortizacaoAcumulada=0] - Amortização acumulada
 * @returns {Object} Cálculo das despesas pré-operacionais
 *
 * Base Legal: Art. 338 do RIR/2018 (Lei 12.973/14, art. 11)
 */
function calcularDespesasPreOperacionais(dados) {
  const {
    tipo = 'PRE_OPERACIONAL',
    totalDespesas = 0,
    dataInicio,
    dataReferencia,
    prazoAmortizacaoAnos = 5,
    amortizacaoAcumulada = 0
  } = dados;

  if (totalDespesas <= 0) {
    return { erro: 'Total de despesas deve ser positivo' };
  }

  // Art. 338 §único: Prazo mínimo 5 anos
  const prazoEfetivo = Math.max(5, prazoAmortizacaoAnos);

  // Não computar no período em que incorridas
  // Excluir em quotas fixas mensais a partir do início das operações
  const quotaMensal = totalDespesas / (prazoEfetivo * 12);
  const saldoAmortizavel = Math.max(0, totalDespesas - amortizacaoAcumulada);

  let mesesDecorridos = 0;
  if (dataInicio && dataReferencia) {
    mesesDecorridos = _calcularMesesEntre(new Date(dataInicio), new Date(dataReferencia));
  }

  // Meses no período atual (máximo 12)
  const mesesNoPeriodo = Math.min(12, Math.max(0, mesesDecorridos));
  let exclusaoLalurPeriodo = quotaMensal * mesesNoPeriodo;
  exclusaoLalurPeriodo = Math.min(exclusaoLalurPeriodo, saldoAmortizavel);

  return {
    tipo,
    totalDespesas,
    prazoAmortizacao: prazoEfetivo,
    quotaMensal: Math.round(quotaMensal * 100) / 100,
    mesesDecorridos,
    exclusaoLalurPeriodo: Math.round(exclusaoLalurPeriodo * 100) / 100,
    amortizacaoAcumuladaAnterior: amortizacaoAcumulada,
    novaAmortizacaoAcumulada: Math.round((amortizacaoAcumulada + exclusaoLalurPeriodo) * 100) / 100,
    saldoRestante: Math.round(Math.max(0, totalDespesas - amortizacaoAcumulada - exclusaoLalurPeriodo) * 100) / 100,
    artigo: 'Art. 338',
    descricao: tipo === 'PRE_OPERACIONAL'
      ? 'Despesas pré-operacionais — exclusão em quotas fixas mensais (mín. 5 anos)'
      : 'Despesas de expansão industrial — exclusão em quotas fixas mensais (mín. 5 anos)',
    ajusteLalur: {
      adicao: totalDespesas,
      exclusao: exclusaoLalurPeriodo,
      descricao: 'Adicionar totalidade no período da despesa; excluir quotas mensais a partir do início das operações'
    },
    economia: {
      irpj: exclusaoLalurPeriodo * 0.25,
      csll: exclusaoLalurPeriodo * 0.09,
      total: exclusaoLalurPeriodo * 0.34
    }
  };
}

/**
 * Calcula custo de aquisição de mercadorias conforme Art. 301.
 *
 * @param {Object} dados
 * @param {number} dados.valorMercadoria - Valor da mercadoria
 * @param {number} [dados.frete=0] - Frete até o estabelecimento
 * @param {number} [dados.seguro=0] - Seguro
 * @param {number} [dados.tributoAquisicao=0] - Tributos devidos na aquisição (II, IPI quando não recuperável)
 * @param {number} [dados.desembaracoAduaneiro=0] - Gastos com desembaraço
 * @param {number} [dados.icmsRecuperavel=0] - ICMS creditável (a subtrair)
 * @param {number} [dados.pisRecuperavel=0] - PIS creditável (a subtrair)
 * @param {number} [dados.cofinsRecuperavel=0] - COFINS creditável (a subtrair)
 * @param {number} [dados.ipiRecuperavel=0] - IPI creditável (a subtrair)
 * @returns {Object} Custo de aquisição apurado
 *
 * Base Legal: Art. 301 do RIR/2018
 */
function calcularCustoAquisicao(dados) {
  const {
    valorMercadoria = 0,
    frete = 0,
    seguro = 0,
    tributoAquisicao = 0,
    desembaracoAduaneiro = 0,
    icmsRecuperavel = 0,
    pisRecuperavel = 0,
    cofinsRecuperavel = 0,
    ipiRecuperavel = 0
  } = dados;

  const custoBruto = valorMercadoria + frete + seguro + tributoAquisicao + desembaracoAduaneiro;
  const totalRecuperavel = icmsRecuperavel + pisRecuperavel + cofinsRecuperavel + ipiRecuperavel;
  const custoLiquido = custoBruto - totalRecuperavel;

  return {
    custoBruto: Math.round(custoBruto * 100) / 100,
    composicao: {
      valorMercadoria,
      frete,
      seguro,
      tributoAquisicao,
      desembaracoAduaneiro
    },
    impostosRecuperaveis: {
      icms: icmsRecuperavel,
      pis: pisRecuperavel,
      cofins: cofinsRecuperavel,
      ipi: ipiRecuperavel,
      total: Math.round(totalRecuperavel * 100) / 100
    },
    custoAquisicaoFiscal: Math.round(custoLiquido * 100) / 100,
    artigo: 'Art. 301',
    observacoes: [
      'Art. 301 §1º: Frete e seguro integram custo de aquisição',
      'Art. 301 §2º: Desembaraço aduaneiro integra custo de aquisição',
      'Art. 301 §3º: Impostos recuperáveis NÃO integram custo'
    ]
  };
}

/**
 * Avalia estoque quando a empresa NÃO possui contabilidade de custo integrada (Art. 308).
 *
 * @param {Object} dados
 * @param {number} [dados.maiorCustoMPAdquirida] - Maior custo de MP adquirida no período
 * @param {number} [dados.maiorPrecoVendaProduto] - Maior preço de venda de produto acabado no período
 * @returns {Object} Valores mínimos obrigatórios de estoque
 *
 * Base Legal: Art. 308 do RIR/2018
 */
function avaliarEstoqueSemCustoIntegrado(dados) {
  const { maiorCustoMPAdquirida = 0, maiorPrecoVendaProduto = 0 } = dados;

  // Art. 308 II: Produtos acabados = 70% do maior preço de venda
  const valorProdutosAcabados = maiorPrecoVendaProduto * 0.70;

  // Art. 308 I: Materiais em processamento = MAX(1,5 × maior custo MP; 80% do valor prod. acabados)
  const opcao1 = maiorCustoMPAdquirida * 1.5;
  const opcao2 = valorProdutosAcabados * 0.80;
  const valorMateriaisProcessamento = Math.max(opcao1, opcao2);

  return {
    produtosAcabados: {
      valorMinimo: Math.round(valorProdutosAcabados * 100) / 100,
      formula: '70% × maior preço de venda no período (com ICMS)',
      artigo: 'Art. 308 II'
    },
    materiaisProcessamento: {
      valorMinimo: Math.round(valorMateriaisProcessamento * 100) / 100,
      formula: 'MAX(1,5 × maior custo MP; 80% × valor prod. acabados)',
      opcao1: Math.round(opcao1 * 100) / 100,
      opcao2: Math.round(opcao2 * 100) / 100,
      artigo: 'Art. 308 I'
    },
    observacoes: [
      'Art. 308 §1º: Preço de venda SEM exclusão de ICMS',
      'Art. 308 §2º: Reconhecer na escrituração comercial',
      'Estes valores são OBRIGATÓRIOS quando não há contabilidade de custo integrada (Art. 306 §1º-§2º)'
    ]
  };
}

/**
 * Analisa encargos financeiros de créditos vencidos para exclusão (Art. 349).
 *
 * @param {Object} dados
 * @param {number} dados.valorEncargos - Encargos financeiros contabilizados como receita
 * @param {string} dados.dataVencimentoCredito - Data de vencimento do crédito
 * @param {string} dados.dataReferencia - Data de referência
 * @param {boolean} [dados.cobrandoJudicialmente=false] - Se há cobrança judicial
 * @param {number} [dados.valorCredito=0] - Valor do crédito para determinar exigência judicial
 * @param {boolean} [dados.possuiGarantia=false] - Se possui garantia
 * @returns {Object} Análise dos encargos
 *
 * Base Legal: Art. 349 do RIR/2018 (Lei 9.430/96, art. 11)
 */
function analisarEncargosFinanceirosVencidos(dados) {
  const {
    valorEncargos = 0,
    dataVencimentoCredito,
    dataReferencia,
    cobrandoJudicialmente = false,
    valorCredito = 0,
    possuiGarantia = false
  } = dados;

  if (!dataVencimentoCredito || valorEncargos <= 0) {
    return { erro: 'Data de vencimento e valor dos encargos são obrigatórios' };
  }

  const dataVenc = new Date(dataVencimentoCredito);
  const dataRef = new Date(dataReferencia || new Date().toISOString());
  const mesesVencidos = _calcularMesesEntre(dataVenc, dataRef);

  // Art. 349: Prazo mínimo de 2 meses
  if (mesesVencidos < 2) {
    return {
      valorEncargos,
      exclusivel: false,
      mesesVencidos,
      artigo: 'Art. 349',
      motivo: `Prazo insuficiente: ${mesesVencidos} meses (mínimo 2 meses)`
    };
  }

  // Verificar se precisa de cobrança judicial (depende da faixa do crédito)
  // As exceções são créditos de pequeno valor conforme Art. 347
  const dispensaJudicial = (
    (!possuiGarantia && valorCredito <= 100000) ||
    (possuiGarantia && valorCredito <= 50000)
  );

  if (!dispensaJudicial && !cobrandoJudicialmente) {
    return {
      valorEncargos,
      exclusivel: false,
      mesesVencidos,
      artigo: 'Art. 349 §1º',
      motivo: 'Crédito acima dos limites de dispensa — exige cobrança judicial'
    };
  }

  return {
    valorEncargos,
    exclusivel: true,
    valorExclusao: valorEncargos,
    mesesVencidos,
    artigo: 'Art. 349',
    ajusteLalur: 'EXCLUSAO',
    descricao: 'Excluir do lucro líquido os encargos financeiros contabilizados como receita',
    alerta: 'Art. 349 §2º: Adicionar quando efetivamente recebidos ou quando reconhecida a perda',
    economia: {
      irpj: valorEncargos * 0.25,
      csll: valorEncargos * 0.09,
      total: valorEncargos * 0.34
    }
  };
}

/**
 * Verifica todos os indicadores de omissão de receita (Art. 293-299).
 * Análise expandida do verificarCompliance do motor principal.
 *
 * @param {Object} dados
 * @param {number} [dados.saldoCaixa] - Saldo de caixa (negativo = saldo credor)
 * @param {number} [dados.pagamentosNaoEscriturados=0] - Total de pagamentos não escriturados
 * @param {number} [dados.passivoSemComprovacao=0] - Obrigações no passivo já pagas ou sem exigibilidade
 * @param {number} [dados.suprimentosSociosSemOrigem=0] - Recursos de sócios sem comprovação de origem
 * @param {number} [dados.receitaSemNF=0] - Valor de operações sem emissão de NF
 * @param {number} [dados.depositosBancariosSemOrigem=0] - Depósitos sem comprovação
 * @param {number} [dados.receitaDeclarada=0] - Receita total declarada
 * @param {number} [dados.diferencaEstoque=0] - Diferença no levantamento quantitativo
 * @returns {Object} Diagnóstico completo de omissão de receita
 *
 * Base Legal: Art. 293-300 do RIR/2018
 */
function verificarOmissaoReceita(dados) {
  const {
    saldoCaixa,
    pagamentosNaoEscriturados = 0,
    passivoSemComprovacao = 0,
    suprimentosSociosSemOrigem = 0,
    receitaSemNF = 0,
    depositosBancariosSemOrigem = 0,
    receitaDeclarada = 0,
    diferencaEstoque = 0
  } = dados;

  const alertas = [];
  let receitaOmitidaEstimada = 0;
  let riscoBaixo = 0, riscoMedio = 0, riscoAlto = 0, riscoCritico = 0;

  // Art. 293 I: Saldo credor de caixa
  if (saldoCaixa !== undefined && saldoCaixa < 0) {
    const valor = Math.abs(saldoCaixa);
    alertas.push({
      indicador: 'SALDO_CREDOR_CAIXA',
      artigo: 'Art. 293 I',
      gravidade: 'CRITICO',
      valor,
      descricao: `Saldo credor de caixa de R$ ${valor.toFixed(2)} — presunção de omissão de receita`,
      recomendacao: 'Justificar com documentação hábil ou retificar escrituração'
    });
    receitaOmitidaEstimada += valor;
    riscoCritico++;
  }

  // Art. 293 II: Falta de escrituração de pagamentos
  if (pagamentosNaoEscriturados > 0) {
    alertas.push({
      indicador: 'FALTA_ESCRITURACAO_PAGAMENTO',
      artigo: 'Art. 293 II',
      gravidade: 'CRITICO',
      valor: pagamentosNaoEscriturados,
      descricao: `Pagamentos não escriturados: R$ ${pagamentosNaoEscriturados.toFixed(2)}`,
      recomendacao: 'Regularizar escrituração de todos os pagamentos efetuados'
    });
    receitaOmitidaEstimada += pagamentosNaoEscriturados;
    riscoCritico++;
  }

  // Art. 293 III: Passivo fictício
  if (passivoSemComprovacao > 0) {
    alertas.push({
      indicador: 'PASSIVO_FICTICIO',
      artigo: 'Art. 293 III',
      gravidade: 'CRITICO',
      valor: passivoSemComprovacao,
      descricao: `Passivo sem comprovação de exigibilidade: R$ ${passivoSemComprovacao.toFixed(2)}`,
      recomendacao: 'Baixar obrigações já pagas; comprovar exigibilidade das remanescentes'
    });
    receitaOmitidaEstimada += passivoSemComprovacao;
    riscoCritico++;
  }

  // Art. 294: Suprimentos de sócios sem origem
  if (suprimentosSociosSemOrigem > 0) {
    alertas.push({
      indicador: 'SUPRIMENTO_CAIXA',
      artigo: 'Art. 294',
      gravidade: 'ALTO',
      valor: suprimentosSociosSemOrigem,
      descricao: `Suprimentos de sócios sem comprovação de origem: R$ ${suprimentosSociosSemOrigem.toFixed(2)}`,
      recomendacao: 'Comprovar a efetividade da entrega e a origem dos recursos (DIRPF, extratos)'
    });
    receitaOmitidaEstimada += suprimentosSociosSemOrigem;
    riscoAlto++;
  }

  // Art. 295: Falta de NF
  if (receitaSemNF > 0) {
    alertas.push({
      indicador: 'FALTA_NOTA_FISCAL',
      artigo: 'Art. 295',
      gravidade: 'CRITICO',
      valor: receitaSemNF,
      descricao: `Operações sem emissão de NF: R$ ${receitaSemNF.toFixed(2)}`,
      recomendacao: 'Emitir documentário fiscal para TODAS as operações'
    });
    receitaOmitidaEstimada += receitaSemNF;
    riscoCritico++;
  }

  // Art. 299: Depósitos bancários sem origem
  if (depositosBancariosSemOrigem > 0) {
    alertas.push({
      indicador: 'DEPOSITOS_SEM_ORIGEM',
      artigo: 'Art. 299',
      gravidade: 'ALTO',
      valor: depositosBancariosSemOrigem,
      descricao: `Depósitos bancários sem comprovação de origem: R$ ${depositosBancariosSemOrigem.toFixed(2)}`,
      recomendacao: 'Documentar origem de todos os créditos bancários individualmente (Art. 299 §3º)'
    });
    receitaOmitidaEstimada += depositosBancariosSemOrigem;
    riscoAlto++;
  }

  // Art. 298: Divergência de estoque
  if (diferencaEstoque > 0) {
    alertas.push({
      indicador: 'DIVERGENCIA_ESTOQUE',
      artigo: 'Art. 298',
      gravidade: 'MEDIO',
      valor: diferencaEstoque,
      descricao: `Diferença no levantamento quantitativo de estoques: R$ ${diferencaEstoque.toFixed(2)}`,
      recomendacao: 'Conciliar estoque físico com contábil; inventariar corretamente (Art. 304)'
    });
    receitaOmitidaEstimada += diferencaEstoque;
    riscoMedio++;
  }

  // Calcular impacto tributário da omissão estimada
  const impostoSobreOmissao = {
    irpj: receitaOmitidaEstimada * 0.25,
    csll: receitaOmitidaEstimada * 0.09,
    total: receitaOmitidaEstimada * 0.34,
    multa75: receitaOmitidaEstimada * 0.34 * 0.75,
    multa150: receitaOmitidaEstimada * 0.34 * 1.50,
    descricao: 'Art. 300: Tributação conforme regime da PJ. Multa de ofício: 75% a 150%.'
  };

  const nivelRisco = riscoCritico > 0 ? 'CRITICO' : riscoAlto > 0 ? 'ALTO' : riscoMedio > 0 ? 'MEDIO' : 'BAIXO';

  return {
    nivelRisco,
    totalAlertasCriticos: riscoCritico,
    totalAlertasAlto: riscoAlto,
    totalAlertasMedio: riscoMedio,
    receitaOmitidaEstimada: Math.round(receitaOmitidaEstimada * 100) / 100,
    exposicaoFiscal: impostoSobreOmissao,
    alertas,
    baseLegal: 'Art. 293-300 do RIR/2018',
    recomendacaoGeral: nivelRisco === 'CRITICO'
      ? 'URGENTE: Regularizar escrituração e documentação IMEDIATAMENTE. Risco de autuação com multa qualificada (150%).'
      : nivelRisco === 'ALTO'
        ? 'Regularizar pendências antes do próximo fechamento. Manter documentação comprobatória organizada.'
        : nivelRisco === 'MEDIO'
          ? 'Ajustar controles internos. Manter inventário atualizado e conciliado.'
          : 'Situação regular. Manter procedimentos de controle.'
  };
}

/**
 * Gera relatório consolidado de todas as despesas dedutíveis e ajustes do LALUR.
 *
 * @param {Object} dados
 * @param {Array} [dados.despesas] - Lista de despesas para análise de dedutibilidade
 * @param {Array} [dados.creditos] - Créditos para PDD
 * @param {Array} [dados.empregados] - Empregados para provisões trabalhistas
 * @param {Array} [dados.bensDepreciacao] - Bens para depreciação
 * @param {Array} [dados.ativosAmortizacao] - Ativos para amortização
 * @param {Object} [dados.dadosOmissao] - Dados para verificação de omissão
 * @param {string} [dados.dataReferencia] - Data de referência
 * @returns {Object} Relatório consolidado com totais e ajustes LALUR
 */
function gerarRelatorioConsolidado(dados) {
  const {
    despesas = [],
    creditos = [],
    empregados = [],
    bensDepreciacao = [],
    ativosAmortizacao = [],
    dadosOmissao = null,
    dataReferencia = new Date().toISOString()
  } = dados;

  const relatorio = {
    dataReferencia,
    totalDespesasDedutivel: 0,
    totalDespesasIndedutivel: 0,
    totalExclusoesLalur: 0,
    totalAdicoesLalur: 0,
    economiaTotal: 0,
    secoes: {}
  };

  // 1. Análise de despesas
  if (despesas.length > 0) {
    const analises = despesas.map(d => analisarDedutibilidade(d));
    const totalDed = analises.reduce((s, a) => s + (a.valorDedutivel || 0), 0);
    const totalInd = analises.reduce((s, a) => s + (a.valorIndedutivel || 0), 0);
    relatorio.secoes.despesas = { totalDedutivel: totalDed, totalIndedutivel: totalInd, detalhes: analises };
    relatorio.totalDespesasDedutivel += totalDed;
    relatorio.totalDespesasIndedutivel += totalInd;
    relatorio.totalAdicoesLalur += totalInd;
  }

  // 2. PDD
  if (creditos.length > 0) {
    const pdd = calcularPDD(creditos, dataReferencia);
    relatorio.secoes.pdd = pdd;
    relatorio.totalDespesasDedutivel += pdd.totalDedutivel || 0;
    relatorio.economiaTotal += (pdd.economia && pdd.economia.total) || 0;
  }

  // 3. Provisões trabalhistas
  if (empregados.length > 0) {
    const prov = calcularProvisoesTrabalhistas(empregados);
    relatorio.secoes.provisoesTrabalhistas = prov;
    relatorio.totalDespesasDedutivel += prov.totalProvisoes || 0;
    relatorio.economiaTotal += (prov.economia && prov.economia.total) || 0;
  }

  // 4. Depreciação
  if (bensDepreciacao.length > 0) {
    const deps = bensDepreciacao.map(b => calcularDepreciacaoCompleta(b));
    const totalDep = deps.reduce((s, d) => s + (d.depreciacaoTotalPeriodo || 0), 0);
    const totalExcl = deps.reduce((s, d) => s + (d.exclusaoLalur || 0), 0);
    relatorio.secoes.depreciacao = { totalPeriodo: totalDep, exclusoesLalur: totalExcl, detalhes: deps };
    relatorio.totalDespesasDedutivel += totalDep;
    relatorio.totalExclusoesLalur += totalExcl;
    relatorio.economiaTotal += totalDep * 0.34;
  }

  // 5. Amortização
  if (ativosAmortizacao.length > 0) {
    const amorts = ativosAmortizacao.map(a => calcularAmortizacao(a));
    const totalAmort = amorts.reduce((s, a) => s + (a.amortizacaoTotalPeriodo || 0), 0);
    const totalExcl = amorts.reduce((s, a) => s + (a.exclusaoLalur || 0), 0);
    relatorio.secoes.amortizacao = { totalPeriodo: totalAmort, exclusoesLalur: totalExcl, detalhes: amorts };
    relatorio.totalDespesasDedutivel += totalAmort;
    relatorio.totalExclusoesLalur += totalExcl;
    relatorio.economiaTotal += totalAmort * 0.34;
  }

  // 6. Omissão de receita
  if (dadosOmissao) {
    relatorio.secoes.omissaoReceita = verificarOmissaoReceita(dadosOmissao);
  }

  relatorio.economiaTotal = Math.round(relatorio.economiaTotal * 100) / 100;

  return relatorio;
}

// ============================================================================
// EXPORTS
// ============================================================================


// ============================================================================
// EXEMPLOS DE USO
// ============================================================================


// ============================================================================
// CONSTANTES
// ============================================================================

/**
 * Limites de dedutibilidade para royalties, assistência técnica e aluguéis (Art. 361-365)
 */
const LIMITES_ROYALTIES_ASSISTENCIA = {
  limiteGeral: 0.05, // 5% da receita líquida (Art. 365)
  regras: [
    {
      id: 'ALUGUEL_MERCADO',
      artigo: 'Art. 361 §1º I',
      descricao: 'Aluguel pago a sócios/dirigentes/parentes: dedutível até o valor de mercado',
      tipo: 'ALUGUEL'
    },
    {
      id: 'ALUGUEL_NAO_PRODUCAO',
      artigo: 'Art. 361 §2º',
      descricao: 'Aluguel de bens não relacionados à produção/comercialização: indedutível',
      tipo: 'ALUGUEL'
    },
    {
      id: 'ROYALTIES_SOCIOS',
      artigo: 'Art. 363 I',
      descricao: 'Royalties pagos a sócios PF/PJ, dirigentes e parentes: indedutível',
      tipo: 'ROYALTIES'
    },
    {
      id: 'ROYALTIES_MATRIZ_EXTERIOR',
      artigo: 'Art. 363 III-a',
      descricao: 'Royalties de patentes pagos pela filial à matriz no exterior: indedutível',
      tipo: 'ROYALTIES'
    },
    {
      id: 'ROYALTIES_CONTROLADORA_EXTERIOR',
      artigo: 'Art. 363 III-b',
      descricao: 'Royalties de patentes a controladora no exterior: indedutível (salvo INPI+BACEN pós 31/12/1991)',
      tipo: 'ROYALTIES'
    },
    {
      id: 'ROYALTIES_SEM_REGISTRO_BACEN',
      artigo: 'Art. 363 IV-a / V-a',
      descricao: 'Royalties ao exterior sem registro no BACEN: indedutível',
      tipo: 'ROYALTIES'
    },
    {
      id: 'ASSIST_TECNICA_EXTERIOR',
      artigo: 'Art. 364',
      descricao: 'Assistência técnica ao exterior: exige contrato BACEN + serviços efetivos + limite MF',
      tipo: 'ASSISTENCIA_TECNICA',
      prazoMaximo: 10, // 5 + 5 anos com autorização CMN
      requisitos: ['Contrato registrado no BACEN', 'Serviços efetivamente prestados', 'Dentro do limite do MF']
    },
    {
      id: 'ASSIST_TECNICA_MATRIZ',
      artigo: 'Art. 364 §2º',
      descricao: 'Assistência técnica paga à matriz ou controladora no exterior: indedutível (salvo INPI+BACEN pós 31/12/1991)',
      tipo: 'ASSISTENCIA_TECNICA'
    }
  ]
};

/**
 * Despesas dedutíveis com condições específicas (Art. 366-387)
 */
const DESPESAS_CONDICIONAIS = {
  leasing: {
    artigo: 'Art. 366',
    dedutiveis: ['Contraprestações de arrendamento mercantil (bens relacionados à produção)'],
    indedutiveis: [
      'Despesas financeiras em contratos de leasing (Art. 366 §1º)',
      'Depreciação/amortização/exaustão de bem em leasing pela arrendatária (Art. 366 §3º)',
      'AVP de obrigações de leasing (Art. 366 §2º)'
    ],
    alertaDescaracterizacao: 'Art. 367: Aquisição em desacordo com Lei 6.099/74 = compra e venda a prestação'
  },
  remuneracaoSocios: {
    artigo: 'Art. 368',
    dedutiveis: ['Remuneração mensal fixa de sócios, diretores, administradores, conselheiros'],
    indedutiveis: [
      'Retiradas não debitadas em custos/despesas (Art. 368 §único I)',
      'Retiradas que não correspondam a remuneração mensal fixa (Art. 368 §único I)',
      'Pagamentos a membros de diretoria de S.A. não residentes no País (Art. 368 §único II)',
      'Gratificações/participações no resultado a dirigentes (Art. 315)'
    ]
  },
  remuneracaoIndireta: {
    artigo: 'Art. 369',
    descricao: 'Veículo, imóvel, benefícios a administradores/diretores/gerentes',
    regra: 'Integra remuneração do beneficiário. Dedutível se identificado e individualizado (Art. 369 §3º I). Indedutível + IRRF 35% se não identificado (Art. 369 §3º II).'
  },
  pagamentoAcoes: {
    artigo: 'Art. 370',
    regra: 'ADICIONAR ao lucro real quando apropriado. EXCLUIR somente após pagamento efetivo ou transferência definitiva das ações.',
    momentoDedutibilidade: 'Após liquidação em caixa ou transferência definitiva de propriedade'
  },
  plr: {
    artigo: 'Art. 371',
    dedutivel: true,
    limite: null,
    condicoes: [
      'Observar Lei 10.101/2000',
      'Deduzir no próprio exercício de constituição',
      'Máximo 2 pagamentos/ano, periodicidade mínima trimestral'
    ]
  },
  servicosAssistenciais: {
    artigo: 'Art. 372',
    dedutivel: true,
    condicoes: [
      'Planos de saúde/seguros destinados INDISTINTAMENTE a todos empregados e dirigentes',
      'Comprovação por sistema contábil específico',
      'Inclui: médico, odontológico, farmacêutico, social'
    ]
  },
  previdenciaComplementar: {
    artigo: 'Art. 373',
    dedutivel: true,
    limite: 0.20, // 20% do total de salários + remuneração de dirigentes
    descricao: 'Contribuições a planos de previdência complementar — limite de 20% da folha',
    condicoes: [
      'Plano assemelhado à previdência social',
      'Em favor de empregados e dirigentes',
      'Soma com FAPI (Art. 375) não pode exceder 20% da folha',
      'Seguro de vida com sobrevivência: indistintamente a todos empregados/dirigentes'
    ]
  },
  desfalqueFurto: {
    artigo: 'Art. 376',
    dedutivel: true,
    condicoes: ['Inquérito trabalhista instaurado OU queixa-crime registrada']
  },
  doacoes: {
    artigo: 'Art. 377',
    limites: {
      ensinoPesquisa: {
        percentual: 0.015, // 1,5% do lucro operacional
        artigo: 'Art. 377 I',
        base: 'Lucro operacional antes da dedução',
        condicoes: ['Instituição autorizada por lei federal', 'Art. 213 CF: sem fins lucrativos, aplica excedentes na educação']
      },
      entidadesCivis: {
        percentual: 0.02, // 2% do lucro operacional
        artigo: 'Art. 377 II',
        base: 'Lucro operacional antes da dedução',
        condicoes: [
          'Entidade civil sem fins lucrativos',
          'Serviços gratuitos a empregados/dependentes ou comunidade',
          'Doação em dinheiro: via conta corrente bancária da entidade',
          'Declaração de aplicação integral dos recursos',
          'Entidade = Organização da Sociedade Civil (Lei 13.019/2014)'
        ]
      }
    }
  },
  propaganda: {
    artigo: 'Art. 380',
    dedutivel: true,
    condicoes: [
      'Diretamente relacionada com atividade da empresa',
      'Regime de competência',
      'Empresas beneficiárias devem ter CNPJ e escrituração regular',
      'Amostras: até 5% da receita de vendas dos produtos (Art. 380 V-c)'
    ],
    limiteAmostras: 0.05
  },
  formacaoProfissional: { artigo: 'Art. 382', dedutivel: true, limite: null },
  alimentacao: {
    artigo: 'Art. 383',
    dedutivel: true,
    condicoes: ['Fornecida INDISTINTAMENTE a todos os empregados']
  },
  valeTransporte: { artigo: 'Art. 384', dedutivel: true, limite: null },
  cultura: {
    artigo: 'Art. 385',
    dedutivel: true,
    descricao: 'Valores contribuídos ao PRONAC — integralmente dedutíveis como despesa + dedução do IR devido (Art. 539)'
  }
};

/**
 * Regras de variação cambial — caixa vs competência (Art. 407)
 */
const VARIACAO_CAMBIAL = {
  regimePadrao: 'CAIXA', // Art. 407 caput — na liquidação da operação
  regimeOpcional: 'COMPETENCIA', // Art. 407 §1º
  regras: {
    opcaoCompetencia: 'Deve ser exercida em janeiro e aplica-se a todo o ano-calendário (Art. 407 §4º I)',
    mudancaDuranteAno: 'Permitida apenas em caso de elevada oscilação cambial (Art. 407 §4º II)',
    comunicacaoRFB: 'Comunicar à RFB no mês de janeiro ou no mês posterior à mudança (Art. 407 §6º)',
    avpCambial: 'Variações cambiais sobre saldos de AVP NÃO são computadas no lucro real (Art. 408)'
  }
};

/**
 * Regras de avaliação a valor justo (Art. 388-396)
 */
const VALOR_JUSTO = {
  ganho: {
    artigo: 'Art. 388',
    regra: 'NÃO computar se evidenciado em SUBCONTA vinculada ao ativo/passivo',
    tributacao: 'Computar quando ativo realizado (depreciação, alienação, baixa) ou passivo liquidado (Art. 388 §1º)',
    semSubconta: 'TRIBUTADO imediatamente (Art. 388 §3º). Não pode reduzir prejuízo fiscal do período (Art. 388 §4º).'
  },
  perda: {
    artigo: 'Art. 389',
    regra: 'Computar somente quando ativo realizado ou passivo liquidado, SE evidenciada em SUBCONTA',
    semSubconta: 'INDEDUTÍVEL (Art. 389 §2º)'
  },
  incorporacaoFusaoCisao: {
    artigo: 'Art. 392',
    regra: 'Ganhos de valor justo da sucedida NÃO integram custo na sucessora para fins de ganho de capital e depreciação'
  },
  subscricaoCapital: {
    ganho: {
      artigo: 'Art. 393',
      regra: 'Diferido se em subconta vinculada à participação societária',
      realizacao: [
        'Na alienação/liquidação da participação (Art. 393 §1º I)',
        'Proporcionalmente à realização do bem pela investida (Art. 393 §1º II)',
        'À razão de 1/60 por mês nos 5 anos seguintes, se não sujeito a realização (Art. 393 §1º III)'
      ]
    },
    perda: {
      artigo: 'Art. 394',
      regra: 'Mesmas condições do ganho para ser dedutível. Sem subconta = indedutível.'
    }
  },
  transicaoPresumidoReal: {
    artigo: 'Art. 396',
    regra: 'PJ que muda de presumido para real: incluir ganhos de valor justo na base do presumido. Pode diferir se usar subcontas (Art. 388).'
  }
};

/**
 * Regras de participações societárias e MEP (Art. 415-440)
 */
const MEP_REGRAS = {
  obrigatoriedade: {
    artigo: 'Art. 420',
    aplicaA: ['Controladas', 'Coligadas', 'Mesmo grupo ou controle comum'],
    coligada: 'Influência significativa: 20%+ do capital votante ou poder de participar nas decisões (Art. 420 §3º-§4º)'
  },
  desdobramentoCusto: {
    artigo: 'Art. 421',
    componentes: [
      'I — Valor de patrimônio líquido na época da aquisição',
      'II — Mais ou menos-valia (diferença entre valor justo dos ativos líquidos e PL)',
      'III — Ágio por rentabilidade futura (goodwill) = custo de aquisição - (PL + mais/menos-valia)'
    ],
    laudo: 'Laudo de perito independente protocolado na RFB ou registrado em cartório até 13º mês após aquisição (Art. 421 §2º)'
  },
  contrapartidaMEP: {
    artigo: 'Art. 426',
    regra: 'Ajustes positivos e negativos do MEP NÃO computados no lucro real'
  },
  dividendos: {
    artigo: 'Art. 415-418',
    recebidos: 'Lucros/dividendos apurados a partir de jan/1996 NÃO integram base de cálculo do IRPJ (Art. 418)',
    exclusaoLucroReal: 'Excluir do lucro líquido para determinação do lucro real (Art. 415 §1º)',
    registroMEP: 'Diminuição do valor do investimento, sem influenciar resultado (Art. 425 §1º)'
  },
  incorporacaoFusaoCisao: {
    maisValia: {
      artigo: 'Art. 431',
      regra: 'Pode integrar custo do bem para depreciação e ganho/perda de capital (se entre partes independentes)',
      condicoes: ['Laudo tempestivo', 'Valores identificáveis', 'Bem relacionado à produção']
    },
    menosValia: {
      artigo: 'Art. 432',
      regra: 'DEVE integrar custo do bem. Se bem não transferido na cisão: tributar em quotas fixas mensais (máx. 5 anos).'
    },
    goodwill: {
      artigo: 'Art. 433',
      regra: 'Exclusão do lucro real à razão de 1/60 por mês (máx.), nos períodos subsequentes',
      condicoes: ['Entre partes NÃO dependentes', 'Laudo tempestivo', 'Valores identificáveis']
    },
    compraVantajosa: {
      artigo: 'Art. 434',
      regra: 'Computar no lucro real à razão de 1/60 por mês (mín.), nos períodos subsequentes'
    },
    partesDependentes: {
      artigo: 'Art. 435',
      criterios: [
        'Controlados pela mesma parte (Art. 435 I)',
        'Relação de controle entre adquirente e alienante (Art. 435 II)',
        'Alienante é sócio/titular/conselheiro/administrador (Art. 435 III)',
        'Parente até 3º grau do anterior (Art. 435 IV)',
        'Outras relações que comprovem dependência (Art. 435 V)'
      ]
    }
  }
};

/**
 * Despesas financeiras — dedutibilidade (Art. 397-403)
 */
const DESPESAS_FINANCEIRAS = {
  dedutiveis: [
    { id: 'JUROS_GERAIS', artigo: 'Art. 398', descricao: 'Juros pagos ou incorridos — dedutíveis como custo ou despesa' },
    { id: 'JUROS_ANTECIPADOS', artigo: 'Art. 399', descricao: 'Juros antecipados, descontos, correção monetária prefixada — pro rata tempore' },
    { id: 'CUSTOS_EMPRESTIMO', artigo: 'Art. 402', descricao: 'Juros de empréstimos para aquisição de ativos de longa maturação — podem ser custo do ativo' }
  ],
  indedutiveis: [
    { id: 'JUROS_CONTROLADA_LUCROS_EXTERIOR', artigo: 'Art. 400', descricao: 'Juros a controlada/coligada sobre lucros não disponibilizados no exterior' },
    { id: 'DESPESA_FINANCEIRA_LEASING', artigo: 'Art. 401', descricao: 'Despesas financeiras de arrendamento mercantil' },
    { id: 'DIVIDENDOS_DESPESA_FINANCEIRA', artigo: 'Art. 403', descricao: 'Dividendos classificados como despesa financeira na contabilidade' }
  ]
};

/**
 * Operações no exterior — regras de tributação (Art. 446-451)
 */
const OPERACOES_EXTERIOR = {
  regra: {
    artigo: 'Art. 446',
    base: 'Lucros, rendimentos e ganhos de capital no exterior computados no lucro real (balanço 31/12)',
    conversao: 'Taxa de câmbio para venda na data da contabilização no País (Art. 446 §1º)',
    prejuizo: 'Prejuízos no exterior NÃO compensáveis com lucros no País (Art. 446 §7º)',
    incentivos: 'Não se admite incentivo fiscal sobre IR de lucros no exterior (Art. 446 §10)'
  },
  filiais: {
    artigo: 'Art. 446 §3º-§4º',
    disponibilizacao: 'Lucros considerados disponibilizados na data do balanço da filial/sucursal',
    demonstracao: 'De acordo com normas da legislação brasileira',
    adicao: 'Na proporção da participação acionária'
  },
  controladas: {
    artigo: 'Art. 448',
    regra: 'Parcela do ajuste MEP equivalente aos lucros (antes do IR) computada no lucro real da controladora',
    consolidacao: {
      artigo: 'Art. 449',
      vigencia: 'Até ano-calendário 2022',
      excecoes: [
        'País sem tratado de troca de informações (Art. 449 I)',
        'País com tributação favorecida ou regime fiscal privilegiado (Art. 449 II)',
        'Controlada por PJ em regime privilegiado (Art. 449 III)',
        'Renda ativa própria < 80% da renda total (Art. 449 IV)'
      ],
      irretratavel: true
    },
    prejuizo: {
      artigo: 'Art. 448 §2º / Art. 450 II',
      regra: 'Compensável com lucros futuros da MESMA PJ no exterior'
    }
  }
};

// ============================================================================
// FUNÇÕES DE CÁLCULO
// ============================================================================

/**
 * Calcula o limite de dedutibilidade de royalties e assistência técnica (Art. 365).
 *
 * @param {Object} dados
 * @param {number} dados.receitaLiquida - Receita líquida anual em R$
 * @param {number} [dados.royaltiesPatentes=0] - Royalties por patentes de invenção
 * @param {number} [dados.royaltiesMarcas=0] - Royalties por uso de marcas
 * @param {number} [dados.assistenciaTecnica=0] - Assistência técnica, científica, administrativa
 * @param {number} [dados.coeficienteMF] - Coeficiente específico do MF para o setor (se houver)
 * @param {boolean} [dados.beneficiarioExterior=false] - Se pagamento ao exterior
 * @param {boolean} [dados.registradoBACEN=false] - Se contrato registrado no BACEN
 * @param {boolean} [dados.averbadoINPI=false] - Se averbado no INPI
 * @param {boolean} [dados.beneficiarioSocio=false] - Se beneficiário é sócio/dirigente/parente
 * @param {boolean} [dados.beneficiarioControladora=false] - Se beneficiário é controladora/matriz
 * @returns {Object} Análise de dedutibilidade com limites
 *
 * Base Legal: Art. 361-365 do RIR/2018
 */
function calcularLimiteRoyaltiesAssistencia(dados) {
  const {
    receitaLiquida = 0,
    royaltiesPatentes = 0,
    royaltiesMarcas = 0,
    assistenciaTecnica = 0,
    coeficienteMF,
    beneficiarioExterior = false,
    registradoBACEN = false,
    averbadoINPI = false,
    beneficiarioSocio = false,
    beneficiarioControladora = false
  } = dados;

  const totalPago = royaltiesPatentes + royaltiesMarcas + assistenciaTecnica;
  const limitePercentual = coeficienteMF || LIMITES_ROYALTIES_ASSISTENCIA.limiteGeral;
  const limiteAbsoluto = receitaLiquida * limitePercentual;

  const resultado = {
    receitaLiquida,
    totalPago,
    limitePercentual,
    limiteAbsoluto: Math.round(limiteAbsoluto * 100) / 100,
    valorDedutivel: 0,
    valorIndedutivel: 0,
    impedimentos: [],
    alertas: [],
    artigo: 'Art. 365',
    detalhamento: {}
  };

  // Verificar impedimentos absolutos
  if (beneficiarioSocio) {
    // Royalties a sócios: indedutível (Art. 363 I)
    if (royaltiesPatentes > 0 || royaltiesMarcas > 0) {
      resultado.impedimentos.push({
        tipo: 'ROYALTIES_SOCIOS',
        valor: royaltiesPatentes + royaltiesMarcas,
        artigo: 'Art. 363 I',
        descricao: 'Royalties pagos a sócios/dirigentes/parentes: INDEDUTÍVEL'
      });
    }
  }

  if (beneficiarioControladora && beneficiarioExterior) {
    if (!averbadoINPI || !registradoBACEN) {
      resultado.impedimentos.push({
        tipo: 'CONTROLADORA_EXTERIOR',
        valor: totalPago,
        artigo: 'Art. 363 III-b / Art. 364 §2º',
        descricao: 'Pagamento à controladora/matriz no exterior sem INPI+BACEN pós 31/12/1991: INDEDUTÍVEL'
      });
    }
  }

  if (beneficiarioExterior) {
    if (!registradoBACEN) {
      resultado.impedimentos.push({
        tipo: 'SEM_REGISTRO_BACEN',
        valor: totalPago,
        artigo: 'Art. 363 IV-a / Art. 364 I',
        descricao: 'Contrato não registrado no BACEN: INDEDUTÍVEL para exterior'
      });
    }
    if (assistenciaTecnica > 0 && !averbadoINPI) {
      resultado.alertas.push('Art. 365 §3º: Dedutibilidade condicionada à averbação no INPI');
    }
  }

  // Calcular valores dedutíveis
  const totalImpedido = resultado.impedimentos.reduce((s, i) => s + i.valor, 0);
  const totalElegivel = Math.max(0, totalPago - totalImpedido);
  const valorDedutivel = Math.min(totalElegivel, limiteAbsoluto);
  const excessoLimite = Math.max(0, totalElegivel - limiteAbsoluto);

  resultado.valorDedutivel = Math.round(valorDedutivel * 100) / 100;
  resultado.valorIndedutivel = Math.round((totalImpedido + excessoLimite) * 100) / 100;

  if (excessoLimite > 0) {
    resultado.alertas.push(
      `Excesso de R$ ${excessoLimite.toFixed(2)} sobre limite de ${(limitePercentual * 100).toFixed(1)}% da receita líquida — considerado LUCRO DISTRIBUÍDO (Art. 365 §2º)`
    );
  }

  resultado.detalhamento = {
    royaltiesPatentes: { valor: royaltiesPatentes, artigo: 'Art. 362-363' },
    royaltiesMarcas: { valor: royaltiesMarcas, artigo: 'Art. 362-363' },
    assistenciaTecnica: { valor: assistenciaTecnica, artigo: 'Art. 364' }
  };

  resultado.ajusteLalur = resultado.valorIndedutivel > 0
    ? { tipo: 'ADICAO', valor: resultado.valorIndedutivel, descricao: 'Adicionar ao lucro líquido na Parte A do LALUR' }
    : null;

  resultado.economia = {
    irpj: valorDedutivel * 0.25,
    csll: valorDedutivel * 0.09,
    total: valorDedutivel * 0.34
  };

  return resultado;
}

/**
 * Calcula o limite de dedutibilidade de doações (Art. 377-379).
 *
 * @param {Object} dados
 * @param {number} dados.lucroOperacional - Lucro operacional (antes das deduções de doações)
 * @param {number} [dados.doacaoEnsinoPesquisa=0] - Doações a instituições de ensino e pesquisa
 * @param {number} [dados.doacaoEntidadesCivis=0] - Doações a entidades civis / OSCIPs
 * @param {number} [dados.outrasDoacoes=0] - Outras doações (geralmente indedutíveis)
 * @returns {Object} Análise dos limites de doações
 *
 * Base Legal: Art. 377-379 do RIR/2018
 */
function calcularLimiteDoacoes(dados) {
  const {
    lucroOperacional = 0,
    doacaoEnsinoPesquisa = 0,
    doacaoEntidadesCivis = 0,
    outrasDoacoes = 0
  } = dados;

  // Art. 377 I: 1,5% do lucro operacional ANTES de computar ambas deduções
  const limiteEnsino = lucroOperacional * DESPESAS_CONDICIONAIS.doacoes.limites.ensinoPesquisa.percentual;
  const dedutivelEnsino = Math.min(doacaoEnsinoPesquisa, limiteEnsino);
  const excessoEnsino = Math.max(0, doacaoEnsinoPesquisa - limiteEnsino);

  // Art. 377 II: 2% do lucro operacional ANTES de computar ambas deduções
  const limiteEntidades = lucroOperacional * DESPESAS_CONDICIONAIS.doacoes.limites.entidadesCivis.percentual;
  const dedutivelEntidades = Math.min(doacaoEntidadesCivis, limiteEntidades);
  const excessoEntidades = Math.max(0, doacaoEntidadesCivis - limiteEntidades);

  const totalDedutivel = dedutivelEnsino + dedutivelEntidades;
  const totalIndedutivel = excessoEnsino + excessoEntidades + outrasDoacoes;

  return {
    lucroOperacional,
    ensinoPesquisa: {
      valorPago: doacaoEnsinoPesquisa,
      limite: Math.round(limiteEnsino * 100) / 100,
      dedutivel: Math.round(dedutivelEnsino * 100) / 100,
      excesso: Math.round(excessoEnsino * 100) / 100,
      artigo: 'Art. 377 I'
    },
    entidadesCivis: {
      valorPago: doacaoEntidadesCivis,
      limite: Math.round(limiteEntidades * 100) / 100,
      dedutivel: Math.round(dedutivelEntidades * 100) / 100,
      excesso: Math.round(excessoEntidades * 100) / 100,
      artigo: 'Art. 377 II'
    },
    outrasDoacoes: {
      valorPago: outrasDoacoes,
      dedutivel: 0,
      indedutivel: outrasDoacoes,
      artigo: 'Art. 377 caput',
      motivo: 'Doações não enquadradas nos incisos I e II são INDEDUTÍVEIS'
    },
    totalDedutivel: Math.round(totalDedutivel * 100) / 100,
    totalIndedutivel: Math.round(totalIndedutivel * 100) / 100,
    ajusteLalur: totalIndedutivel > 0
      ? { tipo: 'ADICAO', valor: Math.round(totalIndedutivel * 100) / 100 }
      : null,
    economia: {
      irpj: totalDedutivel * 0.25,
      csll: totalDedutivel * 0.09,
      total: totalDedutivel * 0.34
    }
  };
}

/**
 * Calcula limite de previdência complementar dedutível (Art. 373).
 *
 * @param {number} totalFolha - Total de salários dos empregados + remuneração dos dirigentes vinculados ao plano
 * @param {number} contribuicaoPrevidencia - Contribuição ao plano de previdência complementar
 * @param {number} [contribuicaoFAPI=0] - Contribuição ao FAPI (Art. 375)
 * @returns {Object} Análise do limite
 *
 * Base Legal: Art. 373 e 375 do RIR/2018
 */
function calcularLimitePrevidenciaComplementar(totalFolha, contribuicaoPrevidencia, contribuicaoFAPI = 0) {
  const limite = totalFolha * DESPESAS_CONDICIONAIS.previdenciaComplementar.limite;
  const totalContribuicoes = contribuicaoPrevidencia + contribuicaoFAPI;
  const dedutivel = Math.min(totalContribuicoes, limite);
  const excesso = Math.max(0, totalContribuicoes - limite);

  return {
    totalFolha,
    contribuicaoPrevidencia,
    contribuicaoFAPI,
    totalContribuicoes,
    limite: Math.round(limite * 100) / 100,
    dedutivel: Math.round(dedutivel * 100) / 100,
    excesso: Math.round(excesso * 100) / 100,
    artigos: 'Art. 373 §1º e Art. 375',
    ajusteLalur: excesso > 0
      ? { tipo: 'ADICAO', valor: Math.round(excesso * 100) / 100, descricao: 'Art. 373 §2º: Excesso adicionado ao lucro real' }
      : null,
    economia: {
      irpj: dedutivel * 0.25,
      csll: dedutivel * 0.09,
      total: dedutivel * 0.34
    }
  };
}

/**
 * Analisa o tratamento fiscal de ajuste a valor justo (Art. 388-396).
 *
 * @param {Object} dados
 * @param {string} dados.tipo - 'GANHO' ou 'PERDA'
 * @param {number} dados.valor - Valor do ajuste
 * @param {boolean} dados.possuiSubconta - Se foi evidenciado em subconta vinculada
 * @param {string} [dados.contexto='NORMAL'] - 'NORMAL', 'INCORPORACAO', 'SUBSCRICAO_CAPITAL', 'PRESUMIDO_PARA_REAL'
 * @param {boolean} [dados.ativoRealizado=false] - Se o ativo já foi realizado
 * @param {boolean} [dados.valorIndedutivel=false] - Se o valor realizado é indedutível
 * @returns {Object} Tratamento fiscal
 *
 * Base Legal: Art. 388-396 do RIR/2018
 */
function analisarValorJusto(dados) {
  const {
    tipo,
    valor = 0,
    possuiSubconta = false,
    contexto = 'NORMAL',
    ativoRealizado = false,
    valorIndedutivel = false
  } = dados;

  if (!tipo || valor <= 0) {
    return { erro: 'Informe tipo (GANHO/PERDA) e valor positivo' };
  }

  const resultado = {
    tipo,
    valor,
    possuiSubconta,
    contexto,
    computarNoLucroReal: false,
    momentoTributacao: null,
    artigo: null,
    ajusteLalur: null,
    alertas: []
  };

  if (tipo === 'GANHO') {
    resultado.artigo = contexto === 'SUBSCRICAO_CAPITAL' ? 'Art. 393' : 'Art. 388';

    if (!possuiSubconta) {
      // Sem subconta = tributar imediatamente
      resultado.computarNoLucroReal = true;
      resultado.momentoTributacao = 'IMEDIATO';
      resultado.ajusteLalur = { tipo: 'ADICAO', valor };
      resultado.alertas.push(
        tipo === 'GANHO'
          ? 'Art. 388 §3º: Sem subconta, ganho TRIBUTADO. Não pode reduzir prejuízo fiscal do período (Art. 388 §4º).'
          : 'Art. 389 §2º: Sem subconta, perda INDEDUTÍVEL.'
      );
    } else if (ativoRealizado) {
      if (valorIndedutivel) {
        resultado.computarNoLucroReal = false;
        resultado.momentoTributacao = 'NAO_TRIBUTADO';
        resultado.alertas.push('Art. 388 §2º: Valor realizado é indedutível, ganho não computado.');
      } else {
        resultado.computarNoLucroReal = true;
        resultado.momentoTributacao = 'NA_REALIZACAO';
        resultado.ajusteLalur = { tipo: 'ADICAO', valor };
      }
    } else {
      resultado.computarNoLucroReal = false;
      resultado.momentoTributacao = 'DIFERIDO';
      resultado.alertas.push('Ganho diferido. Computar quando o ativo for realizado ou passivo liquidado.');
    }
  } else {
    // PERDA
    resultado.artigo = contexto === 'SUBSCRICAO_CAPITAL' ? 'Art. 394' : 'Art. 389';

    if (!possuiSubconta) {
      resultado.computarNoLucroReal = false;
      resultado.momentoTributacao = 'INDEDUTIVEL';
      resultado.ajusteLalur = { tipo: 'ADICAO', valor, descricao: 'Perda sem subconta — indedutível, adicionar ao lucro real' };
    } else if (ativoRealizado) {
      if (valorIndedutivel) {
        resultado.computarNoLucroReal = false;
        resultado.momentoTributacao = 'INDEDUTIVEL';
        resultado.alertas.push('Art. 389 §1º: Valor realizado indedutível, perda não computada.');
      } else {
        resultado.computarNoLucroReal = true;
        resultado.momentoTributacao = 'NA_REALIZACAO';
        resultado.ajusteLalur = { tipo: 'EXCLUSAO', valor };
      }
    } else {
      resultado.computarNoLucroReal = false;
      resultado.momentoTributacao = 'DIFERIDO';
      resultado.alertas.push('Perda diferida. Computar quando o ativo for realizado ou passivo liquidado.');
      resultado.ajusteLalur = { tipo: 'ADICAO', valor, descricao: 'Adicionar perda contábil ao lucro real (reversão quando realizado)' };
    }
  }

  // Contextos especiais
  if (contexto === 'INCORPORACAO') {
    resultado.alertas.push('Art. 392: Na incorporação/fusão/cisão, ganhos de VJ da sucedida NÃO integram custo na sucessora.');
  }

  if (contexto === 'PRESUMIDO_PARA_REAL') {
    resultado.alertas.push('Art. 396: Na transição presumido→real, incluir ganhos de VJ na base do presumido. Pode diferir com subcontas.');
  }

  return resultado;
}

/**
 * Simula o impacto da escolha entre regime de caixa e competência para variação cambial (Art. 407).
 *
 * @param {Array<Object>} operacoes - Lista de operações com exposição cambial
 * @param {number} operacoes[].valorOriginal - Valor original da operação em moeda estrangeira (convertido em R$ na data)
 * @param {number} operacoes[].valorAtual - Valor convertido pela taxa de câmbio atual
 * @param {boolean} operacoes[].liquidada - Se a operação foi liquidada no período
 * @param {number} [operacoes[].valorLiquidacao] - Valor na data de liquidação (se liquidada)
 * @param {string} [operacoes[].tipo='ATIVO'] - 'ATIVO' (direito de crédito) ou 'PASSIVO' (obrigação)
 * @param {string} [operacoes[].descricao] - Descrição da operação
 * @returns {Object} Comparação entre regime de caixa e competência
 *
 * Base Legal: Art. 407 do RIR/2018 (MP 2.158-35/2001, art. 30)
 */
function simularRegimeCambial(operacoes) {
  if (!operacoes || !Array.isArray(operacoes) || operacoes.length === 0) {
    return { erro: 'Informe ao menos uma operação' };
  }

  let variacaoCaixa = 0;
  let variacaoCompetencia = 0;
  const detalhesCaixa = [];
  const detalhesCompetencia = [];

  operacoes.forEach((op, idx) => {
    const {
      valorOriginal = 0,
      valorAtual = 0,
      liquidada = false,
      valorLiquidacao = 0,
      tipo = 'ATIVO',
      descricao = `Operação #${idx + 1}`
    } = op;

    // Variação cambial
    let variacaoTotal;
    if (liquidada) {
      variacaoTotal = tipo === 'ATIVO'
        ? valorLiquidacao - valorOriginal
        : valorOriginal - valorLiquidacao;
    } else {
      variacaoTotal = tipo === 'ATIVO'
        ? valorAtual - valorOriginal
        : valorOriginal - valorAtual;
    }

    // Regime CAIXA: reconhece apenas operações liquidadas
    if (liquidada) {
      variacaoCaixa += variacaoTotal;
      detalhesCaixa.push({ descricao, variacao: variacaoTotal, reconhecida: true });
    } else {
      detalhesCaixa.push({ descricao, variacao: variacaoTotal, reconhecida: false, motivo: 'Operação não liquidada' });
    }

    // Regime COMPETÊNCIA: reconhece todas as variações
    variacaoCompetencia += variacaoTotal;
    detalhesCompetencia.push({ descricao, variacao: variacaoTotal, reconhecida: true });
  });

  variacaoCaixa = Math.round(variacaoCaixa * 100) / 100;
  variacaoCompetencia = Math.round(variacaoCompetencia * 100) / 100;

  // Calcular impacto tributário de cada regime
  const tributoCaixa = variacaoCaixa > 0 ? variacaoCaixa * 0.34 : variacaoCaixa * 0.34;
  const tributoCompetencia = variacaoCompetencia > 0 ? variacaoCompetencia * 0.34 : variacaoCompetencia * 0.34;

  const melhorRegime = tributoCaixa <= tributoCompetencia ? 'CAIXA' : 'COMPETENCIA';
  const economiaEscolha = Math.abs(tributoCaixa - tributoCompetencia);

  return {
    regimeCaixa: {
      artigo: 'Art. 407 caput',
      variacaoReconhecida: variacaoCaixa,
      impostoEstimado: Math.round(tributoCaixa * 100) / 100,
      detalhes: detalhesCaixa,
      descricao: 'Reconhece variações apenas na liquidação da operação'
    },
    regimeCompetencia: {
      artigo: 'Art. 407 §1º',
      variacaoReconhecida: variacaoCompetencia,
      impostoEstimado: Math.round(tributoCompetencia * 100) / 100,
      detalhes: detalhesCompetencia,
      descricao: 'Reconhece todas as variações no período de apuração'
    },
    comparacao: {
      melhorRegime,
      economiaEscolha: Math.round(economiaEscolha * 100) / 100,
      descricao: `Regime ${melhorRegime} é mais vantajoso em R$ ${economiaEscolha.toFixed(2)}`
    },
    regras: {
      opcao: 'Art. 407 §4º I: Opção em janeiro, vale todo o ano-calendário',
      mudanca: 'Art. 407 §4º II: Só em caso de elevada oscilação cambial',
      comunicacao: 'Art. 407 §6º: Comunicar à RFB em janeiro ou no mês posterior à mudança'
    },
    totalOperacoes: operacoes.length,
    operacoesLiquidadas: operacoes.filter(o => o.liquidada).length
  };
}

/**
 * Calcula a amortização do goodwill em incorporação/fusão/cisão (Art. 433).
 *
 * @param {Object} dados
 * @param {number} dados.saldoGoodwill - Saldo do goodwill na data da aquisição
 * @param {string} dados.dataEvento - Data da incorporação/fusão/cisão
 * @param {string} dados.dataReferencia - Data do período de apuração atual
 * @param {boolean} [dados.partesIndependentes=true] - Se a aquisição foi entre partes NÃO dependentes
 * @param {boolean} [dados.laudoTempestivo=true] - Se o laudo foi protocolado/registrado tempestivamente
 * @param {number} [dados.exclusaoAcumulada=0] - Exclusões já realizadas
 * @returns {Object} Cálculo da exclusão do goodwill
 *
 * Base Legal: Art. 433 do RIR/2018 (Lei 12.973/14, art. 22)
 */
function calcularAmortizacaoGoodwill(dados) {
  const {
    saldoGoodwill = 0,
    dataEvento,
    dataReferencia,
    partesIndependentes = true,
    laudoTempestivo = true,
    exclusaoAcumulada = 0
  } = dados;

  if (saldoGoodwill <= 0) {
    return { erro: 'Saldo do goodwill deve ser positivo' };
  }

  // Verificar condições
  if (!partesIndependentes) {
    return {
      saldoGoodwill,
      exclusaoPeriodo: 0,
      dedutivel: false,
      artigo: 'Art. 433 / Art. 435',
      motivo: 'Aquisição entre PARTES DEPENDENTES — goodwill NÃO dedutível'
    };
  }

  if (!laudoTempestivo) {
    return {
      saldoGoodwill,
      exclusaoPeriodo: 0,
      dedutivel: false,
      artigo: 'Art. 433 §1º I',
      motivo: 'Laudo NÃO protocolado/registrado tempestivamente — goodwill NÃO dedutível'
    };
  }

  // Art. 433: 1/60 por mês (máximo)
  const quotaMensal = saldoGoodwill / 60;

  // Calcular meses no período
  const dtEvento = new Date(dataEvento);
  const dtRef = new Date(dataReferencia);
  const mesesTotais = _calcularMesesEntre(dtEvento, dtRef);
  const mesesNoPeriodo = Math.min(12, Math.max(0, mesesTotais));

  const saldoRemanescente = Math.max(0, saldoGoodwill - exclusaoAcumulada);
  let exclusaoPeriodo = quotaMensal * mesesNoPeriodo;
  exclusaoPeriodo = Math.min(exclusaoPeriodo, saldoRemanescente);

  const novaExclusaoAcumulada = exclusaoAcumulada + exclusaoPeriodo;
  const mesesRestantes = Math.max(0, 60 - Math.round(novaExclusaoAcumulada / quotaMensal));

  return {
    saldoGoodwill,
    quotaMensal: Math.round(quotaMensal * 100) / 100,
    mesesNoPeriodo,
    exclusaoPeriodo: Math.round(exclusaoPeriodo * 100) / 100,
    exclusaoAcumulada: Math.round(novaExclusaoAcumulada * 100) / 100,
    saldoRemanescente: Math.round(Math.max(0, saldoGoodwill - novaExclusaoAcumulada) * 100) / 100,
    mesesRestantes,
    dedutivel: true,
    artigo: 'Art. 433',
    ajusteLalur: {
      tipo: 'EXCLUSAO',
      valor: Math.round(exclusaoPeriodo * 100) / 100,
      descricao: 'Exclusão do lucro líquido — amortização do goodwill (1/60 p/mês máx.)'
    },
    economia: {
      irpj: exclusaoPeriodo * 0.25,
      csll: exclusaoPeriodo * 0.09,
      total: exclusaoPeriodo * 0.34
    }
  };
}

/**
 * Analisa o tratamento de participações societárias e dividendos (Art. 415-418).
 *
 * @param {Object} dados
 * @param {number} [dados.dividendosRecebidos=0] - Dividendos recebidos de PJ no País
 * @param {number} [dados.resultadoMEP=0] - Resultado da equivalência patrimonial (positivo ou negativo)
 * @param {number} [dados.ganhoVendaParticipacao=0] - Ganho na venda de participação societária
 * @param {number} [dados.prejuizoVendaParticipacao=0] - Prejuízo na venda de participação
 * @param {boolean} [dados.dividendosPos1996=true] - Se dividendos calculados a partir de jan/1996
 * @param {boolean} [dados.participacaoAdquiridaHaMenos6Meses=false] - Se adquirida < 6 meses antes
 * @returns {Object} Ajustes no LALUR
 *
 * Base Legal: Art. 415-418, 426 do RIR/2018
 */
function analisarParticipacoesSOcietarias(dados) {
  const {
    dividendosRecebidos = 0,
    resultadoMEP = 0,
    ganhoVendaParticipacao = 0,
    prejuizoVendaParticipacao = 0,
    dividendosPos1996 = true,
    participacaoAdquiridaHaMenos6Meses = false
  } = dados;

  const ajustes = {
    exclusoes: [],
    adicoes: [],
    totalExclusoes: 0,
    totalAdicoes: 0,
    observacoes: []
  };

  // 1. Dividendos recebidos (Art. 415, 418)
  if (dividendosRecebidos > 0) {
    if (dividendosPos1996) {
      if (participacaoAdquiridaHaMenos6Meses) {
        // Art. 416: Redução do custo de aquisição, sem efeito no resultado
        ajustes.observacoes.push(
          `Art. 416: Dividendos de R$ ${dividendosRecebidos.toFixed(2)} recebidos de participação adquirida < 6 meses — registrar como redução do custo de aquisição (sem efeito no resultado).`
        );
      } else {
        // Art. 418: Não integram base de cálculo do IRPJ
        ajustes.exclusoes.push({
          descricao: 'Dividendos recebidos de PJ no País (pós jan/1996)',
          valor: dividendosRecebidos,
          artigo: 'Art. 418 c/c Art. 415 §1º'
        });
        ajustes.totalExclusoes += dividendosRecebidos;
      }
    } else {
      ajustes.observacoes.push('Dividendos de resultados anteriores a jan/1996 podem ter tratamento diverso.');
    }
  }

  // 2. Resultado da equivalência patrimonial (Art. 426)
  if (resultadoMEP !== 0) {
    if (resultadoMEP > 0) {
      // MEP positivo: excluir (já foi registrado como receita contábil, mas não é tributável)
      ajustes.exclusoes.push({
        descricao: 'Resultado positivo de equivalência patrimonial',
        valor: resultadoMEP,
        artigo: 'Art. 426'
      });
      ajustes.totalExclusoes += resultadoMEP;
    } else {
      // MEP negativo: adicionar (foi registrado como despesa contábil, mas não é dedutível)
      const valorAbsoluto = Math.abs(resultadoMEP);
      ajustes.adicoes.push({
        descricao: 'Resultado negativo de equivalência patrimonial',
        valor: valorAbsoluto,
        artigo: 'Art. 426'
      });
      ajustes.totalAdicoes += valorAbsoluto;
    }
  }

  // 3. Ações/quotas bonificadas (Art. 417)
  ajustes.observacoes.push('Art. 417: Ações/quotas bonificadas recebidas sem custo — não alteram valor do investimento nem lucro real.');

  return {
    dividendosRecebidos,
    resultadoMEP,
    ajustes: {
      exclusoes: ajustes.exclusoes,
      adicoes: ajustes.adicoes,
      totalExclusoes: Math.round(ajustes.totalExclusoes * 100) / 100,
      totalAdicoes: Math.round(ajustes.totalAdicoes * 100) / 100,
      efeitoLiquidoLalur: Math.round((ajustes.totalAdicoes - ajustes.totalExclusoes) * 100) / 100
    },
    observacoes: ajustes.observacoes,
    baseLegal: 'Art. 415-418, 426 do RIR/2018'
  };
}

/**
 * Analisa o tratamento do leasing/arrendamento mercantil (Art. 366-367).
 *
 * @param {Object} dados
 * @param {number} dados.contraprestacoesAnuais - Total de contraprestações pagas no período
 * @param {number} [dados.despesasFinanceirasLeasing=0] - Despesas financeiras do contrato
 * @param {number} [dados.depreciacaoBemLeasing=0] - Depreciação contabilizada pela arrendatária
 * @param {number} [dados.avpLeasing=0] - Ajuste a valor presente das obrigações de leasing
 * @param {boolean} [dados.bemRelacionadoProducao=true] - Se o bem é relacionado à produção
 * @param {boolean} [dados.contratoRegular=true] - Se o contrato atende Lei 6.099/74
 * @returns {Object} Análise fiscal do leasing
 *
 * Base Legal: Art. 366-367 do RIR/2018
 */
function analisarLeasing(dados) {
  const {
    contraprestacoesAnuais = 0,
    despesasFinanceirasLeasing = 0,
    depreciacaoBemLeasing = 0,
    avpLeasing = 0,
    bemRelacionadoProducao = true,
    contratoRegular = true
  } = dados;

  const resultado = {
    contraprestacoes: {
      valor: contraprestacoesAnuais,
      dedutivel: bemRelacionadoProducao && contratoRegular,
      artigo: 'Art. 366'
    },
    despesasFinanceiras: {
      valor: despesasFinanceirasLeasing,
      dedutivel: false,
      artigo: 'Art. 366 §1º',
      ajuste: despesasFinanceirasLeasing > 0 ? 'ADICAO ao lucro real' : null
    },
    depreciacaoArrendataria: {
      valor: depreciacaoBemLeasing,
      dedutivel: false,
      artigo: 'Art. 366 §3º',
      ajuste: depreciacaoBemLeasing > 0 ? 'ADICAO ao lucro real' : null
    },
    avp: {
      valor: avpLeasing,
      dedutivel: false,
      artigo: 'Art. 366 §2º',
      ajuste: avpLeasing > 0 ? 'ADICAO ao lucro real' : null
    },
    totalDedutivel: bemRelacionadoProducao && contratoRegular ? contraprestacoesAnuais : 0,
    totalAdicaoLalur: despesasFinanceirasLeasing + depreciacaoBemLeasing + avpLeasing
      + ((!bemRelacionadoProducao || !contratoRegular) ? contraprestacoesAnuais : 0),
    alertas: []
  };

  if (!bemRelacionadoProducao) {
    resultado.alertas.push('Art. 366: Bem não relacionado à produção — contraprestações INDEDUTÍVEIS.');
  }

  if (!contratoRegular) {
    resultado.alertas.push('Art. 367: Contrato irregular = compra e venda a prestação. Contraprestações deduzidas anteriormente devem ser ADICIONADAS ao lucro real com juros e multa.');
  }

  resultado.economia = {
    irpj: resultado.totalDedutivel * 0.25,
    csll: resultado.totalDedutivel * 0.09,
    total: resultado.totalDedutivel * 0.34
  };

  return resultado;
}

/**
 * Calcula a tributação de lucros de controladas/coligadas no exterior (Art. 446-451).
 *
 * @param {Object} dados
 * @param {Array<Object>} dados.investidas - Lista de investidas no exterior
 * @param {string} investidas[].nome - Nome da investida
 * @param {number} investidas[].lucroAntes IR - Lucro antes do IR no país de origem
 * @param {number} investidas[].participacao - % de participação (decimal)
 * @param {number} [investidas[].irPagoExterior=0] - IR pago no exterior
 * @param {number} [investidas[].prejuizoAcumulado=0] - Prejuízo acumulado anterior
 * @param {boolean} [investidas[].controlada=true] - Se é controlada (vs coligada)
 * @param {number} investidas[].taxaCambio - Taxa de câmbio (R$/USD ou R$/moeda)
 * @param {boolean} [investidas[].paisTributacaoFavorecida=false] - Se está em paraíso fiscal
 * @param {number} [investidas[].rendaAtivaPercentual=1] - % de renda ativa própria
 * @param {boolean} [dados.optouConsolidacao=false] - Se optou pela consolidação (Art. 449)
 * @returns {Object} Cálculo da tributação no Brasil
 *
 * Base Legal: Art. 446-451 do RIR/2018
 */
function calcularLucrosExterior(dados) {
  const { investidas = [], optouConsolidacao = false } = dados;

  if (investidas.length === 0) {
    return { erro: 'Informe ao menos uma investida no exterior' };
  }

  const resultados = [];
  let totalAdicaoLucroReal = 0;
  let totalCreditoIRExterior = 0;
  const naoConsolidaveis = [];
  let resultadoConsolidado = 0;

  investidas.forEach((inv, idx) => {
    const {
      nome = `Investida #${idx + 1}`,
      lucroAntesIR = 0,
      participacao = 0,
      irPagoExterior = 0,
      prejuizoAcumulado = 0,
      controlada = true,
      taxaCambio = 1,
      paisTributacaoFavorecida = false,
      rendaAtivaPercentual = 1
    } = inv;

    // Parcela do lucro atribuída à controladora
    const parcela = lucroAntesIR * participacao;
    const parcelaReais = parcela * taxaCambio;

    // Compensação com prejuízo acumulado
    const prejuizoCompensavel = Math.min(prejuizoAcumulado, Math.max(0, parcelaReais));
    const baseAposCompensacao = Math.max(0, parcelaReais - prejuizoCompensavel);

    // Crédito de IR pago no exterior (limitado ao IR brasileiro correspondente)
    const irBrasilCorrespondente = baseAposCompensacao * 0.25;
    const creditoIR = Math.min(irPagoExterior * taxaCambio * participacao, irBrasilCorrespondente);

    // Verificar se pode consolidar
    const podeConsolidar = optouConsolidacao
      && !paisTributacaoFavorecida
      && rendaAtivaPercentual >= 0.80;

    const resultado = {
      nome,
      controlada,
      participacao,
      lucroAntesIR,
      taxaCambio,
      parcelaReais: Math.round(parcelaReais * 100) / 100,
      prejuizoCompensado: Math.round(prejuizoCompensavel * 100) / 100,
      baseAposCompensacao: Math.round(baseAposCompensacao * 100) / 100,
      creditoIRExterior: Math.round(creditoIR * 100) / 100,
      adicaoLucroReal: Math.round(baseAposCompensacao * 100) / 100,
      podeConsolidar,
      artigo: controlada ? 'Art. 448' : 'Art. 446 §5º'
    };

    if (!podeConsolidar && optouConsolidacao) {
      resultado.motivoNaoConsolida = [];
      if (paisTributacaoFavorecida) resultado.motivoNaoConsolida.push('País com tributação favorecida (Art. 449 II)');
      if (rendaAtivaPercentual < 0.80) resultado.motivoNaoConsolida.push(`Renda ativa ${(rendaAtivaPercentual * 100).toFixed(0)}% < 80% (Art. 449 IV)`);
      naoConsolidaveis.push(resultado);
    }

    if (podeConsolidar) {
      resultadoConsolidado += baseAposCompensacao;
    } else {
      totalAdicaoLucroReal += baseAposCompensacao;
    }

    totalCreditoIRExterior += creditoIR;
    resultados.push(resultado);
  });

  // Se consolidação, adicionar o resultado líquido
  if (optouConsolidacao && resultadoConsolidado > 0) {
    totalAdicaoLucroReal += resultadoConsolidado;
  }
  // Resultado negativo da consolidação: só compensa com lucros futuros das mesmas PJs
  const prejuizoConsolidado = optouConsolidacao && resultadoConsolidado < 0 ? Math.abs(resultadoConsolidado) : 0;

  return {
    totalAdicaoLucroReal: Math.round(totalAdicaoLucroReal * 100) / 100,
    totalCreditoIRExterior: Math.round(totalCreditoIRExterior * 100) / 100,
    irpjDevido: Math.round(Math.max(0, totalAdicaoLucroReal * 0.25 - totalCreditoIRExterior) * 100) / 100,
    consolidacao: {
      optou: optouConsolidacao,
      resultadoConsolidado: Math.round(resultadoConsolidado * 100) / 100,
      prejuizoConsolidado: Math.round(prejuizoConsolidado * 100) / 100,
      investidasExcluidas: naoConsolidaveis.length,
      artigo: 'Art. 449'
    },
    investidas: resultados,
    regras: {
      conversao: 'Art. 446 §1º: Taxa de câmbio para venda na data da contabilização',
      prejuizoNoPais: 'Art. 446 §7º: Prejuízos no exterior NÃO compensáveis com lucros no País',
      incentivos: 'Art. 446 §10: Sem incentivos fiscais sobre IR de lucros no exterior'
    },
    baseLegal: 'Art. 446-451 do RIR/2018'
  };
}

/**
 * Gera relatório consolidado de todos os ajustes cobertos pelo Bloco D2.
 *
 * @param {Object} dados - Objeto com resultados das funções acima
 * @returns {Object} Relatório com totais de adições e exclusões no LALUR
 */
function gerarRelatorioD2(dados) {
  const {
    royalties,
    doacoes,
    previdencia,
    valorJusto,
    cambial,
    goodwill,
    participacoes,
    leasing,
    exterior
  } = dados;

  let totalAdicoes = 0;
  let totalExclusoes = 0;
  const itens = [];

  const _add = (nome, obj) => {
    if (!obj) return;
    if (obj.ajusteLalur) {
      if (obj.ajusteLalur.tipo === 'ADICAO') {
        totalAdicoes += obj.ajusteLalur.valor || 0;
        itens.push({ tipo: 'ADICAO', nome, valor: obj.ajusteLalur.valor });
      } else if (obj.ajusteLalur.tipo === 'EXCLUSAO') {
        totalExclusoes += obj.ajusteLalur.valor || 0;
        itens.push({ tipo: 'EXCLUSAO', nome, valor: obj.ajusteLalur.valor });
      }
    }
    if (obj.ajustes) {
      totalAdicoes += obj.ajustes.totalAdicoes || 0;
      totalExclusoes += obj.ajustes.totalExclusoes || 0;
      if (obj.ajustes.totalAdicoes) itens.push({ tipo: 'ADICAO', nome, valor: obj.ajustes.totalAdicoes });
      if (obj.ajustes.totalExclusoes) itens.push({ tipo: 'EXCLUSAO', nome, valor: obj.ajustes.totalExclusoes });
    }
    if (obj.totalAdicaoLalur) {
      totalAdicoes += obj.totalAdicaoLalur;
      itens.push({ tipo: 'ADICAO', nome, valor: obj.totalAdicaoLalur });
    }
  };

  _add('Royalties e Assistência Técnica', royalties);
  _add('Doações', doacoes);
  _add('Previdência Complementar', previdencia);
  _add('Valor Justo', valorJusto);
  _add('Goodwill', goodwill);
  _add('Participações Societárias e MEP', participacoes);
  _add('Leasing', leasing);
  _add('Lucros no Exterior', exterior);

  return {
    totalAdicoes: Math.round(totalAdicoes * 100) / 100,
    totalExclusoes: Math.round(totalExclusoes * 100) / 100,
    efeitoLiquido: Math.round((totalAdicoes - totalExclusoes) * 100) / 100,
    impactoTributario: {
      irpjAdicional: Math.round(totalAdicoes * 0.25 * 100) / 100,
      csllAdicional: Math.round(totalAdicoes * 0.09 * 100) / 100,
      economiaExclusoes: Math.round(totalExclusoes * 0.34 * 100) / 100
    },
    itens,
    baseLegal: 'Art. 361-451 do RIR/2018'
  };
}

/**
 * @private
 */

// ============================================================================
// EXPORTS
// ============================================================================


// ============================================================================
// EXEMPLOS DE USO
// ============================================================================


// ============================================================================
// CONSTANTES
// ============================================================================

/**
 * Área de atuação da SUDAM (Art. 630-633 do RIR/2018)
 * Lei Complementar 124/2007
 */
const AREA_SUDAM = {
  artigo: 'Art. 630-633',
  leiComplementar: 'LC 124/2007',
  estados: [
    'AC', 'AP', 'AM', 'MA', 'MT', 'PA', 'RO', 'RR', 'TO'
  ],
  descricao: 'Amazônia Legal: Estados do Acre, Amapá, Amazonas, Maranhão, Mato Grosso, Pará, Rondônia, Roraima e Tocantins',
  municipiosRelevantes: {
    'PA': {
      nome: 'Pará',
      inclui: 'Todo o estado',
      exemplosCidades: ['Belém', 'Marabá', 'Santarém', 'Altamira', 'Itaituba', 'Paragominas']
    }
  },
  exemploMunicipio: {
    estado: 'PA',
    codigoIBGE: '1505031',
    areaAtuacao: 'SUDAM',
    elegivel: true,
    observacao: 'Municípios do Pará estão integralmente na área de atuação da SUDAM (Amazônia Legal)'
  }
};

/**
 * Área de atuação da SUDENE (Art. 627 do RIR/2018)
 * Lei Complementar 125/2007
 */
const AREA_SUDENE = {
  artigo: 'Art. 627',
  leiComplementar: 'LC 125/2007',
  estados: [
    'AL', 'BA', 'CE', 'MA', 'PB', 'PE', 'PI', 'RN', 'SE'
  ],
  parcial: {
    'MG': 'Municípios incluídos no Polígono das Secas e na área do antigo DNOCS (norte e nordeste de MG)',
    'ES': 'Municípios do norte do ES incluídos na área da extinta ADENE'
  }
};

/**
 * Setores prioritários para desenvolvimento regional — SUDAM
 * Decreto 4.212/2002 + atualizações
 */
const SETORES_PRIORITARIOS_SUDAM = {
  decreto: 'Decreto 4.212/2002',
  setores: [
    {
      id: 'AGROIND',
      descricao: 'Agroindústria',
      cnae: ['10', '11', '12'],
      exemplos: ['Beneficiamento de produtos agrícolas', 'Processamento de alimentos']
    },
    {
      id: 'BIOTECH',
      descricao: 'Biotecnologia',
      cnae: ['21', '72'],
      exemplos: ['Pesquisa e desenvolvimento em biotecnologia']
    },
    {
      id: 'CULTURA',
      descricao: 'Cultura',
      cnae: ['90', '91'],
      exemplos: ['Atividades artísticas e culturais']
    },
    {
      id: 'ELETROELETRO',
      descricao: 'Eletroeletrônica',
      cnae: ['26', '27'],
      exemplos: ['Fabricação de equipamentos eletrônicos']
    },
    {
      id: 'FLORESTAL',
      descricao: 'Florestal',
      cnae: ['02', '16'],
      exemplos: ['Manejo florestal sustentável', 'Reflorestamento']
    },
    {
      id: 'INFRA',
      descricao: 'Infraestrutura',
      cnae: ['42', '43'],
      exemplos: ['Construção de obras de infraestrutura']
    },
    {
      id: 'METAL',
      descricao: 'Metalurgia e Metal-Mecânica',
      cnae: ['24', '25', '28', '29'],
      exemplos: ['Siderurgia', 'Fabricação de máquinas']
    },
    {
      id: 'MINERAL',
      descricao: 'Mineral',
      cnae: ['07', '08', '23'],
      exemplos: ['Mineração', 'Beneficiamento de minerais']
    },
    {
      id: 'PESCA',
      descricao: 'Pesca e Aquicultura',
      cnae: ['03'],
      exemplos: ['Piscicultura', 'Aquicultura']
    },
    {
      id: 'QUIMICA',
      descricao: 'Química',
      cnae: ['20'],
      exemplos: ['Fabricação de produtos químicos']
    },
    {
      id: 'SERVICOS_TEC',
      descricao: 'Serviços de tecnologia e técnicos especializados',
      cnae: ['62', '63', '71', '72', '74'],
      exemplos: [
        'Tecnologia da informação',
        'Serviços de engenharia e arquitetura',
        'Geotecnologia e geoprocessamento',
        'Consultoria técnica ambiental',
        'Pesquisa e desenvolvimento'
      ],
      observacao: 'Geotecnologia, CAR, PRA, LAR, georeferenciamento = serviços técnicos especializados'
    },
    {
      id: 'TEXTIL',
      descricao: 'Têxtil, Confecção e Calçados',
      cnae: ['13', '14', '15'],
      exemplos: ['Fabricação de tecidos', 'Confecção']
    },
    {
      id: 'TURISMO',
      descricao: 'Turismo',
      cnae: ['55', '79'],
      exemplos: ['Hospedagem', 'Agenciamento de turismo']
    },
    {
      id: 'DIGITAL',
      descricao: 'Fabricação de equipamentos para inclusão digital',
      cnae: ['26.2'],
      isencaoTotal: true,
      artigo: 'Art. 634 §2º / Art. 628 §2º',
      exemplos: ['Fabricação de máquinas e equipamentos baseados em tecnologia digital']
    }
  ]
};

/**
 * Parâmetros do incentivo de redução de 75% do IRPJ (Art. 628/634)
 */
const INCENTIVO_REDUCAO_75 = {
  artigo: 'Art. 634 (SUDAM) / Art. 628 (SUDENE)',
  baseLegal: 'MP 2.199-14/2001, art. 1º (redação Lei 13.799/2019)',
  percentualReducao: 0.75, // 75%
  prazo: 10, // 10 anos de fruição
  projetoAprovadoAte: '2023-12-31', // MP 2.199-14, art. 1º
  prorrogacao: {
    lei: 'Lei 13.799/2019',
    novoLimite: '2023-12-31',
    observacao: 'Projetos protocolizados e aprovados até 31/12/2023'
  },
  tiposProjeto: [
    { id: 'INSTALACAO', descricao: 'Instalação de novo empreendimento' },
    { id: 'AMPLIACAO', descricao: 'Ampliação de empreendimento existente' },
    { id: 'MODERNIZACAO', descricao: 'Modernização total ou parcial' },
    { id: 'DIVERSIFICACAO', descricao: 'Diversificação da linha de produção/serviços' }
  ],
  requisitos: [
    'Lucro Real obrigatório (não aplicável a Simples Nacional ou Lucro Presumido)',
    'Projeto protocolizado e aprovado pela SUDAM/SUDENE até 31/12/2023',
    'Laudo Constitutivo emitido pela SUDAM/SUDENE',
    'Reconhecimento pela SRF (Art. 637)',
    'Unidade produtora em operação na área de atuação',
    'Atividade em setor considerado prioritário (Decreto 4.212/2002)',
    'Regularidade fiscal (CND/CPEN federal)',
    'Regularidade FGTS',
    'Produção efetiva > 20% da capacidade instalada (para admissibilidade)'
  ],
  reservaIncentivo: {
    artigo: 'Art. 523 / Art. 195-A da Lei 6.404/76',
    obrigacoes: [
      'Registrar em Reserva de Incentivos Fiscais (subconta da Reserva de Lucros)',
      'Uso permitido APENAS para: (I) absorção de prejuízos; (II) aumento de capital social',
      'VEDADA distribuição como dividendos (sob pena de perda do benefício + recolhimento do IR)',
      'Comunicar à SUDAM/SUDENE em caso de absorção de prejuízos (até 31/12 do exercício seguinte)',
      'Comunicar à SUDAM/SUDENE em caso de aumento de capital (até 60 dias)'
    ]
  }
};

/**
 * Parâmetros do reinvestimento de 30% do IRPJ (Art. 638-651)
 */
const REINVESTIMENTO_30 = {
  artigo: 'Art. 638-651',
  baseLegal: 'Lei 5.508/68, art. 23 + MP 2.199-14/2001, art. 3º + Lei 13.799/2019',
  percentual: 0.30, // 30% do IRPJ sobre lucro da exploração
  prazo: 'Até 31/12/2023',
  bancoDeposito: {
    SUDAM: 'Banco da Amazônia (BASA)',
    SUDENE: 'Banco do Nordeste do Brasil (BNB)'
  },
  capitalGiro: {
    percentualPermitido: 0.50, // 50% do valor reinvestido pode ser usado como capital de giro
    lei: 'Lei 13.799/2019',
    descricao: 'Metade do valor a ser reinvestido poderá ser utilizada como capital de giro'
  },
  destinacao: [
    'Modernização de equipamentos',
    'Complementação de equipamentos',
    'Custos de montagem e instalação',
    'Capital de giro (até 50% do valor — Lei 13.799/2019)'
  ],
  recursosPropriosComplementares: 0.50, // 50% de recursos próprios
  depositoPrazo: 'Nas mesmas datas de pagamento do IRPJ',
  remuneracao: 'Taxa Extramercado do Banco Central (enquanto não aplicado)',
  aprovacao: 'Liberação condicionada à aprovação do projeto pela SUDAM/SUDENE'
};

/**
 * Exclusões para cálculo do Lucro da Exploração (Art. 618-626)
 * IN SRF 267/2002, art. 2º
 */
const EXCLUSOES_LUCRO_EXPLORACAO = {
  artigo: 'Art. 618-626 / IN SRF 267/2002',
  excluirDoLucroLiquido: [
    {
      id: 'REC_FIN_LIQUIDA',
      descricao: 'Receitas financeiras líquidas (receitas financeiras – despesas financeiras, se positivo)',
      artigo: 'Art. 618 I / IN 267 art. 2º I',
      tipo: 'EXCLUSAO'
    },
    {
      id: 'RESULT_PARTIC_SOC',
      descricao: 'Resultados positivos de participações societárias (MEP, dividendos)',
      artigo: 'Art. 618 II / IN 267 art. 2º II',
      tipo: 'EXCLUSAO'
    },
    {
      id: 'RESULT_NAO_OPERAC',
      descricao: 'Resultados não operacionais (ganhos/perdas de capital, alienação de ativo não circulante)',
      artigo: 'Art. 618 III / IN 267 art. 2º III',
      tipo: 'EXCLUSAO'
    },
    {
      id: 'RECEITAS_ANTERIOR',
      descricao: 'Receitas de exercícios anteriores',
      artigo: 'Art. 618 IV / IN 267 art. 2º IV',
      tipo: 'EXCLUSAO'
    },
    {
      id: 'RESERVA_REAVALIACAO',
      descricao: 'Valores baixados de reserva de reavaliação (custo/despesa operacional com contrapartida em receita)',
      artigo: 'Art. 618 V / IN 267 art. 2º V',
      tipo: 'EXCLUSAO'
    },
    {
      id: 'SUBVENCOES',
      descricao: 'Subvenções para investimento registradas como receita',
      artigo: 'Art. 618 VI / IN 267 art. 2º VI',
      tipo: 'EXCLUSAO'
    },
    {
      id: 'LUCRO_INFLAC_PREOP',
      descricao: 'Parcela do lucro inflacionário de fase pré-operacional realizado',
      artigo: 'Art. 618 VII / IN 267 art. 2º VII',
      tipo: 'EXCLUSAO'
    },
    {
      id: 'TRIB_SUSPENSOS',
      descricao: 'Tributos com exigibilidade suspensa (art. 151 CTN, II a IV) — controlados na Parte B do LALUR',
      artigo: 'Art. 618 VIII / IN 267 art. 2º VIII',
      tipo: 'EXCLUSAO',
      observacao: 'Serão diminuídos do lucro da exploração quando efetivamente pagos'
    }
  ],
  adicionarAoLucroLiquido: [
    {
      id: 'CSLL_DEVIDA',
      descricao: 'CSLL devida no período de apuração',
      artigo: 'IN SRF 267/2002, art. 2º §1º',
      tipo: 'ADICAO',
      observacao: 'A CSLL é adicionada ao lucro líquido para fins de lucro da exploração'
    },
    {
      id: 'DESP_FIN_LIQUIDA',
      descricao: 'Despesas financeiras líquidas (se despesas financeiras > receitas financeiras)',
      artigo: 'IN SRF 267/2002, art. 2º §2º',
      tipo: 'ADICAO',
      observacao: 'Excesso de despesas financeiras sobre receitas financeiras é adicionado'
    },
    {
      id: 'PREJUIZO_PARTIC_SOC',
      descricao: 'Resultados negativos de participações societárias',
      artigo: 'IN SRF 267/2002, art. 2º §3º',
      tipo: 'ADICAO'
    }
  ],
  variacao_cambial: {
    artigo: 'IN SRF 267/2002, art. 2º §4º',
    regra: 'Variações monetárias de direitos e obrigações em função de câmbio são consideradas receitas/despesas financeiras para fins do lucro da exploração'
  }
};

/**
 * Depreciação acelerada incentivada — referência cruzada
 */
const DEPRECIACAO_ACELERADA_INCENTIVADA = {
  artigo: 'Art. 327-329 do RIR/2018 + IN SRF 267/2002, art. 6º',
  regra: 'Empresas com projeto SUDAM/SUDENE podem depreciar integralmente no ano de aquisição',
  metodo: 'Exclusão no LALUR — sem alterar contabilidade',
  tiposBens: [
    'Bens adquiridos para instalação ou expansão do empreendimento incentivado',
    'Máquinas, equipamentos, aparelhos, instrumentos'
  ],
  vedacao: 'Não se aplica a terrenos, edificações e bens que normalmente aumentam de valor com o tempo',
  observacao: 'Já tratada no bloco-d-despesas-dedutiveis.js — aqui calculamos impacto combinado com incentivo SUDAM'
};

// ============================================================================
// FUNÇÕES DE CÁLCULO
// ============================================================================

/**
 * Verifica elegibilidade da empresa para incentivos SUDAM/SUDENE.
 *
 * @param {Object} dados
 * @param {string} dados.uf - Sigla do estado (ex: 'PA')
 * @param {string} [dados.municipio] - Nome do município
 * @param {string} [dados.codigoIBGE] - Código IBGE do município
 * @param {string} dados.atividadePrincipal - Descrição da atividade principal
 * @param {string} [dados.cnaePrincipal] - CNAE principal (2 primeiros dígitos)
 * @param {string} dados.regimeTributario - 'LUCRO_REAL', 'SIMPLES', 'PRESUMIDO'
 * @param {boolean} [dados.projetoAprovado=false] - Se possui projeto aprovado pela SUDAM/SUDENE
 * @param {string} [dados.dataProtocolo] - Data do protocolo do projeto (YYYY-MM-DD)
 * @param {boolean} [dados.laudoConstitutivo=false] - Se possui laudo constitutivo
 * @param {boolean} [dados.reconhecimentoSRF=false] - Se possui reconhecimento pela SRF
 * @param {boolean} [dados.regularidadeFiscal=true] - Se está em dia com obrigações fiscais
 * @returns {Object} Análise de elegibilidade com alertas e recomendações
 *
 * Base Legal: Art. 627-637 do RIR/2018
 */
function verificarElegibilidade(dados) {
  const {
    uf,
    municipio = '',
    codigoIBGE = '',
    atividadePrincipal = '',
    cnaePrincipal = '',
    regimeTributario = 'SIMPLES',
    projetoAprovado = false,
    dataProtocolo = null,
    laudoConstitutivo = false,
    reconhecimentoSRF = false,
    regularidadeFiscal = true
  } = dados;

  const resultado = {
    elegivel: false,
    superintendencia: null,
    impedimentos: [],
    alertas: [],
    recomendacoes: [],
    setoresAplicaveis: [],
    incentivosDisponiveis: [],
    artigo: 'Art. 627-637'
  };

  // 1. Verificar localização
  const ufUpper = (uf || '').toUpperCase();
  const naAreaSUDAM = AREA_SUDAM.estados.includes(ufUpper);
  const naAreaSUDENE = AREA_SUDENE.estados.includes(ufUpper);
  const naAreaParciaisSUDENE = Object.keys(AREA_SUDENE.parcial).includes(ufUpper);

  if (naAreaSUDAM) {
    resultado.superintendencia = 'SUDAM';
    resultado.alertas.push(`${ufUpper} está na área de atuação da SUDAM (Amazônia Legal)`);
  } else if (naAreaSUDENE) {
    resultado.superintendencia = 'SUDENE';
    resultado.alertas.push(`${ufUpper} está na área de atuação da SUDENE`);
  } else if (naAreaParciaisSUDENE) {
    resultado.superintendencia = 'SUDENE_PARCIAL';
    resultado.alertas.push(`${ufUpper}: verificar se município está na área parcial da SUDENE — ${AREA_SUDENE.parcial[ufUpper]}`);
  } else {
    resultado.impedimentos.push({
      tipo: 'LOCALIZACAO',
      descricao: `${ufUpper} não está na área de atuação da SUDAM nem da SUDENE`,
      artigo: 'Art. 627/630'
    });
  }

  // 2. Verificar regime tributário
  if (regimeTributario !== 'LUCRO_REAL') {
    resultado.impedimentos.push({
      tipo: 'REGIME_TRIBUTARIO',
      descricao: `Regime atual (${regimeTributario}) não permite fruição dos incentivos. Obrigatório Lucro Real.`,
      artigo: 'MP 2.199-14/2001, art. 1º'
    });
    if (regimeTributario === 'SIMPLES') {
      resultado.recomendacoes.push(
        'MIGRAÇÃO NECESSÁRIA: Para usufruir dos incentivos SUDAM/SUDENE, a empresa deve migrar para o Lucro Real.'
      );
    }
  }

  // 3. Verificar setores prioritários
  const cnae2d = (cnaePrincipal || '').substring(0, 2);
  const atividadeLower = (atividadePrincipal || '').toLowerCase();

  SETORES_PRIORITARIOS_SUDAM.setores.forEach(setor => {
    const matchCNAE = setor.cnae.some(c => cnae2d.startsWith(c.substring(0, 2)));
    const matchDescricao = setor.exemplos.some(e => atividadeLower.includes(e.toLowerCase())) ||
      atividadeLower.includes(setor.descricao.toLowerCase());

    // Match específico para serviços técnicos especializados
    const matchGeo = atividadeLower.includes('geotecnologia') ||
      atividadeLower.includes('georeferenc') ||
      atividadeLower.includes('ambiental') ||
      atividadeLower.includes('consultoria técnica') ||
      atividadeLower.includes('geoprocess') ||
      atividadeLower.includes('car ') || atividadeLower.includes(' car') ||
      atividadeLower.includes('cadastro ambiental');

    if (matchCNAE || matchDescricao || (setor.id === 'SERVICOS_TEC' && matchGeo)) {
      resultado.setoresAplicaveis.push({
        setor: setor.id,
        descricao: setor.descricao,
        cnae: setor.cnae,
        isencao: setor.isencaoTotal || false
      });
    }
  });

  if (resultado.setoresAplicaveis.length === 0) {
    resultado.alertas.push(
      'Nenhum setor prioritário identificado automaticamente. Verificar enquadramento no Decreto 4.212/2002 (SUDAM) ou 4.213/2002 (SUDENE). Serviços técnicos especializados (CNAE 71/72/74) podem ser elegíveis.'
    );
  }

  // 4. Verificar projeto e laudo
  if (!projetoAprovado) {
    resultado.alertas.push(
      'Projeto ainda não protocolizado/aprovado. Prazo limite: 31/12/2023 (MP 2.199-14 c/ Lei 13.799/2019). Verificar possibilidade de prorrogação.'
    );
    resultado.recomendacoes.push(
      'AÇÃO URGENTE: Protocolar projeto junto à SUDAM para análise e emissão do Laudo Constitutivo.'
    );
  } else if (!laudoConstitutivo) {
    resultado.alertas.push('Projeto aprovado mas Laudo Constitutivo ainda não emitido pela SUDAM/SUDENE.');
    resultado.recomendacoes.push('Acompanhar emissão do Laudo Constitutivo junto à superintendência.');
  } else if (!reconhecimentoSRF) {
    resultado.alertas.push('Laudo emitido mas reconhecimento pela SRF ainda pendente (Art. 637).');
    resultado.recomendacoes.push(
      'Encaminhar requerimento à unidade da SRF jurisdicionante, instruído com Laudo Constitutivo original.'
    );
  }

  if (dataProtocolo) {
    const dataLimite = new Date('2023-12-31');
    const dataProt = new Date(dataProtocolo);
    if (dataProt > dataLimite) {
      resultado.impedimentos.push({
        tipo: 'PRAZO_PROTOCOLO',
        descricao: `Protocolo em ${dataProtocolo} é posterior ao prazo limite de 31/12/2023`,
        artigo: 'MP 2.199-14, art. 1º (Lei 13.799/2019)'
      });
    }
  }

  // 5. Regularidade fiscal
  if (!regularidadeFiscal) {
    resultado.impedimentos.push({
      tipo: 'REGULARIDADE_FISCAL',
      descricao: 'Empresa com pendências fiscais. Exigida regularidade FGTS + CND federal.',
      artigo: 'IN SRF 267/2002'
    });
  }

  // 6. Determinar elegibilidade
  resultado.elegivel = resultado.impedimentos.length === 0 && resultado.superintendencia != null;

  // 7. Montar incentivos disponíveis
  if (resultado.superintendencia && regimeTributario === 'LUCRO_REAL') {
    resultado.incentivosDisponiveis.push({
      tipo: 'REDUCAO_75',
      descricao: 'Redução de 75% do IRPJ sobre lucro da exploração',
      artigo: resultado.superintendencia === 'SUDAM' ? 'Art. 634' : 'Art. 628',
      prazo: '10 anos a partir do ano de início da fruição',
      requisito: 'Laudo Constitutivo + Reconhecimento SRF'
    });
    resultado.incentivosDisponiveis.push({
      tipo: 'REINVESTIMENTO_30',
      descricao: 'Depósito para reinvestimento de 30% do IRPJ sobre lucro da exploração',
      artigo: 'Art. 638-651',
      deposito: resultado.superintendencia === 'SUDAM' ? 'Banco da Amazônia (BASA)' : 'BNB',
      capitalGiro: '50% do valor pode ser usado como capital de giro (Lei 13.799/2019)'
    });
    resultado.incentivosDisponiveis.push({
      tipo: 'DEPRECIACAO_ACELERADA',
      descricao: 'Depreciação acelerada incentivada — dedução integral no ano de aquisição',
      artigo: 'Art. 327-329',
      requisito: 'Bens do projeto incentivado'
    });
  }

  return resultado;
}

/**
 * Calcula o Lucro da Exploração a partir do lucro líquido.
 * O lucro da exploração é a base para cálculo dos incentivos SUDAM/SUDENE.
 *
 * @param {Object} dados
 * @param {number} dados.lucroLiquido - Lucro líquido antes do IRPJ (após CSLL)
 * @param {number} [dados.receitasFinanceiras=0] - Receitas financeiras do período
 * @param {number} [dados.despesasFinanceiras=0] - Despesas financeiras do período
 * @param {number} [dados.resultadoParticipacoes=0] - Resultado de participações societárias (positivo=receita, negativo=despesa)
 * @param {number} [dados.ganhosCapitalAtivoNaoCirc=0] - Ganhos de capital em ativo não circulante
 * @param {number} [dados.perdasCapitalAtivoNaoCirc=0] - Perdas de capital em ativo não circulante
 * @param {number} [dados.receitasExerciciosAnteriores=0] - Receitas de exercícios anteriores
 * @param {number} [dados.subvencoesReceita=0] - Subvenções registradas como receita
 * @param {number} [dados.csllDevida=0] - CSLL devida no período (a ser adicionada)
 * @param {number} [dados.tributosSuspensos=0] - Tributos com exigibilidade suspensa (Art. 151 CTN)
 * @param {number} [dados.tributosSuspensosPagos=0] - Tributos suspensos efetivamente pagos no período
 * @param {number} [dados.variacaoCambialAtiva=0] - Variação cambial ativa (tratada como rec. financeira)
 * @param {number} [dados.variacaoCambialPassiva=0] - Variação cambial passiva (tratada como desp. financeira)
 * @returns {Object} Lucro da exploração calculado com detalhamento
 *
 * Base Legal: Art. 618-626 do RIR/2018, IN SRF 267/2002, art. 2º
 */
function calcularLucroExploracao(dados) {
  const {
    lucroLiquido = 0,
    receitasFinanceiras = 0,
    despesasFinanceiras = 0,
    resultadoParticipacoes = 0,
    ganhosCapitalAtivoNaoCirc = 0,
    perdasCapitalAtivoNaoCirc = 0,
    receitasExerciciosAnteriores = 0,
    subvencoesReceita = 0,
    csllDevida = 0,
    tributosSuspensos = 0,
    tributosSuspensosPagos = 0,
    variacaoCambialAtiva = 0,
    variacaoCambialPassiva = 0
  } = dados;

  // Receitas e despesas financeiras incluem variações cambiais
  const recFinTotal = receitasFinanceiras + variacaoCambialAtiva;
  const despFinTotal = despesasFinanceiras + variacaoCambialPassiva;

  // Resultado financeiro líquido
  const resultadoFinanceiroLiquido = recFinTotal - despFinTotal;

  // Resultado não operacional (ganhos - perdas de capital)
  const resultadoNaoOperacional = ganhosCapitalAtivoNaoCirc - perdasCapitalAtivoNaoCirc;

  // === EXCLUSÕES ===
  let totalExclusoes = 0;
  const detalhamentoExclusoes = [];

  // I - Receitas financeiras líquidas (se positivo)
  if (resultadoFinanceiroLiquido > 0) {
    totalExclusoes += resultadoFinanceiroLiquido;
    detalhamentoExclusoes.push({
      id: 'REC_FIN_LIQUIDA',
      valor: resultadoFinanceiroLiquido,
      descricao: `Receitas financeiras líquidas (${recFinTotal.toFixed(2)} - ${despFinTotal.toFixed(2)})`,
      artigo: 'Art. 618 I'
    });
  }

  // II - Resultados positivos de participações societárias
  if (resultadoParticipacoes > 0) {
    totalExclusoes += resultadoParticipacoes;
    detalhamentoExclusoes.push({
      id: 'RESULT_PARTIC_SOC',
      valor: resultadoParticipacoes,
      descricao: 'Resultados positivos de participações societárias',
      artigo: 'Art. 618 II'
    });
  }

  // III - Resultados não operacionais (positivos)
  if (resultadoNaoOperacional > 0) {
    totalExclusoes += resultadoNaoOperacional;
    detalhamentoExclusoes.push({
      id: 'RESULT_NAO_OPERAC',
      valor: resultadoNaoOperacional,
      descricao: 'Ganhos de capital em ativo não circulante (líquido)',
      artigo: 'Art. 618 III'
    });
  }

  // IV - Receitas de exercícios anteriores
  if (receitasExerciciosAnteriores > 0) {
    totalExclusoes += receitasExerciciosAnteriores;
    detalhamentoExclusoes.push({
      id: 'RECEITAS_ANTERIOR',
      valor: receitasExerciciosAnteriores,
      descricao: 'Receitas de exercícios anteriores',
      artigo: 'Art. 618 IV'
    });
  }

  // VI - Subvenções como receita
  if (subvencoesReceita > 0) {
    totalExclusoes += subvencoesReceita;
    detalhamentoExclusoes.push({
      id: 'SUBVENCOES',
      valor: subvencoesReceita,
      descricao: 'Subvenções para investimento registradas como receita',
      artigo: 'Art. 618 VI'
    });
  }

  // VIII - Tributos com exigibilidade suspensa (não pagos)
  const tribSuspensosLiquido = tributosSuspensos - tributosSuspensosPagos;
  if (tribSuspensosLiquido > 0) {
    totalExclusoes += tribSuspensosLiquido;
    detalhamentoExclusoes.push({
      id: 'TRIB_SUSPENSOS',
      valor: tribSuspensosLiquido,
      descricao: 'Tributos com exigibilidade suspensa (Art. 151 CTN)',
      artigo: 'Art. 618 VIII'
    });
  }

  // === ADIÇÕES ===
  let totalAdicoes = 0;
  const detalhamentoAdicoes = [];

  // CSLL devida
  if (csllDevida > 0) {
    totalAdicoes += csllDevida;
    detalhamentoAdicoes.push({
      id: 'CSLL_DEVIDA',
      valor: csllDevida,
      descricao: 'CSLL devida no período',
      artigo: 'IN SRF 267/2002, art. 2º §1º'
    });
  }

  // Despesas financeiras líquidas (se despesas > receitas)
  if (resultadoFinanceiroLiquido < 0) {
    const despFinLiquida = Math.abs(resultadoFinanceiroLiquido);
    totalAdicoes += despFinLiquida;
    detalhamentoAdicoes.push({
      id: 'DESP_FIN_LIQUIDA',
      valor: despFinLiquida,
      descricao: `Despesas financeiras líquidas (${despFinTotal.toFixed(2)} - ${recFinTotal.toFixed(2)})`,
      artigo: 'IN SRF 267/2002, art. 2º §2º'
    });
  }

  // Resultados negativos de participações societárias
  if (resultadoParticipacoes < 0) {
    const prejPartic = Math.abs(resultadoParticipacoes);
    totalAdicoes += prejPartic;
    detalhamentoAdicoes.push({
      id: 'PREJUIZO_PARTIC_SOC',
      valor: prejPartic,
      descricao: 'Resultados negativos de participações societárias',
      artigo: 'IN SRF 267/2002, art. 2º §3º'
    });
  }

  // Resultados não operacionais negativos
  if (resultadoNaoOperacional < 0) {
    const perdaNaoOp = Math.abs(resultadoNaoOperacional);
    totalAdicoes += perdaNaoOp;
    detalhamentoAdicoes.push({
      id: 'PERDA_NAO_OPERAC',
      valor: perdaNaoOp,
      descricao: 'Perdas de capital em ativo não circulante',
      artigo: 'Art. 618 III (simétrico)'
    });
  }

  // === CÁLCULO DO LUCRO DA EXPLORAÇÃO ===
  const lucroExploracao = lucroLiquido + totalAdicoes - totalExclusoes;

  return {
    lucroLiquido,
    exclusoes: {
      total: Math.round(totalExclusoes * 100) / 100,
      detalhamento: detalhamentoExclusoes
    },
    adicoes: {
      total: Math.round(totalAdicoes * 100) / 100,
      detalhamento: detalhamentoAdicoes
    },
    lucroExploracao: Math.round(Math.max(0, lucroExploracao) * 100) / 100,
    lucroExploracaoBruto: Math.round(lucroExploracao * 100) / 100,
    prejuizoExploracao: lucroExploracao < 0,
    baseLegal: 'Art. 618-626 do RIR/2018 + IN SRF 267/2002'
  };
}

/**
 * Calcula a proporção do lucro da exploração atribuível à atividade incentivada.
 * Necessário quando a empresa tem atividades incentivadas e não incentivadas.
 *
 * @param {Object} dados
 * @param {number} dados.receitaLiquidaTotal - Receita líquida total da empresa
 * @param {number} dados.receitaLiquidaIncentivada - Receita líquida da atividade incentivada (conforme Laudo)
 * @param {number} dados.lucroExploracao - Lucro da exploração já calculado
 * @returns {Object} Proporção e lucro da exploração incentivado
 *
 * Base Legal: IN SRF 267/2002, art. 3º
 */
function calcularProporcaoIncentivada(dados) {
  const {
    receitaLiquidaTotal = 0,
    receitaLiquidaIncentivada = 0,
    lucroExploracao = 0
  } = dados;

  if (receitaLiquidaTotal <= 0) {
    return {
      proporcao: 0,
      lucroExploracaoIncentivado: 0,
      lucroExploracaoNaoIncentivado: lucroExploracao,
      alertas: ['Receita líquida total é zero ou negativa — não é possível calcular proporção'],
      artigo: 'IN SRF 267/2002, art. 3º'
    };
  }

  const proporcao = Math.min(1, receitaLiquidaIncentivada / receitaLiquidaTotal);
  const lucroExploracaoIncentivado = lucroExploracao * proporcao;

  return {
    receitaLiquidaTotal: Math.round(receitaLiquidaTotal * 100) / 100,
    receitaLiquidaIncentivada: Math.round(receitaLiquidaIncentivada * 100) / 100,
    proporcao: Math.round(proporcao * 10000) / 10000, // 4 casas
    lucroExploracaoIncentivado: Math.round(Math.max(0, lucroExploracaoIncentivado) * 100) / 100,
    lucroExploracaoNaoIncentivado: Math.round(Math.max(0, lucroExploracao - lucroExploracaoIncentivado) * 100) / 100,
    observacao: proporcao >= 1
      ? 'Toda a receita é incentivada — lucro da exploração = lucro da exploração incentivado'
      : `${(proporcao * 100).toFixed(2)}% da receita é incentivada`,
    artigo: 'IN SRF 267/2002, art. 3º'
  };
}

/**
 * Calcula a redução de 75% do IRPJ sobre o lucro da exploração.
 * Principal incentivo SUDAM/SUDENE.
 *
 * @param {Object} dados
 * @param {number} dados.lucroExploracaoIncentivado - Lucro da exploração da atividade incentivada
 * @param {number} [dados.aliquotaIRPJ=0.15] - Alíquota base do IRPJ (15%)
 * @param {number} [dados.limiteAdicional=60000] - Limite trimestral para adicional (R$60.000/tri = R$240.000/ano)
 * @param {boolean} [dados.anual=true] - Se apuração é anual (true) ou trimestral (false)
 * @param {number} [dados.percentualReducao=0.75] - Percentual de redução (padrão 75%)
 * @param {boolean} [dados.isencaoInclusaoDigital=false] - Se é isenção total (inclusão digital)
 * @returns {Object} Cálculo da redução do IRPJ com economia detalhada
 *
 * Base Legal: Art. 634 (SUDAM) / Art. 628 (SUDENE) / MP 2.199-14, art. 1º
 */
function calcularReducao75IRPJ(dados) {
  const {
    lucroExploracaoIncentivado = 0,
    aliquotaIRPJ = 0.15,
    limiteAdicional = 60000, // por trimestre
    anual = true,
    percentualReducao = 0.75,
    isencaoInclusaoDigital = false
  } = dados;

  if (lucroExploracaoIncentivado <= 0) {
    return {
      lucroExploracaoIncentivado: 0,
      irpjSobreLucroExploracao: 0,
      adicionalSobreLucroExploracao: 0,
      totalIRPJIncentivado: 0,
      reducao: 0,
      irpjAposReducao: 0,
      economia: { irpj: 0, total: 0 },
      artigo: isencaoInclusaoDigital ? 'Art. 634 §2º' : 'Art. 634'
    };
  }

  // Calcular IRPJ base sobre lucro da exploração
  const irpjBase = lucroExploracaoIncentivado * aliquotaIRPJ;

  // Calcular adicional de 10% sobre excedente
  const limiteAnual = anual ? limiteAdicional * 4 : limiteAdicional;
  const excedente = Math.max(0, lucroExploracaoIncentivado - limiteAnual);
  const adicional = excedente * 0.10;

  const totalIRPJIncentivado = irpjBase + adicional;

  // Aplicar redução
  const reducaoEfetiva = isencaoInclusaoDigital ? 1.0 : percentualReducao;
  const valorReducao = totalIRPJIncentivado * reducaoEfetiva;
  const irpjAposReducao = totalIRPJIncentivado - valorReducao;

  return {
    lucroExploracaoIncentivado: Math.round(lucroExploracaoIncentivado * 100) / 100,
    irpjSobreLucroExploracao: Math.round(irpjBase * 100) / 100,
    adicionalSobreLucroExploracao: Math.round(adicional * 100) / 100,
    totalIRPJIncentivado: Math.round(totalIRPJIncentivado * 100) / 100,
    percentualReducao: reducaoEfetiva,
    reducao: Math.round(valorReducao * 100) / 100,
    irpjAposReducao: Math.round(irpjAposReducao * 100) / 100,
    economia: {
      irpj: Math.round(valorReducao * 100) / 100,
      total: Math.round(valorReducao * 100) / 100
    },
    ajusteLalur: null, // A redução é deduzida diretamente do IRPJ — não é ajuste no LALUR
    reservaIncentivo: {
      valor: Math.round(valorReducao * 100) / 100,
      descricao: 'Registrar em Reserva de Incentivos Fiscais (Art. 195-A Lei 6.404/76)',
      destino: 'Somente absorção de prejuízos ou aumento de capital social',
      vedacao: 'Vedada distribuição como dividendos'
    },
    artigo: isencaoInclusaoDigital ? 'Art. 634 §2º (isenção digital)' : 'Art. 634 (SUDAM) / Art. 628 (SUDENE)'
  };
}

/**
 * Calcula o reinvestimento de 30% do IRPJ sobre o lucro da exploração.
 *
 * @param {Object} dados
 * @param {number} dados.lucroExploracaoIncentivado - Lucro da exploração da atividade incentivada
 * @param {number} [dados.irpjSobreLucroExploracao] - IRPJ (15% + adicional) sobre lucro da exploração
 * @param {number} [dados.reducao75Ja=0] - Valor já reduzido via incentivo de 75%
 * @param {string} [dados.superintendencia='SUDAM'] - 'SUDAM' ou 'SUDENE'
 * @returns {Object} Cálculo do reinvestimento de 30%
 *
 * Base Legal: Art. 638-651 do RIR/2018 / Lei 5.508/68, art. 23 / MP 2.199-14, art. 3º
 */
function calcularReinvestimento30(dados) {
  const {
    lucroExploracaoIncentivado = 0,
    irpjSobreLucroExploracao = null,
    reducao75Ja = 0,
    superintendencia = 'SUDAM'
  } = dados;

  // Se não informado, calcular IRPJ
  let irpjBase = irpjSobreLucroExploracao;
  if (irpjBase === null) {
    irpjBase = lucroExploracaoIncentivado * 0.15;
    const adicional = Math.max(0, lucroExploracaoIncentivado - 240000) * 0.10;
    irpjBase += adicional;
  }

  // IRPJ líquido = IRPJ total - redução 75% já aplicada
  const irpjLiquido = Math.max(0, irpjBase - reducao75Ja);

  // Reinvestimento = 30% do IRPJ sobre lucro da exploração (ANTES da redução 75%)
  const valorReinvestimento = irpjBase * REINVESTIMENTO_30.percentual;
  const recursosPropriosNecessarios = valorReinvestimento * REINVESTIMENTO_30.recursosPropriosComplementares;
  const capitalGiroPermitido = valorReinvestimento * REINVESTIMENTO_30.capitalGiro.percentualPermitido;

  const banco = REINVESTIMENTO_30.bancoDeposito[superintendencia] || 'Banco da Amazônia (BASA)';

  return {
    irpjSobreLucroExploracao: Math.round(irpjBase * 100) / 100,
    reducao75Ja: Math.round(reducao75Ja * 100) / 100,
    irpjLiquido: Math.round(irpjLiquido * 100) / 100,
    valorReinvestimento: Math.round(valorReinvestimento * 100) / 100,
    recursosPropriosNecessarios: Math.round(recursosPropriosNecessarios * 100) / 100,
    totalDeposito: Math.round((valorReinvestimento + recursosPropriosNecessarios) * 100) / 100,
    capitalGiroPermitido: Math.round(capitalGiroPermitido * 100) / 100,
    bancoDeposito: banco,
    prazoDeposito: 'Nas mesmas datas de pagamento do IRPJ',
    economia: {
      irpj: Math.round(valorReinvestimento * 100) / 100,
      total: Math.round(valorReinvestimento * 100) / 100
    },
    alertas: [
      `Depositar R$ ${valorReinvestimento.toFixed(2)} + R$ ${recursosPropriosNecessarios.toFixed(2)} (próprios) no ${banco}`,
      `Até 50% (R$ ${capitalGiroPermitido.toFixed(2)}) pode ser usado como capital de giro (Lei 13.799/2019)`,
      'Liberação condicionada à aprovação do projeto pela SUDAM/SUDENE'
    ],
    artigo: 'Art. 638-651 / Lei 5.508/68, art. 23 / Lei 13.799/2019'
  };
}

/**
 * Calcula a economia total combinando redução 75% + reinvestimento 30%.
 * Função principal para simulação de incentivos regionais.
 *
 * @param {Object} dados
 * @param {number} dados.lucroLiquido - Lucro líquido antes do IRPJ (após CSLL)
 * @param {number} [dados.receitasFinanceiras=0] - Receitas financeiras
 * @param {number} [dados.despesasFinanceiras=0] - Despesas financeiras
 * @param {number} [dados.resultadoParticipacoes=0] - Resultado participações
 * @param {number} [dados.ganhosCapitalAtivoNaoCirc=0] - Ganhos de capital
 * @param {number} [dados.perdasCapitalAtivoNaoCirc=0] - Perdas de capital
 * @param {number} [dados.receitasExerciciosAnteriores=0] - Receitas exercícios anteriores
 * @param {number} [dados.subvencoesReceita=0] - Subvenções
 * @param {number} [dados.csllDevida=0] - CSLL devida
 * @param {number} dados.receitaLiquidaTotal - Receita líquida total
 * @param {number} dados.receitaLiquidaIncentivada - Receita líquida incentivada
 * @param {boolean} [dados.anual=true] - Apuração anual
 * @param {string} [dados.superintendencia='SUDAM'] - Superintendência
 * @param {boolean} [dados.usarReinvestimento=true] - Se utilizar reinvestimento 30%
 * @returns {Object} Simulação completa com economia total
 *
 * Base Legal: Art. 618-651 do RIR/2018
 */
function simularIncentivosRegionais(dados) {
  const {
    receitaLiquidaTotal = 0,
    receitaLiquidaIncentivada = 0,
    anual = true,
    superintendencia = 'SUDAM',
    usarReinvestimento = true
  } = dados;

  // Passo 1: Calcular Lucro da Exploração
  const le = calcularLucroExploracao(dados);

  // Passo 2: Proporção incentivada
  const proporcao = calcularProporcaoIncentivada({
    receitaLiquidaTotal,
    receitaLiquidaIncentivada,
    lucroExploracao: le.lucroExploracao
  });

  // Passo 3: Redução 75%
  const reducao = calcularReducao75IRPJ({
    lucroExploracaoIncentivado: proporcao.lucroExploracaoIncentivado,
    anual
  });

  // Passo 4: Reinvestimento 30%
  let reinvestimento = null;
  if (usarReinvestimento && proporcao.lucroExploracaoIncentivado > 0) {
    reinvestimento = calcularReinvestimento30({
      lucroExploracaoIncentivado: proporcao.lucroExploracaoIncentivado,
      irpjSobreLucroExploracao: reducao.totalIRPJIncentivado,
      reducao75Ja: reducao.reducao,
      superintendencia
    });
  }

  // Passo 5: IRPJ total sem incentivos
  const irpjSemIncentivo = reducao.totalIRPJIncentivado;

  // Passo 6: IRPJ total com incentivos
  const irpjComReducao = reducao.irpjAposReducao;
  const irpjComReinvestimento = reinvestimento
    ? Math.max(0, irpjComReducao - reinvestimento.valorReinvestimento)
    : irpjComReducao;

  // Economia total
  const economiaReducao = reducao.reducao;
  const economiaReinvestimento = reinvestimento ? reinvestimento.valorReinvestimento : 0;
  const economiaTotal = economiaReducao + economiaReinvestimento;
  const cargaEfetiva = le.lucroExploracao > 0
    ? irpjComReinvestimento / le.lucroExploracao
    : 0;

  return {
    // Etapas
    lucroExploracao: le,
    proporcaoIncentivada: proporcao,
    reducao75: reducao,
    reinvestimento30: reinvestimento,

    // Resumo
    resumo: {
      lucroExploracao: le.lucroExploracao,
      lucroExploracaoIncentivado: proporcao.lucroExploracaoIncentivado,
      irpjSemIncentivo: Math.round(irpjSemIncentivo * 100) / 100,
      irpjComReducao75: Math.round(irpjComReducao * 100) / 100,
      irpjFinal: Math.round(irpjComReinvestimento * 100) / 100,
      economiaReducao75: Math.round(economiaReducao * 100) / 100,
      economiaReinvestimento30: Math.round(economiaReinvestimento * 100) / 100,
      economiaTotal: Math.round(economiaTotal * 100) / 100,
      cargaEfetivaIRPJ: Math.round(cargaEfetiva * 10000) / 10000, // em decimal
      cargaEfetivaIRPJPercent: (cargaEfetiva * 100).toFixed(2) + '%',
      superintendencia
    },

    economia: {
      irpj: Math.round(economiaTotal * 100) / 100,
      csll: 0, // CSLL não tem incentivo regional
      total: Math.round(economiaTotal * 100) / 100
    },

    observacoes: [
      `Lucro da Exploração apurado: R$ ${le.lucroExploracao.toFixed(2)}`,
      `Proporção incentivada: ${(proporcao.proporcao * 100).toFixed(2)}%`,
      `Redução 75%: R$ ${economiaReducao.toFixed(2)}`,
      reinvestimento ? `Reinvestimento 30%: R$ ${economiaReinvestimento.toFixed(2)} (depositar no ${REINVESTIMENTO_30.bancoDeposito[superintendencia]})` : null,
      `Economia total IRPJ: R$ ${economiaTotal.toFixed(2)}`,
      `Carga efetiva IRPJ sobre lucro da exploração: ${(cargaEfetiva * 100).toFixed(2)}%`,
      'IMPORTANTE: Registrar economia em Reserva de Incentivos Fiscais (Art. 195-A Lei 6.404/76)',
      'CSLL não possui redução por incentivos regionais — alíquota cheia de 9%'
    ].filter(Boolean),

    baseLegal: 'Art. 618-651 do RIR/2018 + MP 2.199-14/2001 + Lei 13.799/2019'
  };
}

/**
 * Simula comparativo completo: Simples Nacional vs Lucro Real COM incentivos SUDAM.
 * Função genérica para empresas em região SUDAM/SUDENE.
 *
 * @param {Object} dados
 * @param {number} dados.receitaBrutaAnual - Receita bruta anual (ex: 2_350_000)
 * @param {number} dados.folhaSalarial - Folha salarial anual (ex: 1_000_000)
 * @param {number} [dados.despesasDedutiveis=0] - Despesas dedutíveis totais
 * @param {number} [dados.receitasFinanceiras=0] - Receitas financeiras
 * @param {number} [dados.despesasFinanceiras=0] - Despesas financeiras
 * @param {number} [dados.percentualReceitaIncentivada=1.0] - % da receita incentivada (0 a 1)
 * @param {number} [dados.aliquotaSimplesEfetiva] - Alíquota efetiva do Simples (se conhecida)
 * @param {string} [dados.anexoSimples='III'] - Anexo do Simples Nacional
 * @returns {Object} Comparativo detalhado com recomendação
 *
 * Base Legal: LC 123/2006 (Simples) vs Art. 618-651 RIR/2018 (Lucro Real + SUDAM)
 */
function compararSimplesVsLucroRealSUDAM(dados) {
  const {
    receitaBrutaAnual = 0,
    folhaSalarial = 0,
    despesasDedutiveis = 0,
    receitasFinanceiras = 0,
    despesasFinanceiras = 0,
    percentualReceitaIncentivada = 1.0,
    aliquotaSimplesEfetiva = null,
    anexoSimples = 'III'
  } = dados;

  // ===== SIMPLES NACIONAL =====
  // Alíquotas do Anexo III (serviços) — faixa 5 (> R$ 1,8M até R$ 3,6M)
  // Alíquota nominal 33%, dedução R$ 648.000 → efetiva ~5,4% a 14,7%
  let aliquotaSimples = aliquotaSimplesEfetiva;
  if (!aliquotaSimples) {
    if (anexoSimples === 'III') {
      // Faixas do Anexo III (LC 123/2006, Anexo III)
      if (receitaBrutaAnual <= 180000) aliquotaSimples = 0.06;
      else if (receitaBrutaAnual <= 360000) aliquotaSimples = 0.112;
      else if (receitaBrutaAnual <= 720000) aliquotaSimples = 0.135;
      else if (receitaBrutaAnual <= 1800000) aliquotaSimples = 0.16;
      else if (receitaBrutaAnual <= 3600000) aliquotaSimples = (receitaBrutaAnual * 0.21 - 125640) / receitaBrutaAnual;
      else if (receitaBrutaAnual <= 4800000) aliquotaSimples = (receitaBrutaAnual * 0.33 - 648000) / receitaBrutaAnual;
      else aliquotaSimples = 0.165; // ultrapassou limite Simples
    } else if (anexoSimples === 'V') {
      // Anexo V — pode ser reclassificado para Anexo III se fator R >= 28%
      const fatorR = folhaSalarial / receitaBrutaAnual;
      if (fatorR >= 0.28) {
        // Usa alíquotas do Anexo III
        if (receitaBrutaAnual <= 1800000) aliquotaSimples = 0.155;
        else aliquotaSimples = (receitaBrutaAnual * 0.21 - 125640) / receitaBrutaAnual;
      } else {
        if (receitaBrutaAnual <= 1800000) aliquotaSimples = 0.195;
        else aliquotaSimples = (receitaBrutaAnual * 0.305 - 540000) / receitaBrutaAnual;
      }
    }
  }
  aliquotaSimples = Math.max(0.06, Math.min(aliquotaSimples, 0.33));
  const tributosSimples = receitaBrutaAnual * aliquotaSimples;

  // ===== LUCRO REAL SEM INCENTIVO SUDAM =====
  const lucroContabil = receitaBrutaAnual - despesasDedutiveis - folhaSalarial;
  const csllSemIncentivo = Math.max(0, lucroContabil) * 0.09;
  const lucroLiquidoAposCSLL = lucroContabil - csllSemIncentivo;
  const irpjSemIncentivo = Math.max(0, lucroContabil) * 0.15 + Math.max(0, lucroContabil - 240000) * 0.10;
  const pisNaoCumulativo = receitaBrutaAnual * 0.0165;
  const cofinsNaoCumulativo = receitaBrutaAnual * 0.076;
  const totalLRSemIncentivo = irpjSemIncentivo + csllSemIncentivo + pisNaoCumulativo + cofinsNaoCumulativo;

  // ===== LUCRO REAL COM INCENTIVO SUDAM =====
  const simulacao = simularIncentivosRegionais({
    lucroLiquido: lucroLiquidoAposCSLL,
    receitasFinanceiras,
    despesasFinanceiras,
    csllDevida: csllSemIncentivo,
    receitaLiquidaTotal: receitaBrutaAnual,
    receitaLiquidaIncentivada: receitaBrutaAnual * percentualReceitaIncentivada,
    anual: true,
    superintendencia: 'SUDAM',
    usarReinvestimento: true
  });

  const irpjComSUDAM = irpjSemIncentivo - simulacao.economia.irpj;
  const totalLRComSUDAM = Math.max(0, irpjComSUDAM) + csllSemIncentivo + pisNaoCumulativo + cofinsNaoCumulativo;

  // ===== COMPARATIVO =====
  const economiaSimplesVsLR = tributosSimples - totalLRSemIncentivo;
  const economiaSimplesVsSUDAM = tributosSimples - totalLRComSUDAM;
  const economiaLRvsSUDAM = totalLRSemIncentivo - totalLRComSUDAM;

  let recomendacao = '';
  let melhorRegime = '';
  if (totalLRComSUDAM < tributosSimples && totalLRComSUDAM < totalLRSemIncentivo) {
    melhorRegime = 'LUCRO_REAL_SUDAM';
    recomendacao = `LUCRO REAL + SUDAM é o mais vantajoso. Economia de R$ ${economiaSimplesVsSUDAM.toFixed(2)} vs Simples Nacional.`;
  } else if (totalLRSemIncentivo < tributosSimples) {
    melhorRegime = 'LUCRO_REAL';
    recomendacao = `LUCRO REAL (sem incentivo) é mais vantajoso que Simples. Economia de R$ ${economiaSimplesVsLR.toFixed(2)}.`;
  } else {
    melhorRegime = 'SIMPLES';
    recomendacao = `SIMPLES NACIONAL é mais vantajoso nas condições atuais. Diferença: R$ ${Math.abs(economiaSimplesVsLR).toFixed(2)}.`;
  }

  return {
    simplesNacional: {
      receitaBruta: receitaBrutaAnual,
      aliquotaEfetiva: Math.round(aliquotaSimples * 10000) / 10000,
      aliquotaEfetivaPercent: (aliquotaSimples * 100).toFixed(2) + '%',
      tributosTotal: Math.round(tributosSimples * 100) / 100,
      anexo: anexoSimples
    },
    lucroRealSemIncentivo: {
      lucroContabil: Math.round(lucroContabil * 100) / 100,
      irpj: Math.round(irpjSemIncentivo * 100) / 100,
      csll: Math.round(csllSemIncentivo * 100) / 100,
      pis: Math.round(pisNaoCumulativo * 100) / 100,
      cofins: Math.round(cofinsNaoCumulativo * 100) / 100,
      tributosTotal: Math.round(totalLRSemIncentivo * 100) / 100,
      cargaEfetiva: receitaBrutaAnual > 0 ? (totalLRSemIncentivo / receitaBrutaAnual * 100).toFixed(2) + '%' : '0%'
    },
    lucroRealComSUDAM: {
      lucroExploracao: simulacao.resumo.lucroExploracao,
      lucroExploracaoIncentivado: simulacao.resumo.lucroExploracaoIncentivado,
      reducao75: simulacao.resumo.economiaReducao75,
      reinvestimento30: simulacao.resumo.economiaReinvestimento30,
      irpj: Math.round(Math.max(0, irpjComSUDAM) * 100) / 100,
      csll: Math.round(csllSemIncentivo * 100) / 100,
      pis: Math.round(pisNaoCumulativo * 100) / 100,
      cofins: Math.round(cofinsNaoCumulativo * 100) / 100,
      tributosTotal: Math.round(totalLRComSUDAM * 100) / 100,
      cargaEfetiva: receitaBrutaAnual > 0 ? (totalLRComSUDAM / receitaBrutaAnual * 100).toFixed(2) + '%' : '0%'
    },
    comparativo: {
      economiaSimplesVsLR: Math.round(economiaSimplesVsLR * 100) / 100,
      economiaSimplesVsSUDAM: Math.round(economiaSimplesVsSUDAM * 100) / 100,
      economiaLRvsSUDAM: Math.round(economiaLRvsSUDAM * 100) / 100,
      melhorRegime,
      recomendacao
    },
    baseLegal: 'LC 123/2006 (Simples) vs Art. 618-651 RIR/2018 + MP 2.199-14/2001'
  };
}

/**
 * Gera relatório consolidado do Bloco E.
 *
 * @param {Object} dados
 * @param {Object} dados.elegibilidade - Resultado de verificarElegibilidade()
 * @param {Object} dados.simulacao - Resultado de simularIncentivosRegionais()
 * @param {Object} [dados.comparativo] - Resultado de compararSimplesVsLucroRealSUDAM()
 * @returns {Object} Relatório consolidado com todas as informações
 */
function gerarRelatorioE(dados) {
  const {
    elegibilidade = null,
    simulacao = null,
    comparativo = null
  } = dados;

  const resultado = {
    bloco: 'E — Lucro da Exploração e Incentivos Regionais SUDAM/SUDENE',
    baseLegal: 'Art. 618-668 do RIR/2018 + MP 2.199-14/2001 + Lei 13.799/2019',
    dataGeracao: new Date().toISOString().split('T')[0],
    secoes: {}
  };

  if (elegibilidade) {
    resultado.secoes.elegibilidade = {
      elegivel: elegibilidade.elegivel,
      superintendencia: elegibilidade.superintendencia,
      impedimentos: elegibilidade.impedimentos.length,
      setoresAplicaveis: elegibilidade.setoresAplicaveis.length,
      incentivosDisponiveis: elegibilidade.incentivosDisponiveis.map(i => i.tipo),
      recomendacoes: elegibilidade.recomendacoes
    };
  }

  if (simulacao) {
    resultado.secoes.incentivos = {
      lucroExploracao: simulacao.resumo.lucroExploracao,
      lucroExploracaoIncentivado: simulacao.resumo.lucroExploracaoIncentivado,
      economiaReducao75: simulacao.resumo.economiaReducao75,
      economiaReinvestimento30: simulacao.resumo.economiaReinvestimento30,
      economiaTotal: simulacao.resumo.economiaTotal,
      cargaEfetivaIRPJ: simulacao.resumo.cargaEfetivaIRPJPercent
    };
    resultado.economia = simulacao.economia;
  }

  if (comparativo) {
    resultado.secoes.comparativo = {
      simplesTotal: comparativo.simplesNacional.tributosTotal,
      lucroRealTotal: comparativo.lucroRealSemIncentivo.tributosTotal,
      lucroRealSUDAMTotal: comparativo.lucroRealComSUDAM.tributosTotal,
      melhorRegime: comparativo.comparativo.melhorRegime,
      recomendacao: comparativo.comparativo.recomendacao,
      economiaSUDAMvSimples: comparativo.comparativo.economiaSimplesVsSUDAM
    };
  }

  return resultado;
}

// ============================================================================
// EXPORTS
// ============================================================================


// ============================================================================
// EXEMPLOS DE USO
// ============================================================================


// ============================================================================
// CONSTANTES
// ============================================================================

/**
 * Tabela Progressiva IRPF — Mensal (Art. 677)
 * Vigente a partir de abril/2015 até maio/2023 (tabela RIR/2018)
 * Atualizada pela Lei 14.663/2023 (a partir de maio/2023) e
 * MP 1.294/2025 (a partir de maio/2025 — faixa de isenção R$ 2.428,80)
 *
 * NOTA: As tabelas históricas do Art. 677 (2010-2015) estão preservadas
 * abaixo para referência de períodos anteriores. A tabela corrente
 * deve ser usada para cálculos do período atual.
 */
const TABELAS_IRPF = {
  artigo: 'Art. 677',
  baseLegal: [
    'Lei 11.482/2007, art. 1º',
    'Lei 14.663/2023, art. 1º (faixa isenção R$ 2.112 a partir maio/2023)',
    'MP 1.294/2025 (faixa isenção R$ 2.428,80 a partir maio/2025)'
  ],

  // Tabela vigente a partir de maio/2025 (MP 1.294/2025)
  // Usar para cálculos atuais
  tabela_2025: [
    { faixa: 1, ate: 2428.80, aliquota: 0,     deducao: 0       },
    { faixa: 2, de: 2428.81, ate: 2826.65, aliquota: 0.075, deducao: 182.16 },
    { faixa: 3, de: 2826.66, ate: 3751.05, aliquota: 0.15,  deducao: 394.16 },
    { faixa: 4, de: 3751.06, ate: 4664.68, aliquota: 0.225, deducao: 675.49 },
    { faixa: 5, de: 4664.69, ate: Infinity, aliquota: 0.275, deducao: 908.73 }
  ],
  deducaoDependente_2025: 189.59,

  // Tabela mai/2023 a abr/2025 (Lei 14.663/2023)
  tabela_2023: [
    { faixa: 1, ate: 2112.00, aliquota: 0,     deducao: 0       },
    { faixa: 2, de: 2112.01, ate: 2826.65, aliquota: 0.075, deducao: 158.40 },
    { faixa: 3, de: 2826.66, ate: 3751.05, aliquota: 0.15,  deducao: 370.40 },
    { faixa: 4, de: 3751.06, ate: 4664.68, aliquota: 0.225, deducao: 651.73 },
    { faixa: 5, de: 4664.69, ate: Infinity, aliquota: 0.275, deducao: 884.96 }
  ],
  deducaoDependente_2023: 189.59,

  // Tabela abr/2015 a abr/2023 (RIR/2018, Art. 677 inciso VI)
  tabela_2015: [
    { faixa: 1, ate: 1903.98, aliquota: 0,     deducao: 0       },
    { faixa: 2, de: 1903.99, ate: 2826.65, aliquota: 0.075, deducao: 142.80 },
    { faixa: 3, de: 2826.66, ate: 3751.05, aliquota: 0.15,  deducao: 354.80 },
    { faixa: 4, de: 3751.06, ate: 4664.68, aliquota: 0.225, deducao: 636.13 },
    { faixa: 5, de: 4664.69, ate: Infinity, aliquota: 0.275, deducao: 869.36 }
  ],
  deducaoDependente_2015: 189.59
};

/**
 * IRRF sobre serviços profissionais PJ → PJ (Art. 714)
 * Lista de 40 serviços caracterizadamente de natureza profissional
 */
const IRRF_SERVICOS_PROFISSIONAIS = {
  artigo: 'Art. 714',
  baseLegal: [
    'Decreto-Lei 2.030/1983, art. 2º',
    'Decreto-Lei 2.065/1983, art. 1º, III',
    'Lei 7.450/1985, art. 52',
    'Lei 9.064/1995, art. 6º'
  ],
  aliquota: 0.015, // 1,5%
  tratamento: 'ANTECIPAÇÃO', // Art. 717 — antecipação do IRPJ devido
  servicos: [
    'administração de bens ou negócios', 'advocacia', 'análise clínica laboratorial',
    'análises técnicas', 'arquitetura', 'assessoria e consultoria técnica',
    'assistência social', 'auditoria', 'avaliação e perícia',
    'biologia e biomedicina', 'cálculo em geral', 'consultoria',
    'contabilidade', 'desenho técnico', 'economia',
    'elaboração de projetos', 'engenharia', 'ensino e treinamento',
    'estatística', 'fisioterapia', 'fonoaudiologia',
    'geologia', 'leilão', 'medicina',
    'nutricionismo e dietética', 'odontologia',
    'organização de feiras, congressos, seminários',
    'pesquisa em geral', 'planejamento', 'programação',
    'prótese', 'psicologia e psicanálise', 'química',
    'radiologia e radioterapia', 'relações públicas', 'serviço de despachante',
    'terapêutica ocupacional', 'tradução ou interpretação comercial',
    'urbanismo', 'veterinária'
  ],
  servicosGeotecnologia: [
    'engenharia',        // georeferenciamento, topografia
    'geologia',          // estudos ambientais
    'elaboração de projetos', // PRA, LAR
    'consultoria',       // consultoria ambiental
    'análises técnicas', // laudos técnicos
    'avaliação e perícia' // laudos de avaliação
  ],
  excecoes: [
    'engenharia: construção de estradas, pontes, prédios e obras assemelhadas — NÃO sujeito',
    'medicina: ambulatório, banco de sangue, hospital, pronto-socorro — NÃO sujeito',
    'assistência técnica de ramo explorado pelo prestador — NÃO sujeito ao inciso VI'
  ],
  nota: 'Incide independentemente da qualificação profissional dos sócios (Art. 714 §2º)'
};

/**
 * IRRF sobre limpeza, conservação, segurança, vigilância, locação mão-de-obra (Art. 716)
 */
const IRRF_SERVICOS_LIMPEZA_SEGURANCA = {
  artigo: 'Art. 716',
  baseLegal: [
    'Decreto-Lei 2.462/1988, art. 3º',
    'Lei 7.713/1988, art. 55'
  ],
  aliquota: 0.01, // 1%
  tratamento: 'ANTECIPAÇÃO',
  servicos: ['limpeza', 'conservação', 'segurança', 'vigilância', 'locação de mão-de-obra']
};

/**
 * IRRF sobre comissões, corretagens, representação comercial, propaganda (Art. 718)
 */
const IRRF_COMISSOES_REPRESENTACAO = {
  artigo: 'Art. 718',
  baseLegal: [
    'Lei 7.450/1985, art. 53',
    'Lei 9.064/1995, art. 6º'
  ],
  aliquota: 0.015, // 1,5%
  tratamento: 'ANTECIPAÇÃO',
  servicos: ['comissões', 'corretagens', 'representação comercial', 'mediação de negócios', 'propaganda e publicidade'],
  notaPropaganda: 'Publicidade: excluem-se da base os valores repassados a rádio, TV, jornais, revistas (Art. 718 §1º)'
};

/**
 * IRRF sobre cooperativas de trabalho (Art. 719)
 */
const IRRF_COOPERATIVAS = {
  artigo: 'Art. 719',
  baseLegal: 'Lei 8.541/1992, art. 45',
  aliquota: 0.015,
  tratamento: 'ANTECIPAÇÃO',
  nota: 'Retido pela cooperativa; compensado com IRRF pago aos associados (Art. 719 §1º)'
};

/**
 * IRRF sobre assessoria creditícia, mercadológica, gestão de crédito (Art. 723)
 */
const IRRF_ASSESSORIA_CREDITO = {
  artigo: 'Art. 723',
  baseLegal: 'Lei 10.833/2003, art. 29',
  aliquota: 0.015,
  tratamento: 'ANTECIPAÇÃO'
};

/**
 * IRRF sobre pagamentos pela Administração Pública Federal (Art. 720-722)
 * IN RFB 1.234/2012 (e alterações)
 */
const IRRF_ADMINISTRACAO_PUBLICA = {
  artigo: 'Art. 720-722',
  baseLegal: [
    'Lei 9.430/1996, art. 64',
    'Lei 10.833/2003, art. 34-36',
    'IN RFB 1.234/2012',
    'Lei 12.973/2014, art. 9º (altera Art. 15 Lei 9.249 — percentuais presunção e definição receita bruta)'
  ],
  metodoCalculo: '15% sobre (valor pago × percentual de presunção conforme atividade)',
  percentuaisPresuncao: {
    servicos_geral:       0.32,  // 32% — prestação de serviços em geral
    servicos_transporte:  0.16,  // 16% — transporte de carga
    servicos_hospitalar:  0.08,  // 8%  — serviços hospitalares
    comercio:             0.08,  // 8%  — revenda de mercadorias
    combustiveis:         0.016, // 1,6% — combustíveis
    infraestrutura_concessao: 0.32 // 32% — construção/reforma de infraestrutura vinculada a concessão (Lei 12.973, art. 9º → Art. 15, §1º, III, "e" Lei 9.249)
  },
  aliquotaBase: 0.15,
  exemplos: {
    servicos_geral: '15% × 32% × valor = 4,8% efetivo sobre serviços',
    comercio: '15% × 8% × valor = 1,2% efetivo'
  },
  dispensaSimples: 'Art. 720 §6º — optantes pelo Simples Nacional NÃO sofrem retenção',
  dispensaMinimo: 'R$ 10,00 — retenção dispensada se ≤ R$ 10,00 (Art. 721 §3º)',
  prazoRecolhimento: 'Até o último dia útil do 2º decêndio do mês subsequente (Art. 722)',
  entidadesObrigadas: [
    'Órgãos da administração pública federal direta',
    'Autarquias e fundações federais',
    'Empresas públicas (Art. 721, I)',
    'Sociedades de economia mista (Art. 721, II)',
    'Entidades com maioria de capital federal (Art. 721, III)'
  ]
};

/**
 * IRRF sobre Juros sobre Capital Próprio — JCP (Art. 726)
 */
const IRRF_JCP = {
  artigo: 'Art. 726',
  baseLegal: [
    'Lei 9.249/1995, art. 9º, §2º',
    'Lei 12.973/2014, art. 9º (altera §§8º-12 da Lei 9.249/1995 — contas PL para cálculo JCP)'
  ],
  aliquota: 0.15, // 15%
  tratamento: {
    lucroReal: 'ANTECIPAÇÃO (Art. 726 §1º, I)',
    lucroPresumido: 'ANTECIPAÇÃO (Art. 726 §1º, I)',
    demais: 'TRIBUTAÇÃO DEFINITIVA (Art. 726 §1º, II)'
  },
  contasPL_Lei12973: {
    descricao: 'Para cálculo do JCP, consideram-se EXCLUSIVAMENTE (Lei 9.249, art. 9º, §8º, na redação da Lei 12.973):',
    I: 'Capital social (incluindo ações classificadas em passivo — §12)',
    II: 'Reservas de capital',
    III: 'Reservas de lucros',
    IV: 'Ações em tesouraria (deduzidas)',
    V: 'Prejuízos acumulados (deduzidos)'
  },
  aplicaCSLL: 'Art. 9º, §11 da Lei 9.249 — JCP aplica-se também à CSLL (Lei 12.973)'
};

/**
 * Dividendos — isentos (Art. 725)
 */
const DIVIDENDOS = {
  artigo: 'Art. 725',
  baseLegal: [
    'Lei 9.249/1995, art. 10',
    'Lei 12.973/2014, art. 9º (altera §§1º-3º da Lei 9.249 — isenção ampliada para todas as espécies de ações)'
  ],
  aliquota: 0, // isento
  regra: 'Lucros/dividendos apurados a partir de jan/1996 — isentos de IRRF e não integram base IRPJ do beneficiário',
  nota: 'Aplica-se a todas as espécies de ações (Art. 725 §3º)',
  lei12973: {
    paragrafo1: 'Quotas/ações distribuídas por incorporação de lucros a partir de jan/1996 — custo = parcela do lucro/reserva capitalizado',
    paragrafo2: 'Isenção inclui TODAS as espécies de ações do Art. 15 da Lei 6.404/76, ainda que classificadas em passivo ou remuneração como despesa financeira',
    paragrafo3: 'Lucros/dividendos pagos como despesa financeira NÃO são dedutíveis no lucro real e na base da CSLL'
  }
};

/**
 * IRRF sobre multas rescisórias (Art. 740)
 */
const IRRF_MULTAS_RESCISAO = {
  artigo: 'Art. 740',
  baseLegal: 'Lei 9.430/1996, art. 70',
  aliquota: 0.15,
  tratamento: 'ANTECIPAÇÃO',
  excecoes: 'Não se aplica a indenizações trabalhistas e reparação de danos patrimoniais (Art. 740 §5º)'
};

/**
 * IRRF sobre decisões judiciais (Art. 738-739)
 */
const IRRF_DECISAO_JUDICIAL = {
  jurosLucrosCessantes: {
    artigo: 'Art. 738',
    aliquota: 0.05, // 5%
    tratamento: 'ANTECIPAÇÃO'
  },
  precatorios: {
    artigo: 'Art. 739',
    aliquota: 0.03, // 3%
    tratamento: 'ANTECIPAÇÃO',
    dispensa: 'Dispensada se rendimentos isentos ou não tributáveis, ou optante Simples (Art. 739 §1º)'
  }
};

/**
 * Pagamento a beneficiário não identificado (Art. 730-731)
 */
const IRRF_BENEFICIARIO_NAO_IDENTIFICADO = {
  artigo: 'Art. 730-731',
  baseLegal: 'Lei 8.981/1995, art. 61',
  aliquota: 0.35, // 35%
  tratamento: 'EXCLUSIVAMENTE NA FONTE',
  nota: 'Rendimento considerado líquido — reajustamento para bruto (Art. 730 §3º)',
  formulaBruto: 'Bruto = Líquido / (1 - 0,35) = Líquido / 0,65'
};

/**
 * CSRF — Contribuições Sociais Retidas na Fonte
 * PIS/COFINS/CSLL retidos (Lei 10.833/2003, art. 30)
 */
const CSRF = {
  baseLegal: [
    'Lei 10.833/2003, art. 30 a 36',
    'Lei 13.137/2015 (alteração prazos)',
    'IN RFB 1.234/2012 (Adm. Pública)',
    'IN RFB 459/2004 (regulamentação)'
  ],
  aliquotas: {
    pis:    0.0065,  // 0,65%
    cofins: 0.03,    // 3,00%
    csll:   0.01,    // 1,00%
    total:  0.0465   // 4,65%
  },
  servicosSujeitos: [
    'serviços profissionais (mesma lista do Art. 714)',
    'limpeza, conservação, manutenção',
    'segurança e vigilância',
    'locação de mão-de-obra',
    'assessoria creditícia, mercadológica, gestão de crédito',
    'transporte de valores'
  ],
  dispensas: {
    simplesNacional: 'Optantes pelo Simples Nacional NÃO sofrem retenção (LC 123/2006, art. 30, II)',
    valorMinimo: 'Dispensada se retenção ≤ R$ 10,00 (Lei 10.833/2003, art. 31 §3º)',
    isentas: 'Entidades imunes/isentas referidas no art. 12 da Lei 9.532/1997',
    SCP: 'Não se aplica a pagamentos entre SCP e sócio ostensivo',
    transporteCarga: 'Transporte de carga (exceto valores) — dispensado se PJ prestar com veículo próprio'
  },
  prazoRecolhimento: 'Até o último dia útil do 2º decêndio do mês subsequente ao pagamento (Lei 13.137/2015)',
  codigoDARF: {
    pis: '5979',
    cofins: '5960',
    csll: '5987',
    csrf_unico: '5952' // código unificado Adm. Pública
  },
  tratamento: {
    pis: 'Compensável com PIS/COFINS devidos (cumulativo ou não-cumulativo)',
    cofins: 'Compensável com PIS/COFINS devidos',
    csll: 'Compensável com CSLL devida no período',
    nota: 'Cada contribuição só compensa com ela mesma (PIS com PIS, COFINS com COFINS, CSLL com CSLL)'
  }
};

/**
 * ISS Retido na Fonte (LC 116/2003, art. 3º e 6º)
 */
const ISS_RETIDO = {
  baseLegal: [
    'Lei Complementar 116/2003, art. 3º e 6º',
    'Lei Complementar 175/2020 (CPOM — padrão nacional)'
  ],
  aliquotaMinima: 0.02,   // 2% — piso constitucional (EC 37/2002)
  aliquotaMaxima: 0.05,   // 5%
  retencaoObrigatoria: [
    'Quando o serviço é prestado em município diferente do estabelecimento do prestador',
    'Nos serviços listados nos incisos do art. 3º da LC 116/2003',
    'Serviços de cessão de mão-de-obra (item 17.05 da lista)',
    'Serviços de limpeza, conservação, segurança (item 7.10, 7.12, 7.13)',
    'Serviços de informática (item 1.01 a 1.09)',
    'Quando o município exigir via legislação local'
  ],
  municipioExemplo: {
    aliquotaISS: 0.05,   // 5% — alíquota típica de municípios da região Norte
    nota: 'Verificar legislação municipal vigente — código tributário do município'
  },
  deducaoIRPJ: 'ISS retido NÃO deduz do IRPJ — é tributo municipal, tratado na DRE como despesa',
  nota: 'Se tomador retém ISS, o prestador NÃO recolhe. Responsabilidade solidária.'
};

/**
 * Retenções pela Administração Pública — IN RFB 1.234/2012
 * (Estados, Municípios: IN RFB 475/2004 — adesão facultativa)
 */
const RETENCOES_ADM_PUBLICA_UNIFICADA = {
  baseLegal: 'IN RFB 1.234/2012',
  tributos: {
    irpj: 0.048,  // 4,8% (15% × 32%) para serviços
    csll: 0.01,   // 1%
    cofins: 0.03, // 3%
    pis: 0.0065,  // 0,65%
    total: 0.0945 // 9,45% — alíquota combinada sobre NF de serviço
  },
  prazo: 'Recolhimento até o último dia útil do 2º decêndio do mês subsequente',
  dispensaSimplesNacional: true,
  nota: 'Empresas que migrarem para Lucro Real passarão a sofrer retenção de 9,45% em NFs para órgãos públicos'
};

/**
 * LEI 12.973/2014 — Disposições que impactam retenções na fonte e apuração
 *
 * A Lei 12.973/2014 alterou o DL 1.598/1977, a Lei 9.249/1995, a Lei 9.430/1996,
 * a Lei 8.981/1995, entre outras, com reflexos diretos na base de cálculo de IRPJ,
 * CSLL, PIS/COFINS, e consequentemente nas retenções na fonte.
 *
 * Impactos diretos no Bloco G:
 * 1. Definição de receita bruta (Art. 12 DL 1.598, alterado pela Lei 12.973)
 * 2. JCP — Patrimônio líquido para cálculo (Art. 9º Lei 9.249, alterado)
 * 3. Dividendos — isenção confirmada e ampliada (Art. 10 Lei 9.249, alterado)
 * 4. Base de cálculo CSLL lucro presumido/estimativa (Art. 20 Lei 9.249, alterado)
 * 5. Percentuais de presunção (Art. 15 Lei 9.249, alterado)
 * 6. Avaliação a valor justo — impacto nas bases (Arts. 13-14 Lei 12.973)
 * 7. Subvenções para investimento (Art. 30 Lei 12.973, revogado pela Lei 14.789/2023)
 * 8. Goodwill e mais/menos-valia (Arts. 20-28 Lei 12.973)
 * 9. Ganho de capital — ajustes na base (Art. 25, 27 Lei 9.430, alterados)
 */
const LEI_12973 = {
  baseLegal: 'Lei 12.973/2014',
  publicacao: '14/05/2014',
  vigencia: 'A partir de 01/01/2015 (ou 01/01/2014 para optantes — Art. 75)',

  // ─────────────────────────────────────────────────────────────────────────
  // 1. RECEITA BRUTA (Art. 2º da Lei 12.973 → altera Art. 12 do DL 1.598/1977)
  // ─────────────────────────────────────────────────────────────────────────
  receitaBruta: {
    artigo: 'Art. 12 do DL 1.598/1977 (nova redação pela Lei 12.973/2014, art. 2º)',
    definicao: {
      I: 'Produto da venda de bens nas operações de conta própria',
      II: 'Preço da prestação de serviços em geral',
      III: 'Resultado auferido nas operações de conta alheia',
      IV: 'Receitas da atividade ou objeto principal da PJ não compreendidas em I a III'
    },
    receitaLiquida: {
      descricao: 'Receita bruta diminuída de:',
      I: 'Devoluções e vendas canceladas',
      II: 'Descontos concedidos incondicionalmente',
      III: 'Tributos sobre ela incidentes',
      IV: 'Valores decorrentes do ajuste a valor presente (Art. 183, VIII, Lei 6.404/76)'
    },
    exclusoes: {
      paragrafo4: 'Na receita bruta NÃO se incluem tributos não cumulativos cobrados destacadamente do comprador na condição de mero depositário (§4º)',
      paragrafo5: 'Na receita bruta INCLUEM-SE tributos sobre ela incidentes e valores de ajuste a valor presente (§5º)'
    },
    impactoRetencoes: 'A definição de receita bruta impacta diretamente a base de cálculo para fins de presunção do lucro (Art. 15 Lei 9.249) usada nas retenções pela Adm. Pública (Art. 720 RIR)',
  },

  // ─────────────────────────────────────────────────────────────────────────
  // 2. JCP — JUROS SOBRE CAPITAL PRÓPRIO (Art. 9º da Lei 12.973 → altera Art. 9º Lei 9.249/1995)
  // ─────────────────────────────────────────────────────────────────────────
  jcp: {
    artigo: 'Art. 9º da Lei 9.249/1995 (alterado pela Lei 12.973/2014, art. 9º)',
    irrfRetido: 0.15, // 15% na fonte (Art. 726 RIR)
    contasPatrimonioLiquido: {
      descricao: 'Para cálculo do JCP, consideram-se EXCLUSIVAMENTE (§8º):',
      I: 'Capital social',
      II: 'Reservas de capital',
      III: 'Reservas de lucros',
      IV: 'Ações em tesouraria (deduzidas)',
      V: 'Prejuízos acumulados (deduzidos)'
    },
    capitalSocial: {
      paragrafo12: 'Inclui todas as espécies de ações do Art. 15 da Lei 6.404/76, ainda que classificadas em conta de passivo na escrituração comercial (§12)'
    },
    aplicaCSLL: 'Art. 9º, §11 — o disposto aplica-se também à CSLL',
    impactoRetencao: 'IRRF 17,5% sobre JCP calculado com base nestas contas do PL (Art. 726 RIR + LC 224/2025). Se PL inclui passivo reclassificado como ação, a base de JCP é maior → maior IRRF retido.',
  },

  // ─────────────────────────────────────────────────────────────────────────
  // 3. DIVIDENDOS (Art. 9º da Lei 12.973 → altera Art. 10 Lei 9.249/1995)
  // ─────────────────────────────────────────────────────────────────────────
  dividendos: {
    artigo: 'Art. 10 da Lei 9.249/1995 (alterado pela Lei 12.973/2014, art. 9º)',
    isencao: 'Lucros e dividendos distribuídos — ISENTOS de IRRF',
    detalhes: {
      paragrafo1: 'Quotas/ações distribuídas por aumento de capital via incorporação de lucros apurados a partir de jan/1996 — custo de aquisição = parcela do lucro/reserva capitalizado (§1º)',
      paragrafo2: 'A isenção inclui lucros/dividendos pagos a TODAS as espécies de ações do Art. 15 da Lei 6.404/76, ainda que classificadas em passivo ou remuneração classificada como despesa financeira (§2º)',
      paragrafo3: 'NÃO são dedutíveis no lucro real e na base da CSLL os lucros/dividendos pagos a qualquer espécie de ação, ainda que classificados como despesa financeira (§3º)'
    },
    impactoRetencao: 'Dividendos continuam ISENTOS de retenção (Art. 725 RIR). Porém, se pagos como despesa financeira contabilmente, NÃO são dedutíveis para IRPJ/CSLL.',
  },

  // ─────────────────────────────────────────────────────────────────────────
  // 4. BASE DE CÁLCULO CSLL — LUCRO PRESUMIDO/ESTIMATIVA (Art. 9º → altera Art. 20 Lei 9.249/1995)
  // ─────────────────────────────────────────────────────────────────────────
  baseCSLL: {
    artigo: 'Art. 20 da Lei 9.249/1995 (alterado pela Lei 12.973/2014, art. 9º)',
    percentualGeral: 0.12,  // 12% sobre receita bruta
    percentualServicos: 0.32, // 32% para serviços (inciso III do §1º do art. 15)
    receitaBrutaRef: 'Art. 12 do DL 1.598/1977 (definição da Lei 12.973)',
    deducoes: 'Deduzida de devoluções, vendas canceladas e descontos incondicionais',
    impactoRetencao: 'A base presumida da CSLL usa a mesma receita bruta redefinida pela Lei 12.973. Para serviços, a base é 32% — relevante para CSRF retida (1% CSLL) e para cálculo da CSLL devida contra a qual se compensa a CSLL retida.',
  },

  // ─────────────────────────────────────────────────────────────────────────
  // 5. PERCENTUAIS DE PRESUNÇÃO — LUCRO PRESUMIDO (Art. 9º → altera Art. 15 Lei 9.249/1995)
  // ─────────────────────────────────────────────────────────────────────────
  lucroPresumido: {
    artigo: 'Art. 15 da Lei 9.249/1995 (alterado pela Lei 12.973/2014, art. 9º)',
    percentualGeral: 0.08,  // 8%
    receitaBrutaRef: 'Art. 12 do DL 1.598/1977',
    deducoes: 'Deduzida de devoluções, vendas canceladas e descontos incondicionais',
    percentuaisEspecificos: {
      servicos_geral: { percentual: 0.32, descricao: '32% — prestação de serviços em geral' },
      servicos_transporte_carga: { percentual: 0.08, descricao: '8% — transporte de carga' },
      servicos_transporte_passageiros: { percentual: 0.16, descricao: '16% — transporte (exceto carga)' },
      servicos_hospitalares: { percentual: 0.08, descricao: '8% — serviços hospitalares e de auxílio diagnóstico/terapia' },
      construcao_infraestrutura: { percentual: 0.32, descricao: '32% — construção, recuperação, reforma de infraestrutura vinculada a concessão (§1º, III, "e")' },
      comercio: { percentual: 0.08, descricao: '8% — revenda de mercadorias' },
      combustiveis: { percentual: 0.016, descricao: '1,6% — revenda de combustíveis' }
    },
    impactoRetencao: 'Os percentuais de presunção são usados pela Adm. Pública para calcular o IRRF retido (Art. 720 RIR): IRRF = 15% × (percentual de presunção × valor pago). A Lei 12.973 confirmou a inclusão de serviços de infraestrutura vinculados a concessão na alíquota de 32%.',
  },

  // ─────────────────────────────────────────────────────────────────────────
  // 6. GANHO DE CAPITAL — AJUSTES (Arts. 6-7 da Lei 12.973 → altera Arts. 25, 27 Lei 9.430/1996)
  // ─────────────────────────────────────────────────────────────────────────
  ganhoCapital: {
    artigo: 'Arts. 25 e 27 da Lei 9.430/1996 (alterados pela Lei 12.973/2014, art. 6º)',
    lucroPresumido: {
      baseCalculo: {
        I: 'Percentual de presunção (Art. 15 Lei 9.249) × receita bruta (Art. 12 DL 1.598)',
        II: 'Ganhos de capital, rendimentos/ganhos de aplicações financeiras, demais receitas, com valores de ajuste a valor presente'
      },
      ganhoCapitalAlienacao: {
        paragrafo1: 'Ganho de capital nas alienações de investimentos, imobilizados e intangíveis = diferença positiva entre valor da alienação e valor contábil (§1º)',
        paragrafo2: 'No valor contábil, podem ser considerados os efeitos de ajuste a valor presente do Art. 184, III, Lei 6.404/76 (§2º)'
      },
      valorJusto: {
        paragrafo3: 'Ganhos de avaliação a valor justo NÃO integram a base de cálculo no momento da apuração (§3º)',
        paragrafo4: 'Ganhos/perdas de valor justo NÃO são parte do valor contábil para fins do inciso II (§4º)',
        paragrafo5: 'Exceção: ganhos anteriormente computados na base (§5º)'
      }
    },
    csll: {
      artigo: 'Art. 27 da Lei 9.430/1996 (alterado)',
      mesmaLogica: 'Mesma lógica do IRPJ, porém com percentuais do Art. 20 da Lei 9.249 (12% geral, 32% serviços)'
    },
    custoEmprestimos: {
      artigo: 'Art. 7º da Lei 12.973/2014',
      regra: 'Vedado o cômputo de encargos associados a empréstimos registrados como custo (Art. 17, §1º, "b", DL 1.598) no ganho de capital para lucro presumido/arbitrado',
      aplicacao: 'Aplica-se ao ganho de capital do Art. 25, II, Art. 27, II e Art. 29, II da Lei 9.430/96'
    },
    impactoRetencao: 'A forma de apurar o ganho de capital afeta a base sobre a qual se calcula IRPJ/CSLL devidos, contra os quais as retenções (IRRF e CSRF) são compensadas.',
  },

  // ─────────────────────────────────────────────────────────────────────────
  // 7. AJUSTE A VALOR PRESENTE (Arts. 4-5 da Lei 12.973)
  // ─────────────────────────────────────────────────────────────────────────
  ajusteValorPresente: {
    artigo: 'Arts. 4º e 5º da Lei 12.973/2014',
    ativo: {
      artigo: 'Art. 4º',
      regra: 'Valores de ajuste a valor presente (Art. 183, VIII, Lei 6.404/76) somente são considerados no lucro real no período em que a receita/resultado da operação deva ser oferecida à tributação'
    },
    passivo: {
      artigo: 'Art. 5º',
      regra: 'Valores de ajuste a valor presente (Art. 184, III, Lei 6.404/76) são considerados no lucro real quando:',
      I: 'O bem for revendido (aquisição para revenda)',
      II: 'O bem for utilizado como insumo',
      III: 'O ativo for realizado (depreciação, amortização, exaustão, alienação ou baixa)',
      IV: 'A despesa for incorrida (bem/serviço contabilizado como despesa)',
      V: 'O custo for incorrido (bem/serviço contabilizado como custo de produção)',
      subconta: 'Nas hipóteses I, II e III, valores devem ser evidenciados em subconta vinculada ao ativo (§1º)',
      restricao: 'Não podem ser considerados se: valor indedutível (§2º, I-II) ou não evidenciados em subconta (§2º, III)'
    },
    variacaoCambial: {
      artigo: 'Art. 12 da Lei 12.973/2014',
      regra: 'Variações monetárias cambiais referentes a saldos de ajuste a valor presente NÃO são computadas no lucro real'
    },
    lucroPresumido: {
      artigo: 'Art. 8º da Lei 12.973/2014',
      regra: 'No lucro presumido/arbitrado, receitas financeiras de variações cambiais dos direitos/obrigações originadas de ajuste a valor presente NÃO integram a base do IR'
    },
    impactoRetencao: 'Ajustes a valor presente alteram o momento de reconhecimento da receita, podendo deslocar receita tributável entre períodos — afeta a base contra a qual retenções são compensadas.',
  },

  // ─────────────────────────────────────────────────────────────────────────
  // 8. AVALIAÇÃO A VALOR JUSTO (Arts. 13-14 da Lei 12.973)
  // ─────────────────────────────────────────────────────────────────────────
  avaliacaoValorJusto: {
    ganho: {
      artigo: 'Art. 13 da Lei 12.973/2014',
      regra: 'Ganho de avaliação a valor justo NÃO é computado no lucro real se evidenciado em subconta vinculada ao ativo/passivo',
      realizacao: 'É computado à medida que o ativo for realizado (depreciação, amortização, exaustão, alienação ou baixa) ou passivo liquidado/baixado (§1º)',
      indedutivel: 'Não será computado se o valor realizado for indedutível (§2º)',
      semSubconta: 'Se NÃO evidenciado em subconta, o ganho é TRIBUTADO (§3º)',
      semReducaoPrejuizo: 'Ganho tributado por falta de subconta não pode reduzir prejuízo fiscal — diferido para período seguinte com lucro real (§4º)',
      excecao: 'Não se aplica a ganhos no reconhecimento inicial de ativos de doações recebidas de terceiros (§5º)',
      permuta: 'Em operações de permuta, ganho pode ser computado na medida da realização do ativo/passivo recebido (§6º)'
    },
    perda: {
      artigo: 'Art. 14 da Lei 12.973/2014',
      regra: 'Perda de avaliação a valor justo somente é computada no lucro real à medida que o ativo for realizado ou passivo liquidado/baixado, E desde que evidenciada em subconta',
      indedutivel: 'Não será computada se valor realizado for indedutível (§1º)',
      semSubconta: 'Se NÃO evidenciada em subconta, a perda é INDEDUTÍVEL (§2º)'
    },
    disciplinamento: {
      artigo: 'Art. 15 da Lei 12.973/2014',
      regra: 'A RFB disciplinará o controle em subcontas previsto nos arts. 5º, 13 e 14'
    },
    transicaoPresumidoReal: {
      artigo: 'Art. 16 da Lei 12.973/2014',
      regra: 'PJ que mudar de lucro presumido para lucro real deve incluir na base do presumido os ganhos de valor justo que façam parte do valor contábil dos ativos',
      diferimento: 'Os ganhos podem ser diferidos se observados os requisitos do Art. 13 (subconta)',
      perdas: 'Perdas somente computáveis se observados os requisitos do Art. 14'
    },
    subscricaoAcoes: {
      ganho: {
        artigo: 'Art. 17 da Lei 12.973/2014',
        regra: 'Ganho de valor justo de bem incorporado ao patrimônio de outra PJ na subscrição de capital NÃO é computado no lucro real se evidenciado em subconta vinculada à participação societária',
        realizacao: {
          I: 'Na alienação/liquidação da participação societária',
          II: 'Proporcionalmente ao valor realizado pela PJ que recebeu o bem',
          III: 'Para bens não sujeitos a depreciação: à razão de 1/60 por mês, nos 5 anos subsequentes'
        }
      },
      perda: {
        artigo: 'Art. 18 da Lei 12.973/2014',
        regra: 'Perda de valor justo na subscrição somente computável se evidenciada em subconta, nas mesmas hipóteses do ganho',
        semSubconta: 'Se não evidenciada em subconta, perda é INDEDUTÍVEL (§1º)'
      }
    },
    impactoRetencao: 'Ganhos/perdas de valor justo afetam o lucro real e, portanto, a base de IRPJ/CSLL contra a qual retenções sofridas são compensadas. Se a empresa tiver ativos avaliados a valor justo (terrenos, participações), o momento de tributação do ganho afeta o saldo de compensação.',
  },

  // ─────────────────────────────────────────────────────────────────────────
  // 9. INCORPORAÇÃO, FUSÃO, CISÃO — MAIS-VALIA, MENOS-VALIA, GOODWILL (Arts. 20-28 Lei 12.973)
  // ─────────────────────────────────────────────────────────────────────────
  incorporacaoFusaoCisao: {
    maisValia: {
      artigo: 'Art. 20 da Lei 12.973/2014',
      regra: 'Saldo de mais-valia (Art. 20, II, DL 1.598) na incorporação/fusão/cisão pode ser considerado como integrante do custo do bem que lhe deu causa — para ganho/perda de capital e depreciação/amortização/exaustão',
      condicoes: {
        laudo: 'Laudo de perito independente deve ter sido protocolado/registrado tempestivamente (§3º)',
        identificacao: 'Valores devem ser identificáveis na contabilidade (§3º do art. 37 ou §1º do art. 39)',
        partesNaoDependentes: 'Somente entre partes NÃO dependentes'
      },
      cisaoSemBem: 'Se o bem não foi transferido na cisão, a importância pode ser deduzida em quotas fixas mensais no prazo mínimo de 5 anos (§1º)',
      condicionada: 'Dedutibilidade condicionada ao Art. 13, III da Lei 9.249/1995 (§2º)'
    },
    menosValia: {
      artigo: 'Art. 21 da Lei 12.973/2014',
      regra: 'Saldo de menos-valia DEVERÁ ser considerado como custo do bem que lhe deu causa — para ganho/perda de capital e depreciação/amortização/exaustão',
      cisaoSemBem: 'Se bem não transferido na cisão, importância pode ser diferida com tributação em quotas fixas mensais no prazo máximo de 5 anos (§1º)'
    },
    goodwill: {
      artigo: 'Art. 22 da Lei 12.973/2014',
      regra: 'Ágio por rentabilidade futura (goodwill) na incorporação/fusão/cisão pode ser excluído do lucro real à razão de 1/60 por mês (no máximo) nos períodos subsequentes',
      condicoes: {
        laudo: 'Laudo tempestivamente protocolado/registrado',
        identificacao: 'Valores identificáveis na contabilidade',
        partesNaoDependentes: 'Aquisição entre partes NÃO dependentes (Art. 25 Lei 12.973)'
      },
      contrapartidaReducao: {
        artigo: 'Art. 28 da Lei 12.973/2014',
        regra: 'Contrapartida da redução do goodwill (inclusive redução ao valor recuperável) NÃO é computada no lucro real'
      }
    },
    ganhoCompraVantajosa: {
      artigo: 'Art. 23 da Lei 12.973/2014',
      regra: 'Ganho proveniente de compra vantajosa na incorporação/fusão/cisão deve ser computado no lucro real à razão de 1/60 por mês (no mínimo) nos períodos subsequentes'
    },
    partesDependentes: {
      artigo: 'Art. 25 da Lei 12.973/2014',
      definicao: {
        I: 'Adquirente e alienante controlados pela mesma parte',
        II: 'Relação de controle entre adquirente e alienante',
        III: 'Alienante é sócio, titular, conselheiro ou administrador da adquirente',
        IV: 'Alienante é parente/afim até 3º grau, cônjuge ou companheiro dos anteriores',
        V: 'Outras relações que comprovem dependência societária'
      }
    },
    valorJustoSuccedida: {
      artigo: 'Art. 26 da Lei 12.973/2014',
      regra: 'Ganhos de valor justo na sucedida NÃO podem ser considerados como custo na sucessora para ganho/perda de capital e depreciação',
      subcontas: 'Ganhos/perdas evidenciados em subcontas (Arts. 13 e 14) transferidos por incorporação/fusão/cisão mantêm o mesmo tratamento tributário na sucessora'
    },
    impactoRetencao: 'Goodwill e mais/menos-valia afetam o lucro real ao longo de até 5 anos (1/60 por mês), alterando a base de IRPJ/CSLL devidos e consequentemente o saldo de compensação de retenções sofridas.',
  },

  // ─────────────────────────────────────────────────────────────────────────
  // 10. SUBVENÇÕES PARA INVESTIMENTO (Art. 30 da Lei 12.973)
  // ─────────────────────────────────────────────────────────────────────────
  subvencoesInvestimento: {
    artigo: 'Art. 30 da Lei 12.973/2014',
    status: 'REVOGADO pela Lei 14.789/2023 (a partir de 2024)',
    regraOriginal: 'Subvenções para investimento (inclusive isenção/redução de impostos) e doações do poder público NÃO eram computadas no lucro real, desde que registradas em reserva de lucros (Art. 195-A Lei 6.404/76)',
    utilizacaoReserva: {
      I: 'Absorção de prejuízos (após absorver demais Reservas de Lucros, exceto Reserva Legal)',
      II: 'Aumento do capital social'
    },
    icms: {
      paragrafo4: 'Incentivos e benefícios fiscais de ICMS (Art. 155, II CF) concedidos por Estados/DF são considerados subvenções para investimento, sem exigência de outros requisitos (incluído pela LC 160/2017 — também revogado pela Lei 14.789/2023)',
      nota: 'A Lei 14.789/2023 substituiu este regime por crédito fiscal de subvenção'
    },
    impactoRetencao: 'Subvenções excluídas do lucro real reduziam a base de IRPJ/CSLL devidos → retenções sofridas compensavam contra valores menores → maior probabilidade de saldo credor.',
  },

  // ─────────────────────────────────────────────────────────────────────────
  // 11. PRÊMIO NA EMISSÃO DE DEBÊNTURES (Art. 31 da Lei 12.973)
  // ─────────────────────────────────────────────────────────────────────────
  premioDebentures: {
    artigo: 'Art. 31 da Lei 12.973/2014',
    regra: 'Prêmio na emissão de debêntures NÃO é computado no lucro real, desde que:',
    condicoes: {
      I: 'A titularidade da debênture não seja de sócio/titular com participação ≥ 10% (§5º)',
      II: 'Seja registrado em reserva de lucros específica, para absorção de prejuízos ou aumento de capital'
    },
    tributacao: 'Será tributado se a reserva não for constituída, não for recomposta, ou receber destinação diversa'
  },

  // ─────────────────────────────────────────────────────────────────────────
  // 12. TESTE DE RECUPERABILIDADE (Art. 32 da Lei 12.973)
  // ─────────────────────────────────────────────────────────────────────────
  testeRecuperabilidade: {
    artigo: 'Art. 32 da Lei 12.973/2014',
    regra: 'Valores contabilizados como redução ao valor recuperável (impairment) somente reconhecidos no lucro real quando NÃO revertidos E ocorrer alienação ou baixa do bem',
    unidadeGeradoraCaixa: 'Se o ativo compõe UGC, o valor reconhecido no lucro real é proporcional à relação entre o valor contábil do ativo e o total da UGC na data do teste (parágrafo único)',
    impactoRetencao: 'Impairment não reconhecido no lucro real mantém a base de IRPJ/CSLL mais alta → mais imposto devido → mais espaço para compensar retenções sofridas.',
  },

  // ─────────────────────────────────────────────────────────────────────────
  // 13. DESPESAS PRÉ-OPERACIONAIS (Art. 11 da Lei 12.973)
  // ─────────────────────────────────────────────────────────────────────────
  despresasPreOperacionais: {
    artigo: 'Art. 11 da Lei 12.973/2014',
    regra: 'Despesas de organização pré-operacionais/pré-industriais e de expansão NÃO são computadas no período em que incorridas',
    amortizacao: 'Podem ser excluídas do lucro real em quotas fixas mensais no prazo mínimo de 5 anos a partir do início das operações/atividades',
    impactoRetencao: 'Despesas pré-operacionais não deduzidas imediatamente mantêm a base de IRPJ/CSLL mais alta no curto prazo — retenções sofridas são compensadas mais rapidamente.',
  },

  // ─────────────────────────────────────────────────────────────────────────
  // 14. CONTRATOS DE LONGO PRAZO (Art. 29 da Lei 12.973)
  // ─────────────────────────────────────────────────────────────────────────
  contratosLongoPrazo: {
    artigo: 'Art. 29 da Lei 12.973/2014',
    regra: 'Se o critério contábil de determinação da porcentagem executada for distinto dos previstos no §1º do art. 10 do DL 1.598, e implicar resultado diferente, a diferença deve ser adicionada ou excluída no lucro real',
    impactoRetencao: 'Ajustes de contratos de longo prazo alteram o lucro real do período → afetam a base de IRPJ/CSLL e o saldo de compensação de retenções.',
  },

  // ─────────────────────────────────────────────────────────────────────────
  // 15. INVESTIMENTOS AVALIADOS POR EQUIVALÊNCIA PATRIMONIAL (Arts. 20-25 DL 1.598, alterados)
  // ─────────────────────────────────────────────────────────────────────────
  equivalenciaPatrimonial: {
    artigo: 'Arts. 20 a 25 do DL 1.598/1977 (alterados pela Lei 12.973/2014, art. 2º)',
    desdobramento: {
      descricao: 'Ao adquirir participação avaliada pelo PL, desdobrar o custo em:',
      I: 'Valor patrimonial (PL na proporção da participação)',
      II: 'Mais ou menos-valia (diferença entre valor justo dos ativos líquidos e o valor patrimonial)',
      III: 'Ágio por rentabilidade futura — goodwill (diferença entre custo de aquisição e soma de I + II)'
    },
    laudo: 'Laudo de perito independente deve ser protocolado na RFB ou registrado em Cartório até o último dia útil do 13º mês subsequente à aquisição (§3º do art. 20)',
    ajusteValorJusto: {
      positivo: {
        artigo: 'Art. 24-A do DL 1.598 (incluído pela Lei 12.973)',
        regra: 'Ajuste positivo na participação societária por valor justo de ativo/passivo da investida deve compensar saldo de mais-valia. Ganho excedente computado no lucro real, salvo se evidenciado em subconta.'
      },
      negativo: {
        artigo: 'Art. 24-B do DL 1.598 (incluído pela Lei 12.973)',
        regra: 'Ajuste negativo deve compensar saldo de menos-valia. Perda excedente não computada no lucro real se evidenciada em subconta.'
      }
    },
    resultadoEquivalencia: {
      artigo: 'Art. 23 do DL 1.598 (alterado)',
      regra: 'Contrapartidas de ajuste de investimento ou redução de mais/menos-valia e goodwill de investimentos em sociedades estrangeiras NÃO são computadas no lucro real (parágrafo único)'
    }
  },

  // ─────────────────────────────────────────────────────────────────────────
  // 16. DESPESAS COM EMISSÃO DE AÇÕES E INSTRUMENTOS DE DÍVIDA (Arts. 38-A e 38-B DL 1.598)
  // ─────────────────────────────────────────────────────────────────────────
  despesasEmissaoAcoes: {
    emissaoAcoes: {
      artigo: 'Art. 38-A do DL 1.598/1977 (incluído pela Lei 12.973)',
      regra: 'Custos associados à distribuição primária de ações/bônus de subscrição contabilizados no PL podem ser excluídos na determinação do lucro real quando incorridos'
    },
    instrumentosDivida: {
      artigo: 'Art. 38-B do DL 1.598/1977 (incluído pela Lei 12.973)',
      regra: 'Remuneração, encargos, despesas e custos de instrumentos de capital ou dívida subordinada (exceto ações) contabilizados no PL podem ser excluídos do lucro real e da base da CSLL quando incorridos',
      entidadesFinanceiras: 'Para entidades do §1º do art. 22 da Lei 8.212/91, podem ser excluídos/deduzidos como despesas de intermediação financeira para PIS/COFINS (§1º)',
      estorno: 'Se houver estorno contra PL, valores anteriormente deduzidos devem ser adicionados nas respectivas bases (§3º)'
    }
  },

  // ─────────────────────────────────────────────────────────────────────────
  // 17. MULTAS POR ESCRITURAÇÃO — ECF (Art. 8º-A DL 1.598, incluído pela Lei 12.973)
  // ─────────────────────────────────────────────────────────────────────────
  multasEscrituracao: {
    artigo: 'Art. 8º-A do DL 1.598/1977 (incluído pela Lei 12.973/2014, art. 2º)',
    naoApresentacao: {
      multa: '0,25% por mês-calendário do lucro líquido antes do IR e CSLL, limitada a 10%',
      limites: {
        receitaAte3_6M: 'R$ 100.000,00 (receita bruta ≤ R$ 3.600.000,00)',
        receitaAcima3_6M: 'R$ 5.000.000,00'
      },
      reducoes: {
        ate30dias: '90% de redução',
        ate60dias: '75% de redução',
        antesOficio: '50% de redução',
        emIntimacao: '25% de redução'
      }
    },
    inexatidoes: {
      multa: '3% do valor omitido, inexato ou incorreto (mínimo R$ 100,00)',
      reducoes: {
        antesOficio: 'Não devida se corrigida antes de procedimento de ofício',
        emIntimacao: '50% de redução se corrigida no prazo de intimação'
      }
    },
  },

  // ─────────────────────────────────────────────────────────────────────────
  // 18. ATIVIDADE IMOBILIÁRIA — PERMUTA (Art. 27 DL 1.598, alterado)
  // ─────────────────────────────────────────────────────────────────────────
  atividadeImobiliaria: {
    artigo: 'Art. 27 do DL 1.598/1977, §3º-§4º (incluídos pela Lei 12.973)',
    permuta: 'Lucro bruto de avaliação a valor justo de unidades permutadas é computado no lucro real quando o imóvel recebido for alienado, classificado em investimentos ou imobilizado',
    vendaPrazo: {
      artigo: 'Art. 29 do DL 1.598 (alterado)',
      regra: 'Na venda a prazo, lucro bruto pode ser reconhecido proporcionalmente à receita recebida'
    }
  },

  // ─────────────────────────────────────────────────────────────────────────
  // 19. CUSTO DE AQUISIÇÃO — ATIVO NÃO CIRCULANTE (Art. 15 DL 1.598, alterado)
  // ─────────────────────────────────────────────────────────────────────────
  custoAquisicaoAtivoNC: {
    artigo: 'Art. 15 do DL 1.598/1977 (nova redação pela Lei 12.973)',
    regra: 'Custo de aquisição de bens do ativo não circulante imobilizado e intangível NÃO pode ser deduzido como despesa operacional, SALVO se:',
    excecoes: {
      valorUnitario: 'Valor unitário ≤ R$ 1.200,00',
      vidaUtil: 'Prazo de vida útil ≤ 1 ano'
    },
  },

  // ─────────────────────────────────────────────────────────────────────────
  // 20. JUROS E ENCARGOS DE EMPRÉSTIMOS (Art. 17 DL 1.598, alterado)
  // ─────────────────────────────────────────────────────────────────────────
  jurosEmprestimos: {
    artigo: 'Art. 17 do DL 1.598/1977, §1º-§3º (nova redação pela Lei 12.973)',
    regra: {
      a: 'Juros pagos antecipadamente, descontos de títulos, correção monetária prefixada e deságio devem ser apropriados pro rata tempore (§1º, "a")',
      b: 'Juros e encargos de empréstimos para financiar aquisição/construção/produção de estoques de longa maturação, propriedade para investimentos, ativo imobilizado ou intangível podem ser registrados como custo do ativo, até que estejam prontos para uso/venda (§1º, "b")'
    },
    alternativa: 'Alternativamente, juros e encargos do §1º, "b" podem ser excluídos no lucro real quando incorridos, e adicionados quando o ativo for realizado (§3º)',
    impactoRetencao: 'Se juros forem ativados como custo, a despesa dedutível é adiada → lucro real maior no curto prazo → mais IRPJ/CSLL devidos → maior absorção de retenções sofridas como compensação.'
  },

  // ─────────────────────────────────────────────────────────────────────────
  // CONDOMÍNIOS RESIDENCIAIS (Art. 3º da Lei 12.973)
  // ─────────────────────────────────────────────────────────────────────────
  condominiosResidenciais: {
    artigo: 'Art. 3º da Lei 12.973/2014',
    isencaoIRPF: 'Rendimentos recebidos por condomínios residenciais (Lei 4.591/1964) — isentos de IRPF, limitado a R$ 24.000,00/ano',
    condicoes: [
      'Revertidos em benefício do condomínio para despesas de custeio e extraordinárias',
      'Previstos e autorizados na convenção condominial',
      'Não distribuídos aos condôminos'
    ],
    origens: {
      I: 'Uso, aluguel ou locação de partes comuns',
      II: 'Multas e penalidades por inobservância de regras',
      III: 'Alienação de ativos do condomínio'
    }
  }
};

// ============================================================================
// FUNÇÕES
// ============================================================================

/**
 * 1. Calcular IRRF sobre serviços PJ → PJ (Art. 714-716, 718-719, 723)
 *
 * Art. 714: Serviços profissionais — 1,5%
 * Art. 716: Limpeza/segurança/locação mão-de-obra — 1%
 * Art. 718: Comissões/representação/propaganda — 1,5%
 * Art. 719: Cooperativas de trabalho — 1,5%
 * Art. 723: Assessoria creditícia — 1,5%
 *
 * @param {Object} params
 * @param {number} params.valorBrutoNF - Valor bruto da NF de serviço
 * @param {string} params.tipoServico - 'PROFISSIONAL'|'LIMPEZA_SEGURANCA'|'COMISSAO'|'COOPERATIVA'|'ASSESSORIA_CREDITO'
 * @param {boolean} [params.prestadorSimples=false] - Prestador optante pelo Simples Nacional
 * @param {number} [params.valorRepassadoMidia=0] - Propaganda: valor repassado a rádio/TV/jornal (Art. 718 §1º)
 * @returns {Object} Resultado com IRRF calculado
 */
function calcularIRRFServicoPJ(params) {
  const {
    valorBrutoNF,
    tipoServico,
    prestadorSimples = false,
    valorRepassadoMidia = 0
  } = params;

  // Simples Nacional: dispensado de retenção (LC 123/2006, art. 30, II)
  if (prestadorSimples) {
    return {
      artigo: 'Art. 714-723 c/c LC 123/2006, art. 30',
      valorBrutoNF,
      tipoServico,
      irrfRetido: 0,
      aliquotaAplicada: 0,
      dispensadoSimples: true,
      observacao: 'Prestador optante pelo Simples Nacional — dispensado de retenção IRRF'
    };
  }

  let aliquota, artigo, baseCalculo;

  switch (tipoServico) {
    case 'PROFISSIONAL':
      aliquota = IRRF_SERVICOS_PROFISSIONAIS.aliquota; // 1,5%
      artigo = 'Art. 714';
      baseCalculo = valorBrutoNF;
      break;

    case 'LIMPEZA_SEGURANCA':
      aliquota = IRRF_SERVICOS_LIMPEZA_SEGURANCA.aliquota; // 1%
      artigo = 'Art. 716';
      baseCalculo = valorBrutoNF;
      break;

    case 'COMISSAO':
      aliquota = IRRF_COMISSOES_REPRESENTACAO.aliquota; // 1,5%
      artigo = 'Art. 718';
      baseCalculo = valorBrutoNF - valorRepassadoMidia; // Art. 718 §1º
      break;

    case 'COOPERATIVA':
      aliquota = IRRF_COOPERATIVAS.aliquota; // 1,5%
      artigo = 'Art. 719';
      baseCalculo = valorBrutoNF;
      break;

    case 'ASSESSORIA_CREDITO':
      aliquota = IRRF_ASSESSORIA_CREDITO.aliquota; // 1,5%
      artigo = 'Art. 723';
      baseCalculo = valorBrutoNF;
      break;

    default:
      throw new Error(`Tipo de serviço inválido: ${tipoServico}. Use: PROFISSIONAL, LIMPEZA_SEGURANCA, COMISSAO, COOPERATIVA, ASSESSORIA_CREDITO`);
  }

  if (baseCalculo < 0) baseCalculo = 0;

  const irrfRetido = Math.round(baseCalculo * aliquota * 100) / 100;

  return {
    artigo,
    baseLegal: `${artigo} do RIR/2018`,
    valorBrutoNF,
    tipoServico,
    valorRepassadoMidia: tipoServico === 'COMISSAO' ? valorRepassadoMidia : 0,
    baseCalculo,
    aliquotaAplicada: aliquota,
    aliquotaPercentual: `${(aliquota * 100).toFixed(1)}%`,
    irrfRetido,
    valorLiquido: valorBrutoNF - irrfRetido,
    tratamento: 'Antecipação do IRPJ devido (Art. 717)',
    dispensadoSimples: false,
    codigoDARF: tipoServico === 'LIMPEZA_SEGURANCA' ? '1708' : '1708'
  };
}

/**
 * 2. Calcular CSRF sobre serviços PJ → PJ (Lei 10.833/2003, art. 30)
 *
 * PIS 0,65% + COFINS 3% + CSLL 1% = 4,65% sobre o valor bruto da NF
 *
 * @param {Object} params
 * @param {number} params.valorBrutoNF - Valor bruto da NF
 * @param {boolean} [params.prestadorSimples=false] - Prestador Simples Nacional
 * @param {boolean} [params.serveSujeito=true] - Serviço está na lista sujeita à CSRF
 * @returns {Object} Resultado com PIS/COFINS/CSLL retidos
 */
function calcularCSRF(params) {
  const {
    valorBrutoNF,
    prestadorSimples = false,
    servicoSujeito = true
  } = params;

  // Dispensas
  if (prestadorSimples) {
    return {
      baseLegal: 'Lei 10.833/2003, art. 30 c/c LC 123/2006',
      valorBrutoNF,
      pisRetido: 0, cofinsRetido: 0, csllRetido: 0, totalCSRF: 0,
      dispensado: true,
      motivo: 'Prestador optante pelo Simples Nacional'
    };
  }

  if (!servicoSujeito) {
    return {
      baseLegal: 'Lei 10.833/2003, art. 30',
      valorBrutoNF,
      pisRetido: 0, cofinsRetido: 0, csllRetido: 0, totalCSRF: 0,
      dispensado: true,
      motivo: 'Serviço não sujeito à retenção de CSRF'
    };
  }

  const pisRetido    = Math.round(valorBrutoNF * CSRF.aliquotas.pis    * 100) / 100;
  const cofinsRetido = Math.round(valorBrutoNF * CSRF.aliquotas.cofins * 100) / 100;
  const csllRetido   = Math.round(valorBrutoNF * CSRF.aliquotas.csll   * 100) / 100;
  const totalCSRF    = Math.round((pisRetido + cofinsRetido + csllRetido) * 100) / 100;

  // Dispensa se total ≤ R$ 10,00
  if (totalCSRF <= 10) {
    return {
      baseLegal: 'Lei 10.833/2003, art. 31, §3º',
      valorBrutoNF,
      pisRetido: 0, cofinsRetido: 0, csllRetido: 0, totalCSRF: 0,
      dispensado: true,
      motivo: `Retenção ≤ R$ 10,00 (seria R$ ${totalCSRF.toFixed(2)}) — dispensada`
    };
  }

  return {
    baseLegal: 'Lei 10.833/2003, art. 30',
    valorBrutoNF,
    baseCalculo: valorBrutoNF,
    pisRetido,
    cofinsRetido,
    csllRetido,
    totalCSRF,
    aliquotas: {
      pis: '0,65%',
      cofins: '3,00%',
      csll: '1,00%',
      total: '4,65%'
    },
    valorLiquido: Math.round((valorBrutoNF - totalCSRF) * 100) / 100,
    tratamento: {
      pis: 'Compensável com PIS devido',
      cofins: 'Compensável com COFINS devida',
      csll: 'Compensável com CSLL devida'
    },
    dispensado: false,
    codigosDARF: CSRF.codigoDARF,
    prazo: CSRF.prazoRecolhimento
  };
}

/**
 * 3. Calcular IRRF sobre rendimentos PF — Tabela Progressiva (Art. 677)
 *
 * Aplica-se a: salários, pro-labore (Art. 699), aluguéis PJ→PF (Art. 688),
 * trabalho não-assalariado (Art. 685), e demais rendimentos (Art. 701).
 *
 * @param {Object} params
 * @param {number} params.rendimentoBruto - Rendimento bruto mensal
 * @param {number} [params.inss=0] - Contribuição INSS descontada
 * @param {number} [params.dependentes=0] - Número de dependentes
 * @param {number} [params.pensaoAlimenticia=0] - Pensão alimentícia judicial (Art. 709)
 * @param {number} [params.previdenciaPrivada=0] - Previdência privada (Art. 710)
 * @param {string} [params.tabelaRef='2025'] - Tabela de referência: '2025', '2023', '2015'
 * @param {string} [params.tipoRendimento='SALARIO'] - 'SALARIO'|'PRO_LABORE'|'ALUGUEL'|'AUTONOMO'|'13_SALARIO'
 * @returns {Object} Resultado com IRRF calculado
 */
function calcularIRRFPessoaFisica(params) {
  const {
    rendimentoBruto,
    inss = 0,
    dependentes = 0,
    pensaoAlimenticia = 0,
    previdenciaPrivada = 0,
    tabelaRef = '2025',
    tipoRendimento = 'SALARIO'
  } = params;

  // Selecionar tabela
  let tabela, deducaoDep;
  switch (tabelaRef) {
    case '2025':
      tabela = TABELAS_IRPF.tabela_2025;
      deducaoDep = TABELAS_IRPF.deducaoDependente_2025;
      break;
    case '2023':
      tabela = TABELAS_IRPF.tabela_2023;
      deducaoDep = TABELAS_IRPF.deducaoDependente_2023;
      break;
    case '2015':
      tabela = TABELAS_IRPF.tabela_2015;
      deducaoDep = TABELAS_IRPF.deducaoDependente_2015;
      break;
    default:
      tabela = TABELAS_IRPF.tabela_2025;
      deducaoDep = TABELAS_IRPF.deducaoDependente_2025;
  }

  // Deduções (Art. 707-711)
  const deducaoINSS = inss;
  const deducaoDependentes = dependentes * deducaoDep;
  const deducaoPensao = pensaoAlimenticia;
  const deducaoPrevidenciaPrivada = previdenciaPrivada;

  const totalDeducoes = deducaoINSS + deducaoDependentes + deducaoPensao + deducaoPrevidenciaPrivada;

  // Base de cálculo (Art. 712)
  const baseCalculo = Math.max(rendimentoBruto - totalDeducoes, 0);

  // Desconto simplificado — MP 1.294/2025 e Lei 14.663/2023
  // Contribuinte pode optar pelo desconto simplificado de R$ 564,80 (2023) / R$ 607,20 (2025)
  // ao invés das deduções legais. O motor compara e usa o mais vantajoso.
  let descontoSimplificado = 0;
  if (tabelaRef === '2025') descontoSimplificado = 607.20;
  else if (tabelaRef === '2023') descontoSimplificado = 564.80;

  const baseCalcSimplificado = Math.max(rendimentoBruto - descontoSimplificado, 0);
  const usarSimplificado = (descontoSimplificado > 0 && baseCalcSimplificado < baseCalculo);
  const baseEfetiva = usarSimplificado ? baseCalcSimplificado : baseCalculo;

  // Aplicar tabela progressiva
  let aliquotaEfetiva = 0;
  let deducaoImposto = 0;
  let faixaAplicada = 1;

  for (const faixa of tabela) {
    if (baseEfetiva <= (faixa.ate || Infinity)) {
      aliquotaEfetiva = faixa.aliquota;
      deducaoImposto = faixa.deducao;
      faixaAplicada = faixa.faixa;
      break;
    }
  }

  let irrfCalculado = Math.round((baseEfetiva * aliquotaEfetiva - deducaoImposto) * 100) / 100;
  if (irrfCalculado < 0) irrfCalculado = 0;

  // Artigo de referência conforme tipo
  let artigo;
  switch (tipoRendimento) {
    case 'SALARIO':     artigo = 'Art. 681 c/c Art. 677'; break;
    case 'PRO_LABORE':  artigo = 'Art. 699 c/c Art. 677'; break;
    case 'ALUGUEL':     artigo = 'Art. 688 c/c Art. 677'; break;
    case 'AUTONOMO':    artigo = 'Art. 685 c/c Art. 677'; break;
    case '13_SALARIO':  artigo = 'Art. 700 c/c Art. 677'; break;
    default:            artigo = 'Art. 701 c/c Art. 677';
  }

  return {
    artigo,
    tipoRendimento,
    tabelaRef,
    rendimentoBruto,
    deducoes: {
      inss: deducaoINSS,
      dependentes: deducaoDependentes,
      qtdDependentes: dependentes,
      valorPorDependente: deducaoDep,
      pensaoAlimenticia: deducaoPensao,
      previdenciaPrivada: deducaoPrevidenciaPrivada,
      totalDeducoes
    },
    descontoSimplificado: usarSimplificado ? descontoSimplificado : 0,
    metodoUsado: usarSimplificado ? 'SIMPLIFICADO' : 'DEDUCOES_LEGAIS',
    baseCalculo: baseEfetiva,
    faixaAplicada,
    aliquotaEfetiva: `${(aliquotaEfetiva * 100).toFixed(1)}%`,
    deducaoImposto,
    irrfRetido: irrfCalculado,
    rendimentoLiquido: Math.round((rendimentoBruto - inss - irrfCalculado) * 100) / 100,
    tratamento: tipoRendimento === '13_SALARIO'
      ? 'Tributação exclusiva na fonte, separada (Art. 700, III)'
      : 'Antecipação do IR devido na DIRPF (Art. 677 §3º)'
  };
}

/**
 * 4. Calcular IRRF sobre pagamentos pela Administração Pública (Art. 720-722)
 *
 * Método: 15% sobre (valor × percentual presunção por atividade)
 *
 * @param {Object} params
 * @param {number} params.valorPago - Valor pago pelo órgão público
 * @param {string} params.tipoReceita - 'SERVICOS'|'COMERCIO'|'TRANSPORTE_CARGA'|'HOSPITALAR'|'COMBUSTIVEIS'
 * @param {boolean} [params.prestadorSimples=false]
 * @returns {Object}
 */
function calcularIRRFAdmPublica(params) {
  const {
    valorPago,
    tipoReceita,
    prestadorSimples = false
  } = params;

  // Simples: dispensado (Art. 720 §6º)
  if (prestadorSimples) {
    return {
      artigo: 'Art. 720 §6º',
      valorPago,
      irrfRetido: 0,
      dispensado: true,
      motivo: 'Optante Simples Nacional — dispensado (LC 123/2006, art. 13)'
    };
  }

  const percentuais = IRRF_ADMINISTRACAO_PUBLICA.percentuaisPresuncao;
  let percPresuncao;

  switch (tipoReceita) {
    case 'SERVICOS':           percPresuncao = percentuais.servicos_geral;      break;
    case 'COMERCIO':           percPresuncao = percentuais.comercio;             break;
    case 'TRANSPORTE_CARGA':   percPresuncao = percentuais.transporte_carga;     break;
    case 'HOSPITALAR':         percPresuncao = percentuais.servicos_hospitalar;  break;
    case 'COMBUSTIVEIS':       percPresuncao = percentuais.combustiveis;         break;
    default:                   percPresuncao = percentuais.servicos_geral;
  }

  const basePresumida = Math.round(valorPago * percPresuncao * 100) / 100;
  const irrfRetido = Math.round(basePresumida * 0.15 * 100) / 100;

  // Dispensa se ≤ R$ 10,00
  if (irrfRetido <= 10) {
    return {
      artigo: 'Art. 720 c/c Art. 721 §3º',
      valorPago,
      irrfRetido: 0,
      dispensado: true,
      motivo: `Retenção ≤ R$ 10,00 (seria R$ ${irrfRetido.toFixed(2)}) — dispensada`
    };
  }

  const aliquotaEfetiva = percPresuncao * 0.15;

  return {
    artigo: 'Art. 720-722',
    baseLegal: 'Lei 9.430/1996, art. 64',
    valorPago,
    tipoReceita,
    percentualPresuncao: `${(percPresuncao * 100).toFixed(1)}%`,
    basePresumida,
    aliquotaIRPJ: '15%',
    aliquotaEfetiva: `${(aliquotaEfetiva * 100).toFixed(2)}%`,
    irrfRetido,
    valorLiquido: valorPago - irrfRetido,
    tratamento: 'Antecipação do IRPJ devido (Art. 720 §3º)',
    dispensado: false,
    prazoRecolhimento: IRRF_ADMINISTRACAO_PUBLICA.prazoRecolhimento
  };
}

/**
 * 5. Calcular retenção total sobre NF de serviço (IRRF + CSRF + ISS)
 *
 * Visão integrada: quanto efetivamente o prestador recebe líquido
 * e quais créditos tributários gera.
 *
 * @param {Object} params
 * @param {number} params.valorBrutoNF - Valor bruto da NF
 * @param {string} params.tipoServico - Tipo do serviço para IRRF
 * @param {boolean} [params.prestadorSimples=false]
 * @param {boolean} [params.retencaoISS=false] - Se há retenção de ISS
 * @param {number} [params.aliquotaISS=0.05] - Alíquota ISS municipal
 * @param {boolean} [params.tomadorAdmPublica=false] - Se tomador é órgão público
 * @param {string} [params.tipoReceitaAdmPublica='SERVICOS'] - Tipo receita se Adm. Pública
 * @returns {Object} Consolidação de todas as retenções
 */
function calcularRetencaoIntegrada(params) {
  const {
    valorBrutoNF,
    tipoServico,
    prestadorSimples = false,
    retencaoISS = false,
    aliquotaISS = 0.05,
    tomadorAdmPublica = false,
    tipoReceitaAdmPublica = 'SERVICOS'
  } = params;

  // IRRF sobre serviço PJ
  let irrf;
  if (tomadorAdmPublica && !prestadorSimples) {
    // Adm. Pública: método do Art. 720 (substitui demais retenções IRRF — Art. 720 §5º)
    irrf = calcularIRRFAdmPublica({
      valorPago: valorBrutoNF,
      tipoReceita: tipoReceitaAdmPublica,
      prestadorSimples
    });
  } else {
    irrf = calcularIRRFServicoPJ({
      valorBrutoNF,
      tipoServico,
      prestadorSimples
    });
  }

  // CSRF (PIS/COFINS/CSLL retidos)
  const csrf = calcularCSRF({
    valorBrutoNF,
    prestadorSimples,
    servicoSujeito: true
  });

  // ISS retido
  let issRetido = 0;
  if (retencaoISS && !prestadorSimples) {
    issRetido = Math.round(valorBrutoNF * aliquotaISS * 100) / 100;
  }

  // Totais
  const totalRetencoes = Math.round((
    irrf.irrfRetido +
    csrf.totalCSRF +
    issRetido
  ) * 100) / 100;

  const valorLiquido = Math.round((valorBrutoNF - totalRetencoes) * 100) / 100;
  const percentualRetencao = valorBrutoNF > 0
    ? Math.round((totalRetencoes / valorBrutoNF) * 10000) / 100
    : 0;

  return {
    descricao: 'Retenção integrada sobre NF de serviço',
    valorBrutoNF,
    tipoServico,
    prestadorSimples,
    tomadorAdmPublica,

    irrf: {
      base: irrf.baseCalculo || irrf.basePresumida || 0,
      aliquota: irrf.aliquotaAplicada || irrf.aliquotaEfetiva || '0%',
      valor: irrf.irrfRetido,
      artigo: irrf.artigo
    },

    csrf: {
      pis: csrf.pisRetido,
      cofins: csrf.cofinsRetido,
      csll: csrf.csllRetido,
      total: csrf.totalCSRF,
      dispensado: csrf.dispensado
    },

    iss: {
      aliquota: retencaoISS ? `${(aliquotaISS * 100).toFixed(1)}%` : 'N/A',
      valor: issRetido,
      retido: retencaoISS
    },

    resumo: {
      totalRetencoes,
      percentualRetencao: `${percentualRetencao.toFixed(2)}%`,
      valorLiquido,
      creditosTributarios: {
        irpj: irrf.irrfRetido,
        pis: csrf.pisRetido,
        cofins: csrf.cofinsRetido,
        csll: csrf.csllRetido,
        iss: issRetido,
        nota: 'IRRF/PIS/COFINS/CSLL são antecipações compensáveis; ISS é tributo municipal'
      }
    }
  };
}

/**
 * 6. Calcular IRRF sobre JCP (Art. 726)
 *
 * @param {Object} params
 * @param {number} params.valorJCP - Valor dos juros sobre capital próprio
 * @param {string} [params.tipoBeneficiario='PJ_LUCRO_REAL'] - Tipo do beneficiário
 * @returns {Object}
 */
function calcularIRRFJCP(params) {
  const {
    valorJCP,
    tipoBeneficiario = 'PJ_LUCRO_REAL'
  } = params;

  const irrfRetido = Math.round(valorJCP * IRRF_JCP.aliquota * 100) / 100;

  let tratamento;
  switch (tipoBeneficiario) {
    case 'PJ_LUCRO_REAL':
    case 'PJ_LUCRO_PRESUMIDO':
    case 'PJ_LUCRO_ARBITRADO':
      tratamento = 'Antecipação do IRPJ devido (Art. 726 §1º, I)';
      break;
    case 'PJ_ISENTA':
    case 'PF':
    default:
      tratamento = 'Tributação definitiva (Art. 726 §1º, II)';
  }

  return {
    artigo: 'Art. 726',
    baseLegal: 'Lei 9.249/1995, art. 9º, §2º',
    valorJCP,
    aliquota: '15%',
    irrfRetido,
    valorLiquido: valorJCP - irrfRetido,
    tipoBeneficiario,
    tratamento,
    codigoDARF: '5706'
  };
}

/**
 * 7. Calcular folha de pagamento com retenções (IRRF + INSS)
 *
 * Calcula IRRF individual de cada funcionário + totais da folha.
 * Exemplo: ~R$ 1M/ano de folha ≈ ~R$ 83.333/mês
 *
 * @param {Object} params
 * @param {Array<Object>} params.funcionarios - Lista de funcionários
 *   Cada: { nome, salarioBruto, dependentes, pensaoAlimenticia, previdenciaPrivada, tipo }
 * @param {string} [params.tabelaRef='2025']
 * @returns {Object} Resultado com IRRF por funcionário e totais
 */
function calcularFolhaPagamento(params) {
  const { funcionarios, tabelaRef = '2025' } = params;

  // Faixas INSS 2025 (aproximadas — verificar IN RFB vigente)
  const faixasINSS = [
    { ate: 1518.00,  aliquota: 0.075  },
    { ate: 2793.88,  aliquota: 0.09   },
    { ate: 4190.83,  aliquota: 0.12   },
    { ate: 8157.41,  aliquota: 0.14   }
  ];

  function calcularINSS(salario) {
    let inss = 0;
    let anterior = 0;
    for (const faixa of faixasINSS) {
      const base = Math.min(salario, faixa.ate) - anterior;
      if (base <= 0) break;
      inss += base * faixa.aliquota;
      anterior = faixa.ate;
    }
    return Math.round(inss * 100) / 100;
  }

  const resultados = funcionarios.map(func => {
    const inss = calcularINSS(func.salarioBruto);

    const irrf = calcularIRRFPessoaFisica({
      rendimentoBruto: func.salarioBruto,
      inss,
      dependentes: func.dependentes || 0,
      pensaoAlimenticia: func.pensaoAlimenticia || 0,
      previdenciaPrivada: func.previdenciaPrivada || 0,
      tabelaRef,
      tipoRendimento: func.tipo || 'SALARIO'
    });

    return {
      nome: func.nome,
      salarioBruto: func.salarioBruto,
      tipo: func.tipo || 'SALARIO',
      inssDescontado: inss,
      irrfRetido: irrf.irrfRetido,
      baseCalculoIRRF: irrf.baseCalculo,
      faixaIRRF: irrf.faixaAplicada,
      aliquotaIRRF: irrf.aliquotaEfetiva,
      metodoIRRF: irrf.metodoUsado,
      salarioLiquido: Math.round((func.salarioBruto - inss - irrf.irrfRetido) * 100) / 100
    };
  });

  const totais = resultados.reduce((acc, r) => ({
    totalBruto: acc.totalBruto + r.salarioBruto,
    totalINSS: acc.totalINSS + r.inssDescontado,
    totalIRRF: acc.totalIRRF + r.irrfRetido,
    totalLiquido: acc.totalLiquido + r.salarioLiquido
  }), { totalBruto: 0, totalINSS: 0, totalIRRF: 0, totalLiquido: 0 });

  // Arredondar totais
  Object.keys(totais).forEach(k => totais[k] = Math.round(totais[k] * 100) / 100);

  // Encargos patronais (INSS 20% + RAT 2% + Terceiros 5,8% = 27,8% — simplificado)
  const inssPatronal = Math.round(totais.totalBruto * 0.20 * 100) / 100;
  const rat = Math.round(totais.totalBruto * 0.02 * 100) / 100;
  const terceiros = Math.round(totais.totalBruto * 0.058 * 100) / 100;

  return {
    descricao: 'Folha de pagamento com retenções — Art. 677/699/681',
    tabelaRef,
    quantidadeFuncionarios: funcionarios.length,
    funcionarios: resultados,
    totais,
    encargosPatronais: {
      inssPatronal,
      rat,
      terceiros,
      fgts: Math.round(totais.totalBruto * 0.08 * 100) / 100,
      totalEncargos: Math.round((inssPatronal + rat + terceiros + totais.totalBruto * 0.08) * 100) / 100
    },
    custoTotalEmpregador: Math.round((
      totais.totalBruto +
      inssPatronal + rat + terceiros +
      totais.totalBruto * 0.08
    ) * 100) / 100
  };
}

/**
 * 8. Controlar saldo de retenções para compensação no período
 *
 * Consolida IRRF/PIS/COFINS/CSLL retidos sobre a empresa (quando a empresa é prestadora)
 * e calcula quanto pode ser compensado com os tributos devidos.
 *
 * @param {Object} params
 * @param {Object} params.retencoesSofridas - { irrf, pis, cofins, csll }
 * @param {Object} params.tributosDevidos - { irpj, csll, pis, cofins }
 * @returns {Object} Saldo de compensação
 */
function compensarRetencoes(params) {
  const { retencoesSofridas, tributosDevidos } = params;

  // IRRF compensa somente com IRPJ (Art. 717, 720 §4º)
  const irrfCompensavel = Math.min(retencoesSofridas.irrf || 0, tributosDevidos.irpj || 0);
  const saldoIRRF = Math.round(((retencoesSofridas.irrf || 0) - irrfCompensavel) * 100) / 100;

  // PIS retido compensa com PIS devido
  const pisCompensavel = Math.min(retencoesSofridas.pis || 0, tributosDevidos.pis || 0);
  const saldoPIS = Math.round(((retencoesSofridas.pis || 0) - pisCompensavel) * 100) / 100;

  // COFINS retida compensa com COFINS devida
  const cofinsCompensavel = Math.min(retencoesSofridas.cofins || 0, tributosDevidos.cofins || 0);
  const saldoCOFINS = Math.round(((retencoesSofridas.cofins || 0) - cofinsCompensavel) * 100) / 100;

  // CSLL retida compensa com CSLL devida
  const csllCompensavel = Math.min(retencoesSofridas.csll || 0, tributosDevidos.csll || 0);
  const saldoCSLL = Math.round(((retencoesSofridas.csll || 0) - csllCompensavel) * 100) / 100;

  const totalCompensado = Math.round((irrfCompensavel + pisCompensavel + cofinsCompensavel + csllCompensavel) * 100) / 100;
  const totalSaldoCredor = Math.round((saldoIRRF + saldoPIS + saldoCOFINS + saldoCSLL) * 100) / 100;

  return {
    descricao: 'Compensação de retenções sofridas com tributos devidos',
    baseLegal: 'Art. 717 (IRRF); Lei 10.833/2003, art. 36 (CSRF)',

    retencoesSofridas: {
      irrf: retencoesSofridas.irrf || 0,
      pis: retencoesSofridas.pis || 0,
      cofins: retencoesSofridas.cofins || 0,
      csll: retencoesSofridas.csll || 0,
      total: Math.round(((retencoesSofridas.irrf || 0) + (retencoesSofridas.pis || 0) +
             (retencoesSofridas.cofins || 0) + (retencoesSofridas.csll || 0)) * 100) / 100
    },

    tributosDevidos: {
      irpj: tributosDevidos.irpj || 0,
      csll: tributosDevidos.csll || 0,
      pis: tributosDevidos.pis || 0,
      cofins: tributosDevidos.cofins || 0,
      total: Math.round(((tributosDevidos.irpj || 0) + (tributosDevidos.csll || 0) +
             (tributosDevidos.pis || 0) + (tributosDevidos.cofins || 0)) * 100) / 100
    },

    compensacao: {
      irrf_com_irpj: irrfCompensavel,
      pis_com_pis: pisCompensavel,
      cofins_com_cofins: cofinsCompensavel,
      csll_com_csll: csllCompensavel,
      totalCompensado
    },

    tributosARecolher: {
      irpj: Math.round(((tributosDevidos.irpj || 0) - irrfCompensavel) * 100) / 100,
      csll: Math.round(((tributosDevidos.csll || 0) - csllCompensavel) * 100) / 100,
      pis: Math.round(((tributosDevidos.pis || 0) - pisCompensavel) * 100) / 100,
      cofins: Math.round(((tributosDevidos.cofins || 0) - cofinsCompensavel) * 100) / 100,
      total: Math.round((
        (tributosDevidos.irpj || 0) - irrfCompensavel +
        (tributosDevidos.csll || 0) - csllCompensavel +
        (tributosDevidos.pis || 0) - pisCompensavel +
        (tributosDevidos.cofins || 0) - cofinsCompensavel
      ) * 100) / 100
    },

    saldoCredor: {
      irrf: saldoIRRF,
      pis: saldoPIS,
      cofins: saldoCOFINS,
      csll: saldoCSLL,
      total: totalSaldoCredor,
      destinacao: totalSaldoCredor > 0
        ? 'Saldo credor pode ser compensado em períodos seguintes via PER/DCOMP ou pedido de restituição'
        : 'Sem saldo credor'
    }
  };
}

/**
 * 9. Simular impacto das retenções na migração Simples → Lucro Real
 *
 * No Simples Nacional, a empresa NÃO sofre retenções (LC 123/2006).
 * Ao migrar para Lucro Real, passa a sofrer IRRF 1,5% + CSRF 4,65% + ISS
 * sobre TODAS as NFs emitidas.
 *
 * @param {Object} params
 * @param {number} params.receitaAnualServicos - Receita anual de serviços
 * @param {number} params.percentualPJ - % da receita vinda de PJ (que retém)
 * @param {number} params.percentualAdmPublica - % da receita de órgãos públicos
 * @param {number} params.percentualRetencaoISS - % da receita com retenção ISS
 * @param {number} [params.aliquotaISS=0.05]
 * @returns {Object} Projeção de retenções anuais
 */
function simularRetencoesAnuais(params) {
  const {
    receitaAnualServicos,
    percentualPJ,
    percentualAdmPublica,
    percentualRetencaoISS,
    aliquotaISS = 0.05
  } = params;

  // Receita segmentada
  const receitaPJ = receitaAnualServicos * (percentualPJ / 100);
  const receitaAdmPublica = receitaAnualServicos * (percentualAdmPublica / 100);
  const receitaPJPrivada = receitaPJ - receitaAdmPublica;
  const receitaPF = receitaAnualServicos - receitaPJ;

  // IRRF sobre serviços PJ privada (1,5%)
  const irrfPJPrivada = Math.round(receitaPJPrivada * 0.015 * 100) / 100;

  // IRRF sobre serviços Adm. Pública (4,8% efetivo para serviços)
  const irrfAdmPublica = Math.round(receitaAdmPublica * 0.048 * 100) / 100;

  // CSRF sobre PJ (4,65%) — inclui Adm. Pública
  const csrfTotal = Math.round(receitaPJ * 0.0465 * 100) / 100;

  // ISS retido
  const receitaComRetencaoISS = receitaAnualServicos * (percentualRetencaoISS / 100);
  const issRetido = Math.round(receitaComRetencaoISS * aliquotaISS * 100) / 100;

  const totalRetencoesAnuais = Math.round((irrfPJPrivada + irrfAdmPublica + csrfTotal + issRetido) * 100) / 100;

  return {
    descricao: 'Projeção anual de retenções na fonte — cenário Lucro Real',
    receitaAnualServicos,

    segmentacao: {
      receitaPJTotal: receitaPJ,
      receitaPJPrivada,
      receitaAdmPublica,
      receitaPF,
      receitaComRetencaoISS
    },

    retencoes: {
      irrfPJPrivada: {
        aliquota: '1,5%',
        valor: irrfPJPrivada
      },
      irrfAdmPublica: {
        aliquota: '4,8% efetivo',
        valor: irrfAdmPublica
      },
      csrf: {
        aliquota: '4,65%',
        valor: csrfTotal,
        detalhe: {
          pis: Math.round(receitaPJ * 0.0065 * 100) / 100,
          cofins: Math.round(receitaPJ * 0.03 * 100) / 100,
          csll: Math.round(receitaPJ * 0.01 * 100) / 100
        }
      },
      issRetido: {
        aliquota: `${(aliquotaISS * 100).toFixed(1)}%`,
        valor: issRetido
      }
    },

    totalRetencoesAnuais,
    percentualRetencaoMedio: `${((totalRetencoesAnuais / receitaAnualServicos) * 100).toFixed(2)}%`,

    impactoCaixaMensal: {
      retencaoMediaMensal: Math.round(totalRetencoesAnuais / 12 * 100) / 100,
      nota: 'Retenções são antecipações — compensam no período. Impacto é no fluxo de caixa (timing), não no custo.'
    },

    comparacaoSimples: {
      simplesNacional: 'ZERO retenções (LC 123/2006)',
      lucroReal: `R$ ${totalRetencoesAnuais.toFixed(2)}/ano retidos antecipadamente`,
      diferenca: `Impacto de caixa: R$ ${Math.round(totalRetencoesAnuais / 12).toFixed(2)}/mês`,
      observacao: 'As retenções NÃO são custo adicional — são CRÉDITOS que reduzem o imposto a pagar. O impacto é apenas de timing no fluxo de caixa.'
    }
  };
}

/**
 * 10. Gerar relatório consolidado de retenções — Bloco G
 *
 * @param {Object} params
 * @param {Object} [params.retencaoNF] - Resultado de calcularRetencaoIntegrada
 * @param {Object} [params.folha] - Resultado de calcularFolhaPagamento
 * @param {Object} [params.compensacao] - Resultado de compensarRetencoes
 * @param {Object} [params.projecao] - Resultado de simularRetencoesAnuais
 * @returns {Object}
 */
function gerarRelatorioG(params) {
  const { retencaoNF, folha, compensacao, projecao } = params;

  const resultado = {
    bloco: 'G — Retenções na Fonte',
    baseLegal: 'Art. 714-749 do RIR/2018; Lei 10.833/2003, art. 30-36; LC 116/2003',
    dataGeracao: new Date().toISOString(),
    secoes: {}
  };

  if (retencaoNF) {
    resultado.secoes.retencaoNF = {
      valorBruto: retencaoNF.valorBrutoNF,
      irrf: retencaoNF.irrf.valor,
      csrf: retencaoNF.csrf.total,
      iss: retencaoNF.iss.valor,
      totalRetencoes: retencaoNF.resumo.totalRetencoes,
      percentual: retencaoNF.resumo.percentualRetencao,
      valorLiquido: retencaoNF.resumo.valorLiquido
    };
  }

  if (folha) {
    resultado.secoes.folha = {
      qtdFuncionarios: folha.quantidadeFuncionarios,
      totalBruto: folha.totais.totalBruto,
      totalINSS: folha.totais.totalINSS,
      totalIRRF: folha.totais.totalIRRF,
      totalLiquido: folha.totais.totalLiquido,
      custoTotal: folha.custoTotalEmpregador
    };
  }

  if (compensacao) {
    resultado.secoes.compensacao = {
      totalRetencoesSofridas: compensacao.retencoesSofridas.total,
      totalCompensado: compensacao.compensacao.totalCompensado,
      totalARecolher: compensacao.tributosARecolher.total,
      saldoCredor: compensacao.saldoCredor.total
    };
  }

  if (projecao) {
    resultado.secoes.projecao = {
      receitaAnual: projecao.receitaAnualServicos,
      totalRetencoesAnuais: projecao.totalRetencoesAnuais,
      percentualMedio: projecao.percentualRetencaoMedio,
      impactoCaixaMensal: projecao.impactoCaixaMensal.retencaoMediaMensal
    };
  }

  // Obrigações acessórias relacionadas
  resultado.obrigacoesAcessorias = {
    DIRF: 'Declaração do Imposto sobre a Renda Retido na Fonte — anual (substituída pela EFD-Reinf a partir de 2024)',
    EFDReinf: 'Escrituração Fiscal Digital de Retenções — série R-4000 (eventos de retenções)',
    DCTFWeb: 'Declaração de Débitos e Créditos Tributários Federais — mensal (confissão de débito)',
    DARF: 'Documento de Arrecadação de Receitas Federais — recolhimento das retenções',
    eSocial: 'Retenções sobre folha (IRRF PF) informadas nos eventos S-1200/S-1210',
    prazos: {
      irrfPJ: 'Até o último dia útil do 2º decêndio do mês subsequente',
      irrfPF_folha: 'Até o dia 20 do mês subsequente (antecipado se não for dia útil)',
      csrf: 'Até o último dia útil do 2º decêndio do mês subsequente',
      issRetido: 'Conforme legislação municipal — geralmente até dia 15 do mês seguinte'
    }
  };

  return resultado;
}

// ============================================================================
// FUNÇÕES — LEI 12.973/2014
// ============================================================================

/**
 * 11. Calcular JCP com base nas contas do PL definidas pela Lei 12.973
 *
 * Art. 9º, §8º da Lei 9.249/1995 (redação Lei 12.973): somente capital social,
 * reservas de capital, reservas de lucros, ações em tesouraria e prejuízos acumulados.
 *
 * @param {Object} params
 * @param {number} params.capitalSocial - Capital social (inclui ações em passivo — §12)
 * @param {number} [params.reservasCapital=0]
 * @param {number} [params.reservasLucros=0]
 * @param {number} [params.acoesEmTesouraria=0] - Valor positivo (será deduzido)
 * @param {number} [params.prejuizosAcumulados=0] - Valor positivo (será deduzido)
 * @param {number} params.taxaTJLP - Taxa TJLP/TLP do período (decimal, ex: 0.0612 para 6,12% a.a.)
 * @param {string} [params.tipoBeneficiario='PJ_LUCRO_REAL']
 * @returns {Object} JCP calculado com IRRF e base legal Lei 12.973
 */
function calcularJCPLei12973(params) {
  const {
    capitalSocial,
    reservasCapital = 0,
    reservasLucros = 0,
    acoesEmTesouraria = 0,
    prejuizosAcumulados = 0,
    taxaTJLP,
    tipoBeneficiario = 'PJ_LUCRO_REAL'
  } = params;

  // Base do PL para JCP conforme §8º do Art. 9º Lei 9.249 (redação Lei 12.973)
  const basePL = capitalSocial + reservasCapital + reservasLucros - acoesEmTesouraria - prejuizosAcumulados;

  if (basePL <= 0) {
    return {
      artigo: 'Art. 9º da Lei 9.249/1995 c/c Lei 12.973/2014',
      basePL: 0,
      jcpCalculado: 0,
      irrfRetido: 0,
      observacao: 'PL negativo ou zero — JCP não pode ser calculado'
    };
  }

  // JCP = PL × TJLP (limitado a 50% do lucro líquido do exercício ou 50% dos lucros acumulados)
  const jcpCalculado = Math.round(basePL * taxaTJLP * 100) / 100;
  const irrfRetido = Math.round(jcpCalculado * CONSTANTES.JCP_IRRF_ALIQUOTA * 100) / 100;

  let tratamento;
  switch (tipoBeneficiario) {
    case 'PJ_LUCRO_REAL':
    case 'PJ_LUCRO_PRESUMIDO':
      tratamento = 'Antecipação do IRPJ devido (Art. 726 §1º, I)';
      break;
    default:
      tratamento = 'Tributação definitiva (Art. 726 §1º, II)';
  }

  const economiaIRPJ = Math.round(jcpCalculado * (CONSTANTES.IRPJ_ALIQUOTA_NORMAL + CONSTANTES.IRPJ_ALIQUOTA_ADICIONAL) * 100) / 100;
  const economiaCSLL = Math.round(jcpCalculado * CONSTANTES.CSLL_ALIQUOTA_GERAL * 100) / 100;
  const economiaTotal = Math.round((economiaIRPJ + economiaCSLL) * 100) / 100;

  return {
    artigo: 'Art. 9º da Lei 9.249/1995 c/c Lei 12.973/2014, art. 9º (§§8º-12)',
    composicaoPL: {
      capitalSocial,
      reservasCapital,
      reservasLucros,
      acoesEmTesouraria: -acoesEmTesouraria,
      prejuizosAcumulados: -prejuizosAcumulados,
      basePL
    },
    taxaTJLP: `${(taxaTJLP * 100).toFixed(2)}% a.a.`,
    jcpCalculado,
    limites: {
      nota: 'JCP limitado a 50% do lucro líquido do exercício OU 50% dos lucros acumulados e reservas de lucros (o maior) — validar externamente',
      referencia: 'Art. 9º, §1º da Lei 9.249/1995'
    },
    irrfRetido,
    aliquotaIRRF: `${(CONSTANTES.JCP_IRRF_ALIQUOTA * 100).toFixed(1)}%`,
    jcpLiquido: Math.round((jcpCalculado - irrfRetido) * 100) / 100,
    tipoBeneficiario,
    tratamento,
    deducaoIRPJ: 'JCP é DESPESA DEDUTÍVEL do lucro real e da base da CSLL (Art. 9º, §11)',
    codigoDARF: '5706',
    impactoFiscal: {
      deducaoLucroReal: jcpCalculado,
      economiaIRPJ,
      economiaCSLL,
      economiaTotal,
      custoIRRF: irrfRetido,
      beneficioLiquido: Math.round((economiaTotal - irrfRetido) * 100) / 100,
      nota: `Benefício líquido = economia tributária (${((CONSTANTES.IRPJ_ALIQUOTA_NORMAL + CONSTANTES.IRPJ_ALIQUOTA_ADICIONAL + CONSTANTES.CSLL_ALIQUOTA_GERAL) * 100).toFixed(0)}%) - custo IRRF retido (${(CONSTANTES.JCP_IRRF_ALIQUOTA * 100).toFixed(1)}%) — LC 224/2025`
    }
  };
}

/**
 * 12. Analisar impacto dos ajustes da Lei 12.973 na compensação de retenções
 *
 * Consolida como os diversos ajustes da Lei 12.973 (valor justo, goodwill,
 * mais/menos-valia, subvenções, pré-operacionais) afetam o lucro real
 * e, consequentemente, o saldo de compensação de retenções sofridas.
 *
 * @param {Object} params
 * @param {number} params.lucroRealAntes - Lucro real ANTES dos ajustes Lei 12.973
 * @param {Object} [params.ajustes] - Ajustes da Lei 12.973
 * @param {number} [params.ajustes.ganhoValorJusto=0] - Ganho diferido por subconta (Art. 13)
 * @param {number} [params.ajustes.perdaValorJusto=0] - Perda diferida por subconta (Art. 14)
 * @param {number} [params.ajustes.amortizacaoGoodwill=0] - Goodwill amortizado no período (Art. 22, 1/60 avos)
 * @param {number} [params.ajustes.maisValiaRealizada=0] - Mais-valia realizada por depreciação (Art. 20)
 * @param {number} [params.ajustes.menosValiaRealizada=0] - Menos-valia realizada (Art. 21)
 * @param {number} [params.ajustes.subvencaoExcluida=0] - Subvenção excluída (Art. 30 — até 2023)
 * @param {number} [params.ajustes.despPreOperacional=0] - Amortização de desp. pré-operacionais (Art. 11)
 * @param {number} [params.ajustes.ajusteValorPresente=0] - AVP realizado no período (Arts. 4-5)
 * @param {number} [params.ajustes.jcpDeduzido=0] - JCP deduzido (Art. 9º Lei 9.249)
 * @param {Object} params.retencoesSofridas - { irrf, pis, cofins, csll }
 * @returns {Object} Impacto na compensação
 */
function analisarImpactoLei12973(params) {
  const {
    lucroRealAntes,
    ajustes = {},
    retencoesSofridas
  } = params;

  const {
    ganhoValorJusto = 0,
    perdaValorJusto = 0,
    amortizacaoGoodwill = 0,
    maisValiaRealizada = 0,
    menosValiaRealizada = 0,
    subvencaoExcluida = 0,
    despPreOperacional = 0,
    ajusteValorPresente = 0,
    jcpDeduzido = 0
  } = ajustes;

  // Cálculo do impacto no lucro real
  const exclusoes = amortizacaoGoodwill + subvencaoExcluida + despPreOperacional + jcpDeduzido + ganhoValorJusto;
  const adicoes = perdaValorJusto + menosValiaRealizada;
  const realizacoes = maisValiaRealizada + ajusteValorPresente; // podem ser adição ou exclusão

  const lucroRealDepois = lucroRealAntes - exclusoes + adicoes + realizacoes;

  // IRPJ sobre lucro real (15% + 10% adicional sobre excedente de R$ 20.000/mês = R$ 60.000/tri)
  const irpjBase = Math.max(lucroRealDepois, 0) * 0.15;
  const irpjAdicional = Math.max(lucroRealDepois - 60000, 0) * 0.10; // trimestral
  const irpjDevido = Math.round((irpjBase + irpjAdicional) * 100) / 100;

  // CSLL 9%
  const csllDevida = Math.round(Math.max(lucroRealDepois, 0) * 0.09 * 100) / 100;

  // Total tributos devidos (simplificado — sem PIS/COFINS para este cálculo)
  const totalRetencoesSofridas = (retencoesSofridas.irrf || 0) + (retencoesSofridas.pis || 0) +
    (retencoesSofridas.cofins || 0) + (retencoesSofridas.csll || 0);

  const irrfCompensavel = Math.min(retencoesSofridas.irrf || 0, irpjDevido);
  const csllCompensavel = Math.min(retencoesSofridas.csll || 0, csllDevida);

  const irpjARecolher = Math.round((irpjDevido - irrfCompensavel) * 100) / 100;
  const csllARecolher = Math.round((csllDevida - csllCompensavel) * 100) / 100;

  const saldoCredorIRRF = Math.round(((retencoesSofridas.irrf || 0) - irrfCompensavel) * 100) / 100;
  const saldoCredorCSLL = Math.round(((retencoesSofridas.csll || 0) - csllCompensavel) * 100) / 100;

  return {
    descricao: 'Análise de impacto dos ajustes Lei 12.973 na compensação de retenções',
    baseLegal: 'Lei 12.973/2014 — Arts. 4-5, 11, 13-14, 20-22, 30',

    lucroReal: {
      antes: lucroRealAntes,
      ajustesLei12973: {
        exclusoes: {
          goodwill: -amortizacaoGoodwill,
          subvencao: -subvencaoExcluida,
          despPreOperacional: -despPreOperacional,
          jcp: -jcpDeduzido,
          ganhoValorJustoDiferido: -ganhoValorJusto,
          totalExclusoes: -exclusoes
        },
        adicoes: {
          perdaValorJusto: +perdaValorJusto,
          menosValia: +menosValiaRealizada,
          totalAdicoes: +adicoes
        },
        realizacoes: {
          maisValia: +maisValiaRealizada,
          ajusteValorPresente: +ajusteValorPresente,
          totalRealizacoes: +realizacoes
        },
        impactoLiquido: Math.round((-exclusoes + adicoes + realizacoes) * 100) / 100
      },
      depois: Math.round(lucroRealDepois * 100) / 100
    },

    tributosDevidos: {
      irpj: irpjDevido,
      irpjBase: Math.round(irpjBase * 100) / 100,
      irpjAdicional: Math.round(irpjAdicional * 100) / 100,
      csll: csllDevida,
      total: Math.round((irpjDevido + csllDevida) * 100) / 100
    },

    compensacao: {
      retencoesSofridas: {
        irrf: retencoesSofridas.irrf || 0,
        pis: retencoesSofridas.pis || 0,
        cofins: retencoesSofridas.cofins || 0,
        csll: retencoesSofridas.csll || 0,
        total: Math.round(totalRetencoesSofridas * 100) / 100
      },
      irrfCompensado: irrfCompensavel,
      csllCompensada: csllCompensavel,
      irpjARecolher,
      csllARecolher,
      saldoCredor: {
        irrf: saldoCredorIRRF,
        csll: saldoCredorCSLL,
        total: Math.round((saldoCredorIRRF + saldoCredorCSLL) * 100) / 100,
        destinacao: (saldoCredorIRRF + saldoCredorCSLL) > 0
          ? 'Saldo credor pode ser compensado via PER/DCOMP ou pedido de restituição'
          : 'Sem saldo credor'
      }
    },

    analise: {
      impactoGoodwill: amortizacaoGoodwill > 0
        ? `Goodwill de R$ ${amortizacaoGoodwill.toFixed(2)} excluído do lucro real → reduz IRPJ/CSLL devidos → pode gerar saldo credor de retenções`
        : 'Sem impacto de goodwill',
      impactoJCP: jcpDeduzido > 0
        ? `JCP de R$ ${jcpDeduzido.toFixed(2)} deduzido → economia fiscal estimada de R$ ${(jcpDeduzido * 0.34).toFixed(2)} (34%)`
        : 'Sem JCP deduzido',
      impactoValorJusto: (ganhoValorJusto > 0 || perdaValorJusto > 0)
        ? `Ganho diferido R$ ${ganhoValorJusto.toFixed(2)} / Perda adicionada R$ ${perdaValorJusto.toFixed(2)} — ajustes afetam timing da compensação`
        : 'Sem ajustes de valor justo'
    }
  };
}

/**
 * 13. Calcular receita bruta conforme Art. 12 do DL 1.598 (redação Lei 12.973)
 *
 * @param {Object} params
 * @param {number} [params.vendaBens=0] - Inciso I: produto da venda de bens (conta própria)
 * @param {number} [params.prestacaoServicos=0] - Inciso II: preço da prestação de serviços
 * @param {number} [params.contaAlheia=0] - Inciso III: resultado de operações de conta alheia
 * @param {number} [params.outrasReceitas=0] - Inciso IV: receitas da atividade principal não em I-III
 * @param {number} [params.devolucoes=0] - Devoluções e vendas canceladas
 * @param {number} [params.descontosIncondicionais=0] - Descontos concedidos incondicionalmente
 * @param {number} [params.tributosIncidentes=0] - Tributos sobre a receita
 * @param {number} [params.ajusteValorPresente=0] - Ajuste a valor presente (Art. 183, VIII, Lei 6.404)
 * @returns {Object} Receita bruta e líquida conforme Lei 12.973
 */
function calcularReceitaBrutaLei12973(params) {
  const {
    vendaBens = 0,
    prestacaoServicos = 0,
    contaAlheia = 0,
    outrasReceitas = 0,
    devolucoes = 0,
    descontosIncondicionais = 0,
    tributosIncidentes = 0,
    ajusteValorPresente = 0
  } = params;

  const receitaBruta = vendaBens + prestacaoServicos + contaAlheia + outrasReceitas;
  const receitaLiquida = receitaBruta - devolucoes - descontosIncondicionais - tributosIncidentes - ajusteValorPresente;

  // Base para presunção do lucro (usado em retenções Adm. Pública)
  const basePresuncaoServicos = receitaBruta - devolucoes - descontosIncondicionais;

  return {
    artigo: 'Art. 12 do DL 1.598/1977 (redação Lei 12.973/2014, art. 2º)',
    composicao: {
      I_vendaBens: vendaBens,
      II_prestacaoServicos: prestacaoServicos,
      III_contaAlheia: contaAlheia,
      IV_outrasReceitas: outrasReceitas
    },
    receitaBruta,
    deducoes: {
      I_devolucoes: devolucoes,
      II_descontosIncondicionais: descontosIncondicionais,
      III_tributosIncidentes: tributosIncidentes,
      IV_ajusteValorPresente: ajusteValorPresente,
      totalDeducoes: devolucoes + descontosIncondicionais + tributosIncidentes + ajusteValorPresente
    },
    receitaLiquida: Math.round(receitaLiquida * 100) / 100,
    basePresuncao: {
      descricao: 'Base para cálculo da presunção de lucro (Art. 15 Lei 9.249 c/c Art. 12 DL 1.598)',
      valor: Math.round(basePresuncaoServicos * 100) / 100,
      nota: 'Receita bruta (-) devoluções (-) descontos incondicionais — SEM deduzir tributos e AVP'
    },
    impactoRetencao: {
      irrfAdmPublica_servicos: Math.round(basePresuncaoServicos * 0.32 * 0.15 * 100) / 100,
      csrf_total: Math.round(basePresuncaoServicos * 0.0465 * 100) / 100,
      nota: 'IRRF Adm. Pública = 15% × 32% × base presunção; CSRF = 4,65% × base presunção'
    },
  };
}


// ============================================================================
// BLOCO H — ACRÉSCIMOS MORATÓRIOS E MULTAS (Lei 9.430/96, Arts. 44, 47, 61, 63)
// ============================================================================

/**
 * Constantes de acréscimos moratórios — Lei 9.430/96
 */
const ACRESCIMOS_MORATORIOS = {
  // Art. 61 — Multa de mora
  MULTA_MORA_TAXA_DIA: 0.0033,      // 0,33% por dia de atraso
  MULTA_MORA_TETO: 0.20,            // Teto: 20%
  JUROS_SELIC_MES_PAGAMENTO: 0.01,  // 1% fixo no mês do pagamento

  // Art. 44 — Multas de lançamento de ofício (redação Lei 14.689/2023)
  MULTA_OFICIO: {
    NORMAL: 0.75,               // 75% — falta de pagamento, declaração inexata
    QUALIFICADA_100: 1.00,      // 100% — fraude/sonegação/conluio (Art. 71-73 Lei 4.502)
    QUALIFICADA_150: 1.50,      // 150% — reincidência em 2 anos (§1º-A)
    ISOLADA_ESTIMATIVA: 0.50,   // 50% — estimativa mensal não recolhida (Art. 44, II, b)
  },

  // Agravamento por não atendimento a intimação (§2º Art. 44)
  FATOR_AGRAVAMENTO: 1.50,      // Multas majoradas em 50%

  // Reduções previstas (Art. 6º Lei 8.218/91 + Art. 60 Lei 8.383/91)
  REDUCOES: {
    PAGAMENTO_30_DIAS:       0.50,  // 50% de redução se pagar em 30 dias da notificação
    PAGAMENTO_COM_RECURSO:   0.70,  // 30% de redução se pagar antes do recurso ao CARF
  },
};

/**
 * Calcula a multa de mora sobre tributo pago em atraso.
 * Base Legal: Lei 9.430/96, Art. 61
 *
 * @param {number} valorTributo       - Valor original do tributo/contribuição
 * @param {number} diasAtraso         - Dias de atraso a partir do vencimento
 * @returns {Object} Detalhamento da multa de mora
 */
function calcularMultaMora(valorTributo, diasAtraso) {
  if (valorTributo <= 0) {
    return {
      baseLegal: 'Lei 9.430/1996, art. 61',
      valorTributo: 0,
      diasAtraso: 0,
      percentualMulta: 0,
      multaMora: 0,
      alerta: 'Valor do tributo deve ser positivo',
    };
  }
  if (diasAtraso <= 0) {
    return {
      baseLegal: 'Lei 9.430/1996, art. 61',
      valorTributo: Math.round(valorTributo * 100) / 100,
      diasAtraso: 0,
      percentualMulta: 0,
      multaMora: 0,
      alerta: 'Tributo pago sem atraso — sem multa de mora',
    };
  }

  // §1º: 0,33% por dia, a partir do 1º dia após o vencimento
  const percentualBruto = diasAtraso * ACRESCIMOS_MORATORIOS.MULTA_MORA_TAXA_DIA;

  // §2º: Limitado a 20%
  const percentualAplicavel = Math.min(percentualBruto, ACRESCIMOS_MORATORIOS.MULTA_MORA_TETO);
  const diasParaTeto = Math.ceil(ACRESCIMOS_MORATORIOS.MULTA_MORA_TETO / ACRESCIMOS_MORATORIOS.MULTA_MORA_TAXA_DIA);
  const atingiuTeto = diasAtraso >= diasParaTeto;

  const multaMora = Math.round(valorTributo * percentualAplicavel * 100) / 100;

  return {
    baseLegal: 'Lei 9.430/1996, art. 61',
    artigo61: {
      caput: 'Débitos não pagos no prazo — multa de mora de 0,33% por dia de atraso',
      paragrafo1: 'Calculada a partir do 1º dia subsequente ao vencimento',
      paragrafo2: 'Percentual limitado a 20%',
    },
    valorTributo: Math.round(valorTributo * 100) / 100,
    diasAtraso,
    percentualBruto: Math.round(percentualBruto * 10000) / 10000,
    percentualAplicavel: Math.round(percentualAplicavel * 10000) / 10000,
    atingiuTeto,
    diasParaTeto,
    multaMora,
    alertas: atingiuTeto
      ? [`Multa atingiu teto de 20% (após ${diasParaTeto} dias) — atraso de ${diasAtraso} dias não agrava mais a multa`]
      : [],
  };
}

/**
 * Calcula juros de mora (SELIC) sobre tributo pago em atraso.
 * Base Legal: Lei 9.430/96, Art. 61, §3º c/c Art. 5º, §3º
 *
 * @param {number} valorTributo         - Valor original do tributo
 * @param {Array<number>} taxasSelicMes - Array com taxa SELIC mensal de cada mês intermediário
 *                                        (do mês seguinte ao vencimento até mês anterior ao pagamento)
 * @param {boolean} incluirMesPagamento - Se true, adiciona 1% do mês de pagamento (padrão: true)
 * @returns {Object} Detalhamento dos juros de mora
 */
function calcularJurosMoraSelic(valorTributo, taxasSelicMes = [], incluirMesPagamento = true) {
  if (valorTributo <= 0) {
    return {
      baseLegal: 'Lei 9.430/1996, art. 61, §3º c/c art. 5º, §3º',
      valorTributo: 0,
      jurosMora: 0,
      alerta: 'Valor do tributo deve ser positivo',
    };
  }

  // Soma das taxas SELIC dos meses intermediários
  const selicAcumulada = taxasSelicMes.reduce((acc, t) => acc + t, 0);

  // 1% fixo no mês do pagamento
  const jurosMesPagamento = incluirMesPagamento
    ? ACRESCIMOS_MORATORIOS.JUROS_SELIC_MES_PAGAMENTO
    : 0;

  const taxaTotalJuros = selicAcumulada + jurosMesPagamento;
  const jurosMora = Math.round(valorTributo * taxaTotalJuros * 100) / 100;

  return {
    baseLegal: 'Lei 9.430/1996, art. 61, §3º c/c art. 5º, §3º',
    artigo61_paragrafo3: {
      regra: 'Juros SELIC acumulada mensalmente + 1% no mês do pagamento',
      inicio: '1º dia do mês subsequente ao vencimento',
      fim: 'Último dia do mês anterior ao pagamento + 1% mês pagamento',
    },
    valorTributo: Math.round(valorTributo * 100) / 100,
    mesesIntermediarios: taxasSelicMes.length,
    selicAcumulada: Math.round(selicAcumulada * 10000) / 10000,
    jurosMesPagamento: Math.round(jurosMesPagamento * 10000) / 10000,
    taxaTotalJuros: Math.round(taxaTotalJuros * 10000) / 10000,
    jurosMora,
  };
}

/**
 * Calcula o total de acréscimos moratórios (multa + juros) para pagamento espontâneo.
 * Base Legal: Lei 9.430/96, Art. 61 (integral)
 *
 * @param {Object} dados
 * @param {number} dados.valorTributo     - Valor original do tributo
 * @param {number} dados.diasAtraso       - Dias de atraso
 * @param {Array<number>} dados.taxasSelicMes - Taxas SELIC mensais intermediárias
 * @returns {Object} Consolidação de multa + juros + total a pagar
 */
function calcularAcrescimosMoratorios(dados) {
  const {
    valorTributo = 0,
    diasAtraso = 0,
    taxasSelicMes = [],
  } = dados;

  const multa = calcularMultaMora(valorTributo, diasAtraso);
  const juros = calcularJurosMoraSelic(valorTributo, taxasSelicMes, true);

  const totalAcrescimos = multa.multaMora + juros.jurosMora;
  const totalAPagar = valorTributo + totalAcrescimos;

  return {
    baseLegal: 'Lei 9.430/1996, art. 61 (multa mora + juros SELIC)',
    valorOriginal: Math.round(valorTributo * 100) / 100,
    multaMora: multa.multaMora,
    jurosMora: juros.jurosMora,
    totalAcrescimos: Math.round(totalAcrescimos * 100) / 100,
    totalAPagar: Math.round(totalAPagar * 100) / 100,
    detalhamento: {
      multa,
      juros,
    },
    alertas: [
      ...(multa.alertas || []),
      diasAtraso > 0
        ? `Pagamento espontâneo: multa de mora de ${(multa.percentualAplicavel * 100).toFixed(2)}% + juros SELIC de ${(juros.taxaTotalJuros * 100).toFixed(2)}%`
        : 'Tributo em dia — sem acréscimos moratórios',
    ],
  };
}

/**
 * Calcula multa de lançamento de ofício.
 * Base Legal: Lei 9.430/96, Art. 44 (redação Lei 14.689/2023)
 *
 * @param {Object} dados
 * @param {number} dados.valorDiferenca          - Diferença de imposto ou contribuição
 * @param {string} dados.tipoInfracao            - 'normal' | 'qualificada' | 'reincidente'
 * @param {boolean} dados.estimativaIsolada       - Se é multa isolada sobre estimativa (Art. 44, II, b)
 * @param {boolean} dados.naoAtendeuIntimacao     - Se houve agravamento por não atendimento (§2º)
 * @param {boolean} dados.pagamento30Dias         - Se pagou em 30 dias da notificação
 * @param {boolean} dados.pagamentoAntesRecurso   - Se pagou antes do recurso ao CARF
 * @returns {Object} Detalhamento da multa de ofício
 */
function calcularMultaOficio(dados) {
  const {
    valorDiferenca = 0,
    tipoInfracao = 'normal',
    estimativaIsolada = false,
    naoAtendeuIntimacao = false,
    pagamento30Dias = false,
    pagamentoAntesRecurso = false,
  } = dados;

  if (valorDiferenca <= 0) {
    return {
      baseLegal: 'Lei 9.430/1996, art. 44 (redação Lei 14.689/2023)',
      valorDiferenca: 0,
      multaOficio: 0,
      alerta: 'Sem diferença de imposto — sem multa de ofício',
    };
  }

  let percentualBase;
  let fundamentoEspecifico;
  const alertas = [];

  if (estimativaIsolada) {
    // Art. 44, II, b — 50% sobre estimativa não paga
    percentualBase = ACRESCIMOS_MORATORIOS.MULTA_OFICIO.ISOLADA_ESTIMATIVA;
    fundamentoEspecifico = 'Art. 44, II, b — Multa isolada de 50% sobre estimativa mensal não recolhida';
    alertas.push('Multa isolada: aplica-se mesmo que haja prejuízo fiscal ou base negativa de CSLL no ano');
  } else {
    switch (tipoInfracao) {
      case 'qualificada':
        // Art. 44, §1º, VI — 100% (fraude/sonegação/conluio — Arts. 71-73 Lei 4.502/64)
        percentualBase = ACRESCIMOS_MORATORIOS.MULTA_OFICIO.QUALIFICADA_100;
        fundamentoEspecifico = 'Art. 44, §1º, VI — 100% por sonegação, fraude ou conluio (Arts. 71-73 Lei 4.502/1964)';
        alertas.push('§1º-C: A qualificação não se aplica se não houver comprovação de dolo individualizado');
        alertas.push('§1º-C, II: Sentença penal absolutória com mérito afasta a qualificação');
        break;
      case 'reincidente':
        // Art. 44, §1º, VII — 150% (reincidência em 2 anos)
        percentualBase = ACRESCIMOS_MORATORIOS.MULTA_OFICIO.QUALIFICADA_150;
        fundamentoEspecifico = 'Art. 44, §1º, VII — 150% por reincidência em ação dolosa no prazo de 2 anos (§1º-A)';
        alertas.push('§1º-A: Reincidência conta 2 anos a partir do ATO DE LANÇAMENTO anterior, não da decisão');
        break;
      default:
        // Art. 44, I — 75%
        percentualBase = ACRESCIMOS_MORATORIOS.MULTA_OFICIO.NORMAL;
        fundamentoEspecifico = 'Art. 44, I — 75% sobre diferença de imposto/contribuição';
    }
  }

  // §2º — Agravamento de 50% por não atender intimação
  let percentualFinal = percentualBase;
  if (naoAtendeuIntimacao) {
    percentualFinal = percentualBase * ACRESCIMOS_MORATORIOS.FATOR_AGRAVAMENTO;
    alertas.push(`§2º: Multa majorada em 50% por não atendimento de intimação — de ${(percentualBase * 100).toFixed(0)}% para ${(percentualFinal * 100).toFixed(0)}%`);
  }

  // §3º — Reduções (Art. 6º Lei 8.218/91 + Art. 60 Lei 8.383/91)
  let reducao = 0;
  let reducaoDescricao = 'Nenhuma redução aplicada';
  if (pagamento30Dias) {
    reducao = ACRESCIMOS_MORATORIOS.REDUCOES.PAGAMENTO_30_DIAS;
    reducaoDescricao = 'Redução de 50% — pagamento em 30 dias da notificação (Art. 6º Lei 8.218/91)';
  } else if (pagamentoAntesRecurso) {
    reducao = ACRESCIMOS_MORATORIOS.REDUCOES.PAGAMENTO_COM_RECURSO;
    reducaoDescricao = 'Redução de 30% — pagamento antes de recurso ao CARF (Art. 60 Lei 8.383/91)';
  }

  const multaBruta = Math.round(valorDiferenca * percentualFinal * 100) / 100;
  const valorReducao = Math.round(multaBruta * reducao * 100) / 100;
  const multaLiquida = Math.round((multaBruta - valorReducao) * 100) / 100;

  return {
    baseLegal: 'Lei 9.430/1996, art. 44 (redação Lei 14.689/2023)',
    fundamentoEspecifico,
    valorDiferenca: Math.round(valorDiferenca * 100) / 100,
    tipoInfracao,
    estimativaIsolada,
    percentuais: {
      base: percentualBase,
      agravamento: naoAtendeuIntimacao ? ACRESCIMOS_MORATORIOS.FATOR_AGRAVAMENTO : 1.0,
      final: percentualFinal,
    },
    multaBruta,
    reducao: {
      percentual: reducao,
      descricao: reducaoDescricao,
      valor: valorReducao,
    },
    multaLiquida,
    totalDevido: Math.round((valorDiferenca + multaLiquida) * 100) / 100,
    alertas,
    regraReincidencia: {
      artigo: '§1º-A do Art. 44',
      prazo: '2 anos contados do ato de lançamento anterior',
      condicao: 'Comprovação de nova ação dolosa (Arts. 71-73 Lei 4.502/1964)',
    },
  };
}

/**
 * Verifica se há suspensão da multa de ofício por exigibilidade suspensa.
 * Base Legal: Lei 9.430/96, Art. 63
 *
 * @param {Object} dados
 * @param {boolean} dados.exigibilidadeSuspensa   - Se há medida suspensiva (liminar, tutela, etc.)
 * @param {string}  dados.tipoSuspensao           - 'liminar' | 'tutela_antecipada' | 'deposito' | 'parcelamento' | 'reclamacao_recurso'
 * @param {boolean} dados.suspensaoAntesFiscalizacao - Se a suspensão ocorreu ANTES do início da fiscalização
 * @param {string}  dados.dataConcessaoMedida      - Data da concessão da medida (ISO string)
 * @param {string}  dados.dataInicioFiscalizacao   - Data do início da fiscalização (ISO string)
 * @returns {Object} Análise da suspensão de multa de ofício
 */
function verificarSuspensaoMultaOficio(dados) {
  const {
    exigibilidadeSuspensa = false,
    tipoSuspensao = '',
    suspensaoAntesFiscalizacao = false,
    dataConcessaoMedida = null,
    dataInicioFiscalizacao = null,
  } = dados;

  const fundamentoCTN = {
    liminar: 'Art. 151, IV do CTN — Concessão de medida liminar em mandado de segurança',
    tutela_antecipada: 'Art. 151, V do CTN — Concessão de tutela antecipada em outras ações',
    deposito: 'Art. 151, II do CTN — Depósito do montante integral',
    parcelamento: 'Art. 151, VI do CTN — Parcelamento',
    reclamacao_recurso: 'Art. 151, III do CTN — Reclamações e recursos administrativos',
  };

  if (!exigibilidadeSuspensa) {
    return {
      baseLegal: 'Lei 9.430/1996, art. 63',
      suspensaoMulta: false,
      descricao: 'Sem suspensão de exigibilidade — multa de ofício aplicável normalmente',
      alertas: [],
    };
  }

  const alertas = [];
  let suspensaoAplicavel = false;

  // Art. 63, caput — Só se aplica a medidas dos incisos IV e V do Art. 151 do CTN
  const tiposSuspensiveisArt63 = ['liminar', 'tutela_antecipada'];
  const tipoAceitoArt63 = tiposSuspensiveisArt63.includes(tipoSuspensao);

  if (tipoAceitoArt63) {
    // §1º — Deve ter ocorrido ANTES do início do procedimento de ofício
    if (suspensaoAntesFiscalizacao) {
      suspensaoAplicavel = true;
      alertas.push('Art. 63, §1º: Suspensão válida — medida judicial concedida ANTES do início da fiscalização');
    } else {
      suspensaoAplicavel = false;
      alertas.push('Art. 63, §1º: Suspensão NÃO aplicável — medida judicial foi concedida APÓS o início da fiscalização');
      alertas.push('A RFB constituirá o crédito para prevenir decadência, MAS aplicará multa de ofício');
    }
  } else {
    // Depósito, parcelamento, etc. — Art. 63 não se aplica, mas exigibilidade segue suspensa pelo CTN
    suspensaoAplicavel = false;
    alertas.push(`Tipo de suspensão "${tipoSuspensao}" não gera dispensa de multa de ofício pelo Art. 63`);
    alertas.push('A exigibilidade segue suspensa pelo Art. 151 do CTN, mas multa de ofício pode ser lançada');
  }

  // §2º — Liminar interrompe multa de mora (não multa de ofício)
  const interrupcaoMultaMora = tipoAceitoArt63;

  return {
    baseLegal: 'Lei 9.430/1996, art. 63',
    artigo63: {
      caput: 'Na constituição de crédito para prevenir decadência, se exigibilidade suspensa por liminar/tutela (Art. 151, IV e V do CTN), NÃO cabe multa de ofício',
      paragrafo1: 'Aplica-se APENAS se a suspensão ocorreu ANTES do início da fiscalização',
      paragrafo2: 'A interposição de ação com liminar INTERROMPE a multa de mora desde a concessão até 30 dias após decisão desfavorável',
    },
    exigibilidadeSuspensa: true,
    tipoSuspensao,
    fundamentoCTN: fundamentoCTN[tipoSuspensao] || 'Tipo de suspensão não mapeado',
    suspensaoAntesFiscalizacao,
    suspensaoMultaOficio: suspensaoAplicavel,
    interrupcaoMultaMora,
    dataConcessaoMedida,
    dataInicioFiscalizacao,
    alertas,
    recomendacoes: suspensaoAplicavel
      ? ['Manter a medida judicial vigente impede a aplicação de multa de ofício',
         'Monitorar prazo — se decisão final for desfavorável, multa de mora volta a correr após 30 dias']
      : ['Avaliar possibilidade de obter liminar/tutela ANTES de eventual fiscalização',
         'Art. 47: Pagamento espontâneo até 20 dias do termo de início de fiscalização com acréscimos de procedimento espontâneo'],
  };
}

/**
 * Calcula o prazo de pagamento espontâneo sob fiscalização.
 * Base Legal: Lei 9.430/96, Art. 47 (redação Lei 9.532/97)
 *
 * @param {string} dataTermoInicio       - Data do recebimento do termo de início de fiscalização (ISO string)
 * @param {number} tributoDeclarado      - Valor do tributo já declarado mas não pago
 * @returns {Object} Prazo e condições para pagamento espontâneo
 */
function calcularPrazoEspontaneo(dataTermoInicio, tributoDeclarado = 0) {
  const dataInicio = new Date(dataTermoInicio);
  const dataLimite = new Date(dataInicio);
  dataLimite.setDate(dataLimite.getDate() + 20);

  // Ajustar para dia útil (simplificado — não cai em sábado/domingo)
  while (dataLimite.getDay() === 0 || dataLimite.getDay() === 6) {
    dataLimite.setDate(dataLimite.getDate() + 1);
  }

  return {
    baseLegal: 'Lei 9.430/1996, art. 47 (redação Lei 9.532/1997)',
    artigo47: 'Submetido a fiscalização, pode pagar tributos JÁ DECLARADOS até 20 dias do termo de início, com acréscimos de procedimento espontâneo (multa mora + juros, SEM multa de ofício)',
    dataTermoInicio: dataTermoInicio,
    prazoLimite: dataLimite.toISOString().slice(0, 10),
    diasUteis: 20,
    tributoDeclarado: Math.round(tributoDeclarado * 100) / 100,
    condicoes: [
      'Tributos e contribuições JÁ DECLARADOS como devidos (DCTF, SPED, etc.)',
      'Pagamento com multa de mora (Art. 61) + juros SELIC — SEM multa de ofício',
      'Aplica-se a impostos e contribuições federais administrados pela RFB',
      'NÃO se aplica a tributos lançados de ofício (diferenças apuradas pela fiscalização)',
    ],
    alertas: tributoDeclarado > 0
      ? [`Tributo declarado de R$ ${tributoDeclarado.toLocaleString('pt-BR', { minimumFractionDigits: 2 })} — pagar até ${dataLimite.toISOString().slice(0, 10)} para evitar multa de ofício`]
      : ['Informar valor dos tributos declarados e não pagos para cálculo dos acréscimos'],
  };
}


// ============================================================================
// BLOCO I — COMPENSAÇÃO DE TRIBUTOS FEDERAIS — PER/DCOMP (Lei 9.430/96, Art. 73-74)
// ============================================================================

/**
 * Constantes para compensação de tributos federais (PER/DCOMP)
 */
const COMPENSACAO_TRIBUTARIA = {
  // Art. 73 — Restituição e ressarcimento
  VERIFICACAO_PREVIA: 'Verificação de ausência de débitos perante a Fazenda Nacional antes de restituição/ressarcimento',

  // Art. 74 — Compensação mediante declaração (DCOMP)
  PRAZO_HOMOLOGACAO: 5,     // 5 anos para homologação (§5º)
  PRAZO_PAGAMENTO_NAO_HOMOLOGADA: 30,  // 30 dias para pagar após ciência de não homologação (§7º)
  MULTA_NAO_HOMOLOGADA: 0.50,          // 50% sobre débito indevidamente compensado (§17)

  // Art. 74-A — Limite mensal para créditos judiciais (Lei 14.873/2024)
  LIMITE_MINIMO_JUDICIAL: 10000000.00,  // R$ 10 milhões — abaixo disso não há limite mensal
  FRACAO_MINIMA_MENSAL: 1 / 60,         // Mínimo 1/60 do crédito total por mês
  PRAZO_PRIMEIRA_DCOMP: 5,              // 5 anos do trânsito em julgado (§2º)
};

/**
 * Hipóteses em que a compensação NÃO é permitida.
 * Base Legal: Lei 9.430/96, Art. 74, §3º
 */
const VEDACOES_COMPENSACAO = [
  {
    inciso: 'I',
    descricao: 'Saldo a restituir da DIRPF',
    artigo: 'Art. 74, §3º, I',
  },
  {
    inciso: 'II',
    descricao: 'Tributos e contribuições devidos no registro da Declaração de Importação',
    artigo: 'Art. 74, §3º, II',
  },
  {
    inciso: 'III',
    descricao: 'Débitos já encaminhados à PGFN para inscrição em Dívida Ativa',
    artigo: 'Art. 74, §3º, III',
  },
  {
    inciso: 'IV',
    descricao: 'Débito consolidado em qualquer parcelamento concedido pela RFB',
    artigo: 'Art. 74, §3º, IV',
  },
  {
    inciso: 'V',
    descricao: 'Débito já objeto de compensação não homologada (mesmo pendente de decisão)',
    artigo: 'Art. 74, §3º, V',
  },
  {
    inciso: 'VI',
    descricao: 'Crédito objeto de pedido de restituição/ressarcimento já indeferido (mesmo pendente)',
    artigo: 'Art. 74, §3º, VI',
  },
  {
    inciso: 'VII',
    descricao: 'Crédito sob procedimento fiscal de confirmação de liquidez e certeza',
    artigo: 'Art. 74, §3º, VII',
  },
  {
    inciso: 'VIII',
    descricao: 'Quotas de salário-família e salário-maternidade',
    artigo: 'Art. 74, §3º, VIII',
  },
  {
    inciso: 'IX',
    descricao: 'Estimativa mensal de IRPJ e CSLL (Art. 2º Lei 9.430)',
    artigo: 'Art. 74, §3º, IX (Lei 13.670/2018)',
    impactoLucroReal: 'VEDADA a compensação cruzada para quitar estimativas mensais — deve pagar via DARF',
  },
  {
    inciso: 'X',
    descricao: 'Crédito judicial que superar o limite mensal do Art. 74-A',
    artigo: 'Art. 74, §3º, X (Lei 14.873/2024)',
  },
];

/**
 * Hipóteses em que a compensação é considerada NÃO DECLARADA.
 * Base Legal: Lei 9.430/96, Art. 74, §12
 */
const COMPENSACAO_NAO_DECLARADA = [
  {
    inciso: '§12, I',
    descricao: 'Compensação enquadrada em qualquer vedação do §3º',
  },
  {
    inciso: '§12, II, a',
    descricao: 'Crédito de terceiros',
  },
  {
    inciso: '§12, II, b',
    descricao: 'Crédito-prêmio de exportação (DL 491/69)',
  },
  {
    inciso: '§12, II, c',
    descricao: 'Crédito referente a título público',
  },
  {
    inciso: '§12, II, d',
    descricao: 'Crédito de decisão judicial NÃO transitada em julgado',
  },
  {
    inciso: '§12, II, e',
    descricao: 'Crédito não referente a tributos administrados pela RFB',
  },
  {
    inciso: '§12, II, f',
    descricao: 'Crédito fundado em alegação de inconstitucionalidade (salvo exceções STF)',
    excecoes: [
      'ADI julgada procedente pelo STF',
      'Execução suspensa pelo Senado',
      'Sentença transitada em julgado favorável',
      'Súmula vinculante do STF',
    ],
  },
  {
    inciso: '§12, II, g',
    descricao: 'Crédito de pagamento indevido com DARF inexistente (Lei 15.265/2025)',
  },
  {
    inciso: '§12, II, h',
    descricao: 'Crédito de PIS/COFINS não-cumulativo sem relação com atividades econômicas do sujeito passivo (Lei 15.265/2025)',
  },
];

/**
 * Analisa a viabilidade de compensação tributária via PER/DCOMP.
 * Base Legal: Lei 9.430/96, Arts. 73, 74 e 74-A
 *
 * @param {Object} dados
 * @param {number} dados.creditoApurado         - Valor do crédito apurado (restituição/ressarcimento)
 * @param {string} dados.origemCredito           - 'pagamento_indevido' | 'saldo_negativo' | 'retencao_fonte' |
 *                                                  'pis_cofins_nao_cumulativo' | 'judicial' | 'outro'
 * @param {number} dados.debitoCompensar         - Valor do débito que se pretende compensar
 * @param {string} dados.especieDebito           - 'irpj' | 'csll' | 'pis' | 'cofins' | 'ipi' | 'estimativa' | 'divida_ativa' | 'outro'
 * @param {boolean} dados.debitoParcelado        - Se o débito está parcelado
 * @param {boolean} dados.debitoInscritoDividaAtiva - Se o débito foi inscrito em Dívida Ativa
 * @param {boolean} dados.creditoJudicial        - Se o crédito decorre de decisão judicial
 * @param {boolean} dados.transitoEmJulgado      - Se a decisão judicial transitou em julgado
 * @param {number} dados.valorTotalCreditoJudicial - Valor total do crédito judicial (para Art. 74-A)
 * @returns {Object} Análise completa da compensação
 */
function analisarCompensacaoPERDCOMP(dados) {
  const {
    creditoApurado = 0,
    origemCredito = '',
    debitoCompensar = 0,
    especieDebito = '',
    debitoParcelado = false,
    debitoInscritoDividaAtiva = false,
    creditoJudicial = false,
    transitoEmJulgado = false,
    valorTotalCreditoJudicial = 0,
  } = dados;

  const vedacoesIdentificadas = [];
  const alertas = [];
  let compensacaoViavel = true;

  // 1. Verificar vedações do §3º
  if (especieDebito === 'estimativa') {
    vedacoesIdentificadas.push(VEDACOES_COMPENSACAO[8]); // inciso IX
    compensacaoViavel = false;
    alertas.push('VEDADA: Estimativas mensais de IRPJ/CSLL NÃO podem ser compensadas via DCOMP (Lei 13.670/2018)');
    alertas.push('Estimativas devem ser pagas exclusivamente por DARF ou suspensas com balanço/balancete mensal');
  }

  if (debitoInscritoDividaAtiva) {
    vedacoesIdentificadas.push(VEDACOES_COMPENSACAO[2]); // inciso III
    compensacaoViavel = false;
    alertas.push('VEDADA: Débito inscrito em Dívida Ativa — compensação não permitida');
  }

  if (debitoParcelado) {
    vedacoesIdentificadas.push(VEDACOES_COMPENSACAO[3]); // inciso IV
    compensacaoViavel = false;
    alertas.push('VEDADA: Débito consolidado em parcelamento — compensação não permitida');
  }

  // 2. Verificar crédito judicial
  if (creditoJudicial && !transitoEmJulgado) {
    compensacaoViavel = false;
    alertas.push('COMPENSAÇÃO NÃO DECLARADA: Crédito judicial sem trânsito em julgado (§12, II, d)');
  }

  // 3. Art. 74-A — Limite mensal para créditos judiciais acima de R$ 10 milhões
  let limitesMensais = null;
  if (creditoJudicial && transitoEmJulgado && valorTotalCreditoJudicial >= COMPENSACAO_TRIBUTARIA.LIMITE_MINIMO_JUDICIAL) {
    const limiteMensal = Math.round(valorTotalCreditoJudicial * COMPENSACAO_TRIBUTARIA.FRACAO_MINIMA_MENSAL * 100) / 100;
    const mesesParaCompensar = Math.ceil(valorTotalCreditoJudicial / limiteMensal);

    limitesMensais = {
      baseLegal: 'Lei 9.430/1996, art. 74-A (Lei 14.873/2024)',
      valorTotalCredito: valorTotalCreditoJudicial,
      limiteMinimoMensal: limiteMensal,
      nota: 'Limite efetivo será o maior entre 1/60 e o valor fixado por ato do Ministro da Fazenda',
      mesesEstimados: mesesParaCompensar,
      prazoMaximoPrimeiraDCOMP: `${COMPENSACAO_TRIBUTARIA.PRAZO_PRIMEIRA_DCOMP} anos do trânsito em julgado`,
    };

    alertas.push(`Art. 74-A: Crédito judicial de R$ ${valorTotalCreditoJudicial.toLocaleString('pt-BR')} — limite mensal mínimo de R$ ${limiteMensal.toLocaleString('pt-BR')} (1/60 avos)`);
    alertas.push(`Compensação integral em aproximadamente ${mesesParaCompensar} meses`);
  }

  // 4. Calcular efeito da compensação
  const valorEfetivoCompensacao = compensacaoViavel
    ? Math.min(creditoApurado, debitoCompensar)
    : 0;
  const saldoCreditoRemanescente = compensacaoViavel
    ? Math.max(0, creditoApurado - debitoCompensar)
    : creditoApurado;
  const saldoDebitoRemanescente = compensacaoViavel
    ? Math.max(0, debitoCompensar - creditoApurado)
    : debitoCompensar;

  // 5. Risco de multa por não homologação
  const riscoMulta = {
    baseLegal: 'Art. 74, §17',
    percentual: COMPENSACAO_TRIBUTARIA.MULTA_NAO_HOMOLOGADA,
    valorPotencial: Math.round(valorEfetivoCompensacao * COMPENSACAO_TRIBUTARIA.MULTA_NAO_HOMOLOGADA * 100) / 100,
    excecao: 'Multa de 50% — salvo nos casos de falsidade (que enseja penalidade maior)',
    defesa: 'Manifestação de inconformidade (§9º) suspende exigibilidade da multa (§18)',
  };

  return {
    baseLegal: 'Lei 9.430/1996, arts. 73, 74 e 74-A',
    resumo: {
      compensacaoViavel,
      creditoApurado: Math.round(creditoApurado * 100) / 100,
      debitoCompensar: Math.round(debitoCompensar * 100) / 100,
      valorCompensado: Math.round(valorEfetivoCompensacao * 100) / 100,
      saldoCreditoRemanescente: Math.round(saldoCreditoRemanescente * 100) / 100,
      saldoDebitoRemanescente: Math.round(saldoDebitoRemanescente * 100) / 100,
    },
    mecanismo: {
      artigo74_paragrafo1: 'Compensação efetuada mediante DCOMP (Declaração de Compensação)',
      artigo74_paragrafo2: 'A declaração extingue o crédito tributário sob condição resolutória de homologação',
      artigo74_paragrafo5: `Prazo de homologação: ${COMPENSACAO_TRIBUTARIA.PRAZO_HOMOLOGACAO} anos da entrega da DCOMP`,
      artigo74_paragrafo6: 'DCOMP constitui confissão de dívida — instrumento hábil para exigência dos débitos',
    },
    vedacoesIdentificadas,
    limitesMensaisJudiciais: limitesMensais,
    riscoMulta,
    fluxoPosNaoHomologacao: {
      passo1: '§7º: Cientificação + intimação para pagar em 30 dias',
      passo2: '§8º: Se não pagar, encaminhamento para Dívida Ativa (PGFN)',
      alternativa: '§9º: Manifestação de inconformidade dentro dos 30 dias',
      recurso: '§10: Recurso ao CARF contra decisão desfavorável da manifestação',
      efeito: '§11: Manifestação e recurso suspendem exigibilidade do débito (Art. 151, III do CTN)',
    },
    artigo73: {
      regra: 'Restituição/ressarcimento só após verificação de ausência de débitos perante a Fazenda Nacional',
      compensacaoAutomatica: 'Se houver débitos não parcelados (inclusive Dívida Ativa), créditos são utilizados para quitação',
    },
    impactoLucroReal: {
      estimativas: 'Art. 74, §3º, IX — VEDADA compensação para quitar estimativas mensais IRPJ/CSLL',
      saldoNegativo: 'Art. 6º, §1º, II — Saldo negativo de IRPJ pode ser restituído ou compensado via Art. 74',
      retencoes: 'IRRF/CSRF retidos na fonte podem compor saldo negativo e ser compensados',
      prejuizoFiscal: 'Prejuízo fiscal NÃO gera crédito para PER/DCOMP — só compensa com lucro real futuro (trava 30%)',
    },
    alertas,
    recomendacoes: compensacaoViavel
      ? ['Protocolar DCOMP no e-CAC da RFB',
         'Manter documentação suporte do crédito por 5 anos após a DCOMP',
         'Monitorar homologação tácita — se 5 anos sem manifestação da RFB, compensação homologada']
      : ['Verificar alternativa de pagamento via DARF com acréscimos moratórios',
         'Avaliar parcelamento ordinário (até 60 meses) para débitos não compensáveis',
         'Para saldo negativo: formalizar PER (Pedido Eletrônico de Restituição) via e-CAC'],
  };
}

/**
 * Simula o fluxo de caixa da compensação de créditos judiciais com limite mensal.
 * Base Legal: Lei 9.430/96, Art. 74-A (Lei 14.873/2024)
 *
 * @param {Object} dados
 * @param {number} dados.valorTotalCredito    - Valor total do crédito judicial transitado em julgado
 * @param {number} dados.limiteMensal          - Limite mensal estabelecido (se 0, calcula o mínimo de 1/60)
 * @param {Array<Object>} dados.debitosMensais - Array com débitos mensais previstos [{mes, irpj, csll, pis, cofins}]
 * @returns {Object} Simulação mês a mês do uso do crédito
 */
function simularCompensacaoJudicial(dados) {
  const {
    valorTotalCredito = 0,
    limiteMensal = 0,
    debitosMensais = [],
  } = dados;

  if (valorTotalCredito < COMPENSACAO_TRIBUTARIA.LIMITE_MINIMO_JUDICIAL) {
    return {
      baseLegal: 'Lei 9.430/1996, art. 74-A (Lei 14.873/2024)',
      aplicavel: false,
      motivo: `Crédito de R$ ${valorTotalCredito.toLocaleString('pt-BR')} é inferior a R$ 10 milhões — sem limite mensal`,
      recomendacao: 'Compensar integralmente sem restrição de limite mensal',
    };
  }

  const limiteEfetivo = limiteMensal > 0
    ? limiteMensal
    : Math.round(valorTotalCredito * COMPENSACAO_TRIBUTARIA.FRACAO_MINIMA_MENSAL * 100) / 100;

  let saldoCredito = valorTotalCredito;
  const cronograma = [];

  for (let i = 0; i < debitosMensais.length && saldoCredito > 0; i++) {
    const mes = debitosMensais[i];
    const totalDebitoMes = (mes.irpj || 0) + (mes.csll || 0) + (mes.pis || 0) + (mes.cofins || 0);

    // Não pode compensar mais que o limite mensal E não mais que o débito disponível
    const compensacaoMes = Math.min(limiteEfetivo, totalDebitoMes, saldoCredito);
    const pagarDARF = Math.max(0, totalDebitoMes - compensacaoMes);

    saldoCredito = Math.round((saldoCredito - compensacaoMes) * 100) / 100;

    cronograma.push({
      mes: mes.mes || `Mês ${i + 1}`,
      totalDebito: Math.round(totalDebitoMes * 100) / 100,
      compensado: Math.round(compensacaoMes * 100) / 100,
      pagarDARF: Math.round(pagarDARF * 100) / 100,
      saldoCreditoRestante: saldoCredito,
    });
  }

  const totalCompensado = cronograma.reduce((s, m) => s + m.compensado, 0);
  const totalDARF = cronograma.reduce((s, m) => s + m.pagarDARF, 0);

  return {
    baseLegal: 'Lei 9.430/1996, art. 74-A (Lei 14.873/2024)',
    aplicavel: true,
    parametros: {
      valorTotalCredito,
      limiteEfetivo,
      mesesSimulados: debitosMensais.length,
    },
    cronograma,
    totais: {
      totalCompensado: Math.round(totalCompensado * 100) / 100,
      totalPagoDARF: Math.round(totalDARF * 100) / 100,
      saldoCreditoFinal: saldoCredito,
    },
    estimativaMesesParaEsgotar: saldoCredito > 0
      ? `Crédito não esgotado nos ${debitosMensais.length} meses simulados — saldo de R$ ${saldoCredito.toLocaleString('pt-BR')}`
      : `Crédito esgotado em ${cronograma.length} meses`,
  };
}


// ============================================================================
// EXPORTS — MÓDULO UNIFICADO v5.0
// ============================================================================

const _motorExports = {
  // --- Constantes e Tabelas ---
  ACRESCIMOS_MORATORIOS,
  ADICOES,
  ALIQUOTAS,
  AREA_SUDAM,
  AREA_SUDENE,
  ATIVIDADE_RURAL,
  BASE_NEGATIVA_CSLL,
  COMPENSACAO_GERAL,
  COMPENSACAO_NAO_DECLARADA,
  COMPENSACAO_TRIBUTARIA,
  CONSTANTES,
  CSRF,
  DEPRECIACAO,
  DEPRECIACAO_ACELERADA_INCENTIVADA,
  DEPRECIACAO_FISCAL,
  DESPESAS_COM_LIMITES,
  DESPESAS_CONDICIONAIS,
  DESPESAS_FINANCEIRAS,
  DESPESAS_INDEDUTIVEIS,
  DIVIDENDOS,
  EXCLUSOES,
  EXCLUSOES_LUCRO_EXPLORACAO,
  INCENTIVOS_FISCAIS,
  INCENTIVO_REDUCAO_75,
  INDICADORES_OMISSAO,
  IRRF_ADMINISTRACAO_PUBLICA,
  IRRF_ASSESSORIA_CREDITO,
  IRRF_BENEFICIARIO_NAO_IDENTIFICADO,
  IRRF_COMISSOES_REPRESENTACAO,
  IRRF_COOPERATIVAS,
  IRRF_DECISAO_JUDICIAL,
  IRRF_JCP,
  IRRF_MULTAS_RESCISAO,
  IRRF_SERVICOS_LIMPEZA_SEGURANCA,
  IRRF_SERVICOS_PROFISSIONAIS,
  ISS_RETIDO,
  LEI_12973,
  LIMITES_PDD_ANTIGOS,
  LIMITES_PDD_ATUAIS,
  LIMITES_ROYALTIES_ASSISTENCIA,
  LIMITE_ATIVO_DESPESA,
  LIMITE_GLOBAL_INCENTIVOS,
  MEP_REGRAS,
  METODOS_ESTOQUE,
  OBRIGACOES_ACESSORIAS,
  OPERACOES_EXTERIOR,
  PREJUIZOS_NAO_OPERACIONAIS,
  PRESUNCOES,
  PROVISOES,
  REINVESTIMENTO_30,
  RETENCOES_ADM_PUBLICA_UNIFICADA,
  SETORES_PRIORITARIOS_SUDAM,
  SUBCAPITALIZACAO,
  TABELAS_IRPF,
  TIPOS_GARANTIA,
  VALOR_JUSTO,
  VARIACAO_CAMBIAL,
  VEDACOES,
  VEDACOES_COMPENSACAO,

  // --- Funções de Cálculo ---
  analisarCompensacaoPERDCOMP,
  analisarDedutibilidade,
  analisarEncargosFinanceirosVencidos,
  analisarImpactoLei12973,
  analisarLeasing,
  analisarParticipacoesSOcietarias,
  analisarValorJusto,
  arvoreDecisaoOtimizacao,
  avaliarEstoqueSemCustoIntegrado,
  calcularAmortizacao,
  calcularAcrescimosMoratorios,
  calcularAmortizacaoGoodwill,
  calcularCSLL,
  calcularCSRF,
  calcularCustoAquisicao,
  calcularDepreciacao,
  calcularDepreciacaoCompleta,
  calcularDespesasPreOperacionais,
  calcularEstimativaAtividadesDiversificadas,
  calcularEstimativaMensal,
  calcularExaustao,
  calcularFolhaPagamento,
  calcularIRPJLucroReal,
  calcularIRRFAdmPublica,
  calcularIRRFJCP,
  calcularIRRFPessoaFisica,
  calcularIRRFServicoPJ,
  calcularIncentivos,
  calcularJCP,
  calcularJCPLei12973,
  calcularJurosMoraSelic,
  calcularLimiteDoacoes,
  calcularLimitePrevidenciaComplementar,
  calcularLimiteRoyaltiesAssistencia,
  calcularLucroExploracao,
  calcularLucroRealAjustado,
  calcularLucrosExterior,
  calcularMultaMora,
  calcularMultaOficio,
  calcularPDD,
  calcularPISCOFINSNaoCumulativo,
  calcularPrazoEspontaneo,
  calcularProporcaoIncentivada,
  calcularProvisoesTrabalhistas,
  calcularReceitaBrutaLei12973,
  calcularReducao75IRPJ,
  calcularReinvestimento30,
  calcularRetencaoIntegrada,
  calcularSaldoNegativo,
  calcularSuspensaoReducao,
  compararSimplesVsLucroRealSUDAM,
  compensarBaseNegativaCSLL,
  compensarIntegrado,
  compensarPrejuizo,
  compensarPrejuizoFiscal,
  compensarPrejuizoNaoOperacional,
  compensarRetencoes,
  gerarMapaEconomia,
  gerarRelatorioA,
  gerarRelatorioConsolidado,
  gerarRelatorioD2,
  gerarRelatorioE,
  gerarRelatorioG,
  recomendarRegime,
  registrarPrejuizoParteB,
  registrarUtilizacaoParteB,
  simularCompensacaoPluranual,
  simularCompensacaoJudicial,
  simularIncentivosRegionais,
  simularLucroRealCompleto,
  simularRegimeCambial,
  simularRetencoesAnuais,
  verificarCompliance,
  verificarElegibilidade,
  verificarObrigatoriedadeLucroReal,
  verificarOmissaoReceita,
  verificarSubcapitalizacao,
  verificarSuspensaoMultaOficio,
  verificarVedacoes,

  // ═══ ALIASES — convenções alternativas usadas por consumidores ═══
  calcularIRPJ: calcularIRPJLucroReal,           // Alias curto
  irpj: calcularIRPJLucroReal,                    // Alias mínimo
  csll: calcularCSLL,                             // Alias mínimo
  incentivos: calcularIncentivos,                 // Alias mínimo
  estimativaMensal: calcularEstimativaMensal,     // Alias curto
  compensarPrejuizoFiscalCompleto: compensarIntegrado, // Alias descritivo
  jcp: calcularJCP,                               // Alias mínimo
  depreciacao: calcularDepreciacao,               // Alias mínimo
  subcapitalizacao: verificarSubcapitalizacao,    // Alias
  vedacoesCompensacao: verificarVedacoes,         // Alias
  compensacaoPluranual: simularCompensacaoPluranual, // Alias
};

// ============================================================================
// DETECÇÃO DE AMBIENTE — Browser + Node.js
// ============================================================================

// Browser: expor como window.MotorLR
if (typeof window !== 'undefined') {
  window.MotorLR = _motorExports;
}

// Node.js / CommonJS
if (typeof module !== 'undefined' && module.exports) {
  module.exports = _motorExports;
}

// AMD
if (typeof define === 'function' && define.amd) {
  define(function() { return _motorExports; });
}
  </script>
  <!-- 4. Mapeamento unificado v3.3 (INLINE) -->
  <script>
/**
 * ╔══════════════════════════════════════════════════════════════════════════════╗
 * ║  LUCRO REAL — MAPEAMENTO UNIFICADO DE DADOS  v3.3 (CORREÇÕES FISCAIS)    ║
 * ║  Fonte única de verdade para alimentar qualquer HTML ou JS                 ║
 * ║  Base Legal: RIR/2018 (Decreto 9.580/2018) + Lei 12.973/2014              ║
 * ║  Ano-Base: 2026                                                           ║
 * ╠══════════════════════════════════════════════════════════════════════════════╣
 * ║  CORREÇÕES v3.3 (alinhamento com Motor v5.0 — riscos fiscais):            ║
 * ║                                                                            ║
 * ║  [FIX #1] Gratificações a Administradores — tratamento detalhado           ║
 * ║    - Adicionados subtipos: ADMINISTRADOR_ESTATUTARIO, DIRETOR_EMPREGADO_  ║
 * ║      CLT, EMPREGADO_GERAL com distinção IRPJ vs CSLL (LALUR vs LACS)     ║
 * ║    - Ref: Art. 315 RIR/2018, IN RFB 1.700/17 Anexo I item 85             ║
 * ║                                                                            ║
 * ║  [FIX #2] Créditos PIS/COFINS — Aluguel PF vs PJ                         ║
 * ║    - Novo parâmetro alugueisPF (sem crédito) com alerta automático         ║
 * ║    - Ref: Lei 10.637/2002, Art. 3º, IV                                    ║
 * ║                                                                            ║
 * ║  [FIX #3] Taxa TJLP não hardcoded                                         ║
 * ║    - Removido default de 6% a.a. — TJLP agora é obrigatória               ║
 * ║    - Validação com mensagem orientadora e referência a taxas recentes      ║
 * ║    - JCP fallback e simulacaoCompleta retornam erro se TJLP ausente       ║
 * ║                                                                            ║
 * ║  [FIX #4] Créditos PIS/COFINS sobre depreciação                           ║
 * ║    - Novos parâmetros: depreciacaoBensMetodo, custoAquisicaoImobilizado,  ║
 * ║      mesesUsoImobilizado para cálculo fiscal (1/48 ou 1/60)               ║
 * ║    - Alertas quando usado método contábil                                  ║
 * ║    - Ref: Lei 10.637/02, Art. 3º, VI; Lei 14.592/2023                    ║
 * ║                                                                            ║
 * ║  [FIX #5] Alíquota efetiva PIS/COFINS — duas métricas claras             ║
 * ║    - aliquotaEfetiva = líquida (a pagar / receita bruta)                  ║
 * ║    - aliquotaEfetivaBruta = (débitos / receita bruta)                     ║
 * ║    - aliquotaEfetivaDescricao explica cada métrica                         ║
 * ║                                                                            ║
 * ║  [FIX #6] Carga total — bruta vs líquida                                  ║
 * ║    - totalAPagar agora contém cargaTotalBruta e cargaTotalLiquida          ║
 * ║    - PIS/COFINS integrado em simulacaoCompleta                             ║
 * ║    - dadosPISCOFINS e retencoesPISCOFINS como novos parâmetros            ║
 * ║                                                                            ║
 * ║  [FIX #7] PIS/COFINS proporcional nos cenários                            ║
 * ║    - Cenários pessimista/otimista recalculam PIS/COFINS proporcionalmente ║
 * ║    - Antes: PIS/COFINS era fixo mesmo com receita variando ±5%           ║
 * ╠══════════════════════════════════════════════════════════════════════════════╣
 * ║  CORREÇÕES v3.2:                                                           ║
 * ║  #1 — ARQUITETURAL: Integração com Estados/EstadosBR (27 UFs dinâmicas)  ║
 * ║       LR.setEstado(), LR.getEstado(), LR.ehSUDAM(), LR.ehSUDENE()       ║
 * ║       ISS dinâmico via LR.getAliquotaISS(), helpers delegam a estados.js ║
 * ║  #2 — CRÍTICA: lucroExploracao() operador || com zero falsy corrigido     ║
 * ║  #3 — MÉDIA: compensarIntegrado() resumo.compensacaoEfetiva no motor     ║
 * ║  #4 — BAIXA: estimativaMensal() campos saldoNegativo na delegação        ║
 * ╠══════════════════════════════════════════════════════════════════════════════╣
 * ║  CORREÇÕES v3.0:                                                           ║
 * ║  Todas as funções de LR.calcular.* agora delegam ao motor principal        ║
 * ║  (window.MotorLR). Eliminada reimplementação duplicada. Fallback para      ║
 * ║  código original caso motor não carregue.                                  ║
 * ║                                                                            ║
 * ║  MAPEAMENTO DE DELEGAÇÃO:                                                  ║
 * ║  irpj()              → MotorLR.calcularIRPJLucroReal()     (Etapa 1)     ║
 * ║  csll()              → MotorLR.calcularCSLL()               (Etapa 1)     ║
 * ║  jcp()               → MotorLR.calcularJCP()               (Etapa 2)     ║
 * ║  pisCofins()         → MotorLR.calcularPISCOFINSNaoCumulativo() (Et. 2)  ║
 * ║  retencoesNF()       → MotorLR.calcularRetencaoIntegrada() (Etapa 2)     ║
 * ║  compensarRetencoes()→ MotorLR.compensarRetencoes()         (Etapa 3)     ║
 * ║  compensarIntegrado()→ MotorLR.compensarIntegrado()         (Etapa 3)     ║
 * ║  saldoNegativo()     → MotorLR.calcularSaldoNegativo()     (Etapa 3)     ║
 * ║  estimativaMensal()  → MotorLR.calcularEstimativaMensal()   (Etapa 4)     ║
 * ║  depreciacaoCompleta()→MotorLR.calcularDepreciacaoCompleta() (Etapa 4)    ║
 * ║  incentivos()        → MotorLR.calcularIncentivos()         (Etapa 4)     ║
 * ║  lucroExploracao()   → MotorLR.calcularLucroExploracao()    (Etapa 4)     ║
 * ║  suspensaoReducao()  → MotorLR.calcularSuspensaoReducao()  (Etapa 4)     ║
 * ║  acrescimosMoratorios()→MotorLR.calcularAcrescimosMoratorios()(Etapa 4)  ║
 * ║  multaOficio()       → MotorLR.calcularMultaOficio()        (Etapa 4)     ║
 * ║  recomendarRegime()  → MotorLR.recomendarRegime()           (Etapa 4)     ║
 * ║  simulacaoCompleta() → MotorLR.simularLucroRealCompleto()  (Etapa 4)     ║
 * ╠══════════════════════════════════════════════════════════════════════════════╣
 * ║  FALHAS CORRIGIDAS:                                                        ║
 * ║  #1 — Depreciação: depreciacaoNormal separada de incentivada (DRE)        ║
 * ║  #4 — Simulação: delegação ao motor elimina lucro -R$36.000 incorreto     ║
 * ║  #6 — IRPJ: saldo negativo permitido (PER/DCOMP)                         ║
 * ║  #7 — Economia prejuízo: motor calcula IRPJ real (normal+adicional)      ║
 * ╚══════════════════════════════════════════════════════════════════════════════╝
 *
 * USO:
 *   <script src="lucro-real-mapeamento.js"></script>
 *   const dados = window.LucroRealMap;
 *
 *   // Exemplos:
 *   dados.aliquotas.irpj.normal           → 0.15
 *   dados.presuncoes.SERVICOS_GERAL       → { irpj: 0.32, csll: 0.32, ... }
 *   dados.adicoes[0].descricao            → "Custos/despesas não dedutíveis"
 *   dados.obrigacoes[0].obrigacao         → "LALUR"
 *   dados.darf.irpjMensal                 → "2362"
 *   dados.helpers.formatarMoeda(1234.56)  → "R$ 1.234,56"
 *   dados.calcular.irpj({...})            → { irpjDevido, ... }
 */

(function (root) {
  'use strict';

  const LR = {};

  // v3.3 FIX E2#5: Flag de modo fallback — indica quando motor fiscal não está carregado
  // Se true, cálculos podem ter divergências com o motor fiscal completo
  LR._modoFallback = false;
  LR._fallbackUsado = []; // Rastreia quais funções rodaram em fallback

  // ═══════════════════════════════════════════════════════════════════════════
  // 1. ALÍQUOTAS E CONSTANTES GLOBAIS
  // ═══════════════════════════════════════════════════════════════════════════

  LR.aliquotas = {
    irpj: {
      normal: 0.15,                      // Art. 225 — 15%
      adicional: 0.10,                   // Art. 225 §ú — 10%
      limiteAdicionalMes: 20000,         // R$ 20.000/mês
      limiteAdicionalTrimestre: 60000,   // R$ 60.000/trimestre
      limiteAdicionalAno: 240000,        // R$ 240.000/ano
      artigoBase: 'Art. 225 do RIR/2018'
    },
    csll: {
      geral: 0.09,                       // 9% para empresas em geral
      financeiras: 0.15,                 // 15% para instituições financeiras
      artigoBase: 'Lei 7.689/1988 + Lei 13.169/2015'
    },
    pisCofins: {
      pisNaoCumulativo: 0.0165,          // 1,65%
      cofinsNaoCumulativo: 0.076,        // 7,6%
      totalNaoCumulativo: 0.0925,        // 9,25%
      pisCumulativo: 0.0065,             // 0,65%
      cofinsCumulativo: 0.03,            // 3,0%
      totalCumulativo: 0.0365,           // 3,65%
      artigoBase: 'Lei 10.637/02 (PIS) + Lei 10.833/03 (COFINS)'
    },
    jcp: {
      irrfAliquota: 0.175,              // 17,5% IRRF na fonte (LC 224/2025)
      limiteLucroLiquido: 0.50,          // 50% do lucro líquido
      limiteLucrosAcumulados: 0.50,      // 50% de lucros acumulados + reservas
      artigoBase: 'Art. 355-358 do RIR/2018',
      // v3.3 FIX #3: TJLP é obrigatória — referência informativa apenas
      tjlpNota: 'TJLP deve ser informada pelo usuário. Consultar BACEN para taxa vigente.',
      tjlpReferencia: {
        Q1_2025: 0.0797,   // 7,97% a.a.
        Q2_2025: 0.0850,   // ~8,50% a.a.
        Q3_Q4_2025: 0.0877, // ~8,77% a.a.
        Q1_2026: null,      // Consultar BACEN
        fonteConsulta: 'https://www.gov.br/receitafederal/pt-br/assuntos/orientacao-tributaria/pagamentos-e-parcelamentos/taxa-de-juros-de-longo-prazo-tjlp'
      }
    },
    compensacaoPrejuizo: {
      trava30: 0.30,                     // Art. 261, III — limite de 30%
      artigoBase: 'Art. 580-590 do RIR/2018'
    },
    retencaoFonte: {
      irrfServicos: 0.015,               // 1,5% sobre NF
      irrfServicos32: 0.048,             // 4,8% (15% × 32%) para Adm. Pública
      csrfTotal: 0.0465,                 // 4,65% (PIS 0,65% + COFINS 3% + CSLL 1%)
      csrfPis: 0.0065,
      csrfCofins: 0.03,
      csrfCsll: 0.01,
      admPublicaTotal: 0.0945,           // 9,45% retenção combinada
      artigoBase: 'Art. 714-786 do RIR/2018 + Lei 10.833/03'
    },
    issRetido: {
      minima: 0.02,                      // 2% (piso constitucional)
      maxima: 0.05,                      // 5%
      exemploMunicipio: 0.05,             // 5% alíquota exemplo (região Norte)
      artigoBase: 'LC 116/2003, art. 3º e 6º'
    }
  };

  // ═══════════════════════════════════════════════════════════════════════════
  // 2. LIMITES E OBRIGATORIEDADE
  // ═══════════════════════════════════════════════════════════════════════════

  LR.limites = {
    receitaObrigatoriedade: 78000000,    // Art. 257, I — R$ 78 milhões
    ativoDespesaDireta: 1200,            // Art. 313 §1º — R$ 1.200
    dispensaCSRF: 10,                    // CSRF dispensada se ≤ R$ 10
    artigoBase: 'Art. 257 do RIR/2018'
  };

  LR.obrigatoriedadeLucroReal = {
    artigo: 'Art. 257',
    hipoteses: [
      { id: 'RECEITA', inciso: 'I', descricao: 'Receita total ano anterior > R$ 78 milhões', valor: 78000000 },
      { id: 'FINANCEIRA', inciso: 'II', descricao: 'Instituições financeiras (bancos, seguradoras, financeiras)' },
      { id: 'LUCRO_EXTERIOR', inciso: 'III', descricao: 'Lucros, rendimentos ou ganhos de capital oriundos do exterior' },
      { id: 'BENEFICIO_FISCAL', inciso: 'IV', descricao: 'Benefício fiscal de isenção ou redução do imposto (ex: SUDAM/SUDENE)' },
      { id: 'ESTIMATIVA', inciso: 'V', descricao: 'Optou por pagamento por estimativa mensal (lucro real anual)' },
      { id: 'FACTORING', inciso: 'VI', descricao: 'Factoring / assessoria creditícia' },
      { id: 'SECURITIZADORA', inciso: 'VII', descricao: 'Securitizadora de créditos imobiliários, financeiros ou do agronegócio' }
    ]
  };

  // ═══════════════════════════════════════════════════════════════════════════
  // 3. TRIMESTRES E PERÍODOS
  // ═══════════════════════════════════════════════════════════════════════════

  LR.trimestres = [
    { numero: 1, nome: '1º Trimestre', inicio: '01-01', fim: '03-31', meses: [1, 2, 3], vencimentoDARF: '30/04' },
    { numero: 2, nome: '2º Trimestre', inicio: '04-01', fim: '06-30', meses: [4, 5, 6], vencimentoDARF: '31/07' },
    { numero: 3, nome: '3º Trimestre', inicio: '07-01', fim: '09-30', meses: [7, 8, 9], vencimentoDARF: '31/10' },
    { numero: 4, nome: '4º Trimestre', inicio: '10-01', fim: '12-31', meses: [10, 11, 12], vencimentoDARF: '31/01 do ano seguinte' }
  ];

  LR.meses = [
    'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
  ];

  // ═══════════════════════════════════════════════════════════════════════════
  // 4. PRESUNÇÕES (ESTIMATIVA MENSAL / LUCRO PRESUMIDO)
  // ═══════════════════════════════════════════════════════════════════════════

  LR.presuncoes = {
    COMERCIO_INDUSTRIA: {
      label: 'Comércio / Indústria / Transporte de Carga',
      irpj: 0.08, csll: 0.12,
      aliquotaEfetivaIRPJ: 0.012, aliquotaEfetivaCSLL: 0.0108,
      artigo: 'Art. 220, caput'
    },
    REVENDA_COMBUSTIVEIS: {
      label: 'Revenda de Combustíveis',
      irpj: 0.016, csll: 0.12,
      aliquotaEfetivaIRPJ: 0.0024, aliquotaEfetivaCSLL: 0.0108,
      artigo: 'Art. 220, §1º, I'
    },
    TRANSPORTE_PASSAGEIROS: {
      label: 'Transporte de Passageiros',
      irpj: 0.16, csll: 0.12,
      aliquotaEfetivaIRPJ: 0.024, aliquotaEfetivaCSLL: 0.0108,
      artigo: 'Art. 220, §1º, II, a'
    },
    INSTITUICOES_FINANCEIRAS: {
      label: 'Instituições Financeiras',
      irpj: 0.16, csll: 0.12,
      aliquotaEfetivaIRPJ: 0.024, aliquotaEfetivaCSLL: 0.018,
      artigo: 'Art. 220, §1º, II, b + Art. 223'
    },
    SERVICOS_GERAL: {
      label: 'Prestação de Serviços em Geral',
      irpj: 0.32, csll: 0.32,
      aliquotaEfetivaIRPJ: 0.048, aliquotaEfetivaCSLL: 0.0288,
      artigo: 'Art. 220, §1º, III, a'
    },
    SERVICOS_HOSPITALARES: {
      label: 'Serviços Hospitalares',
      irpj: 0.08, csll: 0.12,
      aliquotaEfetivaIRPJ: 0.012, aliquotaEfetivaCSLL: 0.0108,
      artigo: 'Art. 220, §2º',
      requisitos: ['Sociedade empresária', 'Atender normas ANVISA']
    },
    INTERMEDIACAO_NEGOCIOS: {
      label: 'Intermediação de Negócios',
      irpj: 0.32, csll: 0.32,
      aliquotaEfetivaIRPJ: 0.048, aliquotaEfetivaCSLL: 0.0288,
      artigo: 'Art. 220, §1º, III, b'
    },
    ADMINISTRACAO_LOCACAO: {
      label: 'Administração / Locação / Cessão de Bens',
      irpj: 0.32, csll: 0.32,
      aliquotaEfetivaIRPJ: 0.048, aliquotaEfetivaCSLL: 0.0288,
      artigo: 'Art. 220, §1º, III, c'
    },
    FACTORING: {
      label: 'Factoring / Assessoria Creditícia',
      irpj: 0.32, csll: 0.32,
      aliquotaEfetivaIRPJ: 0.048, aliquotaEfetivaCSLL: 0.0288,
      artigo: 'Art. 220, §1º, III, d'
    },
    CONSTRUCAO_CONCESSAO: {
      label: 'Construção vinculada a Concessão',
      irpj: 0.32, csll: 0.32,
      aliquotaEfetivaIRPJ: 0.048, aliquotaEfetivaCSLL: 0.0288,
      artigo: 'Art. 220, §1º, III, e'
    },
    SERVICOS_ATE_120K: {
      label: 'Serviços até R$ 120.000/ano (IRPJ reduzido)',
      irpj: 0.16, csll: 0.32,
      aliquotaEfetivaIRPJ: 0.024, aliquotaEfetivaCSLL: 0.0288,
      artigo: 'Art. 220, §4º',
      requisitos: ['Receita bruta anual ≤ R$ 120.000', 'Não hospitalar', 'Não profissão regulamentada']
    },
    ATIVIDADE_IMOBILIARIA: {
      label: 'Atividade Imobiliária',
      irpj: 0.08, csll: 0.12,
      aliquotaEfetivaIRPJ: 0.012, aliquotaEfetivaCSLL: 0.0108,
      artigo: 'Art. 220, §7º + Art. 224',
      nota: 'Receita = montante efetivamente recebido (regime de caixa)'
    },
    TRANSPORTE_CARGA: {
      label: 'Transporte de Carga',
      irpj: 0.08, csll: 0.12,
      aliquotaEfetivaIRPJ: 0.012, aliquotaEfetivaCSLL: 0.0108,
      artigo: 'Art. 220, caput'
    }
  };

  // ═══════════════════════════════════════════════════════════════════════════
  // 5. ADIÇÕES AO LUCRO LÍQUIDO (Art. 260)
  // ═══════════════════════════════════════════════════════════════════════════

  LR.adicoes = [
    { id: 1,  descricao: 'Custos/despesas/encargos não dedutíveis', artigo: 'Art. 260, I', tipo: 'D', estrategia: 'Revisar classificação contábil; reclassificar se possível' },
    { id: 2,  descricao: 'Resultados/receitas não incluídos no LL mas tributáveis', artigo: 'Art. 260, II', tipo: 'D', estrategia: 'Garantir que todas as receitas estejam na contabilidade' },
    { id: 3,  descricao: 'Quantias de lucros/fundos não tributados p/ aumento de capital', artigo: 'Art. 260, §ú, I', tipo: 'D', estrategia: 'Planejar distribuição de lucros tributados' },
    { id: 4,  descricao: 'Pagamentos a soc. simples controlada por diretores/parentes', artigo: 'Art. 260, §ú, II', tipo: 'D', estrategia: 'Evitar pagamentos a sociedades controladas por diretores' },
    { id: 5,  descricao: 'Perdas em operações day-trade', artigo: 'Art. 260, §ú, III', tipo: 'C', estrategia: 'Compensar apenas com ganhos day-trade (Art. 261, IV)' },
    { id: 6,  descricao: 'Alimentação de sócios, acionistas e administradores', artigo: 'Art. 260, §ú, IV', tipo: 'D', estrategia: 'Usar PAT para alimentação dedutível' },
    { id: 7,  descricao: 'Contribuições não compulsórias (exceto seguro/saúde/previdência)', artigo: 'Art. 260, §ú, V', tipo: 'D', estrategia: 'Direcionar para planos de saúde/previdência (dedutíveis)' },
    { id: 8,  descricao: 'Doações não enquadradas nos Art. 377/385', artigo: 'Art. 260, §ú, VI', tipo: 'D', estrategia: 'Doar dentro dos limites legais (até 2% lucro operacional)' },
    { id: 9,  descricao: 'Despesas com brindes', artigo: 'Art. 260, §ú, VII', tipo: 'D', estrategia: 'Reclassificar como material de propaganda se possível' },
    { id: 10, descricao: 'CSLL registrada como despesa operacional', artigo: 'Art. 260, §ú, VIII', tipo: 'D', estrategia: 'Inevitável — CSLL nunca é dedutível do IRPJ' },
    { id: 11, descricao: 'Perdas em renda variável/swap que excedem ganhos', artigo: 'Art. 260, §ú, IX', tipo: 'T', estrategia: 'Controlar Parte B do LALUR; compensar com ganhos futuros' },
    { id: 12, descricao: 'Receitas de previdência complementar (regime competência)', artigo: 'Art. 260, §ú, X', tipo: 'T', estrategia: 'Excluir na realização (Art. 261, VI)' },
    { id: 13, descricao: 'Resultados negativos de cooperativas com não-associados', artigo: 'Art. 260, §ú, XI', tipo: 'D', estrategia: 'Segregar atos cooperativos dos não-cooperativos' },
    { id: 14, descricao: 'Depreciação/amortização após atingir custo de aquisição', artigo: 'Art. 260, §ú, XII', tipo: 'D', estrategia: 'Controlar depreciação acumulada por bem' },
    { id: 15, descricao: 'Saldo de depreciação acelerada incentivada na alienação', artigo: 'Art. 260, §ú, XIII', tipo: 'T', estrategia: 'Planejar alienação considerando saldo' },
    { id: 16, descricao: 'Multas por infrações fiscais (punitivas)', artigo: 'Art. 311, §5º', tipo: 'D', estrategia: 'Distinguir multas compensatórias (dedutíveis) de punitivas' },
    { id: 17, descricao: 'Provisões não dedutíveis (exceto férias, 13º, PDD)', artigo: 'Art. 340-352', tipo: 'T', estrategia: 'Reverter quando liquidada → exclusão futura' },
    { id: 18, descricao: 'Resultado negativo de equivalência patrimonial (MEP)', artigo: 'Art. 389', tipo: 'T', estrategia: 'Controlado na Parte B; excluir na realização' },
    {
      id: 19,
      descricao: 'Gratificações/participações no resultado a dirigentes/administradores estatutários (indedutíveis p/ IRPJ)',
      artigo: 'Art. 315 + Art. 527 (Lei 4.506/64, Art. 45, §3º; DL 1.598/77, Art. 58, p.ú.)',
      tipo: 'D',
      estrategia: 'Converter em pró-labore (dedutível) ou JCP. ATENÇÃO: (1) Gratificações a empregados em geral são '
        + 'dedutíveis sem limite (IN 1.700/17, Art. 80). (2) Para CSLL, gratificações a administradores SÃO dedutíveis '
        + '(IN 1.700/17, Anexo I, item 85 — "não aplicável à CSLL"). (3) Diretores-empregados CLT: tema controvertido '
        + '— CARF tem decisões favoráveis à dedutibilidade (Ac. 1301003.760); STJ diverge (REsp 1.948.478/SP). '
        + 'Avaliar risco antes de adicionar ou excluir.',
      subtipos: {
        ADMINISTRADOR_ESTATUTARIO: {
          descricao: 'Dirigente/administrador estatutário (sem vínculo CLT)',
          dedutivelIRPJ: false,
          dedutivelCSLL: true,
          artigo: 'Art. 315 (IRPJ) / IN 1.700/17, Anexo I, item 85 (CSLL)',
          nota: 'Indedutível no LALUR (Parte A), mas NÃO adicionado no LACS (CSLL)'
        },
        DIRETOR_EMPREGADO_CLT: {
          descricao: 'Diretor com vínculo empregatício CLT e subordinação',
          dedutivelIRPJ: 'CONTROVERTIDO',
          dedutivelCSLL: true,
          artigo: 'CARF Ac. 9101-004.773 / REsp 1.746.268/SP (STJ favorável) / REsp 1.948.478/SP (STJ desfavorável)',
          nota: 'Risco médio — favorável no CARF, oscilante no STJ. Documentar subordinação CLT.'
        },
        EMPREGADO_GERAL: {
          descricao: 'Gratificações a empregados em geral (não administradores)',
          dedutivelIRPJ: true,
          dedutivelCSLL: true,
          artigo: 'IN RFB 1.700/2017, Art. 80 — dedutível sem limite',
          nota: 'Dedutível integralmente — não adicionar no LALUR nem no LACS'
        }
      }
    },
    { id: 20, descricao: 'Pagamento sem causa / beneficiário não identificado', artigo: 'Art. 674', tipo: 'D', estrategia: 'SEMPRE identificar beneficiário; tributação 35%' },
    { id: 21, descricao: 'Excesso de JCP acima dos limites legais', artigo: 'Art. 355-358', tipo: 'D', estrategia: 'Calcular JCP dentro dos limites PL × TJLP e 50%' },
    { id: 22, descricao: 'Depreciação contábil acima das taxas fiscais', artigo: 'Art. 311-323', tipo: 'T', estrategia: 'Usar taxas fiscais = contábeis; controlar diferença' },
    { id: 23, descricao: 'Despesas com tributos contestados (sem depósito judicial)', artigo: 'Art. 311, §2º', tipo: 'T', estrategia: 'Depositar judicialmente permite dedução imediata' },
    { id: 24, descricao: 'Royalties pagos acima dos limites a vinculadas', artigo: 'Art. 362-365', tipo: 'D', estrategia: 'Respeitar limites de dedutibilidade' },
    { id: 25, descricao: 'Excesso de preço de transferência (importações vinculadas)', artigo: 'Art. 242, §8º', tipo: 'D', estrategia: 'Documentar preços com métodos PIC, PRL ou CPL' },
    { id: 26, descricao: 'Juros de subcapitalização acima dos limites', artigo: 'Art. 250-251', tipo: 'D', estrategia: 'Manter dívida/PL dentro dos limites (2:1 / 0.3:1)' },
    { id: 27, descricao: 'Despesas não comprovadas ou sem documentação', artigo: 'Art. 311', tipo: 'D', estrategia: 'Sempre manter documentação fiscal completa' },
    { id: 28, descricao: 'Perdas em créditos não enquadradas nos critérios legais', artigo: 'Art. 340-345', tipo: 'D', estrategia: 'Enquadrar perdas nos critérios da PDD fiscal' }
  ];
  // tipo: D = definitiva, T = temporária, C = condicional

  // ═══════════════════════════════════════════════════════════════════════════
  // 6. EXCLUSÕES DO LUCRO LÍQUIDO (Art. 261)
  // ═══════════════════════════════════════════════════════════════════════════

  LR.exclusoes = [
    { id: 1,  descricao: 'Valores dedutíveis não computados no lucro líquido', artigo: 'Art. 261, I', tipo: 'D', economia: 'Até 25% do valor' },
    { id: 2,  descricao: 'Resultados/receitas incluídos no LL mas não tributáveis', artigo: 'Art. 261, II', tipo: 'D', economia: 'Até 25% do valor' },
    { id: 3,  descricao: 'Compensação de prejuízos fiscais (trava 30%)', artigo: 'Art. 261, III', tipo: 'D', economia: 'Até 7,5% do lucro ajustado' },
    { id: 4,  descricao: 'Rendimentos de reforma agrária (desapropriação)', artigo: 'Art. 261, §ú, I', tipo: 'D', economia: '25% do ganho' },
    { id: 5,  descricao: 'Dividendos do FND', artigo: 'Art. 261, §ú, II', tipo: 'D', economia: '25% dos dividendos' },
    { id: 6,  descricao: 'Juros reais de NTN (PND) — na realização', artigo: 'Art. 261, §ú, III', tipo: 'T', economia: '25% dos juros' },
    { id: 7,  descricao: 'Perdas variável/swap adicionadas anteriormente', artigo: 'Art. 261, §ú, IV', tipo: 'T', economia: '25% das perdas recuperadas' },
    { id: 8,  descricao: 'Reversão de provisões não dedutíveis', artigo: 'Art. 261, §ú, V', tipo: 'T', economia: '25% da reversão' },
    { id: 9,  descricao: 'Receitas previdência complementar (na realização)', artigo: 'Art. 261, §ú, VI', tipo: 'T', economia: '25% do valor' },
    { id: 10, descricao: 'Compensação fiscal — horário gratuito rádio/TV', artigo: 'Art. 261, §ú, VII', tipo: 'D', economia: '25%' },
    { id: 11, descricao: 'Créditos de ICMS/ISS (programas nota fiscal)', artigo: 'Art. 261, §ú, VIII', tipo: 'D', economia: '25% dos créditos' },
    { id: 12, descricao: 'Redução multas/juros (REFIS/parcelamentos)', artigo: 'Art. 261, §ú, IX', tipo: 'D', economia: '25% da redução' },
    { id: 13, descricao: 'Quotas fundo cobertura seguro rural', artigo: 'Art. 261, §ú, X', tipo: 'D', economia: '25%' },
    { id: 14, descricao: 'Crédito presumido IPI — Inovar-Auto', artigo: 'Art. 261, §ú, XI', tipo: 'D', economia: '25%' },
    { id: 15, descricao: 'Resultado positivo de equivalência patrimonial (MEP)', artigo: 'Art. 389', tipo: 'D', economia: '25% do MEP positivo' },
    { id: 16, descricao: 'Lucros e dividendos recebidos de PJ brasileira', artigo: 'Art. 261, II + Lei 9.249, Art. 10', tipo: 'D', economia: '25%', nota: 'Verificar LC 214/2025' },
    { id: 17, descricao: 'Depreciação acelerada incentivada (SUDAM/SUDENE)', artigo: 'Art. 324-328', tipo: 'T', economia: 'Antecipação de 25% do valor do bem' },
    { id: 18, descricao: 'Subvenção para investimento', artigo: 'Art. 261, II + Lei 12.973, Art. 30', tipo: 'C', economia: '25%', nota: 'Verificar Lei 14.789/2023' },
    { id: 19, descricao: 'Ganho de capital diferido — permuta imobiliária', artigo: 'Art. 261, II', tipo: 'T', economia: '25% do ganho diferido' }
  ];

  // ═══════════════════════════════════════════════════════════════════════════
  // 7. DEPRECIAÇÃO FISCAL (Art. 311-330)
  // ═══════════════════════════════════════════════════════════════════════════

  LR.depreciacao = {
    tabela: [
      { bem: 'Edifícios e construções',  taxaAnual: 0.04,  vidaUtil: 25 },
      { bem: 'Instalações',              taxaAnual: 0.10,  vidaUtil: 10 },
      { bem: 'Máquinas e equipamentos',  taxaAnual: 0.10,  vidaUtil: 10 },
      { bem: 'Móveis e utensílios',      taxaAnual: 0.10,  vidaUtil: 10 },
      { bem: 'Veículos de passageiros',  taxaAnual: 0.20,  vidaUtil: 5 },
      { bem: 'Veículos de carga',        taxaAnual: 0.20,  vidaUtil: 5 },
      { bem: 'Computadores/periféricos', taxaAnual: 0.20,  vidaUtil: 5 },
      { bem: 'Software (adquirido)',     taxaAnual: 0.20,  vidaUtil: 5 },
      { bem: 'Equipamentos comunicação', taxaAnual: 0.10,  vidaUtil: 10 },
      { bem: 'Ferramentas',             taxaAnual: 0.20,  vidaUtil: 5 },
      { bem: 'Tratores',                taxaAnual: 0.25,  vidaUtil: 4 },
      { bem: 'Semoventes/rebanho',       taxaAnual: 0.20,  vidaUtil: 5 },
      { bem: 'Drones',                  taxaAnual: 0.20,  vidaUtil: 5 },
      { bem: 'GPS / Topografia',         taxaAnual: 0.20,  vidaUtil: 5 }
    ],
    aceleracaoTurnos: [
      { turno: 1, horas: 8,  multiplicador: 1.0, artigo: 'Art. 323, I' },
      { turno: 2, horas: 16, multiplicador: 1.5, artigo: 'Art. 323, II' },
      { turno: 3, horas: 24, multiplicador: 2.0, artigo: 'Art. 323, III' }
    ],
    bensUsados: {
      artigo: 'Art. 322',
      regra: 'Vida útil = MAX(metade da vida útil normal, restante da vida útil)'
    },
    aceleradaIncentivada: {
      atividadeRural: { taxa: 1.0, artigo: 'Art. 325', descricao: 'Integral no ano (exceto terra nua)' },
      pesquisaInovacao: { taxa: 1.0, artigo: 'Art. 326', descricao: 'Integral no ano — máquinas novas P&D' },
      sudamSudene: { taxa: 1.0, artigo: 'Art. 329', descricao: 'Integral no ano ou até 4º ano subsequente' }
    },
    limiteAtivoDespesa: 1200,
    artigoBase: 'Art. 311-330 do RIR/2018'
  };

  // ═══════════════════════════════════════════════════════════════════════════
  // 8. INCENTIVOS FISCAIS (Art. 226/228/625-646)
  // ═══════════════════════════════════════════════════════════════════════════

  LR.incentivos = [
    { id: 'PAT',              label: 'Programa de Alimentação do Trabalhador', limiteIRPJ: 0.04, artigo: 'Art. 226, I + Art. 641-646', requisitos: ['Registro no MTE', 'Até 5 SM'] },
    { id: 'FIA',              label: 'Fundo da Criança e do Adolescente', limiteIRPJ: 0.01, artigo: 'Art. 226, II + Art. 636' },
    { id: 'FUNDO_IDOSO',      label: 'Fundo do Idoso', limiteIRPJ: 0.01, artigo: 'Art. 226, II + Lei 12.213/10' },
    { id: 'ROUANET',          label: 'Lei Rouanet — Atividades Culturais', limiteIRPJ: 0.04, artigo: 'Art. 226, III + Lei 8.313/91' },
    { id: 'VALE_CULTURA',     label: 'Vale-Cultura', limiteIRPJ: 0.01, artigo: 'Art. 226, IV + Lei 12.761/12' },
    { id: 'AUDIOVISUAL',      label: 'Atividades Audiovisuais (FUNCINES)', limiteIRPJ: 0.03, artigo: 'Art. 226, V' },
    { id: 'ESPORTE',          label: 'Lei do Esporte', limiteIRPJ: 0.01, artigo: 'Art. 226, VI + Lei 11.438/06' },
    { id: 'LICENCA_MATERNIDADE', label: 'Prorrogação Licença-Maternidade (Empresa Cidadã)', limiteIRPJ: null, artigo: 'Art. 226, VII + Lei 11.770/08' },
    { id: 'PRONON',           label: 'PRONON — Apoio à Oncologia', limiteIRPJ: 0.01, artigo: 'Art. 628 + Lei 12.715/12' },
    { id: 'PRONAS_PCD',       label: 'PRONAS/PCD — Pessoa com Deficiência', limiteIRPJ: 0.01, artigo: 'Art. 628 + Lei 12.715/12' },
    { id: 'PD_LEI_BEM',       label: 'P&D — Lei do Bem', limiteIRPJ: null, artigo: 'Lei 11.196/05', nota: 'Exclusão de 60% a 80% dos dispêndios da base IRPJ/CSLL' }
  ];

  LR.limiteGlobalIncentivos = {
    artigo: 'Art. 625',
    regra: 'Soma dos incentivos ≤ percentual do IRPJ normal (sem adicional)',
    nota: 'Cada incentivo tem seu limite individual dentro do global'
  };

  // ═══════════════════════════════════════════════════════════════════════════
  // 9. SUBCAPITALIZAÇÃO (Art. 249-251)
  // ═══════════════════════════════════════════════════════════════════════════

  LR.subcapitalizacao = {
    vinculadaComParticipacao: { limiteDividaPL: 2.0, artigo: 'Art. 250, I', descricao: 'Dívida ≤ 2× participação da vinculada no PL' },
    vinculadaSemParticipacao: { limiteDividaPL: 2.0, artigo: 'Art. 250, II', descricao: 'Dívida ≤ 2× PL total' },
    somatorioVinculadas:      { limiteDividaPL: 2.0, artigo: 'Art. 250, III', descricao: 'Total ≤ 2× somatório participações' },
    paraisoFiscal:            { limiteDividaPL: 0.30, artigo: 'Art. 251', descricao: 'Dívida ≤ 30% do PL' }
  };

  // ═══════════════════════════════════════════════════════════════════════════
  // 10. OBRIGAÇÕES ACESSÓRIAS (Art. 262-287)
  // ═══════════════════════════════════════════════════════════════════════════

  LR.obrigacoes = [
    { obrigacao: 'LALUR',           artigo: 'Art. 277', prazo: 'Anual (via ECF)',     digital: true, descricao: 'Parte A: ajustes | Parte B: controle de valores' },
    { obrigacao: 'Livro Diário',    artigo: 'Art. 273', prazo: 'Contínuo (SPED ECD)', digital: true, descricao: 'Todas as operações dia a dia' },
    { obrigacao: 'Livro Razão',     artigo: 'Art. 274', prazo: 'Contínuo (SPED ECD)', digital: true, descricao: 'Totalização por conta. Ausência = arbitramento' },
    { obrigacao: 'Registro Inventário', artigo: 'Art. 275-276', prazo: 'Final período apuração', digital: true, descricao: 'Arrolamento de mercadorias/produtos' },
    { obrigacao: 'Registro Entradas', artigo: 'Art. 275, II', prazo: 'Contínuo', digital: true, descricao: 'Compras de mercadorias e matérias-primas' },
    { obrigacao: 'Apuração ICMS',   artigo: 'Art. 275, IV', prazo: 'Mensal', digital: true, descricao: 'Apuração do ICMS' },
    { obrigacao: 'ECF',             artigo: 'IN RFB 1.422/13', prazo: 'Anual (último dia útil de julho)', digital: true, descricao: 'Escrituração Contábil Fiscal — substitui DIPJ' },
    { obrigacao: 'ECD',             artigo: 'IN RFB 1.420/13', prazo: 'Anual (último dia útil de maio)', digital: true, descricao: 'Escrituração Contábil Digital (SPED Contábil)' },
    { obrigacao: 'EFD-Contribuições', artigo: 'IN RFB 1.252/12', prazo: 'Mensal (10º dia útil do 2º mês)', digital: true, descricao: 'PIS/COFINS — créditos e débitos' },
    { obrigacao: 'DCTF',            artigo: 'IN RFB 1.599/15', prazo: 'Mensal (15º dia útil do 2º mês)', digital: true, descricao: 'Declaração de Débitos e Créditos Tributários Federais' }
  ];

  // ═══════════════════════════════════════════════════════════════════════════
  // 11. CÓDIGOS DARF
  // ═══════════════════════════════════════════════════════════════════════════

  LR.darf = {
    // IRPJ
    irpjMensal:            { codigo: '2362', tributo: 'IRPJ', descricao: 'IRPJ — Estimativa Mensal', periodicidade: 'Mensal', prazo: 'Último dia útil do mês subsequente' },
    irpjTrimestral:        { codigo: '0220', tributo: 'IRPJ', descricao: 'IRPJ — Apuração Trimestral', periodicidade: 'Trimestral', prazo: 'Último dia útil do mês subsequente ao trimestre (em até 3 quotas)' },
    irpjAnualAjuste:       { codigo: '2430', tributo: 'IRPJ', descricao: 'IRPJ — Ajuste Anual', periodicidade: 'Anual', prazo: 'Último dia útil de março do ano seguinte (em até 3 quotas)' },
    // CSLL
    csllMensal:            { codigo: '2484', tributo: 'CSLL', descricao: 'CSLL — Estimativa Mensal', periodicidade: 'Mensal', prazo: 'Último dia útil do mês subsequente' },
    csllTrimestral:        { codigo: '6012', tributo: 'CSLL', descricao: 'CSLL — Apuração Trimestral', periodicidade: 'Trimestral', prazo: 'Último dia útil do mês subsequente ao trimestre (em até 3 quotas)' },
    csllAnualAjuste:       { codigo: '6773', tributo: 'CSLL', descricao: 'CSLL — Ajuste Anual', periodicidade: 'Anual', prazo: 'Último dia útil de março do ano seguinte' },
    // PIS/COFINS
    pisNaoCumulativo:      { codigo: '6912', tributo: 'PIS', descricao: 'PIS — Não-Cumulativo', periodicidade: 'Mensal', prazo: 'Dia 25 do mês subsequente ao fato gerador' },
    cofinsNaoCumulativo:   { codigo: '5856', tributo: 'COFINS', descricao: 'COFINS — Não-Cumulativo', periodicidade: 'Mensal', prazo: 'Dia 25 do mês subsequente ao fato gerador' },
    // Retenções
    irrfServicos:          { codigo: '1708', tributo: 'IRRF', descricao: 'IRRF — Serviços PJ a PJ (1,5%)', periodicidade: 'Por evento', prazo: 'Até o último dia útil do 2º decêndio do mês subsequente' },
    irrfServicosPF:        { codigo: '0588', tributo: 'IRRF', descricao: 'IRRF — Rendimentos do Trabalho', periodicidade: 'Mensal', prazo: 'Até o último dia útil do 2º decêndio do mês subsequente' },
    irrfAdmPublica:        { codigo: '1708', tributo: 'IRRF', descricao: 'IRRF — Adm. Pública', periodicidade: 'Por evento', prazo: 'Até o 3º dia útil após o decêndio da retenção' },
    csrfPis:               { codigo: '5979', tributo: 'PIS Retido', descricao: 'PIS Retido — CSRF', periodicidade: 'Quinzenal', prazo: 'Até o último dia útil da quinzena subsequente' },
    csrfCofins:            { codigo: '5960', tributo: 'COFINS Retido', descricao: 'COFINS Retido — CSRF', periodicidade: 'Quinzenal', prazo: 'Até o último dia útil da quinzena subsequente' },
    csrfCsll:              { codigo: '5987', tributo: 'CSLL Retido', descricao: 'CSLL Retido — CSRF', periodicidade: 'Quinzenal', prazo: 'Até o último dia útil da quinzena subsequente' },
    csrfUnificado:         { codigo: '5952', tributo: 'CSRF', descricao: 'CSRF Unificado — Adm. Pública', periodicidade: 'Por evento', prazo: 'Até o 3º dia útil após o decêndio da retenção' },
    // JCP
    jcpIrrf:               { codigo: '5706', tributo: 'IRRF s/ JCP', descricao: 'IRRF — JCP (17,5% — LC 224/2025)', periodicidade: 'Por evento', prazo: 'Até o 3º dia útil após o pagamento ou crédito' },
    // Outros
    beneficiarioNaoId:     { codigo: '2063', tributo: 'IRRF', descricao: 'IRRF — Beneficiário Não Identificado (35%)', periodicidade: 'Por evento', prazo: 'Data do pagamento' }
  };

  // ═══════════════════════════════════════════════════════════════════════════
  // 12. RETENÇÕES NA FONTE (Bloco G)
  // ═══════════════════════════════════════════════════════════════════════════

  LR.retencoes = {
    irrfServicosPJ: {
      artigo: 'Art. 714',
      aliquota: 0.015,
      tratamento: 'ANTECIPAÇÃO',
      descricao: '1,5% sobre serviços profissionais (lista completa no Art. 714)',
      dispensa: 'Optantes Simples Nacional, pagamentos até R$ 10,00'
    },
    irrfAdmPublica: {
      artigo: 'Art. 720 + IN RFB 1.234/12',
      aliquota: 0.048,
      descricao: '4,8% (15% × 32%) para serviços prestados a órgãos públicos',
      tratamento: 'ANTECIPAÇÃO'
    },
    csrf: {
      artigo: 'Lei 10.833/03, art. 30-36',
      aliquotas: { pis: 0.0065, cofins: 0.03, csll: 0.01, total: 0.0465 },
      servicosSujeitos: [
        'Serviços profissionais (lista Art. 714)',
        'Limpeza, conservação, manutenção',
        'Segurança e vigilância',
        'Locação de mão-de-obra',
        'Assessoria creditícia e mercadológica',
        'Transporte de valores'
      ],
      dispensas: {
        simplesNacional: true,
        valorMinimo: 10,
        descricao: 'Dispensada se retenção ≤ R$ 10 ou optante Simples Nacional'
      },
      tratamento: 'Cada contribuição compensa apenas com ela mesma (PIS→PIS, COFINS→COFINS, CSLL→CSLL)'
    },
    beneficiarioNaoIdentificado: {
      artigo: 'Art. 730-731',
      aliquota: 0.35,
      tratamento: 'EXCLUSIVAMENTE NA FONTE',
      formulaBruto: 'Bruto = Líquido / 0,65'
    },
    jcp: {
      artigo: 'Art. 726 + Art. 355-358 + LC 224/2025',
      aliquota: 0.175,
      tratamento: 'ANTECIPAÇÃO (compensável com IRPJ devido)'
    },
    dividendos: {
      artigo: 'Art. 725 + Lei 9.249, Art. 10',
      aliquota: 0,
      descricao: 'Lucros/dividendos apurados a partir de jan/1996 — ISENTOS'
    },
    iss: {
      artigo: 'LC 116/2003',
      aliquotaMin: 0.02,
      aliquotaMax: 0.05,
      exemploMunicipio: 0.05,
      nota: 'ISS NÃO deduz do IRPJ — é tributo municipal tratado na DRE'
    }
  };

  // ═══════════════════════════════════════════════════════════════════════════
  // 13. SUDAM / SUDENE / INCENTIVOS REGIONAIS (Bloco E)
  // ═══════════════════════════════════════════════════════════════════════════

  LR.sudam = {
    artigo: 'Art. 630-633',
    lei: 'LC 124/2007',
    estados: ['AC', 'AP', 'AM', 'MA', 'MT', 'PA', 'RO', 'RR', 'TO'],
    descricao: 'Amazônia Legal',
    exemploMunicipio: { estado: 'PA', ibge: '1505031', elegivel: true },
    getExemploMunicipio: function() {
      var uf = LR._estadoAtual;
      if (uf && LR.sudam.estados.indexOf(uf) >= 0) {
        var dados = LR.getSecaoEstado('dados_gerais');
        if (dados && dados.municipios_principais && dados.municipios_principais.length > 0) {
          var m = dados.municipios_principais[0];
          return { estado: uf, nome: m.nome, ibge: m.codigo_ibge, elegivel: true };
        }
      }
      return { estado: uf || 'N/D', elegivel: LR.ehSUDAM(uf) };
    },
    reducao75: {
      percentual: 0.75,
      prazo: 10,
      artigo: 'Art. 634',
      baseLegal: 'MP 2.199-14/2001 + Lei 13.799/2019',
      tipos: ['Instalação', 'Ampliação', 'Modernização', 'Diversificação'],
      requisitos: [
        'Lucro Real obrigatório',
        'Projeto aprovado pela SUDAM até 31/12/2023',
        'Laudo Constitutivo emitido',
        'Setor prioritário (Decreto 4.212/2002)',
        'CND/CPEN federal + regularidade FGTS',
        'Produção efetiva > 20% da capacidade instalada'
      ]
    },
    reinvestimento30: {
      percentual: 0.30,
      artigo: 'Art. 638-651',
      banco: 'BASA (Banco da Amazônia)',
      capitalGiro: 0.50,
      destinacao: ['Modernização', 'Complementação equipamentos', 'Montagem/instalação', 'Capital de giro (até 50%)']
    },
    setoresPrioritarios: [
      { id: 'AGROIND', label: 'Agroindústria' },
      { id: 'BIOTECH', label: 'Biotecnologia' },
      { id: 'FLORESTAL', label: 'Florestal' },
      { id: 'INFRA', label: 'Infraestrutura' },
      { id: 'MINERAL', label: 'Mineral' },
      { id: 'PESCA', label: 'Pesca e Aquicultura' },
      { id: 'SERVICOS_TEC', label: 'Serviços Técnicos Especializados', relevante: true },
      { id: 'DIGITAL', label: 'Inclusão Digital' },
      { id: 'TURISMO', label: 'Turismo' },
      { id: 'QUIMICA', label: 'Química' },
      { id: 'METAL', label: 'Metalurgia e Metal-Mecânica' },
      { id: 'TEXTIL', label: 'Têxtil e Calçados' },
      { id: 'ELETROELETRO', label: 'Eletroeletrônica' },
      { id: 'CULTURA', label: 'Cultura' }
    ]
  };

  LR.sudene = {
    artigo: 'Art. 627',
    lei: 'LC 125/2007',
    estados: ['AL', 'BA', 'CE', 'MA', 'PB', 'PE', 'PI', 'RN', 'SE'],
    parcial: { MG: 'Municípios do Polígono das Secas / ex-DNOCS', ES: 'Norte do ES (ex-ADENE)' }
  };

  LR.exclusoesLucroExploracao = {
    excluir: [
      { id: 'REC_FIN_LIQUIDA', label: 'Receitas financeiras líquidas', artigo: 'Art. 618, I' },
      { id: 'RESULT_PARTIC_SOC', label: 'Resultados positivos participações societárias (MEP)', artigo: 'Art. 618, II' },
      { id: 'RESULT_NAO_OPERAC', label: 'Resultados não operacionais (ganhos/perdas capital)', artigo: 'Art. 618, III' },
      { id: 'RECEITAS_ANTERIOR', label: 'Receitas de exercícios anteriores', artigo: 'Art. 618, IV' },
      { id: 'RESERVA_REAV', label: 'Valores baixados reserva reavaliação', artigo: 'Art. 618, V' },
      { id: 'SUBVENCOES', label: 'Subvenções para investimento', artigo: 'Art. 618, VI' },
      { id: 'TRIB_SUSPENSOS', label: 'Tributos com exigibilidade suspensa', artigo: 'Art. 618, VIII' }
    ],
    adicionar: [
      { id: 'CSLL_DEVIDA', label: 'CSLL devida no período', artigo: 'IN SRF 267/2002, art. 2º §1º' },
      { id: 'DESP_FIN_LIQUIDA', label: 'Despesas financeiras líquidas (se > receitas fin.)', artigo: 'IN SRF 267/2002, art. 2º §2º' },
      { id: 'PREJUIZO_PARTIC', label: 'Resultados negativos participações societárias', artigo: 'IN SRF 267/2002, art. 2º §3º' }
    ]
  };

  // ═══════════════════════════════════════════════════════════════════════════
  // 14. DESPESAS INDEDUTÍVEIS E COM LIMITES
  // ═══════════════════════════════════════════════════════════════════════════

  LR.despesasIndedutiveis = [
    { id: 'BRINDES', artigo: 'Art. 13, VII Lei 9.249', descricao: 'Despesas com brindes' },
    { id: 'ALIMENTACAO_SOCIOS', artigo: 'Art. 13, IV Lei 9.249', descricao: 'Alimentação de sócios/acionistas/administradores' },
    { id: 'CONTRIBUICAO_NAO_COMPULSORIA', artigo: 'Art. 13, V Lei 9.249', descricao: 'Contribuições não compulsórias (exceto saúde/previdência)' },
    { id: 'DOACAO_IRREGULAR', artigo: 'Art. 13, VI Lei 9.249', descricao: 'Doações fora dos limites legais' },
    { id: 'MULTA_PUNITIVA', artigo: 'Art. 311, §5º', descricao: 'Multas por infrações fiscais (punitivas)' },
    { id: 'GRATIFICACAO_ADM', artigo: 'Art. 358, §1º', descricao: 'Gratificações a administradores' },
    { id: 'CSLL', artigo: 'Lei 9.316/96, Art. 1º', descricao: 'CSLL registrada como despesa' },
    { id: 'ROYALTIES_SOCIOS', artigo: 'Art. 363, I', descricao: 'Royalties pagos a sócios PF/PJ e parentes' },
    { id: 'PENA_CRIMINAL', artigo: 'Art. 352, §4º', descricao: 'Reparação de pena criminal' },
    { id: 'DEPRECIACAO_EXCESSO', artigo: 'Art. 260, §ú, XII', descricao: 'Depreciação além do custo de aquisição' }
  ];

  LR.despesasComLimites = {
    doacoes: {
      operacionais: { limite: 0.02, base: 'Lucro operacional', artigo: 'Art. 377' },
      oscip: { limite: 0.02, base: 'Lucro operacional', artigo: 'Art. 377, §1º' },
      entidadesEnsino: { limite: 0.015, base: 'Lucro operacional', artigo: 'Art. 385' }
    },
    previdenciaComplementar: {
      limite: 0.20, base: 'Folha salarial', artigo: 'Art. 369, §1º'
    },
    royalties: {
      limiteGeral: 0.05, base: 'Receita líquida', artigo: 'Art. 365'
    }
  };

  // ═══════════════════════════════════════════════════════════════════════════
  // 15. PROVISÕES DEDUTÍVEIS E NÃO DEDUTÍVEIS
  // ═══════════════════════════════════════════════════════════════════════════

  LR.provisoes = {
    dedutiveis: [
      { id: 'FERIAS', descricao: 'Férias + 1/3 + encargos', artigo: 'Art. 342' },
      { id: '13_SALARIO', descricao: '13º salário + encargos', artigo: 'Art. 342' },
      { id: 'PDD', descricao: 'PDD — Provisão para Devedores Duvidosos (critérios Art. 347)', artigo: 'Art. 347-351' }
    ],
    naoDedutiveis: [
      { id: 'CONTINGENCIAS', descricao: 'Provisão para contingências (trabalhistas, cíveis, fiscais)', artigo: 'Art. 340', ajuste: 'Adição ao lucro; exclusão na reversão/liquidação' },
      { id: 'GARANTIAS', descricao: 'Provisão para garantia de produtos', artigo: 'Art. 340' },
      { id: 'PERDAS_INVESTIMENTOS', descricao: 'Provisão para perdas em investimentos', artigo: 'Art. 340' }
    ]
  };

  // ═══════════════════════════════════════════════════════════════════════════
  // 16. PDD — CRITÉRIOS (Art. 347-351)
  // ═══════════════════════════════════════════════════════════════════════════

  LR.pdd = {
    artigo: 'Art. 347-351',
    criterios: [
      { id: 'JUDICIAL', descricao: 'Crédito com cobrança judicial em andamento', artigo: 'Art. 347, §1º, I' },
      { id: 'CONCORDATA', descricao: 'Devedor declarado falido ou em recuperação judicial', artigo: 'Art. 347, §1º, II' },
      { id: 'VENCIDO', descricao: 'Crédito vencido há mais de 6 meses com providências de cobrança', artigo: 'Art. 347, §1º, III' },
      { id: 'INSOLVENTE', descricao: 'Devedor notoriamente insolvente', artigo: 'Art. 347, §1º, IV' }
    ],
    vedacoes: [
      'Créditos com garantia real (até limite da garantia)',
      'Créditos com devedor parte relacionada',
      'Créditos com empresa do mesmo grupo econômico'
    ],
    faixasValor: [
      { ate: 5000, descricao: 'Até R$ 5.000 — sem cobrança judicial: 6 meses + procedimentos', artigo: 'Art. 347, §3º' },
      { ate: 30000, descricao: 'De R$ 5.000 a R$ 30.000 — autos de cobrança administrativos', artigo: 'Art. 347, §4º' },
      { acima: 30000, descricao: 'Acima de R$ 30.000 — exige procedimento judicial', artigo: 'Art. 347, §5º' }
    ]
  };

  // ═══════════════════════════════════════════════════════════════════════════
  // 17. ESTOQUE (Art. 304-310)
  // ═══════════════════════════════════════════════════════════════════════════

  LR.estoques = {
    metodosPermitidos: [
      { id: 'CUSTO_MEDIO', label: 'Custo Médio Ponderado', artigo: 'Art. 307' },
      { id: 'PEPS', label: 'PEPS / FIFO', artigo: 'Art. 307' },
      { id: 'PRECO_VENDA_MARGEM', label: 'Preço de Venda menos Margem', artigo: 'Art. 307' },
      { id: 'MERCADO_RURAL', label: 'Preços correntes de mercado (apenas rural/extrativo)', artigo: 'Art. 309' }
    ],
    vedacoes: [
      'Reduções globais de valores inventariados (Art. 310, I)',
      'Depreciações estimadas ou provisões para oscilação preços (Art. 310, II)',
      'Estoques básicos a preços constantes ou nominais (Art. 310, III)',
      'Provisão ajuste ao valor de mercado se < custo (Art. 310, IV)'
    ]
  };

  // ═══════════════════════════════════════════════════════════════════════════
  // 18. OMISSÃO DE RECEITA (Art. 293-300)
  // ═══════════════════════════════════════════════════════════════════════════

  LR.indicadoresOmissao = [
    { id: 'SALDO_CAIXA_NEGATIVO', artigo: 'Art. 293, I', gravidade: 'CRITICO', descricao: 'Saldo negativo de caixa' },
    { id: 'FALTA_ESCRITURACAO', artigo: 'Art. 293, II', gravidade: 'CRITICO', descricao: 'Falta de escrituração de pagamentos' },
    { id: 'PASSIVO_FICTICIO', artigo: 'Art. 293, III', gravidade: 'CRITICO', descricao: 'Manutenção de obrigações já pagas ou inexigíveis' },
    { id: 'SUPRIMENTO_CAIXA', artigo: 'Art. 294', gravidade: 'ALTO', descricao: 'Recursos de sócios sem comprovação de origem' },
    { id: 'FALTA_NOTA_FISCAL', artigo: 'Art. 295', gravidade: 'CRITICO', descricao: 'Falta de NF ou NF com valor inferior' },
    { id: 'DEPOSITOS_SEM_ORIGEM', artigo: 'Art. 299', gravidade: 'ALTO', descricao: 'Créditos bancários sem comprovação' },
    { id: 'DIVERGENCIA_ESTOQUE', artigo: 'Art. 298', gravidade: 'MEDIO', descricao: 'Diferença no levantamento quantitativo' }
  ];

  // ═══════════════════════════════════════════════════════════════════════════
  // 19. LEI 12.973/2014 — AJUSTES RELEVANTES
  // ═══════════════════════════════════════════════════════════════════════════

  LR.lei12973 = {
    vigencia: '01/01/2015',
    temas: [
      { id: 'RECEITA_BRUTA', label: 'Nova definição de receita bruta', artigo: 'Art. 2º → DL 1.598, Art. 12' },
      { id: 'AVP', label: 'Ajuste a Valor Presente — tributação diferida', artigo: 'Arts. 4-5' },
      { id: 'VALOR_JUSTO', label: 'Ganho/perda valor justo — diferimento via subconta', artigo: 'Arts. 13-14' },
      { id: 'GOODWILL', label: 'Amortização goodwill — dedutível em 1/60 avos', artigo: 'Arts. 20-22' },
      { id: 'MAIS_MENOS_VALIA', label: 'Mais-valia e menos-valia — realização via depreciação', artigo: 'Arts. 20-21' },
      { id: 'JCP_PL', label: 'Base do JCP = PL fiscal (capital + reservas - tesouraria - prejuízo)', artigo: 'Art. 9º → Lei 9.249, §8º' },
      { id: 'DIVIDENDOS', label: 'Isenção ampliada para todas as espécies de ações', artigo: 'Art. 9º → Lei 9.249, Art. 10' },
      { id: 'SUBVENCAO', label: 'Subvenção para investimento — reserva de lucros', artigo: 'Art. 30 (revogado Lei 14.789/2023)' },
      { id: 'PRE_OPERACIONAL', label: 'Despesas pré-operacionais — amortização diferida', artigo: 'Art. 11' }
    ]
  };

  // ═══════════════════════════════════════════════════════════════════════════
  // 20. VALOR JUSTO, MEP, OPERAÇÕES EXTERIOR
  // ═══════════════════════════════════════════════════════════════════════════

  LR.valorJusto = {
    artigo: 'CPC 46 / Arts. 13-14 Lei 12.973',
    ganho: { ajuste: 'EXCLUSÃO do lucro real (diferimento via subconta)', artigo: 'Art. 13' },
    perda: { ajuste: 'ADIÇÃO ao lucro real (não dedutível, controlada Parte B)', artigo: 'Art. 14' },
    realizacao: 'Na alienação, depreciação ou baixa — ganho vira adição / perda vira exclusão'
  };

  LR.mep = {
    artigo: 'Art. 389 + CPC 18',
    positivo: 'EXCLUSÃO do lucro real',
    negativo: 'ADIÇÃO ao lucro real',
    descricao: 'Resultado de equivalência patrimonial — neutro para fins fiscais'
  };

  LR.operacoesExterior = {
    artigo: 'Art. 446-451',
    regras: [
      'Taxa de câmbio para venda na data da contabilização (Art. 446, §1º)',
      'Prejuízos no exterior NÃO compensáveis com lucros no País (Art. 446, §7º)',
      'Sem incentivos fiscais sobre IR de lucros no exterior (Art. 446, §10)'
    ],
    creditoIR: {
      descricao: 'Crédito de IR pago no exterior',
      limite: 'IRPJ brasileiro sobre a mesma renda',
      artigo: 'Art. 448'
    }
  };

  // ═══════════════════════════════════════════════════════════════════════════
  // 21. FÓRMULA MESTRE — PASSOS DO CÁLCULO
  // ═══════════════════════════════════════════════════════════════════════════

  LR.formulaMestre = {
    descricao: 'Sequência de cálculo do IRPJ pelo Lucro Real',
    artigo: 'Art. 258-261',
    passos: [
      { passo: 1, descricao: 'Lucro Líquido Contábil (antes de IRPJ/CSLL)', artigo: 'Art. 259', operacao: '=' },
      { passo: 2, descricao: 'Adições obrigatórias', artigo: 'Art. 260', operacao: '+' },
      { passo: 3, descricao: 'Exclusões permitidas', artigo: 'Art. 261, I e II', operacao: '-' },
      { passo: 4, descricao: 'Lucro Real antes compensação', artigo: '-', operacao: '=' },
      { passo: 5, descricao: 'Compensação prejuízos fiscais (trava 30%)', artigo: 'Art. 261, III', operacao: '-' },
      { passo: 6, descricao: 'LUCRO REAL (base de cálculo)', artigo: '-', operacao: '=' },
      { passo: 7, descricao: 'IRPJ Normal (15%)', artigo: 'Art. 225', operacao: '×' },
      { passo: 8, descricao: 'IRPJ Adicional (10% sobre excedente)', artigo: 'Art. 225, §ú', operacao: '+' },
      { passo: 9, descricao: 'IRPJ Devido', artigo: '-', operacao: '=' },
      { passo: 10, descricao: 'Deduções (incentivos fiscais)', artigo: 'Art. 226/228', operacao: '-' },
      { passo: 11, descricao: 'Compensação retenções na fonte', artigo: '-', operacao: '-' },
      { passo: 12, descricao: 'IRPJ A RECOLHER', artigo: '-', operacao: '=' }
    ]
  };

  // ═══════════════════════════════════════════════════════════════════════════
  // 22. MAPA DE ESTRATÉGIAS DE ECONOMIA
  // ═══════════════════════════════════════════════════════════════════════════

  LR.estrategiasEconomia = [
    { id: 1, nome: 'JCP — Juros sobre Capital Próprio', tipo: 'Dedução', complexidade: 'Baixa', risco: 'Baixo', impacto: '16,5% líquido do JCP pago (LC 224/2025)', artigo: 'Art. 355-358' },
    { id: 2, nome: 'Compensação de Prejuízos Fiscais', tipo: 'Compensação', complexidade: 'Baixa', risco: 'Baixo', impacto: 'Até 30% do lucro ajustado', artigo: 'Art. 580-590' },
    { id: 3, nome: 'Incentivos Fiscais (PAT, FIA, Rouanet)', tipo: 'Dedução IRPJ', complexidade: 'Média', risco: 'Baixo', impacto: '~10% do IRPJ normal', artigo: 'Art. 226/228' },
    { id: 4, nome: 'Balanço de Suspensão/Redução', tipo: 'Timing', complexidade: 'Média', risco: 'Baixo', impacto: 'Até 100% da estimativa mensal', artigo: 'Art. 227-230' },
    { id: 5, nome: 'Depreciação Acelerada', tipo: 'Timing', complexidade: 'Média', risco: 'Baixo', impacto: '1-5% da receita', artigo: 'Art. 311-330' },
    { id: 6, nome: 'Créditos PIS/COFINS', tipo: 'Crédito', complexidade: 'Alta', risco: 'Médio', impacto: '3-7% dos custos', artigo: 'Lei 10.637/02' },
    { id: 7, nome: 'SUDAM — Redução 75% IRPJ', tipo: 'Redução', complexidade: 'Alta', risco: 'Baixo', impacto: 'Até 75% do IRPJ', artigo: 'Art. 615-627' },
    { id: 8, nome: 'Reclassificação Despesas Indedutíveis', tipo: 'Dedução', complexidade: 'Alta', risco: 'Médio', impacto: 'Variável', artigo: 'Art. 311' }
  ];

  // ═══════════════════════════════════════════════════════════════════════════
  // 23. VARIAÇÃO CAMBIAL (Art. 446-451)
  // ═══════════════════════════════════════════════════════════════════════════

  LR.variacaoCambial = {
    regimeCaixa: {
      descricao: 'Variações cambiais reconhecidas na liquidação da operação',
      artigo: 'MP 2.158-35/2001, Art. 30',
      opcao: 'Opção irretratável para o ano-calendário'
    },
    regimeCompetencia: {
      descricao: 'Variações cambiais reconhecidas mensalmente',
      artigo: 'Art. 311',
      padrao: true
    }
  };

  // ═══════════════════════════════════════════════════════════════════════════
  // 24. RECEITA BRUTA — COMPOSIÇÃO (DL 1.598 + Lei 12.973)
  // ═══════════════════════════════════════════════════════════════════════════

  LR.receitaBruta = {
    composicao: [
      { inciso: 'I', descricao: 'Produto da venda de bens (conta própria)', campo: 'vendaBens' },
      { inciso: 'II', descricao: 'Preço da prestação de serviços', campo: 'prestacaoServicos' },
      { inciso: 'III', descricao: 'Resultado de operações de conta alheia', campo: 'contaAlheia' },
      { inciso: 'IV', descricao: 'Receitas da atividade principal não em I-III', campo: 'outrasReceitas' }
    ],
    deducoes: [
      { inciso: 'I', descricao: 'Devoluções e vendas canceladas', campo: 'devolucoes' },
      { inciso: 'II', descricao: 'Descontos concedidos incondicionalmente', campo: 'descontosIncondicionais' },
      { inciso: 'III', descricao: 'Tributos sobre ela incidentes', campo: 'tributosIncidentes' },
      { inciso: 'IV', descricao: 'Ajuste a valor presente', campo: 'ajusteValorPresente' }
    ],
    artigo: 'Art. 12 do DL 1.598/1977 (redação Lei 12.973/2014)'
  };

  // ═══════════════════════════════════════════════════════════════════════════
  // 25. LALUR — ESTRUTURA
  // ═══════════════════════════════════════════════════════════════════════════

  LR.lalur = {
    parteA: {
      descricao: 'Demonstração do lucro real — adições e exclusões do período',
      artigo: 'Art. 277',
      conteudo: ['Lucro líquido do período', 'Adições (Art. 260)', 'Exclusões (Art. 261)', 'Lucro Real apurado']
    },
    parteB: {
      descricao: 'Controle de valores que afetarão períodos futuros',
      artigo: 'Art. 277',
      exemplos: [
        'Prejuízos fiscais a compensar',
        'Base negativa de CSLL',
        'Depreciação acelerada incentivada (diferença fiscal × contábil)',
        'Provisões não dedutíveis (a reverter futuramente)',
        'Perdas de renda variável/swap',
        'Resultado negativo MEP'
      ]
    }
  };

  // ═══════════════════════════════════════════════════════════════════════════
  // 26. TABELA IRPF (para retenções PF)
  // ═══════════════════════════════════════════════════════════════════════════

  LR.tabelaIRPF = {
    anoBase: 2026,
    faixas: [
      { ate: 2428.80, aliquota: 0, deducao: 0, descricao: 'Isento' },
      { ate: 2826.65, aliquota: 0.075, deducao: 182.16 },
      { ate: 3751.05, aliquota: 0.15, deducao: 394.16 },
      { ate: 4664.68, aliquota: 0.225, deducao: 675.49 },
      { acima: 4664.68, aliquota: 0.275, deducao: 908.73 }
    ],
    deducaoDependente: 189.59,
    descontoSimplificado: 607.20,
    redutorMaximo: 312.89,
    faixaIsencaoRedutor: 5000.00,
    faixaReducaoParcial: 7350.00,
    nota: 'MP 1.294/2025 (faixas) + Lei 15.270/2025 (redutor até R$5.000 isento)'
  };

  // ═══════════════════════════════════════════════════════════════════════════
  // HELPER INTERNO — arredondamento 2 casas
  // ═══════════════════════════════════════════════════════════════════════════

  function _r(v) {
    var n = Number(v);
    if (isNaN(n)) {
      console.warn('[IMPOST][_r] NaN detectado:', v);
      return 0;
    }
    return Math.round(n * 100) / 100;
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // INTEGRAÇÃO COM ESTADOS — Dados dinâmicos por UF (v3.2)
  // ═══════════════════════════════════════════════════════════════════════════

  /**
   * Estado atualmente selecionado pelo assinante.
   * Quando o HTML muda o <select>, chamar LR.setEstado('SP') para atualizar.
   */
  LR._estadoAtual = null;
  LR._dadosEstadoAtual = null;

  /**
   * Define o estado ativo e carrega seus dados de estados.js
   * @param {string} sigla - Ex: 'SP', 'RJ', 'PA', 'MT'
   * @returns {boolean} true se carregou com sucesso
   */
  LR.setEstado = function(sigla) {
    if (!sigla) return false;

    var Estados = window.Estados || window.EstadosBR;
    if (!Estados || typeof Estados.getEstado !== 'function') {
      console.warn('[LR] estados.js não carregado — dados estaduais indisponíveis');
      LR._estadoAtual = sigla.toUpperCase();
      LR._dadosEstadoAtual = null;
      return false;
    }

    var dados = Estados.getEstado(sigla);
    if (!dados) {
      console.warn('[LR] Estado não encontrado:', sigla);
      return false;
    }

    LR._estadoAtual = sigla.toUpperCase();
    LR._dadosEstadoAtual = dados;
    return true;
  };

  /**
   * Retorna o estado atualmente selecionado
   * @returns {string|null}
   */
  LR.getEstado = function() {
    return LR._estadoAtual;
  };

  /**
   * Retorna dados de uma seção do estado atual
   * @param {string} secao - 'icms', 'iss', 'ipva', 'incentivos', etc.
   * @returns {object|null}
   */
  LR.getSecaoEstado = function(secao) {
    return LR._dadosEstadoAtual ? (LR._dadosEstadoAtual[secao] || null) : null;
  };

  /**
   * Retorna a alíquota de ISS do estado/município atual
   * Fonte primária: estados.js iss.aliquota_geral
   * Fallback: 0.05 (máximo federal LC 116/2003)
   * @returns {number} Alíquota ISS (ex: 0.05 para 5%)
   */
  LR.getAliquotaISS = function() {
    // 1) Tentar seção ISS do estado carregado via setEstado()
    var iss = LR.getSecaoEstado('iss');
    if (iss && typeof iss.aliquota_geral === 'number') return iss.aliquota_geral;

    // 2) Tentar diretamente via API de estados.js (caso setEstado não foi chamado)
    if (LR._estadoAtual) {
      var Estados = window.Estados || window.EstadosBR;
      if (Estados && typeof Estados.getISS === 'function') {
        var issApi = Estados.getISS(LR._estadoAtual);
        if (issApi && typeof issApi.aliquota_geral === 'number') return issApi.aliquota_geral;
      }
    }

    // 3) Fallback federal máximo LC 116/2003
    return 0.05;
  };

  /**
   * Verifica se um estado é SUDAM (Amazônia Legal)
   * Fonte primária: estados.js incentivos.sudam.ativo
   * Fallback: lista hardcoded (compatibilidade)
   * @param {string} [uf] - Opcional, se não passar usa o estado atual
   * @returns {boolean}
   */
  LR.ehSUDAM = function(uf) {
    var sigla = (uf || LR._estadoAtual || '').toUpperCase();
    if (!sigla) return false;

    // Tentar ler de estados.js primeiro (fonte confiável)
    var Estados = window.Estados || window.EstadosBR;
    if (Estados && typeof Estados.getIncentivos === 'function') {
      var inc = Estados.getIncentivos(sigla);
      if (inc && inc.sudam) return inc.sudam.ativo === true;
    }

    // Fallback: lista hardcoded
    return LR.sudam.estados.indexOf(sigla) >= 0;
  };

  /**
   * Verifica se um estado é SUDENE (Nordeste + parciais)
   * Fonte primária: estados.js incentivos.sudene.ativo
   * Fallback: lista hardcoded (compatibilidade)
   * @param {string} [uf] - Opcional, se não passar usa o estado atual
   * @returns {boolean}
   */
  LR.ehSUDENE = function(uf) {
    var sigla = (uf || LR._estadoAtual || '').toUpperCase();
    if (!sigla) return false;

    var Estados = window.Estados || window.EstadosBR;
    if (Estados && typeof Estados.getIncentivos === 'function') {
      var inc = Estados.getIncentivos(sigla);
      if (inc && inc.sudene) return inc.sudene.ativo === true;
    }

    // Fallback: lista hardcoded
    return LR.sudene.estados.indexOf(sigla) >= 0;
  };

  // (helpers _calcIRPJ e _calcIRPJTrimestral removidos na v2.3 — delegação ao motor)

  // ═══════════════════════════════════════════════════════════════════════════
  // 30. FUNÇÕES DE CÁLCULO ESSENCIAIS (CORRIGIDAS)
  // ═══════════════════════════════════════════════════════════════════════════

  LR.calcular = {

    /**
     * Calcular IRPJ pelo Lucro Real
     * Base Legal: Art. 258-261
     */
    irpj: function (dados) {
      // DELEGAÇÃO AO MOTOR (v2.2) — MotorLR.calcularIRPJLucroReal()
      // Correção Falha #6: motor permite saldo negativo (PER/DCOMP)
      if (typeof MotorLR !== 'undefined' && MotorLR.calcularIRPJLucroReal) {
        var d = Object.assign({
          lucroLiquido: 0, adicoes: 0, exclusoes: 0,
          prejuizoFiscal: 0, numMeses: 12, incentivos: 0,
          retencoesFonte: 0, estimativasPagas: 0
        }, dados);

        // Mapear parâmetros mapeamento → motor
        var resultado = MotorLR.calcularIRPJLucroReal({
          lucroLiquidoContabil: d.lucroLiquido,
          totalAdicoes: d.adicoes,
          totalExclusoes: d.exclusoes,
          saldoPrejuizoFiscal: d.prejuizoFiscal,
          numMeses: d.numMeses,
          incentivosDedutiveis: d.incentivos,
          retencoesFonte: d.retencoesFonte,
          estimativasPagas: d.estimativasPagas
        });

        // Mapear retorno motor → interface esperada pelo mapeamento
        return {
          lucroLiquido: resultado.passo1_lucroLiquido,
          adicoes: resultado.passo2_adicoes,
          exclusoes: resultado.passo3_exclusoes,
          lucroAntesCompensacao: resultado.passo4_lucroAntesCompensacao,
          compensacaoPrejuizo: _r(resultado.passo5_compensacao),
          prejuizoRemanescente: _r(resultado.saldoPrejuizoRemanescente),
          lucroReal: _r(resultado.passo6_lucroReal),
          irpjNormal: _r(resultado.passo7_irpjNormal),
          irpjAdicional: _r(resultado.passo8_adicionalIRPJ),
          irpjDevido: _r(resultado.passo9_irpjDevido),
          deducoes: _r(resultado.passo10_deducoes),
          retencoesFonte: d.retencoesFonte,
          estimativasPagas: d.estimativasPagas,
          irpjAPagar: _r(resultado.passo12_irpjAPagar),
          saldoNegativo: resultado.saldoNegativo ? _r(resultado.valorSaldoNegativo) : 0,
          aliquotaEfetiva: resultado.aliquotaEfetiva
        };
      }

      // FALLBACK: implementação original caso o motor não esteja carregado
      var d = Object.assign({
        lucroLiquido: 0, adicoes: 0, exclusoes: 0,
        prejuizoFiscal: 0, numMeses: 12, incentivos: 0,
        retencoesFonte: 0, estimativasPagas: 0
      }, dados);

      var lucroAntesComp = d.lucroLiquido + d.adicoes - d.exclusoes;
      var limiteCompensacao = Math.max(lucroAntesComp, 0) * 0.30;
      var compensacao = Math.min(limiteCompensacao, d.prejuizoFiscal, Math.max(lucroAntesComp, 0));
      var lucroReal = Math.max(lucroAntesComp - compensacao, 0);

      var limiteAdicional = LR.aliquotas.irpj.limiteAdicionalMes * d.numMeses;
      var irpjNormal = lucroReal * LR.aliquotas.irpj.normal;
      var irpjAdicional = Math.max(lucroReal - limiteAdicional, 0) * LR.aliquotas.irpj.adicional;
      var irpjDevido = irpjNormal + irpjAdicional;
      var deducoes = Math.min(d.incentivos, irpjNormal);
      var irpjAPagar = irpjDevido - deducoes - d.retencoesFonte - d.estimativasPagas;

      return {
        lucroLiquido: d.lucroLiquido,
        adicoes: d.adicoes,
        exclusoes: d.exclusoes,
        lucroAntesCompensacao: lucroAntesComp,
        compensacaoPrejuizo: _r(compensacao),
        prejuizoRemanescente: _r(d.prejuizoFiscal - compensacao),
        lucroReal: _r(lucroReal),
        irpjNormal: _r(irpjNormal),
        irpjAdicional: _r(irpjAdicional),
        irpjDevido: _r(irpjDevido),
        deducoes: _r(deducoes),
        retencoesFonte: d.retencoesFonte,
        estimativasPagas: d.estimativasPagas,
        irpjAPagar: _r(irpjAPagar),
        saldoNegativo: irpjAPagar < 0 ? _r(Math.abs(irpjAPagar)) : 0,
        aliquotaEfetiva: lucroReal > 0 ? _r(irpjDevido / lucroReal * 100) + '%' : '0%'
      };
    },

    /**
     * Calcular CSLL
     * Base Legal: Lei 7.689/88 + Lei 9.249/95
     */
    csll: function (dados) {
      // DELEGAÇÃO AO MOTOR (v2.2) — MotorLR.calcularCSLL()
      if (typeof MotorLR !== 'undefined' && MotorLR.calcularCSLL) {
        var d = Object.assign({
          lucroLiquido: 0, adicoes: 0, exclusoes: 0,
          baseNegativa: 0, financeira: false
        }, dados);

        // Mapear parâmetros mapeamento → motor
        var resultado = MotorLR.calcularCSLL({
          lucroLiquidoContabil: d.lucroLiquido,
          adicoesCSLL: d.adicoes,
          exclusoesCSLL: d.exclusoes,
          saldoBaseNegativa: d.baseNegativa,
          ehInstituicaoFinanceira: d.financeira
        });

        // Mapear retorno motor → interface esperada pelo mapeamento
        return {
          baseAntesCompensacao: _r(resultado.baseAjustada),
          compensacao: _r(resultado.compensacaoBaseNegativa),
          baseNegativaRemanescente: _r(resultado.saldoBaseNegativaRemanescente),
          baseCalculo: _r(resultado.basePositiva),
          aliquota: resultado.aliquota,
          csllDevida: _r(resultado.csllDevida)
        };
      }

      // FALLBACK: implementação original caso o motor não esteja carregado
      var d = Object.assign({
        lucroLiquido: 0, adicoes: 0, exclusoes: 0,
        baseNegativa: 0, financeira: false
      }, dados);

      var base = d.lucroLiquido + d.adicoes - d.exclusoes;
      var limiteComp = Math.max(base, 0) * 0.30;
      var compensacao = Math.min(limiteComp, d.baseNegativa, Math.max(base, 0));
      var baseCalculo = Math.max(base - compensacao, 0);
      var aliq = d.financeira ? LR.aliquotas.csll.financeiras : LR.aliquotas.csll.geral;
      var csllDevida = baseCalculo * aliq;

      return {
        baseAntesCompensacao: _r(base),
        compensacao: _r(compensacao),
        baseNegativaRemanescente: _r(d.baseNegativa - compensacao),
        baseCalculo: _r(baseCalculo),
        aliquota: aliq,
        csllDevida: _r(csllDevida)
      };
    },

    /**
     * Calcular JCP máximo dedutível
     * Base Legal: Art. 355-358
     *
     * DELEGAÇÃO: MotorLR.calcularJCP() + fallback
     */
    jcp: function (dados) {
      // DELEGAÇÃO AO MOTOR (v3.3) — MotorLR.calcularJCP()
      if (typeof MotorLR !== 'undefined' && MotorLR.calcularJCP) {
        var resultado = MotorLR.calcularJCP(dados);

        // v3.3 FIX #3: Motor retorna erro se TJLP não informada — propagar ao chamador
        if (resultado.erro) {
          return {
            erro: true,
            mensagem: resultado.mensagem,
            taxasReferencia: resultado.taxasReferencia || null,
            artigo: resultado.artigo || 'Art. 355 c/c Lei 9.249/95, Art. 9º',
            jcpDedutivel: 0,
            economiaLiquida: 0,
            jcpMaximoTJLP: 0,
            limite50LL: 0,
            limite50Reservas: 0,
            economiaIRPJ: 0,
            economiaCSLL: 0,
            economiaTotal: 0,
            custoIRRF: 0,
            limiteUtilizado: 'N/A'
          };
        }

        // Mapear retorno motor → interface esperada pelo mapeamento
        return {
          jcpMaximoTJLP: _r(resultado.jcpMaximoTJLP),
          limite50LL: _r(resultado.limite1_50LL),
          limite50Reservas: _r(resultado.limite2_50Reservas),
          jcpDedutivel: _r(resultado.jcpDedutivel),
          economiaIRPJ: _r(resultado.economiaIRPJ),
          economiaCSLL: _r(resultado.economiaCSLL),
          economiaTotal: _r(resultado.economiaTotal),
          custoIRRF: _r(resultado.custoIRRF),
          economiaLiquida: _r(resultado.economiaLiquida),
          limiteUtilizado: resultado.limiteUtilizado
        };
      }

      // FALLBACK: implementação original caso o motor não esteja carregado
      // v3.3 FIX #3: TJLP NÃO tem default — deve ser informada explicitamente
      var d = Object.assign({
        patrimonioLiquido: 0, tjlp: null,
        lucroLiquidoAntes: 0, lucrosAcumulados: 0, numMeses: 12
      }, dados);

      // v3.3 FIX #3: Se TJLP não informada, retornar erro informativo
      if (d.tjlp === undefined || d.tjlp === null || d.tjlp === 0) {
        return {
          erro: true,
          mensagem: 'TJLP é OBRIGATÓRIA para cálculo do JCP e não possui valor default. '
            + 'A TJLP é divulgada trimestralmente pelo BACEN. '
            + 'Em 2025: Q1=7,97%, Q2≈8,50%, Q3/Q4≈8,77% a.a.',
          taxasReferencia: {
            'Q1_2025': '7,97% a.a. (0.0797)',
            'Q2_2025': '~8,50% a.a.',
            'Q3_Q4_2025': '~8,77% a.a.',
            'Q1_2026': 'Consultar BACEN'
          },
          artigo: 'Art. 355 c/c Lei 9.249/95, Art. 9º',
          jcpDedutivel: 0,
          economiaLiquida: 0,
          jcpMaximoTJLP: 0,
          limite50LL: 0,
          limite50Reservas: 0,
          economiaIRPJ: 0,
          economiaCSLL: 0,
          economiaTotal: 0,
          custoIRRF: 0,
          limiteUtilizado: 'N/A'
        };
      }

      var tjlpProp = d.tjlp * (d.numMeses / 12);
      // v3.3 FIX BUG MÉDIO 2: PL para JCP deve excluir LL do exercício corrente
      // Ref: IN RFB 1.700/2017, art. 75 — base PL = PL - LL do período
      var plParaJCP = _r(d.patrimonioLiquido - (d.lucroLiquidoAntes || 0));
      if (plParaJCP < 0) plParaJCP = 0; // PL base não pode ser negativo
      var maxTJLP = plParaJCP * tjlpProp;
      var lim1 = d.lucroLiquidoAntes * 0.50;
      var lim2 = d.lucrosAcumulados * 0.50;
      var limiteLegal = Math.max(lim1, lim2);
      var jcpDedutivel = Math.max(0, Math.min(maxTJLP, limiteLegal));
      var limAdicPeriodo = LR.aliquotas.irpj.limiteAdicionalMes * (d.numMeses || 12);
      var baseAntes = Math.max(d.lucroLiquidoAntes || 0, 0);
      var baseApos = Math.max(baseAntes - jcpDedutivel, 0);
      var irpjAntes = baseAntes * LR.aliquotas.irpj.normal + Math.max(0, baseAntes - limAdicPeriodo) * LR.aliquotas.irpj.adicional;
      var irpjApos = baseApos * LR.aliquotas.irpj.normal + Math.max(0, baseApos - limAdicPeriodo) * LR.aliquotas.irpj.adicional;
      var economiaIRPJ = irpjAntes - irpjApos;
      var economiaCSLL = jcpDedutivel * (LR.aliquotas.csll.geral || 0.09);
      var custoIRRF = jcpDedutivel * LR.aliquotas.jcp.irrfAliquota;

      return {
        jcpMaximoTJLP: _r(maxTJLP),
        limite50LL: _r(lim1),
        limite50Reservas: _r(lim2),
        jcpDedutivel: _r(jcpDedutivel),
        economiaIRPJ: _r(economiaIRPJ),
        economiaCSLL: _r(economiaCSLL),
        economiaTotal: _r(economiaIRPJ + economiaCSLL),
        custoIRRF: _r(custoIRRF),
        economiaLiquida: _r(economiaIRPJ + economiaCSLL - custoIRRF),
        limiteUtilizado: jcpDedutivel === maxTJLP ? 'TJLP' : jcpDedutivel === limiteLegal ? (lim1 >= lim2 ? '50% Lucro' : '50% Reservas') : 'TJLP'
      };
    },

    /**
     * Calcular Estimativa Mensal (CORRIGIDA — aceita objeto com campos detalhados)
     * Base Legal: Art. 219-225
     */
    estimativaMensal: function (dados) {
      // Compatibilidade: aceita (receitaBruta, tipoAtividade) OU objeto
      var d;
      if (typeof dados === 'number') {
        d = { receitaBruta: dados, tipoAtividade: arguments[1] || 'SERVICOS_GERAL' };
      } else {
        d = Object.assign({
          receitaBruta: 0, tipoAtividade: 'SERVICOS_GERAL',
          ganhosCapital: 0, demaisReceitas: 0,
          irrfCompensavel: 0, incentivosDedutiveis: 0
        }, dados);
      }

      // DELEGAÇÃO AO MOTOR (v3.0) — MotorLR.calcularEstimativaMensal()
      if (typeof MotorLR !== 'undefined' && MotorLR.calcularEstimativaMensal) {
        var resultado = MotorLR.calcularEstimativaMensal({
          receitaBrutaMensal: d.receitaBruta,
          tipoAtividade: d.tipoAtividade,
          ganhosCapital: d.ganhosCapital || 0,
          demaisReceitas: d.demaisReceitas || 0,
          irrfCompensavel: d.irrfCompensavel || 0,
          incentivosDedutiveis: d.incentivosDedutiveis || 0,
          financeira: d.financeira || false
        });

        // Mapear retorno motor → interface esperada pelo mapeamento
        return {
          atividade: resultado.presuncaoUtilizada,
          receitaBruta: resultado.receitaBruta,
          presuncaoIRPJ: parseFloat(resultado.percentualPresuncaoIRPJ) / 100 || 0,
          presuncaoCSLL: parseFloat(resultado.percentualPresuncaoCSLL) / 100 || 0,
          baseIRPJ: _r(resultado.basePresumidaIRPJ + (resultado.ganhosCapital || 0) + (resultado.demaisReceitas || 0)),
          baseCSLL: _r(resultado.csll ? resultado.csll.baseCSLL : 0),
          irpjNormal: _r(resultado.irpjNormal),
          irpjAdicional: _r(resultado.irpjAdicional),
          irpjDevido: _r(resultado.irpjDevido),
          deducoes: _r(resultado.deducoes),
          irrfCompensavel: resultado.irrfCompensavel || 0,
          irpjAPagar: _r(resultado.irpjAPagar),
          csllDevida: _r(resultado.csll ? resultado.csll.csllDevida : 0),
          totalAPagar: _r(resultado.totalAPagar),
          // v3.2: Campos para consistência com fallback
          saldoNegativo: 0,
          saldoNegativoDestinacao: null
        };
      }

      // FALLBACK: implementação original caso o motor não esteja carregado
      var p = LR.presuncoes[d.tipoAtividade];
      if (!p) return { erro: 'Tipo de atividade não encontrado: ' + d.tipoAtividade };

      var baseIRPJ = d.receitaBruta * p.irpj + (d.ganhosCapital || 0) + (d.demaisReceitas || 0);
      var baseCSLL = d.receitaBruta * p.csll + (d.ganhosCapital || 0) + (d.demaisReceitas || 0);
      var irpjNormal = baseIRPJ * 0.15;
      var irpjAdicional = Math.max(baseIRPJ - 20000, 0) * 0.10;
      var irpjDevido = irpjNormal + irpjAdicional;
      var deducoes = Math.min(d.incentivosDedutiveis || 0, irpjNormal);
      var irpjAPagar = Math.max(irpjDevido - deducoes - (d.irrfCompensavel || 0), 0);
      // CORREÇÃO: Usar alíquota correta de CSLL (15% para inst. financeiras, 9% demais)
      var aliqCSLL = (d.financeira === true || d.financeira === 'true') ? 0.15 : 0.09;
      var csllDevida = baseCSLL * aliqCSLL;

      return {
        atividade: p.label,
        receitaBruta: d.receitaBruta,
        presuncaoIRPJ: p.irpj,
        presuncaoCSLL: p.csll,
        baseIRPJ: _r(baseIRPJ),
        baseCSLL: _r(baseCSLL),
        irpjNormal: _r(irpjNormal),
        irpjAdicional: _r(irpjAdicional),
        irpjDevido: _r(irpjDevido),
        deducoes: _r(deducoes),
        irrfCompensavel: d.irrfCompensavel || 0,
        irpjAPagar: _r(irpjAPagar),
        saldoNegativo: irpjAPagar < 0 ? _r(Math.abs(irpjAPagar)) : 0,
        saldoNegativoDestinacao: irpjAPagar < 0 ? 'Compensável via PER/DCOMP (IN RFB 2.055/2021)' : null,
        csllDevida: _r(csllDevida),
        totalAPagar: _r(irpjAPagar + csllDevida)
      };
    },

    /**
     * ═══════════════════════════════════════════════════════════════════════
     * Calcular PIS/COFINS Não-Cumulativo
     * ═══════════════════════════════════════════════════════════════════════
     *
     * Aceita TANTO o campo consolidado "baseCreditos" QUANTO os campos
     * individuais (comprasBensRevenda, insumosProducao, etc.).
     *
     * DELEGAÇÃO: MotorLR.calcularPISCOFINSNaoCumulativo() + fallback
     * Base Legal: Lei 10.637/02 (PIS) + Lei 10.833/03 (COFINS)
     */
    pisCofins: function (dados) {
      var d = Object.assign({
        receitaBruta: 0, isentas: 0, exportacao: 0,
        // Campo consolidado (retrocompatível)
        baseCreditos: 0,
        // Campos individuais (do motor v4.6)
        comprasBensRevenda: 0,
        insumosProducao: 0,
        energiaEletrica: 0,
        alugueisPJ: 0,
        alugueisPF: 0,                          // v3.3 FIX #2: Aluguel PF — NÃO gera crédito (Lei 10.637/02, Art. 3º, IV)
        depreciacaoBens: 0,
        depreciacaoBensCredito: 0,               // v3.3 FIX #4: Renomeado para distinguir de depreciação contábil
        depreciacaoBensMetodo: 'CONTABIL',       // v3.3 FIX #4: 'CONTABIL' | 'FISCAL_1_48' | 'FISCAL_1_60'
        custoAquisicaoImobilizado: 0,            // v3.3 FIX #4: Para cálculo fiscal (1/48 ou 1/60 por mês)
        mesesUsoImobilizado: 0,                  // v3.3 FIX #4: Meses de uso do imobilizado para crédito fiscal
        devolucoes: 0,
        freteArmazenagem: 0,
        leasing: 0,
        outrosCreditos: 0,
        // CORREÇÃO BUG #8: Campo valeTransporteRefeicao agora é aceito e repassado ao motor
        valeTransporteRefeicao: 0
      }, dados);

      // ─── Se baseCreditos consolidado foi passado, distribuir para campos individuais ───
      // O motor só aceita campos individuais, não o consolidado "baseCreditos"
      var creditosIndividuais = {
        comprasBensRevenda: d.comprasBensRevenda,
        insumosProducao: d.insumosProducao,
        energiaEletrica: d.energiaEletrica,
        alugueisPJ: d.alugueisPJ,
        alugueisPF: d.alugueisPF,                               // v3.3 FIX #2: Repassar ao motor (sem crédito)
        depreciacaoBens: d.depreciacaoBens,
        depreciacaoBensCredito: d.depreciacaoBensCredito || d.depreciacaoBens || 0,  // v3.3 FIX #4: Retrocompatibilidade
        depreciacaoBensMetodo: d.depreciacaoBensMetodo,          // v3.3 FIX #4: Método de cálculo
        custoAquisicaoImobilizado: d.custoAquisicaoImobilizado,  // v3.3 FIX #4: Custo para método fiscal
        mesesUsoImobilizado: d.mesesUsoImobilizado,              // v3.3 FIX #4: Meses de uso
        devolucoes: d.devolucoes,
        freteArmazenagem: d.freteArmazenagem,
        leasing: d.leasing,
        // CORREÇÃO BUG #8: valeTransporteRefeicao somado em outrosCreditos (motor não tem campo separado)
        outrosCreditos: d.outrosCreditos + (d.valeTransporteRefeicao || 0)
      };

      // Se baseCreditos consolidado foi passado e campos individuais estão zerados,
      // colocar tudo em outrosCreditos para o motor somar corretamente
      // CORREÇÃO BUG #8: inclui valeTransporteRefeicao na verificação
      var somaIndividuais = d.comprasBensRevenda + d.insumosProducao
        + d.energiaEletrica + d.alugueisPJ + d.depreciacaoBens
        + d.devolucoes + d.freteArmazenagem + d.leasing + d.outrosCreditos
        + (d.valeTransporteRefeicao || 0);

      if (d.baseCreditos > 0 && somaIndividuais === 0) {
        creditosIndividuais.outrosCreditos = d.baseCreditos;
      }

      // DELEGAÇÃO AO MOTOR (v3.3) — MotorLR.calcularPISCOFINSNaoCumulativo()
      if (typeof MotorLR !== 'undefined' && MotorLR.calcularPISCOFINSNaoCumulativo) {
        var resultado = MotorLR.calcularPISCOFINSNaoCumulativo({
          receitaBruta: d.receitaBruta,
          receitasIsentas: d.isentas,
          receitasExportacao: d.exportacao,
          comprasBensRevenda: creditosIndividuais.comprasBensRevenda,
          insumosProducao: creditosIndividuais.insumosProducao,
          energiaEletrica: creditosIndividuais.energiaEletrica,
          alugueisPJ: creditosIndividuais.alugueisPJ,
          alugueisPF: creditosIndividuais.alugueisPF,                               // v3.3 FIX #2
          depreciacaoBensCredito: creditosIndividuais.depreciacaoBensCredito,         // v3.3 FIX #4: Campo renomeado
          depreciacaoBensMetodo: creditosIndividuais.depreciacaoBensMetodo,           // v3.3 FIX #4
          custoAquisicaoImobilizado: creditosIndividuais.custoAquisicaoImobilizado,   // v3.3 FIX #4
          mesesUsoImobilizado: creditosIndividuais.mesesUsoImobilizado,               // v3.3 FIX #4
          devolucoes: creditosIndividuais.devolucoes,
          freteArmazenagem: creditosIndividuais.freteArmazenagem,
          leasing: creditosIndividuais.leasing,
          outrosCreditos: creditosIndividuais.outrosCreditos
        });

        // Mapear retorno motor → interface esperada pelo mapeamento
        // Motor retorna: debitos.pis/cofins, creditos.*, aPagar.*, saldoCredor.*
        // Mapeamento espera campos flat adicionais: debitoPIS, creditoPIS, pisAPagar, totalAPagar
        return {
          receitaTributavel: _r(resultado.receitaTributavel),
          debitoPIS: _r(resultado.debitos.pis),
          debitoCOFINS: _r(resultado.debitos.cofins),
          creditoPIS: _r(resultado.creditos.pis),
          creditoCOFINS: _r(resultado.creditos.cofins),
          creditos: {
            baseTotal: _r(resultado.creditos.baseTotal),
            pis: _r(resultado.creditos.pis),
            cofins: _r(resultado.creditos.cofins),
            total: _r(resultado.creditos.total),
            detalhamento: resultado.creditos.detalhamento
          },
          pisAPagar: _r(resultado.aPagar.pis),
          cofinsAPagar: _r(resultado.aPagar.cofins),
          aPagar: {
            pis: _r(resultado.aPagar.pis),
            cofins: _r(resultado.aPagar.cofins),
            total: _r(resultado.aPagar.total)
          },
          saldoCredor: {
            pis: _r(resultado.saldoCredor.pis),
            cofins: _r(resultado.saldoCredor.cofins),
            total: _r(resultado.saldoCredor.total)
          },
          totalAPagar: _r(resultado.aPagar.total),
          // v3.3 FIX #5: Duas métricas de alíquota efetiva com labels claros
          aliquotaEfetiva: resultado.aliquotaEfetiva,
          aliquotaEfetivaBruta: resultado.aliquotaEfetivaBruta,
          aliquotaEfetivaDescricao: resultado.aliquotaEfetivaDescricao,
          economiaCreditos: _r(resultado.economiaCreditos),
          // v3.3 FIX #2 + #4: Alertas do motor (aluguel PF, depreciação, etc.)
          alertas: resultado.alertas || [],
          artigos: resultado.artigos
        };
      }

      // FALLBACK: implementação original caso o motor não esteja carregado
      // v3.3 FIX E2#5: Indicar modo fallback
      LR._modoFallback = true;
      if (LR._fallbackUsado.indexOf('pisCofins') === -1) LR._fallbackUsado.push('pisCofins');
      var alertasFallback = [];
      var totalBaseCreditos = d.baseCreditos;
      if (!totalBaseCreditos || totalBaseCreditos === 0) {
        totalBaseCreditos = somaIndividuais;
      }

      // v3.3 FIX #2: Aluguel PF não gera crédito — alertar
      if (d.alugueisPF > 0) {
        alertasFallback.push({
          tipo: 'ALERTA_ALUGUEL_PF',
          mensagem: 'Aluguel pago a Pessoa Física (R$ ' + d.alugueisPF.toFixed(2) + ') NÃO gera crédito PIS/COFINS. '
            + 'Apenas aluguéis pagos a Pessoa Jurídica permitem aproveitamento de crédito.',
          artigo: 'Lei 10.637/2002, Art. 3º, IV',
          valorSemCredito: d.alugueisPF
        });
      }

      // v3.3 FIX #4: Alerta sobre método contábil de depreciação
      if ((d.depreciacaoBens > 0 || d.depreciacaoBensCredito > 0) && d.depreciacaoBensMetodo === 'CONTABIL') {
        alertasFallback.push({
          tipo: 'ALERTA_DEPRECIACAO_CONTABIL',
          mensagem: 'Crédito de PIS/COFINS sobre depreciação calculado pela taxa contábil. '
            + 'O crédito fiscal correto segue regras próprias (1/48 do custo de aquisição para bens a partir de jan/2024, ou 1/60 para anteriores).',
          artigo: 'Lei 10.637/02, Art. 3º, VI',
          risco: 'Crédito calculado pode divergir do crédito fiscal permitido.'
        });
      }

      var tributavel = d.receitaBruta - d.isentas - d.exportacao;
      var debPIS = tributavel * LR.aliquotas.pisCofins.pisNaoCumulativo;
      var debCOFINS = tributavel * LR.aliquotas.pisCofins.cofinsNaoCumulativo;
      var credPIS = totalBaseCreditos * LR.aliquotas.pisCofins.pisNaoCumulativo;
      var credCOFINS = totalBaseCreditos * LR.aliquotas.pisCofins.cofinsNaoCumulativo;

      var pisAPagar = Math.max(debPIS - credPIS, 0);
      var cofinsAPagar = Math.max(debCOFINS - credCOFINS, 0);
      var saldoCredorPIS = Math.max(credPIS - debPIS, 0);
      var saldoCredorCOFINS = Math.max(credCOFINS - debCOFINS, 0);

      // v3.3 FIX #5: Duas métricas de alíquota efetiva
      var totalBrutoFB = debPIS + debCOFINS;
      var totalLiquidoFB = pisAPagar + cofinsAPagar;

      return {
        receitaTributavel: _r(tributavel),
        debitoPIS: _r(debPIS),
        debitoCOFINS: _r(debCOFINS),
        creditoPIS: _r(credPIS),
        creditoCOFINS: _r(credCOFINS),
        creditos: {
          baseTotal: _r(totalBaseCreditos),
          pis: _r(credPIS),
          cofins: _r(credCOFINS),
          total: _r(credPIS + credCOFINS),
          detalhamento: {
            comprasBensRevenda: d.comprasBensRevenda,
            insumosProducao: d.insumosProducao,
            energiaEletrica: d.energiaEletrica,
            alugueisPJ: d.alugueisPJ,
            alugueisPF_semCredito: d.alugueisPF,
            depreciacaoBens: d.depreciacaoBens,
            depreciacaoMetodoUsado: d.depreciacaoBensMetodo || 'CONTABIL',
            devolucoes: d.devolucoes,
            freteArmazenagem: d.freteArmazenagem,
            leasing: d.leasing,
            outrosCreditos: d.outrosCreditos
          }
        },
        pisAPagar: _r(pisAPagar),
        cofinsAPagar: _r(cofinsAPagar),
        aPagar: {
          pis: _r(pisAPagar),
          cofins: _r(cofinsAPagar),
          total: _r(pisAPagar + cofinsAPagar)
        },
        saldoCredor: {
          pis: _r(saldoCredorPIS),
          cofins: _r(saldoCredorCOFINS),
          total: _r(saldoCredorPIS + saldoCredorCOFINS)
        },
        totalAPagar: _r(pisAPagar + cofinsAPagar),
        // v3.3 FIX #5: Duas métricas claras
        aliquotaEfetiva: d.receitaBruta > 0
          ? _r(totalLiquidoFB / d.receitaBruta * 100) + '%'
          : '0%',
        aliquotaEfetivaBruta: d.receitaBruta > 0
          ? _r(totalBrutoFB / d.receitaBruta * 100) + '%'
          : '0%',
        aliquotaEfetivaDescricao: {
          liquida: 'Alíquota efetiva LÍQUIDA = (PIS+COFINS a pagar) ÷ Receita Bruta — carga real após créditos',
          bruta: 'Alíquota efetiva BRUTA = (débitos PIS+COFINS) ÷ Receita Bruta — antes dos créditos',
          nota: 'Use LÍQUIDA para carga tributária real. BRUTA para composição analítica e benchmarking.'
        },
        economiaCreditos: _r(credPIS + credCOFINS),
        alertas: alertasFallback,
        artigos: 'Lei 10.637/02, Lei 10.833/03'
      };
    },

    /**
     * Calcular retenções integradas de uma NF
     * DELEGAÇÃO: MotorLR.calcularRetencaoIntegrada() + fallback
     * Base Legal: Art. 714-786
     */
    retencoesNF: function (valorNF, opts) {
      var o = Object.assign({ admPublica: false, simplesNacional: false, temCSRF: true, iss: 0 }, opts);

      // Simples Nacional — sem retenções federais (atalho, não precisa chamar motor)
      if (o.simplesNacional) return { irrf: 0, csrf: 0, iss: 0, total: 0, liquido: valorNF, nota: 'Simples Nacional — sem retenções federais' };

      // DELEGAÇÃO AO MOTOR (v2.3) — MotorLR.calcularRetencaoIntegrada()
      if (typeof MotorLR !== 'undefined' && MotorLR.calcularRetencaoIntegrada) {
        var resultado = MotorLR.calcularRetencaoIntegrada({
          valorBrutoNF: valorNF,
          tipoServico: 'SERVICOS_PROFISSIONAIS',
          prestadorSimples: false,
          retencaoISS: o.iss > 0,
          aliquotaISS: o.iss || LR.getAliquotaISS(),
          tomadorAdmPublica: o.admPublica,
          tipoReceitaAdmPublica: 'SERVICOS'
        });

        // Mapear retorno motor → interface esperada pelo mapeamento
        // Motor retorna estrutura mais detalhada; mapeamento espera campos flat
        var csrfTotal = o.temCSRF ? resultado.csrf.total : 0;
        var totalRetido = resultado.irrf.valor + csrfTotal + resultado.iss.valor;

        return {
          valorBruto: _r(valorNF),
          irrf: _r(resultado.irrf.valor),
          irrfAliquota: o.admPublica ? '4,8%' : '1,5%',
          csrfPIS: _r(o.temCSRF ? resultado.csrf.pis : 0),
          csrfCOFINS: _r(o.temCSRF ? resultado.csrf.cofins : 0),
          csrfCSLL: _r(o.temCSRF ? resultado.csrf.csll : 0),
          csrfTotal: _r(csrfTotal),
          iss: _r(resultado.iss.valor),
          totalRetido: _r(totalRetido),
          liquido: _r(valorNF - totalRetido)
        };
      }

      // FALLBACK: implementação original caso o motor não esteja carregado
      var irrf = o.admPublica ? valorNF * 0.048 : valorNF * 0.015;
      var csrf = o.temCSRF ? valorNF * 0.0465 : 0;
      var iss = valorNF * o.iss;
      var total = irrf + csrf + iss;

      return {
        valorBruto: _r(valorNF),
        irrf: _r(irrf), irrfAliquota: o.admPublica ? '4,8%' : '1,5%',
        csrfPIS: _r(valorNF * 0.0065), csrfCOFINS: _r(valorNF * 0.03), csrfCSLL: _r(valorNF * 0.01),
        csrfTotal: _r(csrf),
        iss: _r(iss),
        totalRetido: _r(total),
        liquido: _r(valorNF - total)
      };
    },

    /**
     * Calcular Lucro da Exploração (SUDAM/SUDENE)
     * Base Legal: Art. 615-627
     */
    lucroExploracao: function (dados) {
      // DELEGAÇÃO AO MOTOR (v3.0) — MotorLR.calcularLucroExploracao()
      if (typeof MotorLR !== 'undefined' && MotorLR.calcularLucroExploracao) {
        var d = Object.assign({
          lucroLiquido: 0, receitasFinanceirasLiquidas: 0,
          resultadoMEP: 0, resultadoNaoOperacional: 0,
          receitasAnteriores: 0, csllDevida: 0, despFinLiquidas: 0
        }, dados);

        // Mapear parâmetros mapeamento → motor
        var resultado = MotorLR.calcularLucroExploracao({
          lucroLiquido: d.lucroLiquido,
          receitasFinanceiras: Math.max(d.receitasFinanceirasLiquidas, 0),
          despesasFinanceiras: Math.max(-d.receitasFinanceirasLiquidas, 0) + d.despFinLiquidas,
          resultadoParticipacoes: d.resultadoMEP,
          ganhosCapitalAtivoNaoCirc: Math.max(d.resultadoNaoOperacional, 0),
          perdasCapitalAtivoNaoCirc: Math.max(-d.resultadoNaoOperacional, 0),
          receitasExerciciosAnteriores: d.receitasAnteriores,
          csllDevida: d.csllDevida
        });

        // Mapear retorno motor → interface esperada pelo mapeamento
        // v3.2 FIX: null-safe — 0 é falsy em JS, usar != null em vez de ||
        var lucroExp = (resultado.lucroExploracao != null)
          ? resultado.lucroExploracao
          : (resultado.lucroExploracaoBruto != null ? resultado.lucroExploracaoBruto : 0);
        var reducao75 = Math.max(lucroExp, 0) * LR.aliquotas.irpj.normal * 0.75;

        return {
          lucroLiquido: d.lucroLiquido,
          exclusoes: _r(resultado.exclusoes ? resultado.exclusoes.total : 0),
          adicoes: _r(resultado.adicoes ? resultado.adicoes.total : 0),
          lucroExploracao: _r(lucroExp),
          irpjSobreExploracao: _r(Math.max(lucroExp, 0) * 0.15),
          reducao75: _r(reducao75),
          irpjAposReducao: _r(Math.max(lucroExp, 0) * 0.15 - reducao75)
        };
      }

      // FALLBACK: implementação original caso o motor não esteja carregado
      var d = Object.assign({
        lucroLiquido: 0, receitasFinanceirasLiquidas: 0,
        resultadoMEP: 0, resultadoNaoOperacional: 0,
        receitasAnteriores: 0, csllDevida: 0, despFinLiquidas: 0
      }, dados);

      var exclusoes = d.receitasFinanceirasLiquidas + Math.max(d.resultadoMEP, 0) +
        Math.max(d.resultadoNaoOperacional, 0) + d.receitasAnteriores;
      var adicoes = d.csllDevida + d.despFinLiquidas + Math.abs(Math.min(d.resultadoMEP, 0));
      var lucroExploracao = d.lucroLiquido - exclusoes + adicoes;
      var reducao75 = Math.max(lucroExploracao, 0) * LR.aliquotas.irpj.normal * 0.75;

      return {
        lucroLiquido: d.lucroLiquido,
        exclusoes: _r(exclusoes), adicoes: _r(adicoes),
        lucroExploracao: _r(lucroExploracao),
        irpjSobreExploracao: _r(Math.max(lucroExploracao, 0) * 0.15),
        reducao75: _r(reducao75),
        irpjAposReducao: _r(Math.max(lucroExploracao, 0) * 0.15 - reducao75)
      };
    },

    /**
     * ═══════════════════════════════════════════════════════════════════════
     * Compensar Integrado — Prejuízos operacionais, não-operacionais e CSLL
     * ═══════════════════════════════════════════════════════════════════════
     *
     * DELEGAÇÃO: MotorLR.compensarIntegrado() + fallback
     * Correção Falha #7: Motor calcula economia IRPJ corretamente (normal+adicional)
     * Correção Falha #4: Motor elimina simulação "lucro líquido = -R$" incorreta
     * Base Legal: Art. 579-586
     */
    compensarIntegrado: function (dados) {
      // DELEGAÇÃO AO MOTOR (v2.3) — MotorLR.compensarIntegrado()
      // Interface idêntica: mesmos parâmetros e mesma estrutura de retorno
      if (typeof MotorLR !== 'undefined' && MotorLR.compensarIntegrado) {
        var resultado = MotorLR.compensarIntegrado(dados);

        // v3.2: Consolidar compensacaoEfetiva no resumo (downstream acessa este campo)
        if (resultado && resultado.resumo && !resultado.resumo.compensacaoEfetiva) {
          resultado.resumo.compensacaoEfetiva = {
            prejuizoOperacional: resultado.etapa3_compensacaoOperacional
              ? (resultado.etapa3_compensacaoOperacional.compensacaoEfetiva || 0)
              : 0,
            prejuizoNaoOperacional: resultado.etapa2_compensacaoNaoOperacional
              ? (resultado.etapa2_compensacaoNaoOperacional.compensacaoEfetiva || 0)
              : 0,
            baseNegativaCSLL: resultado.etapa4_compensacaoCSLL
              ? (resultado.etapa4_compensacaoCSLL.compensacaoEfetiva || 0)
              : 0
          };
        }

        return resultado;
      }

      // FALLBACK: implementação original caso o motor não esteja carregado
      // v3.3 FIX E2#3: Adicionado 'financeira' para alíquota CSLL correta (9% geral / 15% financeiras)
      // v3.3 FIX E2#5: Indicar modo fallback
      LR._modoFallback = true;
      if (LR._fallbackUsado.indexOf('compensarIntegrado') === -1) LR._fallbackUsado.push('compensarIntegrado');
      var d = Object.assign({
        lucroLiquido: 0, adicoes: 0, exclusoes: 0,
        saldoPrejuizoOperacional: 0,
        saldoPrejuizoNaoOperacional: 0,
        saldoBaseNegativaCSLL: 0,
        lucroNaoOperacional: 0,
        atividadeRural: false,
        trimestral: true,
        financeira: false
      }, dados);

      var lucroAjustado = d.lucroLiquido + d.adicoes - d.exclusoes;

      var resultado = {
        etapa1_lucroAjustado: {
          lucroLiquido: d.lucroLiquido,
          adicoes: d.adicoes,
          exclusoes: d.exclusoes,
          lucroRealAjustado: lucroAjustado,
          temLucro: lucroAjustado > 0,
          temPrejuizo: lucroAjustado < 0,
          artigo: 'Art. 579-580'
        },
        etapa2_compensacaoNaoOperacional: null,
        etapa3_compensacaoOperacional: null,
        etapa4_compensacaoCSLL: null,
        resumo: {
          lucroRealAntes: lucroAjustado,
          totalCompensado: 0,
          lucroRealFinal: lucroAjustado,
          baseCSLLFinal: lucroAjustado,
          saldosPosCompensacao: {
            prejuizoOperacional: d.saldoPrejuizoOperacional,
            prejuizoNaoOperacional: d.saldoPrejuizoNaoOperacional,
            baseNegativaCSLL: d.saldoBaseNegativaCSLL
          },
          economia: { irpj: 0, csll: 0, total: 0 }
        },
        artigo: 'Art. 579-586',
        trimestral: d.trimestral
      };

      if (lucroAjustado <= 0) {
        var novoPrejuizo = Math.abs(lucroAjustado);
        var prejNaoOp = d.lucroNaoOperacional < 0 ? Math.abs(d.lucroNaoOperacional) : 0;
        var prejOp = novoPrejuizo - prejNaoOp;

        resultado.resumo.novoPrejuizoOperacional = Math.max(0, prejOp);
        resultado.resumo.novoPrejuizoNaoOperacional = prejNaoOp;
        resultado.resumo.saldosPosCompensacao.prejuizoOperacional = d.saldoPrejuizoOperacional + Math.max(0, prejOp);
        resultado.resumo.saldosPosCompensacao.prejuizoNaoOperacional = d.saldoPrejuizoNaoOperacional + prejNaoOp;
        resultado.resumo.saldosPosCompensacao.baseNegativaCSLL = d.saldoBaseNegativaCSLL + novoPrejuizo;
        resultado.resumo.lucroRealFinal = 0;
        resultado.resumo.baseCSLLFinal = 0;
        resultado.resumo.observacao = 'Prejuízo fiscal no período: R$ ' + novoPrejuizo.toFixed(2) + ' — registrar na Parte B do LALUR/LACS';
        return resultado;
      }

      var lucroRealCorrente = lucroAjustado;
      var baseCSLLCorrente = lucroAjustado;

      // Helper local para IRPJ (fallback — usa limiar correto por período)
      var _limAdicFallback = d.trimestral ? LR.aliquotas.irpj.limiteAdicionalTrimestre : LR.aliquotas.irpj.limiteAdicionalAno;
      function _calcIRPJFallback(lr) {
        if (lr <= 0) return 0;
        var n = lr * LR.aliquotas.irpj.normal;
        var a = Math.max(0, lr - _limAdicFallback) * LR.aliquotas.irpj.adicional;
        return n + a;
      }

      if (d.lucroNaoOperacional > 0 && d.saldoPrejuizoNaoOperacional > 0) {
        var limNaoOp = d.lucroNaoOperacional * 0.30;
        var compNaoOp = Math.min(limNaoOp, d.saldoPrejuizoNaoOperacional);

        resultado.etapa2_compensacaoNaoOperacional = {
          lucroNaoOperacional: d.lucroNaoOperacional,
          saldoPrejuizoAnterior: d.saldoPrejuizoNaoOperacional,
          compensacaoPermitida: _r(limNaoOp),
          compensacaoEfetiva: _r(compNaoOp),
          saldoPrejuizoRemanescente: _r(d.saldoPrejuizoNaoOperacional - compNaoOp),
          artigo: 'Art. 581'
        };

        lucroRealCorrente -= compNaoOp;
        baseCSLLCorrente -= compNaoOp;
        resultado.resumo.totalCompensado += compNaoOp;
        resultado.resumo.saldosPosCompensacao.prejuizoNaoOperacional = _r(d.saldoPrejuizoNaoOperacional - compNaoOp);
      }

      if (lucroRealCorrente > 0 && d.saldoPrejuizoOperacional > 0) {
        var limOp = d.atividadeRural ? lucroRealCorrente : lucroRealCorrente * 0.30;
        var compOp = Math.min(limOp, d.saldoPrejuizoOperacional);

        var irpjSem = _calcIRPJFallback(lucroRealCorrente);
        var irpjCom = _calcIRPJFallback(lucroRealCorrente - compOp);

        resultado.etapa3_compensacaoOperacional = {
          lucroRealAjustado: _r(lucroRealCorrente),
          saldoPrejuizoAnterior: d.saldoPrejuizoOperacional,
          compensacaoPermitida: _r(limOp),
          compensacaoEfetiva: _r(compOp),
          lucroRealAposCompensacao: _r(lucroRealCorrente - compOp),
          saldoPrejuizoRemanescente: _r(d.saldoPrejuizoOperacional - compOp),
          atividadeRural: d.atividadeRural,
          economia: { irpj: _r(irpjSem - irpjCom) },
          artigo: d.atividadeRural ? 'Art. 583' : 'Art. 580'
        };

        lucroRealCorrente -= compOp;
        // baseCSLLCorrente -= compOp; // REMOVIDO: prejuízo fiscal operacional (Art. 580-581 RIR/2018) é exclusivo do IRPJ; CSLL usa base negativa própria (Lei 9.065/1995, art. 16)
        resultado.resumo.totalCompensado += compOp;
        resultado.resumo.saldosPosCompensacao.prejuizoOperacional = _r(d.saldoPrejuizoOperacional - compOp);
        resultado.resumo.economia.irpj += _r(irpjSem - irpjCom);
      }

      if (baseCSLLCorrente > 0 && d.saldoBaseNegativaCSLL > 0) {
        var limCSLL = baseCSLLCorrente * 0.30;
        var compCSLL = Math.min(limCSLL, d.saldoBaseNegativaCSLL);
        // v3.3 FIX E2#3: Alíquota CSLL dinâmica — 15% para financeiras (Lei 13.169/2015), 9% geral
        var aliqCSLLComp = (d.financeira === true || d.financeira === 'true') ? 0.15 : 0.09;
        var economiaCSLL = compCSLL * aliqCSLLComp;

        resultado.etapa4_compensacaoCSLL = {
          baseCalculoCSLL: _r(baseCSLLCorrente),
          saldoBaseNegativaAnterior: d.saldoBaseNegativaCSLL,
          compensacaoPermitida: _r(limCSLL),
          compensacaoEfetiva: _r(compCSLL),
          baseCSLLAposCompensacao: _r(baseCSLLCorrente - compCSLL),
          saldoBaseNegativaRemanescente: _r(d.saldoBaseNegativaCSLL - compCSLL),
          economia: { csll: _r(economiaCSLL) },
          artigo: 'Lei 9.065/1995, art. 16'
        };

        baseCSLLCorrente -= compCSLL;
        resultado.resumo.saldosPosCompensacao.baseNegativaCSLL = _r(d.saldoBaseNegativaCSLL - compCSLL);
        resultado.resumo.economia.csll += _r(economiaCSLL);
      }

      resultado.resumo.lucroRealFinal = _r(Math.max(0, lucroRealCorrente));
      resultado.resumo.baseCSLLFinal = _r(Math.max(0, baseCSLLCorrente));
      resultado.resumo.economia.total = (function() {
        var _ecoPisCofins = resultado.resumo.economia.pisCofins
          || resultado.resumo.economia.creditosPisCofins || 0;
        return _r(
          resultado.resumo.economia.irpj +
          resultado.resumo.economia.csll +
          _ecoPisCofins
        );
      })();

      // CORREÇÃO v3.1: Adicionar compensacaoEfetiva ao resumo para estudos.js
      // estudos.js acessa r.compensacao.resumo.compensacaoEfetiva.prejuizoOperacional
      resultado.resumo.compensacaoEfetiva = {
        prejuizoOperacional: resultado.etapa3_compensacaoOperacional
          ? (resultado.etapa3_compensacaoOperacional.compensacaoEfetiva || 0)
          : 0,
        prejuizoNaoOperacional: resultado.etapa2_compensacaoNaoOperacional
          ? (resultado.etapa2_compensacaoNaoOperacional.compensacaoEfetiva || 0)
          : 0,
        baseNegativaCSLL: resultado.etapa4_compensacaoCSLL
          ? (resultado.etapa4_compensacaoCSLL.compensacaoEfetiva || 0)
          : 0
      };

      return resultado;
    },

    /**
     * ═══════════════════════════════════════════════════════════════════════
     * Compensar Retenções
     * ═══════════════════════════════════════════════════════════════════════
     *
     * Compensa retenções sofridas (IRRF, PIS, COFINS, CSLL) com tributos devidos.
     * IRRF → IRPJ; PIS → PIS; COFINS → COFINS; CSLL → CSLL
     *
     * DELEGAÇÃO: MotorLR.compensarRetencoes() + fallback
     * Base Legal: Art. 717 (IRRF); Lei 10.833/2003, art. 36 (CSRF)
     */
    compensarRetencoes: function (params) {
      // DELEGAÇÃO AO MOTOR (v2.3) — MotorLR.compensarRetencoes()
      // Interface idêntica: { retencoesSofridas, tributosDevidos }
      if (typeof MotorLR !== 'undefined' && MotorLR.compensarRetencoes) {
        return MotorLR.compensarRetencoes(params);
      }

      // FALLBACK: implementação original caso o motor não esteja carregado
      var ret = params.retencoesSofridas || {};
      var trib = params.tributosDevidos || {};

      var irrfCompensavel = Math.min(ret.irrf || 0, trib.irpj || 0);
      var saldoIRRF = _r((ret.irrf || 0) - irrfCompensavel);

      var pisCompensavel = Math.min(ret.pis || 0, trib.pis || 0);
      var saldoPIS = _r((ret.pis || 0) - pisCompensavel);

      var cofinsCompensavel = Math.min(ret.cofins || 0, trib.cofins || 0);
      var saldoCOFINS = _r((ret.cofins || 0) - cofinsCompensavel);

      var csllCompensavel = Math.min(ret.csll || 0, trib.csll || 0);
      var saldoCSLL = _r((ret.csll || 0) - csllCompensavel);

      var totalCompensado = _r(irrfCompensavel + pisCompensavel + cofinsCompensavel + csllCompensavel);
      var totalSaldoCredor = _r(saldoIRRF + saldoPIS + saldoCOFINS + saldoCSLL);

      return {
        descricao: 'Compensação de retenções sofridas com tributos devidos',
        baseLegal: 'Art. 717 (IRRF); Lei 10.833/2003, art. 36 (CSRF)',
        retencoesSofridas: {
          irrf: ret.irrf || 0, pis: ret.pis || 0,
          cofins: ret.cofins || 0, csll: ret.csll || 0,
          total: _r((ret.irrf || 0) + (ret.pis || 0) + (ret.cofins || 0) + (ret.csll || 0))
        },
        tributosDevidos: {
          irpj: trib.irpj || 0, csll: trib.csll || 0,
          pis: trib.pis || 0, cofins: trib.cofins || 0,
          total: _r((trib.irpj || 0) + (trib.csll || 0) + (trib.pis || 0) + (trib.cofins || 0))
        },
        compensacao: {
          irrf_com_irpj: _r(irrfCompensavel),
          pis_com_pis: _r(pisCompensavel),
          cofins_com_cofins: _r(cofinsCompensavel),
          csll_com_csll: _r(csllCompensavel),
          totalCompensado: totalCompensado
        },
        tributosARecolher: {
          irpj: _r((trib.irpj || 0) - irrfCompensavel),
          csll: _r((trib.csll || 0) - csllCompensavel),
          pis: _r((trib.pis || 0) - pisCompensavel),
          cofins: _r((trib.cofins || 0) - cofinsCompensavel),
          total: _r(
            (trib.irpj || 0) - irrfCompensavel +
            (trib.csll || 0) - csllCompensavel +
            (trib.pis || 0) - pisCompensavel +
            (trib.cofins || 0) - cofinsCompensavel
          ),
          saldoCredorPorTributo: {
            irpj: (trib.irpj || 0) - irrfCompensavel < 0 ? { valor: _r(Math.abs((trib.irpj || 0) - irrfCompensavel)), destinacao: 'PER/DCOMP ou restituição' } : null,
            csll: (trib.csll || 0) - csllCompensavel < 0 ? { valor: _r(Math.abs((trib.csll || 0) - csllCompensavel)), destinacao: 'PER/DCOMP ou restituição' } : null,
            pis: (trib.pis || 0) - pisCompensavel < 0 ? { valor: _r(Math.abs((trib.pis || 0) - pisCompensavel)), destinacao: 'PER/DCOMP ou restituição' } : null,
            cofins: (trib.cofins || 0) - cofinsCompensavel < 0 ? { valor: _r(Math.abs((trib.cofins || 0) - cofinsCompensavel)), destinacao: 'PER/DCOMP ou restituição' } : null
          }
        },
        saldoCredor: {
          irrf: saldoIRRF, pis: saldoPIS,
          cofins: saldoCOFINS, csll: saldoCSLL,
          total: totalSaldoCredor,
          destinacao: totalSaldoCredor > 0
            ? 'Saldo credor pode ser compensado em períodos seguintes via PER/DCOMP ou pedido de restituição'
            : 'Sem saldo credor'
        }
      };
    },

    /**
     * ═══════════════════════════════════════════════════════════════════════
     * Saldo Negativo de IRPJ
     * ═══════════════════════════════════════════════════════════════════════
     *
     * DELEGAÇÃO: MotorLR.calcularSaldoNegativo() + fallback
     * Base Legal: Art. 235
     */
    saldoNegativo: function (irpjDevido, retencoesFonte, estimativasPagas, taxaSelic) {
      // CORREÇÃO v3.1: Aceitar TANTO objeto QUANTO parâmetros posicionais
      // estudos.js chama com { irpjDevido, retencoesFonte, estimativasPagas }
      if (typeof irpjDevido === 'object' && irpjDevido !== null) {
        var _obj = irpjDevido;
        irpjDevido = _obj.irpjDevido || 0;
        retencoesFonte = _obj.retencoesFonte || 0;
        estimativasPagas = _obj.estimativasPagas || 0;
        taxaSelic = _obj.taxaSelic || 0;
      }

      // DELEGAÇÃO AO MOTOR (v2.3) — MotorLR.calcularSaldoNegativo()
      if (typeof MotorLR !== 'undefined' && MotorLR.calcularSaldoNegativo) {
        return MotorLR.calcularSaldoNegativo(irpjDevido, retencoesFonte, estimativasPagas, taxaSelic || 0);
      }

      // FALLBACK: implementação original caso o motor não esteja carregado
      taxaSelic = taxaSelic || 0;
      var totalPago = (retencoesFonte || 0) + (estimativasPagas || 0);
      var saldo = totalPago - irpjDevido;

      if (saldo <= 0) {
        return { temSaldoNegativo: false, irpjAPagar: _r(Math.abs(saldo)) };
      }

      return {
        temSaldoNegativo: true,
        saldoNegativo: _r(saldo),
        valorOriginal: _r(saldo),
        atualizacaoSelic: _r(saldo * taxaSelic),
        valorAtualizado: _r(saldo * (1 + taxaSelic)),
        compensacao: 'Via PER/DCOMP (compensação com outros tributos federais)',
        restituicao: 'Possível via PER/DCOMP (mais demorado)',
        prazoDecadencial: '5 anos',
        alerta: 'Verificar retenções não compensadas — dinheiro potencialmente "esquecido"',
        artigo: 'Art. 235'
      };
    },

    /**
     * ═══════════════════════════════════════════════════════════════════════
     * Depreciação Completa — Portado do motor v4.6
     * ═══════════════════════════════════════════════════════════════════════
     *
     * Calcula depreciação com suporte a: bens usados (Art. 322),
     * aceleração por turnos (Art. 323), incentivada (Art. 324-329),
     * proporcional ao período de uso.
     *
     * Base Legal: Art. 311-330
     */
    depreciacaoCompleta: function (bem) {
      // DELEGAÇÃO AO MOTOR (v3.0) — MotorLR.calcularDepreciacaoCompleta()
      // CORREÇÃO FALHA #1: Motor retorna depreciacaoNormal (contábil/linear para DRE)
      // separada de depreciacaoIncentivada (diferença fiscal para exclusão no LALUR)
      if (typeof MotorLR !== 'undefined' && MotorLR.calcularDepreciacaoCompleta) {
        var resultado = MotorLR.calcularDepreciacaoCompleta(bem);

        // Motor retorna erro como { erro: string }
        if (resultado.erro) return resultado;

        // Motor retorna casos especiais (não-produção, pequeno valor) diretamente
        if (resultado.dedutivel === false || resultado.depreciacaoPeriodo !== undefined) {
          return resultado;
        }

        // Garantir que depreciacaoNormal e depreciacaoIncentivada estejam presentes
        // (o motor já os retorna separados — Falha #1 corrigida)
        return resultado;
      }

      // FALLBACK: implementação original caso o motor não esteja carregado
      var d = Object.assign({
        tipo: null, custoAquisicao: 0, depreciacaoAcumulada: 0,
        usado: false, vidaUtilRestante: null, turnos: 1,
        incentivo: null, mesesUso: 12, relacionadoProducao: true
      }, bem);

      if (!d.tipo || d.custoAquisicao <= 0) {
        return { erro: 'Tipo do bem e custo de aquisição positivo são obrigatórios' };
      }

      if (!d.relacionadoProducao) {
        return {
          tipo: d.tipo, custoAquisicao: d.custoAquisicao,
          depreciacaoPeriodo: 0, dedutivel: false,
          artigo: 'Art. 317 §5º',
          motivo: 'Bem não relacionado com produção/comercialização — depreciação indedutível'
        };
      }

      // Art. 313 §1º: Bem de pequeno valor
      if (d.custoAquisicao <= LR.limites.ativoDespesaDireta) {
        return {
          tipo: d.tipo, custoAquisicao: d.custoAquisicao,
          depreciacaoPeriodo: d.custoAquisicao, dedutivel: true,
          artigo: 'Art. 313 §1º I',
          motivo: 'Valor ≤ R$ ' + LR.limites.ativoDespesaDireta + ' — dedução integral como despesa'
        };
      }

      // Tabela de taxas fiscais (mapeamento tipo → dados)
      var TAXAS = {
        edificios:          { taxa: 0.04, vidaUtil: 25 },
        instalacoes:        { taxa: 0.10, vidaUtil: 10 },
        maquinas:           { taxa: 0.10, vidaUtil: 10 },
        moveis:             { taxa: 0.10, vidaUtil: 10 },
        veiculosPassageiro: { taxa: 0.20, vidaUtil: 5 },
        veiculosCarga:      { taxa: 0.20, vidaUtil: 5 },
        computadores:       { taxa: 0.20, vidaUtil: 5 },
        software:           { taxa: 0.20, vidaUtil: 5 },
        ferramentas:        { taxa: 0.20, vidaUtil: 5 },
        tratores:           { taxa: 0.25, vidaUtil: 4 },
        drones:             { taxa: 0.20, vidaUtil: 5 },
        gps_topografia:     { taxa: 0.20, vidaUtil: 5 }
      };

      var ACELERADA = {
        atividadeRural:    { taxa: 1.0, multiplicador: null },
        pesquisaInovacao:  { taxa: 1.0, multiplicador: null },
        sudamSudene:       { taxa: 1.0, multiplicador: null },
        veiculosCarga3x:   { taxa: null, multiplicador: 3 }
      };

      var TURNOS = { 1: 1.0, 2: 1.5, 3: 2.0 };

      var infoBem = TAXAS[d.tipo];
      if (!infoBem) {
        return { erro: 'Tipo de bem "' + d.tipo + '" não encontrado na tabela de depreciação' };
      }

      var taxaAnual = infoBem.taxa;
      var vidaUtilEfetiva = infoBem.vidaUtil;

      // Art. 322: Bens usados
      if (d.usado) {
        var metadeVidaNovo = infoBem.vidaUtil / 2;
        var restante = d.vidaUtilRestante || metadeVidaNovo;
        vidaUtilEfetiva = Math.max(metadeVidaNovo, restante);
        taxaAnual = 1 / vidaUtilEfetiva;
      }

      // Art. 323: Aceleração por turnos
      var multiplicadorTurnos = 1;
      if (d.tipo !== 'edificios' && d.turnos >= 2) {
        multiplicadorTurnos = TURNOS[d.turnos] || 1;
      }

      var taxaEfetiva = taxaAnual * multiplicadorTurnos;
      var depreciacaoAnualBruta = d.custoAquisicao * taxaEfetiva;

      var fatorProporcional = d.mesesUso / 12;
      var depreciacaoPeriodo = depreciacaoAnualBruta * fatorProporcional;

      // Art. 317 §3º: Limite
      var saldoDepreciavel = Math.max(0, d.custoAquisicao - d.depreciacaoAcumulada);
      depreciacaoPeriodo = Math.min(depreciacaoPeriodo, saldoDepreciavel);

      // Depreciação incentivada (Art. 324-329)
      var depreciacaoIncentivada = 0;
      var exclusaoLalur = 0;
      var adicaoFuturaLalur = false;

      if (d.incentivo && ACELERADA[d.incentivo]) {
        var inc = ACELERADA[d.incentivo];
        if (inc.taxa === 1.0) {
          depreciacaoIncentivada = Math.max(0, saldoDepreciavel - depreciacaoPeriodo);
          exclusaoLalur = depreciacaoIncentivada;
        } else if (inc.multiplicador) {
          var depAcelerada = d.custoAquisicao * taxaAnual * inc.multiplicador * fatorProporcional;
          depreciacaoIncentivada = Math.max(0, Math.min(depAcelerada - depreciacaoPeriodo, saldoDepreciavel - depreciacaoPeriodo));
          exclusaoLalur = depreciacaoIncentivada;
        }
        adicaoFuturaLalur = true;
      }

      var depreciacaoTotalPeriodo = depreciacaoPeriodo + depreciacaoIncentivada;
      var novaDepreciacaoAcumulada = d.depreciacaoAcumulada + depreciacaoTotalPeriodo;
      var limiteAtingido = novaDepreciacaoAcumulada >= d.custoAquisicao;

      return {
        tipo: d.tipo,
        custoAquisicao: d.custoAquisicao,
        depreciacaoAcumuladaAnterior: d.depreciacaoAcumulada,
        saldoDepreciavelAnterior: saldoDepreciavel,
        taxaNormal: infoBem.taxa,
        taxaEfetiva: taxaEfetiva,
        multiplicadorTurnos: multiplicadorTurnos,
        mesesUso: d.mesesUso,
        depreciacaoNormal: _r(depreciacaoPeriodo),
        depreciacaoIncentivada: _r(depreciacaoIncentivada),
        exclusaoLalur: _r(exclusaoLalur),
        depreciacaoTotalPeriodo: _r(depreciacaoTotalPeriodo),
        novaDepreciacaoAcumulada: _r(novaDepreciacaoAcumulada),
        saldoDepreciavelRestante: _r(Math.max(0, d.custoAquisicao - novaDepreciacaoAcumulada)),
        limiteAtingido: limiteAtingido,
        adicaoFuturaLalur: adicaoFuturaLalur,
        dedutivel: true,
        vidaUtilEfetiva: vidaUtilEfetiva,
        bemUsado: d.usado,
        incentivo: d.incentivo || null,
        economia: {
          irpj: _r(depreciacaoTotalPeriodo * 0.25),
          csll: _r(depreciacaoTotalPeriodo * 0.09),
          total: _r(depreciacaoTotalPeriodo * 0.34)
        },
        alertas: limiteAtingido
          ? ['Limite de depreciação atingido. A partir do próximo período, depreciação contábil deverá ser ADICIONADA ao lucro real (Art. 324 §3º / Art. 321 §único)']
          : []
      };
    },

    /**
     * ═══════════════════════════════════════════════════════════════════════
     * Incentivos Fiscais — Portado do motor v4.6
     * ═══════════════════════════════════════════════════════════════════════
     *
     * Calcula deduções do IRPJ por incentivos fiscais.
     * Base Legal: Art. 226 + Art. 228 + Art. 625-646
     */
    incentivos: function (irpjNormal, despesas) {
      // DELEGAÇÃO AO MOTOR (v3.0) — MotorLR.calcularIncentivos()
      if (typeof MotorLR !== 'undefined' && MotorLR.calcularIncentivos) {
        // Motor usa mesma assinatura: (irpjNormal, despesas)
        // Motor pode usar IDs diferentes (IDOSO vs FUNDO_IDOSO, PRONAS vs PRONAS_PCD)
        // Mapear IDs do mapeamento → motor se necessário
        var despesasMotor = Object.assign({}, despesas || {});
        if (despesasMotor.FUNDO_IDOSO && !despesasMotor.IDOSO) {
          despesasMotor.IDOSO = despesasMotor.FUNDO_IDOSO;
        }
        if (despesasMotor.PRONAS_PCD && !despesasMotor.PRONAS) {
          despesasMotor.PRONAS = despesasMotor.PRONAS_PCD;
        }

        return MotorLR.calcularIncentivos(irpjNormal, despesasMotor);
      }

      // FALLBACK: implementação original caso o motor não esteja carregado
      despesas = despesas || {};

      var INCENTIVOS = [
        { id: 'PAT', descricao: 'Programa de Alimentação do Trabalhador', limitePercentualIRPJ: 0.04 },
        { id: 'FIA', descricao: 'Fundo da Criança e do Adolescente', limitePercentualIRPJ: 0.01 },
        { id: 'FUNDO_IDOSO', descricao: 'Fundo do Idoso', limitePercentualIRPJ: 0.01 },
        { id: 'ROUANET', descricao: 'Lei Rouanet — Atividades Culturais', limitePercentualIRPJ: 0.04 },
        { id: 'VALE_CULTURA', descricao: 'Vale-Cultura', limitePercentualIRPJ: 0.01 },
        { id: 'AUDIOVISUAL', descricao: 'Atividades Audiovisuais (FUNCINES)', limitePercentualIRPJ: 0.03 },
        { id: 'ESPORTE', descricao: 'Lei do Esporte', limitePercentualIRPJ: 0.01 },
        { id: 'LICENCA_MATERNIDADE', descricao: 'Prorrogação Licença-Maternidade', limitePercentualIRPJ: null },
        { id: 'PRONON', descricao: 'PRONON — Apoio à Oncologia', limitePercentualIRPJ: 0.01 },
        { id: 'PRONAS_PCD', descricao: 'PRONAS/PCD — Pessoa com Deficiência', limitePercentualIRPJ: 0.01 }
      ];

      var resultado = [];
      var totalDeducao = 0;

      for (var i = 0; i < INCENTIVOS.length; i++) {
        var inc = INCENTIVOS[i];
        var despesaIncentivo = despesas[inc.id] || 0;
        if (despesaIncentivo <= 0) continue;

        var deducaoCalculada = 0;
        if (inc.id === 'PAT') {
          deducaoCalculada = despesaIncentivo * 0.15;
        } else if (inc.id === 'LICENCA_MATERNIDADE') {
          deducaoCalculada = despesaIncentivo;
        } else {
          deducaoCalculada = despesaIncentivo;
        }

        var limiteIndividual = inc.limitePercentualIRPJ
          ? irpjNormal * inc.limitePercentualIRPJ
          : deducaoCalculada;

        var deducaoFinal = Math.min(deducaoCalculada, limiteIndividual);

        resultado.push({
          incentivo: inc.id,
          descricao: inc.descricao,
          despesa: despesaIncentivo,
          deducaoCalculada: _r(deducaoCalculada),
          limiteIndividual: _r(limiteIndividual),
          deducaoFinal: _r(deducaoFinal)
        });

        totalDeducao += deducaoFinal;
      }

      // Art. 625, RIR/2018: limite global de 4% do IRPJ normal para incentivos sujeitos
      var IDS_SUJEITOS_TETO = ['PAT','FIA','FUNDO_IDOSO','ROUANET','AUDIOVISUAL','ESPORTE'];
      var limiteGlobal4 = irpjNormal * 0.04;
      var totalSujeito = 0;
      for (var j = 0; j < resultado.length; j++) {
        if (IDS_SUJEITOS_TETO.indexOf(resultado[j].incentivo) >= 0) totalSujeito += resultado[j].deducaoFinal;
      }
      if (totalSujeito > limiteGlobal4 && limiteGlobal4 > 0) {
        var fatorCorte = limiteGlobal4 / totalSujeito;
        totalDeducao = 0;
        for (var k = 0; k < resultado.length; k++) {
          if (IDS_SUJEITOS_TETO.indexOf(resultado[k].incentivo) >= 0) {
            resultado[k].deducaoFinal = _r(resultado[k].deducaoFinal * fatorCorte);
          }
          totalDeducao += resultado[k].deducaoFinal;
        }
      }

      var totalFinal = Math.min(totalDeducao, irpjNormal);

      return {
        incentivos: resultado,
        totalDeducaoCalculada: _r(totalDeducao),
        totalDeducaoFinal: _r(totalFinal),
        limiteGlobal4Pct: _r(limiteGlobal4),
        tetoGlobalAplicado: totalSujeito > limiteGlobal4,
        irpjNormal: irpjNormal,
        percentualUtilizado: irpjNormal > 0
          ? _r(totalFinal / irpjNormal * 100) + '%'
          : '0%',
        artigos: 'Art. 226, 228, 625-646'
      };
    },

    /**
     * ═══════════════════════════════════════════════════════════════════════
     * Suspensão/Redução de Estimativa — Portado do motor v4.6
     * ═══════════════════════════════════════════════════════════════════════
     *
     * Base Legal: Art. 227-230
     */
    suspensaoReducao: function (dados) {
      // DELEGAÇÃO AO MOTOR (v3.0) — MotorLR.calcularSuspensaoReducao()
      // Interface idêntica: mesmos parâmetros e mesma estrutura de retorno
      if (typeof MotorLR !== 'undefined' && MotorLR.calcularSuspensaoReducao) {
        return MotorLR.calcularSuspensaoReducao(dados);
      }

      // FALLBACK: implementação original caso o motor não esteja carregado
      var d = Object.assign({
        estimativaDevidaMes: 0, irpjRealAcumulado: 0,
        irpjPagoAcumulado: 0, csllRealAcumulada: 0,
        csllPagaAcumulada: 0, estimativaCSLLMes: 0
      }, dados);

      var irpjMes, situacaoIRPJ;
      if (d.irpjRealAcumulado <= d.irpjPagoAcumulado) {
        irpjMes = 0; situacaoIRPJ = 'SUSPENSAO';
      } else if (d.irpjRealAcumulado < d.irpjPagoAcumulado + d.estimativaDevidaMes) {
        irpjMes = d.irpjRealAcumulado - d.irpjPagoAcumulado; situacaoIRPJ = 'REDUCAO';
      } else {
        irpjMes = d.estimativaDevidaMes; situacaoIRPJ = 'INTEGRAL';
      }

      var csllMes, situacaoCSLL;
      if (d.csllRealAcumulada <= d.csllPagaAcumulada) {
        csllMes = 0; situacaoCSLL = 'SUSPENSAO';
      } else if (d.csllRealAcumulada < d.csllPagaAcumulada + d.estimativaCSLLMes) {
        csllMes = d.csllRealAcumulada - d.csllPagaAcumulada; situacaoCSLL = 'REDUCAO';
      } else {
        csllMes = d.estimativaCSLLMes; situacaoCSLL = 'INTEGRAL';
      }

      return {
        irpj: {
          estimativaDevida: d.estimativaDevidaMes,
          irpjRealAcumulado: d.irpjRealAcumulado,
          irpjPagoAcumulado: d.irpjPagoAcumulado,
          valorAPagar: _r(Math.max(irpjMes, 0)),
          situacao: situacaoIRPJ
        },
        csll: {
          estimativaDevida: d.estimativaCSLLMes,
          csllRealAcumulada: d.csllRealAcumulada,
          csllPagaAcumulada: d.csllPagaAcumulada,
          valorAPagar: _r(Math.max(csllMes, 0)),
          situacao: situacaoCSLL
        },
        economiaMes: _r(d.estimativaDevidaMes - Math.max(irpjMes, 0) + d.estimativaCSLLMes - Math.max(csllMes, 0)),
        requisitos: [
          'Balanço/balancete mensal levantado e transcrito no Diário (Art. 227, §1º, I)',
          'Observar leis comerciais e fiscais (Art. 227, §1º, I)',
          'Efeitos apenas para o período em curso (Art. 227, §1º, II)'
        ],
        artigos: 'Art. 227 a 230'
      };
    },

    /**
     * ═══════════════════════════════════════════════════════════════════════
     * Acréscimos Moratórios — Portado do motor v4.6
     * ═══════════════════════════════════════════════════════════════════════
     *
     * Base Legal: Lei 9.430/96, Art. 61
     */
    acrescimosMoratorios: function (dados) {
      // DELEGAÇÃO AO MOTOR (v3.0) — MotorLR.calcularAcrescimosMoratorios()
      if (typeof MotorLR !== 'undefined' && MotorLR.calcularAcrescimosMoratorios) {
        var resultado = MotorLR.calcularAcrescimosMoratorios(dados);

        // Mapear retorno motor → interface esperada pelo mapeamento
        // Motor retorna detalhamento.multa e detalhamento.juros como sub-objetos
        // Mapeamento espera detalhamento flat com diasAtraso, percentualMulta etc.
        return {
          baseLegal: resultado.baseLegal,
          valorOriginal: _r(resultado.valorOriginal),
          multaMora: _r(resultado.multaMora),
          jurosMora: _r(resultado.jurosMora),
          totalAcrescimos: _r(resultado.totalAcrescimos),
          totalAPagar: _r(resultado.totalAPagar),
          detalhamento: resultado.detalhamento && resultado.detalhamento.multa ? {
            diasAtraso: resultado.detalhamento.multa.diasAtraso || (dados && dados.diasAtraso) || 0,
            percentualMulta: resultado.detalhamento.multa.percentualAplicavel
              ? _r(resultado.detalhamento.multa.percentualAplicavel * 100) + '%'
              : '0%',
            atingiuTetoMulta: resultado.detalhamento.multa.atingiuTeto || false,
            selicAcumulada: resultado.detalhamento.juros ? resultado.detalhamento.juros.selicAcumulada || 0 : 0,
            jurosMesPagamento: resultado.detalhamento.juros ? resultado.detalhamento.juros.jurosMesPagamento || 0.01 : 0.01,
            taxaTotalJuros: resultado.detalhamento.juros ? resultado.detalhamento.juros.taxaTotalJuros || 0 : 0
          } : resultado.detalhamento
        };
      }

      // FALLBACK: implementação original caso o motor não esteja carregado
      var d = Object.assign({
        valorTributo: 0, diasAtraso: 0, taxasSelicMes: []
      }, dados);

      // CORREÇÃO v3.1: Aceitar campos alternativos vindos de estudos.js
      if (!d.valorTributo && d.valorPrincipal) d.valorTributo = d.valorPrincipal;
      // Calcular diasAtraso a partir de datas se fornecidas
      if (!d.diasAtraso && d.dataVencimento && d.dataPagamento) {
        try {
          var dv = new Date(d.dataVencimento);
          var dp = new Date(d.dataPagamento);
          if (!isNaN(dv.getTime()) && !isNaN(dp.getTime())) {
            d.diasAtraso = Math.max(0, Math.round((dp - dv) / 86400000));
          }
        } catch(_e) {}
      }

      // Multa de mora: 0,33% por dia, teto 20%
      var percentualBruto = d.diasAtraso * 0.0033;
      var percentualAplicavel = Math.min(percentualBruto, 0.20);
      var multaMora = _r(d.valorTributo * percentualAplicavel);

      // Juros SELIC
      var selicAcumulada = d.taxasSelicMes.reduce(function (acc, t) { return acc + t; }, 0);
      var jurosMesPagamento = 0.01;
      var taxaTotalJuros = selicAcumulada + jurosMesPagamento;
      var jurosMora = _r(d.valorTributo * taxaTotalJuros);

      var totalAcrescimos = _r(multaMora + jurosMora);

      return {
        baseLegal: 'Lei 9.430/1996, art. 61',
        valorOriginal: _r(d.valorTributo),
        multaMora: multaMora,
        jurosMora: jurosMora,
        totalAcrescimos: totalAcrescimos,
        totalAPagar: _r(d.valorTributo + totalAcrescimos),
        detalhamento: {
          diasAtraso: d.diasAtraso,
          percentualMulta: _r(percentualAplicavel * 100) + '%',
          atingiuTetoMulta: d.diasAtraso >= 61,
          selicAcumulada: selicAcumulada,
          jurosMesPagamento: jurosMesPagamento,
          taxaTotalJuros: taxaTotalJuros
        }
      };
    },

    /**
     * ═══════════════════════════════════════════════════════════════════════
     * Multa de Ofício — Portado do motor v4.6
     * ═══════════════════════════════════════════════════════════════════════
     *
     * Base Legal: Lei 9.430/96, Art. 44 (redação Lei 14.689/2023)
     */
    multaOficio: function (dados) {
      // DELEGAÇÃO AO MOTOR (v3.0) — MotorLR.calcularMultaOficio()
      if (typeof MotorLR !== 'undefined' && MotorLR.calcularMultaOficio) {
        var resultado = MotorLR.calcularMultaOficio(dados);

        // Mapear retorno motor → interface esperada pelo mapeamento
        // Motor retorna percentuais como sub-objeto { base, agravamento, final }
        return {
          baseLegal: resultado.baseLegal,
          valorDiferenca: _r(resultado.valorDiferenca),
          tipoInfracao: resultado.tipoInfracao,
          percentualBase: resultado.percentuais ? resultado.percentuais.base : 0,
          percentualFinal: resultado.percentuais ? resultado.percentuais.final : 0,
          multaBruta: _r(resultado.multaBruta),
          reducao: resultado.reducao ? {
            percentual: resultado.reducao.percentual,
            valor: _r(resultado.reducao.valor)
          } : { percentual: 0, valor: 0 },
          multaLiquida: _r(resultado.multaLiquida),
          totalDevido: _r(resultado.totalDevido)
        };
      }

      // FALLBACK: implementação original caso o motor não esteja carregado
      var d = Object.assign({
        valorDiferenca: 0, tipoInfracao: 'normal',
        estimativaIsolada: false, naoAtendeuIntimacao: false,
        pagamento30Dias: false, pagamentoAntesRecurso: false
      }, dados);

      // CORREÇÃO v3.1: Aceitar campos alternativos vindos de estudos.js
      if (!d.valorDiferenca && d.valorTributo) d.valorDiferenca = d.valorTributo;
      if (d.tipo && !dados.tipoInfracao) {
        d.tipoInfracao = d.tipo === 'PADRAO' ? 'normal' : (d.tipo || 'normal').toLowerCase();
      }
      if (d.pagouEm30Dias === true && !dados.pagamento30Dias) d.pagamento30Dias = true;

      if (d.valorDiferenca <= 0) {
        return { baseLegal: 'Lei 9.430/1996, art. 44', valorDiferenca: 0, multaOficio: 0 };
      }

      var percentualBase;
      if (d.estimativaIsolada) {
        percentualBase = 0.50;
      } else if (d.tipoInfracao === 'qualificada') {
        percentualBase = 1.00;
      } else if (d.tipoInfracao === 'reincidente') {
        percentualBase = 1.50;
      } else {
        percentualBase = 0.75;
      }

      var percentualFinal = percentualBase;
      if (d.naoAtendeuIntimacao) {
        percentualFinal = percentualBase * 1.50;
      }

      var reducao = 0;
      if (d.pagamento30Dias) { reducao = 0.50; }
      else if (d.pagamentoAntesRecurso) { reducao = 0.30; }

      var multaBruta = _r(d.valorDiferenca * percentualFinal);
      var valorReducao = _r(multaBruta * reducao);
      var multaLiquida = _r(multaBruta - valorReducao);

      return {
        baseLegal: 'Lei 9.430/1996, art. 44 (redação Lei 14.689/2023)',
        valorDiferenca: _r(d.valorDiferenca),
        tipoInfracao: d.tipoInfracao,
        percentualBase: percentualBase,
        percentualFinal: percentualFinal,
        multaBruta: multaBruta,
        reducao: { percentual: reducao, valor: valorReducao },
        multaLiquida: multaLiquida,
        totalDevido: _r(d.valorDiferenca + multaLiquida)
      };
    },

    /**
     * ═══════════════════════════════════════════════════════════════════════
     * Recomendar Regime (Trimestral vs Anual) — Portado do motor v4.6
     * ═══════════════════════════════════════════════════════════════════════
     *
     * Base Legal: Art. 217-219, Art. 227-229
     */
    recomendarRegime: function (dados) {
      // DELEGAÇÃO AO MOTOR (v3.0) — MotorLR.recomendarRegime()
      // Interface idêntica: { lucrosMensais, prejuizoAcumulado, temInvestimento }
      if (typeof MotorLR !== 'undefined' && MotorLR.recomendarRegime) {
        var resultado = MotorLR.recomendarRegime(dados);

        // Motor retorna mesma estrutura base + campos extras (anual.lucroRealFinal etc.)
        // Garantir compatibilidade com interface do mapeamento
        return {
          recomendacao: resultado.recomendacao,
          motivos: resultado.motivos,
          simulacao: {
            trimestral: {
              irpjTotal: _r(resultado.simulacao.trimestral.irpjTotal),
              detalhamentoTrimestres: resultado.simulacao.trimestral.detalhamentoTrimestres,
              saldoPrejuizoRemanescente: _r(resultado.simulacao.trimestral.saldoPrejuizoRemanescente)
            },
            anual: {
              irpjTotal: _r(resultado.simulacao.anual.irpjTotal),
              saldoPrejuizoRemanescente: _r(resultado.simulacao.anual.saldoPrejuizoRemanescente)
            },
            economia: _r(resultado.simulacao.economia),
            regimeMaisBarato: resultado.simulacao.regimeMaisBarato
          },
          alerta: resultado.alerta,
          artigos: resultado.artigos
        };
      }

      // FALLBACK: implementação original caso o motor não esteja carregado
      var d = Object.assign({
        lucrosMensais: [], prejuizoAcumulado: 0, temInvestimento: false
      }, dados);

      // CORREÇÃO v3.1: Aceitar campos alternativos vindos de estudos.js
      // estudos.js passa: { lucroAjustado, prejuizoFiscal, mesesReceita, ... }
      if ((!d.lucrosMensais || d.lucrosMensais.length === 0) && d.mesesReceita && d.mesesReceita.length > 0) {
        d.lucrosMensais = d.mesesReceita;
      }
      if (d.prejuizoFiscal !== undefined && !d.prejuizoAcumulado) {
        d.prejuizoAcumulado = d.prejuizoFiscal || 0;
      }
      // Se lucrosMensais ainda vazio, distribuir lucroAjustado uniformemente
      if ((!d.lucrosMensais || d.lucrosMensais.length === 0) && d.lucroAjustado) {
        d.lucrosMensais = [];
        for (var _mi = 0; _mi < 12; _mi++) d.lucrosMensais.push(d.lucroAjustado / 12);
      }
      // Garantir 12 meses
      if (!d.lucrosMensais || d.lucrosMensais.length === 0) {
        d.lucrosMensais = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
      }

      var lucroTotal = d.lucrosMensais.reduce(function (a, b) { return a + b; }, 0);
      var temPrejuizoEmAlgunsMeses = d.lucrosMensais.some(function (l) { return l < 0; });
      var lucroConcentradoNoFinal = d.lucrosMensais.slice(9, 12).reduce(function (a, b) { return a + b; }, 0) > lucroTotal * 0.5;

      // Simulação Trimestral
      var trimestres = [
        d.lucrosMensais.slice(0, 3).reduce(function (a, b) { return a + b; }, 0),
        d.lucrosMensais.slice(3, 6).reduce(function (a, b) { return a + b; }, 0),
        d.lucrosMensais.slice(6, 9).reduce(function (a, b) { return a + b; }, 0),
        d.lucrosMensais.slice(9, 12).reduce(function (a, b) { return a + b; }, 0)
      ];

      var irpjTrimestral = 0;
      var saldoPrejTri = d.prejuizoAcumulado;
      for (var i = 0; i < trimestres.length; i++) {
        var lucroTri = trimestres[i];
        if (lucroTri <= 0) {
          saldoPrejTri += Math.abs(lucroTri);
          continue;
        }
        var lim30 = lucroTri * 0.30;
        var comp = Math.min(lim30, saldoPrejTri);
        saldoPrejTri -= comp;
        var lrFinal = lucroTri - comp;
        if (lrFinal > 0) {
          irpjTrimestral += lrFinal * 0.15;
          irpjTrimestral += Math.max(lrFinal - 60000, 0) * 0.10;
        }
      }

      // Simulação Anual
      var irpjAnual = 0;
      var saldoPrejAnual = d.prejuizoAcumulado;
      if (lucroTotal > 0) {
        var lim30a = lucroTotal * 0.30;
        var compA = Math.min(lim30a, saldoPrejAnual);
        saldoPrejAnual -= compA;
        var lrAnual = lucroTotal - compA;
        if (lrAnual > 0) {
          irpjAnual = lrAnual * 0.15;
          irpjAnual += Math.max(lrAnual - 240000, 0) * 0.10;
        }
      }

      var recomendacao, motivos = [];
      if (lucroConcentradoNoFinal || temPrejuizoEmAlgunsMeses) {
        recomendacao = 'ANUAL';
        motivos.push('Lucro concentrado no final ou meses com prejuízo → suspensão/redução economiza');
      } else {
        recomendacao = irpjAnual <= irpjTrimestral ? 'ANUAL' : 'TRIMESTRAL';
        motivos.push('Simulação: IRPJ Trimestral = R$ ' + _r(irpjTrimestral).toFixed(2) + ' vs Anual = R$ ' + _r(irpjAnual).toFixed(2));
      }

      if (temPrejuizoEmAlgunsMeses) {
        motivos.push('ANUAL permite suspensão de estimativas com balanço mensal (Art. 227)');
      }
      if (d.prejuizoAcumulado > 0) {
        motivos.push('Prejuízo acumulado: no trimestral, trava de 30% aplica por trimestre (4 vezes); no anual, aplica uma vez');
      }

      return {
        recomendacao: recomendacao,
        motivos: motivos,
        simulacao: {
          trimestral: { irpjTotal: _r(irpjTrimestral), detalhamentoTrimestres: trimestres, saldoPrejuizoRemanescente: _r(saldoPrejTri) },
          anual: { irpjTotal: _r(irpjAnual), saldoPrejuizoRemanescente: _r(saldoPrejAnual) },
          economia: _r(Math.abs(irpjTrimestral - irpjAnual)),
          regimeMaisBarato: irpjAnual <= irpjTrimestral ? 'ANUAL' : 'TRIMESTRAL'
        },
        alerta: 'Art. 229: A opção é IRRETRATÁVEL para todo o ano-calendário',
        artigos: 'Art. 217-219, Art. 227-229'
      };
    },

    /**
     * Simulação completa — tudo junto
     * v3.3: Integra PIS/COFINS, cenários proporcionais, TJLP obrigatória, carga bruta/líquida
     */
    simulacaoCompleta: function (empresa) {
      // DELEGAÇÃO AO MOTOR (v3.3) — MotorLR.simularLucroRealCompleto()
      if (typeof MotorLR !== 'undefined' && MotorLR.simularLucroRealCompleto) {
        var e = Object.assign({
          lucroLiquido: 0, receitaBruta: 0, adicoes: 0, exclusoes: 0,
          prejuizoFiscal: 0, baseNegativaCSLL: 0,
          patrimonioLiquido: 0, tjlp: null, lucrosAcumulados: 0,  // v3.3 FIX #3: TJLP sem default
          retencoesFonte: 0, estimativasPagas: 0, numMeses: 12,
          dadosPISCOFINS: null,                                    // v3.3 FIX #6: PIS/COFINS integrado
          retencoesPISCOFINS: 0,                                   // v3.3 FIX #6: Retenções PIS/COFINS
          variacaoCenarios: { pessimista: -0.05, otimista: 0.05 }  // v3.3 FIX #7: Variação cenários
        }, empresa);

        // Mapear parâmetros mapeamento → motor
        var resultado = MotorLR.simularLucroRealCompleto({
          lucroLiquidoContabil: e.lucroLiquido,
          receitaBruta: e.receitaBruta,
          totalAdicoes: e.adicoes,
          totalExclusoes: e.exclusoes,
          saldoPrejuizoFiscal: e.prejuizoFiscal,
          saldoBaseNegativaCSLL: e.baseNegativaCSLL,
          patrimonioLiquido: e.patrimonioLiquido,
          tjlp: e.tjlp,                              // v3.3 FIX #3: Sem default — motor valida
          lucrosAcumulados: e.lucrosAcumulados,
          despesasIncentivos: e.despesasIncentivos || {},
          retencoesFonte: e.retencoesFonte,
          estimativasPagas: e.estimativasPagas,
          numMeses: e.numMeses,
          ehInstituicaoFinanceira: e.financeira || false,
          dadosPISCOFINS: e.dadosPISCOFINS,           // v3.3 FIX #6: PIS/COFINS integrado
          retencoesPISCOFINS: e.retencoesPISCOFINS,   // v3.3 FIX #6: Retenções
          variacaoCenarios: e.variacaoCenarios         // v3.3 FIX #7: Cenários proporcionais
        });

        // Mapear retorno motor → interface esperada pelo mapeamento
        return {
          semOtimizacao: {
            irpjDevido: _r(resultado.semOtimizacao.irpjDevido),
            aliquotaEfetiva: resultado.semOtimizacao.aliquotaEfetiva
          },
          comOtimizacao: {
            irpj: resultado.comOtimizacao.irpj,
            csll: resultado.comOtimizacao.csll,
            jcp: resultado.comOtimizacao.jcp,
            pisCofins: resultado.comOtimizacao.pisCofins || null  // v3.3 FIX #6
          },
          economia: {
            jcp: _r(resultado.economia.jcp),
            irpj: _r(resultado.economia.totalIRPJ || resultado.economia.compensacaoPrejuizo || 0),
            // v3.3 FIX E2#1: Incluir economia CSLL também na delegação ao motor
            csll: _r(resultado.economia.csll || resultado.economia.totalCSLL || 0),
            total: _r((resultado.economia.totalIRPJ || 0) + (resultado.economia.jcp || 0) + (resultado.economia.csll || resultado.economia.totalCSLL || 0) + (resultado.economia.pisCofins || resultado.economia.creditosPisCofins || 0))
          },
          // v3.3 FIX #6: Carga total com bruta e líquida separadas
          totalAPagar: {
            irpj: _r(resultado.totalAPagar.irpj),
            csll: _r(resultado.totalAPagar.csll),
            subtotalIRPJ_CSLL: _r(resultado.totalAPagar.subtotalIRPJ_CSLL),
            pisCofins: resultado.totalAPagar.pisCofins || null,
            // v3.3 FIX #6: Labels claros — total legado é a carga líquida
            total: _r(resultado.totalAPagar.cargaTotalLiquida || (resultado.totalAPagar.irpj + resultado.totalAPagar.csll)),
            cargaTotalBruta: _r(resultado.totalAPagar.cargaTotalBruta || 0),
            cargaTotalBrutaDescricao: resultado.totalAPagar.cargaTotalBrutaDescricao || 'IRPJ + CSLL + PIS/COFINS débitos',
            cargaTotalLiquida: _r(resultado.totalAPagar.cargaTotalLiquida || 0),
            cargaTotalLiquidaDescricao: resultado.totalAPagar.cargaTotalLiquidaDescricao || 'IRPJ + CSLL + PIS/COFINS a pagar',
            nota: resultado.totalAPagar.nota || 'A carga LÍQUIDA é o desembolso efetivo. A BRUTA inclui PIS/COFINS antes dos créditos.'
          },
          // v3.3 FIX #7: Cenários com PIS/COFINS proporcional
          cenarios: resultado.cenarios || null,
          cenarioNota: resultado.cenarioNota || 'PIS/COFINS recalculado proporcionalmente à receita em cada cenário.',
          saldoNegativo: resultado.saldoNegativo || null
        };
      }

      // FALLBACK: implementação original caso o motor não esteja carregado
      // v3.3 FIX E2#5: Indicar modo fallback
      LR._modoFallback = true;
      if (LR._fallbackUsado.indexOf('simulacaoCompleta') === -1) LR._fallbackUsado.push('simulacaoCompleta');
      var e = Object.assign({
        lucroLiquido: 0, receitaBruta: 0, adicoes: 0, exclusoes: 0,
        prejuizoFiscal: 0, baseNegativaCSLL: 0,
        patrimonioLiquido: 0, tjlp: null, lucrosAcumulados: 0,  // v3.3 FIX #3: Sem default
        retencoesFonte: 0, estimativasPagas: 0, numMeses: 12,
        dadosPISCOFINS: null, retencoesPISCOFINS: 0
      }, empresa);

      var jcp = LR.calcular.jcp(e);
      var jcpValido = !jcp.erro;
      var jcpDedutivel = jcpValido ? jcp.jcpDedutivel : 0;
      var lucroAjustado = e.lucroLiquido - jcpDedutivel;

      var irpjSem = LR.calcular.irpj({ lucroLiquido: e.lucroLiquido, adicoes: e.adicoes, exclusoes: e.exclusoes, numMeses: e.numMeses });
      var irpjCom = LR.calcular.irpj({
        lucroLiquido: lucroAjustado, adicoes: e.adicoes, exclusoes: e.exclusoes,
        prejuizoFiscal: e.prejuizoFiscal, numMeses: e.numMeses,
        retencoesFonte: e.retencoesFonte, estimativasPagas: e.estimativasPagas
      });
      var csll = LR.calcular.csll({ lucroLiquido: lucroAjustado, adicoes: e.adicoes, exclusoes: e.exclusoes, baseNegativa: e.baseNegativaCSLL });

      // v3.3 FIX E2#1: Calcular economia CSLL (comparando cenário sem vs com base negativa)
      var csllSem = LR.calcular.csll({ lucroLiquido: lucroAjustado, adicoes: e.adicoes, exclusoes: e.exclusoes, baseNegativa: 0 });
      var economiaCSLL = _r(csllSem.csllDevida - csll.csllDevida);

      var economiaJCP = jcpValido ? jcp.economiaLiquida : 0;
      var economiaIRPJ = irpjSem.irpjDevido - irpjCom.irpjDevido;

      // v3.3 FIX #6: PIS/COFINS integrado no fallback
      var pisCofins = null;
      var pisCofinsLiquido = 0;
      var pisCofinsBruto = 0;
      if (e.dadosPISCOFINS) {
        pisCofins = LR.calcular.pisCofins(e.dadosPISCOFINS);
        pisCofinsBruto = (pisCofins.debitoPIS || 0) + (pisCofins.debitoCOFINS || 0);
        pisCofinsLiquido = pisCofins.totalAPagar || 0;
      }

      var cargaIRPJ_CSLL = _r(irpjCom.irpjAPagar + csll.csllDevida);
      var cargaTotalBruta = _r(cargaIRPJ_CSLL + pisCofinsBruto);
      var cargaTotalLiquida = _r(cargaIRPJ_CSLL + Math.max(pisCofinsLiquido - e.retencoesPISCOFINS, 0));

      // v3.3 FIX #7: Cenários com PIS/COFINS proporcional no fallback
      var cenariosFB = {};
      var variacoes = { base: 0, pessimista: -0.05, otimista: 0.05 };
      for (var nomeCenFB in variacoes) {
        if (!variacoes.hasOwnProperty(nomeCenFB)) continue;
        var varFB = variacoes[nomeCenFB];
        var fatorFB = 1 + varFB;
        var receitaCenFB = e.receitaBruta * fatorFB;
        var lucroCenFB = e.lucroLiquido * fatorFB;

        var pcCenFB = pisCofinsLiquido;
        var pcCenBrutoFB = pisCofinsBruto;
        if (e.dadosPISCOFINS && varFB !== 0) {
          var pcCalc = LR.calcular.pisCofins(Object.assign({}, e.dadosPISCOFINS, { receitaBruta: receitaCenFB }));
          pcCenFB = pcCalc.totalAPagar || 0;
          pcCenBrutoFB = (pcCalc.debitoPIS || 0) + (pcCalc.debitoCOFINS || 0);
        }

        var irpjCenFB, csllCenFB;
        if (varFB === 0) {
          irpjCenFB = irpjCom.irpjAPagar;
          csllCenFB = csll.csllDevida;
        } else {
          var irpjCalcFB = LR.calcular.irpj({
            lucroLiquido: lucroCenFB - jcpDedutivel, adicoes: e.adicoes * fatorFB, exclusoes: e.exclusoes * fatorFB,
            prejuizoFiscal: e.prejuizoFiscal, numMeses: e.numMeses,
            retencoesFonte: e.retencoesFonte, estimativasPagas: e.estimativasPagas
          });
          var csllCalcFB = LR.calcular.csll({
            lucroLiquido: lucroCenFB - jcpDedutivel, adicoes: e.adicoes * fatorFB, exclusoes: e.exclusoes * fatorFB,
            baseNegativa: e.baseNegativaCSLL
          });
          irpjCenFB = irpjCalcFB.irpjAPagar;
          csllCenFB = csllCalcFB.csllDevida;
        }

        var totalCenBrutoFB = _r(irpjCenFB + csllCenFB + pcCenBrutoFB);
        var totalCenLiquidoFB = _r(irpjCenFB + csllCenFB + Math.max(pcCenFB - e.retencoesPISCOFINS, 0));

        cenariosFB[nomeCenFB] = {
          variacao: _r(varFB * 100) + '%',
          receita: _r(receitaCenFB),
          irpj: _r(irpjCenFB),
          csll: _r(csllCenFB),
          pisCofins: _r(pcCenFB),
          pisCofinsNota: varFB !== 0 ? 'PIS/COFINS recalculado proporcionalmente' : 'Cenário base',
          cargaTotalBruta: totalCenBrutoFB,
          cargaTotalLiquida: totalCenLiquidoFB,
          cargaEfetiva: receitaCenFB > 0 ? _r(totalCenLiquidoFB / receitaCenFB * 100) + '%' : '0%'
        };
      }

      // v3.3 FIX BUG CRÍTICO 2: Economia PIS/COFINS (créditos não-cumulativos) incluída no total
      var economiaPisCofins = pisCofins ? _r((pisCofins.totalCreditos || 0) + (pisCofins.creditoPIS || 0) + (pisCofins.creditoCOFINS || 0) > 0
        ? (pisCofins.totalCreditos || ((pisCofins.creditoPIS || 0) + (pisCofins.creditoCOFINS || 0)))
        : (pisCofinsBruto - pisCofinsLiquido)) : 0;

      return {
        semOtimizacao: { irpjDevido: irpjSem.irpjDevido, aliquotaEfetiva: irpjSem.aliquotaEfetiva },
        comOtimizacao: { irpj: irpjCom, csll: csll, jcp: jcp, pisCofins: pisCofins },
        economia: { jcp: economiaJCP, irpj: _r(economiaIRPJ), csll: economiaCSLL, pisCofins: _r(economiaPisCofins), total: _r(economiaIRPJ + economiaJCP + economiaCSLL + economiaPisCofins) },
        totalAPagar: {
          irpj: irpjCom.irpjAPagar,
          csll: csll.csllDevida,
          subtotalIRPJ_CSLL: cargaIRPJ_CSLL,
          pisCofins: pisCofins ? {
            bruto: _r(pisCofinsBruto),
            liquido: _r(pisCofinsLiquido),
            retencoesFonte: e.retencoesPISCOFINS,
            aPagar: _r(Math.max(pisCofinsLiquido - e.retencoesPISCOFINS, 0))
          } : null,
          total: cargaTotalLiquida,
          cargaTotalBruta: cargaTotalBruta,
          cargaTotalBrutaDescricao: 'IRPJ + CSLL + PIS/COFINS débitos (antes de créditos e retenções)',
          cargaTotalLiquida: cargaTotalLiquida,
          cargaTotalLiquidaDescricao: 'IRPJ + CSLL + PIS/COFINS a pagar (após créditos e retenções)',
          nota: 'A carga LÍQUIDA é o desembolso efetivo. A BRUTA inclui PIS/COFINS antes dos créditos.'
        },
        cenarios: cenariosFB,
        cenarioNota: 'PIS/COFINS recalculado proporcionalmente à receita em cada cenário.',
        saldoNegativo: null
      };
    }
  };

  // ═══════════════════════════════════════════════════════════════════════════
  // 31. HELPERS — FORMATAÇÃO E UTILITÁRIOS
  // ═══════════════════════════════════════════════════════════════════════════

  LR.helpers = {
    // v3.3 FIX E2#5: Verificar se sistema está em modo fallback
    isFallback: function () {
      return LR._modoFallback === true;
    },
    getFallbackInfo: function () {
      if (!LR._modoFallback) return null;
      return {
        modoFallback: true,
        funcoesAfetadas: LR._fallbackUsado,
        aviso: 'Cálculos executados em modo simplificado — resultados podem divergir do motor fiscal completo.',
        motivo: 'Motor fiscal (motor-lucro-real-v4.6-unificado.js) não carregado ou indisponível.'
      };
    },
    formatarMoeda: function (v) {
      return 'R$ ' + (v || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    },
    formatarPercentual: function (v) {
      return (v * 100).toFixed(2) + '%';
    },
    round: _r,
    getTrimestreAtual: function () {
      var m = new Date().getMonth();
      return LR.trimestres[Math.floor(m / 3)];
    },
    getMesAtual: function () {
      return LR.meses[new Date().getMonth()];
    },
    buscarPresuncao: function (chave) {
      return LR.presuncoes[chave] || null;
    },
    listarPresuncoes: function () {
      return Object.keys(LR.presuncoes).map(function (k) {
        return { chave: k, label: LR.presuncoes[k].label, irpj: LR.presuncoes[k].irpj, csll: LR.presuncoes[k].csll };
      });
    },
    buscarDepreciacao: function (nomeBem) {
      return LR.depreciacao.tabela.find(function (t) {
        return t.bem.toLowerCase().indexOf(nomeBem.toLowerCase()) >= 0;
      }) || null;
    },
    buscarIncentivo: function (id) {
      return LR.incentivos.find(function (i) { return i.id === id; }) || null;
    },
    buscarAdicao: function (id) {
      return LR.adicoes.find(function (a) { return a.id === id; }) || null;
    },
    buscarExclusao: function (id) {
      return LR.exclusoes.find(function (e) { return e.id === id; }) || null;
    },
    buscarDARF: function (id) {
      return LR.darf[id] || null;
    },
    ehSUDAM: function (uf) {
      return LR.ehSUDAM(uf);  // v3.2: delega a função que lê de estados.js
    },
    ehSUDENE: function (uf) {
      return LR.ehSUDENE(uf);  // v3.2: delega a função que lê de estados.js
    },
    verificarObrigatoriedade: function (dados) {
      var motivos = [];
      if (dados.receitaAnual > LR.limites.receitaObrigatoriedade) motivos.push('Receita > R$ 78 milhões');
      if (dados.financeira) motivos.push('Instituição financeira');
      if (dados.lucroExterior) motivos.push('Lucros do exterior');
      if (dados.beneficioFiscal) motivos.push('Benefício fiscal isenção/redução');
      if (dados.estimativaMensal) motivos.push('Paga por estimativa mensal');
      if (dados.factoring) motivos.push('Factoring');
      if (dados.securitizadora) motivos.push('Securitizadora');
      return { obrigada: motivos.length > 0, motivos: motivos };
    }
  };

  // ═══════════════════════════════════════════════════════════════════════════
  // EXPORT — Exposição global
  // ═══════════════════════════════════════════════════════════════════════════

  // Browser
  if (typeof window !== 'undefined') {
    window.LucroRealMap = LR;
    window.LR = LR; // atalho
  }

  // Node.js / CommonJS
  if (typeof module !== 'undefined' && module.exports) {
    module.exports = LR;
  }

  // AMD
  if (typeof define === 'function' && define.amd) {
    define(function () { return LR; });
  }

})(this);
  </script>
  <!-- 5. Chart.js 4.4 CDN com fallback -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"
    onerror="this.onerror=null;this.src='https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.7/chart.umd.min.js';console.warn('[IMPOST] Chart.js CDN primário falhou, tentando fallback');"></script>
  <!-- 6. html2pdf.js para exportação PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"
    onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js';console.warn('[IMPOST] html2pdf CDN primário falhou, tentando fallback');window._depFalha=(window._depFalha||[]);window._depFalha.push('html2pdf.js');"></script>
  <!-- 7. SheetJS para exportação Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"
    onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';console.warn('[IMPOST] SheetJS CDN primário falhou, tentando fallback');window._depFalha=(window._depFalha||[]);window._depFalha.push('xlsx.js');"></script>
  <!-- 8. Motor principal do wizard (INLINE) -->
  <script>
/**
 * ╔══════════════════════════════════════════════════════════════════════════════╗
 * ║  LUCRO REAL — ESTUDOS TRIBUTÁRIOS  v3.5  (ARQUIVO UNIFICADO)              ║
 * ║  Wizard 7 etapas + Motor de diagnóstico + Exportação PDF/Excel            ║
 * ║  100% LUCRO REAL — Sem comparativo com Simples/Presumido                   ║
 * ║  Motor: cruza respostas do usuário com LucroRealMap (LR.calcular.*)        ║
 * ║  Produto comercial por assinatura — ZERO referência a empresa específica   ║
 * ╚══════════════════════════════════════════════════════════════════════════════╝
 *
 * DEPENDÊNCIAS (carregar ANTES deste arquivo):
 *   1. estados.js              → window.ESTADOS (dados de estados, ICMS, ISS)
 *   2. municipios.js           → window.MunicipiosIBGE (municípios via API IBGE)
 *   3. lucro-real-mapeamento.js → window.LR / window.LucroRealMap
 *   4. Chart.js (CDN)          → gráficos no relatório
 *   5. html2pdf.js (CDN)       → exportação PDF profissional
 *   6. SheetJS / XLSX (CDN)    → exportação Excel (.xlsx)
 *
 * EXPORTA:
 *   window.LucroRealEstudos  — API principal (inclui .pdfSimplificado, .pdfCompleto, .exportarExcel)
 *   window.IMPOSTExport      — alias de compatibilidade para exportação
 *
 * IMPOST. — Inteligência em Modelagem de Otimização Tributária
 * Versão: 3.5.0 | Data: Fevereiro/2026
 *
 * NOTA: Este arquivo unifica os antigos lucro-real-estudos.js + lucro-real-estudos-export.js
 *       Não é mais necessário carregar o arquivo de exportação separadamente.
 *
 * CHANGELOG v3.5.0 (Fevereiro/2026):
 *   FIX CRÍTICO — Dados do elaborador (nome, CRC, email, telefone) agora são
 *                 mapeados de dadosEmpresa para CONFIG antes de gerar resultado.
 *                 PDF/Excel agora exibem corretamente a identificação do profissional.
 *   FIX CRÍTICO — logoURL do formulário agora é transferido para CONFIG.
 *   FIX CRÍTICO — irpjComJCP agora recebe pós-processamento SUDAM (consistência).
 *   FIX CRÍTICO — LALUR agora exibe compensação de prejuízo com rastreabilidade fiscal.
 *   FIX MÉDIO — totalDeducoesIncentivos protegido contra null (previne NaN).
 *   FIX MÉDIO — Campos numéricos (numSocios, etc.) convertidos para Number no saveField.
 *   FIX MÉDIO — Catch blocks agora logam erros via console.warn (depuração facilitada).
 *   FIX MENOR — Gráfico de alíquota efetiva: fatia "Receita Livre" agora visível (#E0E0E0).
 *   FIX MENOR — Recomendação trimestral vs anual agora inclui impacto de fluxo de caixa.
 *   FIX MENOR — Projeção plurianual com métodos de compatibilidade (forEach, map, toArray).
 *   FIX MENOR — Validação por etapa no wizard (campos obrigatórios destacados).
 *   FIX SEGURANÇA — Máscara CNPJ reescrita (script morto via innerHTML removido).
 *   FIX SEGURANÇA — Sanitização XSS com _esc() em campos de texto livre no relatório.
 *
 * CHANGELOG v3.4.0 (Fevereiro/2026):
 *   FIX — IRRF JCP default fallback corrigido de 15% para 17,5% (LC 224/2025)
 *   FIX — Subcapitalização: juros indedutíveis usam IRPJ marginal (_irpj incremental)
 *         em vez de taxa fixa 25% — correto para lucros abaixo do limiar adicional
 *   FIX — Alerta de retenções usa _irpj() incremental em vez de 0.25 fixo
 *
 * CHANGELOG v3.2.0 (Fevereiro/2026):
 *   BUG #1 (CRÍTICO) — Cálculo JCP agora mantém compensação de prejuízo ativa, recalculando
 *              trava de 30% sobre novo lucro ajustado após dedução do JCP. Economia JCP corrigida.
 *   BUG #2 (MÉDIO) — VERSAO unificada em 3.2.0. Badge no header sincronizado via JS no init().
 *   BUG #3 (MÉDIO) — Totais do Fluxo de Caixa Mensal usam valores anuais exatos em vez da
 *              soma de parcelas arredondadas. Elimina divergência de R$ 0,01.
 *   BUG #4 (MÉDIO) — Seção 5 agora inclui nota explicativa distinguindo alíquota efetiva por
 *              tributo (sobre base específica) vs alíquota efetiva global (sobre receita bruta).
 *   BUG #5 (BAIXO) — PDD Fiscal na oportunidade #22 usa alíquotas efetivas (consistente com
 *              pddFiscalInfo). Alíquotas passadas via ctx para cálculo uniforme.
 *   BUG #6 (BAIXO) — Todas as oportunidades agora têm campo .economia como alias de
 *              .economiaAnual, evitando undefined em funções de exportação.
 *
 * CHANGELOG v2.3.0 (Fevereiro/2026):
 *   FALHA #1 — Cards SIMULACAO_COMPLETA e MAPA_ECONOMIA marcados como consolidação (_isConsolidada)
 *              para não duplicar economia ao somar oportunidades. Visual distinto no relatório e Excel.
 *   FALHA #2 — pisCofins.aliquotaEfetiva agora é LÍQUIDA (após retenções/créditos).
 *              Adicionada pisCofins.aliquotaEfetivaBruta. Seção 5 mostra alíquota líquida com nota.
 *   FALHA #3 — Dashboard já exibe labels "(Bruto)" e "(Líquido)" com tooltips explicativos.
 *   FALHA #4 — Oportunidade Prejuízo Fiscal: inclui economia IRPJ+CSLL quando não há card separado
 *              de Base Negativa CSLL (evita duplicação quando ambos existem).
 *   FALHA #5 — Guarda para multaOficio: não calcula quando não há débito relevante.
 *   MELHORIA — TJLP default atualizado de 6% para 7,97% (taxa 2025).
 *   MELHORIA — Novo campo PL Ajustado JCP (Lei 14.789/2023) na Etapa 3.
 *   MELHORIA — Disclaimer jurídico em destaque no INÍCIO do relatório.
 *   MELHORIA — Alerta inteligente sobre Lei 14.789/2023 quando PL Ajustado não informado.
 */
(function () {
  "use strict";

  // ═══════════════════════════════════════════════════════════════════════════
  //  CONSTANTES E HELPERS
  // ═══════════════════════════════════════════════════════════════════════════
  const VERSAO = "3.5.0";
  const LS_KEY_DADOS = "impost_lr_dados";
  const LS_KEY_STEP = "impost_lr_step";
  const LS_KEY_RESULTADOS = "impost_lr_resultados";

  const $ = (id) => document.getElementById(id);
  const $$ = (sel) => document.querySelectorAll(sel);
  const _r = (v) => Math.round((v || 0) * 100) / 100;
  const _m = (v) =>
    "R$\u00a0" +
    (v || 0).toLocaleString("pt-BR", {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2,
    });
  const _p = (v) => ((v || 0) * 100).toFixed(2) + "%";
  const _n = (v) => parseFloat(v) || 0;
  /** Formata valor que JÁ É percentual (ex: 25 → "25.00%"). Diferente de _p que multiplica por 100. */
  function _pp(v) { return (v || 0).toFixed(2) + "%"; }
  function _irpj(lr) { return lr <= 0 ? 0 : lr * 0.15 + Math.max(0, lr - 240000) * 0.10; }
  /** Sanitiza string para uso seguro em innerHTML — previne XSS */
  function _esc(s) {
    if (typeof s !== 'string') return s;
    return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
  }

  /**
   * MELHORIA #2: Acesso seguro a propriedades aninhadas.
   * Uso: _safe(sudamResult, 'resumo', 'economiaReducao75')
   * Em vez de: sudamResult ? (sudamResult.resumo.economiaReducao75 || 0) : 0
   */
  function _safe(obj /*, chave1, chave2, ... */) {
    for (var i = 1; i < arguments.length; i++) {
      if (obj == null) return 0;
      obj = obj[arguments[i]];
    }
    return (typeof obj === 'number') ? obj : (typeof obj === 'string' ? parseFloat(obj) || 0 : 0);
  }

  /**
   * Formata número como moeda brasileira para exibição em inputs.
   * Ex: 3000000 → "3.000.000,00"   |   1234.5 → "1.234,50"
   * Recebe valor numérico (ou string de dígitos), retorna string formatada.
   */
  function _fmtBRL(v) {
    if (v === "" || v === undefined || v === null) return "";
    var n = typeof v === "number" ? v : parseFloat(String(v).replace(/\./g, "").replace(",", ".")) || 0;
    if (n === 0 && String(v) !== "0") return "";
    var parts = n.toFixed(2).split(".");
    var inteiro = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    return inteiro + "," + parts[1];
  }

  // ═══════════════════════════════════════════════════════════════════════════
  //  SIGLAS — Dicionário e helpers (Correção 8)
  // ═══════════════════════════════════════════════════════════════════════════

  var _SIGLAS = {
    LALUR:  "Livro de Apuração do Lucro Real",
    LACS:   "Livro de Apuração da Contribuição Social",
    DRE:    "Demonstração do Resultado do Exercício",
    PL:     "Patrimônio Líquido",
    JCP:    "Juros sobre Capital Próprio",
    TJLP:   "Taxa de Juros de Longo Prazo",
    IRPJ:   "Imposto de Renda Pessoa Jurídica",
    CSLL:   "Contribuição Social sobre o Lucro Líquido",
    PIS:    "Programa de Integração Social",
    COFINS: "Contribuição p/ Financiamento da Seguridade Social",
    DARF:   "Documento de Arrecadação de Receitas Federais",
    ISS:    "Imposto sobre Serviços",
    ICMS:   "Imposto sobre Circulação de Mercadorias e Serviços",
    CPP:    "Contribuição Previdenciária Patronal",
    CPRB:   "Contribuição Previdenciária sobre Receita Bruta",
    PDD:    "Provisão para Devedores Duvidosos",
    ECF:    "Escrituração Contábil Fiscal",
    SPED:   "Sistema Público de Escrituração Digital",
    RIR:    "Regulamento do Imposto de Renda",
    SUDAM:  "Superintendência de Desenvolvimento da Amazônia",
    SUDENE: "Superintendência de Desenvolvimento do Nordeste",
    CSRF:   "Contribuições Sociais Retidas na Fonte",
    MEP:    "Método de Equivalência Patrimonial",
    AVP:    "Ajuste a Valor Presente",
    PER:    "Pedido Eletrônico de Restituição",
    DCOMP:  "Declaração de Compensação",
    CND:    "Certidão Negativa de Débitos",
    CPEN:   "Certidão Positiva com Efeitos de Negativa",
    BASA:   "Banco da Amazônia S.A.",
    BNB:    "Banco do Nordeste do Brasil",
    SCP:    "Sociedade em Conta de Participação",
  };

  /**
   * Retorna HTML inline com tooltip para uma sigla.
   * Ex: _sigla("LALUR") → '<span class="sigla-help">LALUR <small class="sigla-desc">(Livro de Apuração do Lucro Real)</small></span>'
   */
  function _sigla(code) {
    var desc = _SIGLAS[code];
    if (!desc) return code;
    return '<span class="sigla-help">' + code +
      ' <small class="sigla-desc">(' + desc + ')</small></span>';
  }

  /**
   * Processa HTML de uma etapa e substitui a PRIMEIRA ocorrência de cada sigla
   * por sua versão com tooltip. Apenas texto visível (entre tags) é processado.
   */
  function _applySiglas(html) {
    var used = {};
    var allSiglas = Object.keys(_SIGLAS).sort(function (a, b) {
      return b.length - a.length; // mais longas primeiro para evitar conflitos
    });
    var pattern = new RegExp("\\b(" + allSiglas.join("|") + ")\\b", "g");

    return html.replace(/(>[^<]+)/g, function (match) {
      var gt = match[0];
      var text = match.slice(1);
      text = text.replace(pattern, function (sigla) {
        if (used[sigla]) return sigla;
        used[sigla] = true;
        return _sigla(sigla);
      });
      return gt + text;
    });
  }

  var _siglaCSSInjected = false;

  function _injectSiglaCSS() {
    if (_siglaCSSInjected) return;
    _siglaCSSInjected = true;
    var style = document.createElement("style");
    style.textContent =
      ".sigla-help{position:relative;border-bottom:1px dotted rgba(46,204,113,0.5);cursor:help;}" +
      ".sigla-desc{font-weight:400;color:#8b95a5;font-size:0.82em;white-space:nowrap;}";
    document.head.appendChild(style);
  }

  // ═══════════════════════════════════════════════════════════════════════════
  //  CONFIGURAÇÃO WHITE-LABEL (defaults)
  // ═══════════════════════════════════════════════════════════════════════════
  const CONFIG_DEFAULTS = {
    nomeProduto: "IMPOST.",
    subtitulo: "Inteligência em Modelagem de Otimização Tributária",
    versao: VERSAO,
    corPrimaria: "#1A3C6E",
    corSecundaria: "#E8A838",
    corAcento: "#2ECC71",
    logoURL: "",
    elaboradoPor: { nome: "", registro: "", email: "", telefone: "" },
    disclaimer:
      "Este estudo é uma estimativa automatizada para fins de planejamento tributário. Consulte um profissional habilitado para validação e implementação.",
    mostrarMarcaImpost: true,
  };

  let CONFIG = Object.assign({}, CONFIG_DEFAULTS);

  // ═══════════════════════════════════════════════════════════════════════════
  //  7 ETAPAS DO WIZARD
  // ═══════════════════════════════════════════════════════════════════════════
  const ETAPAS = [
    {
      id: "empresa",
      titulo: "Dados da Empresa e Regime",
      icone: "🏢",
      descricao:
        "Identificação, atividade, localização com ISS automático e forma de apuração",
    },
    {
      id: "receitas",
      titulo: "Receitas e Faturamento",
      icone: "💰",
      descricao: "Receita bruta detalhada por natureza — base para todos os cálculos",
    },
    {
      id: "custos",
      titulo: "Custos, Despesas e Adições/Exclusões",
      icone: "📋",
      descricao: "DRE e LALUR — a etapa mais importante do wizard",
    },
    {
      id: "patrimonio",
      titulo: "Patrimônio, JCP e Prejuízos",
      icone: "🏦",
      descricao:
        "JCP e compensação de prejuízos — as duas maiores fontes de economia",
    },
    {
      id: "retencoes",
      titulo: "Retenções na Fonte e Créditos PIS/COFINS",
      icone: "🔒",
      descricao:
        "Antecipações compensáveis e créditos não-cumulativos sobre insumos",
    },
    {
      id: "ativos",
      titulo: "Ativos, Depreciação e Incentivos",
      icone: "🏗️",
      descricao:
        "Bens depreciáveis, turnos, SUDAM/SUDENE e todos os incentivos fiscais",
    },
    {
      id: "revisao",
      titulo: "Revisão, Cenários e Configuração",
      icone: "📈",
      descricao:
        "Revisar dados, configurar cenários e personalizar relatório antes de gerar",
    },
  ];

  // ═══════════════════════════════════════════════════════════════════════════
  //  ESTADO GLOBAL
  // ═══════════════════════════════════════════════════════════════════════════
  let currentStep = 0;
  let dadosEmpresa = {};
  let resultadosCache = null;
  let LR = null;
  let ESTADOS = null;

  // ═══════════════════════════════════════════════════════════════════════════
  //  HELPERS DE CAMPO — _field (todos os tipos)
  // ═══════════════════════════════════════════════════════════════════════════

  /**
   * Gera select de UFs a partir de ESTADOS (estados.js)
   */
  function _selectUF(selected) {
    if (!ESTADOS) return '<option value="">Carregando estados...</option>';
    var html = '<option value="">Selecione um estado...</option>';
    // Tentar listar estados de diferentes formatos
    if (ESTADOS.listarEstados) {
      // Formato estados.js UMD (window.Estados)
      var lista = ESTADOS.listarEstados();
      lista.forEach(function (e) {
        html +=
          '<option value="' +
          e.sigla +
          '" ' +
          (e.sigla === selected ? "selected" : "") +
          ">" +
          e.sigla +
          " — " +
          e.nome +
          "</option>";
      });
    } else {
      // Formato simples: ESTADOS["PA"] = { nome: "Pará", ... }
      var siglas = Object.keys(ESTADOS).sort();
      siglas.forEach(function (uf) {
        var nome = ESTADOS[uf].nome || uf;
        html +=
          '<option value="' +
          uf +
          '" ' +
          (uf === selected ? "selected" : "") +
          ">" +
          uf +
          " — " +
          nome +
          "</option>";
      });
    }
    return html;
  }

  /**
   * Gera select de tipos de atividade agrupados por optgroup
   */
  function _selectAtividades(selected) {
    if (!LR || !LR.presuncoes) return '<option value="">Carregando...</option>';
    var grupos = {
      Serviços: [
        "SERVICOS_GERAL",
        "SERVICOS_HOSPITALARES",
        "INTERMEDIACAO_NEGOCIOS",
        "ADMINISTRACAO_LOCACAO",
      ],
      "Comércio/Indústria": [
        "COMERCIO_INDUSTRIA",
        "REVENDA_COMBUSTIVEIS",
        "ATIVIDADE_IMOBILIARIA",
      ],
      Transporte: ["TRANSPORTE_CARGA", "TRANSPORTE_PASSAGEIROS"],
      "⚠️ Obrigatório LR": ["FACTORING", "INSTITUICOES_FINANCEIRAS"],
    };
    var html = '<option value="">Selecione a atividade...</option>';
    Object.keys(grupos).forEach(function (grupo) {
      html += '<optgroup label="' + grupo + '">';
      grupos[grupo].forEach(function (k) {
        if (LR.presuncoes[k]) {
          html +=
            '<option value="' +
            k +
            '" ' +
            (k === selected ? "selected" : "") +
            ">" +
            LR.presuncoes[k].label +
            "</option>";
        }
      });
      html += "</optgroup>";
    });
    // Adicionar quaisquer presunções não classificadas
    var usados = [].concat.apply([], Object.values(grupos));
    Object.keys(LR.presuncoes).forEach(function (k) {
      if (usados.indexOf(k) === -1) {
        html +=
          '<option value="' +
          k +
          '" ' +
          (k === selected ? "selected" : "") +
          ">" +
          LR.presuncoes[k].label +
          "</option>";
      }
    });
    return html;
  }

  /**
   * Gerador universal de campo
   * Suporta: text, number, money, percent, select, checkbox, radio, textarea
   */
  function _field(id, label, type, opts) {
    opts = opts || {};
    var val =
      dadosEmpresa[id] !== undefined ? dadosEmpresa[id] : opts.default || "";
    var ph = opts.placeholder || "";
    var tip = opts.tip
      ? '<span class="wz-tip">' + opts.tip + "</span>"
      : "";
    var req = opts.required ? "required" : "";
    var cls = opts.className || "";
    var cond = opts.condition
      ? 'data-condition="' + opts.condition + '" style="display:none"'
      : "";
    var extra = opts.extra || "";
    var disabled = opts.disabled ? "disabled" : "";

    if (type === "select") {
      return (
        '<div class="wz-field ' + cls + '" ' + cond + ">" +
        '<label for="' + id + '">' + label + "</label>" + tip +
        '<select id="' + id + '" name="' + id + '" class="wz-input" ' +
        req + " " + disabled +
        " onchange=\"LucroRealEstudos.saveField('" + id + "',this.value)\">" +
        (opts.options || "") +
        "</select>" + extra + "</div>"
      );
    }

    if (type === "checkbox") {
      var chk =
        val === true || val === "true" || val === "on" ? "checked" : "";
      return (
        '<div class="wz-field wz-field-check ' + cls + '" ' + cond + ">" +
        '<label class="wz-check-label">' +
        '<input type="checkbox" id="' + id + '" name="' + id + '" ' + chk +
        " onchange=\"LucroRealEstudos.saveField('" + id + "',this.checked)\">" +
        '<span class="wz-checkmark"></span>' + label +
        "</label>" + tip + "</div>"
      );
    }

    if (type === "radio") {
      var radios = (opts.options || [])
        .map(function (o) {
          return (
            '<label class="wz-radio-label">' +
            '<input type="radio" name="' + id + '" value="' + o.value + '" ' +
            (String(val) === String(o.value) ? "checked" : "") +
            " onchange=\"LucroRealEstudos.saveField('" +
            id + "','" + o.value + "')\">" +
            '<span class="wz-radio-mark"></span>' + o.label +
            "</label>"
          );
        })
        .join("");
      return (
        '<div class="wz-field ' + cls + '" ' + cond + ">" +
        "<label>" + label + "</label>" + tip +
        '<div class="wz-radio-group">' + radios + "</div></div>"
      );
    }

    if (type === "money") {
      var fmtVal = val ? _fmtBRL(val) : "";
      return (
        '<div class="wz-field ' + cls + '" ' + cond + ">" +
        '<label for="' + id + '">' + label + "</label>" + tip +
        '<div class="wz-input-prefix"><span>R$</span>' +
        '<input type="text" id="' + id + '" name="' + id +
        '" class="wz-input" placeholder="' + ph + '" value="' + fmtVal +
        "\" oninput=\"LucroRealEstudos.saveMoney('" + id + "',this)\" " +
        req + " " + disabled + ">" +
        "</div>" + extra + "</div>"
      );
    }

    if (type === "percent") {
      return (
        '<div class="wz-field ' + cls + '" ' + cond + ">" +
        '<label for="' + id + '">' + label + "</label>" + tip +
        '<div class="wz-input-suffix">' +
        '<input type="number" id="' + id + '" name="' + id +
        '" class="wz-input" placeholder="' + ph + '" value="' + val +
        '" step="0.01" min="0" max="100"' +
        " oninput=\"LucroRealEstudos.saveField('" + id + "',this.value)\" " +
        req + ">" +
        "<span>%</span></div></div>"
      );
    }

    if (type === "textarea") {
      return (
        '<div class="wz-field ' + cls + '" ' + cond + ">" +
        '<label for="' + id + '">' + label + "</label>" + tip +
        '<textarea id="' + id + '" name="' + id +
        '" class="wz-input" placeholder="' + ph + '" rows="3"' +
        " oninput=\"LucroRealEstudos.saveField('" + id + "',this.value)\" " +
        req + ">" + (val || "") + "</textarea></div>"
      );
    }

    // default: text / number
    return (
      '<div class="wz-field ' + cls + '" ' + cond + ">" +
      '<label for="' + id + '">' + label + "</label>" + tip +
      '<input type="' + type + '" id="' + id + '" name="' + id +
      '" class="wz-input" placeholder="' + ph + '" value="' + val +
      "\" oninput=\"LucroRealEstudos.saveField('" + id + "',this.value)\" " +
      req + ">" + extra + "</div>"
    );
  }

  function _sectionTitle(text) {
    return '<h3 class="wz-section-title">' + text + "</h3>";
  }

  function _infoBox(text, cls) {
    return '<div class="wz-info-box ' + (cls || "") + '">' + text + "</div>";
  }

  function _row(content) {
    return '<div class="wz-row">' + content + "</div>";
  }

  function _autoCalcBox(id) {
    return '<div class="wz-auto-calc" id="' + id + '"></div>';
  }

  // ═══════════════════════════════════════════════════════════════════════════
  //  AUTOCOMPLETE CNAE — Correção 1
  // ═══════════════════════════════════════════════════════════════════════════

  var _cnaeDropdownCSS = false;

  function _injectCnaeCSS() {
    if (_cnaeDropdownCSS) return;
    _cnaeDropdownCSS = true;
    var style = document.createElement("style");
    style.textContent =
      ".cnae-ac-wrap{position:relative;}" +
      ".cnae-dropdown{position:absolute;top:100%;left:0;right:0;z-index:1000;max-height:300px;overflow-y:auto;" +
      "background:#1a2236;border:1px solid rgba(255,255,255,0.12);border-radius:8px;box-shadow:0 8px 32px rgba(0,0,0,0.5);" +
      "margin-top:2px;display:none;}" +
      ".cnae-dropdown.open{display:block;}" +
      ".cnae-dropdown-item{padding:10px 14px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.05);" +
      "font-size:13px;color:#ccc;transition:background .15s;}" +
      ".cnae-dropdown-item:last-child{border-bottom:none;}" +
      ".cnae-dropdown-item:hover,.cnae-dropdown-item.active{background:rgba(46,204,113,0.15);color:#fff;}" +
      ".cnae-dropdown-item .cnae-code{font-family:'JetBrains Mono',monospace;color:#2ECC71;margin-right:8px;font-weight:600;}" +
      ".cnae-dropdown-item .cnae-cat{font-size:11px;color:#888;margin-left:6px;}" +
      ".cnae-dropdown-empty{padding:12px 14px;color:#777;font-style:italic;font-size:13px;}";
    document.head.appendChild(style);
  }

  function buscarCnae(texto) {
    var banco = window.CNAE || window.BANCO_CNAE;
    if (!banco || !texto || texto.length < 2) return [];
    var norm = texto.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    var isCode = /^\d{2,}/.test(norm.replace(/[\s\-\/]/g, ""));
    var codeQ = norm.replace(/[\s\-\/]/g, "");

    return banco.filter(function (c) {
      if (isCode) return c.codigo.replace(/[\-\/]/g, "").indexOf(codeQ) === 0;
      var descNorm = c.descricao.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      return norm.split(/\s+/).every(function (t) { return descNorm.indexOf(t) >= 0; });
    }).slice(0, 15);
  }

  var _cnaeDebounceTimers = {};
  var _cnaeActiveIdx = {};

  function _initCnaeAutocomplete() {
    _injectCnaeCSS();
    _setupCnaeField("cnaePrincipal", false);
    _setupCnaeField("cnaesSecundarios", true);
  }

  function _setupCnaeField(fieldId, multi) {
    var input = $(fieldId);
    if (!input) return;

    // Evitar duplicar dropdowns
    if (input.parentNode.querySelector(".cnae-dropdown")) return;

    // Envolver input em wrapper relativo
    var wrapper = input.parentNode;
    if (!wrapper.classList.contains("cnae-ac-wrap")) {
      wrapper.style.position = "relative";
      wrapper.classList.add("cnae-ac-wrap");
    }

    // Criar dropdown
    var dd = document.createElement("div");
    dd.className = "cnae-dropdown";
    dd.id = "cnaeDD_" + fieldId;
    wrapper.appendChild(dd);

    _cnaeActiveIdx[fieldId] = -1;

    // Input handler com debounce
    input.addEventListener("input", function () {
      clearTimeout(_cnaeDebounceTimers[fieldId]);
      _cnaeDebounceTimers[fieldId] = setTimeout(function () {
        var texto = input.value;
        if (multi) {
          var parts = texto.split(",");
          texto = parts[parts.length - 1].trim();
        }
        _renderCnaeDropdown(dd, fieldId, texto, input, multi);
      }, 250);
    });

    // Paste handler
    input.addEventListener("paste", function () {
      setTimeout(function () {
        var texto = input.value;
        if (multi) {
          var parts = texto.split(",");
          texto = parts[parts.length - 1].trim();
        }
        _renderCnaeDropdown(dd, fieldId, texto, input, multi);
      }, 50);
    });

    // Keyboard navigation
    input.addEventListener("keydown", function (e) {
      if (!dd.classList.contains("open")) return;
      var items = dd.querySelectorAll(".cnae-dropdown-item");
      if (!items.length) return;

      if (e.key === "ArrowDown") {
        e.preventDefault();
        _cnaeActiveIdx[fieldId] = Math.min(_cnaeActiveIdx[fieldId] + 1, items.length - 1);
        _highlightCnaeItem(items, _cnaeActiveIdx[fieldId]);
      } else if (e.key === "ArrowUp") {
        e.preventDefault();
        _cnaeActiveIdx[fieldId] = Math.max(_cnaeActiveIdx[fieldId] - 1, 0);
        _highlightCnaeItem(items, _cnaeActiveIdx[fieldId]);
      } else if (e.key === "Enter") {
        e.preventDefault();
        if (_cnaeActiveIdx[fieldId] >= 0 && items[_cnaeActiveIdx[fieldId]]) {
          items[_cnaeActiveIdx[fieldId]].click();
        }
      } else if (e.key === "Escape") {
        dd.classList.remove("open");
        _cnaeActiveIdx[fieldId] = -1;
      }
    });

    // Fechar ao clicar fora
    document.addEventListener("click", function (e) {
      if (!wrapper.contains(e.target)) {
        dd.classList.remove("open");
        _cnaeActiveIdx[fieldId] = -1;
      }
    });
  }

  function _renderCnaeDropdown(dd, fieldId, texto, input, multi) {
    _cnaeActiveIdx[fieldId] = -1;
    if (!texto || texto.length < 2) {
      dd.classList.remove("open");
      dd.innerHTML = "";
      return;
    }
    var resultados = buscarCnae(texto);
    if (resultados.length === 0) {
      dd.innerHTML = '<div class="cnae-dropdown-empty">Nenhum CNAE encontrado para "' + texto + '"</div>';
      dd.classList.add("open");
      return;
    }
    var html = "";
    resultados.forEach(function (c, idx) {
      html += '<div class="cnae-dropdown-item" data-idx="' + idx + '" data-codigo="' + c.codigo + '" data-descricao="' + c.descricao.replace(/"/g, "&quot;") + '">' +
        '<span class="cnae-code">' + c.codigo + '</span>' + c.descricao +
        '<span class="cnae-cat">' + (c.categoria || "") + '</span></div>';
    });
    dd.innerHTML = html;
    dd.classList.add("open");

    // Click handler para cada item
    dd.querySelectorAll(".cnae-dropdown-item").forEach(function (item) {
      item.addEventListener("click", function () {
        var codigo = item.getAttribute("data-codigo");
        var descricao = item.getAttribute("data-descricao");
        var valor = codigo + " - " + descricao;

        if (multi) {
          var parts = input.value.split(",");
          parts[parts.length - 1] = " " + valor;
          input.value = parts.join(",").replace(/^,?\s*/, "");
        } else {
          input.value = valor;
        }

        dadosEmpresa[fieldId] = input.value;
        saveToLS();
        dd.classList.remove("open");
        dd.innerHTML = "";
        _cnaeActiveIdx[fieldId] = -1;

        // Auto-detectar CPRB se CNAE principal começa com 62
        if (fieldId === "cnaePrincipal" && codigo.replace(/[\-\/]/g, "").substring(0, 2) === "62") {
          _sugerirCPRB();
        }
      });
    });
  }

  function _highlightCnaeItem(items, idx) {
    items.forEach(function (it, i) {
      it.classList.toggle("active", i === idx);
    });
    if (items[idx]) items[idx].scrollIntoView({ block: "nearest" });
  }

  function _sugerirCPRB() {
    // Sugere CPRB na etapa 4 — será implementado na Correção 4
    // Marcar flag para mostrar badge informativo
    dadosEmpresa._cprbSugerida = true;
  }

  // ═══════════════════════════════════════════════════════════════════════════
  //  RENDER WIZARD (com progress bar)
  // ═══════════════════════════════════════════════════════════════════════════

  function renderWizard() {
    var container = $("wizardContainer");
    if (!container) return;

    // Esconder resultados se visíveis
    var resContainer = $("resultadosContainer");
    if (resContainer) resContainer.style.display = "none";
    container.style.display = "";

    // ── Progress bar clicável ──
    var progressHTML = '<div class="wz-progress">';
    ETAPAS.forEach(function (e, i) {
      var estado =
        i < currentStep ? "done" : i === currentStep ? "active" : "";
      progressHTML +=
        '<div class="wz-step-indicator ' + estado +
        '" data-step="' + i +
        '" onclick="LucroRealEstudos.goToStep(' + i + ')" title="' +
        e.titulo + '">' +
        '<div class="wz-step-num">' +
        (i < currentStep ? "✓" : i + 1) + "</div>" +
        '<div class="wz-step-label">' + e.titulo + "</div></div>";
      if (i < ETAPAS.length - 1) {
        progressHTML +=
          '<div class="wz-step-line ' +
          (i < currentStep ? "done" : "") + '"></div>';
      }
    });
    progressHTML += "</div>";

    // ── Conteúdo da etapa atual ──
    var etapa = ETAPAS[currentStep];
    var formHTML = renderEtapa(currentStep);

    // ── Navegação ──
    var navHTML = '<div class="wz-nav">';
    if (currentStep > 0) {
      navHTML +=
        '<button class="wz-btn wz-btn-back" onclick="LucroRealEstudos.prevStep()">← Voltar</button>';
    }
    navHTML +=
      '<button class="wz-btn wz-btn-fill" onclick="LucroRealEstudos.preencherExemplo()" title="Carregar dados de exemplo para demonstração">⚡ Carregar Exemplo</button>';
    if (currentStep < ETAPAS.length - 1) {
      navHTML +=
        '<button class="wz-btn wz-btn-next" onclick="LucroRealEstudos.nextStep()">Próximo →</button>';
    } else {
      navHTML +=
        '<button class="wz-btn wz-btn-analyze" onclick="LucroRealEstudos.analisar()">🔍 GERAR ESTUDO COMPLETO</button>';
    }
    navHTML += "</div>";

    container.innerHTML =
      progressHTML +
      '<div class="wz-content">' +
      '<div class="wz-header">' +
      '<span class="wz-header-icon">' + etapa.icone + "</span>" +
      "<div>" +
      '<h2 class="wz-title">Etapa ' + (currentStep + 1) + " de " +
      ETAPAS.length + " — " + etapa.titulo + "</h2>" +
      '<p class="wz-subtitle">' + etapa.descricao + "</p>" +
      "</div></div>" +
      '<div class="wz-form">' + formHTML + "</div>" +
      navHTML +
      "</div>";

    restoreValues();
    bindConditionals();
    updateAutoCalcs();

    // Integração de municípios: se estamos na etapa 0 e tem UF, carregar municípios
    if (currentStep === 0 && dadosEmpresa.uf) {
      _carregarMunicipios(dadosEmpresa.uf);
    }

    // Autocomplete CNAE na etapa 0
    if (currentStep === 0) {
      _initCnaeAutocomplete();
    }
  }

  // ═══════════════════════════════════════════════════════════════════════════
  //  RENDER DE CADA ETAPA (0 a 6)
  // ═══════════════════════════════════════════════════════════════════════════

  function renderEtapa(step) {
    var html;
    switch (step) {
      case 0: html = renderEtapa0(); break;
      case 1: html = renderEtapa1(); break;
      case 2: html = renderEtapa2(); break;
      case 3: html = renderEtapa3(); break;
      case 4: html = renderEtapa4(); break;
      case 5: html = renderEtapa5(); break;
      case 6: html = renderEtapa6(); break;
      default: html = "";
    }
    return _applySiglas(html);
  }

  // ──────────────────────────────────────────────────────────────────────────
  //  ETAPA 0 — Dados da Empresa e Regime
  // ──────────────────────────────────────────────────────────────────────────
  function renderEtapa0() {
    var h = "";
    h += _sectionTitle("Identificação da Empresa");
    h += _row(
      _field("razaoSocial", "Razão Social", "text", {
        required: true,
        placeholder: "Nome da empresa",
      }) +
      _field("cnpj", "CNPJ", "text", {
        placeholder: "XX.XXX.XXX/XXXX-XX"
      })
    );
    h += _row(
      _field("cnaePrincipal", "CNAE Principal", "text", {
        placeholder: 'Ex: 7119-7/99',
      }) +
      _field("cnaesSecundarios", "CNAEs Secundários", "text", {
        placeholder: "Separados por vírgula",
      })
    );

    h += _sectionTitle("Localização");
    h += _row(
      _field("uf", "UF", "select", {
        required: true,
        options: _selectUF(dadosEmpresa.uf),
        extra: '<div id="ufBadge"></div>',
      }) +
      '<div class="wz-field">' +
        '<label for="municipio">Município</label>' +
        '<span class="wz-tip">Selecione o estado primeiro — os municípios serão carregados automaticamente via API IBGE</span>' +
        '<select id="municipio" name="municipio" class="wz-input" required ' +
        'onchange="LucroRealEstudos.onMunicipioChanged(this)">' +
        '<option value="">Selecione o estado primeiro...</option>' +
        '</select>' +
        '<div id="municipioLoading" class="wz-municipio-loading" style="display:none">Carregando municípios...</div>' +
      '</div>'
    );
    h += _row(
      _field("tipoServicoISS", "Tipo de serviço (LC 116/2003)", "select", {
        tip: "Influencia a faixa de alíquota ISS. Selecione o item da lista de serviços mais adequado.",
        options:
          '<option value="">Selecione (padrão: 5%)</option>' +
          '<option value="informatica" ' + (dadosEmpresa.tipoServicoISS === "informatica" ? "selected" : "") + '>Item 1 — Informática (2% a 5%)</option>' +
          '<option value="saude" ' + (dadosEmpresa.tipoServicoISS === "saude" ? "selected" : "") + '>Item 4 — Saúde (2% a 3%)</option>' +
          '<option value="engenharia" ' + (dadosEmpresa.tipoServicoISS === "engenharia" ? "selected" : "") + '>Item 7 — Engenharia/Arquitetura (2% a 5%)</option>' +
          '<option value="educacao" ' + (dadosEmpresa.tipoServicoISS === "educacao" ? "selected" : "") + '>Item 8 — Educação (2% a 5%)</option>' +
          '<option value="contabilidade" ' + (dadosEmpresa.tipoServicoISS === "contabilidade" ? "selected" : "") + '>Item 17 — Contabilidade/Auditoria (2% a 5%)</option>' +
          '<option value="advocacia" ' + (dadosEmpresa.tipoServicoISS === "advocacia" ? "selected" : "") + '>Item 17 — Advocacia (2% a 5%)</option>' +
          '<option value="consultoria" ' + (dadosEmpresa.tipoServicoISS === "consultoria" ? "selected" : "") + '>Item 17 — Consultoria (2% a 5%)</option>' +
          '<option value="construcao" ' + (dadosEmpresa.tipoServicoISS === "construcao" ? "selected" : "") + '>Item 7 — Construção civil (2% a 5%)</option>' +
          '<option value="transporte" ' + (dadosEmpresa.tipoServicoISS === "transporte" ? "selected" : "") + '>Item 16 — Transporte municipal (2% a 5%)</option>' +
          '<option value="outros" ' + (dadosEmpresa.tipoServicoISS === "outros" ? "selected" : "") + '>Outros serviços (2% a 5%)</option>',
      }) +
      _field("issAliquota", "Alíquota ISS do município (%)", "percent", {
        default: "5",
        tip: "Pré-preenchido pelo município selecionado. Editável manualmente (2% a 5%).",
      })
    );
    h += '<div class="wz-field"><div id="dicaISS" class="wz-iss-dica"></div></div>';

    // SUP — Sociedade Uniprofissional
    h += _field("ehSUP", "Sociedade Uniprofissional (SUP)?", "checkbox", {
      tip: "Sociedades de profissionais liberais (médicos, advogados, contadores, engenheiros) podem recolher ISS fixo por profissional, sem alíquota percentual.",
    });
    h += '<div data-condition="ehSUP" style="display:none">';
    h += _row(
      _field("issFixoPorProfissional", "ISS fixo anual por profissional (R$)", "money", {
        tip: "Valor fixo anual por sócio/profissional habilitado. Varia por município (ex: SP ≈ R$ 800/ano por profissional).",
        default: "800",
      }) +
      _field("numProfissionaisSUP", "Nº de profissionais habilitados", "number", {
        default: "2",
        tip: "Número de sócios ou profissionais que exercem atividade na sociedade",
      })
    );
    h += _autoCalcBox("calcISSSUP");
    h += "</div>";

    h += _sectionTitle("Atividade e Regime");
    h += _row(
      _field("tipoAtividade", "Tipo de Atividade Principal", "select", {
        required: true,
        options: _selectAtividades(dadosEmpresa.tipoAtividade),
      }) +
      _field("atividadeMista", "Atividade mista?", "checkbox", {
        tip: "Se a empresa tem mais de um tipo de atividade com receitas relevantes",
      })
    );
    h += '<div data-condition="atividadeMista" style="display:none">';
    h += _row(
      _field("atividadeSecundaria", "Atividade Secundária", "select", {
        options: _selectAtividades(dadosEmpresa.atividadeSecundaria),
      }) +
      _field("percentReceitaSecundaria", "% da receita da atividade secundária", "percent", {
        placeholder: "30",
      })
    );
    h += "</div>";

    h += _row(
      _field("anoBase", "Ano-Base do Estudo", "select", {
        options:
          '<option value="2024" ' + (dadosEmpresa.anoBase === "2024" ? "selected" : "") + ">2024</option>" +
          '<option value="2025" ' + (dadosEmpresa.anoBase === "2025" ? "selected" : "") + ">2025</option>" +
          '<option value="2026" ' + ((!dadosEmpresa.anoBase || dadosEmpresa.anoBase === "2026") ? "selected" : "") + ">2026</option>",
      }) +
      _field("apuracaoLR", "Forma de Apuração", "select", {
        required: true,
        options:
          '<option value="">Selecione...</option>' +
          '<option value="trimestral" ' + (dadosEmpresa.apuracaoLR === "trimestral" ? "selected" : "") + ">Trimestral (definitiva — apura a cada 3 meses)</option>" +
          '<option value="anual_estimativa" ' + (dadosEmpresa.apuracaoLR === "anual_estimativa" ? "selected" : "") + ">Anual por Estimativa (antecipações mensais + ajuste no ano)</option>" +
          '<option value="anual_suspensao" ' + (dadosEmpresa.apuracaoLR === "anual_suspensao" ? "selected" : "") + ">Anual com Suspensão/Redução (balancetes mensais)</option>",
        tip: "Trimestral: apuração definitiva a cada trimestre. Anual Estimativa: paga antecipações mensais e ajusta no final. Suspensão/Redução: pode suspender pagamento com balancete mensal.",
      })
    );

    h += _sectionTitle("Informações Complementares");
    h += _row(
      _field("numSocios", "Nº de Sócios", "number", { default: "2" }) +
      _field("numFuncionarios", "Nº de Funcionários", "number", { default: "0" })
    );
    h += _row(
      _field("prestaServPublico", "Presta serviço p/ órgão público?", "checkbox") +
      _field("ehFinanceira", "É instituição financeira?", "checkbox")
    );

    // ── Diagnóstico Avançado (campos para funções do mapeamento) ──
    h += _sectionTitle("Informações Complementares para Diagnóstico Avançado");
    h += _infoBox(
      "Estas informações alimentam o diagnóstico avançado de obrigatoriedade, subcapitalização, operações no exterior e regime cambial.",
      "wz-info-default"
    );
    h += _field("ehInstituicaoFinanceira", "É instituição financeira (banco, seguradora, financeira)?", "checkbox", {
      tip: "Altera alíquota CSLL para 15% (vs 9% geral) e torna o Lucro Real obrigatório (Art. 257, II)",
    });
    h += _field("temLucroExterior", "Possui lucros, rendimentos ou ganhos de capital do exterior?", "checkbox", {
      tip: "Torna o Lucro Real obrigatório (Art. 257, III). Dados usados em LR.calcular.avancado.calcularLucrosExterior()",
    });
    h += _field("temBeneficioFiscalIsencao", "Possui benefício fiscal de isenção ou redução (ex: SUDAM/SUDENE)?", "checkbox", {
      tip: "Torna o Lucro Real obrigatório (Art. 257, IV)",
    });
    h += _row(
      _field("ehFactoring", "Atividade de factoring ou assessoria creditícia?", "checkbox", {
        tip: "Torna o Lucro Real obrigatório (Art. 257, VI)",
      }) +
      _field("ehSecuritizadora", "Securitizadora de créditos?", "checkbox", {
        tip: "Torna o Lucro Real obrigatório (Art. 257, VII)",
      })
    );
    h += _field("regimeCambial", "Regime de variação cambial", "select", {
      tip: "Regime padrão é Caixa. Opção por Competência deve ser exercida em janeiro (Art. 407)",
      options:
        '<option value="CAIXA" ' + ((!dadosEmpresa.regimeCambial || dadosEmpresa.regimeCambial === "CAIXA") ? "selected" : "") + '>Caixa (padrão)</option>' +
        '<option value="COMPETENCIA" ' + (dadosEmpresa.regimeCambial === "COMPETENCIA" ? "selected" : "") + '>Competência</option>',
    });

    h += '<div id="alertaObrigatoriedade"></div>';
    return h;
  }

  // ──────────────────────────────────────────────────────────────────────────
  //  ETAPA 1 — Receitas e Faturamento
  // ──────────────────────────────────────────────────────────────────────────
  function renderEtapa1() {
    var h = "";

    h += _sectionTitle("Receita Bruta (obrigatória)");
    h += _infoBox(
      "Informe a receita bruta total anual. Opcionalmente, detalhe por tipo de receita ou preencha mês a mês para análise de sazonalidade.",
      "wz-info-default"
    );

    // Modo simplificado (padrão)
    h += _field("receitaBrutaAnual", "Receita Bruta Total Anual", "money", {
      required: true,
      placeholder: "3.000.000",
    });

    // Toggle detalhamento
    h += _field("detalharReceita", 'Detalhar por tipo de receita', "checkbox");
    h += '<div data-condition="detalharReceita" style="display:none">';
    h += _row(
      _field("receitaServicos", "Receita de Serviços", "money") +
      _field("receitaComercio", "Receita de Comércio/Mercadorias", "money")
    );
    h += _row(
      _field("receitaFinanceiras", "Receita de Aplicações Financeiras", "money", {
        tip: "Tributadas mas NÃO entram no lucro da exploração (SUDAM/SUDENE)",
      }) +
      _field("receitaAlugueis", "Receita de Aluguéis", "money")
    );
    h += _field("outrasReceitas", "Outras Receitas Operacionais", "money");
    h += _autoCalcBox("calcSomaReceitas");
    h += "</div>";

    // Modo mês a mês
    h += _field("preencherMesAMes", "Preencher mês a mês (para análise de sazonalidade)", "checkbox");
    h += '<div data-condition="preencherMesAMes" style="display:none">';
    var meses = ["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
    for (var i = 0; i < 12; i += 2) {
      h += _row(
        _field("receitaMes" + (i + 1), meses[i], "money") +
        (i + 1 < 12 ? _field("receitaMes" + (i + 2), meses[i + 1], "money") : "")
      );
    }
    h += _autoCalcBox("calcSomaMeses");
    h += "</div>";

    h += _sectionTitle("Receitas Especiais");
    h += _row(
      _field("receitasIsentas", "Receitas isentas de PIS/COFINS", "money", {
        tip: "Exportação, alíquota zero, receitas suspensas",
      }) +
      _field("receitaExportacao", "Receitas de exportação", "money", {
        tip: "Isentas de PIS/COFINS — Lei 10.637/02 art. 5º",
      })
    );
    h += _row(
      _field("receitasMonofasicas", "Receitas monofásicas", "money", {
        tip: "Combustíveis, farmacêuticos, cosméticos — tributação concentrada",
      }) +
      _field("receitasFinanceirasEspeciais", "Receitas financeiras", "money", {
        tip: "Aplicações, rendimentos, juros — tributadas mas NÃO entram no lucro da exploração (SUDAM)",
      })
    );
    h += _row(
      _field("receitasExteriorAnual", "Receitas do exterior", "money", {
        tip: "Se > 0, empresa é OBRIGADA ao Lucro Real (Art. 257, III)",
        extra: '<div id="alertaExterior"></div>',
      }) +
      _field("temCreditoImpExterior", "Tem crédito de imposto pago no exterior?", "checkbox", {
        condition: "receitasExteriorAnual",
      })
    );
    h += _field("percentReceitaPublico", "% da receita de órgãos públicos", "percent", {
      default: "0",
      tip: "Para estimar retenções na fonte automaticamente",
    });

    h += _autoCalcBox("calcReceitas");
    return h;
  }

  // ──────────────────────────────────────────────────────────────────────────
  //  ETAPA 2 — Custos, Despesas e Adições/Exclusões
  // ──────────────────────────────────────────────────────────────────────────
  function renderEtapa2() {
    var h = "";

    // ── Custos Operacionais ──
    h += _sectionTitle("Custos Operacionais");
    h += _field("folhaPagamentoAnual", "Custo com Pessoal (total c/ encargos)", "money", {
      required: true,
      tip: "Valor consolidado. Ou detalhe abaixo.",
    });
    h += _field("detalharFolha", "Detalhar folha de pagamento", "checkbox");
    h += '<div data-condition="detalharFolha" style="display:none">';
    h += _row(
      _field("salariosBrutos", "Salários brutos", "money") +
      _field("proLabore", "Pró-labore dos sócios", "money", {
        tip: "DEDUTÍVEL no Lucro Real — destaque como despesa operacional",
        extra: '<span class="wz-badge wz-badge-green">Dedutível</span>',
      })
    );
    h += _row(
      _field("inssPatronal", "INSS patronal + terceiros (≈27%) + FGTS (8%)", "money") +
      _field("fgts", "FGTS (8%)", "money")
    );
    h += _row(
      _field("decimoTerceiro", "13º provisão", "money") +
      _field("feriasProvisao", "Férias + 1/3 provisão", "money")
    );
    h += "</div>";

    h += _row(
      _field("cmv", "CMV / Custos com Mercadorias", "money") +
      _field("servicosTerceiros", "Custos com Serviços de Terceiros", "money")
    );
    h += _row(
      _field("freteComprasVendas", "Frete sobre vendas/compras", "money") +
      _field("outrosCustosOp", "Outros Custos Operacionais", "money")
    );

    // ── Despesas Operacionais ──
    h += _sectionTitle("Despesas Operacionais");
    h += _row(
      _field("aluguelAnual", "Aluguel de imóveis", "money") +
      _field("energiaAnual", "Energia elétrica", "money")
    );
    h += _row(
      _field("telecomAnual", "Telecomunicações", "money") +
      _field("manutencaoConservacao", "Manutenção e conservação", "money")
    );
    h += _row(
      _field("segurosAnual", "Seguros", "money") +
      _field("despesasVeiculos", "Despesas com veículos", "money")
    );
    h += _row(
      _field("honorariosContabeis", "Honorários (contábeis/advocatícios)", "money") +
      _field("marketingPublicidade", "Marketing e publicidade", "money")
    );
    h += _row(
      _field("despesasViagem", "Viagens", "money") +
      _field("materialEscritorio", "Material de escritório", "money")
    );
    h += _field("outrasDespesasOp", "Outras despesas operacionais", "money");

    // ── Adições ao LALUR ──
    h += _sectionTitle("Despesas Indedutíveis → Adições ao LALUR");
    h += _infoBox(
      "Despesas que NÃO podem ser deduzidas do Lucro Real. Cada R$ 1,00 indedutível gera R$ 0,34 a mais de imposto (25% IRPJ + 9% CSLL). Marque apenas as que se aplicam.",
      "wz-info-warning"
    );

    h += _field("temMultas", "Multas punitivas", "checkbox");
    h += _field("multasPunitivas", "Valor das multas punitivas", "money", {
      condition: "temMultas",
      tip: "Indedutível (Art. 311, §5º). Multas COMPENSATÓRIAS são dedutíveis.",
      extra: '<div class="wz-badge wz-badge-red" data-condition="temMultas" style="display:none">Impacto: <span id="impactoMultas"></span></div>',
    });

    h += _field("temBrindes", "Brindes", "checkbox");
    h += _field("brindes", "Valor dos brindes", "money", {
      condition: "temBrindes",
      tip: "Indedutível (Art. 13, Lei 9.249). Estratégia: reclassificar como propaganda.",
    });

    h += _field("temAlimSocios", "Alimentação de sócios/administradores", "checkbox");
    h += _field("alimentacaoSocios", "Valor da alimentação de sócios", "money", {
      condition: "temAlimSocios",
      tip: "Indedutível (Art. 260, §ú, IV). Use PAT para funcionários.",
    });

    h += _field("temGratificacaoAdm", "Gratificações a administradores", "checkbox");
    h += _field("gratificacoesAdm", "Valor das gratificações", "money", {
      condition: "temGratificacaoAdm",
      tip: "Indedutível (Art. 358, §1º). Estratégia: converter em pró-labore (dedutível).",
      extra: '<div class="wz-badge wz-badge-green" data-condition="temGratificacaoAdm" style="display:none">💡 Converter para pró-labore economiza <span id="econGratif"></span></div>',
    });

    h += _field("temDoacoesFora", "Doações fora dos limites legais", "checkbox");
    h += _field("doacoesIrregulares", "Valor das doações irregulares", "money", {
      condition: "temDoacoesFora",
      tip: "Limite: 2% do lucro operacional (Art. 377-385)",
    });

    h += _field("temDespSemNF", "Despesas sem comprovante/NF", "checkbox");
    h += _field("despesasSemNF", "Valor sem comprovante", "money", {
      condition: "temDespSemNF",
      tip: "Indedutível (Art. 311). SEMPRE manter documentação fiscal.",
    });

    h += _field("temProvisoes", "Provisões não dedutíveis", "checkbox");
    h += _field("provisoesIndedutiveis", "Valor das provisões", "money", {
      condition: "temProvisoes",
      tip: "Adição TEMPORÁRIA — excluir quando realizada (Art. 340-352)",
      extra: '<span class="wz-badge wz-badge-gray" data-condition="temProvisoes" style="display:none">Tipo T — vai para Parte B do LALUR</span>',
    });

    h += _field("temMEPNeg", "Resultado negativo de equivalência patrimonial", "checkbox");
    h += _field("mepNegativo", "Valor do MEP negativo", "money", {
      condition: "temMEPNeg",
      tip: "Adição temporária (Art. 389). Controlado na Parte B.",
    });

    h += _field("temDepContMaior", "Depreciação contábil > fiscal", "checkbox");
    h += _field("depContabilMaiorFiscal", "Diferença depreciação contábil vs fiscal", "money", {
      condition: "temDepContMaior",
      tip: "Diferença entre depreciação IFRS e fiscal. Adição temporária.",
    });

    h += _field("temOutrasAdicoes", "Outras adições", "checkbox");
    h += '<div data-condition="temOutrasAdicoes" style="display:none">';
    h += _field("outrasAdicoes", "Valor de outras adições", "money");
    h += _field("descOutrasAdicoes", "Descrição das outras adições", "textarea");
    h += "</div>";

    h += _autoCalcBox("calcTotalAdicoes");

    // ── Exclusões ──
    h += _sectionTitle("Exclusões do Lucro Real");
    h += _infoBox(
      "Valores que REDUZEM a base de cálculo. Cada R$ 1,00 de exclusão economiza R$ 0,34 em impostos.",
      "wz-info-success"
    );

    h += _field("temDividendos", "Dividendos recebidos de PJ brasileira", "checkbox");
    h += _field("dividendosRecebidos", "Valor dos dividendos", "money", {
      condition: "temDividendos",
      tip: "Art. 261, II + Lei 9.249, art. 10",
    });

    h += _field("temMEPPos", "Resultado positivo de equivalência patrimonial", "checkbox");
    h += _field("mepPositivo", "Valor do MEP positivo", "money", {
      condition: "temMEPPos",
      tip: "Art. 389",
    });

    h += _field("temReversaoProvisao", "Reversão de provisões antes adicionadas", "checkbox");
    h += _field("reversaoProvisoes", "Valor das reversões", "money", {
      condition: "temReversaoProvisao",
      tip: "Art. 261, §ú, V — era Parte B, agora exclui",
    });

    h += _field("temSubvencao", "Subvenção para investimento", "checkbox");
    h += _field("subvencaoInvestimento", "Valor da subvenção", "money", {
      condition: "temSubvencao",
      tip: "⚠️ ATENÇÃO: A Lei 14.789/2023 revogou o art. 30 da Lei 12.973/2014. " +
           "Subvenções (ex: ICMS) passam a ser tributadas por IRPJ/CSLL/PIS/COFINS, " +
           "salvo adesão ao REIS (Regime Especial de Inclusão de Subvenção). " +
           "Consulte contador para verificar elegibilidade ao REIS.",
    });

    h += _field("temDepAcelIncentivada", "Depreciação acelerada incentivada", "checkbox");
    h += _field("depAceleradaIncentivadaExclusao", "Valor da exclusão por depreciação incentivada", "money", {
      condition: "temDepAcelIncentivada",
      tip: "Art. 324-329 — SUDAM/SUDENE ou atividade rural",
    });

    h += _field("temOutrasExclusoes", "Outras exclusões", "checkbox");
    h += _field("outrasExclusoes", "Valor de outras exclusões", "money", {
      condition: "temOutrasExclusoes",
    });

    // ── PDD Fiscal — Perdas no Recebimento de Créditos ──
    h += _sectionTitle("Perdas no Recebimento de Créditos (PDD Fiscal)");
    h += _infoBox(
      "Créditos vencidos há mais de 6 meses e com providências de cobrança podem ser " +
      "excluídos da base do IRPJ/CSLL (Art. 340-342, RIR/2018). " +
      "NÃO são adições temporárias — são exclusões definitivas quando os requisitos são cumpridos.",
      "wz-info-success"
    );
    h += _field("temPDD", "Possui perdas no recebimento de créditos?", "checkbox");
    h += '<div data-condition="temPDD" style="display:none">';
    h += _row(
      _field("perdasCreditos6Meses", "Créditos vencidos > 6 meses (com cobrança)", "money", {
        tip: "Créditos até R$ 15.000 por devedor: basta vencimento + provisão contábil. " +
             "Acima de R$ 15.000: necessário protesto, ação judicial, ou declaração de insolvência.",
      }) +
      _field("perdasCreditosJudicial", "Créditos em cobrança judicial", "money", {
        tip: "Independente do valor — basta ajuizamento da ação",
      })
    );
    h += _field("perdasCreditosFalencia", "Créditos com devedor em falência/recuperação", "money", {
      tip: "Dedutível a partir da sentença declaratória de falência ou deferimento da recuperação",
    });
    h += _autoCalcBox("calcPDD");
    h += "</div>";

    h += _autoCalcBox("calcTotalExclusoes");

    // ── Despesas Condicionais e Limites Legais ──
    h += _sectionTitle("Despesas Condicionais e Limites Legais");
    h += _infoBox(
      "Despesas sujeitas a limites legais de dedutibilidade. Valores que excedam os limites serão automaticamente adicionados ao LALUR como indedutíveis.",
      "wz-info-warning"
    );
    h += _row(
      _field("doacoesOperacionais", "Doações a entidades civis (operacionais)", "money", {
        tip: "Limite: 2% do lucro operacional (Art. 377)",
      }) +
      _field("doacoesOSCIP", "Doações a OSCIPs", "money", {
        tip: "Limite: 2% do lucro operacional (Art. 377, §1º)",
      })
    );
    h += _field("doacoesEntidadesEnsino", "Doações a entidades de ensino/pesquisa", "money", {
      tip: "Limite: 1,5% do lucro operacional (Art. 385)",
    });
    h += _field("previdenciaComplementarPatronal", "Contribuição patronal à previdência complementar", "money", {
      tip: "Limite: 20% da folha salarial anual (Art. 369, §1º)",
    });
    h += _field("royaltiesPagos", "Royalties e assistência técnica pagos", "money", {
      tip: "Limite: 5% da receita líquida (Art. 365)",
    });
    h += _row(
      _field("provisoesContingencias", "Provisões para contingências (trabalhistas, cíveis, fiscais)", "money", {
        tip: "NÃO dedutível — gera adição ao LALUR. Reversão futura gera exclusão. (Art. 340)",
      }) +
      _field("provisoesGarantias", "Provisões para garantia de produtos", "money", {
        tip: "NÃO dedutível (Art. 340)",
      })
    );
    h += _field("despesasBrindes", "Despesas com brindes", "money", {
      tip: "100% indedutível (Art. 13, VII Lei 9.249)",
    });
    h += _field("jurosVinculadasExterior", "Juros pagos a pessoa vinculada no exterior", "money", {
      tip: "Sujeito a regras de subcapitalização (Art. 249-251)",
    });

    h += _autoCalcBox("calcCustos");
    return h;
  }

  // ──────────────────────────────────────────────────────────────────────────
  //  ETAPA 3 — Patrimônio, JCP e Prejuízos
  // ──────────────────────────────────────────────────────────────────────────
  function renderEtapa3() {
    var h = "";

    // ── Patrimônio Líquido ──
    h += _sectionTitle("Patrimônio Líquido");
    h += _infoBox(
      "O Patrimônio Líquido é a base para cálculo dos Juros sobre Capital Próprio (JCP). Informe o PL total ou detalhe os componentes.",
      ""
    );
    h += _field("patrimonioLiquido", "PL total (se souber diretamente)", "money", {
      tip: "Se preenchido, prevalece sobre os componentes abaixo.",
    });
    h += _field("detalharPL", "Ou detalhar componentes", "checkbox");
    h += '<div data-condition="detalharPL" style="display:none">';
    h += _row(
      _field("capitalSocial", "Capital Social Integralizado", "money") +
      _field("reservasCapital", "Reservas de Capital", "money")
    );
    h += _row(
      _field("reservasLucros", "Reservas de Lucros", "money") +
      _field("lucrosAcumulados", "Lucros Acumulados", "money")
    );
    h += _field("ajustesAvaliacaoPatrimonial", "Ajustes de Avaliação Patrimonial", "money", {
      tip: "Pode ser positivo ou negativo. CPC/Lei 6.404 Art. 182 §3°. Inclui: ajustes a valor justo de instrumentos financeiros, variações cambiais de investimentos no exterior, etc.",
    });
    h += _field("prejuizosContabeis", "(-) Prejuízos Acumulados (contábil)", "money");
    h += "</div>";
    h += _autoCalcBox("calcPL");

    // ── JCP ──
    h += _sectionTitle("Juros sobre Capital Próprio (JCP)");
    h += _infoBox(
      'O JCP permite DEDUZIR até PL × TJLP da base do IRPJ+CSLL. Para cada R$ 1,00 de JCP pago, a empresa economiza até R$ 0,165 líquido (34% de IRPJ+CSLL economizados − 17,5% de IRRF retido na distribuição — LC 224/2025). <strong>É a ferramenta de planejamento tributário mais poderosa do Lucro Real.</strong>',
      "wz-info-success"
    );
    // Aviso se só PL total preenchido (sem detalhamento)
    if (_n(dadosEmpresa.patrimonioLiquido) > 0 && !(dadosEmpresa.detalharPL === true || dadosEmpresa.detalharPL === "true")) {
      h += _infoBox(
        'Para cálculo preciso do JCP, detalhe os componentes do PL. O Limite 2 depende especificamente de Lucros Acumulados + Reservas de Lucros.',
        "wz-info-warning"
      );
    }
    h += _field("tjlp", "TJLP anual vigente (%)", "percent", {
      default: "7.97",
      tip: "Taxa de Juros de Longo Prazo (TJLP 2025: 7,97% a.a.). Consulte a taxa vigente no Banco Central (www.bcb.gov.br).",
    });
    h += _field("plAjustadoJCP", "PL Ajustado p/ JCP — Lei 14.789/2023 (opcional)", "money", {
      tip: "Conforme Lei 14.789/2023, a base do JCP pode ser limitada ao PL Ajustado (PL - MEP - PDD - AVP). Se informado, será usado no lugar do PL contábil total para cálculo do JCP máximo.",
    });
    h += _autoCalcBox("calcJCP");

    // ── Prejuízos Fiscais ──
    h += _sectionTitle("Prejuízos Fiscais");
    h += _infoBox(
      "Prejuízos fiscais podem ser compensados com até 30% do lucro ajustado por período. <strong>Não prescrevem.</strong>",
      ""
    );
    h += _row(
      _field("prejuizoFiscal", "Prejuízo Fiscal acumulado (IRPJ)", "money", {
        tip: "Saldo da Parte B do LALUR. Não prescreve.",
      }) +
      _field("baseNegativaCSLL", "Base Negativa de CSLL acumulada", "money", {
        tip: "Saldo acumulado. Trava de 30% aplica-se separadamente.",
      })
    );
    h += _field("temMudancaControle", "Houve mudança de controle societário?", "checkbox");
    h += _field("temMudancaRamo", "Houve mudança de ramo de atividade?", "checkbox", {
      condition: "temMudancaControle",
    });
    h += '<div data-condition="temMudancaControle" style="display:none">';
    h += _infoBox(
      '⚠️ Combinada com mudança de ramo, VEDA compensação (Art. 584)',
      "wz-info-warning"
    );
    h += "</div>";

    h += _field("tipoReorganizacao", "Houve incorporação/fusão/cisão?", "select", {
      options:
        '<option value="">Não</option>' +
        '<option value="incorporacao" ' + (dadosEmpresa.tipoReorganizacao === "incorporacao" ? "selected" : "") + ">Incorporação</option>" +
        '<option value="fusao" ' + (dadosEmpresa.tipoReorganizacao === "fusao" ? "selected" : "") + ">Fusão</option>" +
        '<option value="cisao_total" ' + (dadosEmpresa.tipoReorganizacao === "cisao_total" ? "selected" : "") + ">Cisão Total</option>" +
        '<option value="cisao_parcial" ' + (dadosEmpresa.tipoReorganizacao === "cisao_parcial" ? "selected" : "") + ">Cisão Parcial</option>",
    });
    h += _field("percentPLRemanescente", "% PL remanescente (cisão parcial)", "percent", {
      condition: "tipoReorganizacao",
      placeholder: "70",
    });

    h += _autoCalcBox("calcPrejuizos");

    // ── Estimativas já pagas ──
    // Seção só faz sentido para apuração anual (estimativa ou suspensão/redução)
    var apLR = dadosEmpresa.apuracaoLR || "";
    if (apLR === "anual_estimativa" || apLR === "anual_suspensao") {
      h += _sectionTitle("Estimativas já Pagas");
      h += _infoBox(
        "No regime anual por estimativa, antecipações mensais de IRPJ e CSLL são descontadas no ajuste anual.",
        ""
      );
      h += _field("pagouEstimativas", "Pagou estimativas mensais no período?", "checkbox");
      h += '<div data-condition="pagouEstimativas" style="display:none">';
      h += _row(
        _field("estimativasIRPJPagas", "Total estimativas IRPJ pagas", "money", {
          tip: "Estimativas pagas são descontadas do imposto devido no ajuste anual",
        }) +
        _field("estimativasCSLLPagas", "Total estimativas CSLL pagas", "money")
      );
      h += _field("estimativasPISCOFINSPagas", "Total estimativas PIS/COFINS pagas", "money", {
        tip: "Se aplicável ao regime anual por estimativa",
      });
      h += "</div>";
    } else if (apLR === "trimestral") {
      // Trimestral — não tem estimativas, mas permite informar antecipações
      h += _sectionTitle("Antecipações");
      h += _infoBox(
        "Na apuração trimestral, não há estimativas mensais. Antecipações ocorrem somente via retenções na fonte (informar na Etapa 5).",
        "wz-info-gray"
      );
    } else {
      // Sem apuração selecionada — mostra seção genérica
      h += _sectionTitle("Estimativas já Pagas");
      h += _infoBox(
        "Selecione a forma de apuração na Etapa 1 para habilitar os campos de estimativas.",
        "wz-info-gray"
      );
    }

    // ── Subcapitalização e Operações Vinculadas ──
    h += _sectionTitle("Subcapitalização e Operações Vinculadas");
    h += _infoBox(
      "Dívidas com pessoas vinculadas estão sujeitas a limites de dedutibilidade de juros (Art. 249-251 RIR/2018). Juros que excederem os limites são indedutíveis.",
      "wz-info-warning"
    );
    h += _row(
      _field("dividaVinculadaComParticipacao", "Dívida com vinculada que tem participação no PL", "money", {
        tip: "Limite: 2× participação da vinculada no PL (Art. 250)",
      }) +
      _field("participacaoVinculadaNoPL", "Participação da vinculada no PL", "money")
    );
    h += _field("dividaParaisoFiscal", "Dívida com entidade em paraíso fiscal", "money", {
      tip: "Limite: 30% do PL (Art. 251)",
    });
    h += _row(
      _field("prejuizoNaoOperacional", "Prejuízo não-operacional acumulado (alienação ativo)", "money", {
        tip: "Só compensa com lucro de mesma natureza (Art. 581-582)",
      }) +
      _field("lucroNaoOperacional", "Lucro na alienação de ativo imobilizado/investimento (ano corrente)", "money", {
        tip: "Compensável com prejuízo não-operacional acumulado",
      })
    );
    h += _field("atividadeRural", "Empresa tem atividade rural (permite compensação integral sem trava de 30%)", "checkbox", {
      tip: "Art. 583 — Prejuízo de atividade rural pode ser compensado integralmente, sem a trava de 30%",
    });

    // ── Vedações à Compensação ──
    h += _sectionTitle("Vedações à Compensação");
    h += _infoBox(
      "Situações que podem VEDAR ou LIMITAR a compensação de prejuízos fiscais. Preencha para diagnóstico de riscos.",
      "wz-info-warning"
    );
    h += _row(
      _field("houveMudancaControle", "Houve mudança de controle societário?", "checkbox", {
        tip: "Combinada com mudança de ramo, VEDA compensação (Art. 584)",
      }) +
      _field("houveMudancaRamo", "Houve mudança de ramo de atividade?", "checkbox", {
        tip: "Art. 584 — Vedada compensação se cumulada com mudança de controle",
      })
    );
    h += _field("tipoReorganizacaoVedacao", "Reorganização societária no período?", "select", {
      tip: "Incorporação/fusão/cisão podem limitar compensação de prejuízos (Art. 585)",
      options:
        '<option value="NENHUMA" ' + ((!dadosEmpresa.tipoReorganizacaoVedacao || dadosEmpresa.tipoReorganizacaoVedacao === "NENHUMA") ? "selected" : "") + '>Nenhuma</option>' +
        '<option value="INCORPORACAO" ' + (dadosEmpresa.tipoReorganizacaoVedacao === "INCORPORACAO" ? "selected" : "") + '>Incorporação</option>' +
        '<option value="FUSAO" ' + (dadosEmpresa.tipoReorganizacaoVedacao === "FUSAO" ? "selected" : "") + '>Fusão</option>' +
        '<option value="CISAO" ' + (dadosEmpresa.tipoReorganizacaoVedacao === "CISAO" ? "selected" : "") + '>Cisão</option>',
    });
    h += _field("ehSCP", "É Sociedade em Conta de Participação (SCP)?", "checkbox", {
      tip: "Prejuízos de SCP não compensam com ostensivo e vice-versa (Art. 586)",
    });

    return h;
  }

  // ──────────────────────────────────────────────────────────────────────────
  //  ETAPA 4 — Retenções na Fonte e Créditos PIS/COFINS
  // ──────────────────────────────────────────────────────────────────────────
  function renderEtapa4() {
    var h = "";

    // ── Retenções ──
    h += _sectionTitle("Retenções na Fonte");
    h += _infoBox(
      '<strong>No Lucro Real, retenções são ANTECIPAÇÕES 100% compensáveis.</strong> Cada R$ 1 retido é R$ 1 a menos de imposto a pagar. Se retenções > imposto, gera saldo negativo (restituição via PER/DCOMP).',
      "wz-info-success"
    );

    // Modo automático baseado em % receita pública
    var percPub = _n(dadosEmpresa.percentReceitaPublico);
    if (percPub > 0) {
      var rbEst = _n(dadosEmpresa.receitaBrutaAnual);
      var irrfEst = _r(rbEst * (percPub / 100) * 0.048);
      var csrfEst = _r(rbEst * (percPub / 100) * 0.0465);
      h += _infoBox(
        '<strong>Estimativa automática</strong> (baseada em ' + percPub + '% de receita pública):<br>' +
        'IRRF estimado (4,8%): ' + _m(irrfEst) + ' | CSRF estimado (4,65%): ' + _m(csrfEst) +
        '<br><em>Edite os valores abaixo se necessário.</em>',
        "wz-info-default"
      );
    }

    h += _row(
      _field("irrfRetidoPrivado", "IRRF retido por empresas privadas (1,5%)", "money", {
        tip: "Art. 714 — Retenção sobre serviços profissionais",
      }) +
      _field("irrfRetidoPublico", "IRRF retido por órgãos públicos (4,8%)", "money", {
        tip: "Art. 720 + IN RFB 1.234/12",
      })
    );
    h += _row(
      _field("pisRetido", "PIS retido (0,65%)", "money") +
      _field("cofinsRetido", "COFINS retido (3,0%)", "money")
    );
    h += _row(
      _field("csllRetido", "CSLL retido (1,0%)", "money") +
      _field("issRetido", "ISS retido na fonte", "money")
    );

    h += _autoCalcBox("calcRetencoes");

    // ── Retenções Detalhadas por Tipo ──
    h += _sectionTitle("Retenções Detalhadas por Tipo");
    h += _infoBox(
      "Detalhamento das retenções por categoria de serviço. Permite cálculo preciso de saldos a compensar por tipo de tributo.",
      "wz-info-default"
    );
    h += _field("irrfServicosLimpeza", "IRRF — Serviços de limpeza/segurança/vigilância (1%)", "money", {
      tip: "Art. 716 — Retenção de 1% sobre serviços de limpeza, segurança e vigilância",
    });
    h += _field("irrfComissoes", "IRRF — Comissões e representação (1,5%)", "money", {
      tip: "Art. 718 — Retenção sobre comissões e corretagens",
    });
    h += _field("recebeDeAdmPublica", "Presta serviços para órgãos públicos?", "checkbox", {
      tip: "Se sim, sujeito a retenção unificada de 9,45% (IRPJ+CSLL+PIS+COFINS)",
    });
    h += _field("irrfAdmPublica", "IRRF — Serviços prestados à Administração Pública (4,8%)", "money", {
      condition: "recebeDeAdmPublica",
      tip: "Art. 720 + IN RFB 1.234/12 — Retenção unificada sobre pagamentos de órgãos públicos",
    });

    // ── CPRB — Desoneração da Folha ──
    h += _sectionTitle("Desoneração da Folha (CPRB)");
    h += _infoBox(
      "Empresas de TI, construção civil, comunicação e outros setores podem optar pela CPRB. " +
      "Substitui a CPP patronal de 20% por alíquota sobre receita bruta (Lei 12.546/2011).",
      ""
    );
    // Auto-detectar elegibilidade pelo CNAE principal
    var cnaePri = (dadosEmpresa.cnaePrincipal || "").replace(/[\s\-\/]/g, "");
    if (cnaePri.substring(0, 2) === "62" || dadosEmpresa._cprbSugerida) {
      h += _infoBox(
        'CNAE de TI detectado — sua empresa é elegível à CPRB (alíquota 4,5% sobre receita bruta em vez de 20% sobre folha). Avalie abaixo.',
        "wz-info-success"
      );
    }
    h += _field("optouCPRB", "Empresa optou pela CPRB?", "checkbox");
    h += '<div data-condition="optouCPRB" style="display:none">';
    h += _row(
      _field("aliquotaCPRB", "Alíquota CPRB (%)", "percent", {
        default: "4.5",
        tip: "TI/Serviços: 4,5%. Construção/Transporte: 1% a 3%. Verificar Lei 12.546/2011 e alterações.",
      }) +
      _field("receitaBrutaCPRB", "Base de cálculo CPRB (receita bruta do período)", "money", {
        tip: "Se igual à receita bruta total, pode deixar em branco (usará a receita bruta informada na Etapa 2)",
      })
    );
    h += _autoCalcBox("calcCPRB");
    h += "</div>";

    // ── Créditos PIS/COFINS ──
    h += _sectionTitle("Créditos de PIS/COFINS (Não-Cumulativo)");
    h += _infoBox(
      '<strong>No Lucro Real, PIS/COFINS são não-cumulativos:</strong> alíquota de 9,25% sobre receita, mas com DIREITO A CRÉDITOS sobre insumos, energia, aluguéis, depreciação etc. Se seus custos com crédito são altos, a alíquota efetiva pode ser MUITO menor que 9,25%.',
      "wz-info-default"
    );

    h += _row(
      _field("comprasMercadoriasAnual", "Compras de mercadorias/insumos", "money", {
        tip: "Art. 3º, I — Bens para revenda e insumos",
      }) +
      _field("energiaCredito", "Energia elétrica", "money", {
        tip: "Art. 3º, III — Energia consumida na atividade",
      })
    );
    h += _row(
      _field("alugueisPJCredito", "Aluguéis pagos a PJ", "money", {
        tip: "Art. 3º, IV",
      }) +
      _field("leasingCredito", "Contraprestação de leasing", "money", {
        tip: "Art. 3º, V — Arrendamento mercantil operacional",
      })
    );
    h += _row(
      _field("depreciacaoBensCredito", "Depreciação de máquinas na produção", "money", {
        tip: "Art. 3º, VI",
      }) +
      _field("depreciacaoEdifCredito", "Depreciação de edificações", "money", {
        tip: "Art. 3º, VII",
      })
    );
    h += _row(
      _field("freteVendasAnual", "Fretes sobre vendas", "money", {
        tip: "Art. 3º, IX",
      }) +
      _field("armazenagemCredito", "Armazenagem", "money", {
        tip: "Art. 3º, IX",
      })
    );
    h += _row(
      _field("valeTranspAlim", "Vale-transporte/alimentação funcionários", "money") +
      _field("manutencaoMaquinas", "Manutenção de máquinas", "money")
    );
    h += _row(
      _field("devolucoesVendas", "Devoluções de vendas", "money") +
      _field("outrosCreditosPC", "Outros custos com crédito", "money")
    );
    h += _field("creditoEstoqueAbertura", "Crédito sobre estoque de abertura", "money", {
      tip: "Se migrou recentemente para Lucro Real, tem direito a crédito sobre estoques existentes — 1/12 por mês durante 12 meses",
    });

    h += _autoCalcBox("calcPisCofins");
    return h;
  }

  // ──────────────────────────────────────────────────────────────────────────
  //  ETAPA 5 — Ativos, Depreciação e Incentivos
  // ──────────────────────────────────────────────────────────────────────────
  function renderEtapa5() {
    var h = "";
    var uf = dadosEmpresa.uf || "";
    var isSUDAM = LR && LR.helpers ? LR.helpers.ehSUDAM(uf) : false;
    var isSUDENE = LR && LR.helpers ? LR.helpers.ehSUDENE(uf) : false;
    if (!isSUDAM && LR && LR.sudam) isSUDAM = LR.sudam.estados.indexOf(uf) >= 0;
    if (!isSUDENE && LR && LR.sudene) isSUDENE = LR.sudene.estados.indexOf(uf) >= 0;

    // ── Bens do ativo ──
    h += _sectionTitle("Bens do Ativo Imobilizado");
    h += _infoBox(
      "Informe o valor original total dos bens por categoria. A depreciação será calculada automaticamente com base nas taxas fiscais. Dados de LR.depreciacao.tabela.",
      ""
    );
    h += _row(
      _field("valorVeiculos", "Veículos (20% a.a. — 5 anos)", "money") +
      _field("valorMaquinas", "Máquinas e Equipamentos (10% a.a. — 10 anos)", "money")
    );
    h += _row(
      _field("valorComputadores", "Computadores/Periféricos (20% a.a. — 5 anos)", "money") +
      _field("valorMoveis", "Móveis e Utensílios (10% a.a. — 10 anos)", "money")
    );
    h += _row(
      _field("valorEdificios", "Edifícios/Construções (4% a.a. — 25 anos)", "money") +
      _field("valorDrones", "Drones/GPS/Equip. técnicos (20% a.a. — 5 anos)", "money")
    );
    h += _row(
      _field("valorTratores", "Tratores (25% a.a. — 4 anos)", "money") +
      _field("valorSoftware", "Software adquirido (20% a.a. — 5 anos)", "money")
    );
    h += _row(
      _field("valorInstalacoes", "Instalações (10% a.a. — 10 anos)", "money") +
      _field("valorOutrosBens", "Outros bens (10% a.a. default)", "money")
    );
    h += _field("bensSmallValue", "Bens de pequeno valor (≤ R$ 1.200)", "money", {
      tip: "Podem ser lançados diretamente como despesa no período (Art. 313, §1º)",
    });

    // ── Depreciação acelerada por turnos ──
    h += _sectionTitle("Depreciação Acelerada (Turnos) — Art. 323");
    h += _field("turnosOperacao", "Turnos de operação por dia", "radio", {
      options: [
        { value: "1", label: "1 turno (8h) — multiplicador 1,0×" },
        { value: "2", label: "2 turnos (16h) — multiplicador 1,5×" },
        { value: "3", label: "3 turnos (24h) — multiplicador 2,0×" },
      ],
      default: "1",
      tip: "Art. 323 — Mais turnos = depreciação mais rápida = menor base tributável",
    });

    // ── Depreciação incentivada SUDAM/SUDENE ──
    if (isSUDAM || isSUDENE) {
      h += _sectionTitle("Depreciação Acelerada Incentivada (SUDAM/SUDENE)");
      h += _infoBox(
        "Como sua empresa está em área " + (isSUDAM ? "SUDAM" : "SUDENE") +
        ", bens NOVOS adquiridos podem ter depreciação integral (100%) no ano de aquisição — Art. 329 RIR/2018.",
        "wz-info-success"
      );
      h += _field("temBensNovos", "Adquiriu bens NOVOS nos últimos 12 meses?", "checkbox");
      h += _field("valorBensNovos", "Valor dos bens novos", "money", {
        condition: "temBensNovos",
        tip: "Depreciação integral (100%) no ano de aquisição",
      });
    }

    // ── Incentivos Regionais ──
    h += _sectionTitle("Incentivos Regionais (SUDAM/SUDENE)");
    if (isSUDAM) {
      h += _infoBox(
        '✅ <strong>' + uf + ' — Área SUDAM (Amazônia Legal)</strong> — elegível a redução de até 75% do IRPJ sobre o lucro da exploração, com prazo de 10 anos. É o maior incentivo fiscal disponível no Brasil.',
        "wz-info-success"
      );
    } else if (isSUDENE) {
      h += _infoBox(
        '✅ <strong>' + uf + ' — Área SUDENE</strong> — elegível a redução de até 75% do IRPJ sobre o lucro da exploração.',
        "wz-info-success"
      );
    } else {
      h += _infoBox(
        'A UF selecionada (' + (uf || "nenhuma") + ') não está em área SUDAM nem SUDENE. Incentivos regionais não se aplicam.',
        "wz-info-gray"
      );
    }
    h += _field("temProjetoAprovado", "Tem projeto aprovado na " + (isSUDAM ? "SUDAM" : isSUDENE ? "SUDENE" : "SUDAM/SUDENE") + "?", "checkbox");
    h += '<div data-condition="temProjetoAprovado" style="display:none">';
    h += _row(
      _field("setorPrioritario", "Setor prioritário do projeto", "select", {
        options: '<option value="">Selecione...</option>' +
          (LR && LR.sudam && LR.sudam.setoresPrioritarios
            ? LR.sudam.setoresPrioritarios.map(function (s) {
                return '<option value="' + s.id + '" ' +
                  (dadosEmpresa.setorPrioritario === s.id ? "selected" : "") +
                  ">" + s.label + "</option>";
              }).join("")
            : ""),
      }) +
      _field("percentualReducao", "Percentual de redução IRPJ", "select", {
        options:
          '<option value="75">75% (padrão)</option>' +
          '<option value="50" ' + (dadosEmpresa.percentualReducao === "50" ? "selected" : "") + ">50%</option>" +
          '<option value="25" ' + (dadosEmpresa.percentualReducao === "25" ? "selected" : "") + ">25%</option>",
      })
    );
    h += _row(
      _field("possuiLaudoConstitutivo", "Possui Laudo Constitutivo emitido?", "checkbox") +
      _field("possuiReconhecimentoSRF", "Possui reconhecimento da SRF?", "checkbox")
    );
    h += _field("usarReinvestimento30", "Utiliza reinvestimento de 30%?", "checkbox", {
      tip: "30% do IRPJ sobre lucro da exploração depositado em banco oficial. 50% pode ser usado como capital de giro (Lei 13.799/2019)",
    });
    h += "</div>";

    // ── Incentivos Fiscais Diretos ──
    h += _sectionTitle("Incentivos Fiscais (Dedução do IRPJ)");
    h += _infoBox(
      'Incentivos fiscais são deduções DIRETAS do IRPJ normal (15%). Cada um tem limite individual e o somatório não pode ultrapassar o IRPJ normal.',
      ""
    );

    h += _field("usaPAT", "PAT — Programa de Alimentação do Trabalhador (até 4% IRPJ)", "checkbox");
    h += _field("valorPAT", "Valor investido no PAT", "money", { condition: "usaPAT" });

    h += _field("usaFIA", "FIA — Fundo da Infância e Adolescência (até 1%)", "checkbox");
    h += _field("valorFIA", "Valor doado ao FIA", "money", { condition: "usaFIA" });

    h += _field("usaFundoIdoso", "Fundo do Idoso (até 1%)", "checkbox");
    h += _field("valorFundoIdoso", "Valor doado ao Fundo do Idoso", "money", { condition: "usaFundoIdoso" });

    h += _field("usaRouanet", "Lei Rouanet — Cultura (até 4%)", "checkbox");
    h += _field("valorRouanet", "Valor investido em cultura", "money", { condition: "usaRouanet" });

    h += _field("usaEsporte", "Lei do Esporte (até 1%)", "checkbox");
    h += _field("valorEsporte", "Valor investido em esporte", "money", { condition: "usaEsporte" });

    h += _field("usaPRONON", "PRONON — Oncologia (até 1%)", "checkbox");
    h += _field("valorPRONON", "Valor investido PRONON", "money", { condition: "usaPRONON" });

    h += _field("usaPRONAS", "PRONAS/PCD — Pessoa com Deficiência (até 1%)", "checkbox");
    h += _field("valorPRONAS", "Valor investido PRONAS/PCD", "money", { condition: "usaPRONAS" });

    h += _field("usaEmpresaCidada", "Empresa Cidadã — prorrogação licença-maternidade (valor integral)", "checkbox");

    h += _sectionTitle("Lei do Bem (Pesquisa & Desenvolvimento)");
    h += _field("investePD", "Investe em P&D (Lei do Bem)?", "checkbox");
    h += _field("valorPD", "Valor anual investido em P&D", "money", {
      condition: "investePD",
      tip: "Exclusão de 60% a 80% dos gastos da base IRPJ+CSLL — Lei 11.196/2005",
    });

    h += _autoCalcBox("calcDepreciacao");

    // ── Método de Avaliação de Estoques ──
    h += _sectionTitle("Método de Avaliação de Estoques");
    h += _infoBox(
      "O método de avaliação de estoque afeta o custo das mercadorias vendidas e, consequentemente, o lucro tributável. O método deve ser consistente ano a ano. UEPS é vedado.",
      ""
    );
    h += _field("metodoEstoque", "Método de avaliação de estoque", "select", {
      tip: "Método deve ser consistente ano a ano. UEPS é vedado. (Art. 307)",
      options:
        '<option value="" ' + (!dadosEmpresa.metodoEstoque ? "selected" : "") + '>Selecione...</option>' +
        '<option value="CUSTO_MEDIO" ' + (dadosEmpresa.metodoEstoque === "CUSTO_MEDIO" ? "selected" : "") + '>Custo Médio Ponderado (Art. 307)</option>' +
        '<option value="PEPS" ' + (dadosEmpresa.metodoEstoque === "PEPS" ? "selected" : "") + '>PEPS/FIFO — Primeiro a Entrar, Primeiro a Sair (Art. 307)</option>' +
        '<option value="PRECO_VENDA_MARGEM" ' + (dadosEmpresa.metodoEstoque === "PRECO_VENDA_MARGEM" ? "selected" : "") + '>Preço de Venda menos Margem (Art. 307)</option>' +
        '<option value="MERCADO_RURAL" ' + (dadosEmpresa.metodoEstoque === "MERCADO_RURAL" ? "selected" : "") + '>Preços Correntes de Mercado — Rural (Art. 309)</option>',
    });
    h += _field("valorEstoqueFinal", "Valor do estoque final do período", "money", {
      tip: "Usado para validação do método e cálculo do CMV integrado",
    });

    // ── Amortização e Exaustão ──
    h += _sectionTitle("Amortização e Exaustão");
    h += _infoBox(
      "Goodwill, recursos naturais e despesas pré-operacionais geram deduções por amortização ou exaustão, reduzindo a base tributável ao longo do tempo.",
      ""
    );
    h += _field("valorGoodwill", "Goodwill (ágio por expectativa de rentabilidade)", "money", {
      tip: "Amortizável em 1/60 avos/mês = 20% ao ano (Lei 12.973, Arts. 20-22)",
    });
    h += _field("valorRecursosNaturais", "Custo de direitos minerais/florestais para exaustão", "money", {
      tip: "Art. 334-337 do RIR/2018",
    });
    h += _field("despesasPreOperacionais", "Despesas pré-operacionais (em amortização)", "money", {
      tip: "Amortização diferida — mínimo de 5 anos (Art. 11 Lei 12.973)",
    });

    return h;
  }

  // ──────────────────────────────────────────────────────────────────────────
  //  ETAPA 6 — Revisão, Cenários e Configuração do Relatório
  // ──────────────────────────────────────────────────────────────────────────
  function renderEtapa6() {
    var h = "";
    var d = dadosEmpresa;

    // ── Resumo dos dados ──
    h += _sectionTitle("Resumo dos Dados");
    h += '<div class="wz-resumo">';
    h += '<table class="wz-resumo-table">';
    h += '<tr><td><strong>Empresa:</strong></td><td>' + _esc(d.razaoSocial || "—") + '</td>';
    h += '<td><strong>UF/Município:</strong></td><td>' + (d.uf || "—") + " / " + _esc(d.municipio || "—") + " (ISS: " + (d.issAliquota || "5") + "%)" + '</td></tr>';
    h += '<tr><td><strong>Atividade:</strong></td><td>' + _nomeAtividade(d.tipoAtividade) + '</td>';
    h += '<td><strong>Apuração:</strong></td><td>' + _nomeApuracao(d.apuracaoLR) + '</td></tr>';
    h += '<tr><td><strong>Receita Bruta:</strong></td><td>' + _m(_n(d.receitaBrutaAnual)) + '</td>';
    h += '<td><strong>Custos+Despesas:</strong></td><td>' + _m(_calcTotalCustos() + _calcTotalDespesas()) + '</td></tr>';

    var ll = _calcLL();
    var adj = _calcLucroAjustado();
    h += '<tr><td><strong>Lucro Líquido:</strong></td><td>' + _m(ll) + '</td>';
    h += '<td><strong>Lucro Ajustado:</strong></td><td>' + _m(adj) + '</td></tr>';

    var plVal = _calcPL();
    h += '<tr><td><strong>PL:</strong></td><td>' + _m(plVal) + '</td>';
    h += '<td><strong>Prejuízo Fiscal:</strong></td><td>' + _m(_n(d.prejuizoFiscal)) + '</td></tr>';

    var retTotal = _n(d.irrfRetidoPrivado) + _n(d.irrfRetidoPublico) + _n(d.pisRetido) + _n(d.cofinsRetido) + _n(d.csllRetido);
    h += '<tr><td><strong>Retenções:</strong></td><td>' + _m(retTotal) + '</td>';
    h += '<td><strong>Créditos PIS/COFINS:</strong></td><td>' + _m(_calcBaseCreditos()) + '</td></tr>';
    h += '</table>';

    // Botões de editar por etapa
    h += '<div class="wz-resumo-editar">';
    for (var i = 0; i < ETAPAS.length - 1; i++) {
      h += '<button class="wz-btn wz-btn-small" onclick="LucroRealEstudos.goToStep(' + i + ')">✏️ ' + ETAPAS[i].titulo + '</button>';
    }
    h += '</div>';
    h += '</div>';

    // ── Cenários ──
    h += _sectionTitle("Configuração de Cenários");
    h += _field("gerarCenarios", "Gerar cenários de sensibilidade?", "checkbox", {
      default: true,
    });
    h += '<div data-condition="gerarCenarios" style="display:none">';
    h += _field("variacaoMargemCenario", "Variação de margem para cenários (pontos percentuais)", "percent", {
      default: "5",
      tip: "Pessimista: margem - X pp | Base: margem informada | Otimista: margem + X pp",
    });
    h += "</div>";

    h += _field("gerarProjecao", "Gerar projeção plurianual?", "checkbox", {
      default: true,
    });
    h += '<div data-condition="gerarProjecao" style="display:none">';
    h += _row(
      _field("taxaCrescimentoAnual", "Taxa de crescimento anual da receita (%)", "percent", {
        default: "10",
      }) +
      _field("horizonteProjecao", "Horizonte de projeção", "select", {
        options:
          '<option value="3" ' + (dadosEmpresa.horizonteProjecao === "3" ? "selected" : "") + ">3 anos</option>" +
          '<option value="5" ' + ((!dadosEmpresa.horizonteProjecao || dadosEmpresa.horizonteProjecao === "5") ? "selected" : "") + ">5 anos</option>" +
          '<option value="10" ' + (dadosEmpresa.horizonteProjecao === "10" ? "selected" : "") + ">10 anos</option>",
      })
    );
    h += "</div>";

    // ── Personalização do relatório ──
    h += _sectionTitle("Personalização do Relatório");
    h += _row(
      _field("nomeElaborador", "Nome do elaborador", "text", {
        tip: "Aparece no cabeçalho do relatório impresso",
      }) +
      _field("registroProfissional", "Registro profissional (CRC/OAB)", "text")
    );
    h += _row(
      _field("emailContato", "Email de contato", "text") +
      _field("telefoneContato", "Telefone", "text")
    );
    h += _field("logoURL", "Logo (URL da imagem)", "text", {
      tip: "URL de imagem para cabeçalho do relatório (opcional)",
      placeholder: "https://...",
    });

    return h;
  }

  // ═══════════════════════════════════════════════════════════════════════════
  //  INTEGRAÇÃO COM MunicipiosIBGE — select dinâmico de municípios
  // ═══════════════════════════════════════════════════════════════════════════

  /**
   * Chamado quando a UF muda na etapa 0
   */
  async function _carregarMunicipios(uf) {
    var selectMun = $("municipio");
    var loading = $("municipioLoading");
    if (!selectMun || !uf) return;

    // Mostrar loading
    selectMun.innerHTML = '<option value="">Carregando municípios...</option>';
    selectMun.disabled = true;
    if (loading) loading.style.display = "";

    try {
      if (window.MunicipiosIBGE) {
        var municipios = await window.MunicipiosIBGE.buscarMunicipios(uf, ESTADOS);
        window.MunicipiosIBGE.renderizarSelect(selectMun, municipios, { mostrarISS: true });
      } else {
        // Fallback: select vazio editável
        selectMun.innerHTML = '<option value="">MunicipiosIBGE não disponível</option>';
        selectMun.disabled = false;
      }
    } catch (e) {
      console.warn("[LREstudos] Falha API IBGE, usando fallback:", e);
      try {
        if (window.MunicipiosIBGE) {
          var fallback = window.MunicipiosIBGE.fallbackEstadosJS(uf, ESTADOS);
          window.MunicipiosIBGE.renderizarSelect(selectMun, fallback, { mostrarISS: true });
        }
      } catch (e2) {
        selectMun.innerHTML = '<option value="">Erro ao carregar municípios</option>';
        selectMun.disabled = false;
      }
    }

    if (loading) loading.style.display = "none";

    // Se já tinha município salvo, restaurar seleção
    if (dadosEmpresa.municipio) {
      for (var i = 0; i < selectMun.options.length; i++) {
        if (selectMun.options[i].value === dadosEmpresa.municipio) {
          selectMun.selectedIndex = i;
          break;
        }
      }
    }
  }

  /**
   * Chamado quando o município é selecionado
   */
  function onMunicipioChanged(selectEl) {
    var opt = selectEl.selectedOptions[0];
    if (opt && opt.value) {
      dadosEmpresa.municipio = opt.value;
      if (opt.dataset.iss) {
        dadosEmpresa.issAliquota = parseFloat(opt.dataset.iss);
        dadosEmpresa.issConhecido = opt.dataset.issConhecido === "1";
        // Atualizar campo ISS
        var issInput = $("issAliquota");
        if (issInput) issInput.value = dadosEmpresa.issAliquota;
      }
      // Atualizar dica ISS
      var dicaEl = $("dicaISS");
      if (dicaEl && window.MunicipiosIBGE) {
        dicaEl.innerHTML = window.MunicipiosIBGE.gerarDicaISS(
          dadosEmpresa.issConhecido,
          opt.value
        );
      }
      saveToLS();
    }
  }

  // ═══════════════════════════════════════════════════════════════════════════
  //  SAVE / RESTORE / LOCALSTORAGE
  // ═══════════════════════════════════════════════════════════════════════════

  function saveField(id, val) {
    dadosEmpresa[id] = val;
    // ═══ FIX: Converter campos numéricos conhecidos para Number ═══
    var _camposNumericos = ['numSocios', 'numFuncionarios', 'anoBase', 'turnosOperacao', 'horizonteProjecao', 'issAliquota'];
    if (_camposNumericos.indexOf(id) >= 0 && val !== '' && val !== null && val !== undefined) {
      var _parsed = Number(val);
      if (!isNaN(_parsed)) dadosEmpresa[id] = _parsed;
    }
    saveToLS();
    bindConditionals();
    updateAutoCalcs();

    // Tratamento especial: ao mudar UF, carregar municípios e mostrar badge
    if (id === "uf" && val) {
      _carregarMunicipios(val);
      _atualizarBadgeUF(val);
    }

    // Tratamento: alertas de obrigatoriedade
    if (id === "ehFinanceira" || id === "tipoAtividade") {
      _verificarAlertaObrigatoriedade();
    }

    // Tratamento: ao mudar tipo de serviço ISS, atualizar dica de faixa
    if (id === "tipoServicoISS") {
      var dicaEl2 = $("dicaISS");
      if (dicaEl2) {
        var faixas = {
          informatica: { min: 2, max: 5, desc: "Informática (Item 1)" },
          saude: { min: 2, max: 3, desc: "Saúde (Item 4)" },
          engenharia: { min: 2, max: 5, desc: "Engenharia/Arquitetura (Item 7)" },
          educacao: { min: 2, max: 5, desc: "Educação (Item 8)" },
          contabilidade: { min: 2, max: 5, desc: "Contabilidade (Item 17)" },
          advocacia: { min: 2, max: 5, desc: "Advocacia (Item 17)" },
          consultoria: { min: 2, max: 5, desc: "Consultoria (Item 17)" },
          construcao: { min: 2, max: 5, desc: "Construção civil (Item 7)" },
          transporte: { min: 2, max: 5, desc: "Transporte municipal (Item 16)" },
          outros: { min: 2, max: 5, desc: "Outros serviços" },
        };
        var f = faixas[val];
        if (f) {
          dicaEl2.innerHTML = '<span style="color:#3498db;">Faixa ISS para ' + f.desc + ': ' + f.min + '% a ' + f.max + '%. Verifique a alíquota específica do seu município.</span>';
        }
      }
    }

    // Tratamento: validar ISS manualmente alterado
    if (id === "issAliquota" && window.MunicipiosIBGE) {
      var validacao = window.MunicipiosIBGE.validarISS(val);
      var dicaEl = $("dicaISS");
      if (dicaEl && !validacao.valido) {
        dicaEl.innerHTML = '<span style="color:#f59e0b;">⚠️ ' + validacao.msg + '</span>';
      }
    }

    // ═══ FIX: Máscara de CNPJ (substituição do script morto via innerHTML) ═══
    if (id === 'cnpj' && val) {
      var cnpjEl = $('cnpj');
      if (cnpjEl) {
        var v = String(val).replace(/\D/g, '');
        if (v.length > 14) v = v.substring(0, 14);
        v = v.replace(/(\d{2})(\d)/, '$1.$2')
             .replace(/(\d{3})(\d)/, '$1.$2')
             .replace(/(\d{3})(\d)/, '$1/$2')
             .replace(/(\d{4})(\d)/, '$1-$2');
        cnpjEl.value = v;
        dadosEmpresa.cnpj = v;
      }
    }

    // Alerta receita exterior
    if (id === "receitasExteriorAnual" && _n(val) > 0) {
      var alertaExt = $("alertaExterior");
      if (alertaExt) {
        alertaExt.innerHTML = '<div class="wz-badge wz-badge-red">⚠️ Receitas do exterior tornam o Lucro Real OBRIGATÓRIO (Art. 257, III)</div>';
      }
    }
  }

  function saveMoney(id, el) {
    // Extrair apenas dígitos (e vírgula/ponto decimal) para obter o valor numérico
    var raw = el.value.replace(/[^\d]/g, "");
    // Interpretar como centavos: 3000000 digitado = 30.000,00
    // Mas para UX: tratar como inteiro enquanto não tem vírgula
    // Abordagem: remover tudo que não é dígito, tratar como centavos
    var centavos = parseInt(raw, 10) || 0;
    var valor = centavos / 100;
    dadosEmpresa[id] = valor;

    // Aplicar máscara brasileira no input mantendo cursor funcional
    var formatted = _fmtBRL(valor);
    el.value = formatted;

    saveToLS();
    updateAutoCalcs();
  }

  function saveToLS() {
    try {
      localStorage.setItem(LS_KEY_DADOS, JSON.stringify(dadosEmpresa));
      localStorage.setItem(LS_KEY_STEP, String(currentStep));
    } catch (e) { /* ignore */ }
  }

  function loadFromLS() {
    try {
      var savedDados = localStorage.getItem(LS_KEY_DADOS);
      if (savedDados) dadosEmpresa = JSON.parse(savedDados);
      var savedStep = localStorage.getItem(LS_KEY_STEP);
      if (savedStep !== null) currentStep = parseInt(savedStep) || 0;
    } catch (e) { /* ignore */ }
  }

  function restoreValues() {
    Object.keys(dadosEmpresa).forEach(function (id) {
      var el = $(id);
      if (!el) return;
      var val = dadosEmpresa[id];
      if (el.type === "checkbox") {
        el.checked = val === true || val === "true" || val === "on";
      } else if (el.closest && el.closest(".wz-input-prefix")) {
        el.value = val ? _fmtBRL(val) : "";
      } else {
        el.value = val !== undefined ? val : "";
      }
    });
    // Restaurar radio groups
    Object.keys(dadosEmpresa).forEach(function (id) {
      var radios = document.querySelectorAll('input[name="' + id + '"]');
      if (radios.length > 0) {
        radios.forEach(function (r) {
          r.checked = r.value === String(dadosEmpresa[id]);
        });
      }
    });
  }

  // ═══════════════════════════════════════════════════════════════════════════
  //  BIND CONDITIONALS
  // ═══════════════════════════════════════════════════════════════════════════

  function bindConditionals() {
    $$("[data-condition]").forEach(function (el) {
      var condId = el.getAttribute("data-condition");
      var val = dadosEmpresa[condId];
      var visible = false;

      if (condId === "tipoReorganizacao") {
        visible = val === "cisao_parcial";
      } else if (condId === "receitasExteriorAnual") {
        visible = _n(val) > 0;
      } else {
        visible =
          val === true ||
          val === "true" ||
          val === "on" ||
          (val && val !== "false" && val !== "" && val !== "0" && val !== 0);
      }

      el.style.display = visible ? "" : "none";
    });
  }

  // ═══════════════════════════════════════════════════════════════════════════
  //  CÁLCULOS EM TEMPO REAL — updateAutoCalcs
  // ═══════════════════════════════════════════════════════════════════════════

  function updateAutoCalcs() {
    if (!LR) return;
    var d = dadosEmpresa;

    // ── Soma receitas detalhadas ──
    var calcSomaRec = $("calcSomaReceitas");
    if (calcSomaRec) {
      var soma = _n(d.receitaServicos) + _n(d.receitaComercio) + _n(d.receitaFinanceiras) + _n(d.receitaAlugueis) + _n(d.outrasReceitas);
      calcSomaRec.innerHTML = '<strong>Soma das receitas detalhadas: ' + _m(soma) + '</strong>';
    }

    // ── Soma meses ──
    var calcSomaMeses = $("calcSomaMeses");
    if (calcSomaMeses) {
      var somaMes = 0;
      for (var m = 1; m <= 12; m++) somaMes += _n(d["receitaMes" + m]);
      calcSomaMeses.innerHTML = '<strong>Soma 12 meses: ' + _m(somaMes) + '</strong>';
    }

    // ── Prévia Receitas (etapa 1) ──
    var calcReceitas = $("calcReceitas");
    if (calcReceitas) {
      var rb = _n(d.receitaBrutaAnual);
      var isentas = _n(d.receitasIsentas) + _n(d.receitaExportacao) + _n(d.receitasMonofasicas);
      var tributavel = Math.max(rb - isentas, 0);
      var percPub = _n(d.percentReceitaPublico);
      var irrfEst = percPub > 0 ? _r(rb * (percPub / 100) * 0.048) : 0;
      var csrfEst = percPub > 0 ? _r(rb * (percPub / 100) * 0.0465) : 0;
      calcReceitas.innerHTML =
        '<strong>📊 Prévia de Receita</strong><br>' +
        'Receita Bruta Total: <strong>' + _m(rb) + '</strong><br>' +
        'Receita Tributável PIS/COFINS: <strong>' + _m(tributavel) + '</strong>' +
        (percPub > 0
          ? '<br>Estimativa retenções órgãos públicos: IRRF (4,8%): ' + _m(irrfEst) + ' | CSRF (4,65%): ' + _m(csrfEst)
          : "");
    }

    // ── Total Adições (etapa 2) ──
    var calcTotAd = $("calcTotalAdicoes");
    if (calcTotAd) {
      var totalAd = _calcTotalAdicoes();
      calcTotAd.innerHTML =
        '<strong>TOTAL DE ADIÇÕES: ' + _m(totalAd) + '</strong>' +
        (totalAd > 0 ? '<br>Impacto fiscal das adições: ' + _m(totalAd) + ' × 34% = <strong>' + _m(totalAd * 0.34) + '</strong>' : '');
    }

    // ── PDD Fiscal (etapa 2) ──
    var calcPDD = $("calcPDD");
    if (calcPDD) {
      var totalPDD = _n(d.perdasCreditos6Meses) + _n(d.perdasCreditosJudicial) + _n(d.perdasCreditosFalencia);
      if (totalPDD > 0) {
        var econPDD = _r(totalPDD * 0.34);
        calcPDD.innerHTML =
          '<strong>Total PDD Fiscal (exclusão do lucro real): ' + _m(totalPDD) + '</strong><br>' +
          'Economia potencial (25% IRPJ + 9% CSLL): <span style="color:#2ECC71"><strong>' + _m(econPDD) + '</strong></span>';
      } else {
        calcPDD.innerHTML = "";
      }
    }

    // ── Total Exclusões (etapa 2) ──
    var calcTotEx = $("calcTotalExclusoes");
    if (calcTotEx) {
      var totalEx = _calcTotalExclusoes();
      calcTotEx.innerHTML =
        '<strong>TOTAL DE EXCLUSÕES: ' + _m(totalEx) + '</strong>' +
        (totalEx > 0 ? '<br>Economia das exclusões: ' + _m(totalEx) + ' × 34% = <strong style="color:#2ECC71">' + _m(totalEx * 0.34) + '</strong>' : '');
    }

    // ── Prévia LALUR (etapa 2) ──
    var calcCustos = $("calcCustos");
    if (calcCustos) {
      var rb2 = _n(d.receitaBrutaAnual);
      var custos = _calcTotalCustos();
      var despesas = _calcTotalDespesas();
      var ll = rb2 - custos - despesas;
      var margem = rb2 > 0 ? (ll / rb2 * 100) : 0;
      var adicoes = _calcTotalAdicoes();
      var exclusoes = _calcTotalExclusoes();
      var lucroAjustado = ll + adicoes - exclusoes;
      var alertas = "";
      if (margem > 50 && d.tipoAtividade === "COMERCIO_INDUSTRIA") alertas += '<br><span style="color:#e67e22">⚠️ Margem > 50% para comércio é incomum — confirme</span>';
      if (margem > 80) alertas += '<br><span style="color:#e67e22">⚠️ Margem > 80% é atípica — verifique custos e despesas</span>';
      if (ll > rb2 && rb2 > 0) alertas += '<br><span style="color:#c0392b">⚠️ Lucro > Receita — há inconsistência</span>';
      if (custos === 0 && rb2 > 0) alertas += '<br><span style="color:#e67e22">⚠️ Nenhum custo informado — o estudo pode ficar impreciso</span>';

      calcCustos.innerHTML =
        '<strong>📊 Prévia do LALUR</strong><br>' +
        'Receita Bruta: ' + _m(rb2) + '<br>' +
        '(-) Custos Totais: ' + _m(custos) + '<br>' +
        '(-) Despesas Totais: ' + _m(despesas) + '<br>' +
        '<strong>= LUCRO LÍQUIDO CONTÁBIL: ' + _m(ll) + '</strong><br>' +
        '(+) Total de Adições: ' + _m(adicoes) + '<br>' +
        '(-) Total de Exclusões: ' + _m(exclusoes) + '<br>' +
        '<strong>= LUCRO AJUSTADO: ' + _m(lucroAjustado) + '</strong> <span style="color:#95a5a6;font-size:0.85em">(antes de ajustes automáticos — valor preliminar)</span><br>' +
        '<span style="color:#e67e22;font-size:0.82em;">⚠️ Valor parcial — PIS/COFINS sobre receita e depreciação fiscal serão deduzidos automaticamente nas próximas etapas, reduzindo esta base.</span><br>' +
        'Margem de Lucro: ' + margem.toFixed(1) + '%' +
        alertas;
    }

    // ── PL (etapa 3) ──
    var calcPL = $("calcPL");
    if (calcPL) {
      var pl = _calcPL();
      calcPL.innerHTML = '<strong>= PATRIMÔNIO LÍQUIDO: ' + _m(pl) + '</strong>';
    }

    // ── JCP (etapa 3) ──
    var calcJCP = $("calcJCP");
    if (calcJCP && LR.calcular) {
      var plVal = _calcPL();
      var llVal = _calcLL();
      if (plVal > 0 && llVal > 0) {
        try {
          var jcpRes = LR.calcular.jcp({
            patrimonioLiquido: _n(d.plAjustadoJCP) > 0 ? _n(d.plAjustadoJCP) : plVal,
            capitalSocial: _n(d.capitalSocial) || null,
            reservasCapital: _n(d.reservasCapital),
            reservasLucros: _n(d.reservasLucros),
            lucrosAcumulados: _n(d.lucrosAcumulados) + _n(d.reservasLucros),
            prejuizosAcumulados: _n(d.prejuizosContabeis),
            tjlp: (_n(d.tjlp) || 7.97) / 100,
            lucroLiquidoAntes: llVal,
            numMeses: 12,
          });
          calcJCP.innerHTML =
            '<strong>💰 Simulação de JCP</strong><br>' +
            'JCP máximo (PL × TJLP): ' + _m(jcpRes.jcpMaximoTJLP) + '<br>' +
            'Limite 1 — 50% lucro líquido: ' + _m(jcpRes.limite50LL) + '<br>' +
            'Limite 2 — 50% lucros acum. + reservas: ' + _m(jcpRes.limite50Reservas) + '<br>' +
            '<strong>JCP dedutível: ' + _m(jcpRes.jcpDedutivel) + '</strong><br>' +
            'Economia IRPJ (25%): ' + _m(jcpRes.economiaIRPJ) + '<br>' +
            'Economia CSLL (9%): ' + _m(jcpRes.economiaCSLL) + '<br>' +
            '(-) Custo IRRF (17,5%): ' + _m(jcpRes.custoIRRF) + '<br>' +
            '<span style="color:#2ECC71"><strong>✅ ECONOMIA LÍQUIDA: ' + _m(jcpRes.economiaLiquida) + ' /ano</strong></span>';
        } catch (e) {
          calcJCP.innerHTML = '<em>Erro ao calcular JCP: ' + e.message + '</em>';
        }
      } else {
        calcJCP.innerHTML = '<em>Preencha o Patrimônio Líquido (> 0) e a Receita para simular JCP.</em>';
      }
    }

    // ── Prejuízos (etapa 3) ──
    var calcPrej = $("calcPrejuizos");
    if (calcPrej) {
      var pfIRPJ = _n(d.prejuizoFiscal);
      var bnCSLL = _n(d.baseNegativaCSLL);
      var lucroAj = _calcLucroAjustado();
      if (pfIRPJ > 0 || bnCSLL > 0) {
        var maxComp = Math.max(lucroAj, 0) * 0.30;
        var compIRPJ = Math.min(maxComp, pfIRPJ, Math.max(lucroAj, 0));
        var compCSLL = Math.min(maxComp, bnCSLL, Math.max(lucroAj, 0));
        var economiaIRPJ = _r(_irpj(lucroAj) - _irpj(lucroAj - compIRPJ));
        var economiaCSLL = compCSLL * 0.09;
        var periodosIRPJ = maxComp > 0 ? Math.ceil(pfIRPJ / maxComp) : "∞";
        calcPrej.innerHTML =
          '<strong>📉 Simulação de Compensação de Prejuízos</strong><br>' +
          'Lucro Ajustado (antes comp.): ' + _m(lucroAj) + '<br>' +
          'Trava 30%: ' + _m(maxComp) + '<br>' +
          'Prejuízo fiscal disponível: ' + _m(pfIRPJ) + '<br>' +
          'Compensação efetiva: ' + _m(compIRPJ) + ' | Saldo remanescente: ' + _m(pfIRPJ - compIRPJ) + '<br>' +
          'Economia IRPJ: ' + _m(economiaIRPJ) + ' | Economia CSLL: ' + _m(economiaCSLL) + '<br>' +
          'Períodos para esgotar saldo: ~' + periodosIRPJ + ' anos';
      } else {
        calcPrej.innerHTML = '<em>Nenhum prejuízo fiscal informado.</em>';
      }
    }

    // ── Retenções (etapa 4) ──
    var calcRet = $("calcRetencoes");
    if (calcRet) {
      var totalIRRF = _n(d.irrfRetidoPrivado) + _n(d.irrfRetidoPublico);
      var totalCSRF = _n(d.pisRetido) + _n(d.cofinsRetido) + _n(d.csllRetido);
      var totalISS = _n(d.issRetido);
      var totalRet = totalIRRF + totalCSRF + totalISS;
      calcRet.innerHTML =
        '<strong>Total de Retenções Compensáveis:</strong><br>' +
        'IRRF retido: ' + _m(totalIRRF) + '<br>' +
        'CSRF retido (PIS+COFINS+CSLL): ' + _m(totalCSRF) + '<br>' +
        'ISS retido: ' + _m(totalISS) + '<br>' +
        '<strong>TOTAL RETENÇÕES: ' + _m(totalRet) + '/ano</strong>';
    }

    // ── PIS/COFINS (etapa 4) ──
    var calcPC = $("calcPisCofins");
    if (calcPC && LR.calcular) {
      var rb3 = _n(d.receitaBrutaAnual);
      var recTrib = Math.max(rb3 - _n(d.receitasIsentas) - _n(d.receitaExportacao) - _n(d.receitasMonofasicas), 0);
      var baseCred = _calcBaseCreditos();
      var debPIS = _r(recTrib * 0.0165);
      var debCOF = _r(recTrib * 0.076);
      var credPIS = _r(baseCred * 0.0165);
      var credCOF = _r(baseCred * 0.076);
      var aPagarPIS = Math.max(debPIS - credPIS, 0);
      var aPagarCOF = Math.max(debCOF - credCOF, 0);
      var totalPC = _r(aPagarPIS + aPagarCOF);
      var aliqEfetiva = rb3 > 0 ? (totalPC / rb3 * 100).toFixed(2) : "0.00";
      var aproveitamento = (debPIS + debCOF) > 0 ? ((credPIS + credCOF) / (debPIS + debCOF) * 100).toFixed(1) : "0.0";

      calcPC.innerHTML =
        '<strong>📊 Simulação PIS/COFINS em Tempo Real</strong><br>' +
        'Receita tributável: ' + _m(recTrib) + '<br>' +
        'Débito PIS (1,65%): ' + _m(debPIS) + ' | Débito COFINS (7,6%): ' + _m(debCOF) + '<br>' +
        'Total débitos: ' + _m(debPIS + debCOF) + '<br><br>' +
        'Base de créditos: ' + _m(baseCred) + '<br>' +
        'Crédito PIS (1,65%): ' + _m(credPIS) + ' | Crédito COFINS (7,6%): ' + _m(credCOF) + '<br>' +
        'Total créditos: ' + _m(credPIS + credCOF) + '<br><br>' +
        '<strong>PIS/COFINS a pagar: ' + _m(totalPC) + '</strong><br>' +
        '<strong>ALÍQUOTA EFETIVA: ' + aliqEfetiva + '%</strong> (de 9,25% nominal)<br>' +
        'Aproveitamento de créditos: ' + aproveitamento + '%' +
        (parseFloat(aproveitamento) < 30 && baseCred > 0
          ? '<br><span style="color:#e67e22">⚠️ Aproveitamento baixo — revise se há insumos não classificados que geram crédito</span>'
          : "");
    }

    // ── Depreciação e Incentivos (etapa 5) ──
    var calcDep = $("calcDepreciacao");
    if (calcDep) {
      var turnos = parseInt(d.turnosOperacao) || 1;
      var mult = turnos === 3 ? 2.0 : turnos === 2 ? 1.5 : 1.0;
      var depNormal = _calcDepNormal();
      var depAcelerada = depNormal * mult;
      var depIncentivada = 0;
      var uf = d.uf || "";
      var isSUD = (LR && LR.helpers && (LR.helpers.ehSUDAM(uf) || LR.helpers.ehSUDENE(uf))) ||
                  (LR && LR.sudam && LR.sudam.estados.indexOf(uf) >= 0) ||
                  (LR && LR.sudene && LR.sudene.estados.indexOf(uf) >= 0);
      if (isSUD && _n(d.valorBensNovos) > 0) {
        depIncentivada = _n(d.valorBensNovos);
      }
      var depTotal = depAcelerada + depIncentivada + _n(d.bensSmallValue);

      calcDep.innerHTML =
        '<strong>🏗️ Prévia de Depreciação e Incentivos</strong><br>' +
        'Depreciação Normal: ' + _m(depNormal) + '/ano<br>' +
        (mult > 1 ? 'Depreciação Acelerada (×' + mult + '): ' + _m(depAcelerada) + '/ano<br>' : '') +
        (depIncentivada > 0 ? 'Depreciação Incentivada SUDAM/SUDENE (100%): ' + _m(depIncentivada) + '<br>' : '') +
        (_n(d.bensSmallValue) > 0 ? 'Bens de pequeno valor (despesa direta): ' + _m(_n(d.bensSmallValue)) + '<br>' : '') +
        '<strong>Economia fiscal depreciação: ' + _m(depTotal * 0.34) + ' (×34%)</strong>';
    }

    // ── ISS SUP (etapa 0) ──
    var calcISSSUP = $("calcISSSUP");
    if (calcISSSUP) {
      var ehSUP = d.ehSUP === true || d.ehSUP === "true";
      if (ehSUP) {
        var issFixo = _n(d.issFixoPorProfissional) || 800;
        var numProf = parseInt(d.numProfissionaisSUP) || 2;
        var issFixoTotal = _r(issFixo * numProf);
        var recServISS = _n(d.receitaBrutaAnual) || 0;
        var issPercentual = _r(recServISS * (_n(d.issAliquota) || 5) / 100);
        var econISSSUP = _r(issPercentual - issFixoTotal);
        calcISSSUP.innerHTML =
          '<strong>Comparativo ISS</strong><br>' +
          'ISS por alíquota (' + (_n(d.issAliquota) || 5) + '%): ' + _m(issPercentual) + '/ano<br>' +
          'ISS fixo SUP (' + numProf + ' × ' + _m(issFixo) + '): ' + _m(issFixoTotal) + '/ano<br>' +
          (econISSSUP > 0
            ? '<span style="color:#2ECC71"><strong>Economia com SUP: ' + _m(econISSSUP) + '/ano</strong></span>'
            : '<span style="color:#e67e22">SUP mais caro em ' + _m(Math.abs(econISSSUP)) + ' — não compensa</span>');
      } else {
        calcISSSUP.innerHTML = "";
      }
    }

    // ── CPRB (etapa 4) ──
    var calcCPRB = $("calcCPRB");
    if (calcCPRB) {
      var optouCPRB = d.optouCPRB === true || d.optouCPRB === "true";
      if (optouCPRB) {
        var aliqCPRB = (_n(d.aliquotaCPRB) || 4.5) / 100;
        var baseCPRB = _n(d.receitaBrutaCPRB) || _n(d.receitaBrutaAnual);
        var custoCPRB = _r(baseCPRB * aliqCPRB);
        var folhaBruta = _n(d.folhaPagamentoAnual) || (_n(d.salariosBrutos) + _n(d.proLabore));
        var cppNormal = _r(folhaBruta * 0.20);
        var economiaCPRB = _r(cppNormal - custoCPRB);
        calcCPRB.innerHTML =
          '<strong>Simulação CPRB</strong><br>' +
          'CPP normal (20% sobre folha): ' + _m(cppNormal) + '<br>' +
          'CPRB (' + (_n(d.aliquotaCPRB) || 4.5) + '% sobre receita): ' + _m(custoCPRB) + '<br>' +
          (economiaCPRB > 0
            ? '<span style="color:#2ECC71"><strong>Economia com CPRB: ' + _m(economiaCPRB) + '/ano</strong></span>'
            : '<span style="color:#e67e22">CPRB mais cara que CPP normal em ' + _m(Math.abs(economiaCPRB)) + ' — não compensa</span>');
      } else {
        calcCPRB.innerHTML = "";
      }
    }

    // ── Impacto badges dinâmicos ──
    var impMultas = $("impactoMultas");
    if (impMultas) impMultas.textContent = _m(_n(d.multasPunitivas) * 0.34);
    var econGrat = $("econGratif");
    if (econGrat) econGrat.textContent = _m(_n(d.gratificacoesAdm) * 0.34);
  }

  // ═══════════════════════════════════════════════════════════════════════════
  //  HELPERS DE CÁLCULO INTERMEDIÁRIOS
  // ═══════════════════════════════════════════════════════════════════════════

  function _calcTotalCustos() {
    var d = dadosEmpresa;
    var folha = _n(d.folhaPagamentoAnual) ||
      (_n(d.salariosBrutos) + _n(d.inssPatronal) + _n(d.fgts) + _n(d.decimoTerceiro) + _n(d.feriasProvisao) + _n(d.proLabore));
    return folha + _n(d.cmv) + _n(d.servicosTerceiros) + _n(d.freteComprasVendas) + _n(d.outrosCustosOp);
  }

  function _calcTotalDespesas() {
    var d = dadosEmpresa;
    return _n(d.aluguelAnual) + _n(d.energiaAnual) + _n(d.telecomAnual) +
      _n(d.manutencaoConservacao) + _n(d.segurosAnual) + _n(d.despesasVeiculos) +
      _n(d.honorariosContabeis) + _n(d.marketingPublicidade) + _n(d.despesasViagem) +
      _n(d.materialEscritorio) + _n(d.outrasDespesasOp);
  }

  function _calcTotalAdicoes() {
    var d = dadosEmpresa;
    return _n(d.multasPunitivas) + _n(d.brindes) + _n(d.alimentacaoSocios) +
      _n(d.gratificacoesAdm) + _n(d.doacoesIrregulares) + _n(d.despesasSemNF) +
      _n(d.provisoesIndedutiveis) + _n(d.mepNegativo) + _n(d.depContabilMaiorFiscal) +
      _n(d.outrasAdicoes);
  }

  function _calcTotalExclusoes() {
    var d = dadosEmpresa;
    return _n(d.dividendosRecebidos) + _n(d.mepPositivo) + _n(d.reversaoProvisoes) +
      _n(d.subvencaoInvestimento) + _n(d.depAceleradaIncentivadaExclusao) + _n(d.outrasExclusoes) +
      _n(d.perdasCreditos6Meses) + _n(d.perdasCreditosJudicial) + _n(d.perdasCreditosFalencia);
  }

  function _calcLL() {
    var d = dadosEmpresa;
    var rb = _n(d.receitaBrutaAnual);
    var isentas = _n(d.receitasIsentas) + _n(d.receitaExportacao) + _n(d.receitasMonofasicas);
    var recTrib = Math.max(rb - isentas, 0);
    var pisCofDeb = _r(recTrib * 0.0925);
    var dep = _calcDepNormal();
    var recFin = _n(d.receitaFinanceiras) + _n(d.receitasFinanceirasEspeciais);
    return _r(rb - pisCofDeb - _calcTotalCustos() - _calcTotalDespesas() - dep + recFin);
  }

  function _calcLucroAjustado() {
    return _calcLL() + _calcTotalAdicoes() - _calcTotalExclusoes();
  }

  function _calcPL() {
    var d = dadosEmpresa;
    if (_n(d.patrimonioLiquido) > 0) return _n(d.patrimonioLiquido);
    return _n(d.capitalSocial) + _n(d.reservasCapital) + _n(d.reservasLucros) +
      _n(d.lucrosAcumulados) + _n(d.ajustesAvaliacaoPatrimonial) - _n(d.prejuizosContabeis);
  }

  function _calcDepNormal() {
    var d = dadosEmpresa;
    return _n(d.valorVeiculos) * 0.20 + _n(d.valorMaquinas) * 0.10 +
      _n(d.valorComputadores) * 0.20 + _n(d.valorMoveis) * 0.10 +
      _n(d.valorEdificios) * 0.04 + _n(d.valorDrones) * 0.20 +
      _n(d.valorTratores) * 0.25 + _n(d.valorSoftware) * 0.20 +
      _n(d.valorInstalacoes) * 0.10 + _n(d.valorOutrosBens) * 0.10;
  }

  function _calcBaseCreditos() {
    var d = dadosEmpresa;
    return _n(d.comprasMercadoriasAnual) + _n(d.energiaCredito) + _n(d.alugueisPJCredito) +
      _n(d.leasingCredito) + _n(d.depreciacaoBensCredito) + _n(d.depreciacaoEdifCredito) +
      _n(d.freteVendasAnual) + _n(d.armazenagemCredito) + _n(d.valeTranspAlim) +
      _n(d.manutencaoMaquinas) + _n(d.devolucoesVendas) + _n(d.outrosCreditosPC) +
      _n(d.creditoEstoqueAbertura);
  }

  function _nomeAtividade(tipo) {
    if (!tipo) return "—";
    if (LR && LR.presuncoes && LR.presuncoes[tipo]) return LR.presuncoes[tipo].label;
    return tipo;
  }

  function _nomeApuracao(ap) {
    if (ap === "trimestral") return "Trimestral (definitiva)";
    if (ap === "anual_estimativa") return "Anual por Estimativa";
    if (ap === "anual_suspensao") return "Anual com Suspensão/Redução";
    return "—";
  }

  // ═══════════════════════════════════════════════════════════════════════════
  //  HELPERS DE UI
  // ═══════════════════════════════════════════════════════════════════════════

  function _atualizarBadgeUF(uf) {
    var badge = $("ufBadge");
    if (!badge) return;
    var isSUDAM = false;
    var isSUDENE = false;
    if (LR) {
      if (LR.helpers && LR.helpers.ehSUDAM) isSUDAM = LR.helpers.ehSUDAM(uf);
      else if (LR.sudam) isSUDAM = LR.sudam.estados.indexOf(uf) >= 0;
      if (LR.helpers && LR.helpers.ehSUDENE) isSUDENE = LR.helpers.ehSUDENE(uf);
      else if (LR.sudene) isSUDENE = LR.sudene.estados.indexOf(uf) >= 0;
    }
    if (isSUDAM) {
      badge.innerHTML = '<div class="wz-badge wz-badge-green">✅ Área SUDAM — Amazônia Legal — elegível a incentivos regionais</div>';
    } else if (isSUDENE) {
      badge.innerHTML = '<div class="wz-badge wz-badge-green">✅ Área SUDENE — elegível a incentivos regionais</div>';
    } else {
      badge.innerHTML = "";
    }

    // Alerta obrigatoriedade por atividade
    _verificarAlertaObrigatoriedade();
  }

  function _verificarAlertaObrigatoriedade() {
    var alerta = $("alertaObrigatoriedade");
    if (!alerta) return;
    var d = dadosEmpresa;
    var msgs = [];
    if (d.tipoAtividade === "FACTORING" || d.tipoAtividade === "INSTITUICOES_FINANCEIRAS") {
      msgs.push('⚠️ Lucro Real é OBRIGATÓRIO para esta atividade (Art. 257)');
    }
    if (d.ehFinanceira === true || d.ehFinanceira === "true") {
      msgs.push('⚠️ Instituições financeiras são OBRIGADAS ao Lucro Real');
    }
    alerta.innerHTML = msgs.map(function (m) {
      return '<div class="wz-badge wz-badge-red">' + m + '</div>';
    }).join("");
  }

  function mostrarErro(msg) {
    var container = $("wizardContainer");
    if (container) {
      container.innerHTML =
        '<div class="wz-error"><h2>Erro de Inicialização</h2><p>' + msg + '</p></div>';
    }
  }

  // ═══════════════════════════════════════════════════════════════════════════
  //  NAVEGAÇÃO
  // ═══════════════════════════════════════════════════════════════════════════

  function nextStep() {
    // ═══ FIX: Validação por etapa antes de avançar ═══
    var errosEtapa = _validarEtapa(currentStep);
    if (errosEtapa.length > 0) {
      // Destacar campos com erro visual
      errosEtapa.forEach(function(campo) {
        var el = $(campo);
        if (el) {
          el.style.borderColor = '#e74c3c';
          el.style.boxShadow = '0 0 0 2px rgba(231,76,60,0.3)';
          setTimeout(function() { el.style.borderColor = ''; el.style.boxShadow = ''; }, 4000);
        }
      });
      alert('Preencha os campos obrigatórios desta etapa:\n\n• ' + errosEtapa.join('\n• '));
      return;
    }
    if (currentStep < ETAPAS.length - 1) {
      currentStep++;
      saveToLS();
      renderWizard();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }
  }

  function prevStep() {
    if (currentStep > 0) {
      currentStep--;
      saveToLS();
      renderWizard();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }
  }

  function goToStep(n) {
    if (n >= 0 && n < ETAPAS.length) {
      currentStep = n;
      saveToLS();
      renderWizard();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }
  }

  function voltarWizard() {
    renderWizard();
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  // ═══════════════════════════════════════════════════════════════════════════
  //  MOTOR DE ANÁLISE — analisar() — PLACEHOLDER PARTE 2
  // ═══════════════════════════════════════════════════════════════════════════

  function analisar() {
    var d = dadosEmpresa;

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 0A — Garantir que LR existe (fallback mínimo se mapeamento não carregou)
    // ═══════════════════════════════════════════════════════════════════════
    if (!LR) {
      LR = window.LR || window.LucroRealMap || {};
    }
    if (!LR.calcular) LR.calcular = {};
    if (!LR.validar) LR.validar = {};
    if (!LR.helpers) LR.helpers = {};
    if (!LR.simular) LR.simular = {};

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 0 — Validar campos obrigatórios
    // ═══════════════════════════════════════════════════════════════════════
    var erros = _validarObrigatorios();
    if (erros.length > 0) {
      alert("Campos obrigatórios faltando:\n\n• " + erros.join("\n• "));
      return;
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 1 — Validação cruzada (alertas amarelos, não bloqueiam)
    // ═══════════════════════════════════════════════════════════════════════
    var alertas = _validacaoCruzada();

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 1.5 — Normalização dos dados de entrada (MELHORIA #7 + BUG #5)
    // ═══════════════════════════════════════════════════════════════════════
    // Unificar campos duplicados e normalizar tipos
    d.brindes = _n(d.brindes) + _n(d.despesasBrindes);  // CORRIGIDO: soma ambos campos (antes usava || que ignorava um)
    d.ehFinanceira = d.ehFinanceira === true || d.ehFinanceira === "true";
    d.temProjetoAprovado = d.temProjetoAprovado === true || d.temProjetoAprovado === "true";
    d.apuracaoLR = (d.apuracaoLR || "anual").toLowerCase();

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 2 — Montar DRE (Receita → Lucro Líquido Contábil)
    // ═══════════════════════════════════════════════════════════════════════
    var receitaBruta = _n(d.receitaBrutaAnual);
    var custosTotais = _calcTotalCustos();
    var despesasTotais = _calcTotalDespesas();
    var depAnual = _calcDepNormal();
    var turnos = parseInt(d.turnosOperacao) || 1;
    var multTurnos = turnos === 3 ? 2.0 : turnos === 2 ? 1.5 : 1.0;
    var depAcelerada = _r(depAnual * multTurnos);
    var depNormalDRE = depAnual;
    var diferencaAcelerada = _r(depAcelerada - depAnual);
    var receitaFinanceiras = _n(d.receitaFinanceiras) + _n(d.receitasFinanceirasEspeciais);
    var receitaServicos = _n(d.receitaServicos) || (d.tipoAtividade && d.tipoAtividade.indexOf("SERVICO") >= 0 ? receitaBruta : 0);
    var receitaComercio = _n(d.receitaComercio) || (d.tipoAtividade === "COMERCIO_INDUSTRIA" ? receitaBruta : 0);
    // Se não detalharam, usar a receita toda como do tipo de atividade
    if (!d.detalharReceita && !_n(d.receitaServicos) && !_n(d.receitaComercio)) {
      if (d.tipoAtividade && d.tipoAtividade.indexOf("COMERCIO") >= 0) {
        receitaComercio = receitaBruta;
      } else {
        receitaServicos = receitaBruta;
      }
    }
    // Pré-cálculo PIS/COFINS débitos para DRE (antes do passo 8)
    // Na DRE, deduz-se da Receita Bruta os débitos totais de PIS/COFINS (9,25% da receita tributável)
    var receitasIsentasPreDRE = _n(d.receitasIsentas) + _n(d.receitaExportacao) + _n(d.receitasMonofasicas);
    var receitaTributavelDRE = _r(Math.max(receitaBruta - receitasIsentasPreDRE, 0));
    var pisCofinsDebitosDRE = _r(receitaTributavelDRE * 0.0925); // PIS 1,65% + COFINS 7,60%

    var receitaLiquida = _r(receitaBruta - pisCofinsDebitosDRE);
    var lucroBruto = _r(receitaLiquida - custosTotais);
    var lucroLiquido = _r(lucroBruto - despesasTotais - depNormalDRE + receitaFinanceiras);
    var margemLucro = receitaBruta > 0 ? _r(lucroLiquido / receitaBruta * 100) : 0;
    // CORREÇÃO FALHA #6: Margem precisa (sem arredondamento) para uso em cenários
    var margemLucroPrecisa = receitaBruta > 0 ? (lucroLiquido / receitaBruta) : 0;

    var dre = {
      receitaBruta: receitaBruta,
      receitaServicos: receitaServicos,
      receitaComercio: receitaComercio,
      receitaFinanceiras: receitaFinanceiras,
      receitaAlugueis: _n(d.receitaAlugueis),
      outrasReceitas: _n(d.outrasReceitas),
      pisCofinsDebitos: pisCofinsDebitosDRE,
      receitaLiquida: receitaLiquida,
      custosTotais: custosTotais,
      folhaPagamento: _n(d.folhaPagamentoAnual) || (_n(d.salariosBrutos) + _n(d.proLabore) + _n(d.inssPatronal) + _n(d.fgts) + _n(d.decimoTerceiro) + _n(d.feriasProvisao)),
      cmv: _n(d.cmv),
      servicosTerceiros: _n(d.servicosTerceiros),
      despesasTotais: despesasTotais,
      depreciacao: depNormalDRE,
      lucroBruto: lucroBruto,
      lucroLiquido: lucroLiquido,
      margemLucro: margemLucro,
      margemLucroPrecisa: margemLucroPrecisa
    };

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 3 — Montar LALUR (LL + Adições - Exclusões = Lucro Ajustado)
    // ═══════════════════════════════════════════════════════════════════════
    var totalAdicoes = _calcTotalAdicoes();
    var totalExclusoes = _calcTotalExclusoes();
    var lucroAjustado = _r(lucroLiquido + totalAdicoes - totalExclusoes);

    // Detalhe de adições com artigo
    var adicoesDetalhe = [];
    if (_n(d.multasPunitivas) > 0) adicoesDetalhe.push({ desc: "Multas punitivas", valor: _n(d.multasPunitivas), artigo: "Art. 311, §5º", tipo: "D" });
    if (_n(d.brindes) > 0) adicoesDetalhe.push({ desc: "Brindes", valor: _n(d.brindes), artigo: "Art. 13, Lei 9.249", tipo: "D" });
    if (_n(d.alimentacaoSocios) > 0) adicoesDetalhe.push({ desc: "Alimentação de sócios/adm.", valor: _n(d.alimentacaoSocios), artigo: "Art. 260, §ú, IV", tipo: "D" });
    if (_n(d.gratificacoesAdm) > 0) adicoesDetalhe.push({ desc: "Gratificações a administradores", valor: _n(d.gratificacoesAdm), artigo: "Art. 358, §1º", tipo: "D" });
    if (_n(d.doacoesIrregulares) > 0) adicoesDetalhe.push({ desc: "Doações fora dos limites legais", valor: _n(d.doacoesIrregulares), artigo: "Art. 377-385", tipo: "D" });
    if (_n(d.despesasSemNF) > 0) adicoesDetalhe.push({ desc: "Despesas sem comprovante/NF", valor: _n(d.despesasSemNF), artigo: "Art. 311", tipo: "D" });
    if (_n(d.provisoesIndedutiveis) > 0) adicoesDetalhe.push({ desc: "Provisões não dedutíveis", valor: _n(d.provisoesIndedutiveis), artigo: "Art. 340-352", tipo: "T" });
    if (_n(d.mepNegativo) > 0) adicoesDetalhe.push({ desc: "Resultado negativo MEP", valor: _n(d.mepNegativo), artigo: "Art. 389", tipo: "T" });
    if (_n(d.depContabilMaiorFiscal) > 0) adicoesDetalhe.push({ desc: "Depreciação contábil > fiscal", valor: _n(d.depContabilMaiorFiscal), artigo: "Art. 283-285", tipo: "T" });
    if (_n(d.outrasAdicoes) > 0) adicoesDetalhe.push({ desc: _esc(d.descOutrasAdicoes) || "Outras adições", valor: _n(d.outrasAdicoes), artigo: "—", tipo: "D" });

    var exclusoesDetalhe = [];
    if (_n(d.dividendosRecebidos) > 0) exclusoesDetalhe.push({ desc: "Dividendos recebidos de PJ brasileira", valor: _n(d.dividendosRecebidos), artigo: "Art. 261, II + Lei 9.249, art. 10" });
    if (_n(d.mepPositivo) > 0) exclusoesDetalhe.push({ desc: "Resultado positivo MEP", valor: _n(d.mepPositivo), artigo: "Art. 389" });
    if (_n(d.reversaoProvisoes) > 0) exclusoesDetalhe.push({ desc: "Reversão de provisões antes adicionadas", valor: _n(d.reversaoProvisoes), artigo: "Art. 261, §ú, V" });
    if (_n(d.subvencaoInvestimento) > 0) exclusoesDetalhe.push({ desc: "Subvenção para investimento (⚠ verificar REIS — Lei 14.789/2023)", valor: _n(d.subvencaoInvestimento), artigo: "Lei 14.789/2023 (revogou art. 30, Lei 12.973)" });
    if (_n(d.depAceleradaIncentivadaExclusao) > 0) exclusoesDetalhe.push({ desc: "Depreciação acelerada incentivada", valor: _n(d.depAceleradaIncentivadaExclusao), artigo: "Art. 324-329" });
    if (_n(d.outrasExclusoes) > 0) exclusoesDetalhe.push({ desc: "Outras exclusões", valor: _n(d.outrasExclusoes), artigo: "—" });

    // PDD Fiscal
    var totalPDDAnalise = _n(d.perdasCreditos6Meses) + _n(d.perdasCreditosJudicial) + _n(d.perdasCreditosFalencia);
    if (_n(d.perdasCreditos6Meses) > 0) exclusoesDetalhe.push({ desc: "PDD — Créditos vencidos > 6 meses", valor: _n(d.perdasCreditos6Meses), artigo: "Art. 340, RIR/2018" });
    if (_n(d.perdasCreditosJudicial) > 0) exclusoesDetalhe.push({ desc: "PDD — Créditos em cobrança judicial", valor: _n(d.perdasCreditosJudicial), artigo: "Art. 340, §1º" });
    if (_n(d.perdasCreditosFalencia) > 0) exclusoesDetalhe.push({ desc: "PDD — Créditos c/ devedor em falência/recuperação", valor: _n(d.perdasCreditosFalencia), artigo: "Art. 341" });

    var lalur = {
      lucroLiquido: lucroLiquido,
      adicoes: adicoesDetalhe,
      totalAdicoes: totalAdicoes,
      exclusoes: exclusoesDetalhe,
      totalExclusoes: totalExclusoes,
      lucroAjustado: lucroAjustado,
      // ═══ FIX: Rastreabilidade da compensação de prejuízo no LALUR ═══
      compensacaoPrejuizo: 0,
      compensacaoBaseNegativa: 0,
      lucroAntesCompensacao: lucroAjustado,
      lucroRealFinal: 0 // será atualizado após compensação
    };

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 3A — Validação de Despesas com Limites Legais
    // ═══════════════════════════════════════════════════════════════════════
    var lucroOperacional = lucroLiquido;
    var receitaLiquidaValidacao = receitaBruta;
    var plVal = _calcPL();
    var validacaoDespesasLimites = { doacoes: null, previdencia: null, royalties: null };
    if (LR.calcular.avancado && LR.calcular.avancado.calcularLimiteDoacoes) {
      try {
        validacaoDespesasLimites.doacoes = LR.calcular.avancado.calcularLimiteDoacoes({
          lucroOperacional: lucroOperacional,
          doacoesOperacionais: _n(d.doacoesOperacionais),
          doacoesOSCIP: _n(d.doacoesOSCIP),
          doacoesEntidadesEnsino: _n(d.doacoesEntidadesEnsino)
        });
      } catch(e) { console.warn('[IMPOST] Erro em limiteDoacoes:', e.message); }
    }
    if (LR.calcular.avancado && LR.calcular.avancado.calcularLimitePrevidenciaComplementar) {
      try {
        validacaoDespesasLimites.previdencia = LR.calcular.avancado.calcularLimitePrevidenciaComplementar({
          folhaSalarial: dre.folhaPagamento,
          contribuicaoPatronal: _n(d.previdenciaComplementarPatronal)
        });
      } catch(e) { console.warn('[IMPOST] Erro em limitePrevidencia:', e.message); }
    }
    if (LR.calcular.avancado && LR.calcular.avancado.calcularLimiteRoyaltiesAssistencia) {
      try {
        validacaoDespesasLimites.royalties = LR.calcular.avancado.calcularLimiteRoyaltiesAssistencia({
          receitaLiquida: receitaLiquida,
          royaltiesPagos: _n(d.royaltiesPagos)
        });
      } catch(e) { console.warn('[IMPOST] Erro em limiteRoyalties:', e.message); }
    }

    // Se algum limite foi excedido, somar o EXCESSO como ADIÇÃO ao LALUR
    var excessoDespesasLimites = 0;
    if (validacaoDespesasLimites.doacoes && validacaoDespesasLimites.doacoes.excesso > 0) {
      excessoDespesasLimites += validacaoDespesasLimites.doacoes.excesso;
      adicoesDetalhe.push({ desc: "Excesso de doações acima do limite legal", valor: validacaoDespesasLimites.doacoes.excesso, artigo: "Art. 377-385", tipo: "D" });
    }
    if (validacaoDespesasLimites.previdencia && validacaoDespesasLimites.previdencia.excesso > 0) {
      excessoDespesasLimites += validacaoDespesasLimites.previdencia.excesso;
      adicoesDetalhe.push({ desc: "Excesso de previdência complementar acima do limite", valor: validacaoDespesasLimites.previdencia.excesso, artigo: "Art. 369, §1º", tipo: "D" });
    }
    if (validacaoDespesasLimites.royalties && validacaoDespesasLimites.royalties.excesso > 0) {
      excessoDespesasLimites += validacaoDespesasLimites.royalties.excesso;
      adicoesDetalhe.push({ desc: "Excesso de royalties acima do limite legal", valor: validacaoDespesasLimites.royalties.excesso, artigo: "Art. 365", tipo: "D" });
    }
    if (excessoDespesasLimites > 0) {
      totalAdicoes = _r(totalAdicoes + excessoDespesasLimites);
      lucroAjustado = _r(lucroLiquido + totalAdicoes - totalExclusoes);
      lalur.totalAdicoes = totalAdicoes;
      lalur.lucroAjustado = lucroAjustado;
    }

    // Depreciação acelerada por turnos: diferença é exclusão fiscal no LALUR
    if (diferencaAcelerada > 0) {
      exclusoesDetalhe.push({ desc: "Depreciação acelerada por turnos (exclusão LALUR)", valor: diferencaAcelerada, artigo: "Art. 323", tipo: "T" });
      totalExclusoes = _r(totalExclusoes + diferencaAcelerada);
      lucroAjustado = _r(lucroLiquido + totalAdicoes - totalExclusoes);
      lalur.totalExclusoes = totalExclusoes;
      lalur.lucroAjustado = lucroAjustado;
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 3B — Despesas Indedutíveis Automáticas
    // ═══════════════════════════════════════════════════════════════════════
    var despesasIndedutivelDetalhe = [];
    var totalIndedutivelAuto = 0;
    // CORREÇÃO FALHA #5: Unificar campos d.despesasBrindes e d.brindes (LALUR usa d.brindes, UI usa d.despesasBrindes)
    var valorBrindes = _n(d.despesasBrindes) || _n(d.brindes);
    if (valorBrindes > 0) {
      despesasIndedutivelDetalhe.push({ desc: "Brindes", valor: valorBrindes, artigo: "Art. 13, VII Lei 9.249" });
      // Não somar a totalIndedutivelAuto — já contabilizado em _calcTotalAdicoes() via d.brindes
    }
    if (_n(d.multasPunitivas) > 0) {
      despesasIndedutivelDetalhe.push({ desc: "Multas punitivas", valor: _n(d.multasPunitivas), artigo: "Art. 311, §5º" });
      // Não somar — já incluído em _calcTotalAdicoes()
    }
    // ═══ CORREÇÃO BUG CRÍTICO 4: Deduplicar provisões contingências/garantias ═══
    var _provIndedTotal = _n(d.provisoesIndedutiveis);
    var _provCont = _n(d.provisoesContingencias);
    var _provGar = _n(d.provisoesGarantias);
    if (_provIndedTotal > 0 && (_provCont + _provGar) > 0) {
      if (_provCont + _provGar <= _provIndedTotal) {
        _provCont = 0;
        _provGar = 0;
        console.info('[IMPOST] Provisões contingências/garantias já em provisoesIndedutiveis — deduplicando');
      }
    }
    if (_provCont > 0) {
      despesasIndedutivelDetalhe.push({ desc: "Provisões para contingências", valor: _provCont, artigo: "Art. 340" });
      adicoesDetalhe.push({ desc: "Provisões para contingências (indedutível)", valor: _provCont, artigo: "Art. 340, RIR/2018", tipo: "T" });
      totalIndedutivelAuto += _provCont;
    }
    if (_provGar > 0) {
      despesasIndedutivelDetalhe.push({ desc: "Provisões para garantia de produtos", valor: _provGar, artigo: "Art. 340" });
      adicoesDetalhe.push({ desc: "Provisões para garantia de produtos (indedutível)", valor: _provGar, artigo: "Art. 340, RIR/2018", tipo: "T" });
      totalIndedutivelAuto += _provGar;
    }
    if (_n(d.gratificacoesAdm) > 0) {
      despesasIndedutivelDetalhe.push({ desc: "Gratificações a administradores", valor: _n(d.gratificacoesAdm), artigo: "Art. 358, §1º" });
      // Já contabilizado nas adições existentes, não somar novamente
    }
    if (totalIndedutivelAuto > 0) {
      totalAdicoes = _r(totalAdicoes + totalIndedutivelAuto);
      lucroAjustado = _r(lucroLiquido + totalAdicoes - totalExclusoes);
      lalur.totalAdicoes = totalAdicoes;
      lalur.lucroAjustado = lucroAjustado;
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 4 — Compensação de prejuízos → LR.calcular.compensarIntegrado()
    // ═══════════════════════════════════════════════════════════════════════
    var prejuizoFiscal = _n(d.prejuizoFiscal);
    var baseNegCSLL = _n(d.baseNegativaCSLL);
    var compensacao = null;
    var vedacoes = null;

    // Verificar vedações
    if (LR.validar && LR.validar.vedacoesCompensacao) {
      try {
        vedacoes = LR.validar.vedacoesCompensacao({
          houveMudancaControle: d.temMudancaControle === true || d.temMudancaControle === "true",
          houveMudancaRamo: d.temMudancaRamo === true || d.temMudancaRamo === "true",
          tipoReorganizacao: d.tipoReorganizacao || "",
          percentPLRemanescente: _n(d.percentPLRemanescente)
        });
      } catch (e) { console.warn('[IMPOST] Erro em vedações:', e.message); vedacoes = null; }
    }

    var vedaCompensacao = vedacoes && vedacoes.compensacaoPermitida === false;

    if (LR.calcular.compensarIntegrado && (prejuizoFiscal > 0 || baseNegCSLL > 0) && lucroAjustado > 0 && !vedaCompensacao) {
      try {
        compensacao = LR.calcular.compensarIntegrado({
          lucroLiquido: lucroLiquido,
          adicoes: totalAdicoes,
          exclusoes: totalExclusoes,
          saldoPrejuizoOperacional: prejuizoFiscal,
          saldoPrejuizoNaoOperacional: _n(d.prejuizoNaoOperacional),
          saldoBaseNegativaCSLL: baseNegCSLL,
          lucroNaoOperacional: _n(d.lucroNaoOperacional),
          atividadeRural: d.atividadeRural === true || d.atividadeRural === "true",
          trimestral: d.apuracaoLR === "trimestral"
        });
      } catch (e) {
        console.warn('[IMPOST] Erro em compensação:', e.message);
        compensacao = null;
      }
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 5 — Lucro Real final (Lucro Ajustado - Compensação)
    // ═══════════════════════════════════════════════════════════════════════
    var lucroRealFinal = compensacao
      ? (compensacao.resumo ? compensacao.resumo.lucroRealFinal : Math.max(lucroAjustado, 0))
      : Math.max(lucroAjustado, 0);
    var baseCSLLFinal = compensacao
      ? (compensacao.resumo ? compensacao.resumo.baseCSLLFinal : lucroRealFinal)
      : lucroRealFinal;

    // ═══ FIX: Atualizar LALUR com dados de compensação para rastreabilidade ═══
    lalur.lucroAntesCompensacao = lucroAjustado;
    lalur.lucroRealFinal = lucroRealFinal;
    if (compensacao && compensacao.resumo) {
      lalur.compensacaoPrejuizo = compensacao.resumo.compensacaoIRPJ || compensacao.resumo.prejuizoCompensado || _r(lucroAjustado - lucroRealFinal);
      lalur.compensacaoBaseNegativa = compensacao.resumo.compensacaoCSLL || compensacao.resumo.baseNegativaCompensada || 0;
    } else if (!compensacao && prejuizoFiscal > 0 && lucroAjustado > 0 && !vedaCompensacao) {
      // Fallback: compensação manual (trava de 30%)
      lalur.compensacaoPrejuizo = Math.min(lucroAjustado * 0.30, prejuizoFiscal);
      lalur.lucroRealFinal = _r(lucroAjustado - lalur.compensacaoPrejuizo);
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 6 — IRPJ → LR.calcular.irpj()
    // ═══════════════════════════════════════════════════════════════════════
    var ehFinanceira = d.ehFinanceira === true || d.ehFinanceira === "true" || d.tipoAtividade === "INSTITUICOES_FINANCEIRAS";
    var totalIRRF = _n(d.irrfRetidoPrivado) + _n(d.irrfRetidoPublico);
    var estimIRPJPagas = _n(d.estimativasIRPJPagas);
    var estimCSLLPagas = _n(d.estimativasCSLLPagas);
    var estimPISCOFINSPagas = _n(d.estimativasPISCOFINSPagas);

    // Calcular incentivos primeiro para ter valor de deduções
    var irpjNormalPrevia = _r(lucroRealFinal * 0.15);
    var despesasIncentivos = {};
    if (d.usaPAT === true || d.usaPAT === "true") despesasIncentivos.PAT = _n(d.valorPAT);
    if (d.usaFIA === true || d.usaFIA === "true") despesasIncentivos.FIA = _n(d.valorFIA);
    if (d.usaFundoIdoso === true || d.usaFundoIdoso === "true") despesasIncentivos.FUNDO_IDOSO = _n(d.valorFundoIdoso);
    if (d.usaRouanet === true || d.usaRouanet === "true") despesasIncentivos.ROUANET = _n(d.valorRouanet);
    if (d.usaEsporte === true || d.usaEsporte === "true") despesasIncentivos.ESPORTE = _n(d.valorEsporte);
    if (d.usaPRONON === true || d.usaPRONON === "true") despesasIncentivos.PRONON = _n(d.valorPRONON);
    if (d.usaPRONAS === true || d.usaPRONAS === "true") despesasIncentivos.PRONAS_PCD = _n(d.valorPRONAS);
    if (d.investePD === true || d.investePD === "true") despesasIncentivos.PD_LEI_BEM = _n(d.valorPD);

    var incentivosFiscais = null;
    if (LR.calcular.incentivos) {
      try {
        incentivosFiscais = LR.calcular.incentivos({
          irpjNormal: irpjNormalPrevia,
          despesas: despesasIncentivos
        });
      } catch (e) { console.warn('[IMPOST] Erro em incentivos:', e.message); incentivosFiscais = null; }
    }

    var totalDeducoesIncentivos = (incentivosFiscais && incentivosFiscais.totalDeducaoFinal != null) ? incentivosFiscais.totalDeducaoFinal : 0;

    // SUDAM/SUDENE — Redução do IRPJ
    var uf = d.uf || "";
    var isSUDAM = (LR.helpers && LR.helpers.ehSUDAM) ? LR.helpers.ehSUDAM(uf) : (LR.sudam && LR.sudam.estados.indexOf(uf) >= 0);
    var isSUDENE = (LR.helpers && LR.helpers.ehSUDENE) ? LR.helpers.ehSUDENE(uf) : (LR.sudene && LR.sudene.estados.indexOf(uf) >= 0);
    var temProjetoSUDAM = (isSUDAM || isSUDENE) && (d.temProjetoAprovado === true || d.temProjetoAprovado === "true");

    var sudamResult = null;
    var reducaoSUDAM = 0;
    if (temProjetoSUDAM && LR.simular && LR.simular.incentivosRegionais) {
      try {
        sudamResult = LR.simular.incentivosRegionais({
          lucroLiquido: lucroLiquido,
          receitasFinanceiras: receitaFinanceiras,
          receitaLiquidaTotal: receitaBruta,
          receitaLiquidaIncentivada: receitaBruta - receitaFinanceiras,
          adicoes: totalAdicoes,
          exclusoes: totalExclusoes,
          csllDevida: _r(baseCSLLFinal * (ehFinanceira ? 0.15 : 0.09)),
          percentualReducao: (_n(d.percentualReducao) || 75) / 100,
          usarReinvestimento: d.usarReinvestimento30 === true || d.usarReinvestimento30 === "true",
          superintendencia: isSUDAM ? "SUDAM" : "SUDENE",
          anual: d.apuracaoLR !== "trimestral"
        });
        reducaoSUDAM = _safe(sudamResult, 'resumo', 'economiaReducao75');
      } catch (e) { console.warn('[IMPOST] Erro em SUDAM:', e.message); sudamResult = null; }
    }

    // ═══ CORREÇÃO ERRO CRÍTICO #1: Evitar compensação DUPLA de prejuízo fiscal ═══
    // Se compensarIntegrado já foi executado, passar lucroRealFinal (já compensado) como base
    // e zerar prejuizoFiscal para que o motor IRPJ NÃO recompense.
    // Se compensarIntegrado NÃO rodou, passar os valores originais para o motor compensar.
    var _irpjUsarBaseCompensada = (compensacao !== null);
    var irpjResult = null;
    try {
      if (LR && LR.calcular && LR.calcular.irpj) {
        irpjResult = LR.calcular.irpj({
          lucroLiquido: _irpjUsarBaseCompensada ? lucroRealFinal : lucroLiquido,
          adicoes: _irpjUsarBaseCompensada ? 0 : totalAdicoes,
          exclusoes: _irpjUsarBaseCompensada ? 0 : totalExclusoes,
          prejuizoFiscal: _irpjUsarBaseCompensada ? 0 : (vedaCompensacao ? 0 : prejuizoFiscal),
          numMeses: 12,
          incentivos: totalDeducoesIncentivos,
          retencoesFonte: totalIRRF,
          estimativasPagas: estimIRPJPagas,
          apuracao: d.apuracaoLR === "trimestral" ? "TRIMESTRAL" : "ANUAL"
        });
      }
    } catch (e) {
      console.warn('[IMPOST] Erro em LR.calcular.irpj:', e.message);
      irpjResult = null;
    }
    // Fallback manual se motor não disponível ou falhou
    if (!irpjResult) {
      var _baseIRPJ = Math.max(lucroRealFinal, 0);
      var _irpjN = _r(_baseIRPJ * 0.15);
      var _irpjA = _r(Math.max(_baseIRPJ - 240000, 0) * 0.10);
      var _irpjDev = _r(_irpjN + _irpjA - totalDeducoesIncentivos);
      irpjResult = {
        baseCalculo: _baseIRPJ,
        irpjNormal: _irpjN,
        irpjAdicional: _irpjA,
        incentivos: totalDeducoesIncentivos,
        irpjDevido: Math.max(_irpjDev, 0),
        irpjAPagar: _r(Math.max(_irpjDev, 0) - totalIRRF - estimIRPJPagas),
        aliquota: 0.15,
        aliquotaAdicional: 0.10,
        limiteAdicional: 240000
      };
    }
    // Garantir propriedades mínimas
    irpjResult.irpjDevido = irpjResult.irpjDevido || 0;
    irpjResult.irpjNormal = irpjResult.irpjNormal || 0;
    irpjResult.irpjAdicional = irpjResult.irpjAdicional || 0;

    // ═══ CORREÇÃO BUG CRÍTICO 2: irpjBruto = IRPJ antes de incentivos (cargaBruta verdadeiramente bruta) ═══
    var irpjBruto = _r((irpjResult.irpjNormal || 0) + (irpjResult.irpjAdicional || 0));
    // Aplicar redução SUDAM/SUDENE sobre o IRPJ
    var irpjAntesReducao = irpjResult.irpjDevido;
    var irpjAposReducao = _r(Math.max(irpjAntesReducao - reducaoSUDAM, 0));

    // ═══ CORREÇÃO BUG 1: Na apuração trimestral, usar simulação trimestral (adicional correto) ═══
    var simTrimestral = _simularTrimestral(d, lucroAjustado, prejuizoFiscal, baseNegCSLL, vedaCompensacao, ehFinanceira);
    if (d.apuracaoLR === "trimestral") {
      irpjResult.irpjAdicional = simTrimestral.totalIRPJAdicional;
      irpjResult.irpjNormal = simTrimestral.totalIRPJNormal;
      irpjResult.irpjDevido = _r(irpjResult.irpjNormal + irpjResult.irpjAdicional);
      irpjAntesReducao = irpjResult.irpjDevido;
      irpjAposReducao = _r(Math.max(irpjAntesReducao - reducaoSUDAM, 0));
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 6A — Subcapitalização
    // ═══════════════════════════════════════════════════════════════════════
    var subcapResult = null;
    if (LR.validar && LR.validar.subcapitalizacao && (_n(d.dividaVinculadaComParticipacao) > 0 || _n(d.dividaParaisoFiscal) > 0)) {
      try {
        subcapResult = LR.validar.subcapitalizacao({
          patrimonioLiquido: plVal,
          dividaVinculadaComParticipacao: _n(d.dividaVinculadaComParticipacao),
          participacaoVinculadaNoPL: _n(d.participacaoVinculadaNoPL),
          dividaParaisoFiscal: _n(d.dividaParaisoFiscal),
          jurosIndedutiveis: _n(d.jurosVinculadasExterior)
        });
      } catch(e) { console.warn('[IMPOST] Erro em subcapitalização:', e.message); }
    }
    // Se subcapitalização excedeu, somar IRPJ marginal dos juros indedutíveis
    if (subcapResult && subcapResult.excedeu === true && subcapResult.jurosIndedutiveis > 0) {
      var _baseSubcap = Math.max(lucroRealFinal, 0);
      var _irpjMarginal = _irpj(_baseSubcap + subcapResult.jurosIndedutiveis) - _irpj(_baseSubcap);
      irpjAposReducao = _r(irpjAposReducao + _irpjMarginal);
    }

    // ═══ CORREÇÃO BUG 3: Gravar irpjAPagar corrigido (pós-SUDAM/subcap) no objeto ═══
    irpjResult.irpjAPagar = _r(irpjAposReducao - totalIRRF - estimIRPJPagas);

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 7 — CSLL → LR.calcular.csll()
    // ═══════════════════════════════════════════════════════════════════════
    // ═══ CORREÇÃO ERRO CRÍTICO #2: Evitar compensação DUPLA de base negativa CSLL ═══
    // Se compensarIntegrado já rodou, passar baseCSLLFinal (já compensada) e zerar baseNegativa.
    var _csllUsarBaseCompensada = (compensacao !== null);
    var csllResult = null;
    try {
      if (LR && LR.calcular && LR.calcular.csll) {
        csllResult = LR.calcular.csll({
          lucroLiquido: _csllUsarBaseCompensada ? baseCSLLFinal : lucroLiquido,
          adicoes: _csllUsarBaseCompensada ? 0 : totalAdicoes,
          exclusoes: _csllUsarBaseCompensada ? 0 : totalExclusoes,
          baseNegativa: _csllUsarBaseCompensada ? 0 : (vedaCompensacao ? 0 : baseNegCSLL),
          financeira: ehFinanceira,
          tipoAtividade: d.tipoAtividade || ""
        });
      }
    } catch (e) {
      console.warn('[IMPOST] Erro em LR.calcular.csll:', e.message);
      csllResult = null;
    }
    // Fallback manual se motor não disponível ou falhou
    // ═══ CORREÇÃO ERRO CRÍTICO #3: Usar baseCSLLFinal (não lucroRealFinal) no fallback ═══
    if (!csllResult) {
      var _aliqCSLL = ehFinanceira ? 0.15 : 0.09;
      var _baseCSLL = Math.max(baseCSLLFinal, 0);
      var _compBN = 0;
      if (!_csllUsarBaseCompensada && _baseCSLL > 0 && baseNegCSLL > 0 && !vedaCompensacao) {
        _compBN = Math.min(_r(_baseCSLL * 0.30), baseNegCSLL);
      }
      var _baseCSLLFinal = Math.max(_baseCSLL - _compBN, 0);
      csllResult = {
        baseCalculo: _baseCSLLFinal,
        aliquota: _aliqCSLL,
        compensacao: _compBN,
        csllDevida: _r(_baseCSLLFinal * _aliqCSLL),
        csllAPagar: _r(_baseCSLLFinal * _aliqCSLL - _n(d.csllRetido) - estimCSLLPagas)
      };
    }
    // Garantir propriedades mínimas
    csllResult.csllDevida = csllResult.csllDevida || 0;
    csllResult.aliquota = csllResult.aliquota || (ehFinanceira ? 0.15 : 0.09);
    // ═══ CORREÇÃO BUG CRÍTICO 3: Garantir csllAPagar descontando estimativas ═══
    if (csllResult.csllAPagar === undefined || csllResult.csllAPagar === null) {
      csllResult.csllAPagar = _r(Math.max(
        csllResult.csllDevida - _n(d.csllRetido) - estimCSLLPagas, 0
      ));
    }

    // ═══ CORREÇÃO ERRO CRÍTICO #4: Recalcular SUDAM com csllDevida correta do motor CSLL ═══
    // O SUDAM foi calculado no PASSO 6 com csllDevida manual. Agora que temos csllResult,
    // recalcular se o valor divergiu.
    if (temProjetoSUDAM && LR.simular && LR.simular.incentivosRegionais && csllResult) {
      var _csllManual = _r(baseCSLLFinal * (ehFinanceira ? 0.15 : 0.09));
      if (Math.abs(csllResult.csllDevida - _csllManual) > 0.01) {
        try {
          sudamResult = LR.simular.incentivosRegionais({
            lucroLiquido: lucroLiquido,
            receitasFinanceiras: receitaFinanceiras,
            receitaLiquidaTotal: receitaBruta,
            receitaLiquidaIncentivada: receitaBruta - receitaFinanceiras,
            adicoes: totalAdicoes,
            exclusoes: totalExclusoes,
            csllDevida: csllResult.csllDevida,
            percentualReducao: (_n(d.percentualReducao) || 75) / 100,
            usarReinvestimento: d.usarReinvestimento30 === true || d.usarReinvestimento30 === "true",
            superintendencia: isSUDAM ? "SUDAM" : "SUDENE",
            anual: d.apuracaoLR !== "trimestral"
          });
          reducaoSUDAM = _safe(sudamResult, 'resumo', 'economiaReducao75');
          // Recalcular IRPJ após SUDAM corrigido
          irpjAntesReducao = irpjResult.irpjDevido;
          irpjAposReducao = _r(Math.max(irpjAntesReducao - reducaoSUDAM, 0));
          irpjResult.irpjAPagar = _r(irpjAposReducao - totalIRRF - estimIRPJPagas);
        } catch (e) { console.warn('[IMPOST] Erro ao recalcular SUDAM:', e.message); /* mantém sudamResult anterior */ }
      }
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 7A — Verificação de Omissão de Receita
    // ═══════════════════════════════════════════════════════════════════════
    var omissaoResult = null;
    if (LR.validar && LR.validar.omissaoReceita) {
      try {
        omissaoResult = LR.validar.omissaoReceita({
          receitaBruta: receitaBruta,
          custos: custosTotais,
          despesas: despesasTotais,
          lucroLiquido: lucroLiquido,
          saldoCaixa: _n(d.saldoCaixa),
          depositosBancarios: _n(d.depositosBancarios)
        });
      } catch(e) { console.warn('[IMPOST] Erro em omissãoReceita:', e.message); }
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 8 — PIS/COFINS → LR.calcular.pisCofins()
    // ═══════════════════════════════════════════════════════════════════════
    var receitasIsentas = _n(d.receitasIsentas) + _n(d.receitaExportacao) + _n(d.receitasMonofasicas);
    var baseCreditos = _calcBaseCreditos();

    var pisCofinsResult = null;
    try {
      if (LR && LR.calcular && LR.calcular.pisCofins) {
        pisCofinsResult = LR.calcular.pisCofins({
          receitaBruta: receitaBruta,
          isentas: receitasIsentas,
          exportacao: 0, // já incluída em isentas acima
          comprasBensRevenda: _n(d.comprasMercadoriasAnual),
          energiaEletrica: _n(d.energiaCredito),
          alugueisPJ: _n(d.alugueisPJCredito),
          depreciacaoBens: _n(d.depreciacaoBensCredito) + _n(d.depreciacaoEdifCredito),
          freteArmazenagem: _n(d.freteVendasAnual) + _n(d.armazenagemCredito),
          leasing: _n(d.leasingCredito),
          valeTransporteRefeicao: _n(d.valeTranspAlim),
          devolucoes: _n(d.devolucoesVendas),
          outrosCreditos: _n(d.outrosCreditosPC) + _n(d.manutencaoMaquinas) + _n(d.creditoEstoqueAbertura)
        });
      }
    } catch (e) {
      console.warn('[IMPOST] Erro em LR.calcular.pisCofins:', e.message);
      pisCofinsResult = null;
    }
    // Fallback manual se motor não disponível ou falhou
    if (!pisCofinsResult) {
      var _recTribFB = _r(Math.max(receitaBruta - receitasIsentas, 0));
      var _debPIS = _r(_recTribFB * 0.0165);
      var _debCOF = _r(_recTribFB * 0.076);
      var _credPIS = _r(baseCreditos * 0.0165);
      var _credCOF = _r(baseCreditos * 0.076);
      pisCofinsResult = {
        receitaTributavel: _recTribFB,
        debitoPIS: _debPIS,
        debitoCOFINS: _debCOF,
        creditoPIS: _credPIS,
        creditoCOFINS: _credCOF,
        debitos: { pis: _debPIS, cofins: _debCOF },
        creditos: { pis: _credPIS, cofins: _credCOF },
        pisAPagar: _r(Math.max(_debPIS - _credPIS, 0)),
        cofinsAPagar: _r(Math.max(_debCOF - _credCOF, 0)),
        aPagar: {
          pis: _r(Math.max(_debPIS - _credPIS, 0)),
          cofins: _r(Math.max(_debCOF - _credCOF, 0)),
          total: _r(Math.max(_debPIS - _credPIS, 0) + Math.max(_debCOF - _credCOF, 0))
        }
      };
    }

    // Normalizar propriedades flat para evitar crash no render
    // O motor LR pode retornar debitos/creditos como objetos aninhados ou propriedades planas
    if (!pisCofinsResult.debitos) pisCofinsResult.debitos = { pis: 0, cofins: 0 };
    if (!pisCofinsResult.creditos) pisCofinsResult.creditos = { pis: 0, cofins: 0 };
    if (!pisCofinsResult.aPagar) pisCofinsResult.aPagar = { pis: 0, cofins: 0, total: 0 };

    // Garantir flat props a partir de aninhados (ou vice-versa)
    var _recTrib = pisCofinsResult.receitaTributavel || _r(receitaBruta - receitasIsentas);
    pisCofinsResult.receitaTributavel = _recTrib;
    pisCofinsResult.debitoPIS    = pisCofinsResult.debitoPIS    || pisCofinsResult.debitos.pis    || _r(_recTrib * 0.0165);
    pisCofinsResult.debitoCOFINS = pisCofinsResult.debitoCOFINS || pisCofinsResult.debitos.cofins || _r(_recTrib * 0.076);
    pisCofinsResult.debitos.pis    = pisCofinsResult.debitos.pis    || pisCofinsResult.debitoPIS;
    pisCofinsResult.debitos.cofins = pisCofinsResult.debitos.cofins || pisCofinsResult.debitoCOFINS;

    // Créditos: replicar lógica do simulador da Etapa 5
    var _totalCredBase = baseCreditos;
    pisCofinsResult.creditoPIS    = pisCofinsResult.creditoPIS    || pisCofinsResult.creditos.pis    || _r(_totalCredBase * 0.0165);
    pisCofinsResult.creditoCOFINS = pisCofinsResult.creditoCOFINS || pisCofinsResult.creditos.cofins || _r(_totalCredBase * 0.076);
    pisCofinsResult.creditos.pis    = pisCofinsResult.creditos.pis    || pisCofinsResult.creditoPIS;
    pisCofinsResult.creditos.cofins = pisCofinsResult.creditos.cofins || pisCofinsResult.creditoCOFINS;

    // A pagar líquido (débitos - créditos)
    var _pisAP  = _r(Math.max(pisCofinsResult.debitoPIS - pisCofinsResult.creditoPIS, 0));
    var _cofAP  = _r(Math.max(pisCofinsResult.debitoCOFINS - pisCofinsResult.creditoCOFINS, 0));
    // CORREÇÃO: Forçar sobrescrita com valores corretos (débitos - créditos).
    // O mapeamento pode retornar pisAPagar/cofinsAPagar SEM subtrair créditos
    // quando recebe itens individuais mas espera 'baseCreditos'. A cadeia ||
    // anterior preservava esses valores errados.
    pisCofinsResult.pisAPagar      = _pisAP;
    pisCofinsResult.cofinsAPagar   = _cofAP;
    pisCofinsResult.aPagar.pis     = _pisAP;
    pisCofinsResult.aPagar.cofins  = _cofAP;
    pisCofinsResult.aPagar.total   = _r(_pisAP + _cofAP);
    pisCofinsResult.totalAPagarBruto = _r(_pisAP + _cofAP);
    pisCofinsResult.totalAPagarAntesRetencoes = _r(_pisAP + _cofAP); // alias mantido
    pisCofinsResult.pisCofinsRetido = _r(_n(d.pisRetido) + _n(d.cofinsRetido));
    pisCofinsResult.totalAPagarLiquido = _r(Math.max((_pisAP + _cofAP) - _n(d.pisRetido) - _n(d.cofinsRetido), 0));
    pisCofinsResult.totalAPagar = pisCofinsResult.totalAPagarLiquido; // ← agora é o valor líquido (retrocompatível)

    // Economia com créditos (débitos totais - a pagar = quanto os créditos economizaram)
    var _totalDebitos = _r(pisCofinsResult.debitoPIS + pisCofinsResult.debitoCOFINS);
    pisCofinsResult.economiaCreditos = pisCofinsResult.economiaCreditos || _r(Math.max(_totalDebitos - pisCofinsResult.totalAPagarBruto, 0));
    pisCofinsResult.receitasIsentas  = pisCofinsResult.receitasIsentas || receitasIsentas;
    // CORREÇÃO FALHA #2: aliquotaEfetiva agora é LÍQUIDA (após retenções e créditos).
    // aliquotaEfetivaBruta é BRUTA (débitos sobre receita).
    pisCofinsResult.aliquotaEfetiva = pisCofinsResult.aliquotaEfetiva || (receitaBruta > 0 ? (_r(pisCofinsResult.totalAPagarLiquido / receitaBruta * 100)).toFixed(2) + '%' : '0.00%');
    pisCofinsResult.aliquotaEfetivaBruta = pisCofinsResult.aliquotaEfetivaBruta || (receitaBruta > 0 ? (_r(pisCofinsResult.totalAPagarBruto / receitaBruta * 100)).toFixed(2) + '%' : '0.00%');

    // CORREÇÃO BUG #4: Validar consistência entre totalAPagarBruto e aPagar.total
    if (pisCofinsResult.aPagar && pisCofinsResult.aPagar.total !== undefined) {
      if (Math.abs(pisCofinsResult.totalAPagarBruto - pisCofinsResult.aPagar.total) > 0.02) {
        console.warn('[IMPOST PIS/COFINS] Divergência entre totalAPagarBruto (' + pisCofinsResult.totalAPagarBruto + ') e aPagar.total (' + pisCofinsResult.aPagar.total + '). Usando valor recalculado.');
      }
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 9 — ISS mensal
    // ═══════════════════════════════════════════════════════════════════════
    var issAliquota = _n(d.issAliquota) || 5;
    // ═══ CORREÇÃO BUG MÉDIO 1: Normalizar alíquota decimal → percentual ═══
    if (issAliquota > 0 && issAliquota < 1) {
      issAliquota = _r(issAliquota * 100); // converter 0.05 → 5
    }
    var ehSUP = d.ehSUP === true || d.ehSUP === "true";
    var issAnual, issMensal, issModalidade;
    if (ehSUP) {
      var issFixoProf = _n(d.issFixoPorProfissional) || 800;
      var nProf = parseInt(d.numProfissionaisSUP) || 2;
      issAnual = _r(issFixoProf * nProf);
      issMensal = _r(issAnual / 12);
      issModalidade = "SUP (fixo por profissional)";
    } else {
      issAnual = _r(receitaServicos * issAliquota / 100);
      issMensal = _r(issAnual / 12);
      issModalidade = "Percentual";
    }
    var issResult = {
      receitaServicos: receitaServicos,
      aliquota: ehSUP ? 0 : issAliquota,
      municipio: d.municipio || "—",
      issAnual: issAnual,
      issMensal: issMensal,
      modalidade: issModalidade,
      ehSUP: ehSUP,
      tipoServico: d.tipoServicoISS || "",
      baseLegal: "LC 116/2003"
    };

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 9.1 — CPRB (Desoneração da Folha)
    // ═══════════════════════════════════════════════════════════════════════
    var cprbResult = null;
    var optouCPRB = d.optouCPRB === true || d.optouCPRB === "true";
    if (optouCPRB) {
      var aliqCPRB = (_n(d.aliquotaCPRB) || 4.5) / 100;
      var baseCPRB = _n(d.receitaBrutaCPRB) || receitaBruta;
      var custoCPRB = _r(baseCPRB * aliqCPRB);
      var folhaBrutaCPRB = _n(d.folhaPagamentoAnual) || (_n(d.salariosBrutos) + _n(d.proLabore));
      var cppNormal = _r(folhaBrutaCPRB * 0.20);
      var economiaCPRB = _r(cppNormal - custoCPRB);
      cprbResult = {
        optou: true,
        aliquota: aliqCPRB,
        baseCPRB: baseCPRB,
        custoCPRB: custoCPRB,
        cppNormal: cppNormal,
        economia: Math.max(economiaCPRB, 0),
        compensa: economiaCPRB > 0
      };
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 10 — JCP → LR.calcular.jcp()
    // ═══════════════════════════════════════════════════════════════════════
    // plVal já calculado no PASSO 3A
    // MELHORIA Lei 14.789/2023: usar PL Ajustado quando informado
    var plParaJCP = _n(d.plAjustadoJCP) > 0 ? _n(d.plAjustadoJCP) : plVal;
    var jcpResult = null;
    // ═══ CORREÇÃO ERRO MÉDIO #6: Não usar default silencioso para TJLP ═══
    var _tjlpInformada = _n(d.tjlp);
    var _tjlpUsarDefault = false;
    if (!_tjlpInformada || _tjlpInformada === 0) {
      _tjlpInformada = 7.97; // Taxa Q1/2025 como fallback
      _tjlpUsarDefault = true;
      console.warn('[IMPOST] TJLP default 7.97% (Q1/2025) usada — verificar se atualizada para o exercício vigente');
    }
    if (plParaJCP > 0 && (lucroLiquido > 0 || lucroRealFinal > 0)) {
      try {
        jcpResult = LR.calcular.jcp({
          patrimonioLiquido: plParaJCP,
          capitalSocial: _n(d.capitalSocial) || null,
          reservasCapital: _n(d.reservasCapital),
          reservasLucros: _n(d.reservasLucros),
          lucrosAcumulados: _n(d.lucrosAcumulados) + _n(d.reservasLucros),
          prejuizosAcumulados: _n(d.prejuizosContabeis),
          tjlp: _tjlpInformada / 100,
          lucroLiquidoAntes: lucroLiquido,
          numMeses: 12
        });
        // Marcar no resultado se usou taxa default
        if (jcpResult && _tjlpUsarDefault) {
          jcpResult.tjlpDefault = true;
          jcpResult.tjlpUsada = _tjlpInformada;
          jcpResult.alertaTJLP = "ATENÇÃO: TJLP não informada. Usando taxa default de " + _tjlpInformada + "% (Q1/2025). Verifique a taxa vigente.";
        }
      } catch (e) { console.warn('[IMPOST] Erro em JCP:', e.message); jcpResult = null; }
    }

    // ═══ CORREÇÃO ERRO MÉDIO #5: Recalcular IRPJ e CSLL com dedução do JCP ═══
    // O JCP é dedutível da base do IRPJ e da CSLL. Recalcular com a dedução aplicada.
    // ═══ FIX BUG #1 (CRÍTICO): Manter compensação de prejuízo ativa no cenário COM JCP ═══
    // Antes: compensação era zerada (prejuizoFiscal: 0, baseNegativa: 0) → economia JCP errada.
    // Agora: recalcula a trava de 30% sobre o novo lucro ajustado APÓS dedução do JCP.
    var jcpDedutivel = _safe(jcpResult, 'jcpDedutivel') || _safe(jcpResult, 'valorDedutivel') || 0;
    var irpjComJCP = irpjResult; // referência original (será sobrescrita se JCP > 0)
    var csllComJCP = csllResult;
    if (jcpDedutivel > 0) {
      // ── IRPJ COM JCP: Recalcular compensação sobre lucroAjustado - JCP ──
      var _lucroAjustadoComJCP_IRPJ = Math.max(lucroAjustado - jcpDedutivel, 0);
      // Recalcular trava de 30% sobre novo lucro ajustado
      var _compPrejComJCP = 0;
      if (!vedaCompensacao && prejuizoFiscal > 0 && _lucroAjustadoComJCP_IRPJ > 0) {
        _compPrejComJCP = Math.min(_lucroAjustadoComJCP_IRPJ * 0.30, prejuizoFiscal);
      }
      var _lucroRealComJCP = Math.max(_lucroAjustadoComJCP_IRPJ - _compPrejComJCP, 0);
      try {
        if (LR && LR.calcular && LR.calcular.irpj) {
          irpjComJCP = LR.calcular.irpj({
            lucroLiquido: _lucroRealComJCP,
            adicoes: 0,
            exclusoes: 0,
            prejuizoFiscal: 0, // já compensado manualmente acima
            numMeses: 12,
            incentivos: totalDeducoesIncentivos,
            retencoesFonte: totalIRRF,
            estimativasPagas: estimIRPJPagas,
            apuracao: d.apuracaoLR === "trimestral" ? "TRIMESTRAL" : "ANUAL"
          });
        }
      } catch (e) { console.warn('[IMPOST] Erro em IRPJ com JCP:', e.message); irpjComJCP = irpjResult; }
      if (!irpjComJCP) irpjComJCP = irpjResult;

      // ═══ FIX: Aplicar SUDAM/subcapitalização no irpjComJCP (consistência com irpjResult) ═══
      if (irpjComJCP !== irpjResult) {
        var _irpjComJCPAntesReducao = irpjComJCP.irpjDevido || 0;
        var _irpjComJCPAposReducao = _r(Math.max(_irpjComJCPAntesReducao - reducaoSUDAM, 0));
        // Subcapitalização
        if (subcapResult && subcapResult.excedeu === true && subcapResult.jurosIndedutiveis > 0) {
          var _baseSubcapJCP = Math.max(_lucroRealComJCP, 0);
          var _irpjMarginalJCP = _irpj(_baseSubcapJCP + subcapResult.jurosIndedutiveis) - _irpj(_baseSubcapJCP);
          _irpjComJCPAposReducao = _r(_irpjComJCPAposReducao + _irpjMarginalJCP);
        }
        irpjComJCP.irpjAPagar = _r(_irpjComJCPAposReducao - totalIRRF - estimIRPJPagas);
      }

      // ── CSLL COM JCP: Recalcular compensação de base negativa sobre base - JCP ──
      var _lucroAjustadoComJCP_CSLL = Math.max(lucroAjustado - jcpDedutivel, 0);
      var _compBNComJCP = 0;
      if (!vedaCompensacao && baseNegCSLL > 0 && _lucroAjustadoComJCP_CSLL > 0) {
        _compBNComJCP = Math.min(_lucroAjustadoComJCP_CSLL * 0.30, baseNegCSLL);
      }
      var _baseCSLLComJCP = Math.max(_lucroAjustadoComJCP_CSLL - _compBNComJCP, 0);
      try {
        if (LR && LR.calcular && LR.calcular.csll) {
          csllComJCP = LR.calcular.csll({
            lucroLiquido: _baseCSLLComJCP,
            adicoes: 0,
            exclusoes: 0,
            baseNegativa: 0, // já compensado manualmente acima
            financeira: ehFinanceira,
            tipoAtividade: d.tipoAtividade || ""
          });
        }
      } catch (e) { console.warn('[IMPOST] Erro em CSLL com JCP:', e.message); csllComJCP = csllResult; }
      if (!csllComJCP) csllComJCP = csllResult;

      // Gravar nos resultados para referência
      irpjResult.irpjSemJCP = irpjResult.irpjDevido;
      irpjResult.irpjComJCP = irpjComJCP.irpjDevido || irpjResult.irpjDevido;
      irpjResult.compensacaoPrejComJCP = _compPrejComJCP;
      csllResult.csllSemJCP = csllResult.csllDevida;
      csllResult.csllComJCP = csllComJCP.csllDevida || csllResult.csllDevida;
      csllResult.compensacaoBNComJCP = _compBNComJCP;
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 11 — Incentivos fiscais (já calculados no passo 6)
    // ═══════════════════════════════════════════════════════════════════════
    // incentivosFiscais já foi calculado acima

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 12 — SUDAM/SUDENE (já calculado no passo 6)
    // ═══════════════════════════════════════════════════════════════════════
    // sudamResult já foi calculado acima

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 12A — Lucro da Exploração (para incentivos SUDAM/SUDENE)
    // ═══════════════════════════════════════════════════════════════════════
    var lucroExploracaoResult = null;
    if ((isSUDAM || isSUDENE) && LR.calcular.lucroExploracao) {
      try {
        lucroExploracaoResult = LR.calcular.lucroExploracao({
          lucroLiquido: lucroLiquido,
          receitasFinanceirasLiquidas: receitaFinanceiras,
          resultadoMEP: _n(d.resultadoMEP),
          resultadoNaoOperacional: _n(d.lucroNaoOperacional),
          receitasAnteriores: 0,
          csllDevida: csllResult ? csllResult.csllDevida : 0
        });
      } catch(e) { console.warn('[IMPOST] Erro em lucroExploração:', e.message); }
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 13 — Depreciação → LR.calcular.depreciacaoCompleta()
    // ═══════════════════════════════════════════════════════════════════════
    var depreciacaoResult = { bens: [], total: 0, economiaFiscal: 0 };
    var bensParaCalculo = [];
    var bensConfig = [
      // CORREÇÃO BUG #2: Tipos devem ser EXATAMENTE iguais às chaves de DEPRECIACAO_FISCAL.taxasAnuais no motor
      // Antes: usava maiúsculas (MAQUINAS, COMPUTADORES) e fazia .toLowerCase() — mas isso
      // quebrava "veiculosPassageiro" → "veiculospassageiro" (sem match no motor).
      // Agora: chaves já são as corretas do motor, sem necessidade de conversão.
      { campo: "valorVeiculos", tipo: "veiculosPassageiro", taxa: 0.20 },
      { campo: "valorMaquinas", tipo: "maquinas", taxa: 0.10 },
      { campo: "valorComputadores", tipo: "computadores", taxa: 0.20 },
      { campo: "valorMoveis", tipo: "moveis", taxa: 0.10 },
      { campo: "valorEdificios", tipo: "edificios", taxa: 0.04 },
      { campo: "valorDrones", tipo: "drones", taxa: 0.20 },
      { campo: "valorTratores", tipo: "tratores", taxa: 0.25 },
      { campo: "valorSoftware", tipo: "software", taxa: 0.20 },
      { campo: "valorInstalacoes", tipo: "instalacoes", taxa: 0.10 },
      { campo: "valorOutrosBens", tipo: "outros", taxa: 0.10 } // "outros" não existe no motor — usa fallback manual
    ];
    bensConfig.forEach(function(bc) {
      var valor = _n(d[bc.campo]);
      // CORREÇÃO BUG #2: Tipos já estão nas chaves corretas do motor — não precisa mais de .toLowerCase()
      if (valor > 0) bensParaCalculo.push({ tipo: bc.tipo, custoAquisicao: valor, valor: valor, taxa: bc.taxa });
    });

    // MELHORIA #1: Validação centralizada — verificar se tipos existem no motor
    if (typeof LR !== 'undefined' && LR.DEPRECIACAO_FISCAL && LR.DEPRECIACAO_FISCAL.taxasAnuais) {
      bensParaCalculo.forEach(function(bp) {
        if (!LR.DEPRECIACAO_FISCAL.taxasAnuais[bp.tipo] && bp.tipo !== 'outros') {
          console.warn('[IMPOST DEPRECIACAO] Tipo "' + bp.tipo + '" não existe no motor. Usando fallback com taxa ' + bp.taxa + '.');
        }
      });
    }

    if (LR.calcular.depreciacaoCompleta && bensParaCalculo.length > 0) {
      // CORREÇÃO BUG 3: Iterar cada bem individualmente (motor espera um único bem, não array)
      var depreciacaoDetalhe = [];
      var totalDepNormal = 0;
      var totalDepAcelerada = 0;
      bensParaCalculo.forEach(function (bc) {
        var resultado = null;
        try {
          resultado = LR.calcular.depreciacaoCompleta({
            tipo: bc.tipo,
            custoAquisicao: bc.custoAquisicao,
            turnos: turnos,
            mesesUso: 12
          });
        } catch(e) {
          console.warn('[IMPOST] Erro em depreciaçãoCompleta:', e.message);
          resultado = null;
        }
        // Se motor retornou erro ou falhou, usar fallback manual para este bem
        if (!resultado || resultado.erro) {
          var depN = _r(bc.custoAquisicao * bc.taxa);
          var depA = _r(depN * multTurnos);
          totalDepNormal += depN;
          totalDepAcelerada += depA;
          depreciacaoDetalhe.push({
            tipo: bc.tipo, valorOriginal: bc.custoAquisicao, taxa: bc.taxa,
            depreciaNormal: depN, depreciaAcelerada: depA, turnos: turnos
          });
        } else {
          // Motor retornou resultado válido
          var depNM = resultado.depreciacaoNormal || resultado.depreciacaoPeriodo || _r(bc.custoAquisicao * bc.taxa);
          var depAM = resultado.depreciacaoAcelerada || resultado.depreciacaoIncentivada || _r(depNM * multTurnos);
          totalDepNormal += depNM;
          totalDepAcelerada += depAM;
          depreciacaoDetalhe.push(Object.assign({
            tipo: bc.tipo, valorOriginal: bc.custoAquisicao, taxa: bc.taxa,
            depreciaNormal: depNM, depreciaAcelerada: depAM, turnos: turnos
          }, resultado));
        }
      });
      var depBensNovos = 0;
      if ((isSUDAM || isSUDENE) && _n(d.valorBensNovos) > 0) {
        depBensNovos = _n(d.valorBensNovos);
      }
      var depBensSmall = _n(d.bensSmallValue);
      var depreciacaoTotal = _r(totalDepAcelerada + depBensNovos + depBensSmall);
      depreciacaoResult = {
        bens: depreciacaoDetalhe,
        depreciaNormal: totalDepNormal,
        depreciaAcelerada: totalDepAcelerada,
        depBensNovos: depBensNovos,
        depBensSmall: depBensSmall,
        total: depreciacaoTotal,
        economiaFiscal: _r(depreciacaoTotal * 0.34),
        turnos: turnos,
        multiplicador: multTurnos
      };
    } else if (bensParaCalculo.length > 0) {
      // fallback sem motor disponível
      var depreciacaoDetalhe2 = [];
      var totalDepNormal2 = 0;
      var totalDepAcelerada2 = 0;
      bensParaCalculo.forEach(function (bc) {
        var depN = _r(bc.valor * bc.taxa);
        var depA = _r(depN * multTurnos);
        totalDepNormal2 += depN;
        totalDepAcelerada2 += depA;
        depreciacaoDetalhe2.push({
          tipo: bc.tipo, valorOriginal: bc.valor, taxa: bc.taxa,
          depreciaNormal: depN, depreciaAcelerada: depA, turnos: turnos
        });
      });
      var depBensNovos2 = 0;
      if ((isSUDAM || isSUDENE) && _n(d.valorBensNovos) > 0) {
        depBensNovos2 = _n(d.valorBensNovos);
      }
      var depBensSmall2 = _n(d.bensSmallValue);
      var depreciacaoTotal2 = _r(totalDepAcelerada2 + depBensNovos2 + depBensSmall2);
      depreciacaoResult = {
        bens: depreciacaoDetalhe2,
        depreciaNormal: totalDepNormal2,
        depreciaAcelerada: totalDepAcelerada2,
        depBensNovos: depBensNovos2,
        depBensSmall: depBensSmall2,
        total: depreciacaoTotal2,
        economiaFiscal: _r(depreciacaoTotal2 * 0.34),
        turnos: turnos,
        multiplicador: multTurnos
      };
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 13A — Amortização de Goodwill
    // ═══════════════════════════════════════════════════════════════════════
    var goodwillResult = null;
    if (_n(d.valorGoodwill) > 0 && LR.calcular.avancado && LR.calcular.avancado.calcularAmortizacaoGoodwill) {
      try {
        goodwillResult = LR.calcular.avancado.calcularAmortizacaoGoodwill({
          valorGoodwill: _n(d.valorGoodwill),
          mesesNoAno: 12
        });
      } catch(e) { console.warn('[IMPOST] Erro em goodwill:', e.message); }
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 13B — Exaustão de Recursos Naturais
    // ═══════════════════════════════════════════════════════════════════════
    var exaustaoResult = null;
    if (_n(d.valorRecursosNaturais) > 0 && LR.calcular.avancado && LR.calcular.avancado.calcularExaustao) {
      try {
        exaustaoResult = LR.calcular.avancado.calcularExaustao({
          custoAquisicao: _n(d.valorRecursosNaturais)
        });
      } catch(e) { console.warn('[IMPOST] Erro em exaustão:', e.message); }
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 13C — Despesas Pré-Operacionais
    // ═══════════════════════════════════════════════════════════════════════
    var preOperacionalResult = null;
    if (_n(d.despesasPreOperacionais) > 0 && LR.calcular.avancado && LR.calcular.avancado.calcularDespesasPreOperacionais) {
      try {
        preOperacionalResult = LR.calcular.avancado.calcularDespesasPreOperacionais({
          valorTotal: _n(d.despesasPreOperacionais)
        });
      } catch(e) { console.warn('[IMPOST] Erro em despesasPreOperacionais:', e.message); }
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 14 — Retenções compensáveis → LR.calcular.compensarRetencoes()
    // ═══════════════════════════════════════════════════════════════════════
    var retencoesResult = null;
    var totalCSRF = _n(d.pisRetido) + _n(d.cofinsRetido) + _n(d.csllRetido);
    if (LR.calcular.compensarRetencoes) {
      try {
        retencoesResult = LR.calcular.compensarRetencoes({
          retencoesSofridas: {
            irrf: totalIRRF,
            pis: _n(d.pisRetido),
            cofins: _n(d.cofinsRetido),
            csll: _n(d.csllRetido)
          },
          tributosDevidos: {
            irpj: irpjAposReducao,
            csll: csllResult.csllDevida,
            pis: pisCofinsResult.pisAPagar || pisCofinsResult.aPagar.pis,
            cofins: pisCofinsResult.cofinsAPagar || pisCofinsResult.aPagar.cofins
          }
        });
      } catch (e) { console.warn('[IMPOST] Erro em retenções:', e.message); retencoesResult = null; }
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 15 — Saldo negativo → LR.calcular.saldoNegativo()
    // ═══════════════════════════════════════════════════════════════════════
    var saldoNegResult = null;
    if (LR.calcular.saldoNegativo) {
      try {
        saldoNegResult = LR.calcular.saldoNegativo({
          irpjDevido: irpjAposReducao,
          retencoesFonte: totalIRRF,
          estimativasPagas: estimIRPJPagas
        });
      } catch (e) { console.warn('[IMPOST] Erro em saldoNegativo:', e.message); saldoNegResult = null; }
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 16 — Simulação TRIMESTRAL
    // ═══════════════════════════════════════════════════════════════════════
    // var simTrimestral = _simularTrimestral(...); // Movido para PASSO 6 (BUG 1 fix)

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 17 — Simulação ANUAL POR ESTIMATIVA
    // ═══════════════════════════════════════════════════════════════════════
    var simAnual = _simularAnualEstimativa(d, receitaBruta, lucroRealFinal, ehFinanceira, irpjAntesReducao, csllResult.csllDevida);

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 18 — Suspensão/redução (informativo)
    // ═══════════════════════════════════════════════════════════════════════
    var simSuspensao = _simularSuspensaoReducao(d, receitaBruta, lucroRealFinal, ehFinanceira, irpjAntesReducao, csllResult.csllDevida);

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 19 — Recomendação de melhor forma de apuração
    // ═══════════════════════════════════════════════════════════════════════
    var recomendacao = _recomendarApuracao(simTrimestral, simAnual, simSuspensao, d);

    // Recomendação de regime via motor (complementar)
    var recomendacaoRegime = null;
    if (LR.calcular.recomendarRegime) {
      try {
        recomendacaoRegime = LR.calcular.recomendarRegime({
          lucroAjustado: lucroAjustado,
          prejuizoFiscal: _n(d.prejuizoFiscal),
          prejuizoAcumulado: _n(d.prejuizoFiscal),
          baseNegativaCSLL: _n(d.baseNegativaCSLL),
          receitaBruta: receitaBruta,
          sazonalidade: d.preencherMesAMes === true || d.preencherMesAMes === "true",
          mesesReceita: (function() {
            var arr = [];
            for (var m = 1; m <= 12; m++) arr.push(_n(d["receitaMes" + m]));
            return arr;
          })(),
          lucrosMensais: (function() {
            var arr = [];
            var temMes = d.preencherMesAMes === true || d.preencherMesAMes === "true";
            for (var m = 1; m <= 12; m++) {
              if (temMes && _n(d["receitaMes" + m]) > 0) {
                var fator = _n(d.receitaBrutaAnual) > 0 ? _n(d["receitaMes" + m]) / _n(d.receitaBrutaAnual) : 1/12;
                arr.push(_r(lucroAjustado * fator));
              } else {
                arr.push(_r(lucroAjustado / 12));
              }
            }
            return arr;
          })()
        });
      } catch(e) { console.warn('[IMPOST] Erro em recomendarRegime:', e.message); }
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  PRÉ-CÁLCULO — Totais de economia (necessário para projeção)
    // ═══════════════════════════════════════════════════════════════════════
    var economiaJCP = _safe(jcpResult, 'economiaLiquida');
    var economiaPrejuizo = _safe(compensacao, 'resumo', 'economia', 'total');
    var economiaSUDAM = reducaoSUDAM;
    var economiaIncentivos = _safe(incentivosFiscais, 'economiaTotal');
    var economiaDepreciacao = _safe(depreciacaoResult, 'economiaFiscal');
    var economiaPisCofins = pisCofinsResult.economiaCreditos || 0;
    // ═══ CORREÇÃO BUG CRÍTICO 5: Usar alíquota efetiva (não fixa 34%) ═══
    var _aliqEfetIRPJ = lucroRealFinal > 0
      ? Math.min((irpjResult.irpjDevido || 0) / lucroRealFinal, 0.25)
      : 0.15;
    var _aliqEfetCSLL = csllResult.aliquota || 0.09;
    var economiaGratificacao = _n(d.gratificacoesAdm) > 0
      ? _r(_n(d.gratificacoesAdm) * (_aliqEfetIRPJ + _aliqEfetCSLL))
      : 0;
    var economiaCPRBFinal = cprbResult ? cprbResult.economia : 0;
    // ═══ CORREÇÃO BUG CRÍTICO 1: PDD já reduz IRPJ/CSLL via exclusões LALUR — não contar 2x ═══
    var totalPDDEcon = 0; // Valor zerado para eliminar dupla contagem
    var totalPDDInfo = _r((_n(d.perdasCreditos6Meses) + _n(d.perdasCreditosJudicial) + _n(d.perdasCreditosFalencia)) * (_aliqEfetIRPJ + _aliqEfetCSLL)); // apenas para exibição

    // ═══ CORREÇÃO ERRO BAIXO #8: Separar economias REALIZADAS vs OPORTUNIDADE ═══
    // Economias realizadas: já refletidas nos cálculos efetivos
    var economiasRealizadas = _r(economiaJCP + economiaPrejuizo + economiaSUDAM + economiaIncentivos + economiaDepreciacao + economiaPisCofins + economiaCPRBFinal);
    // Economias de oportunidade: potenciais, dependem de implementação
    var economiasOportunidade = _r(economiaGratificacao + totalPDDEcon);
    // Total inclui ambas para manter compatibilidade
    var totalEconomias = _r(economiasRealizadas + economiasOportunidade);

    // ── CORREÇÃO BUG-02: Garantir que totalEconomias nunca seja 0 quando há economias individuais ──
    // Se totalEconomias resultou em 0 mas há economias individuais calculadas, recalcular diretamente
    if (totalEconomias === 0) {
      var _ecoCheck = [economiaJCP, economiaPrejuizo, economiaSUDAM, economiaIncentivos,
                       economiaDepreciacao, economiaPisCofins, economiaCPRBFinal, totalPDDEcon, economiaGratificacao];
      var _ecoSum = 0;
      for (var _ei = 0; _ei < _ecoCheck.length; _ei++) {
        _ecoSum += (_ecoCheck[_ei] || 0);
      }
      if (_ecoSum > 0) {
        totalEconomias = _r(_ecoSum);
        console.warn('[IMPOST] BUG-02 safety: totalEconomias recalculado de 0 para ' + totalEconomias);
      }
    }

    // CORREÇÃO FALHA #3: Carga bruta 100% bruta (IRPJ + CSLL + PIS/COFINS + ISS, todos ANTES de retenções)
    var pisCofinsLiquido = _r(Math.max(pisCofinsResult.totalAPagarBruto - _n(d.pisRetido) - _n(d.cofinsRetido), 0));
    var pisCofinsParaCargaBruta = pisCofinsResult.totalAPagarBruto || pisCofinsLiquido;
    var cargaBruta = _r(irpjBruto + csllResult.csllDevida + pisCofinsParaCargaBruta + issAnual);
    var cargaOtimizada = _r(Math.max(cargaBruta - totalEconomias, 0));
    var aliquotaEfetiva = receitaBruta > 0 ? _r(cargaBruta / receitaBruta * 100) : 0;
    var aliquotaOtimizada = receitaBruta > 0 ? _r(cargaOtimizada / receitaBruta * 100) : 0;

    // Retenções totais
    var totalRetencoes = totalIRRF + totalCSRF + _n(d.issRetido);

    // ═══ CORREÇÃO ERRO BAIXO #9: saldoEfetivo considera economia do JCP ═══
    // Se JCP for efetivamente pago, a carga real é menor. Calcular cargaBrutaComJCP.
    var cargaBrutaComJCP = cargaBruta;
    if (jcpDedutivel > 0 && irpjComJCP && csllComJCP) {
      var _irpjComJCPDevido = irpjComJCP.irpjDevido || irpjResult.irpjDevido;
      var _csllComJCPDevida = csllComJCP.csllDevida || csllResult.csllDevida;
      cargaBrutaComJCP = _r(_irpjComJCPDevido + _csllComJCPDevida + pisCofinsParaCargaBruta + issAnual);
    }

    // Saldo a pagar efetivo (usa cargaBrutaComJCP para refletir economia do JCP)
    var saldoEfetivo = retencoesResult
      ? (retencoesResult.tributosARecolher ? retencoesResult.tributosARecolher.total : _r(cargaBrutaComJCP - totalRetencoes))
      : _r(cargaBrutaComJCP - totalRetencoes);

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 20 — Cenários (pessimista / base / otimista)
    // ═══════════════════════════════════════════════════════════════════════
    var cenarios = null;
    if (d.gerarCenarios === true || d.gerarCenarios === "true") {
      cenarios = _gerarCenarios(d, dre, lalur, ehFinanceira, prejuizoFiscal, baseNegCSLL, vedaCompensacao);
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 21 — Projeção plurianual
    // ═══════════════════════════════════════════════════════════════════════
    var projecao = null;
    if (d.gerarProjecao === true || d.gerarProjecao === "true") {
      var taxa = (_n(d.taxaCrescimentoAnual) || 10) / 100;
      var horizonte = parseInt(d.horizonteProjecao) || 5;
      if (LR.simular && LR.simular.compensacaoPluranual) {
        try {
          projecao = LR.simular.compensacaoPluranual({
            saldoPrejuizoFiscal: compensacao ? (compensacao.resumo.saldosPosCompensacao.prejuizoOperacional || 0) : prejuizoFiscal,
            saldoBaseNegativaCSLL: compensacao ? (compensacao.resumo.saldosPosCompensacao.baseNegativaCSLL || 0) : baseNegCSLL,
            lucroProjetadoAnual: lucroAjustado,
            anosProjecao: horizonte
          });
        } catch (e) { console.warn('[IMPOST] Erro em projeção:', e.message); projecao = null; }
      }
      // Projeção de carga tributária com crescimento
      // ═══ CORREÇÃO BUG MÉDIO 3: JCP depende do PL, não escala com receita ═══
      var econSemJCP = _r(totalEconomias - economiaJCP);
      var projecaoCarga = [];
      var receitaProj = receitaBruta;
      var econAcum = 0;
      for (var aP = 0; aP < horizonte; aP++) {
        if (aP > 0) receitaProj = _r(receitaProj * (1 + taxa));
        var fator = receitaProj / (receitaBruta || 1);
        var cargaAno = _r((irpjAposReducao + csllResult.csllDevida + pisCofinsLiquido + issAnual) * fator);
        var econAno = _r(econSemJCP * fator + economiaJCP);
        econAcum += econAno;
        projecaoCarga.push({
          ano: aP + 1,
          receita: receitaProj,
          carga: cargaAno,
          economiaAno: econAno,
          economiaAcumulada: _r(econAcum)
        });
      }
      projecao = projecao || {};
      projecao.projecaoCarga = projecaoCarga;
      // ═══ FIX: Compatibilidade — projecao iterável via forEach ═══
      projecao._isProjecao = true;
      projecao.length = projecaoCarga.length;
      projecao.forEach = function(fn) { return projecaoCarga.forEach(fn); };
      projecao.map = function(fn) { return projecaoCarga.map(fn); };
      projecao.toArray = function() { return projecaoCarga; };
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 22 — Fluxo de caixa tributário mensal
    // ═══════════════════════════════════════════════════════════════════════
    var fluxoCaixa = _gerarFluxoCaixaMensal(d, receitaBruta, receitaServicos, issAliquota, irpjAposReducao, csllResult.csllDevida, pisCofinsResult, simTrimestral);

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 22A — Relatório Consolidado (PARTE 5)
    // ═══════════════════════════════════════════════════════════════════════
    var relatorioConsolidado = null;
    if (LR.calcular.avancado && LR.calcular.avancado.gerarRelatorioConsolidado) {
      try {
        relatorioConsolidado = LR.calcular.avancado.gerarRelatorioConsolidado({
          irpj: irpjResult, csll: csllResult, pisCofins: pisCofinsResult,
          jcp: jcpResult, compensacao: compensacao, depreciacao: depreciacaoResult,
          incentivos: incentivosFiscais, retencoes: retencoesResult,
          sudam: sudamResult, saldoNegativo: saldoNegResult
        });
      } catch(e) { console.warn('[IMPOST] Erro em relatórioConsolidado:', e.message); }
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 22B — Árvore de Decisão de Otimização (PARTE 5)
    // ═══════════════════════════════════════════════════════════════════════
    var arvoreDecisao = null;
    if (LR.calcular.avancado && LR.calcular.avancado.arvoreDecisaoOtimizacao) {
      try {
        arvoreDecisao = LR.calcular.avancado.arvoreDecisaoOtimizacao({
          receitaBruta: receitaBruta,
          lucroLiquido: lucroLiquido,
          patrimonioLiquido: plVal,
          folhaPagamento: dre.folhaPagamento,
          uf: uf,
          tipoAtividade: d.tipoAtividade,
          ehFinanceira: ehFinanceira,
          temProjetoSUDAM: temProjetoSUDAM,
          isSUDAM: isSUDAM,
          isSUDENE: isSUDENE
        });
      } catch(e) { console.warn('[IMPOST] Erro em árvoreDecisão:', e.message); }
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 22C — Verificar Elegibilidade de Incentivos Regionais (PARTE 5)
    // ═══════════════════════════════════════════════════════════════════════
    var elegibilidade = null;
    if (LR.calcular.avancado && LR.calcular.avancado.verificarElegibilidade) {
      try {
        elegibilidade = LR.calcular.avancado.verificarElegibilidade({
          uf: uf, cnae: d.cnaePrincipal, receitaBruta: receitaBruta
        });
      } catch(e) { console.warn('[IMPOST] Erro em elegibilidade:', e.message); }
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 22D — Simulação de Retenções Anuais (PARTE 5)
    // ═══════════════════════════════════════════════════════════════════════
    var retencoesAnuais = null;
    if (LR.calcular.avancado && LR.calcular.avancado.simularRetencoesAnuais) {
      try {
        retencoesAnuais = LR.calcular.avancado.simularRetencoesAnuais({
          receitaServicos: receitaServicos,
          recebeDeAdmPublica: d.recebeDeAdmPublica === true || d.recebeDeAdmPublica === "true",
          aliquotaISS: _n(d.issAliquota)
        });
      } catch(e) { console.warn('[IMPOST] Erro em retençõesAnuais:', e.message); }
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 22E — Comparativo Simples vs Lucro Real SUDAM (PARTE 5)
    // ═══════════════════════════════════════════════════════════════════════
    var comparativoSUDAM = null;
    if (isSUDAM && LR.calcular.avancado && LR.calcular.avancado.compararSimplesVsLucroRealSUDAM) {
      try {
        comparativoSUDAM = LR.calcular.avancado.compararSimplesVsLucroRealSUDAM({
          receitaBruta: receitaBruta,
          lucroLiquido: lucroLiquido,
          folhaPagamento: dre.folhaPagamento,
          tipoAtividade: d.tipoAtividade
        });
      } catch(e) { console.warn('[IMPOST] Erro em comparativoSUDAM:', e.message); }
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 22F — Acréscimos Moratórios e Multas (Bloco H)
    //  Arts. 44, 47, 61, 63 — Lei 9.430/1996 + Lei 14.689/2023
    // ═══════════════════════════════════════════════════════════════════════
    var acrescimosMoratoriosResult = null;
    var multaOficioResult = null;
    var prazoEspontaneoResult = null;
    var suspensaoMultaResult = null;

    // Só calcula se o usuário informou dados de atraso/mora
    var temDadosMora = _n(d.valorPrincipalMora) > 0 || d.dataVencimentoMora || d.dataPagamentoMora;
    if (temDadosMora && LR.calcular) {
      try {
        var dadosMora = {
          valorPrincipal: _n(d.valorPrincipalMora) || _r(cargaBruta / 12),
          valorTributo: _n(d.valorPrincipalMora) || _r(cargaBruta / 12),
          dataVencimento: d.dataVencimentoMora || null,
          dataPagamento: d.dataPagamentoMora || null,
          diasAtraso: _n(d.diasAtrasoMora) || 0,
          taxasSelicMes: []
        };
        // Calcular diasAtraso a partir de datas se não fornecido diretamente
        if (!dadosMora.diasAtraso && dadosMora.dataVencimento && dadosMora.dataPagamento) {
          try {
            var _dv = new Date(dadosMora.dataVencimento);
            var _dp = new Date(dadosMora.dataPagamento);
            if (!isNaN(_dv.getTime()) && !isNaN(_dp.getTime())) {
              dadosMora.diasAtraso = Math.max(0, Math.round((_dp - _dv) / 86400000));
            }
          } catch(_e) {}
        }
        if (LR.calcular.acrescimosMoratorios) {
          acrescimosMoratoriosResult = LR.calcular.acrescimosMoratorios(dadosMora);
        }
      } catch(e) { if (typeof console !== 'undefined') console.warn('[Passo 22F] acrescimosMoratorios:', e.message); }
    }

    // Multa de ofício — simulação com base na carga tributária calculada
    // CORREÇÃO FALHA #5: só calcular multa de ofício se houver valor relevante de tributo
    if (LR.calcular && LR.calcular.multaOficio && _r(cargaBruta / 12) > 0) {
      try {
        multaOficioResult = LR.calcular.multaOficio({
          valorDiferenca: _r(cargaBruta / 12),
          valorTributo: _r(cargaBruta / 12),
          tipoInfracao: (d.tipoMultaOficio || 'PADRAO') === 'PADRAO' ? 'normal' : (d.tipoMultaOficio || 'normal').toLowerCase(),
          tipo: d.tipoMultaOficio || 'PADRAO',
          pagamento30Dias: d.pagouMultaEm30Dias === true || d.pagouMultaEm30Dias === "true",
          pagouEm30Dias: d.pagouMultaEm30Dias === true || d.pagouMultaEm30Dias === "true",
          temConformidade: d.temConformidadeLei14689 === true || d.temConformidadeLei14689 === "true",
          temTransacao: d.temTransacaoTributaria === true || d.temTransacaoTributaria === "true"
        });
        // FALHA #5: limpar resultado se multaLiquida é 0 (empresa adimplente)
        if (multaOficioResult && (multaOficioResult.multaLiquida || multaOficioResult.valorFinal || 0) <= 0) {
          multaOficioResult = null;
        }
      } catch(e) { if (typeof console !== 'undefined') console.warn('[Passo 22F] multaOficio:', e.message); }
    }

    // Prazo espontâneo — 20 dias do termo de fiscalização
    if (LR.validar && LR.validar.prazoEspontaneo) {
      try {
        prazoEspontaneoResult = LR.validar.prazoEspontaneo({
          dataTermoFiscalizacao: d.dataTermoFiscalizacao || null
        });
      } catch(e) { if (typeof console !== 'undefined') console.warn('[Passo 22F] prazoEspontaneo:', e.message); }
    }

    // Suspensão de multa de ofício por liminar/tutela
    if (LR.validar && LR.validar.suspensaoMultaOficio) {
      try {
        suspensaoMultaResult = LR.validar.suspensaoMultaOficio({
          temLiminar: d.temLiminarSuspensao === true || d.temLiminarSuspensao === "true",
          temTutela: d.temTutelaSuspensao === true || d.temTutelaSuspensao === "true",
          temDeposito: d.temDepositoJudicial === true || d.temDepositoJudicial === "true"
        });
      } catch(e) { if (typeof console !== 'undefined') console.warn('[Passo 22F] suspensaoMulta:', e.message); }
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 22G — Compensação PER/DCOMP (Bloco I)
    //  Arts. 73, 74, 74-A — CTN + Lei 14.873/2024
    // ═══════════════════════════════════════════════════════════════════════
    var compensacaoPERDCOMPResult = null;
    var compensacaoJudicialResult = null;

    var temCreditoCompensavel = _n(d.creditoCompensavelValor) > 0 || (saldoNegResult && saldoNegResult.saldoNegativo > 0);
    if (temCreditoCompensavel && LR.calcular) {
      var valorCredComp = _n(d.creditoCompensavelValor) || (saldoNegResult ? (saldoNegResult.saldoNegativo || 0) : 0);
      try {
        if (LR.calcular.compensacaoPERDCOMP) {
          compensacaoPERDCOMPResult = LR.calcular.compensacaoPERDCOMP({
            creditoValor: valorCredComp,
            creditoTipo: d.creditoCompensavelTipo || 'PAGAMENTO_INDEVIDO',
            ehEstimativa: d.creditoEhEstimativa === true || d.creditoEhEstimativa === "true",
            creditoPrescrito: d.creditoPrescrito === true || d.creditoPrescrito === "true",
            temTransitoJulgado: d.creditoTemTransito === true || d.creditoTemTransito === "true",
            debitoDestino: d.debitoDestinoCompensacao || 'IRPJ',
            lucroRealFinal: lucroRealFinal,
            cargaBruta: cargaBruta
          });
        }
      } catch(e) { if (typeof console !== 'undefined') console.warn('[Passo 22G] compensacaoPERDCOMP:', e.message); }

      // Simulação judicial — créditos > R$ 10 milhões
      if (valorCredComp > 10000000 && LR.calcular.compensacaoJudicial) {
        try {
          compensacaoJudicialResult = LR.calcular.compensacaoJudicial({
            valorCredito: valorCredComp,
            prazoMeses: 60,
            limiteMinimo: 10000000
          });
        } catch(e) { if (typeof console !== 'undefined') console.warn('[Passo 22G] compensacaoJudicial:', e.message); }
      }
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 23 — Detector de oportunidades
    // ═══════════════════════════════════════════════════════════════════════
    var oportunidades = _detectarOportunidades(d, {
      lucroLiquido: lucroLiquido,
      lucroAjustado: lucroAjustado,
      lucroRealFinal: lucroRealFinal,
      plVal: plVal,
      jcpResult: jcpResult,
      compensacao: compensacao,
      irpjResult: irpjResult,
      irpjNormalPrevia: irpjNormalPrevia,
      irpjAposReducao: irpjAposReducao,
      csllResult: csllResult,
      pisCofinsResult: pisCofinsResult,
      incentivosFiscais: incentivosFiscais,
      sudamResult: sudamResult,
      retencoesResult: retencoesResult,
      saldoNegResult: saldoNegResult,
      depreciacaoResult: depreciacaoResult,
      totalIRRF: totalIRRF,
      totalCSRF: totalCSRF,
      baseCreditos: baseCreditos,
      receitaServicos: receitaServicos,
      isSUDAM: isSUDAM,
      isSUDENE: isSUDENE,
      temProjetoSUDAM: temProjetoSUDAM,
      ehFinanceira: ehFinanceira,
      despesasIncentivos: despesasIncentivos,
      receitaBruta: receitaBruta,
      folhaPagamento: dre.folhaPagamento,
      custosTotais: custosTotais,
      despesasTotais: despesasTotais,
      validacaoDespesasLimites: validacaoDespesasLimites,
      subcapResult: subcapResult,
      omissaoResult: omissaoResult,
      lucroExploracaoResult: lucroExploracaoResult,
      goodwillResult: goodwillResult,
      exaustaoResult: exaustaoResult,
      preOperacionalResult: preOperacionalResult,
      recomendacaoRegime: recomendacaoRegime,
      lucroOperacional: lucroOperacional,
      receitaLiquida: receitaLiquida,
      totalAdicoes: totalAdicoes || 0,   // BUG#4 CORRIGIDO: mapeado do LALUR
      totalExclusoes: totalExclusoes || 0,  // BUG#4 CORRIGIDO: mapeado do LALUR
      // ═══ FIX BUG #5: Passar alíquotas efetivas para cálculo consistente de PDD ═══
      aliqEfetIRPJ: _aliqEfetIRPJ,
      aliqEfetCSLL: _aliqEfetCSLL
    });

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 24 — Compliance e obrigatoriedade
    // ═══════════════════════════════════════════════════════════════════════
    var obrigatoriedade = null;
    if (LR.validar && LR.validar.obrigatoriedade) {
      try {
        obrigatoriedade = LR.validar.obrigatoriedade({
          receitaTotalAnterior: receitaBruta,
          ehInstituicaoFinanceira: ehFinanceira,
          temRendimentosExterior: _n(d.receitasExteriorAnual) > 0,
          tipoAtividade: d.tipoAtividade || ""
        });
      } catch (e) { console.warn('[IMPOST] Erro em obrigatoriedade:', e.message); obrigatoriedade = null; }
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 25 — Obrigações acessórias
    // ═══════════════════════════════════════════════════════════════════════
    var obrigacoes = LR.obrigacoes || [];

    // PASSO 26 — DARFs (CORRIGIDO — enriquecer com periodicidade e prazo)
    var darfs = [];
    var _darfMeta = {
      '0220': { tributo: 'IRPJ', periodicidade: 'Trimestral', prazo: 'Último dia útil do mês subsequente ao trimestre' },
      '2362': { tributo: 'IRPJ', periodicidade: 'Mensal', prazo: 'Último dia útil do mês subsequente' },
      '2430': { tributo: 'IRPJ', periodicidade: 'Anual', prazo: 'Último dia útil de março do ano seguinte' },
      '6012': { tributo: 'CSLL', periodicidade: 'Trimestral', prazo: 'Último dia útil do mês subsequente ao trimestre' },
      '2484': { tributo: 'CSLL', periodicidade: 'Mensal', prazo: 'Último dia útil do mês subsequente' },
      '6773': { tributo: 'CSLL', periodicidade: 'Anual', prazo: 'Último dia útil de março do ano seguinte' },
      '6912': { tributo: 'PIS', periodicidade: 'Mensal', prazo: 'Dia 25 do mês subsequente' },
      '5856': { tributo: 'COFINS', periodicidade: 'Mensal', prazo: 'Dia 25 do mês subsequente' },
      '5706': { tributo: 'IRRF s/ JCP', periodicidade: 'Por evento', prazo: 'Até 3º dia útil após pagamento/crédito' }
    };
    function _enriquecerDarf(df) {
      if (!df) return null;
      var meta = _darfMeta[df.codigo] || {};
      return {
        codigo: df.codigo,
        tributo: df.tributo || df.nome || meta.tributo || df.descricao || '—',
        descricao: df.descricao || '',
        periodicidade: df.periodicidade || meta.periodicidade || '—',
        prazo: df.prazo || df.vencimento || meta.prazo || '—'
      };
    }
    if (LR.darf) {
      if (d.apuracaoLR === "trimestral") {
        darfs.push(_enriquecerDarf(LR.darf.irpjTrimestral));
        darfs.push(_enriquecerDarf(LR.darf.csllTrimestral));
      } else {
        darfs.push(_enriquecerDarf(LR.darf.irpjMensal));
        darfs.push(_enriquecerDarf(LR.darf.csllMensal));
        darfs.push(_enriquecerDarf(LR.darf.irpjAnualAjuste));
        darfs.push(_enriquecerDarf(LR.darf.csllAnualAjuste));
      }
      darfs.push(_enriquecerDarf(LR.darf.pisNaoCumulativo));
      darfs.push(_enriquecerDarf(LR.darf.cofinsNaoCumulativo));
      if (jcpResult && jcpResult.jcpDedutivel > 0) darfs.push(_enriquecerDarf(LR.darf.jcpIrrf));
    }

    // ═══ FIX: Mapear dados do elaborador do formulário para CONFIG ═══
    if (d.nomeElaborador || d.registroProfissional || d.emailContato || d.telefoneContato) {
      CONFIG.elaboradoPor = {
        nome: d.nomeElaborador || CONFIG.elaboradoPor.nome || '',
        registro: d.registroProfissional || CONFIG.elaboradoPor.registro || '',
        email: d.emailContato || CONFIG.elaboradoPor.email || '',
        telefone: d.telefoneContato || CONFIG.elaboradoPor.telefone || ''
      };
    }
    // ═══ FIX: Mapear logoURL do formulário para CONFIG ═══
    if (d.logoURL) {
      CONFIG.logoURL = d.logoURL;
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 27 — Objeto resultados completo
    // ═══════════════════════════════════════════════════════════════════════
    var resultados = {
      versao: VERSAO,
      dataGeracao: new Date().toISOString(),
      config: CONFIG,
      dadosEmpresa: Object.assign({}, d),

      // Seção 2: Painel resumo
      resumo: {
        economiaTotal: totalEconomias,
        numOportunidades: oportunidades.length,
        cargaBruta: cargaBruta,
        cargaBrutaMensal: _r(cargaBruta / 12),
        aliquotaEfetiva: aliquotaEfetiva,
        cargaOtimizada: cargaOtimizada,
        aliquotaOtimizada: aliquotaOtimizada,
        totalRetencoes: totalRetencoes,
        saldoEfetivo: saldoEfetivo,
        issAnual: issAnual,
        desembolsoTotal: _r(saldoEfetivo + issAnual)
      },

      // Seção 3: DRE + LALUR
      dre: dre,
      lalur: lalur,
      lucroRealFinal: lucroRealFinal,
      baseCSLLFinal: baseCSLLFinal,

      // Seção 4: Tributos detalhados
      irpj: irpjResult,
      irpjBruto: irpjBruto,
      irpjAntesReducao: irpjAntesReducao,
      irpjAposReducao: irpjAposReducao,
      reducaoSUDAM: reducaoSUDAM,
      csll: csllResult,
      pisCofins: pisCofinsResult,
      iss: issResult,

      // Seção 5: Composição da carga
      composicao: {
        // CORREÇÃO BUG CRÍTICO 2: cargaBruta usa irpjBruto, composicao.irpj também
        irpj: { valor: irpjBruto, percentual: cargaBruta > 0 ? _r(irpjBruto / cargaBruta * 100) : 0 },
        csll: { valor: csllResult.csllDevida, percentual: cargaBruta > 0 ? _r(csllResult.csllDevida / cargaBruta * 100) : 0 },
        pisCofins: { valor: pisCofinsParaCargaBruta, percentual: cargaBruta > 0 ? _r(pisCofinsParaCargaBruta / cargaBruta * 100) : 0 },  // BUG#1 CORRIGIDO: usa bruto para consistência com IRPJ e CSLL
        iss: { valor: issAnual, percentual: cargaBruta > 0 ? _r(issAnual / cargaBruta * 100) : 0 }
      },

      // Seção 6: Mapa de economia
      economia: {
        jcp: economiaJCP,
        prejuizo: economiaPrejuizo,
        sudam: economiaSUDAM,
        incentivos: economiaIncentivos,
        depreciacao: economiaDepreciacao,
        pisCofinsCreditos: economiaPisCofins,
        gratificacao: economiaGratificacao,
        cprb: economiaCPRBFinal,
        pddFiscal: totalPDDEcon,
        // ═══ FIX BUG #5: pddFiscalInfo = impacto fiscal com alíquotas efetivas (pode diferir de oportunidade que usa mesmas alíquotas agora) ═══
        pddFiscalInfo: totalPDDInfo, // valor informativo: perdas × (alíqEfetIRPJ + alíqEfetCSLL). Já incluso via exclusões LALUR.
        total: totalEconomias,
        // ═══ CORREÇÃO #8: Separar economias realizadas vs oportunidade ═══
        realizadas: economiasRealizadas,
        oportunidade: economiasOportunidade,
        tipoGratificacao: "OPORTUNIDADE",
        tipoPDD: "OPORTUNIDADE"
      },

      // ═══ CORREÇÃO #5/#9: Resultados com JCP deduzido ═══
      jcpDedutivel: jcpDedutivel,
      irpjComJCP: (jcpDedutivel > 0 && irpjComJCP) ? irpjComJCP : null,
      csllComJCP: (jcpDedutivel > 0 && csllComJCP) ? csllComJCP : null,
      cargaBrutaComJCP: cargaBrutaComJCP,

      // Seção 7: Oportunidades
      oportunidades: oportunidades,

      // Seção 8: Trimestral vs Anual
      comparativoApuracao: {
        trimestral: simTrimestral,
        anual: simAnual,
        suspensao: simSuspensao,
        recomendacao: recomendacao
      },

      // Seção 9: Cenários
      cenarios: cenarios,
      projecao: projecao,

      // Seção 10: Fluxo de caixa
      fluxoCaixa: fluxoCaixa,

      // Demais seções
      jcpDetalhado: jcpResult,
      compensacao: compensacao,
      vedacoes: vedacoes,
      depreciacaoDetalhada: depreciacaoResult,
      retencoes: {
        irrf: totalIRRF,
        pis: _n(d.pisRetido),
        cofins: _n(d.cofinsRetido),
        csll: _n(d.csllRetido),
        iss: _n(d.issRetido),
        total: totalRetencoes
      },
      retencoesCompensadas: retencoesResult,
      saldoNegativo: saldoNegResult,
      sudamDetalhado: sudamResult,
      incentivosFiscais: incentivosFiscais,
      cprb: cprbResult,
      obrigatoriedade: obrigatoriedade,
      obrigacoes: obrigacoes,
      darfs: darfs,
      alertas: alertas,

      // Novos resultados — PARTE 2
      validacaoDespesasLimites: validacaoDespesasLimites,
      despesasIndedutivelDetalhe: despesasIndedutivelDetalhe,
      subcapResult: subcapResult,
      omissaoResult: omissaoResult,
      lucroExploracaoResult: lucroExploracaoResult,
      goodwillResult: goodwillResult,
      exaustaoResult: exaustaoResult,
      preOperacionalResult: preOperacionalResult,
      recomendacaoRegime: recomendacaoRegime,

      // Novos resultados — PARTE 5
      relatorioConsolidado: relatorioConsolidado,
      arvoreDecisao: arvoreDecisao,
      elegibilidade: elegibilidade,
      retencoesAnuais: retencoesAnuais,
      comparativoSUDAM: comparativoSUDAM,

      // Novos resultados — BLOCO H (Acréscimos Moratórios)
      acrescimosMoratorios: acrescimosMoratoriosResult,
      multaOficio: multaOficioResult,
      prazoEspontaneo: prazoEspontaneoResult,
      suspensaoMulta: suspensaoMultaResult,

      // Novos resultados — BLOCO I (PER/DCOMP)
      compensacaoPERDCOMP: compensacaoPERDCOMPResult,
      compensacaoJudicial: compensacaoJudicialResult
    };

    // ── CORREÇÃO BUG-02 (parte 2): Revalidar resumo.economiaTotal a partir do objeto economia ──
    // Garante que o KPI "Economia Total Identificada" sempre reflete a soma real dos componentes
    var _ecoObj = resultados.economia;
    var _ecoResum = _r(
      (_ecoObj.jcp || 0) + (_ecoObj.prejuizo || 0) + (_ecoObj.sudam || 0) +
      (_ecoObj.incentivos || 0) + (_ecoObj.depreciacao || 0) + (_ecoObj.pisCofinsCreditos || 0) +
      (_ecoObj.cprb || 0) + (_ecoObj.pddFiscal || 0) + (_ecoObj.gratificacao || 0)
    );
    if (_ecoResum > 0 && (resultados.resumo.economiaTotal || 0) === 0) {
      resultados.resumo.economiaTotal = _ecoResum;
      resultados.economia.total = _ecoResum;
      console.warn('[IMPOST] BUG-02 safety (passo 2): resumo.economiaTotal corrigido para ' + _ecoResum);
    } else if (_ecoResum > 0 && Math.abs(resultados.resumo.economiaTotal - _ecoResum) > 1) {
      // Se divergência > R$1, usar o recalculado (mais confiável)
      resultados.resumo.economiaTotal = _ecoResum;
      resultados.economia.total = _ecoResum;
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 28 — Cache
    // ═══════════════════════════════════════════════════════════════════════
    resultadosCache = resultados;

    // MELHORIA #3: Congelar sub-objetos críticos para detectar mutações posteriores
    // Em strict mode, qualquer tentativa de mutação gerará TypeError (facilita debug)
    if (typeof Object.freeze === 'function') {
      try {
        Object.freeze(resultados.resumo);
        Object.freeze(resultados.composicao);
        Object.freeze(resultados.economia);
      } catch(e) { /* ignora em browsers antigos */ }
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 29 — Salvar localStorage
    // ═══════════════════════════════════════════════════════════════════════
    try {
      localStorage.setItem(LS_KEY_RESULTADOS, JSON.stringify(resultados));
    } catch (e) { /* ignora se exceder quota */ }

    // ═══════════════════════════════════════════════════════════════════════
    //  PASSO 30 — Renderizar resultados
    // ═══════════════════════════════════════════════════════════════════════
    renderResultados(resultados);
  }

  // ═══════════════════════════════════════════════════════════════════════════
  //  VALIDAÇÃO DE CAMPOS OBRIGATÓRIOS
  // ═══════════════════════════════════════════════════════════════════════════

  function _validarObrigatorios() {
    var d = dadosEmpresa;
    var erros = [];
    if (!d.razaoSocial || !d.razaoSocial.trim()) erros.push("Razão Social (Etapa 0)");
    if (!d.uf) erros.push("UF (Etapa 0)");
    if (!d.municipio) erros.push("Município (Etapa 0)");
    if (!d.tipoAtividade) erros.push("Tipo de Atividade (Etapa 0)");
    if (!d.apuracaoLR) erros.push("Forma de Apuração (Etapa 0)");
    var rb = _n(d.receitaBrutaAnual);
    // Tentar somar meses se preencheu mês a mês
    if (rb <= 0 && (d.preencherMesAMes === true || d.preencherMesAMes === "true")) {
      var somaMes = 0;
      for (var m = 1; m <= 12; m++) somaMes += _n(d["receitaMes" + m]);
      if (somaMes > 0) rb = somaMes;
    }
    if (rb <= 0) erros.push("Receita Bruta Anual (Etapa 1)");
    // Pelo menos um campo de custo/despesa
    if (_calcTotalCustos() + _calcTotalDespesas() <= 0) {
      erros.push("Pelo menos um campo de custo ou despesa (Etapa 2)");
    }
    return erros;
  }

  function _validarEtapa(step) {
    var d = dadosEmpresa;
    var erros = [];
    switch(step) {
      case 0: // Empresa
        if (!d.razaoSocial || !d.razaoSocial.trim()) erros.push('razaoSocial');
        if (!d.uf) erros.push('uf');
        if (!d.tipoAtividade) erros.push('tipoAtividade');
        break;
      case 1: // Receitas
        var rb = _n(d.receitaBrutaAnual);
        if (d.preencherMesAMes === true || d.preencherMesAMes === 'true') {
          var soma = 0;
          for (var m = 1; m <= 12; m++) soma += _n(d['receitaMes' + m]);
          if (soma <= 0 && rb <= 0) erros.push('receitaBrutaAnual');
        } else if (rb <= 0) {
          erros.push('receitaBrutaAnual');
        }
        break;
      case 2: // Custos
        if (_calcTotalCustos() + _calcTotalDespesas() <= 0) erros.push('folhaPagamentoAnual');
        break;
      // Etapas 3-6: não obrigatórias (patrimônio, retenções, ativos, revisão)
    }
    return erros;
  }

  // ═══════════════════════════════════════════════════════════════════════════
  //  VALIDAÇÃO CRUZADA (alertas amarelos)
  // ═══════════════════════════════════════════════════════════════════════════

  function _validacaoCruzada() {
    var d = dadosEmpresa;
    var alertas = [];
    var rb = _n(d.receitaBrutaAnual);
    var ll = _calcLL();
    var margem = rb > 0 ? (ll / rb * 100) : 0;
    var custoTotal = _calcTotalCustos() + _calcTotalDespesas();
    var numFunc = parseInt(d.numFuncionarios) || 0;
    var folha = _n(d.folhaPagamentoAnual);
    var plVal = _calcPL();
    var totalRet = _n(d.irrfRetidoPrivado) + _n(d.irrfRetidoPublico) + _n(d.pisRetido) + _n(d.cofinsRetido) + _n(d.csllRetido);
    var issAliq = _n(d.issAliquota);
    var pf = _n(d.prejuizoFiscal);

    if (ll > rb && rb > 0) {
      alertas.push({ tipo: "aviso", msg: "Lucro informado é MAIOR que a receita — verifique os dados" });
    }
    if (ll < 0 && pf === 0) {
      alertas.push({ tipo: "aviso", msg: "Prejuízo contábil mas sem prejuízo fiscal informado — confirme" });
    }
    if (margem > 50 && d.tipoAtividade === "COMERCIO_INDUSTRIA") {
      alertas.push({ tipo: "aviso", msg: "Margem > 50% para comércio é incomum — confirme" });
    }
    if (margem > 80) {
      alertas.push({ tipo: "aviso", msg: "Margem > 80% é atípica — verifique custos e despesas" });
    }
    if (custoTotal === 0 && rb > 0) {
      alertas.push({ tipo: "aviso", msg: "Nenhum custo informado — o estudo pode ficar impreciso" });
    }
    if (folha === 0 && numFunc > 0) {
      alertas.push({ tipo: "aviso", msg: "Tem " + numFunc + " funcionários mas folha de pagamento = R$ 0" });
    }
    if (plVal > 0 && ll > 0 && !(_n(d.tjlp) > 0)) {
      alertas.push({ tipo: "economia", msg: "Há economia de JCP não aproveitada — informe a TJLP" });
    }
    if (totalRet > 0) {
      // IRPJ+CSLL estimados para comparação (IRPJ marginal correto)
      var _laEst = Math.max(_calcLucroAjustado(), 0);
      var irpjEst = _irpj(_laEst);
      var csllEst = _r(_laEst * 0.09);
      if (totalRet > irpjEst + csllEst && irpjEst + csllEst > 0) {
        alertas.push({ tipo: "info", msg: "Retenções excedem imposto estimado — pode gerar saldo negativo (PER/DCOMP)" });
      }
    }
    if ((d.atividadeMista === true || d.atividadeMista === "true") && !_n(d.percentReceitaSecundaria)) {
      alertas.push({ tipo: "aviso", msg: "Atividade mista selecionada mas sem % de receita secundária" });
    }
    if (window.MunicipiosIBGE && issAliq > 0) {
      if (issAliq < (window.MunicipiosIBGE.ISS_MIN || 2) || issAliq > (window.MunicipiosIBGE.ISS_MAX || 5)) {
        alertas.push({ tipo: "aviso", msg: "Alíquota ISS (" + issAliq + "%) fora dos limites legais (2% a 5%)" });
      }
    }

    // ═══ PARTE 5D — Validações cruzadas aprimoradas ═══
    if ((d.ehInstituicaoFinanceira === true || d.ehInstituicaoFinanceira === "true") && d.tipoAtividade !== "INSTITUICOES_FINANCEIRAS") {
      alertas.push({ tipo: "aviso", msg: "Instituição financeira marcada — CSLL deve ser 15% (não 9%). Verifique se alíquota está correta." });
    }
    if ((d.atividadeRural === true || d.atividadeRural === "true") && pf > 0) {
      alertas.push({ tipo: "info", msg: "Atividade rural com prejuízo fiscal — compensação é integral (sem trava de 30%). Art. 583 RIR/2018." });
    }
    if (d.tipoReorganizacao && d.tipoReorganizacao !== "NENHUMA" && pf > 0) {
      alertas.push({ tipo: "aviso", msg: "Reorganização societária (" + d.tipoReorganizacao + ") com prejuízo fiscal — compensação pode ser vedada (Art. 584-585 RIR/2018)." });
    }
    if (d.ehSCP === true || d.ehSCP === "true") {
      alertas.push({ tipo: "aviso", msg: "Sociedade em Conta de Participação (SCP) — prejuízo de SCP não compensa com ostensivo e vice-versa (Art. 586 RIR/2018)." });
    }
    if ((_n(d.doacoesOperacionais) + _n(d.doacoesOSCIP)) > 0 && ll <= 0) {
      alertas.push({ tipo: "aviso", msg: "Doações informadas mas exercício com prejuízo operacional — doações não são dedutíveis quando não há lucro operacional." });
    }
    if (rb > 78000000) {
      alertas.push({ tipo: "info", msg: "Receita bruta > R$ 78 milhões — empresa OBRIGATORIAMENTE no Lucro Real (Art. 257, I do RIR/2018)." });
    }
    if (d.regimeCambial === "COMPETENCIA" && _n(d.receitasExteriorAnual) === 0) {
      alertas.push({ tipo: "aviso", msg: "Regime cambial por competência selecionado mas sem operações em moeda estrangeira declaradas. Verifique se a opção é necessária." });
    }

    return alertas;
  }

  // ═══════════════════════════════════════════════════════════════════════════
  //  DETECTOR DE 22 OPORTUNIDADES
  // ═══════════════════════════════════════════════════════════════════════════

  function _detectarOportunidades(d, ctx) {
    var ops = [];

    // #1 — JCP
    if (ctx.plVal > 0 && ctx.lucroLiquido > 0 && ctx.jcpResult && ctx.jcpResult.economiaLiquida > 0) {
      ops.push({
        id: "JCP", titulo: "Juros sobre Capital Próprio",
        tipo: "Dedução", complexidade: "Baixa", risco: "Baixo",
        economiaAnual: ctx.jcpResult.economiaLiquida,
        descricao: "JCP dedutível de " + _m(ctx.jcpResult.jcpDedutivel) + " gera economia líquida de " + _m(ctx.jcpResult.economiaLiquida) + "/ano (34% de economia - 17,5% IRRF — LC 224/2025).",
        baseLegal: "Art. 355-358 do RIR/2018",
        acaoRecomendada: "Deliberar distribuição de JCP aos sócios. Formalizar via ata e pagar IRRF (DARF 5706).",
        prazoImplementacao: "Imediato",
        detalhes: ctx.jcpResult
      });
    }

    // #2 — Prejuízo Fiscal
    if (_n(d.prejuizoFiscal) > 0 && ctx.lucroAjustado > 0 && ctx.compensacao) {
      // CORREÇÃO FALHA #4: incluir economia IRPJ + CSLL quando não há card #3 separado.
      // Se há base negativa CSLL separada, card #2 fica apenas IRPJ para evitar duplicação.
      var _temBaseNeg = _n(d.baseNegativaCSLL) > 0;
      var econPrej;
      if (_temBaseNeg) {
        // Cards separados: #2 = IRPJ, #3 = CSLL
        econPrej = ctx.compensacao.resumo ? _n(ctx.compensacao.resumo.economia.irpj) : 0;
      } else {
        // Sem card #3: incluir tudo em #2
        econPrej = ctx.compensacao.resumo ? (ctx.compensacao.resumo.economia.total || (_n(ctx.compensacao.resumo.economia.irpj) + _n(ctx.compensacao.resumo.economia.csll))) : 0;
      }
      if (econPrej > 0) {
        var _descrPrej = _temBaseNeg
          ? "Prejuízo fiscal acumulado de " + _m(_n(d.prejuizoFiscal)) + " permite compensar até 30% do lucro ajustado, economizando " + _m(econPrej) + " em IRPJ."
          : "Prejuízo fiscal acumulado de " + _m(_n(d.prejuizoFiscal)) + " permite compensar até 30% do lucro ajustado, economizando " + _m(econPrej) + " em IRPJ+CSLL.";
        ops.push({
          id: "PREJUIZO_FISCAL", titulo: "Compensação de Prejuízo Fiscal",
          tipo: "Compensação", complexidade: "Baixa", risco: "Baixo",
          economiaAnual: econPrej,
          descricao: _descrPrej,
          baseLegal: "Art. 579-586 do RIR/2018",
          acaoRecomendada: "Manter controle na Parte B do LALUR/LACS. Verificar vedações de compensação.",
          prazoImplementacao: "Imediato",
          detalhes: ctx.compensacao.resumo
        });
      }
    }

    // #3 — Base Negativa CSLL
    if (_n(d.baseNegativaCSLL) > 0 && ctx.lucroAjustado > 0 && ctx.compensacao) {
      var econCSLL = ctx.compensacao.resumo ? ctx.compensacao.resumo.economia.csll : 0;
      if (econCSLL > 0) {
        ops.push({
          id: "BASE_NEGATIVA_CSLL", titulo: "Compensação de Base Negativa CSLL",
          tipo: "Compensação", complexidade: "Baixa", risco: "Baixo",
          economiaAnual: econCSLL,
          descricao: "Base negativa de " + _m(_n(d.baseNegativaCSLL)) + " permite compensar até 30% da base de CSLL, economizando " + _m(econCSLL) + ".",
          baseLegal: "Art. 580-586 do RIR/2018",
          acaoRecomendada: "Manter controle no LACS. Verificar vedações.",
          prazoImplementacao: "Imediato",
          detalhes: {}
        });
      }
    }

    // #4 — SUDAM 75% (com projeto)
    if (ctx.isSUDAM && ctx.temProjetoSUDAM && ctx.sudamResult && ctx.sudamResult.resumo) {
      var econSudam = ctx.sudamResult.resumo.economiaReducao75 || 0;
      if (econSudam > 0) {
        ops.push({
          id: "SUDAM_75", titulo: "Redução 75% IRPJ — SUDAM",
          tipo: "Redução", complexidade: "Média", risco: "Baixo",
          economiaAnual: econSudam,
          descricao: "Projeto SUDAM aprovado permite reduzir 75% do IRPJ sobre o lucro da exploração, economizando " + _m(econSudam) + "/ano.",
          baseLegal: "Art. 627-637 do RIR/2018",
          acaoRecomendada: "Manter laudo constitutivo e reconhecimento da SRF atualizados.",
          prazoImplementacao: "Imediato",
          detalhes: ctx.sudamResult.resumo
        });
      }
    }

    // #5 — SUDENE 75% (com projeto)
    if (ctx.isSUDENE && ctx.temProjetoSUDAM && ctx.sudamResult && ctx.sudamResult.resumo) {
      var econSudene = ctx.sudamResult.resumo.economiaReducao75 || 0;
      if (econSudene > 0) {
        ops.push({
          id: "SUDENE_75", titulo: "Redução 75% IRPJ — SUDENE",
          tipo: "Redução", complexidade: "Média", risco: "Baixo",
          economiaAnual: econSudene,
          descricao: "Projeto SUDENE aprovado permite reduzir 75% do IRPJ sobre o lucro da exploração, economizando " + _m(econSudene) + "/ano.",
          baseLegal: "Art. 627-637 do RIR/2018",
          acaoRecomendada: "Manter laudo constitutivo e reconhecimento da SRF atualizados.",
          prazoImplementacao: "Imediato",
          detalhes: ctx.sudamResult.resumo
        });
      }
    }

    // #6 — SUDAM/SUDENE potencial (sem projeto)
    if ((ctx.isSUDAM || ctx.isSUDENE) && !ctx.temProjetoSUDAM && ctx.lucroRealFinal > 0) {
      var nomeSup = ctx.isSUDAM ? "SUDAM" : "SUDENE";
      var econPotencial = _r(ctx.irpjNormalPrevia * 0.75);
      if (econPotencial > 500) {
        ops.push({
          id: ctx.isSUDAM ? "SUDAM_POTENCIAL" : "SUDENE_POTENCIAL",
          titulo: "Potencial: Projeto " + nomeSup + " (sem projeto aprovado)",
          tipo: "Potencial", complexidade: "Alta", risco: "Médio",
          economiaAnual: econPotencial,
          descricao: "A empresa está em área " + nomeSup + " mas NÃO tem projeto aprovado. Economia potencial de até " + _m(econPotencial) + "/ano com redução de 75% do IRPJ.",
          baseLegal: "Art. 627-637 do RIR/2018",
          acaoRecomendada: "Consultar contador especializado para elaboração e protocolo do projeto junto à superintendência regional.",
          prazoImplementacao: "6 meses",
          detalhes: {}
        });
      }
    }

    // #7 — Créditos PIS/COFINS
    if (ctx.baseCreditos > 0 && ctx.pisCofinsResult) {
      var econPC = ctx.pisCofinsResult.economiaCreditos || _r((ctx.pisCofinsResult.creditoPIS || 0) + (ctx.pisCofinsResult.creditoCOFINS || 0));
      if (econPC > 0) {
        ops.push({
          id: "CREDITOS_PIS_COFINS", titulo: "Créditos de PIS/COFINS Não-Cumulativo",
          tipo: "Crédito", complexidade: "Baixa", risco: "Baixo",
          economiaAnual: econPC,
          descricao: "Créditos sobre insumos de " + _m(ctx.baseCreditos) + " geram economia de " + _m(econPC) + " em PIS/COFINS. Alíquota efetiva: " + (ctx.pisCofinsResult.aliquotaEfetiva || "—"),
          baseLegal: "Lei 10.637/2002 + Lei 10.833/2003, Art. 3º",
          acaoRecomendada: "Mapear todos os insumos elegíveis. Revisar classificação de despesas.",
          prazoImplementacao: "Imediato",
          detalhes: ctx.pisCofinsResult
        });
      }
    }

    // #8 — Depreciação acelerada por turnos
    var turnosVal = parseInt(d.turnosOperacao) || 1;
    if (turnosVal > 1 && ctx.depreciacaoResult.depreciaNormal > 0) {
      var econTurnos = _r((ctx.depreciacaoResult.depreciaAcelerada - ctx.depreciacaoResult.depreciaNormal) * 0.34);
      if (econTurnos > 0) {
        ops.push({
          id: "DEPRECIACAO_TURNOS", titulo: "Depreciação Acelerada por Turnos",
          tipo: "Dedução", complexidade: "Baixa", risco: "Baixo",
          economiaAnual: econTurnos,
          descricao: "Operação em " + turnosVal + " turnos permite depreciação acelerada (×" + ctx.depreciacaoResult.multiplicador + "), economia fiscal de " + _m(econTurnos) + ".",
          baseLegal: "Art. 323 do RIR/2018",
          acaoRecomendada: "Documentar turnos de operação. Manter controles de horas trabalhadas.",
          prazoImplementacao: "Imediato",
          detalhes: {}
        });
      }
    }

    // #9 — Depreciação incentivada SUDAM/SUDENE
    if ((ctx.isSUDAM || ctx.isSUDENE) && _n(d.valorBensNovos) > 0) {
      var econDepInc = _r(_n(d.valorBensNovos) * 0.34);
      ops.push({
        id: "DEPRECIACAO_INCENTIVADA", titulo: "Depreciação Incentivada SUDAM/SUDENE (100%)",
        tipo: "Dedução", complexidade: "Média", risco: "Baixo",
        economiaAnual: econDepInc,
        descricao: "Bens novos de " + _m(_n(d.valorBensNovos)) + " podem ser depreciados integralmente no ano de aquisição, economia de " + _m(econDepInc) + ".",
        baseLegal: "Art. 329 do RIR/2018",
        acaoRecomendada: "Registrar bens como novos e vincular ao projeto SUDAM/SUDENE.",
        prazoImplementacao: "Imediato",
        detalhes: {}
      });
    }

    // #10 — Bens de pequeno valor
    if (_n(d.bensSmallValue) > 0) {
      var econSmall = _r(_n(d.bensSmallValue) * 0.34);
      ops.push({
        id: "BENS_PEQUENO_VALOR", titulo: "Dedução Integral de Bens de Pequeno Valor",
        tipo: "Dedução", complexidade: "Baixa", risco: "Baixo",
        economiaAnual: econSmall,
        descricao: "Bens ≤ R$ 1.200 podem ser deduzidos integralmente como despesa, economia de " + _m(econSmall) + ".",
        baseLegal: "Art. 313, §1º do RIR/2018",
        acaoRecomendada: "Classificar bens de pequeno valor como despesa operacional direta.",
        prazoImplementacao: "Imediato",
        detalhes: {}
      });
    }

    // #11-15 — Incentivos não usados (PAT, FIA, Fundo Idoso, Rouanet, Esporte)
    var incentivosNaoUsados = [
      { id: "PAT_NAO_USADO", campo: "usaPAT", nome: "PAT — Programa de Alimentação do Trabalhador", limite: 0.04 },
      { id: "FIA_NAO_USADO", campo: "usaFIA", nome: "FIA — Fundo da Infância e Adolescência", limite: 0.01 },
      { id: "FUNDO_IDOSO_NAO_USADO", campo: "usaFundoIdoso", nome: "Fundo do Idoso", limite: 0.01 },
      { id: "ROUANET_NAO_USADA", campo: "usaRouanet", nome: "Lei Rouanet — Cultura", limite: 0.04 },
      { id: "ESPORTE_NAO_USADO", campo: "usaEsporte", nome: "Lei do Esporte", limite: 0.01 }
    ];
    incentivosNaoUsados.forEach(function (inc) {
      var usado = d[inc.campo] === true || d[inc.campo] === "true";
      if (!usado && ctx.irpjNormalPrevia > 0) {
        var potencial = _r(ctx.irpjNormalPrevia * inc.limite);
        if (potencial > 500) {
          ops.push({
            id: inc.id, titulo: inc.nome + " (não utilizado)",
            tipo: "Dedução", complexidade: "Média", risco: "Baixo",
            economiaAnual: potencial,
            descricao: "O incentivo " + inc.nome + " permite deduzir até " + _m(potencial) + " do IRPJ normal. ⚠️ Sujeito ao limite combinado de 4% do IRPJ Normal (Art. 228 RIR/2018) caso outros incentivos sejam utilizados simultaneamente.",
            baseLegal: "Art. 625-646 do RIR/2018",
            acaoRecomendada: "Avaliar adesão ao programa e realizar doações/investimentos dentro do período.",
            prazoImplementacao: "90 dias",
            detalhes: {}
          });
        }
      }
    });

    // ALERTA #5 — Limite combinado de 4% para incentivos fiscais (Art. 228 RIR/2018)
    (function() {
      var qtdIncentivosNaoUsados = incentivosNaoUsados.filter(function(inc) {
        return !(d[inc.campo] === true || d[inc.campo] === 'true');
      }).length;
      if (qtdIncentivosNaoUsados >= 2 && ctx.irpjNormalPrevia > 0) {
        var limiteCombinado = _r(ctx.irpjNormalPrevia * 0.04);
        ops.push({
          id: 'INCENTIVOS_LIMITE_COMBINADO',
          titulo: '⚠️ Atenção — Limite Combinado de Incentivos Fiscais',
          tipo: 'Alerta',
          complexidade: 'Baixa',
          risco: 'Alto',
          economiaAnual: 0,
          descricao: 'Os incentivos PAT, Lei Rouanet, FIA, Fundo do Idoso e Lei do Esporte têm limite ' +
            'COMBINADO de 4% do IRPJ Normal (Art. 228 do RIR/2018). O total máximo aproveitável ' +
            'para este período é de ' + _m(limiteCombinado) + '. ' +
            'Não é possível somar os limites individuais de cada incentivo — o teto global é único.',
          baseLegal: 'Art. 228 do RIR/2018 (Decreto 9.580/2018); IN RFB 1.700/2017',
          acaoRecomendada: 'Planejar quais incentivos priorizar dentro do teto de ' + _m(limiteCombinado) +
            ' (4% do IRPJ Normal). Recomenda-se consultar contador para otimizar a combinação.',
          prazoImplementacao: 'Antes do fechamento do período',
          detalhes: { limiteCombinado: limiteCombinado, irpjNormal: ctx.irpjNormalPrevia }
        });
      }
    })();


    // #16 — Lei do Bem (P&D)
    if ((d.investePD === true || d.investePD === "true") && _n(d.valorPD) > 0) {
      var econPD = _r(_n(d.valorPD) * 0.60 * 0.34);
      ops.push({
        id: "LEI_BEM_PD", titulo: "Lei do Bem — Pesquisa & Desenvolvimento",
        tipo: "Exclusão", complexidade: "Média", risco: "Baixo",
        economiaAnual: econPD,
        descricao: "Investimento em P&D de " + _m(_n(d.valorPD)) + " permite exclusão de 60% da base de IRPJ/CSLL, economia de " + _m(econPD) + ".",
        baseLegal: "Lei 11.196/2005 (Lei do Bem)",
        acaoRecomendada: "Manter documentação de projetos de P&D. Enviar relatório ao MCTI.",
        prazoImplementacao: "30 dias",
        detalhes: {}
      });
    }

    // #17 — Converter gratificação em pró-labore
    if ((d.temGratificacaoAdm === true || d.temGratificacaoAdm === "true") && _n(d.gratificacoesAdm) > 0) {
      var econGrat = _r(_n(d.gratificacoesAdm) * 0.34);
      ops.push({
        id: "CONVERTER_GRATIFICACAO", titulo: "Converter Gratificação de Administradores em Pró-labore",
        tipo: "Dedução", complexidade: "Baixa", risco: "Baixo",
        economiaAnual: econGrat,
        descricao: "Gratificação de " + _m(_n(d.gratificacoesAdm)) + " é indedutível. Convertendo em pró-labore, economia de " + _m(econGrat) + " (passa a ser dedutível).",
        baseLegal: "Art. 358, §1º do RIR/2018",
        acaoRecomendada: "Alterar contrato social. Formalizar pró-labore mensal com folha de pagamento.",
        prazoImplementacao: "30 dias",
        detalhes: {}
      });
    }

    // #18 — Retenções a compensar
    if (ctx.totalIRRF + ctx.totalCSRF > 0 && ctx.retencoesResult) {
      var compRetTotal = ctx.retencoesResult.compensacao ? ctx.retencoesResult.compensacao.totalCompensado : 0;
      if (compRetTotal > 0) {
        ops.push({
          id: "RETENCOES_COMPENSAR", titulo: "Retenções na Fonte Compensáveis",
          tipo: "Compensação", complexidade: "Baixa", risco: "Baixo",
          economiaAnual: compRetTotal,
          descricao: "Total de " + _m(ctx.totalIRRF + ctx.totalCSRF) + " em retenções sofridas, " + _m(compRetTotal) + " compensáveis diretamente com tributos devidos.",
          baseLegal: "Art. 717 (IRRF); Lei 10.833/2003, art. 36 (CSRF)",
          acaoRecomendada: "Manter controle detalhado de notas fiscais com retenções. Escriturar na EFD-Reinf.",
          prazoImplementacao: "Imediato",
          detalhes: ctx.retencoesResult
        });
      }
    }

    // #19 — Saldo negativo
    if (ctx.saldoNegResult && ctx.saldoNegResult.temSaldoNegativo) {
      ops.push({
        id: "SALDO_NEGATIVO", titulo: "Saldo Negativo de IRPJ — Restituição/Compensação",
        tipo: "Compensação", complexidade: "Média", risco: "Baixo",
        economiaAnual: ctx.saldoNegResult.valorOriginal,
        descricao: "Retenções + estimativas excedem o IRPJ devido em " + _m(ctx.saldoNegResult.valorOriginal) + ". Pode ser compensado via PER/DCOMP ou pedido de restituição.",
        baseLegal: "Art. 235 do RIR/2018",
        acaoRecomendada: "Transmitir PER/DCOMP para compensar com outros tributos federais. Prazo decadencial: 5 anos.",
        prazoImplementacao: "30 dias",
        detalhes: ctx.saldoNegResult
      });
    }

    // #20 — Crédito sobre estoque de abertura
    if (_n(d.creditoEstoqueAbertura) > 0) {
      var econEstoque = _r(_n(d.creditoEstoqueAbertura) * 0.0925);
      ops.push({
        id: "ESTOQUE_ABERTURA", titulo: "Crédito sobre Estoque de Abertura (Migração)",
        tipo: "Crédito", complexidade: "Média", risco: "Baixo",
        economiaAnual: econEstoque,
        descricao: "Crédito de PIS/COFINS sobre estoque de " + _m(_n(d.creditoEstoqueAbertura)) + " na migração para Lucro Real, " + _m(econEstoque) + "/ano (1/12 por mês).",
        baseLegal: "Art. 12 da Lei 10.637/2002",
        acaoRecomendada: "Levantar inventário na data da migração. Apropriar 1/12 por mês durante 12 meses.",
        prazoImplementacao: "Imediato",
        detalhes: {}
      });
    }

    // #21 — Reinvestimento 30% (SUDAM/SUDENE)
    if (ctx.temProjetoSUDAM && (d.usarReinvestimento30 === true || d.usarReinvestimento30 === "true") && ctx.sudamResult && ctx.sudamResult.resumo) {
      var econReinv = ctx.sudamResult.resumo.economiaReinvestimento30 || 0;
      if (econReinv > 0) {
        ops.push({
          id: "REINVESTIMENTO_30", titulo: "Reinvestimento 30% IRPJ — SUDAM/SUDENE",
          tipo: "Redução", complexidade: "Média", risco: "Baixo",
          economiaAnual: econReinv,
          descricao: "Depósito de 30% do IRPJ sobre lucro da exploração em banco oficial, economia de " + _m(econReinv) + ". 50% pode ser usado como capital de giro.",
          baseLegal: "Lei 13.799/2019",
          acaoRecomendada: "Efetuar depósito no banco oficial da superintendência. Vincular ao projeto aprovado.",
          prazoImplementacao: "30 dias",
          detalhes: {}
        });
      }
    }

    // #22 — PDD Fiscal
    // ═══ FIX BUG #5: Usar alíquotas efetivas (consistente com pddFiscalInfo) em vez de 34% fixo ═══
    var totalPDDOp = _n(d.perdasCreditos6Meses) + _n(d.perdasCreditosJudicial) + _n(d.perdasCreditosFalencia);
    if (totalPDDOp > 0) {
      // Usar alíquotas efetivas do contexto (se disponíveis), senão fallback 34%
      var _aliqIRPJCtx = ctx.aliqEfetIRPJ || 0.15;
      var _aliqCSLLCtx = ctx.aliqEfetCSLL || 0.09;
      var econPDDOp = _r(totalPDDOp * (_aliqIRPJCtx + _aliqCSLLCtx));
      var aliqPDDUsada = _r((_aliqIRPJCtx + _aliqCSLLCtx) * 100);
      ops.push({
        id: "PDD_FISCAL", titulo: "PDD Fiscal — Perdas no Recebimento de Créditos",
        tipo: "Exclusão", complexidade: "Baixa", risco: "Baixo",
        economiaAnual: econPDDOp,
        economia: econPDDOp, // alias para compatibilidade (FIX BUG #6)
        descricao: "Perdas totais de " + _m(totalPDDOp) + " podem ser excluídas do lucro real, gerando economia de " + _m(econPDDOp) + " (" + _pp(aliqPDDUsada) + " alíquota efetiva IRPJ+CSLL).",
        baseLegal: "Art. 340-342 do RIR/2018 (Decreto 9.580/2018)",
        acaoRecomendada: "Manter documentação comprobatória: protestos, ajuizamento de ações, sentença de falência. Controlar na Parte A do LALUR.",
        prazoImplementacao: "Imediato",
        detalhes: {
          creditos6Meses: _n(d.perdasCreditos6Meses),
          creditosJudicial: _n(d.perdasCreditosJudicial),
          creditosFalencia: _n(d.perdasCreditosFalencia),
        }
      });
    }

    // #23 — CPRB (Desoneração da Folha)
    var cnaePriStr = (d.cnaePrincipal || "").replace(/[\s\-\/]/g, "");
    var elegCPRB = cnaePriStr.substring(0, 2) === "62" || d._cprbSugerida;
    if (elegCPRB && !(d.optouCPRB === true || d.optouCPRB === "true")) {
      var folhaCPRBPot = _n(d.folhaPagamentoAnual) || (_n(d.salariosBrutos) + _n(d.proLabore));
      var cppPot = _r(folhaCPRBPot * 0.20);
      var cprbPot = _r((_n(d.receitaBrutaAnual) || 0) * 0.045);
      var econCPRBPot = _r(cppPot - cprbPot);
      if (econCPRBPot > 0) {
        ops.push({
          id: "CPRB_POTENCIAL", titulo: "CPRB — Desoneração da Folha (não optada)",
          tipo: "Potencial", complexidade: "Baixa", risco: "Baixo",
          economiaAnual: econCPRBPot,
          descricao: "Empresa de TI elegível à CPRB. Alíquota de 4,5% sobre receita bruta em vez de 20% sobre folha. Economia potencial de " + _m(econCPRBPot) + "/ano.",
          baseLegal: "Lei 12.546/2011",
          acaoRecomendada: "Avaliar opção pela CPRB na Etapa 5 do wizard. A opção é feita via GFIP/eSocial no início do ano.",
          prazoImplementacao: "Imediato (início do ano-calendário)",
          detalhes: {}
        });
      }
    }

    // #23 — Pró-labore como dedução
    if ((parseInt(d.numSocios) || 0) > 0 && _n(d.proLabore) > 0) {
      var econProLabore = _r(_n(d.proLabore) * 0.34);
      ops.push({
        id: "PROLABORE_DEDUCAO", titulo: "Pró-labore dos Sócios como Despesa Dedutível",
        tipo: "Dedução", complexidade: "Baixa", risco: "Baixo",
        economiaAnual: econProLabore,
        descricao: "Pró-labore de " + _m(_n(d.proLabore)) + "/ano é despesa 100% dedutível no Lucro Real, gerando economia de " + _m(econProLabore) + ".",
        baseLegal: "Art. 357 do RIR/2018",
        acaoRecomendada: "Formalizar pró-labore em folha de pagamento. Recolher INSS e IRRF na fonte.",
        prazoImplementacao: "Imediato",
        detalhes: {}
      });
    }

    // #24 — Previdência Complementar (não usada)
    var usaPrevidCompl = d.usaPrevidenciaComplementar === true || d.usaPrevidenciaComplementar === "true";
    if (!usaPrevidCompl && ctx.folhaPagamento > 0 && ctx.lucroRealFinal > 0) {
      var limPrevidCompl = _r(ctx.folhaPagamento * 0.20);
      var econPrevidCompl = _r(limPrevidCompl * 0.34);
      if (econPrevidCompl > 500) {
        ops.push({
          id: "PREVIDENCIA_COMPLEMENTAR", titulo: "Previdência Complementar Patronal (não utilizada)",
          tipo: "Dedução", complexidade: "Média", risco: "Baixo",
          economiaAnual: econPrevidCompl,
          descricao: "Contribuição patronal para previdência complementar de até " + _m(limPrevidCompl) + " (20% da folha) é dedutível, gerando economia fiscal de até " + _m(econPrevidCompl) + ".",
          baseLegal: "Art. 369, §1º do RIR/2018",
          acaoRecomendada: "Contratar plano de previdência complementar empresarial. Benefício para retenção de talentos.",
          prazoImplementacao: "60 dias",
          detalhes: { limiteAnual: limPrevidCompl, economiaFiscal: econPrevidCompl }
        });
      }
    }

    // #25 — PDD Fiscal (oportunidade proativa — quando NÃO há PDD declarada)
    var temCreditosVencidos = _n(d.creditosVencidos6Meses) > 0 || _n(d.inadimplenciaAnual) > 0;
    var jaPddUsada = _n(d.perdasCreditos6Meses) + _n(d.perdasCreditosJudicial) + _n(d.perdasCreditosFalencia);
    if (!temCreditosVencidos && jaPddUsada === 0 && ctx.receitaBruta > 500000) {
      ops.push({
        id: "PDD_PROATIVA", titulo: "Revisão de PDD — Provisão para Devedores Duvidosos",
        tipo: "Dedução", complexidade: "Média", risco: "Baixo",
        economiaAnual: 0,
        descricao: "Nenhuma PDD fiscal informada. Empresas com receita acima de R$ 500 mil geralmente têm créditos vencidos enquadráveis como PDD fiscal (Art. 340-342). Recomenda-se revisão dos recebíveis.",
        baseLegal: "Art. 340-342 do RIR/2018",
        acaoRecomendada: "Levantar todos os créditos vencidos há mais de 6 meses. Identificar devedores em falência/recuperação judicial. Documentar providências de cobrança.",
        prazoImplementacao: "30 dias",
        detalhes: {}
      });
    }

    // #26 — Compliance/Riscos (se verificarCompliance disponível)
    if (LR.calcular.avancado && LR.calcular.avancado.verificarCompliance) {
      try {
        var compliance = LR.calcular.avancado.verificarCompliance({
          lucroLiquido: ctx.lucroLiquido,
          receitaBruta: ctx.receitaBruta,
          custos: ctx.custosTotais,
          despesas: ctx.despesasTotais
        });
        if (compliance && compliance.alertas && compliance.alertas.length > 0) {
          ops.push({
            id: "COMPLIANCE_ALERTAS", titulo: "Alertas de Compliance Fiscal",
            tipo: "Risco", complexidade: "Alta", risco: "Alto",
            economiaAnual: 0,
            descricao: compliance.alertas.length + " alerta(s) de conformidade identificado(s). Resolução preventiva evita autuações e multas de 75-150%.",
            baseLegal: "Art. 293-300 do RIR/2018",
            acaoRecomendada: "Revisar cada alerta com o contador. Priorizar itens críticos.",
            prazoImplementacao: "Imediato",
            detalhes: compliance
          });
        }
      } catch(e) { console.warn('[IMPOST] Erro em compliance:', e.message); }
    }

    // #27 — Lei do Bem NÃO usada (potencial — quando investePD NÃO está marcado)
    var usaLeiBem = d.investePD === true || d.investePD === "true";
    if (!usaLeiBem && ctx.irpjNormalPrevia > 5000) {
      var econLeiBemPotencial = _r(ctx.irpjNormalPrevia * 0.20);
      ops.push({
        id: "LEI_BEM_POTENCIAL", titulo: "Potencial: Lei do Bem — P&D (não utilizada)",
        tipo: "Potencial", complexidade: "Alta", risco: "Médio",
        economiaAnual: econLeiBemPotencial,
        descricao: "Empresas com lucro real podem excluir 60-80% dos gastos com P&D da base de IRPJ/CSLL. Economia potencial de até " + _m(econLeiBemPotencial) + "/ano.",
        baseLegal: "Lei 11.196/2005 (Lei do Bem), Cap. III",
        acaoRecomendada: "Avaliar se a empresa realiza atividades de inovação tecnológica. Consultar MCTI para enquadramento.",
        prazoImplementacao: "6 meses",
        detalhes: {}
      });
    }

    // #28 — Doações com Incentivo Fiscal
    if (ctx.validacaoDespesasLimites && ctx.validacaoDespesasLimites.doacoes && ctx.lucroAjustado > 100000) {
      var limDoacoes = ctx.validacaoDespesasLimites.doacoes;
      var doacoesAtual = _n(d.doacoesOperacionais) + _n(d.doacoesOSCIP);
      var limiteMaxDoacoes = _r((ctx.lucroOperacional || ctx.lucroLiquido) * 0.02);
      var faltaParaLimite = _r(limiteMaxDoacoes - doacoesAtual);
      if (faltaParaLimite > 0) {
        var econDoacoes = _r(faltaParaLimite * 0.34);
        ops.push({
          id: "DOACOES_INCENTIVO", titulo: "Doações com Incentivo Fiscal — Utilizar Limite Completo",
          tipo: "Dedução", complexidade: "Baixa", risco: "Baixo",
          economiaAnual: econDoacoes,
          descricao: "Doações operacionais atuais de " + _m(doacoesAtual) + " estão abaixo do limite de " + _m(limiteMaxDoacoes) + " (2% do lucro operacional). Margem de " + _m(faltaParaLimite) + " gera economia fiscal de " + _m(econDoacoes) + " (34%).",
          baseLegal: "Art. 377-385 do RIR/2018",
          acaoRecomendada: "Realizar doações a entidades civis ou OSCIPs até o limite legal. Obter recibos e manter documentação.",
          prazoImplementacao: "30 dias",
          detalhes: { limiteMaximo: limiteMaxDoacoes, doacoesAtuais: doacoesAtual, margemDisponivel: faltaParaLimite }
        });
      }
    }

    // #29 — Amortização de Goodwill
    if (_n(d.valorGoodwill) > 0 && ctx.goodwillResult) {
      var deducaoGoodwill = ctx.goodwillResult.amortizacaoAnual || _r(_n(d.valorGoodwill) * (12 / 60));
      var econGoodwill = _r(deducaoGoodwill * 0.34);
      ops.push({
        id: "GOODWILL_AMORTIZACAO", titulo: "Amortização de Goodwill — Dedução Fiscal",
        tipo: "Dedução", complexidade: "Média", risco: "Baixo",
        economiaAnual: econGoodwill,
        descricao: "Goodwill de " + _m(_n(d.valorGoodwill)) + " amortizado em 1/60 avos/mês (20% a.a.), dedução anual de " + _m(deducaoGoodwill) + ", economia fiscal de " + _m(econGoodwill) + ".",
        baseLegal: "Lei 12.973/2014, Arts. 20-22",
        acaoRecomendada: "Registrar goodwill conforme CPC 15 e Lei 12.973. Manter laudo de avaliação atualizado.",
        prazoImplementacao: "Imediato",
        detalhes: ctx.goodwillResult
      });
    }

    // #30 — Exaustão de Recursos Naturais
    if (_n(d.valorRecursosNaturais) > 0 && ctx.exaustaoResult) {
      var deducaoExaustao = ctx.exaustaoResult.exaustaoAnual || _r(_n(d.valorRecursosNaturais) * 0.20);
      var econExaustao = _r(deducaoExaustao * 0.34);
      ops.push({
        id: "EXAUSTAO_RECURSOS", titulo: "Exaustão de Recursos Naturais — Dedução Fiscal",
        tipo: "Dedução", complexidade: "Média", risco: "Baixo",
        economiaAnual: econExaustao,
        descricao: "Recursos naturais de " + _m(_n(d.valorRecursosNaturais)) + " permitem dedução de exaustão de " + _m(deducaoExaustao) + "/ano, economia fiscal de " + _m(econExaustao) + ".",
        baseLegal: "Art. 334-337 do RIR/2018",
        acaoRecomendada: "Manter laudo técnico de estimativa de vida útil dos recursos. Registrar na contabilidade e LALUR.",
        prazoImplementacao: "Imediato",
        detalhes: ctx.exaustaoResult
      });
    }

    // #31 — Despesas Pré-Operacionais Diferidas
    if (_n(d.despesasPreOperacionais) > 0 && ctx.preOperacionalResult) {
      var deducaoPreOp = ctx.preOperacionalResult.amortizacaoAnual || _r(_n(d.despesasPreOperacionais) / 5);
      var econPreOp = _r(deducaoPreOp * 0.34);
      ops.push({
        id: "PRE_OPERACIONAIS", titulo: "Despesas Pré-Operacionais — Amortização Diferida",
        tipo: "Dedução", complexidade: "Baixa", risco: "Baixo",
        economiaAnual: econPreOp,
        descricao: "Despesas pré-operacionais de " + _m(_n(d.despesasPreOperacionais)) + " amortizadas em no mínimo 5 anos, dedução anual de " + _m(deducaoPreOp) + ", economia de " + _m(econPreOp) + ".",
        baseLegal: "Art. 11 da Lei 12.973/2014",
        acaoRecomendada: "Registrar despesas pré-operacionais no ativo diferido. Controlar amortização no LALUR Parte B.",
        prazoImplementacao: "Imediato",
        detalhes: ctx.preOperacionalResult
      });
    }

    // #32 — Subcapitalização — Alerta de Juros Indedutíveis
    if (ctx.subcapResult && ctx.subcapResult.excedeu) {
      var jurosIndedSubcap = ctx.subcapResult.jurosIndedutiveis || 0;
      var econSubcapPotencial = _r(jurosIndedSubcap * 0.34);
      ops.push({
        id: "SUBCAPITALIZACAO_ALERTA", titulo: "Subcapitalização — Juros Indedutíveis (Alerta)",
        tipo: "Risco", complexidade: "Alta", risco: "Alto",
        economiaAnual: econSubcapPotencial,
        descricao: "Juros de " + _m(jurosIndedSubcap) + " pagos a vinculadas excedem limites de subcapitalização e são INDEDUTÍVEIS. Reestruturar dívida pode recuperar dedutibilidade de " + _m(econSubcapPotencial) + ".",
        baseLegal: "Art. 249-251 do RIR/2018",
        acaoRecomendada: "Reestruturar dívida para reduzir proporção dívida/PL dentro dos limites legais (2:1 geral, 30% paraíso fiscal).",
        prazoImplementacao: "90 dias",
        detalhes: ctx.subcapResult
      });
    }

    // #33 — Omissão de Receita — Alertas de Compliance
    if (ctx.omissaoResult && ctx.omissaoResult.riscosIdentificados > 0) {
      var descOmissao = ctx.omissaoResult.riscosIdentificados + " indicador(es) de omissão de receita identificado(s).";
      if (ctx.omissaoResult.indicadores && ctx.omissaoResult.indicadores.length > 0) {
        var indicadoresDesc = [];
        ctx.omissaoResult.indicadores.forEach(function (ind) {
          var descInd = ind.descricao || ind.tipo || "Indicador";
          indicadoresDesc.push(descInd);
        });
        descOmissao += " Indicadores: " + indicadoresDesc.join("; ") + ".";
      }
      ops.push({
        id: "OMISSAO_RECEITA_ALERTA", titulo: "Omissão de Receita — Alertas de Compliance",
        tipo: "Risco", complexidade: "Alta", risco: "Alto",
        economiaAnual: 0,
        descricao: descOmissao + " Resolução preventiva evita autuações com multa de 75-150% e juros SELIC.",
        baseLegal: "Art. 293-300 do RIR/2018",
        acaoRecomendada: "Revisar cada indicador imediatamente com o contador. Regularizar divergências antes de fiscalização.",
        prazoImplementacao: "Imediato",
        detalhes: ctx.omissaoResult
      });
    }

    // #34 — Regime Cambial Ótimo
    if (_n(d.receitasExteriorAnual) > 0 && d.regimeCambial) {
      var regCambialAtual = d.regimeCambial === "COMPETENCIA" ? "Competência" : "Caixa";
      var regCambialAlt = d.regimeCambial === "COMPETENCIA" ? "Caixa" : "Competência";
      var descCambial = "Regime atual: " + regCambialAtual + ". ";
      if (d.regimeCambial === "CAIXA") {
        descCambial += "O regime de Competência pode postergar tributação em cenários de depreciação cambial. A opção deve ser exercida em janeiro (Art. 407).";
      } else {
        descCambial += "O regime de Caixa tributa variações cambiais apenas no recebimento/pagamento efetivo, podendo diferir tributação.";
      }
      ops.push({
        id: "REGIME_CAMBIAL", titulo: "Regime Cambial — Análise de Oportunidade",
        tipo: "Timing", complexidade: "Média", risco: "Médio",
        economiaAnual: 0,
        descricao: descCambial,
        baseLegal: "Art. 407-413 do RIR/2018 (Variação Cambial)",
        acaoRecomendada: "Simular impacto da mudança de regime cambial considerando projeções de câmbio. Opção por Competência é irretratável no ano-calendário.",
        prazoImplementacao: "Janeiro do próximo exercício",
        detalhes: { regimeAtual: d.regimeCambial, alternativa: regCambialAlt }
      });
    }

    // #35 — Método de Estoque Ótimo
    if (_n(d.valorEstoqueFinal) > 0) {
      var metodoAtual = d.metodoEstoque || "CUSTO_MEDIO";
      var descEstoque = "Método atual: " + metodoAtual + ". Estoque final: " + _m(_n(d.valorEstoqueFinal)) + ". ";
      descEstoque += "Em cenários inflacionários, PEPS pode gerar custo mais alto (menor lucro tributável). Custo Médio é mais conservador.";
      var vedacoesEstoque = [];
      if (LR.estoques && LR.estoques.vedacoes) {
        vedacoesEstoque = LR.estoques.vedacoes;
      }
      ops.push({
        id: "METODO_ESTOQUE", titulo: "Método de Avaliação de Estoques — Revisão",
        tipo: "Timing", complexidade: "Média", risco: "Baixo",
        economiaAnual: 0,
        descricao: descEstoque + (vedacoesEstoque.length > 0 ? " Vedações: " + vedacoesEstoque[0] + "." : ""),
        baseLegal: "Art. 304-310 do RIR/2018",
        acaoRecomendada: "Avaliar qual método de estoque minimiza a carga tributária no cenário atual. Método deve ser consistente ano a ano. UEPS é vedado (Art. 307).",
        prazoImplementacao: "Início do exercício",
        detalhes: { metodoAtual: metodoAtual, valorEstoque: _n(d.valorEstoqueFinal), vedacoes: vedacoesEstoque }
      });
    }

    // #36 — Provisões Não Dedutíveis — Estratégia de Reversão
    if (_n(d.provisoesContingencias) > 0) {
      var totalProvisoes = _n(d.provisoesContingencias) + _n(d.provisoesGarantias);
      var econFuturaProvisoes = _r(totalProvisoes * 0.34);
      var descProvisao = "Provisões não dedutíveis de " + _m(totalProvisoes) + " geram adição ao LALUR no exercício corrente. ";
      descProvisao += "A reversão/utilização futura gera EXCLUSÃO do LALUR, resultando em economia fiscal futura de até " + _m(econFuturaProvisoes) + ".";
      var fundamentacao = "";
      if (LR.provisoes && LR.provisoes.naoDedutiveis) {
        LR.provisoes.naoDedutiveis.forEach(function (prov) {
          fundamentacao += prov.descricao + " (" + prov.artigo + "); ";
        });
      }
      ops.push({
        id: "PROVISOES_REVERSAO", titulo: "Provisões Não Dedutíveis — Estratégia de Reversão Futura",
        tipo: "Timing", complexidade: "Baixa", risco: "Baixo",
        economiaAnual: 0,
        descricao: descProvisao + (fundamentacao ? " Fundamento: " + fundamentacao : ""),
        baseLegal: "Art. 340-342 do RIR/2018",
        acaoRecomendada: "Controlar provisões na Parte B do LALUR. Na reversão/utilização, registrar exclusão na Parte A. Manter memória de cálculo atualizada.",
        prazoImplementacao: "Contínuo",
        detalhes: { provisoesContingencias: _n(d.provisoesContingencias), provisoesGarantias: _n(d.provisoesGarantias), economiaFuturaEstimada: econFuturaProvisoes }
      });
    }

    // #37 — Reinvestimento 30% SUDAM/SUDENE Potencial (SEM projeto)
    if ((ctx.isSUDAM || ctx.isSUDENE) && !ctx.temProjetoSUDAM && ctx.irpjNormalPrevia > 0) {
      var nomeSup37 = ctx.isSUDAM ? "SUDAM" : "SUDENE";
      var reinvPotencial = _r(ctx.irpjNormalPrevia * 0.30);
      var capitalGiroPotencial = _r(reinvPotencial * 0.50);
      var bancoDeposito = "";
      if (LR.sudam && LR.sudam.reinvestimento30 && LR.sudam.reinvestimento30.bancoDeposito) {
        bancoDeposito = LR.sudam.reinvestimento30.bancoDeposito[nomeSup37] || "";
      } else if (LR.reinvestimento30 && LR.reinvestimento30.bancoDeposito) {
        bancoDeposito = LR.reinvestimento30.bancoDeposito || "";
      }
      ops.push({
        id: "REINVESTIMENTO_30_POTENCIAL", titulo: "Potencial: Reinvestimento 30% " + nomeSup37 + " (sem projeto)",
        tipo: "Potencial", complexidade: "Alta", risco: "Médio",
        economiaAnual: reinvPotencial,
        descricao: "Com projeto " + nomeSup37 + " aprovado, seria possível depositar 30% do IRPJ (" + _m(reinvPotencial) + ") como reinvestimento. 50% (" + _m(capitalGiroPotencial) + ") pode ser usado como capital de giro." + (bancoDeposito ? " Banco: " + bancoDeposito + "." : ""),
        baseLegal: "Art. 638-651 do RIR/2018",
        acaoRecomendada: "Elaborar projeto de investimento e protocolar junto à " + nomeSup37 + " para obter aprovação e acessar o benefício.",
        prazoImplementacao: "6-12 meses",
        detalhes: { reinvestimentoPotencial: reinvPotencial, capitalGiro50: capitalGiroPotencial }
      });
    }

    // #38 — Receita Bruta Formal (revisão)
    if (ctx.receitaBruta > 0 && LR.calcular && LR.calcular.receitaBrutaCalc) {
      try {
        var receitaFormal = LR.calcular.receitaBrutaCalc({
          receitaBruta: ctx.receitaBruta,
          devolucoes: _n(d.devolucoes),
          descontosIncondicionais: _n(d.descontosIncondicionais),
          avp: _n(d.ajusteValorPresente)
        });
        if (receitaFormal && receitaFormal.deducoesNaoAplicadas > 0) {
          var econReceitaFormal = _r(receitaFormal.deducoesNaoAplicadas * 0.34);
          ops.push({
            id: "RECEITA_BRUTA_FORMAL", titulo: "Receita Bruta — Deduções Não Aplicadas",
            tipo: "Dedução", complexidade: "Baixa", risco: "Baixo",
            economiaAnual: econReceitaFormal,
            descricao: "Revisão da composição da receita bruta identificou deduções não aplicadas de " + _m(receitaFormal.deducoesNaoAplicadas) + " (devoluções, descontos, AVP). Economia potencial de " + _m(econReceitaFormal) + ".",
            baseLegal: "Lei 12.973/2014, Art. 12",
            acaoRecomendada: "Verificar se devoluções, descontos incondicionais e AVP estão sendo corretamente deduzidos da receita bruta.",
            prazoImplementacao: "Imediato",
            detalhes: receitaFormal
          });
        }
      } catch(e) { console.warn('[IMPOST] Erro em receitaFormal:', e.message); }
    }

    // #39 — Simulação Completa Integrada
    if (LR.calcular && LR.calcular.simulacaoCompleta) {
      try {
        // BUG#4 CORRIGIDO: campos renomeados para o formato esperado pelo mapeamento
        var simCompleta = LR.calcular.simulacaoCompleta({
          lucroLiquido: ctx.lucroLiquido,
          receitaBruta: ctx.receitaBruta,
          adicoes: ctx.totalAdicoes || 0,
          exclusoes: ctx.totalExclusoes || 0,
          patrimonioLiquido: _n(d.plAjustadoJCP) > 0 ? _n(d.plAjustadoJCP) : ctx.plVal,
          prejuizoFiscal: _n(d.prejuizoFiscal),
          baseNegativaCSLL: _n(d.baseNegativaCSLL),
          lucrosAcumulados: _n(d.lucrosAcumulados) + _n(d.reservasLucros),
          tjlp: (_n(d.tjlp) || 7.97) / 100,
          financeira: ctx.ehFinanceira,
          despesasIncentivos: ctx.despesasIncentivos || {},
          retencoesFonte: ctx.totalIRRF || 0,
          estimativasPagas: 0,
          numMeses: 12
        });
        // BUG#4: guarda para evitar exibir número fantasma quando baseline é zero
        if (simCompleta && simCompleta.economia && simCompleta.economia.total > 0
            && simCompleta.semOtimizacao && simCompleta.semOtimizacao.irpjDevido > 0) {
          ops.push({
            id: "SIMULACAO_COMPLETA", titulo: "Simulação Integrada — Economia Consolidada",
            tipo: "Dedução", complexidade: "Média", risco: "Baixo",
            // CORREÇÃO FALHA #1: Marcar como consolidação para não somar com itens individuais
            _isConsolidada: true,
            economiaAnual: simCompleta.economia.total,
            descricao: "⚠️ CONSOLIDAÇÃO (não somar com itens acima) — Simulação consolidada IRPJ+CSLL+JCP+Incentivos indica economia total otimizada de " + _m(simCompleta.economia.total) + " vs cenário sem otimizações.",
            baseLegal: "Diversos — consolidação de todos os incentivos aplicáveis",
            acaoRecomendada: "Implementar todas as otimizações identificadas na simulação completa para maximizar a economia fiscal.",
            prazoImplementacao: "30-90 dias",
            detalhes: simCompleta
          });
        }
      } catch(e) { console.warn('[IMPOST] Erro em simulaçãoCompleta:', e.message); }
    }

    // #40 — Recomendação Trimestral vs Anual
    if (ctx.recomendacaoRegime) {
      var regimeRecomendado = ctx.recomendacaoRegime.regimeRecomendado || "";
      var regimeAtual = d.apuracaoLR || "anual";
      var econRegime = ctx.recomendacaoRegime.economiaEstimada || 0;
      if (regimeRecomendado && regimeRecomendado.toLowerCase() !== regimeAtual.toLowerCase() && econRegime > 0) {
        ops.push({
          id: "REGIME_APURACAO", titulo: "Recomendação: Apuração " + regimeRecomendado.charAt(0).toUpperCase() + regimeRecomendado.slice(1),
          tipo: "Timing", complexidade: "Baixa", risco: "Baixo",
          economiaAnual: econRegime,
          descricao: "Regime atual: " + regimeAtual + ". Recomendação: " + regimeRecomendado + ". Economia estimada de " + _m(econRegime) + "/ano pela mudança. " + (ctx.recomendacaoRegime.motivo || ""),
          baseLegal: "Art. 218-220 do RIR/2018",
          acaoRecomendada: "Avaliar mudança de regime de apuração no próximo exercício. Considerar impacto no fluxo de caixa e compensação de prejuízos.",
          prazoImplementacao: "Início do exercício",
          detalhes: ctx.recomendacaoRegime
        });
      }
    }

    // #41 — PDD Fiscal Detalhada (usando motor)
    var temPDD = _n(d.perdasCreditos6Meses) + _n(d.perdasCreditosJudicial) + _n(d.perdasCreditosFalencia);
    if (temPDD > 0 && LR.calcular && LR.calcular.avancado && LR.calcular.avancado.calcularPDD) {
      try {
        var pddDetalhada = LR.calcular.avancado.calcularPDD({
          perdasCreditos6Meses: _n(d.perdasCreditos6Meses),
          perdasCreditosJudicial: _n(d.perdasCreditosJudicial),
          perdasCreditosFalencia: _n(d.perdasCreditosFalencia),
          creditosVencidos6Meses: _n(d.creditosVencidos6Meses)
        });
        if (pddDetalhada && pddDetalhada.economiaAdicional > 0) {
          ops.push({
            id: "PDD_DETALHADA", titulo: "PDD Fiscal — Validação Detalhada por Faixas",
            tipo: "Dedução", complexidade: "Média", risco: "Baixo",
            economiaAnual: pddDetalhada.economiaAdicional,
            descricao: "Validação por faixas de valor (< R$ 15k, R$ 15k-100k, > R$ 100k) identificou economia adicional de " + _m(pddDetalhada.economiaAdicional) + ". " + (pddDetalhada.alertas ? pddDetalhada.alertas.join("; ") : ""),
            baseLegal: "Art. 340-342 do RIR/2018 (Decreto 9.580/2018)",
            acaoRecomendada: "Classificar créditos por faixa de valor e verificar requisitos específicos de cada faixa para maximizar PDD dedutível.",
            prazoImplementacao: "30 dias",
            detalhes: pddDetalhada
          });
        }
      } catch(e) { console.warn('[IMPOST] Erro em PDD detalhada:', e.message); }
    }

    // #42 — Mapa de Economia Consolidado
    if (LR.calcular && LR.calcular.avancado && LR.calcular.avancado.gerarMapaEconomia) {
      try {
        var mapaEconomia = LR.calcular.avancado.gerarMapaEconomia({
          receitaBruta: ctx.receitaBruta,
          lucroLiquido: ctx.lucroLiquido,
          lucroAjustado: ctx.lucroAjustado,
          patrimonioLiquido: ctx.plVal,
          irpjResult: ctx.irpjResult,
          csllResult: ctx.csllResult,
          jcpResult: ctx.jcpResult,
          pisCofinsResult: ctx.pisCofinsResult,
          depreciacaoResult: ctx.depreciacaoResult,
          compensacao: ctx.compensacao,
          incentivosFiscais: ctx.incentivosFiscais,
          sudamResult: ctx.sudamResult,
          goodwillResult: ctx.goodwillResult,
          exaustaoResult: ctx.exaustaoResult,
          preOperacionalResult: ctx.preOperacionalResult,
          oportunidades: ops
        });
        if (mapaEconomia && mapaEconomia.economiaTotal > 0) {
          ops.push({
            id: "MAPA_ECONOMIA", titulo: "Mapa de Economia Consolidado IMPOST.",
            tipo: "Dedução", complexidade: "Baixa", risco: "Baixo",
            // CORREÇÃO FALHA #1: Marcar como consolidação para não somar com itens individuais
            _isConsolidada: true,
            economiaAnual: mapaEconomia.economiaTotal,
            descricao: "⚠️ CONSOLIDAÇÃO (não somar com itens acima) — Mapa consolidado de todas as estratégias identifica economia total potencial de " + _m(mapaEconomia.economiaTotal) + ". " + (mapaEconomia.estrategiasAtivas || 0) + " estratégias ativas de " + (mapaEconomia.estrategiasDisponiveis || 0) + " disponíveis.",
            baseLegal: "Consolidação de todas as bases legais aplicáveis",
            acaoRecomendada: "Utilizar o Mapa de Economia como roteiro de implementação. Priorizar estratégias por impacto e complexidade.",
            prazoImplementacao: "Contínuo",
            detalhes: mapaEconomia
          });
        }
      } catch(e) { console.warn('[IMPOST] Erro em mapaEconomia:', e.message); }
    }

    // Ordenar por economia anual descrescente e atribuir ranking
    ops.sort(function (a, b) { return b.economiaAnual - a.economiaAnual; });
    // ═══ FIX BUG #6: Garantir que todas as oportunidades tenham .economia como alias de .economiaAnual ═══
    ops.forEach(function (op, i) {
      op.ranking = i + 1;
      // Sincronizar campos para evitar undefined em exportações que usem .economia
      if (op.economiaAnual !== undefined && op.economia === undefined) {
        op.economia = op.economiaAnual;
      } else if (op.economia !== undefined && op.economiaAnual === undefined) {
        op.economiaAnual = op.economia;
      }
    });

    return ops;
  }

  // ═══════════════════════════════════════════════════════════════════════════
  //  SIMULAÇÃO TRIMESTRAL vs ANUAL
  // ═══════════════════════════════════════════════════════════════════════════

  function _simularTrimestral(d, lucroAjustado, prejuizoFiscal, baseNegCSLL, vedaCompensacao, ehFinanceira) {
    var trimestres = [];
    var totalIRPJ = 0;
    var totalCSLL = 0;
    var totalIRPJNormalExato = 0;
    var totalIRPJAdicionalExato = 0;
    var totalCSLLExato = 0;
    var saldoPF = vedaCompensacao ? 0 : prejuizoFiscal;
    var saldoBN = vedaCompensacao ? 0 : baseNegCSLL;
    var aliqCSLL = ehFinanceira ? 0.15 : 0.09;

    // Se temos meses preenchidos, usar dados reais por trimestre
    var temMes = d.preencherMesAMes === true || d.preencherMesAMes === "true";
    for (var tri = 0; tri < 4; tri++) {
      var lucroTri;
      if (temMes) {
        var recTri = 0;
        for (var m = tri * 3 + 1; m <= tri * 3 + 3; m++) recTri += _n(d["receitaMes" + m]);
        var fator = _n(d.receitaBrutaAnual) > 0 ? recTri / _n(d.receitaBrutaAnual) : 0.25;
        lucroTri = _r(lucroAjustado * fator);
      } else {
        lucroTri = _r(lucroAjustado / 4);
      }

      // Compensação 30% por trimestre
      var compTri = 0;
      if (lucroTri > 0 && saldoPF > 0) {
        var maxComp = _r(lucroTri * 0.30);
        compTri = Math.min(maxComp, saldoPF);
        saldoPF = _r(saldoPF - compTri);
      }
      var lucroRealTri = Math.max(lucroTri - compTri, 0);

      // IRPJ trimestral (adicional sobre R$ 60.000)
      var irpjN_exato = lucroRealTri * 0.15;
      var irpjA_exato = Math.max(lucroRealTri - 60000, 0) * 0.10;
      var irpjN = _r(irpjN_exato);  // arredondado para UI do trimestre
      var irpjA = _r(irpjA_exato);
      var irpjTri = _r(irpjN + irpjA);

      // CSLL trimestral com compensação
      var compCSLLTri = 0;
      if (lucroTri > 0 && saldoBN > 0) {
        var maxCompBN = _r(lucroTri * 0.30);
        compCSLLTri = Math.min(maxCompBN, saldoBN);
        saldoBN = _r(saldoBN - compCSLLTri);
      }
      var baseCSLLTri = Math.max(lucroTri - compCSLLTri, 0);
      var csll_exato = baseCSLLTri * aliqCSLL;
      var csllTri = _r(csll_exato);

      // Acumular valores EXATOS (arredondamento apenas no retorno final)
      totalIRPJNormalExato += irpjN_exato;
      totalIRPJAdicionalExato += irpjA_exato;
      totalCSLLExato += csll_exato;
      totalIRPJ += irpjTri;
      totalCSLL += csllTri;

      trimestres.push({
        trimestre: tri + 1,
        lucroAjustado: lucroTri,
        compensacaoPrejuizo: compTri,
        lucroReal: lucroRealTri,
        irpjNormal: irpjN,
        irpjAdicional: irpjA,
        irpjTotal: irpjTri,
        compensacaoCSLL: compCSLLTri,
        baseCSLL: baseCSLLTri,
        csll: csllTri
      });
    }

    return {
      trimestres: trimestres,
      totalIRPJ: _r(totalIRPJNormalExato + totalIRPJAdicionalExato),
      totalIRPJNormal: _r(totalIRPJNormalExato),
      totalIRPJAdicional: _r(totalIRPJAdicionalExato),
      totalCSLL: _r(totalCSLLExato),
      total: _r(totalIRPJNormalExato + totalIRPJAdicionalExato + totalCSLLExato),
      saldoPrejuizoRemanescente: _r(saldoPF),
      saldoBaseNegRemanescente: _r(saldoBN)
    };
  }

  function _simularAnualEstimativa(d, receitaBruta, lucroRealFinal, ehFinanceira, irpjRealDoMotor, csllRealDoMotor) {
    var meses = [];
    var totalEstimIRPJ = 0;
    var totalEstimCSLL = 0;
    var tipo = d.tipoAtividade || "SERVICOS_GERAL";
    var temMes = d.preencherMesAMes === true || d.preencherMesAMes === "true";

    // Presunções para fallback (RIR/2018 Art. 591-593)
    var presIRPJ = 0.32; // Serviços
    var presCSLL = 0.32;
    if (tipo === "COMERCIO_INDUSTRIA" || tipo === "INDUSTRIA" || tipo === "TRANSPORTE_CARGA") {
      presIRPJ = 0.08;
      presCSLL = 0.12;
    } else if (tipo === "TRANSPORTE_PASSAGEIROS") {
      presIRPJ = 0.16;
      presCSLL = 0.12;
    } else if (tipo === "SERVICOS_HOSPITALARES") {
      presIRPJ = 0.08;
      presCSLL = 0.12;
    } else if (tipo === "REVENDA_COMBUSTIVEIS") {
      presIRPJ = 0.016;
      presCSLL = 0.12;
    }
    // Buscar presunção do LR.presuncoes se disponível
    if (LR && LR.presuncoes && LR.presuncoes[tipo]) {
      var pData = LR.presuncoes[tipo];
      if (pData.irpj) presIRPJ = pData.irpj;
      if (pData.csll) presCSLL = pData.csll;
    }

    for (var m = 1; m <= 12; m++) {
      var recMes = temMes ? _n(d["receitaMes" + m]) : _r(receitaBruta / 12);
      var est = null;
      if (LR.calcular.estimativaMensal) {
        try {
          est = LR.calcular.estimativaMensal({
            receitaBruta: recMes,
            tipoAtividade: tipo,
            mes: m,
            financeira: ehFinanceira
          });
        } catch (e) { console.warn('[IMPOST] Erro em estimativaMensal:', e.message); est = null; }
      }
      var irpjMes = est ? (est.irpjDevido || (est.irpj && est.irpj.devido) || 0) : 0;
      var csllMes = est ? (est.csllDevida || (est.csll && est.csll.devida) || 0) : 0;

      // Fallback: calcular estimativa por presunção se o motor não retornou valores
      if (irpjMes === 0 && csllMes === 0 && recMes > 0) {
        var baseIRPJMes = _r(recMes * presIRPJ);
        irpjMes = _r(baseIRPJMes * 0.15 + Math.max(baseIRPJMes - 20000, 0) * 0.10);
        var baseCSLLMes = _r(recMes * presCSLL);
        csllMes = _r(baseCSLLMes * (ehFinanceira ? 0.15 : 0.09));
      }

      totalEstimIRPJ += irpjMes;
      totalEstimCSLL += csllMes;

      meses.push({
        mes: m, receitaBruta: recMes,
        irpjEstimativa: _r(irpjMes),
        csllEstimativa: _r(csllMes),
        totalMes: _r(irpjMes + csllMes)
      });
    }

    // Ajuste anual: IRPJ real - estimativas (usa valores do motor quando disponíveis)
    var irpjRealAnual = irpjRealDoMotor || _r(lucroRealFinal * 0.15 + Math.max(lucroRealFinal - 240000, 0) * 0.10);
    var csllRealAnual = csllRealDoMotor || _r(lucroRealFinal * (ehFinanceira ? 0.15 : 0.09));
    var ajusteIRPJ = _r(irpjRealAnual - totalEstimIRPJ);
    var ajusteCSLL = _r(csllRealAnual - totalEstimCSLL);

    return {
      meses: meses,
      totalEstimativasIRPJ: _r(totalEstimIRPJ),
      totalEstimativasCSLL: _r(totalEstimCSLL),
      totalEstimativas: _r(totalEstimIRPJ + totalEstimCSLL),
      irpjRealAnual: irpjRealAnual,
      csllRealAnual: csllRealAnual,
      ajusteIRPJ: ajusteIRPJ,
      ajusteCSLL: ajusteCSLL,
      ajusteTotal: _r(ajusteIRPJ + ajusteCSLL),
      saldoACompensar: ajusteIRPJ < 0 ? _r(Math.abs(ajusteIRPJ)) : 0,
      saldoACompensarCSLL: ajusteCSLL < 0 ? _r(Math.abs(ajusteCSLL)) : 0,
      saldoACompensarTotal: _r((ajusteIRPJ < 0 ? Math.abs(ajusteIRPJ) : 0) + (ajusteCSLL < 0 ? Math.abs(ajusteCSLL) : 0))
    };
  }

  function _simularSuspensaoReducao(d, receitaBruta, lucroRealFinal, ehFinanceira, irpjRealDoMotor, csllRealDoMotor) {
    if (!LR.calcular.suspensaoReducao) return null;
    var meses = [];
    var irpjPagoAcum = 0;
    var csllPagaAcum = 0;
    var tipo = d.tipoAtividade || "SERVICOS_GERAL";
    var mesesSuspensos = 0;
    var economiaSuspensao = 0;
    var temMes = d.preencherMesAMes === true || d.preencherMesAMes === "true";

    // Presunções para fallback
    var presIRPJ = 0.32;
    var presCSLL = 0.32;
    if (tipo === "COMERCIO_INDUSTRIA" || tipo === "INDUSTRIA" || tipo === "TRANSPORTE_CARGA") {
      presIRPJ = 0.08; presCSLL = 0.12;
    } else if (tipo === "TRANSPORTE_PASSAGEIROS") {
      presIRPJ = 0.16; presCSLL = 0.12;
    } else if (tipo === "SERVICOS_HOSPITALARES") {
      presIRPJ = 0.08; presCSLL = 0.12;
    } else if (tipo === "REVENDA_COMBUSTIVEIS") {
      presIRPJ = 0.016; presCSLL = 0.12;
    }
    if (LR && LR.presuncoes && LR.presuncoes[tipo]) {
      if (LR.presuncoes[tipo].irpj) presIRPJ = LR.presuncoes[tipo].irpj;
      if (LR.presuncoes[tipo].csll) presCSLL = LR.presuncoes[tipo].csll;
    }

    for (var m = 1; m <= 12; m++) {
      var recMes = temMes ? _n(d["receitaMes" + m]) : _r(receitaBruta / 12);
      var est = null;
      try {
        est = LR.calcular.estimativaMensal({ receitaBruta: recMes, tipoAtividade: tipo, mes: m, financeira: ehFinanceira });
      } catch (e) { console.warn('[IMPOST] Erro em estimativaMensal (suspensão):', e.message); }
      var estimIRPJMes = est ? (est.irpjDevido || 0) : 0;
      var estimCSLLMes = est ? (est.csllDevida || 0) : 0;

      // Fallback por presunção
      if (estimIRPJMes === 0 && estimCSLLMes === 0 && recMes > 0) {
        var baseEstIRPJ = _r(recMes * presIRPJ);
        estimIRPJMes = _r(baseEstIRPJ * 0.15 + Math.max(baseEstIRPJ - 20000, 0) * 0.10);
        var baseEstCSLL = _r(recMes * presCSLL);
        estimCSLLMes = _r(baseEstCSLL * (ehFinanceira ? 0.15 : 0.09));
      }

      // IRPJ real acumulado até o mês (proporcional — usa valores do motor quando disponíveis)
      var irpjRealAcum = _r((irpjRealDoMotor || (lucroRealFinal * 0.15 + Math.max(lucroRealFinal - 240000, 0) * 0.10)) * m / 12);
      var csllRealAcum = _r((csllRealDoMotor || (lucroRealFinal * (ehFinanceira ? 0.15 : 0.09))) * m / 12);

      var sr = null;
      try {
        sr = LR.calcular.suspensaoReducao({
          estimativaDevidaMes: estimIRPJMes,
          irpjRealAcumulado: irpjRealAcum,
          irpjPagoAcumulado: irpjPagoAcum,
          estimativaCSLLMes: estimCSLLMes,
          csllRealAcumulada: csllRealAcum,
          csllPagaAcumulada: csllPagaAcum,
          mesReferencia: m
        });
      } catch (e) { console.warn('[IMPOST] Erro em suspensãoRedução:', e.message); sr = null; }

      var irpjPago = sr ? (sr.irpj ? sr.irpj.valorAPagar : estimIRPJMes) : estimIRPJMes;
      var csllPaga = sr ? (sr.csll ? sr.csll.valorAPagar : estimCSLLMes) : estimCSLLMes;
      irpjPagoAcum += irpjPago;
      csllPagaAcum += csllPaga;

      var situacao = sr ? (sr.irpj ? sr.irpj.situacao : "INTEGRAL") : "INTEGRAL";
      if (situacao === "SUSPENSAO") mesesSuspensos++;
      var econMes = sr ? (sr.economiaMes || (estimIRPJMes - irpjPago + estimCSLLMes - csllPaga)) : 0;
      economiaSuspensao += Math.max(econMes, 0);

      meses.push({
        mes: m, situacao: situacao,
        estimativaIRPJ: _r(estimIRPJMes), irpjPago: _r(irpjPago),
        estimativaCSLL: _r(estimCSLLMes), csllPaga: _r(csllPaga),
        economia: _r(Math.max(econMes, 0))
      });
    }

    return {
      meses: meses,
      mesesSuspensos: mesesSuspensos,
      economiaTotalSuspensao: _r(economiaSuspensao)
    };
  }

  function _recomendarApuracao(simTri, simAnual, simSuspensao, d) {
    var totalTri = simTri.total;
    // CORREÇÃO: Comparar custo FINAL real de cada regime, não estimativas vs definitivo.
    // No regime anual, o custo final é irpjRealAnual + csllRealAnual (ajuste anual),
    // não a soma das estimativas mensais.
    var totalAnual = (simAnual.irpjRealAnual || 0) + (simAnual.csllRealAnual || 0);
    // ═══ FIX: Calcular impacto de fluxo de caixa ═══
    var desembolsoEstimativas = simAnual.totalEstimativas || 0;
    var ajusteAnual = (simAnual.ajusteIRPJ || 0) + (simAnual.ajusteCSLL || 0);
    var temSaldoNegativo = ajusteAnual < 0; // empresa pagou mais em estimativas do que deve
    var valorRecuperar = temSaldoNegativo ? Math.abs(ajusteAnual) : 0;
    var temMes = d.preencherMesAMes === true || d.preencherMesAMes === "true";

    // Verificar sazonalidade
    var sazonal = false;
    if (temMes) {
      var recMeses = [];
      for (var m = 1; m <= 12; m++) recMeses.push(_n(d["receitaMes" + m]));
      var maxM = Math.max.apply(null, recMeses);
      var minM = Math.min.apply(null, recMeses.filter(function (v) { return v > 0; }));
      if (minM > 0 && (maxM / minM) > 1.3) sazonal = true;
    }

    // Algum trimestre com prejuízo?
    var temPrejuizoTri = simTri.trimestres.some(function (t) { return t.lucroAjustado < 0; });

    var recomendacao = "";
    var forma = "";
    // CORREÇÃO FALHA #8: Filtro de materialidade — diferenças < R$ 100 são insignificantes
    var MATERIALIDADE = 100;
    var diferencaAbsoluta = Math.abs(totalTri - totalAnual);
    if (sazonal || temPrejuizoTri) {
      forma = "anual";
      recomendacao = "Apuração ANUAL recomendada. ";
      if (sazonal) recomendacao += "Receita sazonal (variação > 30% entre meses) favorece apuração anual. ";
      if (temPrejuizoTri) recomendacao += "Prejuízo em trimestres pode ser compensado dentro do ano na apuração anual. ";
      if (simSuspensao && simSuspensao.mesesSuspensos > 0) {
        recomendacao += "Com suspensão/redução, economia adicional de " + _m(simSuspensao.economiaTotalSuspensao) + " evitando estimativas desnecessárias.";
      }
    } else if (diferencaAbsoluta < MATERIALIDADE) {
      forma = "ambas";
      recomendacao = "O imposto final é equivalente em ambas as formas (diferença de " + _m(diferencaAbsoluta) + ").";
      if (temSaldoNegativo && valorRecuperar > 1000) {
        recomendacao += " ATENÇÃO ao fluxo de caixa: no regime anual por estimativa, o desembolso durante o ano seria de " + _m(desembolsoEstimativas) + ", com " + _m(valorRecuperar) + " a recuperar via PER/DCOMP no ajuste anual. Na apuração trimestral o desembolso é mais previsível.";
        forma = "trimestral";
      } else {
        recomendacao += " Ambas são viáveis — considere a simplicidade operacional.";
      }
    } else if (totalTri < totalAnual) {
      forma = "trimestral";
      recomendacao = "Apuração TRIMESTRAL é mais vantajosa neste caso (economia de " + _m(totalAnual - totalTri) + " vs. estimativa). Lucro estável favorece simplicidade.";
    } else {
      forma = "anual";
      recomendacao = "Apuração ANUAL por estimativa é ligeiramente mais vantajosa (economia de " + _m(totalTri - totalAnual) + ").";
    }

    return {
      formaRecomendada: forma,
      justificativa: recomendacao,
      diferenca: _r(Math.abs(totalTri - totalAnual)),
      sazonal: sazonal,
      temPrejuizoTrimestral: temPrejuizoTri,
      // ═══ FIX: Dados de fluxo de caixa para transparência ═══
      fluxoCaixa: {
        desembolsoEstimativasAnual: _r(desembolsoEstimativas),
        impostoRealAnual: _r(totalAnual),
        ajusteAnual: _r(ajusteAnual),
        valorRecuperarPERDCOMP: _r(valorRecuperar)
      }
    };
  }

  // ═══════════════════════════════════════════════════════════════════════════
  //  CENÁRIOS (pessimista / base / otimista)
  // ═══════════════════════════════════════════════════════════════════════════

  function _gerarCenarios(d, dre, lalur, ehFinanceira, prejuizoFiscal, baseNegCSLL, vedaCompensacao) {
    var variacao = (_n(d.variacaoMargemCenario) || 5) / 100;
    var rb = _n(d.receitaBrutaAnual);
    var cenarios = [];
    var nomes = ["Pessimista", "Base", "Otimista"];
    var fatores = [-variacao, 0, variacao];
    var aliqCSLL = ehFinanceira ? 0.15 : 0.09;
    var pf = vedaCompensacao ? 0 : (prejuizoFiscal || 0);
    var bn = vedaCompensacao ? 0 : (baseNegCSLL || 0);

    for (var c = 0; c < 3; c++) {
      // CORREÇÃO FALHA #6: Usar margem precisa (sem arredondamento) em vez de margemLucro/100
      var margemAjustada = (dre.margemLucroPrecisa !== undefined ? dre.margemLucroPrecisa : (dre.margemLucro / 100)) + fatores[c];
      var lucroC = _r(rb * margemAjustada);
      var lucroAjC = _r(lucroC + lalur.totalAdicoes - lalur.totalExclusoes);

      // Compensação de prejuízo fiscal (30%) — mesmo critério do cálculo principal
      var compPF = 0;
      if (lucroAjC > 0 && pf > 0) {
        compPF = Math.min(_r(lucroAjC * 0.30), pf);
      }
      var lucroRealC = Math.max(lucroAjC - compPF, 0);

      // IRPJ sobre lucro real do cenário
      var irpjC = _r(lucroRealC * 0.15 + Math.max(lucroRealC - 240000, 0) * 0.10);

      // CSLL com compensação de base negativa (30%)
      var compBN = 0;
      if (lucroAjC > 0 && bn > 0) {
        compBN = Math.min(_r(lucroAjC * 0.30), bn);
      }
      var baseCSLLC = Math.max(lucroAjC - compBN, 0);
      var csllC = _r(baseCSLLC * aliqCSLL);

      var pcC = _r(pisCofinsSimplificado(rb, d));
      var issC = _r((_n(d.receitaServicos) || rb) * (_n(d.issAliquota) || 5) / 100);
      var totalC = _r(irpjC + csllC + pcC + issC);
      var aliqC = rb > 0 ? _r(totalC / rb * 100) : 0;

      cenarios.push({
        nome: nomes[c],
        margem: _r(margemAjustada * 100),
        lucro: lucroC,
        irpjCSLL: _r(irpjC + csllC),
        pisCofins: pcC,
        iss: issC,
        cargaTotal: totalC,
        aliquotaEfetiva: aliqC
      });
    }
    return cenarios;
  }

  function pisCofinsSimplificado(rb, d) {
    var isentas = _n(d.receitasIsentas) + _n(d.receitaExportacao) + _n(d.receitasMonofasicas);
    var tributavel = Math.max(rb - isentas, 0);
    var baseCreditos = _calcBaseCreditos();
    var debitos = _r(tributavel * 0.0925);
    var creditos = _r(baseCreditos * 0.0925);
    // CORREÇÃO FALHA #7: Descontar retenções de PIS/COFINS (consistente com cálculo principal)
    var retencoesPisCofins = _n(d.pisRetido) + _n(d.cofinsRetido);
    return _r(Math.max(debitos - creditos - retencoesPisCofins, 0));
  }

  // ═══════════════════════════════════════════════════════════════════════════
  //  FLUXO DE CAIXA TRIBUTÁRIO MENSAL
  // ═══════════════════════════════════════════════════════════════════════════

  function _gerarFluxoCaixaMensal(d, receitaBruta, receitaServicos, issAliquota, irpjAnual, csllAnual, pisCofinsResult, simTrimestralData) {
    var apuracao = d.apuracaoLR || "trimestral";
    var temMes = d.preencherMesAMes === true || d.preencherMesAMes === "true";
    var meses = [];
    var pisAnual = pisCofinsResult.pisAPagar || (pisCofinsResult.aPagar ? pisCofinsResult.aPagar.pis : 0);
    var cofinsAnual = pisCofinsResult.cofinsAPagar || (pisCofinsResult.aPagar ? pisCofinsResult.aPagar.cofins : 0);
    var totalFluxo = 0;

    // ═══ CORREÇÃO FALHA #4: Deduzir retenções proporcionalmente à apuração ═══
    var totalIRRFAnual = _n(d.irrfRetidoPrivado) + _n(d.irrfRetidoPublico);
    var totalCSLLRetAnual = _n(d.csllRetido);
    var retPISMes = _r(_n(d.pisRetido) / 12);
    var retCOFINSMes = _r(_n(d.cofinsRetido) / 12);

    for (var m = 1; m <= 12; m++) {
      var recMes = temMes ? _n(d["receitaMes" + m]) : _r(receitaBruta / 12);
      var fator = receitaBruta > 0 ? recMes / receitaBruta : 1 / 12;
      var recServMes = _r(receitaServicos * fator);

      // PIS/COFINS sempre mensais
      var pisMes = _r(pisAnual / 12);
      var cofinsMes = _r(cofinsAnual / 12);

      // ISS mensal sobre receita de serviços
      var issMes = _r(recServMes * issAliquota / 100);

      // IRPJ/CSLL dependem da apuração
      var irpjMes = 0;
      var csllMes = 0;
      // CORREÇÃO: Retenções de IRRF e CSLL proporcionais ao período de apuração
      var retIRRFMes = 0;
      var retCSLLMes = 0;
      if (apuracao === "trimestral") {
        // Concentrado nos meses 3, 6, 9, 12
        if (m % 3 === 0) {
          var triIdx = (m / 3) - 1;
          if (simTrimestralData && simTrimestralData.trimestres && simTrimestralData.trimestres[triIdx]) {
            irpjMes = _r(simTrimestralData.trimestres[triIdx].irpjTotal);
            csllMes = _r(simTrimestralData.trimestres[triIdx].csll);
          } else {
            irpjMes = _r(irpjAnual / 4);
            csllMes = _r(csllAnual / 4);
          }
          // Retenções concentradas nos meses de pagamento (1/4 cada trimestre)
          retIRRFMes = _r(totalIRRFAnual / 4);
          retCSLLMes = _r(totalCSLLRetAnual / 4);
        }
        // Em meses não-trimestrais, retIRRFMes e retCSLLMes ficam 0
      } else {
        // Estimativa mensal
        irpjMes = _r(irpjAnual / 12);
        csllMes = _r(csllAnual / 12);
        retIRRFMes = _r(totalIRRFAnual / 12);
        retCSLLMes = _r(totalCSLLRetAnual / 12);
      }

      var irpjEfetivo = Math.max(_r(irpjMes - (irpjMes > 0 ? retIRRFMes : 0)), 0);
      var csllEfetivo = Math.max(_r(csllMes - (csllMes > 0 ? retCSLLMes : 0)), 0);
      var pisEfetivo = Math.max(_r(pisMes - retPISMes), 0);
      var cofinsEfetivo = Math.max(_r(cofinsMes - retCOFINSMes), 0);
      var totalMes = _r(irpjEfetivo + csllEfetivo + pisEfetivo + cofinsEfetivo + issMes);
      totalFluxo += totalMes;

      meses.push({
        mes: m,
        irpj: irpjEfetivo,
        csll: csllEfetivo,
        pis: pisEfetivo,
        cofins: cofinsEfetivo,
        iss: issMes,
        total: totalMes,
        irpjBruto: irpjMes,
        csllBruto: csllMes
      });
    }

    // ═══ FIX BUG #3: Usar valores anuais exatos nos totais em vez da soma de parcelas arredondadas ═══
    return {
      meses: meses,
      totalAnual: _r(totalFluxo),
      apuracao: apuracao,
      mediaMensal: _r(totalFluxo / 12),
      // Totais anuais exatos (para evitar diferença de centavos ao somar meses arredondados)
      irpjAnualExato: _r(irpjAnual),
      csllAnualExato: _r(csllAnual),
      pisAnualExato: _r(pisAnual),
      cofinsAnualExato: _r(cofinsAnual)
    };
  }

  // ═══════════════════════════════════════════════════════════════════════════
  //  RENDER RESULTADOS — PLACEHOLDER PARTE 3
  // ═══════════════════════════════════════════════════════════════════════════

  function renderResultados(r) {
    var d = r.dadosEmpresa;
    var cfg = r.config || CONFIG;
    var container = $("wizardContainer");
    var resContainer = $("resultadosContainer");
    if (!resContainer) {
      resContainer = document.createElement("div");
      resContainer.id = "resultadosContainer";
      if (container && container.parentNode) {
        container.parentNode.insertBefore(resContainer, container.nextSibling);
      } else {
        document.body.appendChild(resContainer);
      }
    }
    if (container) container.style.display = "none";
    resContainer.style.display = "";

    var mesesNome = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
    var dataHoje = new Date();
    var dataFormatada = dataHoje.toLocaleDateString("pt-BR");
    var anoBase = d.anoBase || "2026";

    // ═══ Helpers locais ═══
    function _pp(v) { return (v || 0).toFixed(2) + "%"; }
    function _linha(label, valor, artigo, cls) {
      return '<tr class="' + (cls || "") + '"><td>' + label +
        (artigo ? ' <span class="res-artigo">' + artigo + '</span>' : '') +
        '</td><td class="res-valor">' + _m(valor) + '</td></tr>';
    }
    function _linhaPerc(label, valor, cls) {
      return '<tr class="' + (cls || "") + '"><td>' + label + '</td><td class="res-valor">' + _pp(valor) + '</td></tr>';
    }
    function _secao(num, titulo, conteudo) {
      return '<div class="res-section" id="resSecao' + num + '">' +
        '<h2 class="res-section-title"><span class="res-section-num">' + num + '</span> ' + titulo + '</h2>' +
        '<div class="res-section-body">' + conteudo + '</div></div>';
    }

    var html = '';

    // ═══════════════════════════════════════════════════════════════════════
    //  SEÇÃO 1 — CABEÇALHO PROFISSIONAL
    // ═══════════════════════════════════════════════════════════════════════
    var elab = cfg.elaboradoPor || {};
    html += '<div class="res-header">';
    if (cfg.logoURL) {
      html += '<div class="res-logo"><img src="' + cfg.logoURL + '" alt="Logo" style="max-height:60px;"></div>';
    }
    html += '<h1 class="res-title">ESTUDO TRIBUTÁRIO — REGIME DO LUCRO REAL</h1>';
    html += '<div class="res-header-line"></div>';
    html += '<div class="res-company">';
    html += '<div class="res-company-row"><strong>Empresa:</strong> ' + _esc(d.razaoSocial || "—") + '</div>';
    if (d.cnpj) html += '<div class="res-company-row"><strong>CNPJ:</strong> ' + _esc(d.cnpj) + '</div>';
    if (d.cnaePrincipal) html += '<div class="res-company-row"><strong>CNAE:</strong> ' + _esc(d.cnaePrincipal) + '</div>';
    html += '<div class="res-company-row"><strong>UF/Município:</strong> ' + (d.uf || "—") + ' / ' + _esc(d.municipio || "—") + ' — ISS: ' + _pp(_n(d.issAliquota)) + '</div>';
    var formaApurLabel = d.apuracaoLR === "trimestral" ? "Trimestral (definitiva)" : d.apuracaoLR === "anual_suspensao" ? "Anual com Suspensão/Redução" : "Anual por Estimativa";
    html += '<div class="res-company-row"><strong>Forma de Apuração:</strong> ' + formaApurLabel + '</div>';
    html += '<div class="res-company-row"><strong>Ano-Base:</strong> ' + anoBase + '</div>';
    html += '</div>';
    if (elab.nome) {
      html += '<div class="res-elaborador">';
      html += '<div><strong>Elaborado por:</strong> ' + elab.nome;
      if (elab.registro) html += ' — ' + elab.registro;
      html += '</div>';
      if (elab.email || elab.telefone) {
        html += '<div><strong>Contato:</strong> ';
        if (elab.email) html += elab.email;
        if (elab.email && elab.telefone) html += ' | ';
        if (elab.telefone) html += elab.telefone;
        html += '</div>';
      }
      html += '<div><strong>Data:</strong> ' + dataFormatada + '</div>';
      html += '</div>';
    }
    if (cfg.mostrarMarcaImpost) {
      html += '<div class="res-powered">Powered by ' + cfg.nomeProduto + ' v' + VERSAO + ' — ' + cfg.subtitulo + '</div>';
    }
    html += '</div>';

    // MELHORIA: Aviso Legal em destaque no INÍCIO do relatório (antes do painel)
    html += '<div class="res-disclaimer-top" style="margin:16px 0;padding:14px 18px;background:#FFF9E6;border-left:4px solid #F39C12;border-radius:4px;font-size:0.92em;color:#666;">';
    html += '<strong style="color:#F39C12;">⚠️ AVISO LEGAL</strong><br>';
    html += cfg.disclaimer;
    html += '<br><span style="font-size:0.85em;color:#999;">Os valores apresentados são estimativas baseadas nos dados informados e na legislação vigente. ' +
      'Não substitui a análise individualizada de profissional contábil/jurídico habilitado. ' +
      'Todos os cálculos devem ser validados antes de qualquer implementação.</span>';
    html += '</div>';

    // ═══════════════════════════════════════════════════════════════════════
    //  SEÇÃO 2 — PAINEL RESUMO (6 Cards)
    // ═══════════════════════════════════════════════════════════════════════
    var res = r.resumo;
    var s2 = '<div class="res-summary">';
    // Card 1 — Economia total
    s2 += '<div class="res-summary-card res-card-hero">' +
      '<div class="res-card-label">ECONOMIA TOTAL IDENTIFICADA</div>' +
      '<div class="res-card-value res-card-economia">' + _m(res.economiaTotal) + '</div>' +
      '<div class="res-card-sub">' + res.numOportunidades + ' oportunidade' + (res.numOportunidades !== 1 ? 's' : '') + ' identificada' + (res.numOportunidades !== 1 ? 's' : '') + '</div>' +
      '</div>';
    // Card 2 — Carga bruta
    s2 += '<div class="res-summary-card">' +
      '<div class="res-card-label">TOTAL DE TRIBUTOS DEVIDOS (Bruto)</div>' +
      '<div class="res-card-value" title="Soma de IRPJ + CSLL + PIS/COFINS + ISS antes de descontar retenções na fonte">' + _m(res.cargaBruta) + '</div>' +
      '<div class="res-card-sub">Mensal: ' + _m(res.cargaBrutaMensal) + '</div>' +
      '</div>';
    // Card 3 — Alíquota efetiva
    s2 += '<div class="res-summary-card">' +
      '<div class="res-card-label">ALÍQUOTA EFETIVA GLOBAL</div>' +
      '<div class="res-card-value">' + _pp(res.aliquotaEfetiva) + '</div>' +
      '<div class="res-card-sub">Carga / Receita Bruta</div>' +
      '</div>';
    // Card 4 — Carga otimizada
    s2 += '<div class="res-summary-card">' +
      '<div class="res-card-label">CARGA OTIMIZADA</div>' +
      '<div class="res-card-value res-card-economia">' + _m(res.cargaOtimizada) + '</div>' +
      '<div class="res-card-sub">Alíquota: ' + _pp(res.aliquotaOtimizada) + '</div>' +
      '</div>';
    // Card 5 — Retenções
    s2 += '<div class="res-summary-card">' +
      '<div class="res-card-label">RETENÇÕES A COMPENSAR</div>' +
      '<div class="res-card-value">' + _m(res.totalRetencoes) + '</div>' +
      '<div class="res-card-sub">IRRF + CSRF + ISS retido</div>' +
      '</div>';
    // Card 6 — Saldo efetivo
    s2 += '<div class="res-summary-card">' +
      '<div class="res-card-label">SALDO FEDERAL A PAGAR</div>' +
      '<div class="res-card-value ' + (res.saldoEfetivo < 0 ? 'res-card-economia' : '') + '">' + _m(res.saldoEfetivo) + '</div>' +
      '<div class="res-card-sub">' + (res.saldoEfetivo < 0 ? 'Saldo negativo — PER/DCOMP' : 'Federal — sem ISS de ' + _m(res.issAnual || 0)) + '</div>' +
      '</div>';
    // Card 7 — Total a Pagar (Líquido de Retenções)
    s2 += '<div class="res-summary-card">' +
      '<div class="res-card-label">TOTAL A PAGAR (Líquido de Retenções)</div>' +
      '<div class="res-card-value" title="Valor efetivo a desembolsar após compensação de retenções sofridas (IRRF, PIS, COFINS e CSLL retidos)">' + _m(res.desembolsoTotal) + '</div>' +
      '<div class="res-card-sub">Inclui ISS municipal de ' + _m(res.issAnual || 0) + '</div>' +
      '</div>';
    s2 += '</div>';
    html += _secao(2, 'Painel Resumo Executivo', s2);

    // ═══════════════════════════════════════════════════════════════════════
    //  SEÇÃO 3 — DRE + LALUR
    // ═══════════════════════════════════════════════════════════════════════
    var dre = r.dre;
    var lalur = r.lalur;
    var s3 = '<div class="res-dre">';
    s3 += '<h3>DEMONSTRAÇÃO DO RESULTADO DO EXERCÍCIO (DRE)</h3>';
    s3 += '<table class="res-table res-table-dre">';
    s3 += _linha('Receita Bruta', dre.receitaBruta, '', '');
    // CORREÇÃO: Deduções da receita = débitos PIS/COFINS (antes de créditos),
    // pois créditos reduzem o imposto a pagar, não a receita líquida
    var deducoesReceita = r.pisCofins
      ? _r((r.pisCofins.debitoPIS || 0) + (r.pisCofins.debitoCOFINS || 0))
      : (dre.pisCofinsDebitos || 0);
    s3 += _linha('(-) PIS/COFINS sobre Receita', deducoesReceita, 'Lei 10.637/02 + 10.833/03', 'res-sub');
    var receitaLiqDisplay = _r(dre.receitaBruta - deducoesReceita);
    s3 += _linha('= RECEITA LÍQUIDA', receitaLiqDisplay, '', 'res-subtotal');
    // Custos Totais (já inclui pessoal/folha, CMV e serviços de terceiros)
    s3 += _linha('(-) Custos Totais', dre.custosTotais, '', 'res-sub');
    // Sub-itens informativos da composição dos custos
    if (dre.folhaPagamento > 0) s3 += _linha('&emsp;Folha de Pagamento', dre.folhaPagamento, '', 'res-sub');
    if (dre.cmv > 0) s3 += _linha('&emsp;CMV / Custos Operacionais', dre.cmv, '', 'res-sub');
    if (dre.servicosTerceiros > 0) s3 += _linha('&emsp;Serviços de Terceiros', dre.servicosTerceiros, '', 'res-sub');
    // CORREÇÃO BUG 2: Lucro Bruto = Receita Líquida - Custos (não Receita Bruta - Custos)
    s3 += _linha('= LUCRO BRUTO', dre.lucroBruto || _r(receitaLiqDisplay - dre.custosTotais), '', 'res-subtotal');
    // Despesas operacionais (pessoal já nos custos — não duplicar)
    s3 += _linha('(-) Despesas Administrativas e Operacionais', dre.despesasTotais, '', 'res-sub');
    // CORREÇÃO BUG 3: Depreciação subtraída no Lucro Líquido (já incluída no cálculo via dre.lucroLiquido)
    if (dre.depreciacao > 0) s3 += _linha('(-) Depreciação e Amortização', dre.depreciacao, 'Art. 305-329 RIR/2018', 'res-sub');
    if (dre.receitaFinanceiras > 0) s3 += _linha('(+) Receitas Financeiras', dre.receitaFinanceiras, '', 'res-sub');
    s3 += '<tr class="res-total"><td><strong>= LUCRO LÍQUIDO DO EXERCÍCIO</strong></td><td class="res-valor"><strong>' + _m(dre.lucroLiquido) + '</strong></td></tr>';
    s3 += '<tr class="res-info-row"><td colspan="2">Margem de Lucro: ' + _pp(dre.margemLucro) + '</td></tr>';
    s3 += '</table>';

    // LALUR
    s3 += '<h3>LIVRO DE APURAÇÃO DO LUCRO REAL (LALUR — Parte A)</h3>';
    s3 += '<table class="res-table res-table-lalur">';
    s3 += _linha('Lucro Líquido do Exercício', lalur.lucroLiquido, '', '');
    if (lalur.adicoes && lalur.adicoes.length > 0) {
      s3 += '<tr class="res-group-header"><td colspan="2"><strong>(+) ADIÇÕES:</strong></td></tr>';
      lalur.adicoes.forEach(function (a) {
        var tipoTag = a.tipo === 'T' ? ' <span class="res-tag-tipo-t">[Temp.]</span>' : a.tipo === 'C' ? ' <span class="res-tag-tipo-c">[Cond.]</span>' : '';
        s3 += _linha('    ' + a.desc + tipoTag, a.valor, a.artigo, 'res-sub');
      });
      s3 += _linha('= Total de Adições', lalur.totalAdicoes, '', 'res-subtotal');
    }
    if (lalur.exclusoes && lalur.exclusoes.length > 0) {
      s3 += '<tr class="res-group-header"><td colspan="2"><strong>(-) EXCLUSÕES:</strong></td></tr>';
      lalur.exclusoes.forEach(function (e) {
        s3 += _linha('    ' + e.desc, e.valor, e.artigo, 'res-sub');
      });
      s3 += _linha('= Total de Exclusões', lalur.totalExclusoes, '', 'res-subtotal');
    }
    s3 += _linha('= LUCRO ANTES DA COMPENSAÇÃO', lalur.lucroAjustado, '', 'res-subtotal');
    // Compensação de prejuízos
    if (r.compensacao && r.compensacao.resumo) {
      var comp = r.compensacao.resumo;
      if (comp.compensacaoEfetiva && comp.compensacaoEfetiva.prejuizoOperacional > 0) {
        s3 += _linha('(-) Compensação Prejuízo Fiscal (30%)', comp.compensacaoEfetiva.prejuizoOperacional, 'Art. 579-586 RIR/2018', 'res-sub res-economia');
      }
    }
    // ═══ FIX: Exibir compensação de prejuízo no LALUR do relatório ═══
    if (lalur.compensacaoPrejuizo > 0) {
      s3 += _linha('(-) Compensação de Prejuízos Fiscais (trava 30%)', -lalur.compensacaoPrejuizo, 'Art. 580-582', 'res-sub res-economia');
    }
    if (lalur.compensacaoBaseNegativa > 0 && lalur.compensacaoBaseNegativa !== lalur.compensacaoPrejuizo) {
      s3 += _linha('(-) Compensação Base Negativa CSLL (trava 30%)', -lalur.compensacaoBaseNegativa, 'Art. 580', 'res-sub res-economia');
    }
    if (lalur.lucroRealFinal !== undefined && lalur.lucroRealFinal !== lalur.lucroAjustado) {
      s3 += _linha('= LUCRO REAL (Base IRPJ)', lalur.lucroRealFinal, '', 'res-total');
    }
    s3 += '<tr class="res-total res-destaque"><td><strong>= LUCRO REAL</strong></td><td class="res-valor"><strong>' + _m(r.lucroRealFinal) + '</strong></td></tr>';
    s3 += '</table>';
    // CORREÇÃO RJ-04: Nota sobre distinção de prejuízos operacionais vs não-operacionais
    if (r.compensacao && r.compensacao.resumo && r.compensacao.resumo.totalCompensado > 0) {
      s3 += '<div class="res-alerta res-alerta-info" style="margin-top:8px;"><span class="res-alerta-icon">&#x1F535;</span>' +
        '<strong>Nota sobre compensação de prejuízos:</strong> ' +
        'A trava de 30% foi aplicada corretamente. Contudo, observe que prejuízos <em>não-operacionais</em> ' +
        'só podem ser compensados com lucros não-operacionais futuros (Art. 511, RIR/2018). ' +
        'Este estudo trata o saldo de prejuízo informado como uma massa única. ' +
        'Se houver parcela de prejuízo não-operacional, a compensação efetiva pode ser menor. ' +
        'Consulte a ECF para segregação.</div>';
    }
    s3 += '</div>';
    html += _secao(3, 'Demonstração do Resultado e Apuração do Lucro Real', s3);

    // ═══════════════════════════════════════════════════════════════════════
    //  SEÇÃO NOVA 1 — DIAGNÓSTICO DE DESPESAS COM LIMITES LEGAIS
    // ═══════════════════════════════════════════════════════════════════════
    var vdl = r.validacaoDespesasLimites;
    if (vdl && (vdl.doacoes || vdl.previdencia || vdl.royalties)) {
      var sN1 = '';
      var houveExcesso = false;
      sN1 += '<table class="res-table"><thead><tr><th>Despesa</th><th>Valor Informado</th><th>Limite Legal</th><th>Excesso Indedutível</th></tr></thead><tbody>';
      if (vdl.doacoes) {
        var limDoacoes = (LR.despesasComLimites && LR.despesasComLimites.doacoes) ? LR.despesasComLimites.doacoes : {};
        var excD = (vdl.doacoes.excesso || vdl.doacoes.excedenteTotal || 0);
        if (excD > 0) houveExcesso = true;
        sN1 += '<tr' + (excD > 0 ? ' style="color:#E74C3C;"' : '') + '><td>Doações (operacionais + OSCIP + ensino)';
        if (limDoacoes.operacionais) sN1 += ' <span class="res-artigo">' + limDoacoes.operacionais.artigo + ' — limite ' + ((limDoacoes.operacionais.limite || 0.02) * 100) + '% do lucro oper.</span>';
        sN1 += '</td><td class="res-valor">' + _m(vdl.doacoes.totalInformado || 0) + '</td><td class="res-valor">' + _m(vdl.doacoes.limiteCalculado || vdl.doacoes.limiteTotal || 0) + '</td><td class="res-valor">' + (excD > 0 ? '⚠️ ' + _m(excD) : '✅ —') + '</td></tr>';
      }
      if (vdl.previdencia) {
        var limPrev = (LR.despesasComLimites && LR.despesasComLimites.previdenciaComplementar) ? LR.despesasComLimites.previdenciaComplementar : {};
        var excP = (vdl.previdencia.excesso || vdl.previdencia.excedente || 0);
        if (excP > 0) houveExcesso = true;
        sN1 += '<tr' + (excP > 0 ? ' style="color:#E74C3C;"' : '') + '><td>Previdência Complementar Patronal';
        if (limPrev.artigo) sN1 += ' <span class="res-artigo">' + limPrev.artigo + ' — limite ' + ((limPrev.limite || 0.20) * 100) + '% da folha</span>';
        sN1 += '</td><td class="res-valor">' + _m(vdl.previdencia.contribuicao || vdl.previdencia.totalInformado || 0) + '</td><td class="res-valor">' + _m(vdl.previdencia.limite || vdl.previdencia.limiteCalculado || 0) + '</td><td class="res-valor">' + (excP > 0 ? '⚠️ ' + _m(excP) : '✅ —') + '</td></tr>';
      }
      if (vdl.royalties) {
        var limRoy = (LR.despesasComLimites && LR.despesasComLimites.royalties) ? LR.despesasComLimites.royalties : {};
        var excR = (vdl.royalties.excesso || vdl.royalties.excedente || 0);
        if (excR > 0) houveExcesso = true;
        sN1 += '<tr' + (excR > 0 ? ' style="color:#E74C3C;"' : '') + '><td>Royalties e Assistência Técnica';
        if (limRoy.artigo) sN1 += ' <span class="res-artigo">' + limRoy.artigo + ' — limite ' + ((limRoy.limiteGeral || 0.05) * 100) + '% da receita líq.</span>';
        sN1 += '</td><td class="res-valor">' + _m(vdl.royalties.royaltiesPagos || vdl.royalties.totalInformado || 0) + '</td><td class="res-valor">' + _m(vdl.royalties.limite || vdl.royalties.limiteCalculado || 0) + '</td><td class="res-valor">' + (excR > 0 ? '⚠️ ' + _m(excR) : '✅ —') + '</td></tr>';
      }
      sN1 += '</tbody></table>';
      if (houveExcesso) {
        sN1 += '<div class="res-alerta res-alerta-aviso"><span class="res-alerta-icon">&#x1F7E1;</span>Excessos identificados foram adicionados automaticamente ao LALUR como despesas indedutíveis.</div>';
      } else {
        sN1 += '<div class="res-alerta res-alerta-economia"><span class="res-alerta-icon">&#x1F7E2;</span>✅ Todas as despesas dentro dos limites legais.</div>';
      }
      html += _secao('A', 'Diagnóstico de Despesas com Limites Legais', sN1);
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  SEÇÃO NOVA 2 — DESPESAS INDEDUTÍVEIS IDENTIFICADAS
    // ═══════════════════════════════════════════════════════════════════════
    var despInded = r.despesasIndedutivelDetalhe;
    if (despInded && despInded.length > 0) {
      var sN2 = '';
      var totalInded = 0;
      var totalImpacto = 0;
      sN2 += '<table class="res-table"><thead><tr><th>Despesa</th><th>Artigo</th><th>Valor Informado</th><th>Impacto Fiscal (34%)</th></tr></thead><tbody>';
      despInded.forEach(function (di) {
        var impacto = _r((di.valor || 0) * 0.34);
        totalInded += (di.valor || 0);
        totalImpacto += impacto;
        // Lookup da descrição no mapeamento
        var descMapa = di.descricao || di.desc || '';
        var artigoMapa = di.artigo || '';
        if (!descMapa && LR.despesasIndedutiveis) {
          for (var dii = 0; dii < LR.despesasIndedutiveis.length; dii++) {
            if (LR.despesasIndedutiveis[dii].id === di.id) {
              descMapa = LR.despesasIndedutiveis[dii].descricao;
              artigoMapa = LR.despesasIndedutiveis[dii].artigo;
              break;
            }
          }
        }
        sN2 += '<tr><td>' + descMapa + '</td><td><span class="res-artigo">' + artigoMapa + '</span></td><td class="res-valor">' + _m(di.valor) + '</td><td class="res-valor" style="color:#E74C3C;">' + _m(impacto) + '</td></tr>';
      });
      sN2 += '<tr class="res-total"><td colspan="2"><strong>Total de adições por despesas indedutíveis</strong></td><td class="res-valor"><strong>' + _m(totalInded) + '</strong></td><td class="res-valor" style="color:#E74C3C;"><strong>' + _m(totalImpacto) + '</strong></td></tr>';
      sN2 += '</tbody></table>';
      html += _secao('B', 'Despesas Indedutíveis Identificadas', sN2);
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  SEÇÃO NOVA 3 — ANÁLISE DE SUBCAPITALIZAÇÃO
    // ═══════════════════════════════════════════════════════════════════════
    if (r.subcapResult) {
      var sN3 = '';
      if (r.subcapResult.excedeu) {
        sN3 += '<div class="res-alerta res-alerta-critico"><span class="res-alerta-icon">&#x1F534;</span><strong>ATENÇÃO:</strong> Juros indedutíveis por subcapitalização: <strong>' + _m(r.subcapResult.jurosIndedutiveis || 0) + '</strong></div>';
        // Detalhamento dos limites violados
        sN3 += '<table class="res-table"><thead><tr><th>Limite</th><th>Regra</th><th>Status</th></tr></thead><tbody>';
        if (LR.subcapitalizacao) {
          if (LR.subcapitalizacao.vinculadaComParticipacao) {
            sN3 += '<tr><td>Vinculada c/ participação <span class="res-artigo">' + LR.subcapitalizacao.vinculadaComParticipacao.artigo + '</span></td><td>' + LR.subcapitalizacao.vinculadaComParticipacao.descricao + '</td><td style="color:#E74C3C;">Excedido</td></tr>';
          }
          if (LR.subcapitalizacao.paraisoFiscal) {
            sN3 += '<tr><td>Paraíso Fiscal <span class="res-artigo">' + LR.subcapitalizacao.paraisoFiscal.artigo + '</span></td><td>' + LR.subcapitalizacao.paraisoFiscal.descricao + '</td><td>' + (r.subcapResult.paraisoFiscalExcedeu ? '<span style="color:#E74C3C;">Excedido</span>' : '✅ OK') + '</td></tr>';
          }
        }
        sN3 += '</tbody></table>';
        sN3 += '<div class="res-alerta res-alerta-info"><span class="res-alerta-icon">&#x1F535;</span><strong>Base Legal:</strong> Art. 249-251 do RIR/2018. <strong>Ação recomendada:</strong> Reestruturar dívida para reduzir proporção dívida/PL.</div>';
      } else {
        sN3 += '<div class="res-alerta res-alerta-economia"><span class="res-alerta-icon">&#x1F7E2;</span>✅ Dívidas com vinculadas dentro dos limites de subcapitalização.</div>';
      }
      html += _secao('C', 'Análise de Subcapitalização', sN3);
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  SEÇÃO NOVA 4 — ALERTAS DE COMPLIANCE E OMISSÃO DE RECEITA
    // ═══════════════════════════════════════════════════════════════════════
    if (r.omissaoResult && r.omissaoResult.indicadores && r.omissaoResult.indicadores.length > 0) {
      var sN4 = '';
      r.omissaoResult.indicadores.forEach(function (ind) {
        var gravIcon = ind.gravidade === 'CRITICO' ? '&#x1F534;' : ind.gravidade === 'ALTO' ? '&#x1F7E0;' : '&#x1F7E1;';
        var gravCls = ind.gravidade === 'CRITICO' ? 'res-alerta-critico' : ind.gravidade === 'ALTO' ? 'res-alerta-aviso' : 'res-alerta-info';
        // Lookup no mapeamento
        var descOm = ind.descricao || '';
        var artigoOm = ind.artigo || '';
        if (LR.indicadoresOmissao) {
          for (var oi = 0; oi < LR.indicadoresOmissao.length; oi++) {
            if (LR.indicadoresOmissao[oi].id === ind.id) {
              descOm = descOm || LR.indicadoresOmissao[oi].descricao;
              artigoOm = artigoOm || LR.indicadoresOmissao[oi].artigo;
              break;
            }
          }
        }
        sN4 += '<div class="res-alerta ' + gravCls + '"><span class="res-alerta-icon">' + gravIcon + '</span>';
        sN4 += '<strong>' + descOm + '</strong>';
        if (artigoOm) sN4 += ' <span class="res-artigo">' + artigoOm + '</span>';
        if (ind.resolucao) sN4 += '<br><em>Resolução: ' + ind.resolucao + '</em>';
        sN4 += '</div>';
      });
      html += _secao('D', 'Alertas de Compliance e Omissão de Receita', sN4);
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  SEÇÃO NOVA 5 — AMORTIZAÇÃO, EXAUSTÃO E PRÉ-OPERACIONAIS
    // ═══════════════════════════════════════════════════════════════════════
    if (r.goodwillResult || r.exaustaoResult || r.preOperacionalResult) {
      var sN5 = '';
      sN5 += '<table class="res-table"><thead><tr><th>Item</th><th>Valor Original</th><th>Dedução Anual</th><th>Economia Fiscal (34%)</th><th>Base Legal</th></tr></thead><tbody>';
      if (r.goodwillResult) {
        var gwDeducao = r.goodwillResult.amortizacaoAnual || r.goodwillResult.deducaoAnual || 0;
        var gwEcon = _r(gwDeducao * 0.34);
        sN5 += '<tr><td>Goodwill (ágio por rentabilidade)</td><td class="res-valor">' + _m(r.goodwillResult.valorGoodwill || _n(d.valorGoodwill)) + '</td><td class="res-valor">' + _m(gwDeducao) + '</td><td class="res-valor res-economia">' + _m(gwEcon) + '</td><td><span class="res-artigo">Lei 12.973/2014, Art. 20-22</span></td></tr>';
      }
      if (r.exaustaoResult) {
        var exDeducao = r.exaustaoResult.exaustaoAnual || r.exaustaoResult.deducaoAnual || 0;
        var exEcon = _r(exDeducao * 0.34);
        sN5 += '<tr><td>Exaustão de Recursos Naturais</td><td class="res-valor">' + _m(r.exaustaoResult.custoAquisicao || _n(d.valorRecursosNaturais)) + '</td><td class="res-valor">' + _m(exDeducao) + '</td><td class="res-valor res-economia">' + _m(exEcon) + '</td><td><span class="res-artigo">Art. 334-337 RIR/2018</span></td></tr>';
      }
      if (r.preOperacionalResult) {
        var poDeducao = r.preOperacionalResult.amortizacaoAnual || r.preOperacionalResult.deducaoAnual || 0;
        var poEcon = _r(poDeducao * 0.34);
        sN5 += '<tr><td>Despesas Pré-Operacionais</td><td class="res-valor">' + _m(r.preOperacionalResult.valorTotal || _n(d.despesasPreOperacionais)) + '</td><td class="res-valor">' + _m(poDeducao) + '</td><td class="res-valor res-economia">' + _m(poEcon) + '</td><td><span class="res-artigo">Art. 11 Lei 12.973</span></td></tr>';
      }
      sN5 += '</tbody></table>';
      html += _secao('E', 'Amortização, Exaustão e Pré-Operacionais', sN5);
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  SEÇÃO 4 — CÁLCULO DETALHADO DE CADA TRIBUTO
    // ═══════════════════════════════════════════════════════════════════════
    var s4 = '<div class="res-detail-grid">';

    // 4.1 — IRPJ
    s4 += '<div class="res-detail-card">';
    s4 += '<h3>4.1 — IRPJ <span class="res-artigo">Art. 225 do RIR/2018</span></h3>';
    s4 += '<table class="res-table">';
    // CORREÇÃO FALHA #1: Exibir lucroAjustado (ANTES compensação), não lucroRealFinal (APÓS)
    var lucroAjustadoDisplay = (r.lalur && r.lalur.lucroAjustado !== undefined) ? r.lalur.lucroAjustado : r.lucroRealFinal;
    var baseIRPJDisplay = (r.irpj && r.irpj.lucroReal !== undefined) ? r.irpj.lucroReal : r.lucroRealFinal;
    s4 += _linha('Lucro Ajustado (antes compensação)', lucroAjustadoDisplay, '', '');
    if (r.irpj && r.irpj.compensacaoPrejuizo > 0) {
      s4 += _linha('(-) Compensação de Prejuízo Fiscal (30%)', r.irpj.compensacaoPrejuizo, 'Art. 580-586', 'res-sub res-economia');
    } else if (r.compensacao && r.compensacao.resumo && r.compensacao.resumo.totalCompensado > 0) {
      s4 += _linha('(-) Compensação de Prejuízo Fiscal (30%)', r.compensacao.resumo.totalCompensado, 'Art. 580-586', 'res-sub res-economia');
    }
    s4 += _linha('= Lucro Real (base de cálculo IRPJ)', baseIRPJDisplay, '', 'res-subtotal');
    if (r.irpj) {
      // CORREÇÃO FALHA #9: Usar baseIRPJDisplay (base de cálculo correta) no fallback, evitando centavo de arredondamento
      s4 += _linha('IRPJ Normal (15%)', r.irpj.irpjNormal || _r(baseIRPJDisplay * 0.15), 'Art. 225', '');
      s4 += _linha('Adicional (10% sobre excedente R$ 240.000)', r.irpj.adicional || r.irpj.irpjAdicional || 0, 'Art. 228', '');
      s4 += _linha('= IRPJ Bruto', r.irpjAntesReducao, '', 'res-subtotal');
      if (r.irpj.deducaoIncentivos > 0 || (r.incentivosFiscais && r.incentivosFiscais.totalDeducaoFinal > 0)) {
        s4 += _linha('(-) Deduções por Incentivos Fiscais', r.irpj.deducaoIncentivos || r.incentivosFiscais.totalDeducaoFinal, 'Art. 641', 'res-sub res-economia');
      }
      if (r.reducaoSUDAM > 0) {
        s4 += _linha('(-) Redução SUDAM/SUDENE (75%)', r.reducaoSUDAM, 'Art. 627-637', 'res-sub res-economia');
      }
      s4 += _linha('= IRPJ após Reduções', r.irpjAposReducao, '', 'res-subtotal');
      var totalIRRF = _n(d.irrfRetidoPrivado) + _n(d.irrfRetidoPublico);
      if (totalIRRF > 0) {
        s4 += _linha('(-) IRRF Retido na Fonte', totalIRRF, '', 'res-sub');
      }
      var estimIRPJ = _n(d.estimativasIRPJPagas);
      if (estimIRPJ > 0) {
        s4 += _linha('(-) Estimativas de IRPJ Pagas', estimIRPJ, '', 'res-sub');
      }
      var saldoIRPJ = _r(r.irpjAposReducao - totalIRRF - estimIRPJ);
      s4 += '<tr class="res-total"><td><strong>' + (saldoIRPJ >= 0 ? '= IRPJ A PAGAR' : '= SALDO NEGATIVO IRPJ') + '</strong></td><td class="res-valor"><strong>' + _m(saldoIRPJ) + '</strong></td></tr>';
    }
    s4 += '</table></div>';

    // 4.2 — CSLL
    s4 += '<div class="res-detail-card">';
    s4 += '<h3>4.2 — CSLL <span class="res-artigo">Lei 7.689/1988</span></h3>';
    s4 += '<table class="res-table">';
    if (r.csll) {
      var aliqCSLL = r.csll.aliquota || (d.ehFinanceira ? 0.15 : 0.09);
      // CORREÇÃO BUG 4: Exibir base pós-compensação para CSLL
      var baseCSLLDisplay = (r.csll.baseCalculo !== undefined) ? r.csll.baseCalculo : r.baseCSLLFinal;
      s4 += _linha('Base de cálculo CSLL', baseCSLLDisplay, '', '');
      if (r.csll.compensacao > 0) {
        s4 += _linha('(-) Compensação Base Negativa (30%)', r.csll.compensacao, 'Art. 580-586', 'res-sub res-economia');
      } else if (r.compensacao && r.compensacao.resumo && r.compensacao.resumo.compensacaoEfetiva && r.compensacao.resumo.compensacaoEfetiva.baseNegativaCSLL > 0) {
        s4 += _linha('(-) Compensação Base Negativa (30%)', r.compensacao.resumo.compensacaoEfetiva.baseNegativaCSLL, 'Art. 580-586', 'res-sub res-economia');
      }
      // CORREÇÃO BUG 5: Usar _linhaPerc em vez de _linha para alíquota (evita prefixo "R$" em valor percentual)
      s4 += _linhaPerc('Alíquota CSLL', aliqCSLL * 100, '');
      s4 += '<tr><td>CSLL (' + _pp(aliqCSLL * 100) + ')</td><td class="res-valor">' + _m(r.csll.csllDevida) + '</td></tr>';
      var csllRetida = _n(d.csllRetido);
      if (csllRetida > 0) s4 += _linha('(-) CSLL Retida na Fonte', csllRetida, '', 'res-sub');
      var estimCSLL = _n(d.estimativasCSLLPagas);
      if (estimCSLL > 0) s4 += _linha('(-) Estimativas CSLL Pagas', estimCSLL, '', 'res-sub');
      var saldoCSLL = _r(r.csll.csllDevida - csllRetida - estimCSLL);
      s4 += '<tr class="res-total"><td><strong>' + (saldoCSLL >= 0 ? '= CSLL A PAGAR' : '= SALDO NEGATIVO CSLL') + '</strong></td><td class="res-valor"><strong>' + _m(saldoCSLL) + '</strong></td></tr>';
    }
    s4 += '</table></div>';

    // 4.3 — PIS/COFINS
    s4 += '<div class="res-detail-card res-detail-wide">';
    s4 += '<h3>4.3 — PIS/COFINS Não-Cumulativo <span class="res-artigo">Lei 10.637/02 + Lei 10.833/03</span></h3>';
    s4 += '<table class="res-table">';
    if (r.pisCofins) {
      var pc = r.pisCofins;
      s4 += _linha('Receita Bruta', dre.receitaBruta, '', '');
      if (pc.receitasIsentas > 0) s4 += _linha('(-) Receitas Isentas/Suspensas', pc.receitasIsentas, '', 'res-sub');
      s4 += _linha('= Receita Tributável', pc.receitaTributavel || _r(dre.receitaBruta - (pc.receitasIsentas || 0)), '', 'res-subtotal');
      s4 += '<tr class="res-group-header"><td colspan="2"><strong>DÉBITOS:</strong></td></tr>';
      s4 += _linha('    PIS (1,65%)', pc.debitoPIS || pc.debitos.pis, 'Art. 2º, Lei 10.637/02', 'res-sub');
      s4 += _linha('    COFINS (7,60%)', pc.debitoCOFINS || pc.debitos.cofins, 'Art. 2º, Lei 10.833/03', 'res-sub');
      s4 += _linha('= Total Débitos', _r((pc.debitoPIS || pc.debitos.pis || 0) + (pc.debitoCOFINS || pc.debitos.cofins || 0)), '', 'res-subtotal');
      s4 += '<tr class="res-group-header"><td colspan="2"><strong>CRÉDITOS:</strong></td></tr>';
      // Listar créditos detalhados se disponíveis
      if (pc.creditosDetalhe && pc.creditosDetalhe.length > 0) {
        pc.creditosDetalhe.forEach(function (cr) {
          if (cr.valor > 0) s4 += _linha('    ' + cr.descricao, cr.valor, cr.artigo || 'Art. 3º', 'res-sub res-economia');
        });
      } else {
        s4 += _linha('    Crédito PIS (1,65%)', pc.creditoPIS || pc.creditos.pis, 'Art. 3º', 'res-sub res-economia');
        s4 += _linha('    Crédito COFINS (7,60%)', pc.creditoCOFINS || pc.creditos.cofins, 'Art. 3º', 'res-sub res-economia');
      }
      s4 += _linha('= Total Créditos', _r((pc.creditoPIS || pc.creditos.pis || 0) + (pc.creditoCOFINS || pc.creditos.cofins || 0)), '', 'res-subtotal res-economia');
      // Retenções PIS/COFINS
      var pisRetido = _n(d.pisRetido);
      var cofinsRetido = _n(d.cofinsRetido);
      if (pisRetido > 0) s4 += _linha('(-) PIS Retido na Fonte', pisRetido, '', 'res-sub');
      if (cofinsRetido > 0) s4 += _linha('(-) COFINS Retido na Fonte', cofinsRetido, '', 'res-sub');
      var pisCofinsLiquido = _r(Math.max(pc.totalAPagarBruto - pisRetido - cofinsRetido, 0));
      s4 += '<tr class="res-total"><td><strong>' + (pisCofinsLiquido >= 0 ? '= PIS/COFINS A PAGAR' : '= SALDO CREDOR PIS/COFINS') + '</strong></td><td class="res-valor"><strong>' + _m(pisCofinsLiquido) + '</strong></td></tr>';
      s4 += '<tr class="res-info-row"><td colspan="2">Alíquota Efetiva: ' + _pp(_r(pisCofinsLiquido / (dre.receitaBruta || 1) * 100)) + ' (nominal: 9,25%)</td></tr>';
    }
    s4 += '</table></div>';

    // 4.4 — ISS
    s4 += '<div class="res-detail-card">';
    s4 += '<h3>4.4 — ISS <span class="res-artigo">LC 116/2003</span></h3>';
    s4 += '<table class="res-table">';
    if (r.iss) {
      s4 += _linha('Receita de Serviços', r.iss.receitaServicos, '', '');
      s4 += '<tr><td>Município: ' + r.iss.municipio + '</td><td class="res-valor">Alíquota: ' + _pp(r.iss.aliquota) + '</td></tr>';
      s4 += '<tr class="res-total"><td><strong>= ISS Anual</strong></td><td class="res-valor"><strong>' + _m(r.iss.issAnual) + '</strong></td></tr>';
      s4 += '<tr class="res-info-row"><td><strong>ISS Mensal</strong></td><td class="res-valor">' + _m(r.iss.issMensal) + '</td></tr>';
      var issRetido = _n(d.issRetido);
      if (issRetido > 0) s4 += _linha('(-) ISS Retido na Fonte', issRetido, '', 'res-sub');
    }
    s4 += '</table></div>';

    s4 += '</div>'; // fecha res-detail-grid
    html += _secao(4, 'Cálculo Detalhado de Cada Tributo', s4);

    // ═══════════════════════════════════════════════════════════════════════
    //  SEÇÃO 5 — COMPOSIÇÃO DA CARGA TRIBUTÁRIA
    // ═══════════════════════════════════════════════════════════════════════
    var comp = r.composicao;
    var s5 = '';

    // Barra visual
    var totalComp = (comp.irpj.valor || 0) + (comp.csll.valor || 0) + (comp.pisCofins.valor || 0) + (comp.iss.valor || 0);
    if (totalComp > 0) {
      var pIRPJ = _r((comp.irpj.valor / totalComp) * 100);
      var pCSLL = _r((comp.csll.valor / totalComp) * 100);
      var pPC = _r((comp.pisCofins.valor / totalComp) * 100);
      var pISS = _r(100 - pIRPJ - pCSLL - pPC);

      s5 += '<div class="res-composicao-visual">';
      s5 += '<div class="res-comp-bar">';
      if (pIRPJ > 0) s5 += '<div class="res-comp-seg" style="width:' + pIRPJ + '%;background:#E74C3C;" title="IRPJ: ' + _pp(pIRPJ) + '">IRPJ</div>';
      if (pCSLL > 0) s5 += '<div class="res-comp-seg" style="width:' + pCSLL + '%;background:#F39C12;" title="CSLL: ' + _pp(pCSLL) + '">CSLL</div>';
      if (pPC > 0) s5 += '<div class="res-comp-seg" style="width:' + pPC + '%;background:#3498DB;" title="PIS/COFINS: ' + _pp(pPC) + '">PIS/COF</div>';
      if (pISS > 0) s5 += '<div class="res-comp-seg" style="width:' + pISS + '%;background:#9B59B6;" title="ISS: ' + _pp(pISS) + '">ISS</div>';
      s5 += '</div></div>';
    }

    // Gráfico Pizza
    s5 += '<div class="res-chart-container"><canvas id="chartComposicao" width="350" height="350"></canvas></div>';

    // Tabela de composição — usar bases pós-compensação para alíquota efetiva
    var compBaseIRPJ = (r.irpj && r.irpj.lucroReal !== undefined) ? r.irpj.lucroReal : r.lucroRealFinal;
    var compBaseCSLL = (r.csll && r.csll.baseCalculo !== undefined) ? r.csll.baseCalculo : (r.baseCSLLFinal || r.lucroRealFinal);
    s5 += '<table class="res-table">';
    s5 += '<thead><tr><th>Tributo</th><th>Base</th><th>Alíq. Efetiva</th><th>Anual</th><th>Mensal</th><th>% Carga</th></tr></thead>';
    s5 += '<tbody>';
    s5 += '<tr><td style="color:#E74C3C;">IRPJ</td><td>' + _m(compBaseIRPJ) + '</td><td>' + _pp(compBaseIRPJ > 0 ? _r(comp.irpj.valor / compBaseIRPJ * 100) : 0) + '</td><td>' + _m(comp.irpj.valor) + '</td><td>' + _m(_r(comp.irpj.valor / 12)) + '</td><td>' + _pp(comp.irpj.percentual) + '</td></tr>';
    s5 += '<tr><td style="color:#F39C12;">CSLL</td><td>' + _m(compBaseCSLL) + '</td><td>' + _pp(compBaseCSLL > 0 ? _r(comp.csll.valor / compBaseCSLL * 100) : 0) + '</td><td>' + _m(comp.csll.valor) + '</td><td>' + _m(_r(comp.csll.valor / 12)) + '</td><td>' + _pp(comp.csll.percentual) + '</td></tr>';
    // CORREÇÃO FALHA #2: alíquota efetiva LÍQUIDA (após retenções e créditos)
    var pcValorBruto = comp.pisCofins.valor; // bruto para consistência com cargaBruta
    var pcAliqEfetivaLiquida = dre.receitaBruta > 0 ? _pp(_r(r.pisCofins.totalAPagarLiquido / dre.receitaBruta * 100)) : '0,00%';
    var pcAliqDisplay = r.pisCofins.aliquotaEfetiva || pcAliqEfetivaLiquida;
    s5 += '<tr><td style="color:#3498DB;">PIS/COFINS</td><td>' + _m(dre.receitaBruta) + '</td><td>' + pcAliqDisplay + '</td><td>' + _m(pcValorBruto) + '</td><td>' + _m(_r(pcValorBruto / 12)) + '</td><td>' + _pp(comp.pisCofins.percentual) + '</td></tr>';
    s5 += '<tr><td style="color:#9B59B6;">ISS</td><td>' + _m(r.iss.receitaServicos) + '</td><td>' + _pp(r.iss.aliquota) + '</td><td>' + _m(comp.iss.valor) + '</td><td>' + _m(_r(comp.iss.valor / 12)) + '</td><td>' + _pp(comp.iss.percentual) + '</td></tr>';
    s5 += '</tbody>';
    s5 += '<tfoot><tr class="res-total"><td><strong>TOTAL</strong></td><td></td><td><strong>' + _pp(res.aliquotaEfetiva) + '</strong></td><td><strong>' + _m(res.cargaBruta) + '</strong></td><td><strong>' + _m(res.cargaBrutaMensal) + '</strong></td><td><strong>100%</strong></td></tr></tfoot>';
    s5 += '</table>';
    // ═══ FIX BUG #4: Nota explicativa sobre bases de cálculo das alíquotas efetivas ═══
    s5 += '<p class="res-nota">* <strong>Nota sobre alíquotas efetivas:</strong> Na tabela acima, a alíquota efetiva de cada tributo é calculada sobre sua respectiva base de cálculo (Lucro Real para IRPJ/CSLL, Receita Bruta para PIS/COFINS, Receita de Serviços para ISS). A <strong>Alíquota Efetiva Global</strong> no rodapé (' + _pp(res.aliquotaEfetiva) + ') é calculada sobre a <strong>Receita Bruta Total</strong> (' + _m(dre.receitaBruta) + ').</p>';
    // FALHA #2 nota: esclarecer que PIS/COFINS exibe alíquota líquida (após créditos e retenções)
    s5 += '<p class="res-nota">* A alíquota efetiva de PIS/COFINS exibida é <strong>líquida</strong> (após créditos e retenções). Alíquota bruta (antes de créditos): <strong>' + (r.pisCofins.aliquotaEfetivaBruta || '—') + '</strong></p>';
    // BUG#1 — notas de valores líquidos (após retenções) para transparência
    var _pisCofinsLiqS5 = _r(Math.max(pcValorBruto - _n(d.pisRetido) - _n(d.cofinsRetido), 0));
    var _csllLiqS5 = _r(Math.max(_n(comp.csll.valor) - _n(d.csllRetido), 0));
    if (_n(d.pisRetido) + _n(d.cofinsRetido) > 0) {
      s5 += '<p class="res-nota">* PIS/COFINS a pagar líquido (após retenções na fonte de ' + _m(_n(d.pisRetido) + _n(d.cofinsRetido)) + '): <strong>' + _m(_pisCofinsLiqS5) + '</strong></p>';
    }
    if (_n(d.csllRetido) > 0) {
      s5 += '<p class="res-nota">* CSLL a pagar líquida (após CSLL retida ' + _m(_n(d.csllRetido)) + '): <strong>' + _m(_csllLiqS5) + '</strong></p>';
    }
    html += _secao(5, 'Composição da Carga Tributária', s5);

    // ═══════════════════════════════════════════════════════════════════════
    //  SEÇÃO 6 — MAPA DA ECONOMIA (Antes × Depois)
    // ═══════════════════════════════════════════════════════════════════════
    var eco = r.economia;
    var s6 = '<div class="res-mapa-economia">';
    // Antes vs Depois
    s6 += '<div class="res-mapa-row">';
    s6 += '<div class="res-mapa-card res-mapa-antes"><div class="res-mapa-card-label">SEM Otimização</div><div class="res-mapa-card-value">' + _m(res.cargaBruta) + '</div><div class="res-mapa-card-sub">Alíquota: ' + _pp(res.aliquotaEfetiva) + '</div></div>';
    s6 += '<div class="res-mapa-seta"><div class="res-mapa-seta-valor">- ' + _m(eco.total) + '</div><div class="res-mapa-seta-icon">→</div></div>';
    s6 += '<div class="res-mapa-card res-mapa-depois"><div class="res-mapa-card-label">COM Otimização</div><div class="res-mapa-card-value">' + _m(res.cargaOtimizada) + '</div><div class="res-mapa-card-sub">Alíquota: ' + _pp(res.aliquotaOtimizada) + '</div></div>';
    s6 += '</div>';

    // Breakdown das economias
    // Breakdown separado: Planejamento vs Já Incorporados
    s6 += '<div class="res-mapa-breakdown">';
    var temAdicionais = (eco.jcp > 0 || eco.sudam > 0 || eco.incentivos > 0 || eco.gratificacao > 0 || eco.cprb > 0);
    if (temAdicionais) {
      s6 += '<h4>💡 Economias por Ação de Planejamento Tributário</h4>';
      s6 += '<p style="font-size:0.82em;color:#8892b0;margin-bottom:8px;">Estratégias que você pode implementar para reduzir a carga:</p>';
      s6 += '<table class="res-table">';
      if (eco.jcp > 0) s6 += _linha('JCP — Juros sobre Capital Próprio', eco.jcp, 'Art. 355-358', 'res-economia');
      if (eco.sudam > 0) s6 += _linha('Redução SUDAM/SUDENE (75%)', eco.sudam, 'Art. 627-637', 'res-economia');
      if (eco.incentivos > 0) s6 += _linha('Incentivos Fiscais (PAT, FIA, etc.)', eco.incentivos, 'Art. 641', 'res-economia');
      if (eco.gratificacao > 0) s6 += _linha('Conversão Gratificação → Pró-labore', eco.gratificacao, 'Art. 358, §1º', 'res-economia');
      if (eco.cprb > 0) s6 += _linha('CPRB — Desoneração da Folha', eco.cprb, 'Lei 12.546/2011', 'res-economia');
      var subPlan = _r((eco.jcp || 0) + (eco.sudam || 0) + (eco.incentivos || 0) + (eco.gratificacao || 0) + (eco.cprb || 0));
      s6 += '<tr class="res-total res-economia"><td><strong>SUBTOTAL PLANEJAMENTO</strong></td><td class="res-valor"><strong>' + _m(subPlan) + '</strong></td></tr>';
      s6 += '</table>';
    }
    var temEmbutidas = (eco.depreciacao > 0 || eco.pisCofinsCreditos > 0 || eco.pddFiscal > 0 || eco.prejuizo > 0);
    if (temEmbutidas) {
      s6 += '<h4 style="margin-top:16px;">✅ Economias Já Incorporadas na Carga Base</h4>';
      s6 += '<p style="font-size:0.82em;color:#8892b0;margin-bottom:8px;">Direitos legais e créditos já refletidos no cálculo:</p>';
      s6 += '<table class="res-table">';
      if (eco.depreciacao > 0) s6 += _linha('Economia Fiscal de Depreciação', eco.depreciacao, 'Art. 305-329', 'res-economia');
      if (eco.pisCofinsCreditos > 0) s6 += _linha('Créditos PIS/COFINS (não-cumulativo)', eco.pisCofinsCreditos, 'Art. 3º', 'res-economia');
      if (eco.pddFiscal > 0) s6 += _linha('PDD Fiscal — Perdas no Recebimento', eco.pddFiscal, 'Art. 340-342', 'res-economia');
      if (eco.prejuizo > 0) s6 += _linha('Compensação de Prejuízo Fiscal', eco.prejuizo, 'Art. 579-586', 'res-economia');
      var subEmb = _r((eco.depreciacao || 0) + (eco.pisCofinsCreditos || 0) + (eco.pddFiscal || 0) + (eco.prejuizo || 0));
      s6 += '<tr class="res-total"><td><strong>SUBTOTAL JÁ APLICADO</strong></td><td class="res-valor"><strong>' + _m(subEmb) + '</strong></td></tr>';
      s6 += '</table>';
    }
    s6 += '<div style="margin-top:12px;padding:12px 16px;background:rgba(16,185,129,0.1);border-radius:8px;text-align:center;">';
    s6 += '<div style="font-size:0.85em;color:#666;">ECONOMIA TOTAL (Planejamento + Direitos Legais)</div>';
    s6 += '<div style="font-size:1.4em;font-weight:700;color:#10b981;">' + _m(eco.total) + '</div>';
    s6 += '</div>';
    s6 += '</div>';

    // Projeções acumuladas
    if (r.projecao && r.projecao.projecaoCarga) {
      s6 += '<div class="res-mapa-projecoes"><h4>Projeção de Economia Acumulada</h4>';
      s6 += '<table class="res-table"><thead><tr><th>Período</th><th>Economia/Ano</th><th>Acumulada</th></tr></thead><tbody>';
      var econAcum1 = 0;
      var periodos = [1, 3, 5, 10];
      var pcLen = r.projecao.projecaoCarga.length;
      periodos.forEach(function (p) {
        var econP = 0;
        // Somar anos disponíveis no array
        for (var a = 0; a < Math.min(p, pcLen); a++) {
          econP += r.projecao.projecaoCarga[a].economiaAno;
        }
        // CORREÇÃO BUG 6: Se período > tamanho do array, extrapolar com economia do último ano
        if (p > pcLen && pcLen > 0) {
          var ultimaEconomia = r.projecao.projecaoCarga[pcLen - 1].economiaAno;
          econP += ultimaEconomia * (p - pcLen);
        }
        var anoLabel = p === 1 ? "1 ano" : p + " anos";
        var idxUltimo = Math.min(p, pcLen) - 1;
        var ultimoAno = r.projecao.projecaoCarga[idxUltimo >= 0 ? idxUltimo : 0];
        var econAnoDisplay = (p > pcLen && pcLen > 0)
          ? r.projecao.projecaoCarga[pcLen - 1].economiaAno
          : (ultimoAno ? ultimoAno.economiaAno : eco.total);
        s6 += '<tr><td>' + anoLabel + '</td><td>' + _m(econAnoDisplay) + '</td><td class="res-economia"><strong>' + _m(econP || eco.total * p) + '</strong></td></tr>';
      });
      s6 += '</tbody></table></div>';
    } else {
      // Projeção simples sem cenários
      s6 += '<div class="res-mapa-projecoes"><h4>Projeção de Economia Acumulada</h4>';
      s6 += '<table class="res-table"><thead><tr><th>Período</th><th>Economia Acumulada</th></tr></thead><tbody>';
      [1, 3, 5, 10].forEach(function (p) {
        s6 += '<tr><td>' + p + (p === 1 ? ' ano' : ' anos') + '</td><td class="res-economia"><strong>' + _m(_r(eco.total * p)) + '</strong></td></tr>';
      });
      s6 += '</tbody></table></div>';
    }

    // Gráficos
    s6 += '<div class="res-chart-row">';
    s6 += '<div class="res-chart-container"><canvas id="chartEconomias" width="400" height="300"></canvas></div>';
    s6 += '<div class="res-chart-container"><canvas id="chartAntesDepois" width="400" height="300"></canvas></div>';
    s6 += '</div>';
    if (r.projecao && r.projecao.projecaoCarga) {
      s6 += '<div class="res-chart-container"><canvas id="chartProjecao" width="700" height="300"></canvas></div>';
    }

    s6 += '</div>';
    html += _secao(6, 'Mapa da Economia — Antes x Depois', s6);

    // ═══════════════════════════════════════════════════════════════════════
    //  SEÇÃO 7 — OPORTUNIDADES DE ECONOMIA
    // ═══════════════════════════════════════════════════════════════════════
    var ops = r.oportunidades || [];
    var s7 = '<div class="res-oportunidades">';
    if (ops.length === 0) {
      s7 += '<p class="res-info-msg">Nenhuma oportunidade adicional identificada com os dados informados.</p>';
    } else {
      ops.sort(function (a, b) { return (b.economiaAnual || 0) - (a.economiaAnual || 0); });
      ops.forEach(function (op, idx) {
        var rankNum = idx + 1;
        var corTipo = op.tipo === 'Dedução' ? '#2ECC71' : op.tipo === 'Redução' ? '#3498DB' : op.tipo === 'Crédito' ? '#9B59B6' : op.tipo === 'Compensação' ? '#F39C12' : op.tipo === 'Potencial' ? '#95A5A6' : '#E74C3C';
        var corRisco = op.risco === 'Baixo' ? '#2ECC71' : op.risco === 'Médio' ? '#F39C12' : '#E74C3C';
        var corCompl = op.complexidade === 'Baixa' ? '#2ECC71' : op.complexidade === 'Média' ? '#F39C12' : '#E74C3C';

        // CORREÇÃO FALHA #1: cards consolidados recebem estilo visual diferente
        var cardStyle = op._isConsolidada ? ' style="border:2px dashed #95A5A6;opacity:0.85;background:#f8f9fa;"' : '';
        s7 += '<div class="res-oport-card"' + cardStyle + '>';
        s7 += '<div class="res-oport-header">';
        s7 += '<div class="res-oport-rank">' + (op._isConsolidada ? '⊕' : '#' + rankNum) + '</div>';
        s7 += '<div class="res-oport-titulo">' + op.titulo + '</div>';
        s7 += '<div class="res-oport-valor">' + _m(op.economiaAnual) + '<span>/ano</span></div>';
        s7 += '</div>';
        s7 += '<div class="res-oport-tags">';
        s7 += '<span class="res-tag" style="background:' + corTipo + ';">' + op.tipo + '</span>';
        s7 += '<span class="res-tag" style="background:' + corCompl + ';">Compl.: ' + op.complexidade + '</span>';
        s7 += '<span class="res-tag" style="background:' + corRisco + ';">Risco: ' + op.risco + '</span>';
        if (op.prazoImplementacao) s7 += '<span class="res-tag" style="background:#3498DB;">Prazo: ' + op.prazoImplementacao + '</span>';
        s7 += '</div>';
        s7 += '<div class="res-oport-body">';
        s7 += '<p>' + op.descricao + '</p>';
        if (op.baseLegal) s7 += '<div class="res-oport-legal">Base Legal: ' + op.baseLegal + '</div>';
        if (op.acaoRecomendada) s7 += '<div class="res-oport-acao"><strong>Ação Recomendada:</strong> ' + op.acaoRecomendada + '</div>';
        s7 += '</div>';
        s7 += '</div>';
      });
    }
    s7 += '</div>';
    html += _secao(7, 'Oportunidades de Economia (' + ops.length + ')', s7);

    // ═══════════════════════════════════════════════════════════════════════
    //  SEÇÃO 8 — TRIMESTRAL vs ANUAL
    // ═══════════════════════════════════════════════════════════════════════
    var ca = r.comparativoApuracao;
    var s8 = '';
    if (ca) {
      // Tabela comparativa TRIMESTRAL
      if (ca.trimestral && ca.trimestral.trimestres) {
        s8 += '<h3>Apuração Trimestral</h3>';
        s8 += '<table class="res-table"><thead><tr><th>Trimestre</th><th>Lucro Ajustado</th><th>Comp. Prejuízo</th><th>Lucro Real</th><th>IRPJ Normal</th><th>IRPJ Adic.</th><th>IRPJ Total</th><th>CSLL</th></tr></thead><tbody>';
        ca.trimestral.trimestres.forEach(function (t) {
          s8 += '<tr><td>' + t.trimestre + 'º Tri</td><td>' + _m(t.lucroAjustado) + '</td><td>' + _m(t.compensacaoPrejuizo) + '</td><td>' + _m(t.lucroReal) + '</td><td>' + _m(t.irpjNormal) + '</td><td>' + _m(t.irpjAdicional) + '</td><td>' + _m(t.irpjTotal) + '</td><td>' + _m(t.csll) + '</td></tr>';
        });
        s8 += '<tr class="res-total"><td><strong>TOTAL</strong></td><td></td><td></td><td></td><td></td><td></td><td><strong>' + _m(ca.trimestral.totalIRPJ) + '</strong></td><td><strong>' + _m(ca.trimestral.totalCSLL) + '</strong></td></tr>';
        s8 += '</tbody></table>';
        s8 += '<p class="res-total-destaque">Total Trimestral (IRPJ+CSLL): <strong>' + _m(ca.trimestral.total) + '</strong></p>';
      }

      // Tabela ANUAL POR ESTIMATIVA (resumo)
      if (ca.anual) {
        s8 += '<h3>Apuração Anual por Estimativa</h3>';
        s8 += '<table class="res-table">';
        s8 += _linha('Total Estimativas IRPJ (12 meses)', ca.anual.totalEstimativasIRPJ, '', '');
        s8 += _linha('Total Estimativas CSLL (12 meses)', ca.anual.totalEstimativasCSLL, '', '');
        s8 += _linha('= Total Estimativas Pagas', ca.anual.totalEstimativas, '', 'res-subtotal');
        s8 += _linha('IRPJ Real Anual (ajuste)', ca.anual.irpjRealAnual, '', '');
        s8 += _linha('CSLL Real Anual (ajuste)', ca.anual.csllRealAnual, '', '');
        s8 += _linha('Ajuste IRPJ (real - estimativas)', ca.anual.ajusteIRPJ, '', ca.anual.ajusteIRPJ < 0 ? 'res-economia' : '');
        s8 += _linha('Ajuste CSLL (real - estimativas)', ca.anual.ajusteCSLL, '', ca.anual.ajusteCSLL < 0 ? 'res-economia' : '');
        // BUG#3 CORRIGIDO: saldo a compensar separado para IRPJ e CSLL
        if (ca.anual.saldoACompensar > 0) {
          s8 += _linha('Saldo a Compensar IRPJ (estimativas excedentes)', ca.anual.saldoACompensar, 'PER/DCOMP', 'res-economia');
        }
        if (ca.anual.saldoACompensarCSLL > 0) {
          s8 += _linha('Saldo a Compensar CSLL (estimativas excedentes)', ca.anual.saldoACompensarCSLL, 'PER/DCOMP', 'res-economia');
        }
        if (ca.anual.saldoACompensarTotal > 0) {
          s8 += _linha('= TOTAL a Compensar via PER/DCOMP', ca.anual.saldoACompensarTotal, 'PER/DCOMP', 'res-total res-economia');
        }
        s8 += '</table>';
      }

      // Suspensão/Redução
      if (ca.suspensao && ca.suspensao.mesesSuspensos > 0) {
        s8 += '<h3>Suspensão/Redução de Estimativas</h3>';
        s8 += '<p>Meses com possibilidade de suspensão: <strong>' + ca.suspensao.mesesSuspensos + '</strong></p>';
        s8 += '<p>Economia estimada com suspensão: <strong class="res-economia">' + _m(ca.suspensao.economiaTotalSuspensao) + '</strong></p>';
      }

      // Recomendação
      if (ca.recomendacao) {
        var recBg = ca.recomendacao.formaRecomendada === 'trimestral' ? '#1A3C6E' : '#2ECC71';
        s8 += '<div class="res-recomendacao" style="border-left:4px solid ' + recBg + ';">';
        s8 += '<h4>Recomendação</h4>';
        s8 += '<p>' + ca.recomendacao.justificativa + '</p>';
        if (ca.recomendacao.diferenca > 0 && ca.recomendacao.diferenca >= 100) {
          s8 += '<p><strong>Diferença: ' + _m(ca.recomendacao.diferenca) + '</strong></p>';
        }
        s8 += '</div>';
      }
    }
    // ALERTA #7 — Impacto de fluxo de caixa no regime anual por estimativa
    if (ca && ca.anual && (ca.anual.saldoACompensar > 0 || ca.anual.saldoACompensarCSLL > 0)) {
      var _capitalImob7 = _r((ca.anual.saldoACompensar || 0) + (ca.anual.saldoACompensarCSLL || 0));
      var _irpjCsllReal7 = _r((ca.anual.irpjRealAnual || 0) + (ca.anual.csllRealAnual || 0));
      s8 += '<div class="res-recomendacao" style="border-left:4px solid #F39C12;">';
      s8 += '<h4>⚠️ Impacto de Fluxo de Caixa (Regime Anual)</h4>';
      s8 += '<p>No regime anual por estimativa, a empresa pagará ' + _m(ca.anual.totalEstimativas) +
        ' em estimativas mensais, mas o imposto real ajustado é de ' + _m(_irpjCsllReal7) + '.</p>';
      s8 += '<p>Isso representa <strong>' + _m(_capitalImob7) +
        ' de capital imobilizado</strong> durante o ano, restituível somente após a entrega da ECF ' +
        '(geralmente no ano seguinte). Para empresas com necessidade de capital de giro, o regime ' +
        'trimestral pode ser mais vantajoso do ponto de vista financeiro.</p>';
      s8 += '</div>';
    }
    html += _secao(8, 'Comparativo: Trimestral vs Anual', s8);

    // ═══════════════════════════════════════════════════════════════════════
    //  SEÇÃO 9 — CENÁRIOS DE SENSIBILIDADE
    // ═══════════════════════════════════════════════════════════════════════
    var s9 = '';
    if (r.cenarios && r.cenarios.length > 0) {
      s9 += '<table class="res-table"><thead><tr><th>Cenário</th><th>Margem</th><th>Lucro</th><th>IRPJ+CSLL</th><th>PIS/COFINS</th><th>ISS</th><th>Carga Total</th><th>Alíq. Efetiva</th></tr></thead><tbody>';
      r.cenarios.forEach(function (c) {
        var cls = c.nome === 'Base' ? 'res-cenario-base' : c.nome === 'Pessimista' ? 'res-cenario-pessimista' : 'res-cenario-otimista';
        s9 += '<tr class="' + cls + '"><td><strong>' + c.nome + '</strong></td><td>' + _pp(c.margem) + '</td><td>' + _m(c.lucro) + '</td><td>' + _m(c.irpjCSLL) + '</td><td>' + _m(c.pisCofins) + '</td><td>' + _m(c.iss) + '</td><td><strong>' + _m(c.cargaTotal) + '</strong></td><td>' + _pp(c.aliquotaEfetiva) + '</td></tr>';
      });
      s9 += '</tbody></table>';
      s9 += '<div class="res-chart-container"><canvas id="chartCenarios" width="600" height="300"></canvas></div>';
    } else {
      s9 += '<p class="res-info-msg">Cenários de sensibilidade não foram habilitados. Ative na Etapa 6 para visualizar.</p>';
    }

    // Projeção plurianual
    if (r.projecao && r.projecao.projecaoCarga) {
      s9 += '<h3>Projeção Plurianual</h3>';
      s9 += '<table class="res-table"><thead><tr><th>Ano</th><th>Receita Projetada</th><th>Carga Tributária</th><th>Economia/Ano</th><th>Economia Acumulada</th></tr></thead><tbody>';
      r.projecao.projecaoCarga.forEach(function (p) {
        s9 += '<tr><td>Ano ' + p.ano + '</td><td>' + _m(p.receita) + '</td><td>' + _m(p.carga) + '</td><td>' + _m(p.economiaAno) + '</td><td class="res-economia"><strong>' + _m(p.economiaAcumulada) + '</strong></td></tr>';
      });
      s9 += '</tbody></table>';
    }
    html += _secao(9, 'Cenários de Sensibilidade', s9);

    // ═══════════════════════════════════════════════════════════════════════
    //  SEÇÃO 10 — FLUXO DE CAIXA TRIBUTÁRIO MENSAL
    // ═══════════════════════════════════════════════════════════════════════
    var fc = r.fluxoCaixa;
    var s10 = '';
    if (fc && fc.meses) {
      s10 += '<p>Forma de Apuração: <strong>' + (fc.apuracao === "trimestral" ? "Trimestral" : "Anual por Estimativa") + '</strong> | Média Mensal: <strong>' + _m(fc.mediaMensal) + '</strong></p>';
      s10 += '<div class="res-table-wrap"><table class="res-table res-fluxo-mensal"><thead><tr><th>Mês</th><th>IRPJ</th><th>CSLL</th><th>PIS</th><th>COFINS</th><th>ISS</th><th>Total</th></tr></thead><tbody>';
      var totIRPJ = 0, totCSLL = 0, totPIS = 0, totCOF = 0, totISS = 0, totTot = 0;
      fc.meses.forEach(function (m) {
        totIRPJ += m.irpj; totCSLL += m.csll; totPIS += m.pis; totCOF += m.cofins; totISS += m.iss; totTot += m.total;
        s10 += '<tr><td>' + mesesNome[m.mes - 1] + '</td><td>' + _m(m.irpj) + '</td><td>' + _m(m.csll) + '</td><td>' + _m(m.pis) + '</td><td>' + _m(m.cofins) + '</td><td>' + _m(m.iss) + '</td><td><strong>' + _m(m.total) + '</strong></td></tr>';
      });
      // ═══ FIX BUG #3: Usar totais anuais exatos para evitar divergência de centavos ═══
      var totIRPJExato = fc.irpjAnualExato !== undefined ? fc.irpjAnualExato : _r(totIRPJ);
      var totCSLLExato = fc.csllAnualExato !== undefined ? fc.csllAnualExato : _r(totCSLL);
      var totPISExato = fc.pisAnualExato !== undefined ? fc.pisAnualExato : _r(totPIS);
      var totCOFExato = fc.cofinsAnualExato !== undefined ? fc.cofinsAnualExato : _r(totCOF);
      var totISSExato = _r(totISS);
      var totTotExato = _r(totIRPJExato + totCSLLExato + totPISExato + totCOFExato + totISSExato);
      s10 += '<tr class="res-total"><td><strong>TOTAL</strong></td><td><strong>' + _m(totIRPJExato) + '</strong></td><td><strong>' + _m(totCSLLExato) + '</strong></td><td><strong>' + _m(totPISExato) + '</strong></td><td><strong>' + _m(totCOFExato) + '</strong></td><td><strong>' + _m(totISSExato) + '</strong></td><td><strong>' + _m(totTotExato) + '</strong></td></tr>';
      s10 += '</tbody></table></div>';
      s10 += '<div class="res-chart-container"><canvas id="chartFluxoMensal" width="700" height="350"></canvas></div>';
    }
    html += _secao(10, 'Fluxo de Caixa Tributário Mensal', s10);

    // ═══════════════════════════════════════════════════════════════════════
    //  SEÇÃO 11 — ALERTAS E COMPLIANCE
    // ═══════════════════════════════════════════════════════════════════════
    var alertas = r.alertas || [];
    var s11 = '<div class="res-alertas">';

    // Obrigatoriedade
    if (r.obrigatoriedade && r.obrigatoriedade.obrigado) {
      s11 += '<div class="res-alerta res-alerta-critico"><span class="res-alerta-icon">&#x1F534;</span><strong>OBRIGATORIEDADE:</strong> ' + (r.obrigatoriedade.motivo || 'Empresa é obrigada ao regime do Lucro Real.') + '</div>';
    }

    // Alertas da validação cruzada
    alertas.forEach(function (a) {
      var cls = a.tipo === 'critico' ? 'res-alerta-critico' : a.tipo === 'aviso' ? 'res-alerta-aviso' : a.tipo === 'economia' ? 'res-alerta-economia' : 'res-alerta-info';
      var icon = a.tipo === 'critico' ? '&#x1F534;' : a.tipo === 'aviso' ? '&#x1F7E1;' : a.tipo === 'economia' ? '&#x1F7E2;' : '&#x1F535;';
      s11 += '<div class="res-alerta ' + cls + '"><span class="res-alerta-icon">' + icon + '</span>' + a.msg + '</div>';
    });

    // Saldo negativo
    if (r.saldoNegativo && r.saldoNegativo.saldoNegativo && r.saldoNegativo.saldoNegativo > 0) {
      s11 += '<div class="res-alerta res-alerta-info"><span class="res-alerta-icon">&#x1F535;</span><strong>SALDO NEGATIVO IRPJ:</strong> ' + _m(r.saldoNegativo.saldoNegativo) + '. Solicitar restituição ou compensação via PER/DCOMP (IN RFB 2.055/2021).</div>';
    }

    // Vedações de compensação
    if (r.vedacoes && r.vedacoes.compensacaoPermitida === false) {
      s11 += '<div class="res-alerta res-alerta-critico"><span class="res-alerta-icon">&#x1F534;</span><strong>VEDAÇÃO DE COMPENSAÇÃO:</strong> ' + (r.vedacoes.motivo || 'Compensação de prejuízo fiscal vedada por mudança de controle + ramo de atividade (Art. 584 RIR/2018).') + '</div>';
    }

    // JCP não aproveitado
    if (r.jcpDetalhado && r.jcpDetalhado.economiaLiquida > 0 && r.economia.jcp > 0) {
      s11 += '<div class="res-alerta res-alerta-economia"><span class="res-alerta-icon">&#x1F7E2;</span><strong>JCP DISPONÍVEL:</strong> Economia líquida de ' + _m(r.jcpDetalhado.economiaLiquida) + '/ano com distribuição de Juros sobre Capital Próprio.</div>';
      // CORREÇÃO RJ-01: Alerta sobre Lei 14.789/2023 que alterou o cálculo do JCP
      if (!_n(d.plAjustadoJCP)) {
        s11 += '<div class="res-alerta res-alerta-warn"><span class="res-alerta-icon">&#x26A0;&#xFE0F;</span><strong>ATENÇÃO — Lei 14.789/2023 (vigente desde 01/01/2024):</strong> ' +
          'O novo §8º do art. 9º da Lei 9.249/95 passou a excluir da base patrimonial do JCP diversos itens ' +
          '(lucros do período, reservas de incentivos, AAP, AVP, entre outros). ' +
          'O valor de JCP apresentado utiliza PL contábil total (PL Ajustado não foi informado) e pode estar superestimado. ' +
          '<strong>Informe o PL Ajustado conforme Lei 14.789/2023 na Etapa 3 ou valide com contador.</strong></div>';
      } else {
        s11 += '<div class="res-alerta res-alerta-info"><span class="res-alerta-icon">&#x1F535;</span><strong>JCP — Lei 14.789/2023:</strong> Cálculo utiliza PL Ajustado de ' + _m(_n(d.plAjustadoJCP)) + ' conforme informado.</div>';
      }
    }

    // SUDAM/SUDENE potencial
    var isSUDAM = (LR.helpers && LR.helpers.ehSUDAM) ? LR.helpers.ehSUDAM(d.uf) : false;
    var isSUDENE = (LR.helpers && LR.helpers.ehSUDENE) ? LR.helpers.ehSUDENE(d.uf) : false;
    if ((isSUDAM || isSUDENE) && !(d.temProjetoAprovado === true || d.temProjetoAprovado === "true")) {
      var nomeSup = isSUDAM ? "SUDAM" : "SUDENE";
      s11 += '<div class="res-alerta res-alerta-economia"><span class="res-alerta-icon">&#x1F7E2;</span><strong>POTENCIAL ' + nomeSup + ':</strong> Empresa em área ' + nomeSup + ' sem projeto aprovado. Redução de até 75% do IRPJ é possível.</div>';
    }

    // Reforma Tributária — CORREÇÃO RJ-03: Disclaimer mais explícito para 2026
    s11 += '<div class="res-alerta res-alerta-warn"><span class="res-alerta-icon">&#x26A0;&#xFE0F;</span><strong>REFORMA TRIBUTÁRIA — ANO-BASE 2026 (LC 214/2025):</strong> ' +
      'Em 2026 inicia-se a fase de teste da CBS (0,9%) e IBS (0,1%) com crédito proporcional de PIS/COFINS vigente. ' +
      'Os cálculos de PIS/COFINS neste estudo utilizam a sistemática anterior (Leis 10.637/02 e 10.833/03). ' +
      '<strong>O impacto da CBS/IBS teste não está refletido nos valores apresentados.</strong> ' +
      'Consulte regulamentação vigente para ajustar o planejamento tributário. ' +
      'O regime do Lucro Real permanece aplicável para IRPJ e CSLL.</div>';

    s11 += '</div>';
    html += _secao(11, 'Alertas e Compliance', s11);

    // ═══════════════════════════════════════════════════════════════════════
    //  SEÇÃO 12 — OBRIGAÇÕES ACESSÓRIAS E DARFs
    // ═══════════════════════════════════════════════════════════════════════
    var s12 = '';

    // Obrigações acessórias
    var obrigacoes = r.obrigacoes || [];
    if (obrigacoes.length > 0) {
      s12 += '<h3>Obrigações Acessórias</h3>';
      s12 += '<table class="res-table"><thead><tr><th>Obrigação</th><th>Periodicidade</th><th>Prazo</th><th>Descrição</th></tr></thead><tbody>';
      obrigacoes.forEach(function (ob) {
        if (ob) {
          var _periodicidade = '—';
          if (ob.prazo) {
            var _pl = ob.prazo.toLowerCase();
            if (_pl.indexOf('mensal') >= 0 || _pl.indexOf('mês') >= 0 || _pl.indexOf('15º') >= 0 || _pl.indexOf('10º') >= 0) _periodicidade = 'Mensal';
            else if (_pl.indexOf('trimestral') >= 0 || _pl.indexOf('trimestre') >= 0) _periodicidade = 'Trimestral';
            else if (_pl.indexOf('anual') >= 0 || _pl.indexOf('ano') >= 0 || _pl.indexOf('julho') >= 0 || _pl.indexOf('maio') >= 0 || _pl.indexOf('fevereiro') >= 0) _periodicidade = 'Anual';
            else if (_pl.indexOf('contínuo') >= 0 || _pl.indexOf('continuo') >= 0) _periodicidade = 'Contínuo';
            else if (_pl.indexOf('período') >= 0 || _pl.indexOf('periodo') >= 0) _periodicidade = 'Por Período';
            else if (_pl.indexOf('prescrever') >= 0 || _pl.indexOf('5 anos') >= 0) _periodicidade = 'Permanente';
            else if (_pl.indexOf('varia') >= 0) _periodicidade = 'Varia por UF';
            else _periodicidade = ob.prazo.split('(')[0].trim() || '—';
          }
          s12 += '<tr><td><strong>' + (ob.obrigacao || ob.nome || ob.id || '—') + '</strong></td><td>' + _periodicidade + '</td><td>' + (ob.prazo || '—') + '</td><td>' + (ob.descricao || '—') + '</td></tr>';
        }
      });
      s12 += '</tbody></table>';
    } else {
      // Obrigações padrão do Lucro Real
      s12 += '<h3>Obrigações Acessórias do Lucro Real</h3>';
      s12 += '<table class="res-table"><thead><tr><th>Obrigação</th><th>Periodicidade</th><th>Prazo</th></tr></thead><tbody>';
      s12 += '<tr><td><strong>ECF</strong> — Escrituração Contábil Fiscal</td><td>Anual</td><td>Último dia útil de julho</td></tr>';
      s12 += '<tr><td><strong>ECD</strong> — Escrituração Contábil Digital</td><td>Anual</td><td>Último dia útil de maio</td></tr>';
      s12 += '<tr><td><strong>EFD-Contribuições</strong></td><td>Mensal</td><td>10º dia útil do 2º mês subsequente</td></tr>';
      s12 += '<tr><td><strong>DCTF</strong> — Declaração de Débitos e Créditos</td><td>Mensal</td><td>15º dia útil do 2º mês subsequente</td></tr>';
      s12 += '<tr><td><strong>EFD-ICMS/IPI</strong></td><td>Mensal</td><td>Varia por UF</td></tr>';
      s12 += '<tr><td><strong>LALUR/LACS</strong> — Livro de Apuração</td><td>' + (d.apuracaoLR === "trimestral" ? "Trimestral" : "Anual") + '</td><td>Integrado à ECF</td></tr>';
      s12 += '</tbody></table>';
    }

    // DARFs
    var darfs = r.darfs || [];
    if (darfs.length > 0) {
      s12 += '<h3>Códigos DARF — Forma: ' + (d.apuracaoLR === "trimestral" ? "Trimestral" : "Anual") + '</h3>';
      s12 += '<table class="res-table res-darf-table"><thead><tr><th>Tributo</th><th>Código DARF</th><th>Periodicidade</th><th>Prazo</th></tr></thead><tbody>';
      darfs.forEach(function (df) {
        if (df) {
          s12 += '<tr><td><strong>' + (df.tributo || df.nome || '—') + '</strong></td><td>' + (df.codigo || '—') + '</td><td>' + (df.periodicidade || '—') + '</td><td>' + (df.prazo || df.vencimento || '—') + '</td></tr>';
        }
      });
      s12 += '</tbody></table>';
    } else {
      // DARFs padrão
      s12 += '<h3>Códigos DARF</h3>';
      s12 += '<table class="res-table res-darf-table"><thead><tr><th>Tributo</th><th>Código DARF</th><th>Periodicidade</th></tr></thead><tbody>';
      if (d.apuracaoLR === "trimestral") {
        s12 += '<tr><td>IRPJ — Trimestral</td><td>0220</td><td>Trimestral</td></tr>';
        s12 += '<tr><td>CSLL — Trimestral</td><td>2372</td><td>Trimestral</td></tr>';
      } else {
        s12 += '<tr><td>IRPJ — Estimativa Mensal</td><td>2362</td><td>Mensal</td></tr>';
        s12 += '<tr><td>CSLL — Estimativa Mensal</td><td>2484</td><td>Mensal</td></tr>';
        s12 += '<tr><td>IRPJ — Ajuste Anual</td><td>2430</td><td>Anual</td></tr>';
        s12 += '<tr><td>CSLL — Ajuste Anual</td><td>6773</td><td>Anual</td></tr>';
      }
      s12 += '<tr><td>PIS — Não Cumulativo</td><td>6912</td><td>Mensal</td></tr>';
      s12 += '<tr><td>COFINS — Não Cumulativo</td><td>5856</td><td>Mensal</td></tr>';
      if (r.jcpDetalhado && r.jcpDetalhado.jcpDedutivel > 0) {
        s12 += '<tr><td>IRRF sobre JCP</td><td>5706</td><td>Quando distribuir</td></tr>';
      }
      s12 += '</tbody></table>';
    }
    html += _secao(12, 'Obrigações Acessórias e DARFs', s12);

    // ═══════════════════════════════════════════════════════════════════════
    //  SEÇÃO NOVA 6 — REFORMA TRIBUTÁRIA — IMPACTOS E DISCLAIMER
    // ═══════════════════════════════════════════════════════════════════════
    if (LR.reformaTributaria) {
      var sN6 = '';
      sN6 += '<div class="res-detail-card" style="border-left:4px solid #3498DB;padding:16px;">';
      sN6 += '<h3>⚖️ Impactos da LC 214/2025 (Reforma Tributária)</h3>';
      if (LR.reformaTributaria.impactosLucroReal) {
        sN6 += '<table class="res-table"><thead><tr><th>Tema</th><th>Impacto</th><th>Status</th></tr></thead><tbody>';
        LR.reformaTributaria.impactosLucroReal.forEach(function (imp) {
          var corImp = imp.impacto === 'ALTO' ? '#E74C3C' : imp.impacto === 'MEDIO' ? '#F39C12' : '#3498DB';
          sN6 += '<tr><td><strong>' + (imp.tema || '') + '</strong>';
          if (imp.artigo) sN6 += ' <span class="res-artigo">' + imp.artigo + '</span>';
          sN6 += '<br><span style="font-size:0.85em;color:#666;">' + (imp.descricao || '') + '</span></td>';
          sN6 += '<td style="color:' + corImp + ';font-weight:600;">' + (imp.impacto || '') + '</td>';
          sN6 += '<td style="font-size:0.85em;color:#666;">' + (imp.statusRegulamentacao || imp.status || '') + '</td></tr>';
        });
        sN6 += '</tbody></table>';
      }
      if (LR.reformaTributaria.disclaimer) {
        sN6 += '<div style="margin-top:12px;padding:10px;background:#f8f9fa;border-radius:6px;font-style:italic;color:#666;font-size:0.9em;">' + LR.reformaTributaria.disclaimer + '</div>';
      }
      if (LR.reformaTributaria.dataUltimaRevisao) {
        sN6 += '<div style="margin-top:6px;font-size:0.8em;color:#999;">Última revisão: ' + LR.reformaTributaria.dataUltimaRevisao + '</div>';
      }
      sN6 += '</div>';
      html += _secao('F', 'Reforma Tributária — Impactos e Disclaimer', sN6);
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  SEÇÃO NOVA 7 — FÓRMULA MESTRE DO LUCRO REAL
    // ═══════════════════════════════════════════════════════════════════════
    if (LR.formulaMestre && LR.formulaMestre.passos) {
      var sN7 = '';
      // Mapear valores reais para cada passo da fórmula
      var valoresFormula = {};
      valoresFormula[1] = r.dre ? r.dre.lucroLiquido : 0;
      valoresFormula[2] = r.lalur ? r.lalur.totalAdicoes : 0;
      valoresFormula[3] = r.lalur ? r.lalur.totalExclusoes : 0;
      valoresFormula[4] = r.lalur ? r.lalur.lucroAjustado : 0;
      var compensTotal = 0;
      if (r.compensacao && r.compensacao.resumo && r.compensacao.resumo.compensacaoEfetiva) {
        // CORREÇÃO BUG FÓRMULA MESTRE: Usar apenas a compensação de prejuízo fiscal (IRPJ),
        // NÃO somar a base negativa de CSLL — são grandezas distintas.
        // A base negativa CSLL é compensação para cálculo da CSLL (seção 4.2), não do Lucro Real.
        // Antes: compensTotal = prejuizoOperacional + baseNegativaCSLL (ERRADO: R$200k + R$150k = R$350k)
        // Agora: compensTotal = apenas prejuizoOperacional (CORRETO: R$200k)
        compensTotal = (r.compensacao.resumo.compensacaoEfetiva.prejuizoOperacional || 0);
      }
      // Fallback: ler do resultado do IRPJ se a compensação veio zerada
      if (compensTotal === 0 && r.irpj) {
        compensTotal = r.irpj.compensacaoPrejuizo || r.irpj.passo5_compensacao || 0;
      }
      valoresFormula[5] = compensTotal;
      valoresFormula[6] = r.lucroRealFinal || 0;
      valoresFormula[7] = r.irpj ? (r.irpj.irpjNormal || 0) : 0;
      valoresFormula[8] = r.irpj ? (r.irpj.irpjAdicional || r.irpj.adicional || 0) : 0;
      valoresFormula[9] = r.irpjAntesReducao || 0;
      valoresFormula[10] = (r.incentivosFiscais ? (r.incentivosFiscais.totalDeducaoFinal || r.incentivosFiscais.economiaTotal || 0) : 0) + (r.reducaoSUDAM || 0);
      var totalRetForm = _n(d.irrfRetidoPrivado) + _n(d.irrfRetidoPublico);
      valoresFormula[11] = totalRetForm;
      valoresFormula[12] = r.irpjAposReducao ? _r(r.irpjAposReducao - totalRetForm) : 0;

      sN7 += '<div class="res-detail-card" style="font-family:\'JetBrains Mono\',monospace;">';
      sN7 += '<div style="margin-bottom:8px;font-size:0.85em;color:#666;">Sequência de cálculo — <span class="res-artigo">' + (LR.formulaMestre.artigo || 'Art. 258-261') + '</span></div>';
      LR.formulaMestre.passos.forEach(function (p) {
        var val = valoresFormula[p.passo] || 0;
        var isTotal = (p.operacao === '=' && (p.passo === 6 || p.passo === 9 || p.passo === 12));
        var bgColor = isTotal ? '#f0fdf4' : 'transparent';
        var fWeight = isTotal ? 'font-weight:700;' : '';
        var opIcon = p.operacao === '+' ? '(+)' : p.operacao === '-' ? '(-)' : p.operacao === '×' ? '(×)' : '(=)';
        sN7 += '<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 12px;border-bottom:1px solid #eee;background:' + bgColor + ';' + fWeight + '">';
        sN7 += '<div><span style="display:inline-block;width:30px;color:#999;font-size:0.9em;">' + opIcon + '</span> ' + p.descricao;
        if (p.artigo && p.artigo !== '-') sN7 += ' <span class="res-artigo">' + p.artigo + '</span>';
        sN7 += '</div>';
        sN7 += '<div style="text-align:right;min-width:140px;' + (isTotal ? 'color:#10b981;font-size:1.1em;' : '') + '">' + _m(val) + '</div>';
        sN7 += '</div>';
      });
      sN7 += '</div>';
      html += _secao('G', 'Fórmula Mestre do Lucro Real', sN7);
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  SEÇÃO NOVA 8 — MAPA DE ESTRATÉGIAS DE ECONOMIA — RANKINGS
    // ═══════════════════════════════════════════════════════════════════════
    if (LR.estrategiasEconomia && LR.estrategiasEconomia.length > 0) {
      var sN8 = '';
      var opsArr = r.oportunidades || [];
      // Calcular total economia para % barras — CORREÇÃO FALHA #1: excluir cards consolidados
      var totalEconOps = 0;
      opsArr.forEach(function (op) { if (!op._isConsolidada) totalEconOps += (op.economiaAnual || 0); });

      sN8 += '<div class="res-oportunidades">';
      LR.estrategiasEconomia.forEach(function (est) {
        // Cruzar com oportunidade correspondente
        var econReal = 0;
        opsArr.forEach(function (op) {
          if (op.titulo && op.titulo.indexOf(est.nome.substring(0, 10)) >= 0) econReal += (op.economiaAnual || 0);
        });
        // Fallback: cruzar pelo tipo
        if (econReal === 0) {
          var ecoKey = est.nome.toLowerCase();
          if (ecoKey.indexOf('jcp') >= 0) econReal = r.economia ? (r.economia.jcp || 0) : 0;
          else if (ecoKey.indexOf('prejuízo') >= 0 || ecoKey.indexOf('prejuizo') >= 0) econReal = r.economia ? (r.economia.prejuizo || 0) : 0;
          else if (ecoKey.indexOf('sudam') >= 0) econReal = r.economia ? (r.economia.sudam || 0) : 0;
          else if (ecoKey.indexOf('incentiv') >= 0) econReal = r.economia ? (r.economia.incentivos || 0) : 0;
          else if (ecoKey.indexOf('deprecia') >= 0) econReal = r.economia ? (r.economia.depreciacao || 0) : 0;
          else if (ecoKey.indexOf('pis') >= 0 || ecoKey.indexOf('cofins') >= 0) econReal = r.economia ? (r.economia.pisCofinsCreditos || 0) : 0;
        }

        var pctBarra = totalEconOps > 0 ? _r(econReal / totalEconOps * 100) : 0;
        var corTipo = est.tipo === 'Dedução' ? '#2ECC71' : est.tipo === 'Timing' ? '#3498DB' : est.tipo === 'Crédito' ? '#9B59B6' : est.tipo === 'Redução' ? '#F39C12' : '#95A5A6';
        var corCompl = est.complexidade === 'Baixa' ? '#2ECC71' : est.complexidade === 'Média' ? '#F39C12' : '#E74C3C';
        var corRisco = est.risco === 'Baixo' ? '#2ECC71' : est.risco === 'Médio' ? '#F39C12' : '#E74C3C';

        sN8 += '<div class="res-oport-card" style="margin-bottom:8px;">';
        sN8 += '<div class="res-oport-header">';
        sN8 += '<div class="res-oport-titulo">' + est.nome + '</div>';
        sN8 += '<div class="res-oport-valor">' + _m(econReal) + '</div>';
        sN8 += '</div>';
        sN8 += '<div class="res-oport-tags">';
        sN8 += '<span class="res-tag" style="background:' + corTipo + ';">' + est.tipo + '</span>';
        sN8 += '<span class="res-tag" style="background:' + corCompl + ';">Compl.: ' + est.complexidade + '</span>';
        sN8 += '<span class="res-tag" style="background:' + corRisco + ';">Risco: ' + est.risco + '</span>';
        sN8 += '</div>';
        // Barra de progresso
        sN8 += '<div style="display:flex;align-items:center;margin:6px 0 4px;">';
        sN8 += '<div style="flex:1;background:#eee;border-radius:4px;height:10px;overflow:hidden;margin-right:8px;">';
        sN8 += '<div style="width:' + pctBarra + '%;background:' + corTipo + ';height:100%;border-radius:4px;transition:width 0.3s;"></div>';
        sN8 += '</div>';
        sN8 += '<span style="font-size:0.8em;color:#666;min-width:40px;text-align:right;">' + pctBarra.toFixed(0) + '%</span>';
        sN8 += '</div>';
        if (est.artigo) sN8 += '<div style="font-size:0.8em;color:#999;">' + est.artigo + '</div>';
        sN8 += '</div>';
      });
      sN8 += '</div>';
      html += _secao('H', 'Mapa de Estratégias de Economia — Rankings', sN8);
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  SEÇÃO NOVA 9 — ESTRUTURA LALUR — PARTE A E PARTE B
    // ═══════════════════════════════════════════════════════════════════════
    if (LR.lalur) {
      var sN9 = '';

      // Parte A — Adições e exclusões efetivamente realizadas
      sN9 += '<h3>Parte A — Demonstração do Lucro Real (Art. 277)</h3>';
      if (LR.lalur.parteA) {
        sN9 += '<p style="color:#666;font-size:0.9em;">' + (LR.lalur.parteA.descricao || '') + '</p>';
      }
      sN9 += '<table class="res-table"><thead><tr><th>Tipo</th><th>Descrição</th><th>Artigo</th><th>Valor</th></tr></thead><tbody>';
      // Adições efetivas
      if (r.lalur && r.lalur.adicoes && r.lalur.adicoes.length > 0) {
        r.lalur.adicoes.forEach(function (a) {
          // Lookup artigo no mapeamento LR.adicoes
          var artigoLookup = a.artigo || '';
          if (!artigoLookup && LR.adicoes) {
            for (var ai = 0; ai < LR.adicoes.length; ai++) {
              if (LR.adicoes[ai].id === a.id || (LR.adicoes[ai].descricao && a.desc && LR.adicoes[ai].descricao.indexOf(a.desc.substring(0, 15)) >= 0)) {
                artigoLookup = LR.adicoes[ai].artigo || '';
                break;
              }
            }
          }
          sN9 += '<tr><td style="color:#E74C3C;font-weight:600;">(+) Adição</td><td>' + (a.desc || a.descricao || '') + '</td><td><span class="res-artigo">' + artigoLookup + '</span></td><td class="res-valor">' + _m(a.valor) + '</td></tr>';
        });
      }
      // Exclusões efetivas
      if (r.lalur && r.lalur.exclusoes && r.lalur.exclusoes.length > 0) {
        r.lalur.exclusoes.forEach(function (e) {
          var artigoLookupE = e.artigo || '';
          if (!artigoLookupE && LR.exclusoes) {
            for (var ei = 0; ei < LR.exclusoes.length; ei++) {
              if (LR.exclusoes[ei].id === e.id || (LR.exclusoes[ei].descricao && e.desc && LR.exclusoes[ei].descricao.indexOf(e.desc.substring(0, 15)) >= 0)) {
                artigoLookupE = LR.exclusoes[ei].artigo || '';
                break;
              }
            }
          }
          sN9 += '<tr><td style="color:#2ECC71;font-weight:600;">(-) Exclusão</td><td>' + (e.desc || e.descricao || '') + '</td><td><span class="res-artigo">' + artigoLookupE + '</span></td><td class="res-valor">' + _m(e.valor) + '</td></tr>';
        });
      }
      sN9 += '</tbody></table>';

      // Parte B — Controles futuros
      sN9 += '<h3 style="margin-top:20px;">Parte B — Controle de Valores Futuros (Art. 277)</h3>';
      if (LR.lalur.parteB) {
        sN9 += '<p style="color:#666;font-size:0.9em;">' + (LR.lalur.parteB.descricao || '') + '</p>';
      }
      sN9 += '<table class="res-table"><thead><tr><th>Controle</th><th>Saldo Remanescente</th><th>Projeção de Reversão</th></tr></thead><tbody>';
      // Prejuízos remanescentes
      var saldoPrej = 0;
      if (r.compensacao && r.compensacao.resumo && r.compensacao.resumo.saldosPosCompensacao) {
        saldoPrej = r.compensacao.resumo.saldosPosCompensacao.prejuizoOperacional || r.compensacao.resumo.saldosPosCompensacao.prejuizoFiscal || 0;
      }
      if (saldoPrej > 0 || _n(d.prejuizoFiscal) > 0) {
        sN9 += '<tr><td>Prejuízos Fiscais a Compensar</td><td class="res-valor">' + _m(saldoPrej > 0 ? saldoPrej : _n(d.prejuizoFiscal)) + '</td><td>Compensável a 30% do lucro ajustado por período</td></tr>';
      }
      // Base negativa CSLL
      var saldoBN = 0;
      if (r.compensacao && r.compensacao.resumo && r.compensacao.resumo.saldosPosCompensacao) {
        saldoBN = r.compensacao.resumo.saldosPosCompensacao.baseNegativaCSLL || 0;
      }
      if (saldoBN > 0 || _n(d.baseNegativaCSLL) > 0) {
        sN9 += '<tr><td>Base Negativa da CSLL</td><td class="res-valor">' + _m(saldoBN > 0 ? saldoBN : _n(d.baseNegativaCSLL)) + '</td><td>Compensável a 30% da base positiva</td></tr>';
      }
      // Provisões não dedutíveis (reversão futura)
      var provND = _n(d.provisoesContingencias) + _n(d.provisoesGarantias);
      if (provND > 0) {
        sN9 += '<tr><td>Provisões Não Dedutíveis (reversão futura → exclusão)</td><td class="res-valor">' + _m(provND) + '</td><td>Exclusão quando da reversão/liquidação da provisão</td></tr>';
      }
      // Depreciação acelerada (diferença fiscal × contábil)
      if (r.depreciacaoDetalhada && r.depreciacaoDetalhada.depreciaAcelerada > 0 && r.depreciacaoDetalhada.depreciaNormal > 0) {
        var difDepFiscal = _r(r.depreciacaoDetalhada.depreciaAcelerada - r.depreciacaoDetalhada.depreciaNormal);
        if (difDepFiscal > 0) {
          sN9 += '<tr><td>Depreciação Acelerada (diferença fiscal × contábil)</td><td class="res-valor">' + _m(difDepFiscal) + '</td><td>Adição futura quando a depreciação contábil ultrapassar a fiscal</td></tr>';
        }
      }
      sN9 += '</tbody></table>';

      html += _secao('I', 'Estrutura LALUR — Parte A e Parte B', sN9);
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  SEÇÃO NOVA 10 — ALÍQUOTAS APLICÁVEIS (PARTE 5B)
    // ═══════════════════════════════════════════════════════════════════════
    if (LR.aliquotas) {
      var sAliq = '';
      sAliq += '<div class="res-detail-grid">';
      var aliqIRPJ = LR.aliquotas.irpj || {};
      var aliqCSLL = LR.aliquotas.csll || {};
      var aliqPC = LR.aliquotas.pisCofins || {};
      var aliqJCP = LR.aliquotas.jcp || {};
      var aliqComp = LR.aliquotas.compensacaoPrejuizo || {};
      sAliq += '<div class="res-detail-card"><h3>IRPJ <span class="res-artigo">' + (aliqIRPJ.artigoBase || 'Art. 225') + '</span></h3>';
      sAliq += '<table class="res-table">';
      sAliq += '<tr><td>Alíquota normal</td><td class="res-valor">' + _p(aliqIRPJ.normal || 0.15) + '</td></tr>';
      sAliq += '<tr><td>Adicional sobre excedente</td><td class="res-valor">' + _p(aliqIRPJ.adicional || 0.10) + '</td></tr>';
      sAliq += '<tr><td>Limite adicional/mês</td><td class="res-valor">' + _m(aliqIRPJ.limiteAdicionalMes || 20000) + '</td></tr>';
      sAliq += '</table></div>';
      sAliq += '<div class="res-detail-card"><h3>CSLL <span class="res-artigo">' + (aliqCSLL.artigoBase || 'Lei 7.689') + '</span></h3>';
      sAliq += '<table class="res-table">';
      sAliq += '<tr><td>Alíquota geral</td><td class="res-valor">' + _p(aliqCSLL.geral || 0.09) + '</td></tr>';
      sAliq += '<tr><td>Instituições financeiras</td><td class="res-valor">' + _p(aliqCSLL.financeiras || 0.15) + '</td></tr>';
      sAliq += '</table></div>';
      sAliq += '<div class="res-detail-card"><h3>PIS/COFINS NC <span class="res-artigo">' + (aliqPC.artigoBase || '') + '</span></h3>';
      sAliq += '<table class="res-table">';
      sAliq += '<tr><td>PIS não-cumulativo</td><td class="res-valor">' + _p(aliqPC.pisNaoCumulativo || 0.0165) + '</td></tr>';
      sAliq += '<tr><td>COFINS não-cumulativo</td><td class="res-valor">' + _p(aliqPC.cofinsNaoCumulativo || 0.076) + '</td></tr>';
      sAliq += '<tr><td>Total NC</td><td class="res-valor">' + _p(aliqPC.totalNaoCumulativo || 0.0925) + '</td></tr>';
      sAliq += '</table></div>';
      sAliq += '<div class="res-detail-card"><h3>JCP e Compensação</h3>';
      sAliq += '<table class="res-table">';
      sAliq += '<tr><td>IRRF sobre JCP <span class="res-artigo">' + (aliqJCP.artigoBase || '') + '</span></td><td class="res-valor">' + _p(aliqJCP.irrfAliquota || 0.175) + '</td></tr>';
      sAliq += '<tr><td>Trava compensação <span class="res-artigo">' + (aliqComp.artigoBase || '') + '</span></td><td class="res-valor">' + _p(aliqComp.trava30 || 0.30) + '</td></tr>';
      sAliq += '</table></div>';
      sAliq += '</div>';
      html += _secao('J', 'Alíquotas Aplicáveis — Referência', sAliq);
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  SEÇÃO NOVA 11 — OBRIGATORIEDADE LUCRO REAL — HIPÓTESES (PARTE 5B)
    // ═══════════════════════════════════════════════════════════════════════
    if (LR.obrigatoriedadeLucroReal && LR.obrigatoriedadeLucroReal.hipoteses) {
      var sObrig = '';
      sObrig += '<p style="color:#666;font-size:0.9em;">Artigo base: <span class="res-artigo">' + (LR.obrigatoriedadeLucroReal.artigo || 'Art. 257') + '</span></p>';
      sObrig += '<table class="res-table"><thead><tr><th>Inciso</th><th>Hipótese</th><th>Aplicável?</th></tr></thead><tbody>';
      LR.obrigatoriedadeLucroReal.hipoteses.forEach(function (hip) {
        var aplicavel = false;
        if (hip.id === 'RECEITA' && _n(d.receitaBrutaAnual) > (hip.valor || 78000000)) aplicavel = true;
        else if (hip.id === 'FINANCEIRA' && (d.ehInstituicaoFinanceira === true || d.ehInstituicaoFinanceira === "true" || d.ehFinanceira === true || d.ehFinanceira === "true")) aplicavel = true;
        else if (hip.id === 'LUCRO_EXTERIOR' && (d.temLucroExterior === true || d.temLucroExterior === "true")) aplicavel = true;
        else if (hip.id === 'BENEFICIO_FISCAL' && (d.temBeneficioFiscalIsencao === true || d.temBeneficioFiscalIsencao === "true")) aplicavel = true;
        else if (hip.id === 'ESTIMATIVA' && d.apuracaoLR === 'anual') aplicavel = true;
        else if (hip.id === 'FACTORING' && (d.ehFactoring === true || d.ehFactoring === "true")) aplicavel = true;
        else if (hip.id === 'SECURITIZADORA' && (d.ehSecuritizadora === true || d.ehSecuritizadora === "true")) aplicavel = true;
        sObrig += '<tr><td>' + (hip.inciso || '') + '</td><td>' + (hip.descricao || '') + '</td><td style="text-align:center;font-size:1.2em;">' + (aplicavel ? '✅' : '—') + '</td></tr>';
      });
      sObrig += '</tbody></table>';
      html += _secao('K', 'Hipóteses de Obrigatoriedade do Lucro Real', sObrig);
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  SEÇÃO NOVA 12 — IMPACTOS LEI 12.973/2014 (PARTE 5B)
    // ═══════════════════════════════════════════════════════════════════════
    if (LR.lei12973 && LR.lei12973.temas) {
      var sLei = '';
      sLei += '<p style="color:#666;font-size:0.9em;">Vigência: ' + (LR.lei12973.vigencia || '01/01/2015') + '</p>';
      sLei += '<table class="res-table"><thead><tr><th>Tema</th><th>Artigo</th><th>Relevante?</th></tr></thead><tbody>';
      LR.lei12973.temas.forEach(function (tema) {
        var relevante = false;
        if (tema.id === 'GOODWILL' && _n(d.valorGoodwill) > 0) relevante = true;
        else if (tema.id === 'JCP_PL' && r.jcpDetalhado && r.jcpDetalhado.jcpDedutivel > 0) relevante = true;
        else if (tema.id === 'PRE_OPERACIONAL' && _n(d.despesasPreOperacionais) > 0) relevante = true;
        else if (tema.id === 'RECEITA_BRUTA') relevante = true;
        sLei += '<tr><td><strong>' + (tema.label || '') + '</strong></td><td><span class="res-artigo">' + (tema.artigo || '') + '</span></td><td style="text-align:center;">' + (relevante ? '✅ Sim' : '—') + '</td></tr>';
      });
      sLei += '</tbody></table>';
      html += _secao('L', 'Impactos da Lei 12.973/2014', sLei);
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  SEÇÃO NOVA 13 — TABELA DE RETENÇÕES APLICÁVEIS (PARTE 5B)
    // ═══════════════════════════════════════════════════════════════════════
    if (LR.retencoes) {
      var sRet = '';
      sRet += '<table class="res-table"><thead><tr><th>Retenção</th><th>Alíquota</th><th>Artigo</th><th>Tratamento</th></tr></thead><tbody>';
      var retKeys = ['irrfServicosPJ', 'irrfAdmPublica', 'csrf', 'beneficiarioNaoIdentificado', 'jcp', 'dividendos'];
      retKeys.forEach(function (rk) {
        var retItem = LR.retencoes[rk];
        if (retItem) {
          var aliqStr = retItem.aliquota !== undefined ? _p(retItem.aliquota) : (retItem.aliquotas ? _p(retItem.aliquotas.total) : '—');
          sRet += '<tr><td><strong>' + (retItem.descricao || rk) + '</strong></td><td class="res-valor">' + aliqStr + '</td><td><span class="res-artigo">' + (retItem.artigo || '') + '</span></td><td>' + (retItem.tratamento || '') + '</td></tr>';
        }
      });
      sRet += '</tbody></table>';
      html += _secao('M', 'Tabela de Retenções na Fonte Aplicáveis', sRet);
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  SEÇÃO NOVA 14 — TABELA IRPF REFERÊNCIA (PARTE 5B)
    // ═══════════════════════════════════════════════════════════════════════
    if (LR.tabelaIRPF && LR.tabelaIRPF.tabela_2025) {
      var sIRPF = '';
      sIRPF += '<p style="color:#666;font-size:0.9em;">Referência para retenções sobre PF — <span class="res-artigo">' + (LR.tabelaIRPF.artigo || 'Art. 677') + '</span> — Ano-base: ' + (LR.tabelaIRPF.anoBase || '2025') + '</p>';
      sIRPF += '<table class="res-table"><thead><tr><th>Faixa</th><th>Até (R$)</th><th>Alíquota</th><th>Dedução</th></tr></thead><tbody>';
      LR.tabelaIRPF.tabela_2025.forEach(function (f) {
        sIRPF += '<tr><td>' + f.faixa + 'ª</td><td class="res-valor">' + (f.ate === Infinity ? 'Acima' : _m(f.ate)) + '</td><td class="res-valor">' + _p(f.aliquota) + '</td><td class="res-valor">' + _m(f.deducao) + '</td></tr>';
      });
      sIRPF += '</tbody></table>';
      if (LR.tabelaIRPF.deducaoDependente_2025) {
        sIRPF += '<p style="color:#666;font-size:0.85em;">Dedução por dependente: ' + _m(LR.tabelaIRPF.deducaoDependente_2025) + '</p>';
      }
      html += _secao('N', 'Tabela IRPF — Referência para Retenções PF', sIRPF);
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  SEÇÃO NOVA 15 — ÁRVORE DE DECISÃO E ELEGIBILIDADE (PARTE 5B)
    // ═══════════════════════════════════════════════════════════════════════
    if (r.arvoreDecisao) {
      var sArvore = '';
      if (r.arvoreDecisao.recomendacoes && r.arvoreDecisao.recomendacoes.length > 0) {
        sArvore += '<div class="res-oportunidades">';
        r.arvoreDecisao.recomendacoes.forEach(function (rec, i) {
          var corPri = rec.prioridade === 'ALTA' ? '#E74C3C' : rec.prioridade === 'MEDIA' ? '#F39C12' : '#2ECC71';
          sArvore += '<div class="res-oport-card" style="border-left:4px solid ' + corPri + ';margin-bottom:6px;">';
          sArvore += '<div class="res-oport-header"><div class="res-oport-rank">' + (i + 1) + '</div>';
          sArvore += '<div class="res-oport-titulo">' + (rec.titulo || rec.descricao || '') + '</div></div>';
          if (rec.impacto) sArvore += '<div style="font-size:0.85em;color:#666;padding:4px 12px;">' + rec.impacto + '</div>';
          sArvore += '</div>';
        });
        sArvore += '</div>';
      } else if (typeof r.arvoreDecisao === 'object') {
        sArvore += '<div class="res-alerta res-alerta-info"><span class="res-alerta-icon">&#x1F535;</span>Árvore de decisão processada. Consulte as oportunidades ranqueadas para o plano de ação detalhado.</div>';
      }
      html += _secao('O', 'Árvore de Decisão — Otimização Tributária', sArvore);
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  SEÇÃO NOVA 16 — COMPARATIVO SUDAM (PARTE 5B)
    // ═══════════════════════════════════════════════════════════════════════
    if (r.comparativoSUDAM) {
      var sCompSUDAM = '';
      if (r.comparativoSUDAM.simplesNacional !== undefined && r.comparativoSUDAM.lucroRealSUDAM !== undefined) {
        sCompSUDAM += '<table class="res-table"><thead><tr><th>Regime</th><th>Carga Tributária</th></tr></thead><tbody>';
        sCompSUDAM += '<tr><td>Simples Nacional (estimativa)</td><td class="res-valor">' + _m(r.comparativoSUDAM.simplesNacional) + '</td></tr>';
        sCompSUDAM += '<tr><td>Lucro Real com SUDAM</td><td class="res-valor res-economia">' + _m(r.comparativoSUDAM.lucroRealSUDAM) + '</td></tr>';
        var difComp = _r((r.comparativoSUDAM.simplesNacional || 0) - (r.comparativoSUDAM.lucroRealSUDAM || 0));
        sCompSUDAM += '<tr class="res-total"><td><strong>' + (difComp > 0 ? 'Economia com LR+SUDAM' : 'Diferença') + '</strong></td><td class="res-valor"><strong>' + _m(difComp) + '</strong></td></tr>';
        sCompSUDAM += '</tbody></table>';
      } else {
        sCompSUDAM += '<div class="res-alerta res-alerta-info"><span class="res-alerta-icon">&#x1F535;</span>Comparativo SUDAM processado. Dados detalhados disponíveis no relatório consolidado.</div>';
      }
      html += _secao('P', 'Comparativo: Simples Nacional vs Lucro Real SUDAM', sCompSUDAM);
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  SEÇÃO NOVA 17 — PDD FISCAL — CRITÉRIOS E FAIXAS DE VALOR (PARTE 5B)
    // ═══════════════════════════════════════════════════════════════════════
    if (LR.pdd && (LR.pdd.criterios || LR.pdd.faixasValor)) {
      var sPDD = '';

      // CORREÇÃO INC-03 (completa): Os artigos do mapeamento externo (LR.pdd) podem
      // conter "Art. 347-351" (Avaliação de Estoques) em vez de "Art. 340-342" (PDD).
      // Sanitizar todas as referências de artigo vindas do mapeamento.
      function _fixPDDArt(artigo) {
        if (!artigo) return '';
        return String(artigo)
          .replace(/Art\.\s*347[\s\-–]+351/gi, 'Art. 340-342')
          .replace(/\b347\b/g, '340')
          .replace(/\b348\b/g, '340')
          .replace(/\b349\b/g, '341')
          .replace(/\b350\b/g, '341')
          .replace(/\b351\b/g, '342');
      }

      var pddArtigoHeader = _fixPDDArt(LR.pdd.artigo) || 'Art. 340-342';

      if (LR.pdd.criterios && LR.pdd.criterios.length > 0) {
        sPDD += '<h4>Critérios para Dedutibilidade <span class="res-artigo">' + pddArtigoHeader + '</span></h4>';
        sPDD += '<table class="res-table"><thead><tr><th>Critério</th><th>Descrição</th><th>Artigo</th></tr></thead><tbody>';
        LR.pdd.criterios.forEach(function (c) {
          sPDD += '<tr><td><strong>' + (c.id || '') + '</strong></td><td>' + (c.descricao || '') + '</td><td><span class="res-artigo">' + _fixPDDArt(c.artigo) + '</span></td></tr>';
        });
        sPDD += '</tbody></table>';
      }
      if (LR.pdd.faixasValor && LR.pdd.faixasValor.length > 0) {
        sPDD += '<h4 style="margin-top:12px;">Faixas de Valor — Requisitos por Faixa</h4>';
        // CORREÇÃO INC-01: Nota sobre o limite padrão correto
        sPDD += '<div class="res-alerta res-alerta-info" style="margin-bottom:8px;font-size:0.85em;"><span class="res-alerta-icon">&#x1F535;</span>' +
          '<strong>Referência padrão (IN SRF 93/97 + jurisprudência CARF):</strong> ' +
          'Créditos até R$ 15.000 por devedor dispensam procedimento judicial — basta protesto extrajudicial. ' +
          'Acima de R$ 15.000: necessário ação judicial ou declaração de insolvência.</div>';
        sPDD += '<table class="res-table"><thead><tr><th>Faixa</th><th>Requisito</th><th>Artigo</th></tr></thead><tbody>';
        LR.pdd.faixasValor.forEach(function (f) {
          var faixaLabel = f.ate ? 'Até ' + _m(f.ate) : (f.acima ? 'Acima de ' + _m(f.acima) : '—');
          sPDD += '<tr><td><strong>' + faixaLabel + '</strong></td><td>' + (f.descricao || '') + '</td><td><span class="res-artigo">' + _fixPDDArt(f.artigo) + '</span></td></tr>';
        });
        sPDD += '</tbody></table>';
      }
      if (LR.pdd.vedacoes && LR.pdd.vedacoes.length > 0) {
        sPDD += '<div class="res-alerta res-alerta-warn" style="margin-top:8px;"><span class="res-alerta-icon">&#x26A0;&#xFE0F;</span><strong>Vedações:</strong> ' + LR.pdd.vedacoes.join('; ') + '</div>';
      }
      html += _secao('Q', 'PDD Fiscal — Critérios e Faixas de Valor', sPDD);
      // CORREÇÃO INC-01: Nota sobre o limite correto de R$ 15.000 (IN SRF 93/97)
      // Os faixasValor do mapeamento externo podem usar limites diferentes (R$5.000/R$30.000)
      // mas o limite correto conforme IN SRF 93/97 e jurisprudência CARF é R$ 15.000
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  SEÇÃO NOVA 18 — ESTOQUES — VEDAÇÕES (PARTE 5B)
    // ═══════════════════════════════════════════════════════════════════════
    if (LR.estoques && LR.estoques.vedacoes && LR.estoques.vedacoes.length > 0) {
      var sEstoque = '';
      if (d.metodoEstoque) {
        var metodoSelecionado = null;
        if (LR.estoques.permitidos) {
          LR.estoques.permitidos.forEach(function (m) {
            if (m.id === d.metodoEstoque) metodoSelecionado = m;
          });
        }
        if (metodoSelecionado) {
          sEstoque += '<p>Método selecionado: <strong>' + (metodoSelecionado.descricao || d.metodoEstoque) + '</strong> <span class="res-artigo">' + (metodoSelecionado.artigo || '') + '</span></p>';
        }
      }
      sEstoque += '<h4>Vedações ao Custeio de Estoques <span class="res-artigo">Art. 310 RIR/2018</span></h4>';
      sEstoque += '<div class="res-oportunidades">';
      LR.estoques.vedacoes.forEach(function (v) {
        sEstoque += '<div class="res-alerta res-alerta-warn" style="margin-bottom:4px;"><span class="res-alerta-icon">&#x26A0;&#xFE0F;</span>' + v + '</div>';
      });
      sEstoque += '</div>';
      if (LR.estoques.permitidos && LR.estoques.permitidos.length > 0) {
        sEstoque += '<h4 style="margin-top:12px;">Métodos Permitidos</h4>';
        sEstoque += '<table class="res-table"><thead><tr><th>Método</th><th>Descrição</th><th>Artigo</th></tr></thead><tbody>';
        LR.estoques.permitidos.forEach(function (m) {
          var isSel = (d.metodoEstoque === m.id);
          sEstoque += '<tr' + (isSel ? ' style="background:rgba(16,185,129,0.1);"' : '') + '><td><strong>' + (m.id || '') + '</strong>' + (isSel ? ' ✅' : '') + '</td><td>' + (m.descricao || '') + '</td><td><span class="res-artigo">' + (m.artigo || '') + '</span></td></tr>';
        });
        sEstoque += '</tbody></table>';
      }
      html += _secao('R', 'Avaliação de Estoques — Métodos e Vedações', sEstoque);
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  SEÇÃO NOVA 19 — EXCLUSÕES DO LUCRO DA EXPLORAÇÃO (PARTE 5B)
    // ═══════════════════════════════════════════════════════════════════════
    if (r.lucroExploracaoResult && LR.exclusoesLucroExploracao) {
      var sExcLE = '';
      sExcLE += '<p style="color:#666;font-size:0.9em;">Para cálculo do lucro da exploração (base dos incentivos SUDAM/SUDENE), devem ser ajustados os seguintes itens:</p>';
      var excluirLE = LR.exclusoesLucroExploracao.excluirDoLucroLiquido || LR.exclusoesLucroExploracao.excluir || [];
      var adicionarLE = LR.exclusoesLucroExploracao.adicionarAoLucroLiquido || LR.exclusoesLucroExploracao.adicionar || [];
      if (excluirLE.length > 0) {
        sExcLE += '<h4>Exclusões do Lucro Líquido</h4>';
        sExcLE += '<table class="res-table"><thead><tr><th>Item</th><th>Descrição</th><th>Artigo</th></tr></thead><tbody>';
        excluirLE.forEach(function (e) {
          sExcLE += '<tr><td>(-)</td><td>' + (e.descricao || e.label || '') + '</td><td><span class="res-artigo">' + (e.artigo || '') + '</span></td></tr>';
        });
        sExcLE += '</tbody></table>';
      }
      if (adicionarLE.length > 0) {
        sExcLE += '<h4 style="margin-top:12px;">Adições ao Lucro Líquido</h4>';
        sExcLE += '<table class="res-table"><thead><tr><th>Item</th><th>Descrição</th><th>Artigo</th></tr></thead><tbody>';
        adicionarLE.forEach(function (a) {
          sExcLE += '<tr><td>(+)</td><td>' + (a.descricao || a.label || '') + '</td><td><span class="res-artigo">' + (a.artigo || '') + '</span></td></tr>';
        });
        sExcLE += '</tbody></table>';
      }
      if (r.lucroExploracaoResult.lucroExploracao !== undefined) {
        sExcLE += '<div style="margin-top:12px;padding:8px 12px;background:rgba(16,185,129,0.08);border-radius:8px;">';
        sExcLE += '<strong>Lucro da Exploração Calculado: ' + _m(r.lucroExploracaoResult.lucroExploracao) + '</strong>';
        if (r.lucroExploracaoResult.reducao75 !== undefined) {
          sExcLE += '<br>Redução 75% aplicável: <span class="res-economia"><strong>' + _m(r.lucroExploracaoResult.reducao75) + '</strong></span>';
        }
        sExcLE += '</div>';
      }
      html += _secao('S', 'Lucro da Exploração — Ajustes SUDAM/SUDENE', sExcLE);
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  SEÇÃO NOVA 20 — ACRÉSCIMOS MORATÓRIOS E MULTAS (Bloco H)
    //  Arts. 44, 47, 61, 63 — Lei 9.430/1996 + Lei 14.689/2023
    // ═══════════════════════════════════════════════════════════════════════
    if (r.acrescimosMoratorios || r.multaOficio || LR.multasEMora) {
      var sT = '';

      // Tabela de referência — parâmetros legais
      if (LR.multasEMora) {
        var mm = LR.multasEMora;
        sT += '<h4>Parâmetros Legais — Multas e Mora</h4>';
        sT += '<table class="res-table"><thead><tr><th>Parâmetro</th><th>Valor</th><th>Base Legal</th></tr></thead><tbody>';
        if (mm.multaMora) {
          sT += '<tr><td>Multa de Mora (por dia de atraso)</td><td>' + _p(mm.multaMora.taxaDiaria || 0.0033) + '</td><td><span class="res-artigo">' + (mm.multaMora.artigo || 'Art. 61') + '</span></td></tr>';
          sT += '<tr><td>Teto da Multa de Mora</td><td>' + _p(mm.multaMora.teto || 0.20) + '</td><td><span class="res-artigo">Art. 61</span></td></tr>';
        }
        if (mm.jurosMora) {
          sT += '<tr><td>Juros de Mora</td><td>SELIC acumulada + 1% mês pagamento</td><td><span class="res-artigo">' + (mm.jurosMora.artigo || 'Art. 61, §3º') + '</span></td></tr>';
        }
        if (mm.multaOficio) {
          sT += '<tr><td>Multa de Ofício — Padrão</td><td>' + _p(mm.multaOficio.padrao || 0.75) + '</td><td><span class="res-artigo">' + (mm.multaOficio.artigo || 'Art. 44') + '</span></td></tr>';
          sT += '<tr><td>Multa de Ofício — Fraude/Sonegação</td><td>' + _p(mm.multaOficio.fraude || 1.50) + '</td><td><span class="res-artigo">Art. 44, §1º</span></td></tr>';
          if (mm.multaOficio.agravamento) {
            sT += '<tr><td>Agravamento (não atendimento intimação)</td><td>+' + _p(mm.multaOficio.agravamento.naoAtendimentoIntimacao || 0.50) + ' (teto ' + _p(mm.multaOficio.agravamento.percentualMaximo || 2.25) + ')</td><td><span class="res-artigo">Art. 44, §2º</span></td></tr>';
          }
          if (mm.multaOficio.reducoes) {
            sT += '<tr><td>Redução — pagamento em 30 dias</td><td>-' + _p(mm.multaOficio.reducoes.pagamentoOuParcelamento30dias || 0.50) + '</td><td><span class="res-artigo">Art. 44, §3º</span></td></tr>';
            if (mm.multaOficio.reducoes.conformidadeLei14689) {
              sT += '<tr><td>Redução — Conformidade (Lei 14.689/2023)</td><td>Até -' + _p(mm.multaOficio.reducoes.conformidadeLei14689.comTransacao || 0.50) + ' c/ transação</td><td><span class="res-artigo">' + (mm.multaOficio.reducoes.conformidadeLei14689.artigo || 'Lei 14.689/2023') + '</span></td></tr>';
            }
          }
        }
        if (mm.prazoEspontaneo) {
          sT += '<tr><td>Prazo para Pagamento Espontâneo</td><td>' + (mm.prazoEspontaneo.diasAposTermoFiscalizacao || 20) + ' dias do termo de fiscalização</td><td><span class="res-artigo">' + (mm.prazoEspontaneo.artigo || 'Art. 47') + '</span></td></tr>';
        }
        sT += '</tbody></table>';
      }

      // Resultado calculado — acréscimos moratórios
      if (r.acrescimosMoratorios) {
        var am = r.acrescimosMoratorios;
        sT += '<h4 style="margin-top:16px;">Simulação de Acréscimos Moratórios</h4>';
        sT += '<div class="res-cards-row">';
        sT += '<div class="res-card"><div class="res-card-label">Valor Original</div><div class="res-card-value">' + _m(am.valorOriginal || 0) + '</div></div>';
        sT += '<div class="res-card"><div class="res-card-label">Multa de Mora</div><div class="res-card-value res-negativo">' + _m(am.multaMora || 0) + '</div></div>';
        sT += '<div class="res-card"><div class="res-card-label">Juros (SELIC)</div><div class="res-card-value res-negativo">' + _m(am.jurosMora || 0) + '</div></div>';
        sT += '<div class="res-card"><div class="res-card-label">Total a Pagar</div><div class="res-card-value" style="color:#e74c3c;font-weight:700;">' + _m(am.valorTotal || 0) + '</div></div>';
        sT += '</div>';
        if (am.espontaneo) {
          sT += '<div class="res-alert res-alert-info">Pagamento espontâneo — sem multa de ofício. Incide apenas multa de mora + juros SELIC.</div>';
        }
      }

      // Resultado calculado — multa de ofício
      if (r.multaOficio) {
        var mo = r.multaOficio;
        sT += '<h4 style="margin-top:16px;">Simulação de Multa de Ofício</h4>';
        sT += '<div class="res-cards-row">';
        sT += '<div class="res-card"><div class="res-card-label">Multa Calculada</div><div class="res-card-value res-negativo">' + _m(mo.multaOficio || mo.valorFinal || 0) + '</div></div>';
        sT += '<div class="res-card"><div class="res-card-label">Percentual Aplicado</div><div class="res-card-value">' + _p(mo.percentualAplicado || 0.75) + '</div></div>';
        sT += '</div>';
        if (mo.reducoes && mo.reducoes.length > 0) {
          sT += '<div class="res-alert res-alert-success">Reduções aplicadas: ' + mo.reducoes.join('; ') + '</div>';
        }
      }

      // Suspensão de multa
      if (r.suspensaoMulta && r.suspensaoMulta.suspensa) {
        sT += '<div class="res-alert res-alert-success" style="margin-top:12px;"><strong>Multa de ofício suspensa</strong> — ' + (r.suspensaoMulta.motivo || 'Liminar/Tutela vigente') + ' <span class="res-artigo">Art. 63</span></div>';
      }

      // Prazo espontâneo
      if (r.prazoEspontaneo && r.prazoEspontaneo.prazoFinal) {
        sT += '<div class="res-alert res-alert-warning" style="margin-top:12px;"><strong>Prazo Espontâneo:</strong> até ' + new Date(r.prazoEspontaneo.prazoFinal).toLocaleDateString('pt-BR') + ' (' + (r.prazoEspontaneo.artigo || 'Art. 47') + '). Pagamento dentro deste prazo evita multa de ofício.</div>';
      }

      html += _secao('T', 'Acréscimos Moratórios e Multas', sT);
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  SEÇÃO NOVA 21 — COMPENSAÇÃO PER/DCOMP (Bloco I)
    //  Arts. 73, 74, 74-A — CTN + Lei 14.873/2024
    // ═══════════════════════════════════════════════════════════════════════
    if (r.compensacaoPERDCOMP || r.compensacaoJudicial || LR.compensacaoPERDCOMP) {
      var sU = '';

      // Tabela de vedações — referência legal
      if (LR.compensacaoPERDCOMP) {
        var cp = LR.compensacaoPERDCOMP;
        if (cp.vedacoes && cp.vedacoes.length > 0) {
          sU += '<h4>Vedações à Compensação (§3º do Art. 74)</h4>';
          sU += '<table class="res-table"><thead><tr><th>Hipótese</th><th>Descrição</th><th>Artigo</th></tr></thead><tbody>';
          cp.vedacoes.forEach(function (v) {
            sU += '<tr><td>' + (v.id || '') + '</td><td>' + (v.descricao || '') + '</td><td><span class="res-artigo">' + (v.artigo || '') + '</span></td></tr>';
          });
          sU += '</tbody></table>';
        }

        if (cp.hipotesesNaoDeclarada && cp.hipotesesNaoDeclarada.length > 0) {
          sU += '<h4 style="margin-top:16px;">Hipóteses de "Não Declarada" (§12 do Art. 74)</h4>';
          sU += '<table class="res-table"><thead><tr><th>Hipótese</th><th>Descrição</th><th>Artigo</th></tr></thead><tbody>';
          cp.hipotesesNaoDeclarada.forEach(function (h) {
            sU += '<tr><td>' + (h.id || '') + '</td><td>' + (h.descricao || '') + '</td><td><span class="res-artigo">' + (h.artigo || '') + '</span></td></tr>';
          });
          sU += '</tbody></table>';
        }

        if (cp.multaCompensacaoIndevida) {
          sU += '<div class="res-alert res-alert-danger" style="margin-top:12px;"><strong>⚠️ Multa por Compensação Indevida:</strong> ' + _p(cp.multaCompensacaoIndevida.percentual || 0.50) + ' sobre o valor não homologado (' + (cp.multaCompensacaoIndevida.artigo || '§17') + ')</div>';
        }

        if (cp.compensacaoJudicial) {
          sU += '<div class="res-alert res-alert-warning" style="margin-top:12px;"><strong>Limite Judicial (Art. 74-A):</strong> ' + (cp.compensacaoJudicial.descricao || 'Créditos > R$ 10 milhões — 1/60 por mês') + '</div>';
        }

        if (cp.prazoDecadencial) {
          sU += '<p style="color:#666;font-size:0.9em;margin-top:8px;">' + (cp.prazoDecadencial.descricao || '') + ' <span class="res-artigo">' + (cp.prazoDecadencial.artigo || 'Art. 168 CTN') + '</span></p>';
        }
      }

      // Resultado calculado — análise PER/DCOMP
      if (r.compensacaoPERDCOMP) {
        var pdc = r.compensacaoPERDCOMP;
        sU += '<h4 style="margin-top:16px;">Análise da Compensação Solicitada</h4>';
        sU += '<div class="res-cards-row">';
        sU += '<div class="res-card"><div class="res-card-label">Status</div><div class="res-card-value" style="color:' + (pdc.compensacaoPermitida ? '#2ecc71' : '#e74c3c') + ';">' + (pdc.compensacaoPermitida ? '✅ Permitida' : '❌ Vedada') + '</div></div>';
        if (pdc.riscoMulta50 && pdc.riscoMulta50.aplicavel) {
          sU += '<div class="res-card"><div class="res-card-label">Risco Multa 50%</div><div class="res-card-value res-negativo">' + _m(pdc.riscoMulta50.valor || 0) + '</div></div>';
        }
        if (pdc.impactoLucroReal) {
          var impLR = pdc.impactoLucroReal;
          if ((impLR.reducaoIRPJ || 0) > 0 || (impLR.reducaoCSLL || 0) > 0) {
            sU += '<div class="res-card"><div class="res-card-label">Redução IRPJ</div><div class="res-card-value res-economia">' + _m(impLR.reducaoIRPJ || 0) + '</div></div>';
            sU += '<div class="res-card"><div class="res-card-label">Redução CSLL</div><div class="res-card-value res-economia">' + _m(impLR.reducaoCSLL || 0) + '</div></div>';
          }
        }
        sU += '</div>';

        if (pdc.vedacoes && pdc.vedacoes.length > 0) {
          sU += '<div class="res-alert res-alert-danger">Vedações identificadas: ' + pdc.vedacoes.join(', ') + '</div>';
        }
        if (pdc.hipotesesNaoDeclarada && pdc.hipotesesNaoDeclarada.length > 0) {
          sU += '<div class="res-alert res-alert-warning">Risco de "não declarada": ' + pdc.hipotesesNaoDeclarada.join(', ') + '</div>';
        }
        if (pdc.recomendacoes && pdc.recomendacoes.length > 0) {
          sU += '<h4 style="margin-top:12px;">Recomendações</h4><ul>';
          pdc.recomendacoes.forEach(function (rec) { sU += '<li>' + rec + '</li>'; });
          sU += '</ul>';
        }
      }

      // Resultado calculado — compensação judicial (1/60)
      if (r.compensacaoJudicial && r.compensacaoJudicial.sujeito) {
        var cj = r.compensacaoJudicial;
        sU += '<h4 style="margin-top:16px;">Cronograma de Compensação Judicial (Art. 74-A)</h4>';
        sU += '<div class="res-cards-row">';
        sU += '<div class="res-card"><div class="res-card-label">Limite Mensal</div><div class="res-card-value">' + _m(cj.limiteMensal || 0) + '</div></div>';
        sU += '<div class="res-card"><div class="res-card-label">Prazo Total</div><div class="res-card-value">' + (cj.prazoTotal || 60) + ' meses</div></div>';
        sU += '</div>';
        if (cj.cronograma && cj.cronograma.length > 0) {
          sU += '<details style="margin-top:8px;"><summary style="cursor:pointer;font-weight:600;">Ver cronograma mês a mês (' + cj.cronograma.length + ' parcelas)</summary>';
          sU += '<table class="res-table" style="margin-top:6px;"><thead><tr><th>Mês</th><th>Compensação</th><th>Saldo Remanescente</th></tr></thead><tbody>';
          cj.cronograma.forEach(function (p) {
            sU += '<tr><td>' + (p.mes || p.parcela || '') + '</td><td>' + _m(p.valor || p.compensacao || 0) + '</td><td>' + _m(p.saldo || p.saldoRemanescente || 0) + '</td></tr>';
          });
          sU += '</tbody></table></details>';
        }
      }

      html += _secao('U', 'Compensação PER/DCOMP', sU);
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  SEÇÃO 13 — CRONOGRAMA DE IMPLEMENTAÇÃO (condicional)
    // ═══════════════════════════════════════════════════════════════════════
    var situacao = d.situacaoAtual || '';
    if (situacao === 'vai_migrar' || situacao === 'avaliando') {
      var s13 = '<div class="res-timeline">';
      var etapas = [
        { fase: "1", titulo: "Diagnóstico Tributário", prazo: "Semana 1-2", desc: "Análise completa da situação fiscal atual, identificação de riscos e oportunidades." },
        { fase: "2", titulo: "Levantamento de Saldos", prazo: "Semana 2-3", desc: "Apurar saldos de prejuízo fiscal, base negativa, retenções acumuladas e créditos de PIS/COFINS." },
        { fase: "3", titulo: "Ajustes Contábeis (IFRS/CPC)", prazo: "Semana 3-5", desc: "Adequar contabilidade aos padrões IFRS. Conciliações e ajustes de classificação." },
        { fase: "4", titulo: "Implementação LALUR/LACS", prazo: "Semana 5-7", desc: "Estruturar Parte A e Parte B do LALUR. Configurar sistema de adições e exclusões." },
        { fase: "5", titulo: "Setup ECD/ECF/EFD", prazo: "Semana 7-9", desc: "Configurar escriturações digitais. Mapear plano de contas referencial." },
        { fase: "6", titulo: "Créditos PIS/COFINS", prazo: "Semana 8-10", desc: "Mapear todos os insumos elegíveis a créditos. Implementar controles de apropriação." },
        { fase: "7", titulo: "JCP e Incentivos", prazo: "Semana 10-11", desc: "Estruturar distribuição de JCP. Cadastrar nos programas de incentivos aplicáveis (PAT, FIA, etc.)." },
        { fase: "8", titulo: "Go-Live e Monitoramento", prazo: "Semana 12+", desc: "Primeira apuração no Lucro Real. Monitoramento contínuo dos indicadores fiscais." }
      ];
      etapas.forEach(function (et) {
        s13 += '<div class="res-timeline-item">';
        s13 += '<div class="res-timeline-marker">' + et.fase + '</div>';
        s13 += '<div class="res-timeline-content">';
        s13 += '<div class="res-timeline-titulo"><strong>' + et.titulo + '</strong> <span class="res-timeline-prazo">' + et.prazo + '</span></div>';
        s13 += '<div class="res-timeline-desc">' + et.desc + '</div>';
        s13 += '</div></div>';
      });
      s13 += '</div>';
      html += _secao(13, 'Cronograma de Implementação', s13);
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  SEÇÃO 14 — RODAPÉ E AÇÕES
    // ═══════════════════════════════════════════════════════════════════════
    var s14 = '<div class="res-footer">';
    if (elab.nome) {
      s14 += '<div class="res-footer-elaborador"><strong>Elaborado por:</strong> ' + elab.nome;
      if (elab.registro) s14 += ' — ' + elab.registro;
      s14 += '</div>';
    }
    s14 += '<div class="res-footer-data"><strong>Data de geração:</strong> ' + dataFormatada + ' às ' + dataHoje.toLocaleTimeString("pt-BR") + '</div>';
    s14 += '<div class="res-footer-base">Base legal: RIR/2018 (Decreto 9.580/2018), Lei 7.689/1988, Lei 9.430/1996, Lei 10.637/2002, Lei 10.833/2003, Lei 14.689/2023, Lei 14.873/2024, LC 116/2003</div>';
    s14 += '<div class="res-footer-disclaimer">' + cfg.disclaimer + '</div>';
    if (cfg.mostrarMarcaImpost) {
      s14 += '<div class="res-footer-marca">' + cfg.nomeProduto + ' v' + VERSAO + ' — ' + cfg.subtitulo + '</div>';
    }
    s14 += '<div class="res-actions">';
    s14 += '<button class="res-btn" onclick="window.print()">Imprimir</button>';
    s14 += '<button class="res-btn" onclick="LucroRealEstudos.exportarJSON()">Exportar JSON</button>';
    s14 += '<button class="res-btn" onclick="LucroRealEstudos.voltarWizard()">Editar Dados</button>';
    s14 += '<button class="res-btn" onclick="LucroRealEstudos.novoEstudo()">Novo Estudo</button>';
    s14 += '</div>';
    s14 += '</div>';
    html += _secao(14, '', s14);

    // Gráfico alíquota efetiva (gauge)
    html += '<div class="res-chart-container res-chart-aliquota" style="max-width:250px;margin:0 auto 2rem;"><canvas id="chartAliquota" width="250" height="250"></canvas></div>';

    // ═══ Inserir HTML no container ═══
    resContainer.innerHTML = html;

    // ═══ Renderizar gráficos após DOM atualizar ═══
    requestAnimationFrame(function () {
      renderCharts(r);
    });
  }

  // ═══════════════════════════════════════════════════════════════════════════
  //  RENDER GRÁFICOS (Chart.js) — 7 gráficos
  // ═══════════════════════════════════════════════════════════════════════════

  function renderCharts(r) {
    if (typeof Chart === "undefined") {
      console.warn("[IMPOST.] Chart.js não carregado — gráficos não renderizados.");
      return;
    }

    var CORES = {
      irpj: '#E74C3C',
      csll: '#F39C12',
      pisCofins: '#3498DB',
      iss: '#9B59B6',
      economia: '#2ECC71',
      bruto: '#95A5A6',
      otimizado: '#27AE60',
      pessimista: '#E74C3C',
      base: '#3498DB',
      otimista: '#2ECC71'
    };

    var chartDefaults = {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { position: 'bottom', labels: { color: '#ccc', font: { family: "'DM Sans', sans-serif", size: 12 } } },
        tooltip: {
          callbacks: {
            label: function (ctx) {
              return ctx.dataset.label + ': ' + _m(ctx.parsed.y || ctx.parsed || 0);
            }
          }
        }
      },
      scales: {
        x: { ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,0.06)' } },
        y: { ticks: { color: '#aaa', callback: function (v) { return _m(v); } }, grid: { color: 'rgba(255,255,255,0.06)' } }
      }
    };

    // ── Gráfico 1: Doughnut — Composição ──
    var elComp = $("chartComposicao");
    if (elComp && r.composicao) {
      new Chart(elComp, {
        type: 'doughnut',
        data: {
          labels: ['IRPJ', 'CSLL', 'PIS/COFINS', 'ISS'],
          datasets: [{
            data: [r.composicao.irpj.valor, r.composicao.csll.valor, r.composicao.pisCofins.valor, r.composicao.iss.valor],
            backgroundColor: [CORES.irpj, CORES.csll, CORES.pisCofins, CORES.iss],
            borderColor: '#161e31',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { position: 'bottom', labels: { color: '#ccc' } },
            tooltip: {
              callbacks: { label: function (ctx) { return ctx.label + ': ' + _m(ctx.parsed); } }
            }
          }
        }
      });
    }

    // ── Gráfico 2: Bar horizontal — Ranking de economias ──
    var elEcon = $("chartEconomias");
    if (elEcon && r.economia) {
      var econLabels = [];
      var econValues = [];
      var econColors = [];
      var eco = r.economia;
      var items = [
        { label: 'JCP', val: eco.jcp },
        { label: 'SUDAM/SUDENE', val: eco.sudam },
        { label: 'Incentivos Fiscais', val: eco.incentivos },
        { label: 'Depreciação', val: eco.depreciacao },
        { label: 'Créditos PIS/COFINS', val: eco.pisCofinsCreditos },
        { label: 'Gratificação→Pró-labore', val: eco.gratificacao },
        { label: 'CPRB Desoneração', val: eco.cprb },
        { label: 'PDD Fiscal', val: eco.pddFiscal }
      ];
      items.sort(function (a, b) { return (b.val || 0) - (a.val || 0); });
      items.forEach(function (it) {
        if (it.val > 0) {
          econLabels.push(it.label);
          econValues.push(it.val);
          econColors.push(CORES.economia);
        }
      });
      if (econLabels.length > 0) {
        new Chart(elEcon, {
          type: 'bar',
          data: {
            labels: econLabels,
            datasets: [{ label: 'Economia Anual', data: econValues, backgroundColor: econColors, borderRadius: 4 }]
          },
          options: Object.assign({}, chartDefaults, {
            indexAxis: 'y',
            plugins: Object.assign({}, chartDefaults.plugins, {
              tooltip: { callbacks: { label: function (ctx) { return _m(ctx.parsed.x); } } }
            }),
            scales: {
              x: { ticks: { color: '#aaa', callback: function (v) { return _m(v); } }, grid: { color: 'rgba(255,255,255,0.06)' } },
              y: { ticks: { color: '#ccc' }, grid: { display: false } }
            }
          })
        });
      }
    }

    // ── Gráfico 3: Bar agrupado — Antes vs Depois ──
    var elAD = $("chartAntesDepois");
    if (elAD && r.resumo) {
      new Chart(elAD, {
        type: 'bar',
        data: {
          labels: ['Carga Tributária'],
          datasets: [
            { label: 'Sem Otimização', data: [r.resumo.cargaBruta], backgroundColor: CORES.bruto, borderRadius: 4 },
            { label: 'Com Otimização', data: [r.resumo.cargaOtimizada], backgroundColor: CORES.otimizado, borderRadius: 4 }
          ]
        },
        options: chartDefaults
      });
    }

    // ── Gráfico 4: Line — Projeção acumulada ──
    var elProj = $("chartProjecao");
    if (elProj && r.projecao && r.projecao.projecaoCarga) {
      var projLabels = r.projecao.projecaoCarga.map(function (p) { return 'Ano ' + p.ano; });
      var projValues = r.projecao.projecaoCarga.map(function (p) { return p.economiaAcumulada; });
      new Chart(elProj, {
        type: 'line',
        data: {
          labels: projLabels,
          datasets: [{
            label: 'Economia Acumulada',
            data: projValues,
            borderColor: CORES.economia,
            backgroundColor: 'rgba(46,204,113,0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 5,
            pointBackgroundColor: CORES.economia
          }]
        },
        options: chartDefaults
      });
    }

    // ── Gráfico 5: Bar empilhado — Fluxo mensal ──
    var elFluxo = $("chartFluxoMensal");
    if (elFluxo && r.fluxoCaixa && r.fluxoCaixa.meses) {
      var mLabels = r.fluxoCaixa.meses.map(function (m) { return ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"][m.mes - 1]; });
      new Chart(elFluxo, {
        type: 'bar',
        data: {
          labels: mLabels,
          datasets: [
            { label: 'IRPJ', data: r.fluxoCaixa.meses.map(function (m) { return m.irpj; }), backgroundColor: CORES.irpj },
            { label: 'CSLL', data: r.fluxoCaixa.meses.map(function (m) { return m.csll; }), backgroundColor: CORES.csll },
            { label: 'PIS', data: r.fluxoCaixa.meses.map(function (m) { return m.pis; }), backgroundColor: '#2980B9' },
            { label: 'COFINS', data: r.fluxoCaixa.meses.map(function (m) { return m.cofins; }), backgroundColor: CORES.pisCofins },
            { label: 'ISS', data: r.fluxoCaixa.meses.map(function (m) { return m.iss; }), backgroundColor: CORES.iss }
          ]
        },
        options: Object.assign({}, chartDefaults, {
          scales: {
            x: { stacked: true, ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,0.06)' } },
            y: { stacked: true, ticks: { color: '#aaa', callback: function (v) { return _m(v); } }, grid: { color: 'rgba(255,255,255,0.06)' } }
          }
        })
      });
    }

    // ── Gráfico 6: Bar agrupado — Cenários ──
    var elCen = $("chartCenarios");
    if (elCen && r.cenarios && r.cenarios.length > 0) {
      new Chart(elCen, {
        type: 'bar',
        data: {
          labels: r.cenarios.map(function (c) { return c.nome; }),
          datasets: [
            { label: 'IRPJ+CSLL', data: r.cenarios.map(function (c) { return c.irpjCSLL; }), backgroundColor: CORES.irpj, borderRadius: 4 },
            { label: 'PIS/COFINS', data: r.cenarios.map(function (c) { return c.pisCofins; }), backgroundColor: CORES.pisCofins, borderRadius: 4 },
            { label: 'ISS', data: r.cenarios.map(function (c) { return c.iss; }), backgroundColor: CORES.iss, borderRadius: 4 }
          ]
        },
        options: chartDefaults
      });
    }

    // ── Gráfico 7: Doughnut com texto central — Alíquota efetiva (gauge) ──
    var elAliq = $("chartAliquota");
    if (elAliq && r.resumo) {
      var aliqVal = r.resumo.aliquotaEfetiva || 0;
      var restante = Math.max(100 - aliqVal, 0);
      new Chart(elAliq, {
        type: 'doughnut',
        data: {
          labels: ['Carga Tributária', 'Receita Livre'],
          datasets: [{
            data: [aliqVal, restante],
            backgroundColor: [CORES.irpj, '#E0E0E0'],
            borderColor: '#161e31',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          cutout: '70%',
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: { label: function (ctx) { return ctx.label + ': ' + ctx.parsed.toFixed(2) + '%'; } }
            }
          }
        },
        plugins: [{
          id: 'centerText',
          afterDraw: function (chart) {
            var ctx2d = chart.ctx;
            var w = chart.width;
            var h = chart.height;
            ctx2d.save();
            ctx2d.textAlign = 'center';
            ctx2d.textBaseline = 'middle';
            ctx2d.fillStyle = '#ccc';
            ctx2d.font = 'bold 22px "DM Sans", sans-serif';
            ctx2d.fillText(aliqVal.toFixed(2) + '%', w / 2, h / 2 - 8);
            ctx2d.font = '12px "DM Sans", sans-serif';
            ctx2d.fillStyle = '#999';
            ctx2d.fillText('Alíquota Efetiva', w / 2, h / 2 + 16);
            ctx2d.restore();
          }
        }]
      });
    }
  }

  // ═══════════════════════════════════════════════════════════════════════════
  //  PREENCHIMENTO DE EXEMPLO (Demo genérico)
  // ═══════════════════════════════════════════════════════════════════════════

  function preencherExemplo() {
    dadosEmpresa = {
      razaoSocial: "Empresa Modelo Consultoria Ltda",
      cnpj: "12.345.678/0001-90",
      cnaePrincipal: "7020-4/00",
      uf: "SP",
      municipio: "São Paulo",
      issAliquota: 5,
      issConhecido: true,
      tipoAtividade: "SERVICOS_GERAL",
      apuracaoLR: "trimestral",
      anoBase: 2026,
      numSocios: 2,
      numFuncionarios: 25,
      prestaServPublico: false,
      ehFinanceira: false,
      receitaBrutaAnual: 3000000,
      receitaServicos: 3000000,
      percentReceitaPublico: 15,
      folhaPagamentoAnual: 1200000,
      cmv: 100000,
      servicosTerceiros: 150000,
      aluguelAnual: 72000,
      energiaAnual: 36000,
      telecomAnual: 18000,
      honorariosContabeis: 36000,
      marketingPublicidade: 24000,
      outrasDespesasOp: 48000,
      temMultas: true,
      multasPunitivas: 5000,
      temBrindes: true,
      brindes: 3000,
      temGratificacaoAdm: true,
      gratificacoesAdm: 24000,
      patrimonioLiquido: 600000,
      capitalSocial: 300000,
      lucrosAcumulados: 300000,
      detalharPL: true,
      tjlp: 7.97,
      prejuizoFiscal: 200000,
      baseNegativaCSLL: 150000,
      irrfRetidoPublico: 21600,
      pisRetido: 2925,
      cofinsRetido: 13500,
      csllRetido: 4500,
      comprasMercadoriasAnual: 80000,
      energiaCredito: 36000,
      alugueisPJCredito: 72000,
      depreciacaoBensCredito: 55000,
      freteVendasAnual: 24000,
      valorVeiculos: 180000,
      valorComputadores: 60000,
      valorMoveis: 30000,
      temPDD: true,
      perdasCreditos6Meses: 50000,
      perdasCreditosJudicial: 30000,
      turnosOperacao: 1,
      gerarCenarios: true,
      variacaoMargemCenario: 5,
      gerarProjecao: true,
      taxaCrescimentoAnual: 10,
      horizonteProjecao: 5,
    };
    currentStep = 0;
    saveToLS();
    renderWizard();

    // MELHORIA #4: Teste de regressão automático
    // Após preencher dados de exemplo, rodar cálculo e validar totais esperados
    setTimeout(function() {
      try {
        analisar();
        var r = resultadosCache;
        if (!r || !r.resumo) { console.warn('[TESTE REGRESSÃO] Sem resultados após analisar()'); return; }
        var checks = [
          // [caminho, valorEsperado, tolerancia]
          ['resumo.cargaBruta', null, 0.02],           // valor real a definir após baseline
          ['resumo.economiaTotal', null, 0.02],
          ['irpj.irpjDevido', null, 0.02]
        ];
        checks.forEach(function(chk) {
          if (chk[1] === null) return; // skip se valor esperado não definido
          var partes = chk[0].split('.');
          var atual = r;
          partes.forEach(function(p) { atual = atual ? atual[p] : null; });
          if (atual === null || atual === undefined) {
            console.error('[TESTE REGRESSÃO] Campo ' + chk[0] + ' não encontrado nos resultados');
          } else if (Math.abs(atual - chk[1]) > chk[2]) {
            console.error('[TESTE REGRESSÃO] ' + chk[0] + ': esperado ' + chk[1] + ', obtido ' + atual);
          } else {
            console.info('[TESTE REGRESSÃO] ✓ ' + chk[0] + ' = ' + atual);
          }
        });
        console.info('[TESTE REGRESSÃO] Para definir baseline, anote: cargaBruta=' + _safe(r, 'resumo', 'cargaBruta') + ', economiaTotal=' + _safe(r, 'resumo', 'economiaTotal') + ', irpjDevido=' + _safe(r, 'irpj', 'irpjDevido'));
      } catch(e) {
        console.error('[TESTE REGRESSÃO] Erro ao executar:', e.message);
      }
    }, 200);
  }

  // ═══════════════════════════════════════════════════════════════════════════
  //  NOVO ESTUDO
  // ═══════════════════════════════════════════════════════════════════════════

  function novoEstudo() {
    if (confirm("Tem certeza? Os dados atuais serão perdidos.")) {
      dadosEmpresa = {};
      currentStep = 0;
      resultadosCache = null;
      localStorage.removeItem(LS_KEY_DADOS);
      localStorage.removeItem(LS_KEY_STEP);
      localStorage.removeItem(LS_KEY_RESULTADOS);
      renderWizard();
    }
  }

  // ═══════════════════════════════════════════════════════════════════════════
  //  EXPORTAR JSON / IMPRIMIR
  // ═══════════════════════════════════════════════════════════════════════════

  function exportarJSON() {
    var exportData = {
      versao: VERSAO,
      produto: CONFIG.nomeProduto,
      dataExportacao: new Date().toISOString(),
      dadosEmpresa: dadosEmpresa,
      resultados: resultadosCache,
    };
    var blob = new Blob([JSON.stringify(exportData, null, 2)], {
      type: "application/json",
    });
    var url = URL.createObjectURL(blob);
    var a = document.createElement("a");
    a.href = url;
    a.download =
      "estudo-lucro-real-" +
      (dadosEmpresa.razaoSocial || "empresa").replace(/\s+/g, "-") +
      "-" +
      new Date().toISOString().split("T")[0] +
      ".json";
    a.click();
    URL.revokeObjectURL(url);
  }

  function imprimir() {
    window.print();
  }

  // ═══════════════════════════════════════════════════════════════════════════
  //  INIT — Verificação de dependências
  // ═══════════════════════════════════════════════════════════════════════════

  function init() {
    // 1. Verificar mapeamento (obrigatório)
    LR = window.LR || window.LucroRealMap;
    if (!LR) {
      mostrarErro(
        "lucro-real-mapeamento.js não carregado. Verifique se o script foi incluído antes deste arquivo."
      );
      return;
    }

    // 2. Verificar estados.js (obrigatório para municípios)
    ESTADOS = window.ESTADOS || window.Estados || window.EstadosBR;
    if (!ESTADOS) {
      mostrarErro(
        "estados.js não carregado. Verifique se o script foi incluído antes deste arquivo."
      );
      return;
    }

    // 3. Verificar MunicipiosIBGE (obrigatório para select de municípios)
    if (!window.MunicipiosIBGE) {
      mostrarErro(
        "municipios.js não carregado. Verifique se o script foi incluído antes deste arquivo."
      );
      return;
    }

    // 4. Ler white-label config
    var cfg = window.IMPOST_CONFIG || {};
    CONFIG = Object.assign({}, CONFIG_DEFAULTS, cfg);
    if (cfg.elaboradoPor) {
      CONFIG.elaboradoPor = Object.assign(
        {},
        CONFIG_DEFAULTS.elaboradoPor,
        cfg.elaboradoPor
      );
    }

    // 5. Injetar CSS de siglas (tooltips)
    _injectSiglaCSS();

    // 6. Restaurar dados salvos
    loadFromLS();

    // 7. Renderizar wizard
    renderWizard();

    // ═══ FIX BUG #2: Sincronizar badge de versão no header com VERSAO do JS ═══
    var _vBadge = document.getElementById('versionBadge') || document.querySelector('.header-version');
    if (_vBadge) _vBadge.textContent = 'v' + VERSAO;

    console.log(
      "[" + CONFIG.nomeProduto + " LucroRealEstudos] v" + VERSAO + " inicializado. " +
      "LR: ✓ | ESTADOS: ✓ | MunicipiosIBGE: ✓"
    );
  }



  // ═══════════════════════════════════════════════════════════════════════════
  // ═══════════════════════════════════════════════════════════════════════════
  // ██████████████████████████████████████████████████████████████████████████
  //  MÓDULO DE EXPORTAÇÃO PDF / EXCEL                                       █
  //  (integrado — anteriormente em lucro-real-estudos-export.js)             █
  //  Gera relatórios profissionais: PDF Simplificado, PDF Completo, Excel    █
  // ██████████████████████████████████████████████████████████████████████████
  // ═══════════════════════════════════════════════════════════════════════════
  // ═══════════════════════════════════════════════════════════════════════════

  // ── Helpers de data para exportação ──
  function _dataFormatada(iso) {
    if (!iso) return new Date().toLocaleDateString('pt-BR');
    var dt = new Date(iso);
    return dt.toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });
  }
  function _dataHora(iso) {
    if (!iso) return '';
    var dt = new Date(iso);
    return dt.toLocaleDateString('pt-BR') + ' ' + dt.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
  }
  function _dataCurta() {
    return new Date().toISOString().split('T')[0];
  }


  // ═══════════════════════════════════════════════════════════════════════════
  //  CORES & ESTILOS
  // ═══════════════════════════════════════════════════════════════════════════

  var COR = {
    primary: '#2D8C4E',
    primaryDark: '#1E6B38',
    accent: '#2ECC71',
    accentDark: '#27AE60',
    danger: '#E74C3C',
    warning: '#F39C12',
    info: '#3498DB',
    purple: '#9B59B6',
    text: '#1a1a2e',
    textSec: '#5a6170',
    textMuted: '#8b95a5',
    stripe: '#f7f9fb',
    ecoBg: '#eafaf1',
    dangerBg: '#FADBD8',
    warningBg: '#FEF5E7',
    infoBg: '#EBF5FB',
    white: '#FFFFFF',
    headerBg: '#2D8C4E',
    totalBg: '#2D8C4E',
    subtotalBg: '#E2E6EA'
  };

  var FONT = "font-family:'DM Sans','Segoe UI',Helvetica,Arial,sans-serif;";
  var FONT_MONO = "font-family:'JetBrains Mono','Fira Code','Courier New',monospace;";
  var BASE_CSS = FONT + "color:" + COR.text + ";font-size:11px;line-height:1.6;";

  // ═══════════════════════════════════════════════════════════════════════════
  //  LOADING OVERLAY
  // ═══════════════════════════════════════════════════════════════════════════

  function showLoading(msg) {
    hideLoading();
    var overlay = document.createElement('div');
    overlay.id = '__impost_loading';
    overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;z-index:99999;background:rgba(10,15,30,0.85);display:flex;align-items:center;justify-content:center;flex-direction:column;';
    overlay.innerHTML =
      '<div style="width:48px;height:48px;border:4px solid rgba(255,255,255,0.15);border-top:4px solid #2ECC71;border-radius:50%;animation:impostSpin 0.8s linear infinite;margin-bottom:16px;"></div>' +
      '<div style="color:#fff;font-size:15px;' + FONT + '">' + (msg || 'Gerando...') + '</div>' +
      '<style>@keyframes impostSpin{to{transform:rotate(360deg)}}</style>';
    document.body.appendChild(overlay);
  }

  function hideLoading() {
    var el = document.getElementById('__impost_loading');
    if (el) el.remove();
  }

  // ═══════════════════════════════════════════════════════════════════════════
  //  HTML BUILDERS — Blocos reutilizáveis para PDF
  // ═══════════════════════════════════════════════════════════════════════════

  /** Cabeçalho do PDF com logo IMPOST., empresa, data */
  function pdfHeader(r, titulo) {
    var d = r.dadosEmpresa || {};
    var cfg = r.config || {};
    var h = '';
    h += '<div style="display:flex;justify-content:space-between;align-items:flex-start;border-bottom:3px solid ' + COR.primary + ';padding-bottom:14px;margin-bottom:18px;">';
    // Logo lado esquerdo
    h += '<div>';
    if (cfg.mostrarMarcaImpost !== false) {
      h += '<div style="font-size:26px;font-weight:800;color:' + COR.primary + ';letter-spacing:1px;' + FONT + '">' + (cfg.nomeProduto || 'IMPOST.') + '</div>';
      h += '<div style="font-size:9px;color:' + COR.textMuted + ';margin-top:2px;' + FONT + '">' + (cfg.subtitulo || '') + '</div>';
    }
    h += '</div>';
    // Info lado direito
    h += '<div style="text-align:right;font-size:10px;color:' + COR.textSec + ';">';
    h += '<div style="font-weight:700;font-size:12px;color:' + COR.text + ';">' + _esc(d.razaoSocial || 'Empresa') + '</div>';
    if (d.cnpj) h += '<div>CNPJ: ' + _esc(d.cnpj) + '</div>';
    h += '<div>' + _esc(d.municipio || '') + '/' + (d.uf || '') + ' — ' + (d.anoBase || new Date().getFullYear()) + '</div>';
    h += '</div>';
    h += '</div>';
    // Título do relatório
    h += '<div style="text-align:center;margin-bottom:18px;">';
    h += '<div style="font-size:16px;font-weight:700;color:' + COR.primary + ';text-transform:uppercase;letter-spacing:2px;' + FONT + '">' + titulo + '</div>';
    h += '<div style="font-size:9px;color:' + COR.textMuted + ';margin-top:4px;">Gerado em ' + _dataFormatada(r.dataGeracao) + ' — v' + (r.versao || '2.0.0') + '</div>';
    h += '</div>';
    return h;
  }

  /** Rodapé padrão */
  function pdfFooter(r) {
    var cfg = r.config || {};
    var ep = cfg.elaboradoPor || {};
    var h = '<div style="margin-top:30px;border-top:2px solid #e0e4e8;padding-top:14px;font-size:9px;color:' + COR.textMuted + ';">';
    // Disclaimer
    h += '<div style="background:#f8f9fa;border-left:3px solid ' + COR.info + ';padding:10px 14px;margin-bottom:12px;font-size:9px;color:' + COR.textSec + ';line-height:1.5;">';
    h += (cfg.disclaimer || 'Este estudo é uma estimativa automatizada para fins de planejamento tributário. Consulte um profissional habilitado para validação e implementação.');
    h += '</div>';
    // Elaborado por
    if (ep.nome) {
      h += '<div style="margin-top:30px;text-align:center;">';
      h += '<div style="border-top:1px solid #ccc;width:250px;margin:0 auto 6px;"></div>';
      h += '<div style="font-weight:600;color:' + COR.text + ';font-size:11px;">' + _esc(ep.nome) + '</div>';
      if (ep.registro) h += '<div>' + _esc(ep.registro) + '</div>';
      if (ep.email) h += '<div>' + _esc(ep.email) + '</div>';
      if (ep.telefone) h += '<div>' + _esc(ep.telefone) + '</div>';
      h += '</div>';
    }
    // Powered by
    if (cfg.mostrarMarcaImpost !== false) {
      h += '<div style="text-align:center;margin-top:14px;font-size:8px;color:' + COR.textMuted + ';">Powered by ' + (cfg.nomeProduto || 'IMPOST.') + ' v' + (r.versao || '2.0.0') + '</div>';
    }
    h += '</div>';
    return h;
  }

  /** Título de seção com ícone */
  function secaoTitulo(icone, texto, sub) {
    var h = '<div style="page-break-inside:avoid;margin:22px 0 12px;">';
    h += '<div style="font-size:15px;font-weight:700;color:' + COR.primary + ';border-bottom:2px solid ' + COR.primary + ';padding-bottom:6px;' + FONT + '">';
    if (icone) h += icone + ' ';
    h += texto + '</div>';
    if (sub) h += '<div style="font-size:9px;color:' + COR.textMuted + ';margin-top:3px;">' + sub + '</div>';
    h += '</div>';
    return h;
  }

  /** Card de economia com valor verde */
  function cardEconomia(titulo, valor, sub) {
    return '<div style="background:' + COR.ecoBg + ';border-left:4px solid ' + COR.accentDark + ';padding:10px 14px;margin:6px 0;page-break-inside:avoid;">' +
      '<div style="font-size:9px;color:' + COR.textSec + ';text-transform:uppercase;letter-spacing:0.5px;">' + titulo + '</div>' +
      '<div style="font-size:18px;font-weight:700;color:' + COR.accentDark + ';' + FONT_MONO + '">' + _m(valor) + '</div>' +
      (sub ? '<div style="font-size:9px;color:' + COR.textMuted + ';margin-top:2px;">' + sub + '</div>' : '') +
      '</div>';
  }

  /** Mini card indicador */
  function miniCard(titulo, valor, cor, sub) {
    cor = cor || COR.text;
    return '<div style="background:#fff;border:1px solid #e8ecf0;border-radius:6px;padding:10px 12px;text-align:center;page-break-inside:avoid;">' +
      '<div style="font-size:8px;color:' + COR.textMuted + ';text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">' + titulo + '</div>' +
      '<div style="font-size:16px;font-weight:700;color:' + cor + ';' + FONT_MONO + '">' + valor + '</div>' +
      (sub ? '<div style="font-size:8px;color:' + COR.textMuted + ';margin-top:3px;">' + sub + '</div>' : '') +
      '</div>';
  }

  /** Grid de N colunas */
  function grid(cols, items) {
    var w = Math.floor(100 / cols) - 2;
    var h = '<div style="display:flex;flex-wrap:wrap;gap:8px;margin:10px 0;">';
    items.forEach(function (item) {
      h += '<div style="flex:0 0 ' + w + '%;max-width:' + w + '%;">' + item + '</div>';
    });
    h += '</div>';
    return h;
  }

  /** Tabela genérica com zebra-striping */
  function tabelaHTML(headers, rows, opts) {
    opts = opts || {};
    var h = '<table style="width:100%;border-collapse:collapse;margin:8px 0;page-break-inside:avoid;font-size:10px;' + FONT + '">';
    // Header
    h += '<thead><tr>';
    headers.forEach(function (hdr, i) {
      var align = (i > 0 && !opts.noAlignRight) ? 'text-align:right;' : 'text-align:left;';
      h += '<th style="background:' + COR.headerBg + ';color:#fff;padding:7px 10px;font-weight:600;font-size:9px;text-transform:uppercase;letter-spacing:0.5px;' + align + '">' + hdr + '</th>';
    });
    h += '</tr></thead>';
    // Body
    h += '<tbody>';
    rows.forEach(function (row, ri) {
      var isTotal = row._total || false;
      var isSubtotal = row._subtotal || false;
      var isEco = row._eco || false;
      var bg = isTotal ? COR.totalBg : isSubtotal ? COR.subtotalBg : (ri % 2 === 1 ? COR.stripe : '#fff');
      var txtColor = isTotal ? '#fff' : COR.text;
      var fw = (isTotal || isSubtotal) ? 'font-weight:700;' : '';
      h += '<tr style="background:' + bg + ';color:' + txtColor + ';' + fw + '">';
      (row.cells || row).forEach(function (cell, ci) {
        var align = (ci > 0 && !opts.noAlignRight) ? 'text-align:right;' : 'text-align:left;';
        var ecoStyle = (isEco && ci > 0) ? 'color:' + COR.accentDark + ';font-weight:700;' + FONT_MONO : '';
        var indent = (row._indent && ci === 0) ? 'padding-left:' + (row._indent * 14) + 'px;' : '';
        h += '<td style="padding:6px 10px;border-bottom:1px solid #eee;' + align + ecoStyle + indent + '">' + cell + '</td>';
      });
      h += '</tr>';
    });
    h += '</tbody></table>';
    return h;
  }

  /** Box de alerta */
  function alertaBox(tipo, msg) {
    var cores = {
      critico: { bg: COR.dangerBg, borda: COR.danger, ico: '🔴' },
      aviso: { bg: COR.warningBg, borda: COR.warning, ico: '🟡' },
      economia: { bg: COR.ecoBg, borda: COR.accentDark, ico: '🟢' },
      info: { bg: COR.infoBg, borda: COR.info, ico: '🔵' }
    };
    var c = cores[tipo] || cores.info;
    return '<div style="background:' + c.bg + ';border-left:4px solid ' + c.borda + ';padding:8px 12px;margin:5px 0;font-size:10px;page-break-inside:avoid;">' +
      c.ico + ' ' + msg + '</div>';
  }

  /** Barra visual de percentual */
  function barraVisual(valor, max, cor, label) {
    var pct = max > 0 ? Math.min((valor / max) * 100, 100) : 0;
    return '<div style="display:flex;align-items:center;margin:3px 0;">' +
      '<div style="flex:0 0 120px;font-size:9px;color:' + COR.textSec + ';">' + (label || '') + '</div>' +
      '<div style="flex:1;background:#eee;border-radius:4px;height:14px;overflow:hidden;">' +
      '<div style="width:' + pct.toFixed(1) + '%;background:' + (cor || COR.primary) + ';height:100%;border-radius:4px;"></div>' +
      '</div>' +
      '<div style="flex:0 0 90px;text-align:right;font-size:10px;font-weight:600;' + FONT_MONO + 'color:' + (cor || COR.text) + ';">' + _m(valor) + '</div>' +
      '</div>';
  }

  /** Page break */
  function pageBreak() {
    return '<div style="page-break-before:always;margin:0;padding:0;height:0;"></div>';
  }

  /** Badge colorido */
  function badge(texto, cor) {
    return '<span style="display:inline-block;padding:2px 8px;border-radius:10px;font-size:8px;font-weight:600;background:' + cor + '20;color:' + cor + ';margin:0 3px;">' + texto + '</span>';
  }

  function badgeComplexidade(c) {
    var cores = { 'Baixa': COR.accentDark, 'Média': COR.warning, 'Alta': COR.danger };
    return badge(c || 'N/A', cores[c] || COR.info);
  }
  function badgeRisco(r) {
    var cores = { 'Baixo': COR.accentDark, 'Médio': COR.warning, 'Alto': COR.danger };
    return badge(r || 'N/A', cores[r] || COR.info);
  }

  /** Nomes das fontes de economia */
  var ECONOMIA_NOMES = {
    jcp: { nome: 'Juros sobre Capital Próprio (JCP)', base: 'Art. 355-358 RIR/2018' },
    prejuizo: { nome: 'Compensação de Prejuízo Fiscal', base: 'Art. 579-586 RIR/2018' },
    sudam: { nome: 'Redução SUDAM/SUDENE (75%)', base: 'Art. 612-613 RIR/2018' },
    incentivos: { nome: 'Incentivos Fiscais (PAT, Rouanet, etc.)', base: 'Legislação específica' },
    depreciacao: { nome: 'Economia Fiscal com Depreciação', base: 'Art. 317-323 RIR/2018' },
    pisCofinsCreditos: { nome: 'Créditos PIS/COFINS Não-Cumulativo', base: 'Art. 3º Lei 10.637/02 e 10.833/03' },
    gratificacao: { nome: 'Conversão Gratificação → Pró-labore', base: 'Art. 311 RIR/2018' },
    cprb: { nome: 'Desoneração da Folha (CPRB)', base: 'Lei 12.546/2011' },
    pddFiscal: { nome: 'PDD — Provisão para Devedores Duvidosos', base: 'Art. 340-342 RIR/2018' }
  };

  /** Nomes dos meses */
  var MESES = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];

  // ═══════════════════════════════════════════════════════════════════════════
  //  GERADOR DO HTML2PDF — wrapper
  // ═══════════════════════════════════════════════════════════════════════════

  function gerarPDF(htmlContent, filename, onDone) {
    if (typeof html2pdf === 'undefined') {
      alert('html2pdf.js não foi carregado. Verifique as dependências.');
      if (onDone) onDone();
      return;
    }
    var wrapper = '<div style="' + BASE_CSS + 'max-width:700px;margin:0 auto;padding:10px 15px;">' + htmlContent + '</div>';
    var tempDiv = document.createElement('div');
    tempDiv.innerHTML = wrapper;
    document.body.appendChild(tempDiv);

    html2pdf().set({
      margin: [10, 10, 15, 10],
      filename: filename,
      image: { type: 'jpeg', quality: 0.95 },
      html2canvas: { scale: 2, useCORS: true, logging: false, letterRendering: true },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
      pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
    }).from(tempDiv).save().then(function () {
      document.body.removeChild(tempDiv);
      if (onDone) onDone();
    }).catch(function (err) {
      document.body.removeChild(tempDiv);
      console.error('Erro PDF:', err);
      alert('Erro ao gerar PDF. Veja o console.');
      if (onDone) onDone();
    });
  }


  // ═══════════════════════════════════════════════════════════════════════════════
  // ███████████████████████████████████████████████████████████████████████████████
  //  PDF SIMPLIFICADO — Para o empresário (3-5 páginas)
  // ███████████████████████████████████████████████████████████████████████████████
  // ═══════════════════════════════════════════════════════════════════════════════

  function pdfSimplificado() {
    var r = window.LucroRealEstudos ? window.LucroRealEstudos.getResultados() : null;
    if (!r) { alert('Gere o estudo antes de exportar.'); return; }

    showLoading('Gerando Relatório Simplificado...');

    var d = r.dadosEmpresa || {};
    var res = r.resumo || {};
    var eco = r.economia || {};
    var ops = (r.oportunidades || []).slice(0, 5);
    var fc = r.fluxoCaixa || {};
    var ca = r.comparativoApuracao || {};
    var proj = r.projecao || {};

    var h = '';

    // ══════════════════════════════════════════════════════════════
    //  PÁGINA 1: CAPA + RESUMO EXECUTIVO
    // ══════════════════════════════════════════════════════════════

    h += pdfHeader(r, 'RELATÓRIO EXECUTIVO — ESTUDO DE LUCRO REAL');

    // 6 Cards de resumo (grid 3x2)
    h += grid(3, [
      miniCard('ECONOMIA IDENTIFICADA', _m(res.economiaTotal), COR.accentDark, 'Potencial de economia anual'),
      miniCard('TRIBUTOS DEVIDOS (Bruto)', _m(res.cargaBruta), COR.danger, _m(res.cargaBrutaMensal) + '/mês'),
      miniCard('ALÍQUOTA EFETIVA', _pp(res.aliquotaEfetiva), COR.text),
      miniCard('CARGA OTIMIZADA', _m(res.cargaOtimizada), COR.accentDark, _pp(res.aliquotaOtimizada) + ' efetiva'),
      miniCard('RETENÇÕES A COMPENSAR', _m(res.totalRetencoes), COR.info),
      miniCard('SALDO A PAGAR', _m(res.saldoEfetivo), COR.text, 'Após retenções')
    ]);

    // Box economia destaque
    if (res.economiaTotal > 0) {
      h += '<div style="background:' + COR.ecoBg + ';border:2px solid ' + COR.accentDark + ';border-radius:8px;padding:16px 20px;margin:16px 0;text-align:center;page-break-inside:avoid;">';
      h += '<div style="font-size:10px;color:' + COR.textSec + ';text-transform:uppercase;letter-spacing:1px;">ECONOMIA TOTAL IDENTIFICADA</div>';
      h += '<div style="font-size:32px;font-weight:800;color:' + COR.accentDark + ';' + FONT_MONO + 'margin:6px 0;">' + _m(res.economiaTotal) + ' /ano</div>';
      h += '<div style="font-size:10px;color:' + COR.textSec + ';">' + _m(res.economiaTotal / 12) + ' por mês &bull; Redução de ' + _pp(res.aliquotaEfetiva - res.aliquotaOtimizada) + ' na alíquota efetiva</div>';
      h += '</div>';
    }

    // Box explicativo
    h += '<div style="background:#f8f9fa;border-radius:6px;padding:12px 16px;margin:12px 0;font-size:10px;color:' + COR.textSec + ';line-height:1.7;page-break-inside:avoid;">';
    h += '<div style="font-weight:700;color:' + COR.text + ';margin-bottom:4px;">💡 O que isso significa para sua empresa?</div>';
    if (res.economiaTotal > 0) {
      h += 'Identificamos <strong style="color:' + COR.accentDark + ';">' + (res.numOportunidades || ops.length) + ' oportunidades de economia</strong> que podem reduzir sua carga tributária de ';
      h += '<strong>' + _m(res.cargaBruta) + '</strong> para <strong style="color:' + COR.accentDark + ';">' + _m(res.cargaOtimizada) + '</strong> por ano. ';
      h += 'A economia de <strong style="color:' + COR.accentDark + ';">' + _m(res.economiaTotal) + '</strong> representa uma redução de ';
      h += '<strong>' + (res.cargaBruta > 0 ? _pp(res.economiaTotal / res.cargaBruta * 100) : '0%') + '</strong> na carga tributária total.';
    } else {
      h += 'A empresa já opera com carga tributária otimizada no regime de Lucro Real. Recomendamos revisão periódica para identificar novas oportunidades.';
    }
    h += '</div>';


    // ══════════════════════════════════════════════════════════════
    //  PÁGINA 2: MAPA DE ECONOMIA
    // ══════════════════════════════════════════════════════════════

    h += pageBreak();
    h += secaoTitulo('💰', 'DE ONDE VEM A ECONOMIA', 'Fontes identificadas de economia tributária');

    // Tabela de fontes de economia (apenas > 0)
    var ecoRows = [];
    var ecoKeys = ['jcp', 'prejuizo', 'sudam', 'incentivos', 'depreciacao', 'pisCofinsCreditos', 'gratificacao', 'cprb', 'pddFiscal'];
    ecoKeys.forEach(function (k) {
      if (eco[k] > 0) {
        var info = ECONOMIA_NOMES[k] || {};
        ecoRows.push({ cells: [info.nome || k, _m(eco[k]), info.base || '—'], _eco: true });
      }
    });
    if (ecoRows.length > 0) {
      ecoRows.push({ cells: ['ECONOMIA TOTAL', _m(eco.total || res.economiaTotal), ''], _total: true });
      h += tabelaHTML(['Fonte de Economia', 'Valor Anual', 'Base Legal'], ecoRows);
    } else {
      h += '<div style="font-size:10px;color:' + COR.textMuted + ';padding:10px;">Nenhuma fonte de economia adicional identificada neste estudo.</div>';
    }

    // Barra ANTES x DEPOIS
    h += '<div style="margin:18px 0;page-break-inside:avoid;">';
    h += '<div style="font-size:11px;font-weight:700;color:' + COR.text + ';margin-bottom:8px;">COMPARATIVO: ANTES × DEPOIS</div>';
    h += barraVisual(res.cargaBruta, res.cargaBruta, COR.danger, 'Carga Bruta');
    if (res.economiaTotal > 0) {
      h += barraVisual(res.economiaTotal, res.cargaBruta, COR.accentDark, '(-) Economia');
    }
    h += barraVisual(res.cargaOtimizada, res.cargaBruta, COR.primary, 'Carga Otimizada');
    h += '</div>';

    // Projeção de economia acumulada
    if (res.economiaTotal > 0) {
      h += '<div style="margin:14px 0;page-break-inside:avoid;">';
      h += '<div style="font-size:11px;font-weight:700;color:' + COR.text + ';margin-bottom:8px;">PROJEÇÃO DE ECONOMIA ACUMULADA</div>';
      var projAnos = [1, 3, 5, 10];
      var projRows = [];
      projAnos.forEach(function (a) {
        // Se tiver projeção com crescimento, usar
        if (proj.projecaoCarga && proj.projecaoCarga.length >= a) {
          projRows.push({ cells: [a + (a === 1 ? ' ano' : ' anos'), _m(proj.projecaoCarga[a - 1].economiaAcumulada)], _eco: true });
        } else {
          projRows.push({ cells: [a + (a === 1 ? ' ano' : ' anos'), _m(res.economiaTotal * a)], _eco: true });
        }
      });
      h += tabelaHTML(['Horizonte', 'Economia Acumulada'], projRows);
      h += '</div>';
    }

    // ══════════════════════════════════════════════════════════════
    //  PÁGINA 3: TOP OPORTUNIDADES + AÇÕES
    // ══════════════════════════════════════════════════════════════

    if (ops.length > 0) {
      h += pageBreak();
      h += secaoTitulo('🎯', 'TOP ' + ops.length + ' OPORTUNIDADES DE ECONOMIA');

      ops.forEach(function (op, i) {
        h += '<div style="background:#fff;border:1px solid #e8ecf0;border-radius:6px;padding:12px 16px;margin:8px 0;page-break-inside:avoid;' + (i === 0 ? 'border-left:4px solid ' + COR.accentDark + ';' : '') + '">';
        h += '<div style="display:flex;justify-content:space-between;align-items:flex-start;">';
        h += '<div>';
        h += '<span style="display:inline-block;background:' + COR.primary + ';color:#fff;border-radius:50%;width:22px;height:22px;text-align:center;line-height:22px;font-size:10px;font-weight:700;margin-right:8px;">#' + (i + 1) + '</span>';
        h += '<strong style="font-size:12px;color:' + COR.text + ';">' + (op.titulo || '') + '</strong>';
        h += '</div>';
        h += '<div style="font-size:14px;font-weight:700;color:' + COR.accentDark + ';' + FONT_MONO + '">' + _m(op.economiaAnual || 0) + '/ano</div>';
        h += '</div>';
        // Tags
        h += '<div style="margin:6px 0;">';
        h += badge(op.tipo || 'N/A', COR.primary);
        h += badgeComplexidade(op.complexidade);
        h += badgeRisco(op.risco);
        h += badge(op.prazoImplementacao || '', COR.info);
        h += '</div>';
        // Descrição + Ação
        if (op.descricao) h += '<div style="font-size:9px;color:' + COR.textSec + ';margin:4px 0;">' + op.descricao + '</div>';
        if (op.acaoRecomendada) {
          h += '<div style="font-size:9px;color:' + COR.primary + ';font-weight:600;margin-top:4px;">→ ' + op.acaoRecomendada + '</div>';
        }
        h += '</div>';
      });

      // Box recomendação de apuração
      if (ca.recomendacao) {
        h += '<div style="background:' + COR.infoBg + ';border-left:4px solid ' + COR.info + ';padding:12px 16px;margin:14px 0;page-break-inside:avoid;">';
        h += '<div style="font-weight:700;color:' + COR.text + ';font-size:11px;">📋 Recomendação de Forma de Apuração</div>';
        h += '<div style="font-size:10px;color:' + COR.textSec + ';margin-top:4px;">';
        h += 'Forma recomendada: <strong style="color:' + COR.primary + ';">' + (ca.recomendacao.formaRecomendada === 'anual' ? 'ANUAL por Estimativa' : 'TRIMESTRAL') + '</strong>';
        if (ca.recomendacao.justificativa) h += '<br>' + ca.recomendacao.justificativa;
        if (ca.recomendacao.diferenca) h += '<br>Diferença estimada: <strong style="color:' + COR.accentDark + ';">' + _m(Math.abs(ca.recomendacao.diferenca)) + '</strong>';
        h += '</div></div>';
      }
    }

    // ══════════════════════════════════════════════════════════════
    //  PÁGINA 4: FLUXO MENSAL + PRÓXIMOS PASSOS
    // ══════════════════════════════════════════════════════════════

    h += pageBreak();
    h += secaoTitulo('📅', 'FLUXO DE CAIXA TRIBUTÁRIO MENSAL', 'Desembolso estimado mês a mês');

    if (fc.meses && fc.meses.length > 0) {
      var fcHeaders = ['Mês', 'IRPJ', 'CSLL', 'PIS', 'COFINS', 'ISS', 'TOTAL'];
      var fcRows = [];
      fc.meses.forEach(function (m, i) {
        fcRows.push({ cells: [MESES[i] || m.mes, _m(m.irpj), _m(m.csll), _m(m.pis), _m(m.cofins), _m(m.iss), _m(m.total)] });
      });
      // ═══ FIX BUG #3: Usar valores anuais exatos nos totais do PDF ═══
      var _fcTotIRPJ = fc.irpjAnualExato !== undefined ? fc.irpjAnualExato : fc.meses.reduce(function (s, m) { return s + (m.irpj || 0); }, 0);
      var _fcTotCSLL = fc.csllAnualExato !== undefined ? fc.csllAnualExato : fc.meses.reduce(function (s, m) { return s + (m.csll || 0); }, 0);
      var _fcTotPIS = fc.pisAnualExato !== undefined ? fc.pisAnualExato : fc.meses.reduce(function (s, m) { return s + (m.pis || 0); }, 0);
      var _fcTotCOF = fc.cofinsAnualExato !== undefined ? fc.cofinsAnualExato : fc.meses.reduce(function (s, m) { return s + (m.cofins || 0); }, 0);
      var _fcTotISS = fc.meses.reduce(function (s, m) { return s + (m.iss || 0); }, 0);
      fcRows.push({ cells: ['TOTAL ANUAL', _m(_r(_fcTotIRPJ)), _m(_r(_fcTotCSLL)), _m(_r(_fcTotPIS)), _m(_r(_fcTotCOF)), _m(_r(_fcTotISS)), _m(fc.totalAnual || 0)], _total: true });
      if (fc.mediaMensal) {
        fcRows.push({ cells: ['MÉDIA MENSAL', '', '', '', '', '', _m(fc.mediaMensal)], _subtotal: true });
      }
      h += tabelaHTML(fcHeaders, fcRows);
    } else {
      h += '<div style="font-size:10px;color:' + COR.textMuted + ';padding:8px;">Fluxo mensal não disponível.</div>';
    }

    // Próximos Passos
    h += '<div style="background:#f8f9fa;border-radius:8px;padding:14px 18px;margin:18px 0;page-break-inside:avoid;">';
    h += '<div style="font-size:13px;font-weight:700;color:' + COR.primary + ';margin-bottom:8px;">📌 Próximos Passos</div>';
    h += '<div style="font-size:10px;color:' + COR.textSec + ';line-height:1.8;">';
    var passos = [];
    if (eco.jcp > 0) passos.push('Deliberar distribuição de JCP em ata de sócios/assembleia');
    if (eco.prejuizo > 0) passos.push('Verificar controle de prejuízos na Parte B do LALUR');
    if (eco.sudam > 0) passos.push('Confirmar laudo de projeto SUDAM/SUDENE vigente');
    if (eco.pisCofinsCreditos > 0) passos.push('Revisar escrituração de créditos PIS/COFINS');
    if (eco.depreciacao > 0) passos.push('Avaliar depreciação acelerada e controle patrimonial');
    if (ops.length > 0) passos.push('Implementar as oportunidades acima em ordem de prioridade');
    passos.push('Agendar revisão tributária com profissional habilitado');
    passos.push('Manter escrituração contábil regular para aproveitamento de todas as deduções');
    passos.forEach(function (p, i) {
      h += '<div style="margin:3px 0;"><strong style="color:' + COR.primary + ';">' + (i + 1) + '.</strong> ' + p + '</div>';
    });
    h += '</div></div>';

    // ══════════════════════════════════════════════════════════════
    //  NOVA PÁGINA: FÓRMULA MESTRE + MAPA ECONOMIA + COMPLIANCE
    // ══════════════════════════════════════════════════════════════

    h += pageBreak();

    // Fórmula Mestre (Seção 7)
    if (LR.formulaMestre && LR.formulaMestre.passos) {
      h += secaoTitulo('📐', 'FÓRMULA MESTRE DO LUCRO REAL', 'Sequência de cálculo — ' + (LR.formulaMestre.artigo || 'Art. 258-261'));
      var vfPdf = {};
      vfPdf[1] = res.cargaBruta ? (r.dre ? r.dre.lucroLiquido : 0) : 0;
      vfPdf[2] = r.lalur ? r.lalur.totalAdicoes : 0;
      vfPdf[3] = r.lalur ? r.lalur.totalExclusoes : 0;
      vfPdf[4] = r.lalur ? r.lalur.lucroAjustado : 0;
      var compTotPdf = 0;
      if (r.compensacao && r.compensacao.resumo && r.compensacao.resumo.compensacaoEfetiva) {
        // CORREÇÃO BUG FÓRMULA MESTRE (PDF): Apenas compensação IRPJ, não somar CSLL
        compTotPdf = (r.compensacao.resumo.compensacaoEfetiva.prejuizoOperacional || 0);
      }
      // Fallback: ler do resultado do IRPJ se a compensação veio zerada
      if (compTotPdf === 0 && r.irpj) {
        compTotPdf = r.irpj.compensacaoPrejuizo || r.irpj.passo5_compensacao || 0;
      }
      vfPdf[5] = compTotPdf;
      vfPdf[6] = r.lucroRealFinal || 0;
      vfPdf[7] = r.irpj ? (r.irpj.irpjNormal || 0) : 0;
      vfPdf[8] = r.irpj ? (r.irpj.irpjAdicional || r.irpj.adicional || 0) : 0;
      vfPdf[9] = r.irpjAntesReducao || 0;
      vfPdf[10] = (r.incentivosFiscais ? (r.incentivosFiscais.totalDeducaoFinal || r.incentivosFiscais.economiaTotal || 0) : 0) + (r.reducaoSUDAM || 0);
      var retFormPdf = (r.retencoes ? r.retencoes.irrf : 0) || 0;
      vfPdf[11] = retFormPdf;
      vfPdf[12] = r.irpjAposReducao ? _r(r.irpjAposReducao - retFormPdf) : 0;

      var fmRows = [];
      LR.formulaMestre.passos.forEach(function (p) {
        var opI = p.operacao === '+' ? '(+)' : p.operacao === '-' ? '(-)' : p.operacao === '×' ? '(×)' : '(=)';
        var isT = (p.operacao === '=' && (p.passo === 6 || p.passo === 9 || p.passo === 12));
        var row = { cells: [opI, p.descricao + (p.artigo && p.artigo !== '-' ? ' — ' + p.artigo : ''), _m(vfPdf[p.passo] || 0)] };
        if (isT) row._subtotal = true;
        fmRows.push(row);
      });
      h += tabelaHTML(['Op.', 'Passo', 'Valor'], fmRows, { noAlignRight: false });
    }

    // Mapa Economia top 5 oportunidades (Seção 8)
    if (ops.length > 0) {
      h += secaoTitulo('🗺️', 'MAPA DE ECONOMIA — TOP 5');
      ops.slice(0, 5).forEach(function (op, i) {
        h += '<div style="background:#fff;border:1px solid #e8ecf0;border-left:4px solid ' + COR.accentDark + ';padding:8px 12px;margin:5px 0;page-break-inside:avoid;">';
        h += '<div style="display:flex;justify-content:space-between;align-items:center;">';
        h += '<div><strong style="font-size:10px;">#' + (i + 1) + ' ' + (op.titulo || '') + '</strong> ';
        h += badge(op.tipo || '', COR.primary) + badgeRisco(op.risco) + '</div>';
        h += '<div style="font-size:13px;font-weight:700;color:' + COR.accentDark + ';' + FONT_MONO + '">' + _m(op.economiaAnual || 0) + '/ano</div>';
        h += '</div></div>';
      });
    }

    // Alertas de compliance (Seção 4 — só se houver)
    var omissaoPdf = r.omissaoResult;
    if (omissaoPdf && omissaoPdf.indicadores && omissaoPdf.indicadores.length > 0) {
      h += secaoTitulo('⚠️', 'ALERTAS DE COMPLIANCE');
      omissaoPdf.indicadores.forEach(function (ind) {
        var tipoAl = ind.gravidade === 'CRITICO' ? 'critico' : ind.gravidade === 'ALTO' ? 'aviso' : 'info';
        h += alertaBox(tipoAl, '<strong>' + (ind.descricao || '') + '</strong>' + (ind.artigo ? ' (' + ind.artigo + ')' : '') + (ind.resolucao ? '<br>→ ' + ind.resolucao : ''));
      });
    }

    // Reforma Tributária disclaimer (Seção 6)
    if (LR.reformaTributaria) {
      h += '<div style="background:#f8f9fa;border-left:3px solid ' + COR.info + ';padding:10px 14px;margin:14px 0;font-size:9px;color:' + COR.textSec + ';line-height:1.5;page-break-inside:avoid;">';
      h += '<strong>⚖️ Reforma Tributária (LC 214/2025):</strong> ';
      h += (LR.reformaTributaria.disclaimer || '');
      if (LR.reformaTributaria.dataUltimaRevisao) h += ' <em>(Revisão: ' + LR.reformaTributaria.dataUltimaRevisao + ')</em>';
      h += '</div>';
    }

    // Footer
    h += pdfFooter(r);

    // Gerar
    var filename = 'relatorio-simplificado-' + (d.razaoSocial || 'empresa').replace(/[^a-zA-Z0-9]/g, '-').substring(0, 40) + '-' + _dataCurta() + '.pdf';
    gerarPDF(h, filename, function () { hideLoading(); });
  }


  // ═══════════════════════════════════════════════════════════════════════════════
  // ███████████████████████████████████████████████████████████████████████████████
  //  PDF COMPLETO — Para o contador (10-18 páginas, 14 seções)
  // ███████████████████████████████████████████████████████████████████████████████
  // ═══════════════════════════════════════════════════════════════════════════════

  function pdfCompleto() {
    var r = window.LucroRealEstudos ? window.LucroRealEstudos.getResultados() : null;
    if (!r) { alert('Gere o estudo antes de exportar.'); return; }

    showLoading('Gerando Relatório Completo — 14 seções...');

    var d = r.dadosEmpresa || {};
    var res = r.resumo || {};
    var eco = r.economia || {};
    var dre = r.dre || {};
    var lalur = r.lalur || {};
    var irpj = r.irpj || {};
    var csll = r.csll || {};
    var pc = r.pisCofins || {};
    var iss = r.iss || {};
    var comp = r.composicao || {};
    var ops = r.oportunidades || [];
    var ca = r.comparativoApuracao || {};
    var cen = r.cenarios || [];
    var proj = r.projecao || {};
    var fc = r.fluxoCaixa || {};
    var alertas = r.alertas || [];
    var obr = r.obrigacoes || [];
    var darfs = r.darfs || [];
    var cfg = r.config || {};

    var h = '';

    // ═════════════════════════════════════════════════════
    //  SEÇÃO 1 — CAPA PROFISSIONAL
    // ═════════════════════════════════════════════════════

    h += '<div style="text-align:center;padding:40px 20px 30px;page-break-after:always;">';
    // Logo
    h += '<div style="font-size:36px;font-weight:800;color:' + COR.primary + ';letter-spacing:2px;' + FONT + '">' + (cfg.nomeProduto || 'IMPOST.') + '</div>';
    h += '<div style="font-size:11px;color:' + COR.textMuted + ';margin-top:4px;">' + (cfg.subtitulo || '') + '</div>';
    h += '<div style="width:80px;height:3px;background:' + COR.primary + ';margin:20px auto;"></div>';
    // Título
    h += '<div style="font-size:20px;font-weight:700;color:' + COR.text + ';margin:24px 0 8px;">ESTUDO DE LUCRO REAL</div>';
    h += '<div style="font-size:13px;color:' + COR.textSec + ';">Relatório Completo de Análise Tributária</div>';
    // Dados da empresa
    h += '<div style="margin:30px auto;max-width:400px;text-align:left;background:#f8f9fa;border-radius:8px;padding:18px 24px;">';
    h += '<div style="font-size:14px;font-weight:700;color:' + COR.text + ';margin-bottom:8px;">' + _esc(d.razaoSocial || 'Empresa') + '</div>';
    var dadosCapa = [];
    if (d.cnpj) dadosCapa.push(['CNPJ', _esc(d.cnpj)]);
    if (d.cnaePrincipal) dadosCapa.push(['CNAE', _esc(d.cnaePrincipal)]);
    if (d.uf) dadosCapa.push(['UF/Município', _esc(d.municipio || '') + '/' + d.uf]);
    if (d.tipoAtividade) dadosCapa.push(['Atividade', d.tipoAtividade]);
    dadosCapa.push(['Apuração', (d.apuracaoLR === 'anual' ? 'Anual por Estimativa' : 'Trimestral')]);
    dadosCapa.push(['Ano-base', d.anoBase || new Date().getFullYear()]);
    dadosCapa.forEach(function (item) {
      h += '<div style="display:flex;justify-content:space-between;font-size:10px;padding:3px 0;border-bottom:1px solid #eee;">';
      h += '<span style="color:' + COR.textMuted + ';">' + item[0] + '</span>';
      h += '<span style="color:' + COR.text + ';font-weight:600;">' + item[1] + '</span>';
      h += '</div>';
    });
    h += '</div>';
    // Elaborado por
    var ep = cfg.elaboradoPor || {};
    if (ep.nome) {
      h += '<div style="margin-top:20px;font-size:10px;color:' + COR.textSec + ';">Elaborado por: <strong>' + _esc(ep.nome) + '</strong>';
      if (ep.registro) h += ' — ' + _esc(ep.registro);
      h += '</div>';
    }
    h += '<div style="font-size:9px;color:' + COR.textMuted + ';margin-top:12px;">' + _dataFormatada(r.dataGeracao) + ' — v' + (r.versao || '2.0.0') + '</div>';
    h += '</div>';


    // ═════════════════════════════════════════════════════
    //  SEÇÃO 2 — RESUMO EXECUTIVO
    // ═════════════════════════════════════════════════════

    h += secaoTitulo('📊', 'SEÇÃO 2 — RESUMO EXECUTIVO');

    h += grid(3, [
      miniCard('ECONOMIA TOTAL', _m(res.economiaTotal), COR.accentDark),
      miniCard('CARGA BRUTA', _m(res.cargaBruta), COR.danger, _m(res.cargaBrutaMensal) + '/mês'),
      miniCard('ALÍQUOTA EFETIVA', _pp(res.aliquotaEfetiva), COR.text),
      miniCard('CARGA OTIMIZADA', _m(res.cargaOtimizada), COR.accentDark, _pp(res.aliquotaOtimizada)),
      miniCard('RETENÇÕES', _m(res.totalRetencoes), COR.info),
      miniCard('SALDO A PAGAR', _m(res.saldoEfetivo), COR.text)
    ]);

    if (res.economiaTotal > 0) {
      h += cardEconomia('ECONOMIA TOTAL IDENTIFICADA', res.economiaTotal, _m(res.economiaTotal / 12) + ' por mês — ' + (res.numOportunidades || 0) + ' oportunidades');
    }


    // ═════════════════════════════════════════════════════
    //  SEÇÃO 3 — DRE + LALUR
    // ═════════════════════════════════════════════════════

    h += pageBreak();
    h += secaoTitulo('📋', 'SEÇÃO 3 — DEMONSTRAÇÃO DO RESULTADO (DRE) E LALUR');

    // DRE
    h += '<div style="font-weight:700;font-size:11px;color:' + COR.text + ';margin:10px 0 6px;">Demonstração do Resultado do Exercício (DRE)</div>';
    var pdfDeducoesRec = r.pisCofins ? _r((r.pisCofins.debitoPIS || 0) + (r.pisCofins.debitoCOFINS || 0)) : (dre.pisCofinsDebitos || 0);
    var pdfRecLiquida = _r(dre.receitaBruta - pdfDeducoesRec);
    var dreRows = [
      { cells: ['Receita Bruta', _m(dre.receitaBruta)] },
      { cells: ['(-) PIS/COFINS sobre Receita', _m(-pdfDeducoesRec)], _indent: 1 },
      { cells: ['= RECEITA LÍQUIDA', _m(pdfRecLiquida)], _subtotal: true },
      { cells: ['(-) Custos Totais', _m(-(dre.custosTotais || 0))], _indent: 1 },
    ];
    if (dre.cmv) dreRows.push({ cells: ['    CMV / CPV', _m(-dre.cmv)], _indent: 2 });
    if (dre.folhaPagamento) dreRows.push({ cells: ['    Folha de Pagamento', _m(-dre.folhaPagamento)], _indent: 2 });
    if (dre.servicosTerceiros) dreRows.push({ cells: ['    Serviços de Terceiros', _m(-dre.servicosTerceiros)], _indent: 2 });
    dreRows.push({ cells: ['= LUCRO BRUTO', _m(dre.lucroBruto || _r(pdfRecLiquida - dre.custosTotais))], _subtotal: true });
    dreRows.push({ cells: ['(-) Despesas Totais', _m(-(dre.despesasTotais || 0))], _indent: 1 });
    if (dre.depreciacao) dreRows.push({ cells: ['    Depreciação', _m(-dre.depreciacao)], _indent: 2 });
    if (dre.receitaFinanceiras) dreRows.push({ cells: ['(+) Receitas Financeiras', _m(dre.receitaFinanceiras)], _indent: 1 });
    dreRows.push({ cells: ['= LUCRO LÍQUIDO CONTÁBIL', _m(dre.lucroLiquido)], _subtotal: true });
    if (dre.margemLucro !== undefined) dreRows.push({ cells: ['Margem de Lucro', _pp(dre.margemLucro)] });
    h += tabelaHTML(['Item', 'Valor'], dreRows);

    // LALUR
    h += '<div style="font-weight:700;font-size:11px;color:' + COR.text + ';margin:14px 0 6px;">LALUR — Livro de Apuração do Lucro Real (Parte A)</div>';
    var lalurRows = [
      { cells: ['Lucro Líquido Contábil', _m(lalur.lucroLiquido), ''] }
    ];
    // Adições
    if (lalur.adicoes && lalur.adicoes.length > 0) {
      lalurRows.push({ cells: ['ADIÇÕES', '', ''], _subtotal: true });
      lalur.adicoes.forEach(function (a) {
        lalurRows.push({ cells: ['(+) ' + (a.desc || a.descricao || ''), _m(a.valor), a.artigo || ''], _indent: 1 });
      });
      lalurRows.push({ cells: ['Total Adições', _m(lalur.totalAdicoes), ''], _subtotal: true });
    }
    // Exclusões
    if (lalur.exclusoes && lalur.exclusoes.length > 0) {
      lalurRows.push({ cells: ['EXCLUSÕES', '', ''], _subtotal: true });
      lalur.exclusoes.forEach(function (e) {
        lalurRows.push({ cells: ['(-) ' + (e.desc || e.descricao || ''), _m(e.valor), e.artigo || ''], _indent: 1, _eco: e.valor > 0 });
      });
      lalurRows.push({ cells: ['Total Exclusões', _m(lalur.totalExclusoes), ''], _subtotal: true });
    }
    lalurRows.push({ cells: ['= LUCRO AJUSTADO', _m(lalur.lucroAjustado), ''], _subtotal: true });
    // Compensação
    if (r.compensacao && r.compensacao.resumo) {
      var compRes = r.compensacao.resumo;
      if (compRes.economia && compRes.economia.total > 0) {
        lalurRows.push({ cells: ['(-) Compensação Prejuízo Fiscal (30%)', _m(compRes.economia.total > 0 ? (lalur.lucroAjustado - r.lucroRealFinal) : 0), 'Art. 579-586 RIR/2018'], _eco: true });
      }
    }
    lalurRows.push({ cells: ['= LUCRO REAL FINAL', _m(r.lucroRealFinal), ''], _total: true });
    if (r.baseCSLLFinal !== undefined && r.baseCSLLFinal !== r.lucroRealFinal) {
      lalurRows.push({ cells: ['Base da CSLL Final', _m((r.csll && r.csll.baseCalculo !== undefined) ? r.csll.baseCalculo : r.baseCSLLFinal), ''] });
    }
    h += tabelaHTML(['Descrição', 'Valor', 'Base Legal'], lalurRows);


    // ═════════════════════════════════════════════════════
    //  SEÇÃO 4 — CÁLCULO DETALHADO DE TRIBUTOS
    // ═════════════════════════════════════════════════════

    h += pageBreak();
    h += secaoTitulo('🧮', 'SEÇÃO 4 — CÁLCULO DETALHADO DE TRIBUTOS');

    // IRPJ
    h += '<div style="font-weight:700;font-size:11px;color:' + COR.text + ';margin:10px 0 6px;">4.1 — IRPJ (Imposto de Renda Pessoa Jurídica)</div>';
    var irpjRows = [
      { cells: ['Lucro Real (Base de Cálculo)', _m((r.irpj && r.irpj.lucroReal !== undefined) ? r.irpj.lucroReal : r.lucroRealFinal)] },
      { cells: ['IRPJ Normal (15%)', _m(irpj.irpjNormal || 0)] },
      { cells: ['IRPJ Adicional (10% s/ excedente R$ 240k)', _m(irpj.adicional || 0)] },
      { cells: ['= IRPJ Bruto', _m(irpj.totalBruto || (irpj.irpjNormal || 0) + (irpj.adicional || 0))], _subtotal: true }
    ];
    if (r.incentivosFiscais && r.incentivosFiscais.economiaTotal > 0) {
      irpjRows.push({ cells: ['(-) Incentivos Fiscais', _m(-r.incentivosFiscais.economiaTotal)], _eco: true });
    }
    if (r.reducaoSUDAM > 0) {
      irpjRows.push({ cells: ['(-) Redução SUDAM/SUDENE (75%)', _m(-r.reducaoSUDAM)], _eco: true });
    }
    irpjRows.push({ cells: ['= IRPJ FINAL', _m(r.irpjAposReducao)], _total: true });
    h += tabelaHTML(['Item', 'Valor'], irpjRows);

    // CSLL
    h += '<div style="font-weight:700;font-size:11px;color:' + COR.text + ';margin:14px 0 6px;">4.2 — CSLL (Contribuição Social sobre o Lucro Líquido)</div>';
    h += tabelaHTML(['Item', 'Valor'], [
      { cells: ['Base da CSLL', _m((csll.baseCalculo !== undefined) ? csll.baseCalculo : (r.baseCSLLFinal || r.lucroRealFinal))] },
      { cells: ['Alíquota', _pp((csll.aliquota || 0.09) * 100)] },
      { cells: ['= CSLL DEVIDA', _m(csll.csllDevida)], _total: true }
    ]);

    // PIS/COFINS
    h += '<div style="font-weight:700;font-size:11px;color:' + COR.text + ';margin:14px 0 6px;">4.3 — PIS/COFINS (Não-Cumulativo)</div>';
    var pcRows = [
      { cells: ['Receita Tributável', _m(pc.receitaTributavel)] },
      { cells: ['Débito PIS (1,65%)', _m(pc.debitoPIS)] },
      { cells: ['Débito COFINS (7,6%)', _m(pc.debitoCOFINS)] },
      { cells: ['Total Débitos', _m((pc.debitoPIS || 0) + (pc.debitoCOFINS || 0))], _subtotal: true },
      { cells: ['(-) Crédito PIS', _m(-(pc.creditoPIS || 0))], _eco: pc.creditoPIS > 0 },
      { cells: ['(-) Crédito COFINS', _m(-(pc.creditoCOFINS || 0))], _eco: pc.creditoCOFINS > 0 }
    ];
    var pdfPisRetido = _n(d.pisRetido);
    var pdfCofinsRetido = _n(d.cofinsRetido);
    if (pdfPisRetido > 0) pcRows.push({ cells: ['(-) PIS Retido na Fonte', _m(-pdfPisRetido)] });
    if (pdfCofinsRetido > 0) pcRows.push({ cells: ['(-) COFINS Retido na Fonte', _m(-pdfCofinsRetido)] });
    var pdfPisCofinsLiq = _r(Math.max(pc.totalAPagarBruto - pdfPisRetido - pdfCofinsRetido, 0));
    pcRows.push({ cells: ['= PIS/COFINS A PAGAR', _m(pdfPisCofinsLiq)], _total: true });
    if (pc.economiaCreditos > 0) {
      pcRows.push({ cells: ['Economia com Créditos Não-Cumulativos', _m(pc.economiaCreditos)], _eco: true });
    }
    h += tabelaHTML(['Item', 'Valor'], pcRows);

    // ISS
    if (iss && (iss.issAnual > 0 || iss.receitaServicos > 0)) {
      h += '<div style="font-weight:700;font-size:11px;color:' + COR.text + ';margin:14px 0 6px;">4.4 — ISS (Imposto sobre Serviços)</div>';
      h += tabelaHTML(['Item', 'Valor'], [
        { cells: ['Receita de Serviços', _m(iss.receitaServicos)] },
        { cells: ['Alíquota ISS (' + (iss.municipio || '') + ')', _pp((iss.aliquota || 0) * 100)] },
        { cells: ['= ISS Anual', _m(iss.issAnual)], _total: true },
        { cells: ['ISS Mensal', _m(iss.issMensal)] }
      ]);
    }


    // ═════════════════════════════════════════════════════
    //  SEÇÃO 5 — COMPOSIÇÃO DA CARGA
    // ═════════════════════════════════════════════════════

    h += pageBreak();
    h += secaoTitulo('📊', 'SEÇÃO 5 — COMPOSIÇÃO DA CARGA TRIBUTÁRIA');

    h += tabelaHTML(['Tributo', 'Valor Anual', '% da Carga'], [
      { cells: ['IRPJ', _m(comp.irpj ? comp.irpj.valor : 0), _pp(comp.irpj ? comp.irpj.percentual : 0)] },
      { cells: ['CSLL', _m(comp.csll ? comp.csll.valor : 0), _pp(comp.csll ? comp.csll.percentual : 0)] },
      { cells: ['PIS/COFINS', _m(comp.pisCofins ? comp.pisCofins.valor : 0), _pp(comp.pisCofins ? comp.pisCofins.percentual : 0)] },
      { cells: ['ISS', _m(comp.iss ? comp.iss.valor : 0), _pp(comp.iss ? comp.iss.percentual : 0)] },
      { cells: ['TOTAL', _m(res.cargaBruta), '100,00%'], _total: true }
    ]);

    // Barras visuais
    h += '<div style="margin:12px 0;">';
    var maxComp = res.cargaBruta || 1;
    h += barraVisual(comp.irpj ? comp.irpj.valor : 0, maxComp, '#E74C3C', 'IRPJ');
    h += barraVisual(comp.csll ? comp.csll.valor : 0, maxComp, '#F39C12', 'CSLL');
    h += barraVisual(comp.pisCofins ? comp.pisCofins.valor : 0, maxComp, '#3498DB', 'PIS/COFINS');
    h += barraVisual(comp.iss ? comp.iss.valor : 0, maxComp, '#9B59B6', 'ISS');
    h += '</div>';


    // ═════════════════════════════════════════════════════
    //  SEÇÃO 6 — MAPA DA ECONOMIA
    // ═════════════════════════════════════════════════════

    h += secaoTitulo('💰', 'SEÇÃO 6 — MAPA DA ECONOMIA (ANTES × DEPOIS)');

    // Diagrama antes/depois
    h += '<div style="display:flex;align-items:center;justify-content:space-around;margin:12px 0;page-break-inside:avoid;">';
    h += '<div style="text-align:center;padding:14px 20px;background:#fff;border:2px solid ' + COR.danger + ';border-radius:8px;">';
    h += '<div style="font-size:9px;color:' + COR.textMuted + ';text-transform:uppercase;">Carga Bruta</div>';
    h += '<div style="font-size:20px;font-weight:700;color:' + COR.danger + ';' + FONT_MONO + '">' + _m(res.cargaBruta) + '</div></div>';
    h += '<div style="font-size:24px;color:' + COR.accentDark + ';">→</div>';
    h += '<div style="text-align:center;padding:14px 20px;background:' + COR.ecoBg + ';border:2px solid ' + COR.accentDark + ';border-radius:8px;">';
    h += '<div style="font-size:9px;color:' + COR.textMuted + ';text-transform:uppercase;">Economia</div>';
    h += '<div style="font-size:20px;font-weight:700;color:' + COR.accentDark + ';' + FONT_MONO + '">' + _m(res.economiaTotal) + '</div></div>';
    h += '<div style="font-size:24px;color:' + COR.primary + ';">→</div>';
    h += '<div style="text-align:center;padding:14px 20px;background:#fff;border:2px solid ' + COR.primary + ';border-radius:8px;">';
    h += '<div style="font-size:9px;color:' + COR.textMuted + ';text-transform:uppercase;">Carga Otimizada</div>';
    h += '<div style="font-size:20px;font-weight:700;color:' + COR.primary + ';' + FONT_MONO + '">' + _m(res.cargaOtimizada) + '</div></div>';
    h += '</div>';

    // Tabela detalhada de economia
    var ecoRows2 = [];
    var ecoKeys2 = ['jcp', 'prejuizo', 'sudam', 'incentivos', 'depreciacao', 'pisCofinsCreditos', 'gratificacao', 'cprb', 'pddFiscal'];
    ecoKeys2.forEach(function (k) {
      if (eco[k] > 0) {
        var info = ECONOMIA_NOMES[k] || {};
        ecoRows2.push({ cells: [info.nome || k, _m(eco[k]), info.base || '—'], _eco: true });
      }
    });
    if (ecoRows2.length > 0) {
      ecoRows2.push({ cells: ['ECONOMIA TOTAL', _m(eco.total || res.economiaTotal), ''], _total: true });
      h += tabelaHTML(['Fonte de Economia', 'Valor Anual', 'Base Legal'], ecoRows2);
    }

    // Projeção acumulada
    if (res.economiaTotal > 0) {
      h += '<div style="font-weight:700;font-size:11px;color:' + COR.text + ';margin:12px 0 6px;">Projeção de Economia Acumulada</div>';
      var projAnos2 = [1, 3, 5, 10];
      var projR2 = [];
      projAnos2.forEach(function (a) {
        if (proj.projecaoCarga && proj.projecaoCarga.length >= a) {
          projR2.push({ cells: [a + (a === 1 ? ' ano' : ' anos'), _m(proj.projecaoCarga[a - 1].economiaAcumulada)], _eco: true });
        } else {
          projR2.push({ cells: [a + (a === 1 ? ' ano' : ' anos'), _m(res.economiaTotal * a)], _eco: true });
        }
      });
      h += tabelaHTML(['Horizonte', 'Economia Acumulada'], projR2);
    }


    // ═════════════════════════════════════════════════════
    //  SEÇÃO 7 — OPORTUNIDADES
    // ═════════════════════════════════════════════════════

    if (ops.length > 0) {
      h += pageBreak();
      h += secaoTitulo('🎯', 'SEÇÃO 7 — OPORTUNIDADES DE ECONOMIA (' + ops.length + ')');

      ops.forEach(function (op, i) {
        h += '<div style="background:#fff;border:1px solid #e0e4e8;border-left:4px solid ' + COR.primary + ';padding:12px 16px;margin:8px 0;page-break-inside:avoid;">';
        // Header
        h += '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:4px;">';
        h += '<div><span style="background:' + COR.primary + ';color:#fff;padding:2px 8px;border-radius:10px;font-size:9px;font-weight:700;margin-right:6px;">#' + (op.ranking || i + 1) + '</span>';
        h += '<strong style="font-size:11px;">' + (op.titulo || '') + '</strong></div>';
        h += '<div style="font-size:14px;font-weight:700;color:' + COR.accentDark + ';' + FONT_MONO + '">' + _m(op.economiaAnual || 0) + '/ano</div>';
        h += '</div>';
        // Tags
        h += '<div style="margin:4px 0;">';
        h += badge(op.tipo || '', COR.primary);
        h += badgeComplexidade(op.complexidade);
        h += badgeRisco(op.risco);
        h += badge(op.prazoImplementacao || '', COR.info);
        h += '</div>';
        // Detalhes
        if (op.descricao) h += '<div style="font-size:9px;color:' + COR.textSec + ';margin:4px 0;line-height:1.5;">' + op.descricao + '</div>';
        if (op.baseLegal) h += '<div style="font-size:9px;color:' + COR.textMuted + ';"><em>Base legal: ' + op.baseLegal + '</em></div>';
        if (op.acaoRecomendada) h += '<div style="font-size:9px;color:' + COR.primary + ';font-weight:600;margin-top:4px;">→ Ação: ' + op.acaoRecomendada + '</div>';
        h += '</div>';
      });
    }


    // ═════════════════════════════════════════════════════
    //  SEÇÃO 8 — COMPARATIVO TRIMESTRAL vs ANUAL
    // ═════════════════════════════════════════════════════

    h += pageBreak();
    h += secaoTitulo('📈', 'SEÇÃO 8 — COMPARATIVO: TRIMESTRAL vs ANUAL POR ESTIMATIVA');

    // Trimestral
    if (ca.trimestral && ca.trimestral.trimestres) {
      h += '<div style="font-weight:700;font-size:11px;color:' + COR.text + ';margin:10px 0 6px;">8.1 — Apuração Trimestral</div>';
      var trimHeaders = ['Trim.', 'Lucro Ajust.', 'Comp. Prej.', 'Lucro Real', 'IRPJ Normal', 'IRPJ Adic.', 'IRPJ Total', 'CSLL'];
      var trimRows = [];
      ca.trimestral.trimestres.forEach(function (t) {
        trimRows.push({ cells: [t.trimestre + 'º', _m(t.lucroAjustado), _m(t.compensacaoPrejuizo), _m(t.lucroReal), _m(t.irpjNormal), _m(t.irpjAdicional), _m(t.irpjTotal), _m(t.csll)] });
      });
      trimRows.push({ cells: ['TOTAL', '', '', '', '', '', _m(ca.trimestral.totalIRPJ), _m(ca.trimestral.totalCSLL)], _total: true });
      h += tabelaHTML(trimHeaders, trimRows);
    }

    // Anual
    if (ca.anual && ca.anual.meses) {
      h += '<div style="font-weight:700;font-size:11px;color:' + COR.text + ';margin:14px 0 6px;">8.2 — Apuração Anual por Estimativa</div>';
      var anualHeaders = ['Mês', 'Receita Bruta', 'Est. IRPJ', 'Est. CSLL', 'Total Mês'];
      var anualRows = [];
      ca.anual.meses.forEach(function (m, i) {
        anualRows.push({ cells: [MESES[i] || m.mes, _m(m.receitaBruta), _m(m.irpjEstimativa), _m(m.csllEstimativa), _m(m.totalMes)] });
      });
      anualRows.push({ cells: ['TOTAL ESTIMATIVAS', '', _m(ca.anual.totalEstimativasIRPJ), _m(ca.anual.totalEstimativasCSLL), _m(ca.anual.totalEstimativas)], _total: true });
      // Ajuste anual
      if (ca.anual.ajusteTotal !== undefined) {
        anualRows.push({ cells: ['IRPJ Real Anual', '', _m(ca.anual.irpjRealAnual), _m(ca.anual.csllRealAnual), ''], _subtotal: true });
        anualRows.push({ cells: ['Ajuste (Real - Estimativas)', '', _m(ca.anual.ajusteIRPJ), _m(ca.anual.ajusteCSLL), _m(ca.anual.ajusteTotal)], _subtotal: true });
      }
      h += tabelaHTML(anualHeaders, anualRows);
    }

    // Suspensão/Redução
    if (ca.suspensao && ca.suspensao.meses && ca.suspensao.meses.length > 0) {
      h += '<div style="font-weight:700;font-size:11px;color:' + COR.text + ';margin:14px 0 6px;">8.3 — Oportunidades de Suspensão/Redução</div>';
      var suspHeaders = ['Mês', 'Situação', 'Est. IRPJ', 'IRPJ Pago', 'Est. CSLL', 'CSLL Paga', 'Economia'];
      var suspRows = [];
      ca.suspensao.meses.forEach(function (m, i) {
        var isEco = (m.economia || 0) > 0;
        suspRows.push({ cells: [MESES[i] || m.mes, m.situacao || '', _m(m.estimativaIRPJ), _m(m.irpjPago), _m(m.estimativaCSLL), _m(m.csllPaga), _m(m.economia)], _eco: isEco });
      });
      if (ca.suspensao.economiaTotalSuspensao > 0) {
        suspRows.push({ cells: ['TOTAL', ca.suspensao.mesesSuspensos + ' meses suspensos', '', '', '', '', _m(ca.suspensao.economiaTotalSuspensao)], _total: true });
      }
      h += tabelaHTML(suspHeaders, suspRows);
    }

    // Recomendação
    if (ca.recomendacao) {
      h += '<div style="background:' + COR.infoBg + ';border-left:4px solid ' + COR.info + ';padding:12px 16px;margin:12px 0;page-break-inside:avoid;">';
      h += '<div style="font-weight:700;color:' + COR.text + ';font-size:11px;">📋 Recomendação</div>';
      h += '<div style="font-size:10px;color:' + COR.textSec + ';margin-top:4px;">';
      h += 'Forma recomendada: <strong style="color:' + COR.primary + ';">' + (ca.recomendacao.formaRecomendada === 'anual' ? 'ANUAL por Estimativa' : 'TRIMESTRAL') + '</strong>';
      if (ca.recomendacao.justificativa) h += '<br>' + ca.recomendacao.justificativa;
      if (ca.recomendacao.diferenca) h += '<br>Diferença: <strong style="color:' + COR.accentDark + ';">' + _m(Math.abs(ca.recomendacao.diferenca)) + '</strong>';
      h += '</div></div>';
    }


    // ═════════════════════════════════════════════════════
    //  SEÇÃO 9 — CENÁRIOS
    // ═════════════════════════════════════════════════════

    if (cen && cen.length > 0) {
      h += pageBreak();
      h += secaoTitulo('📉', 'SEÇÃO 9 — CENÁRIOS (Pessimista / Base / Otimista)');

      var cenHeaders = ['Indicador'];
      cen.forEach(function (c) { cenHeaders.push(c.nome || ''); });
      var indicadores = ['margem', 'lucro', 'irpjCSLL', 'pisCofins', 'iss', 'cargaTotal', 'aliquotaEfetiva'];
      var labels = { margem: 'Margem (%)', lucro: 'Lucro', irpjCSLL: 'IRPJ + CSLL', pisCofins: 'PIS/COFINS', iss: 'ISS', cargaTotal: 'Carga Total', aliquotaEfetiva: 'Alíquota Efetiva (%)' };
      var cenRows = [];
      indicadores.forEach(function (ind) {
        var row = [labels[ind] || ind];
        cen.forEach(function (c) {
          var v = c[ind];
          if (ind === 'margem' || ind === 'aliquotaEfetiva') row.push(_pp(v));
          else row.push(_m(v));
        });
        cenRows.push({ cells: row });
      });
      h += tabelaHTML(cenHeaders, cenRows);
    }

    // Projeção plurianual
    if (proj.projecaoCarga && proj.projecaoCarga.length > 0) {
      h += '<div style="font-weight:700;font-size:11px;color:' + COR.text + ';margin:14px 0 6px;">Projeção Plurianual</div>';
      var projHeaders = ['Ano', 'Receita', 'Carga', 'Economia Ano', 'Economia Acumulada'];
      var projRows = [];
      proj.projecaoCarga.forEach(function (p) {
        projRows.push({ cells: ['Ano ' + p.ano, _m(p.receita), _m(p.carga), _m(p.economiaAno), _m(p.economiaAcumulada)], _eco: true });
      });
      h += tabelaHTML(projHeaders, projRows);
    }


    // ═════════════════════════════════════════════════════
    //  SEÇÃO 10 — FLUXO DE CAIXA
    // ═════════════════════════════════════════════════════

    h += pageBreak();
    h += secaoTitulo('📅', 'SEÇÃO 10 — FLUXO DE CAIXA TRIBUTÁRIO MENSAL');

    if (fc.meses && fc.meses.length > 0) {
      var fcHeaders2 = ['Mês', 'IRPJ', 'CSLL', 'PIS', 'COFINS', 'ISS', 'TOTAL'];
      var fcRows2 = [];
      fc.meses.forEach(function (m, i) {
        fcRows2.push({ cells: [MESES[i] || m.mes, _m(m.irpj), _m(m.csll), _m(m.pis), _m(m.cofins), _m(m.iss), _m(m.total)] });
      });
      // ═══ FIX BUG #3: Usar valores anuais exatos nos totais do PDF completo ═══
      var _fcPdf2IRPJ = fc.irpjAnualExato !== undefined ? fc.irpjAnualExato : fc.meses.reduce(function (s, m) { return s + (m.irpj || 0); }, 0);
      var _fcPdf2CSLL = fc.csllAnualExato !== undefined ? fc.csllAnualExato : fc.meses.reduce(function (s, m) { return s + (m.csll || 0); }, 0);
      var _fcPdf2PIS = fc.pisAnualExato !== undefined ? fc.pisAnualExato : fc.meses.reduce(function (s, m) { return s + (m.pis || 0); }, 0);
      var _fcPdf2COF = fc.cofinsAnualExato !== undefined ? fc.cofinsAnualExato : fc.meses.reduce(function (s, m) { return s + (m.cofins || 0); }, 0);
      var _fcPdf2ISS = fc.meses.reduce(function (s, m) { return s + (m.iss || 0); }, 0);
      fcRows2.push({ cells: ['TOTAL ANUAL', _m(_r(_fcPdf2IRPJ)), _m(_r(_fcPdf2CSLL)), _m(_r(_fcPdf2PIS)), _m(_r(_fcPdf2COF)), _m(_r(_fcPdf2ISS)), _m(fc.totalAnual || 0)], _total: true });
      if (fc.mediaMensal) {
        fcRows2.push({ cells: ['Média Mensal', '', '', '', '', '', _m(fc.mediaMensal)], _subtotal: true });
      }
      h += tabelaHTML(fcHeaders2, fcRows2);
      h += '<div style="font-size:9px;color:' + COR.textMuted + ';margin-top:6px;">Forma de apuração: ' + (fc.apuracao || d.apuracaoLR || 'N/A') + '</div>';
    }


    // ═════════════════════════════════════════════════════
    //  SEÇÃO 11 — ALERTAS E COMPLIANCE
    // ═════════════════════════════════════════════════════

    h += pageBreak();
    h += secaoTitulo('⚠️', 'SEÇÃO 11 — ALERTAS E COMPLIANCE');

    // Obrigatoriedade
    if (r.obrigatoriedade) {
      if (r.obrigatoriedade.obrigado) {
        h += alertaBox('critico', '<strong>OBRIGATÓRIO:</strong> Esta empresa é obrigatória ao Lucro Real. Motivo: ' + (r.obrigatoriedade.motivo || 'Legislação vigente.'));
      } else {
        h += alertaBox('info', 'A empresa pode optar pelo Lucro Real (não obrigatória). ' + (r.obrigatoriedade.motivo || ''));
      }
    }

    // Alerta da Reforma Tributária
    h += alertaBox('aviso', '<strong>Reforma Tributária (LC 214/2025):</strong> A CBS e o IBS substituirão PIS/COFINS e ISS/ICMS a partir de 2026 (transição até 2033). Os cálculos de PIS/COFINS e ISS neste estudo seguem a legislação atual vigente. Recomenda-se acompanhar a regulamentação.');

    // Vedações
    if (r.vedacoes && r.vedacoes.length > 0) {
      r.vedacoes.forEach(function (v) {
        h += alertaBox('aviso', '<strong>Vedação:</strong> ' + (v.msg || v.descricao || v));
      });
    }

    // Alertas do motor
    if (alertas.length > 0) {
      alertas.forEach(function (a) {
        h += alertaBox(a.tipo || 'info', a.msg || '');
      });
    } else {
      h += alertaBox('info', 'Nenhum alerta adicional identificado na análise.');
    }


    // ═════════════════════════════════════════════════════
    //  SEÇÃO 12 — OBRIGAÇÕES ACESSÓRIAS E DARFs
    // ═════════════════════════════════════════════════════

    h += secaoTitulo('📝', 'SEÇÃO 12 — OBRIGAÇÕES ACESSÓRIAS E DARFs');

    if (obr.length > 0) {
      h += '<div style="font-weight:700;font-size:10px;margin:8px 0 4px;">Obrigações Acessórias do Lucro Real</div>';
      var obrRows = [];
      obr.forEach(function (o) {
        var _perPdf = '';
        if (o.prazo) {
          var _plp = o.prazo.toLowerCase();
          if (_plp.indexOf('mensal') >= 0 || _plp.indexOf('mês') >= 0 || _plp.indexOf('15º') >= 0 || _plp.indexOf('10º') >= 0) _perPdf = 'Mensal';
          else if (_plp.indexOf('trimestral') >= 0 || _plp.indexOf('trimestre') >= 0) _perPdf = 'Trimestral';
          else if (_plp.indexOf('anual') >= 0 || _plp.indexOf('ano') >= 0 || _plp.indexOf('julho') >= 0 || _plp.indexOf('maio') >= 0 || _plp.indexOf('fevereiro') >= 0) _perPdf = 'Anual';
          else if (_plp.indexOf('contínuo') >= 0 || _plp.indexOf('continuo') >= 0) _perPdf = 'Contínuo';
          else if (_plp.indexOf('período') >= 0 || _plp.indexOf('periodo') >= 0) _perPdf = 'Por Período';
          else if (_plp.indexOf('prescrever') >= 0 || _plp.indexOf('5 anos') >= 0) _perPdf = 'Permanente';
          else if (_plp.indexOf('varia') >= 0) _perPdf = 'Varia por UF';
          else _perPdf = o.prazo.split('(')[0].trim() || '';
        }
        obrRows.push({ cells: [o.obrigacao || o.nome || '', _perPdf, o.prazo || '', o.descricao || ''] });
      });
      h += tabelaHTML(['Obrigação', 'Periodicidade', 'Prazo', 'Descrição'], obrRows, { noAlignRight: true });
    }

    if (darfs.length > 0) {
      h += '<div style="font-weight:700;font-size:10px;margin:12px 0 4px;">Códigos DARF</div>';
      var darfRows = [];
      darfs.forEach(function (df) {
        if (df) darfRows.push({ cells: [df.tributo || '', df.codigo || '', df.periodicidade || '', df.prazo || ''] });
      });
      if (darfRows.length > 0) {
        h += tabelaHTML(['Tributo', 'Código DARF', 'Periodicidade', 'Prazo'], darfRows, { noAlignRight: true });
      }
    }


    // ═════════════════════════════════════════════════════
    //  SEÇÃO 13 — DETALHAMENTOS COMPLEMENTARES
    // ═════════════════════════════════════════════════════

    h += pageBreak();
    h += secaoTitulo('📎', 'SEÇÃO 13 — DETALHAMENTOS COMPLEMENTARES');

    // JCP
    if (r.jcpDetalhado && r.jcpDetalhado.jcpDedutivel > 0) {
      h += '<div style="font-weight:700;font-size:10px;margin:10px 0 4px;">13.1 — Juros sobre Capital Próprio (JCP)</div>';
      h += tabelaHTML(['Item', 'Valor'], [
        { cells: ['JCP Dedutível (PL × TJLP)', _m(r.jcpDetalhado.jcpDedutivel)] },
        { cells: ['IRRF sobre JCP (17,5%)', _m(r.jcpDetalhado.irpjJCP || r.jcpDetalhado.irrfJCP)] },
        { cells: ['Economia Líquida (34% - 17,5%)', _m(r.jcpDetalhado.economiaLiquida)], _eco: true },
        { cells: ['Limite (Lucro Líquido)', _m(r.jcpDetalhado.limiteLucro)] }
      ]);
    }

    // Compensação de prejuízo
    if (r.compensacao && r.compensacao.resumo && r.compensacao.resumo.economia && r.compensacao.resumo.economia.total > 0) {
      h += '<div style="font-weight:700;font-size:10px;margin:14px 0 4px;">13.2 — Compensação de Prejuízo Fiscal</div>';
      var compEco = r.compensacao.resumo.economia;
      var compSaldos = r.compensacao.resumo.saldosPosCompensacao || {};
      h += tabelaHTML(['Item', 'Valor'], [
        { cells: ['Economia com IRPJ', _m(compEco.irpj || compEco.total)], _eco: true },
        { cells: ['Economia com CSLL', _m(compEco.csll || 0)], _eco: true },
        { cells: ['Economia Total', _m(compEco.total)], _eco: true },
        { cells: ['Saldo Remanescente Prejuízo Fiscal', _m(compSaldos.prejuizoOperacional || compSaldos.prejuizoFiscal || 0)] },
        { cells: ['Saldo Remanescente Base Negativa CSLL', _m(compSaldos.baseNegativaCSLL || 0)] }
      ]);
    }

    // Depreciação
    if (r.depreciacaoDetalhada && r.depreciacaoDetalhada.bens && r.depreciacaoDetalhada.bens.length > 0) {
      h += '<div style="font-weight:700;font-size:10px;margin:14px 0 4px;">13.3 — Depreciação Detalhada</div>';
      var depHeaders = ['Tipo de Bem', 'Valor Original', 'Taxa', 'Deprec. Normal', 'Deprec. Acelerada'];
      var depRows = [];
      r.depreciacaoDetalhada.bens.forEach(function (b) {
        depRows.push({ cells: [b.tipo || '', _m(b.valorOriginal), _pp(b.taxa * 100), _m(b.depreciaNormal), _m(b.depreciaAcelerada)] });
      });
      depRows.push({ cells: ['TOTAL', '', '', _m(r.depreciacaoDetalhada.depreciaNormal), _m(r.depreciacaoDetalhada.depreciaAcelerada)], _subtotal: true });
      depRows.push({ cells: ['Economia Fiscal com Depreciação', '', '', '', _m(r.depreciacaoDetalhada.economiaFiscal)], _eco: true });
      h += tabelaHTML(depHeaders, depRows);
      if (r.depreciacaoDetalhada.turnos > 1) {
        h += '<div style="font-size:9px;color:' + COR.textMuted + ';">Turnos de operação: ' + r.depreciacaoDetalhada.turnos + ' (multiplicador: ' + r.depreciacaoDetalhada.multiplicador + 'x)</div>';
      }
    }

    // SUDAM/SUDENE
    if (r.sudamDetalhado && r.sudamDetalhado.resumo) {
      var sudR = r.sudamDetalhado.resumo;
      if ((sudR.economiaReducao75 || 0) + (sudR.economiaReinvestimento30 || 0) > 0) {
        h += '<div style="font-weight:700;font-size:10px;margin:14px 0 4px;">13.4 — SUDAM/SUDENE</div>';
        h += tabelaHTML(['Item', 'Valor'], [
          { cells: ['Economia Redução 75%', _m(sudR.economiaReducao75)], _eco: true },
          { cells: ['Economia Reinvestimento 30%', _m(sudR.economiaReinvestimento30)], _eco: true }
        ]);
      }
    }

    // CPRB
    if (r.cprb && r.cprb.optou && r.cprb.economia > 0) {
      h += '<div style="font-weight:700;font-size:10px;margin:14px 0 4px;">13.5 — CPRB (Desoneração da Folha)</div>';
      h += tabelaHTML(['Item', 'Valor'], [
        { cells: ['Alíquota CPRB', _pp(r.cprb.aliquota * 100)] },
        { cells: ['Base CPRB', _m(r.cprb.baseCPRB)] },
        { cells: ['Custo CPRB', _m(r.cprb.custoCPRB)] },
        { cells: ['CPP Normal (sem desoneração)', _m(r.cprb.cppNormal)] },
        { cells: ['Economia', _m(r.cprb.economia)], _eco: true },
        { cells: ['Compensa?', r.cprb.compensa ? 'SIM' : 'NÃO'] }
      ]);
    }

    // Incentivos Fiscais
    if (r.incentivosFiscais && r.incentivosFiscais.incentivos && r.incentivosFiscais.incentivos.length > 0) {
      h += '<div style="font-weight:700;font-size:10px;margin:14px 0 4px;">13.6 — Incentivos Fiscais</div>';
      var incRows = [];
      r.incentivosFiscais.incentivos.forEach(function (inc) {
        incRows.push({ cells: [inc.nome || inc.tipo || '', _m(inc.valor || inc.economia || 0), inc.baseLegal || ''] });
      });
      incRows.push({ cells: ['TOTAL INCENTIVOS', _m(r.incentivosFiscais.economiaTotal), ''], _total: true });
      h += tabelaHTML(['Incentivo', 'Economia', 'Base Legal'], incRows);
    }

    // Retenções compensadas
    if (r.retencoesCompensadas && r.retencoesCompensadas.tributosARecolher) {
      h += '<div style="font-weight:700;font-size:10px;margin:14px 0 4px;">13.7 — Retenções Compensadas</div>';
      var retObj = r.retencoesCompensadas.tributosARecolher;
      var retRows = [];
      Object.keys(retObj).forEach(function (k) {
        if (k !== 'total') retRows.push({ cells: [k.toUpperCase(), _m(retObj[k])] });
      });
      retRows.push({ cells: ['TOTAL A RECOLHER APÓS RETENÇÕES', _m(retObj.total)], _total: true });
      h += tabelaHTML(['Tributo', 'Valor a Recolher'], retRows);
    }


    // ═════════════════════════════════════════════════════
    //  SEÇÃO NOVA PDF 1 — DIAGNÓSTICO DESPESAS COM LIMITES
    // ═════════════════════════════════════════════════════

    var vdlPdf = r.validacaoDespesasLimites;
    if (vdlPdf && (vdlPdf.doacoes || vdlPdf.previdencia || vdlPdf.royalties)) {
      h += pageBreak();
      h += secaoTitulo('📋', 'DIAGNÓSTICO DE DESPESAS COM LIMITES LEGAIS');
      var dlRows = [];
      if (vdlPdf.doacoes) {
        var excDPdf = vdlPdf.doacoes.excesso || vdlPdf.doacoes.excedenteTotal || 0;
        dlRows.push({ cells: ['Doações', _m(vdlPdf.doacoes.totalInformado || 0), _m(vdlPdf.doacoes.limiteCalculado || vdlPdf.doacoes.limiteTotal || 0), excDPdf > 0 ? _m(excDPdf) : '—'] });
      }
      if (vdlPdf.previdencia) {
        var excPPdf = vdlPdf.previdencia.excesso || vdlPdf.previdencia.excedente || 0;
        dlRows.push({ cells: ['Previdência Complementar', _m(vdlPdf.previdencia.contribuicao || vdlPdf.previdencia.totalInformado || 0), _m(vdlPdf.previdencia.limite || vdlPdf.previdencia.limiteCalculado || 0), excPPdf > 0 ? _m(excPPdf) : '—'] });
      }
      if (vdlPdf.royalties) {
        var excRPdf = vdlPdf.royalties.excesso || vdlPdf.royalties.excedente || 0;
        dlRows.push({ cells: ['Royalties', _m(vdlPdf.royalties.royaltiesPagos || vdlPdf.royalties.totalInformado || 0), _m(vdlPdf.royalties.limite || vdlPdf.royalties.limiteCalculado || 0), excRPdf > 0 ? _m(excRPdf) : '—'] });
      }
      h += tabelaHTML(['Despesa', 'Valor Informado', 'Limite Legal', 'Excesso'], dlRows);
    }

    // ═════════════════════════════════════════════════════
    //  SEÇÃO NOVA PDF 2 — DESPESAS INDEDUTÍVEIS
    // ═════════════════════════════════════════════════════

    var diPdf = r.despesasIndedutivelDetalhe;
    if (diPdf && diPdf.length > 0) {
      h += secaoTitulo('🚫', 'DESPESAS INDEDUTÍVEIS IDENTIFICADAS');
      var diRowsPdf = [];
      var totalIndPdf = 0;
      var totalImpPdf = 0;
      diPdf.forEach(function (di) {
        var impDi = _r((di.valor || 0) * 0.34);
        totalIndPdf += (di.valor || 0);
        totalImpPdf += impDi;
        diRowsPdf.push({ cells: [di.descricao || di.desc || '', di.artigo || '', _m(di.valor), _m(impDi)] });
      });
      diRowsPdf.push({ cells: ['TOTAL', '', _m(totalIndPdf), _m(totalImpPdf)], _total: true });
      h += tabelaHTML(['Despesa', 'Artigo', 'Valor', 'Impacto (34%)'], diRowsPdf);
    }

    // ═════════════════════════════════════════════════════
    //  SEÇÃO NOVA PDF 3 — SUBCAPITALIZAÇÃO
    // ═════════════════════════════════════════════════════

    if (r.subcapResult) {
      h += secaoTitulo('🏦', 'ANÁLISE DE SUBCAPITALIZAÇÃO');
      if (r.subcapResult.excedeu) {
        h += alertaBox('critico', '<strong>Juros indedutíveis:</strong> ' + _m(r.subcapResult.jurosIndedutiveis || 0) + ' — Ação: reestruturar dívida (Art. 249-251)');
      } else {
        h += alertaBox('info', 'Dívidas com vinculadas dentro dos limites de subcapitalização.');
      }
    }

    // ═════════════════════════════════════════════════════
    //  SEÇÃO NOVA PDF 4 — ALERTAS COMPLIANCE / OMISSÃO
    // ═════════════════════════════════════════════════════

    var omPdf = r.omissaoResult;
    if (omPdf && omPdf.indicadores && omPdf.indicadores.length > 0) {
      h += secaoTitulo('🔍', 'ALERTAS DE COMPLIANCE E OMISSÃO DE RECEITA');
      omPdf.indicadores.forEach(function (ind) {
        var tipoAlPdf = ind.gravidade === 'CRITICO' ? 'critico' : ind.gravidade === 'ALTO' ? 'aviso' : 'info';
        h += alertaBox(tipoAlPdf, '<strong>' + (ind.descricao || '') + '</strong>' + (ind.artigo ? ' (' + ind.artigo + ')' : '') + (ind.resolucao ? '<br>→ ' + ind.resolucao : ''));
      });
    }

    // ═════════════════════════════════════════════════════
    //  SEÇÃO NOVA PDF 5 — AMORTIZAÇÃO, EXAUSTÃO, PRÉ-OPER.
    // ═════════════════════════════════════════════════════

    if (r.goodwillResult || r.exaustaoResult || r.preOperacionalResult) {
      h += secaoTitulo('📊', 'AMORTIZAÇÃO, EXAUSTÃO E PRÉ-OPERACIONAIS');
      var aeRows = [];
      if (r.goodwillResult) {
        var gwDedPdf = r.goodwillResult.amortizacaoAnual || r.goodwillResult.deducaoAnual || 0;
        aeRows.push({ cells: ['Goodwill', _m(r.goodwillResult.valorGoodwill || 0), _m(gwDedPdf), _m(_r(gwDedPdf * 0.34)), 'Lei 12.973, Art. 20-22'], _eco: true });
      }
      if (r.exaustaoResult) {
        var exDedPdf = r.exaustaoResult.exaustaoAnual || r.exaustaoResult.deducaoAnual || 0;
        aeRows.push({ cells: ['Exaustão', _m(r.exaustaoResult.custoAquisicao || 0), _m(exDedPdf), _m(_r(exDedPdf * 0.34)), 'Art. 334-337 RIR'], _eco: true });
      }
      if (r.preOperacionalResult) {
        var poDedPdf = r.preOperacionalResult.amortizacaoAnual || r.preOperacionalResult.deducaoAnual || 0;
        aeRows.push({ cells: ['Pré-Operacionais', _m(r.preOperacionalResult.valorTotal || 0), _m(poDedPdf), _m(_r(poDedPdf * 0.34)), 'Art. 11 Lei 12.973'], _eco: true });
      }
      h += tabelaHTML(['Item', 'Valor Original', 'Dedução Anual', 'Economia (34%)', 'Base Legal'], aeRows);
    }

    // ═════════════════════════════════════════════════════
    //  SEÇÃO NOVA PDF 6 — REFORMA TRIBUTÁRIA
    // ═════════════════════════════════════════════════════

    if (LR.reformaTributaria) {
      h += pageBreak();
      h += secaoTitulo('⚖️', 'REFORMA TRIBUTÁRIA — IMPACTOS LC 214/2025');
      if (LR.reformaTributaria.impactosLucroReal) {
        var rtRows = [];
        LR.reformaTributaria.impactosLucroReal.forEach(function (imp) {
          rtRows.push({ cells: [imp.tema || '', imp.descricao || '', imp.impacto || '', imp.statusRegulamentacao || imp.status || ''] });
        });
        h += tabelaHTML(['Tema', 'Descrição', 'Impacto', 'Status'], rtRows, { noAlignRight: true });
      }
      h += '<div style="font-style:italic;font-size:9px;color:' + COR.textMuted + ';margin:8px 0;">' + (LR.reformaTributaria.disclaimer || '') + '</div>';
      if (LR.reformaTributaria.dataUltimaRevisao) {
        h += '<div style="font-size:8px;color:' + COR.textMuted + ';">Última revisão: ' + LR.reformaTributaria.dataUltimaRevisao + '</div>';
      }
    }

    // ═════════════════════════════════════════════════════
    //  SEÇÃO NOVA PDF 7 — FÓRMULA MESTRE
    // ═════════════════════════════════════════════════════

    if (LR.formulaMestre && LR.formulaMestre.passos) {
      h += secaoTitulo('📐', 'FÓRMULA MESTRE DO LUCRO REAL');
      var vfPdfC = {};
      vfPdfC[1] = dre.lucroLiquido || 0;
      vfPdfC[2] = lalur.totalAdicoes || 0;
      vfPdfC[3] = lalur.totalExclusoes || 0;
      vfPdfC[4] = lalur.lucroAjustado || 0;
      var compTotPdfC = 0;
      if (r.compensacao && r.compensacao.resumo && r.compensacao.resumo.compensacaoEfetiva) {
        // CORREÇÃO BUG FÓRMULA MESTRE (PDF Completo): Apenas compensação IRPJ, não somar CSLL
        compTotPdfC = (r.compensacao.resumo.compensacaoEfetiva.prejuizoOperacional || 0);
      }
      // Fallback: ler do resultado do IRPJ se a compensação veio zerada
      if (compTotPdfC === 0 && r.irpj) {
        compTotPdfC = r.irpj.compensacaoPrejuizo || r.irpj.passo5_compensacao || 0;
      }
      vfPdfC[5] = compTotPdfC;
      vfPdfC[6] = r.lucroRealFinal || 0;
      vfPdfC[7] = irpj.irpjNormal || 0;
      vfPdfC[8] = irpj.irpjAdicional || irpj.adicional || 0;
      vfPdfC[9] = r.irpjAntesReducao || 0;
      vfPdfC[10] = (r.incentivosFiscais ? (r.incentivosFiscais.totalDeducaoFinal || r.incentivosFiscais.economiaTotal || 0) : 0) + (r.reducaoSUDAM || 0);
      var retFormPdfC = r.retencoes ? (r.retencoes.irrf || 0) : 0;
      vfPdfC[11] = retFormPdfC;
      vfPdfC[12] = r.irpjAposReducao ? _r(r.irpjAposReducao - retFormPdfC) : 0;

      var fmRowsC = [];
      LR.formulaMestre.passos.forEach(function (p) {
        var opI = p.operacao === '+' ? '(+)' : p.operacao === '-' ? '(-)' : p.operacao === '×' ? '(×)' : '(=)';
        var isT = (p.operacao === '=' && (p.passo === 6 || p.passo === 9 || p.passo === 12));
        var row = { cells: [opI, p.descricao + (p.artigo && p.artigo !== '-' ? ' — ' + p.artigo : ''), _m(vfPdfC[p.passo] || 0)] };
        if (isT) row._subtotal = true;
        fmRowsC.push(row);
      });
      h += tabelaHTML(['Op.', 'Passo', 'Valor'], fmRowsC);
    }

    // ═════════════════════════════════════════════════════
    //  SEÇÃO NOVA PDF 8 — MAPA ESTRATÉGIAS RANKINGS
    // ═════════════════════════════════════════════════════

    if (LR.estrategiasEconomia && LR.estrategiasEconomia.length > 0 && ops.length > 0) {
      h += secaoTitulo('🗺️', 'MAPA DE ESTRATÉGIAS DE ECONOMIA — RANKINGS');
      var estRows = [];
      LR.estrategiasEconomia.forEach(function (est) {
        var econEstPdf = 0;
        var ecoKeyPdf = est.nome.toLowerCase();
        if (ecoKeyPdf.indexOf('jcp') >= 0) econEstPdf = eco.jcp || 0;
        else if (ecoKeyPdf.indexOf('prejuízo') >= 0 || ecoKeyPdf.indexOf('prejuizo') >= 0) econEstPdf = eco.prejuizo || 0;
        else if (ecoKeyPdf.indexOf('sudam') >= 0) econEstPdf = eco.sudam || 0;
        else if (ecoKeyPdf.indexOf('incentiv') >= 0) econEstPdf = eco.incentivos || 0;
        else if (ecoKeyPdf.indexOf('deprecia') >= 0) econEstPdf = eco.depreciacao || 0;
        else if (ecoKeyPdf.indexOf('pis') >= 0 || ecoKeyPdf.indexOf('cofins') >= 0) econEstPdf = eco.pisCofinsCreditos || 0;
        estRows.push({ cells: [est.nome, est.tipo || '', _m(econEstPdf), est.complexidade || '', est.risco || '', est.artigo || ''], _eco: econEstPdf > 0 });
      });
      h += tabelaHTML(['Estratégia', 'Tipo', 'Economia Real', 'Complexidade', 'Risco', 'Artigo'], estRows, { noAlignRight: true });
    }

    // ═════════════════════════════════════════════════════
    //  SEÇÃO NOVA PDF 9 — ESTRUTURA LALUR
    // ═════════════════════════════════════════════════════

    if (LR.lalur) {
      h += secaoTitulo('📑', 'ESTRUTURA LALUR — PARTE A E PARTE B');

      // Parte A
      h += '<div style="font-weight:700;font-size:10px;margin:8px 0 4px;">Parte A — Demonstração do Lucro Real</div>';
      var lalurRowsPdf = [];
      if (lalur.adicoes && lalur.adicoes.length > 0) {
        lalur.adicoes.forEach(function (a) {
          lalurRowsPdf.push({ cells: ['(+) Adição', a.desc || a.descricao || '', _m(a.valor), a.artigo || ''] });
        });
      }
      if (lalur.exclusoes && lalur.exclusoes.length > 0) {
        lalur.exclusoes.forEach(function (e) {
          lalurRowsPdf.push({ cells: ['(-) Exclusão', e.desc || e.descricao || '', _m(e.valor), e.artigo || ''], _eco: true });
        });
      }
      if (lalurRowsPdf.length > 0) {
        h += tabelaHTML(['Tipo', 'Descrição', 'Valor', 'Artigo'], lalurRowsPdf, { noAlignRight: true });
      }

      // Parte B
      h += '<div style="font-weight:700;font-size:10px;margin:12px 0 4px;">Parte B — Controles Futuros</div>';
      var parteBRows = [];
      var saldoPrejPdf = 0;
      if (r.compensacao && r.compensacao.resumo && r.compensacao.resumo.saldosPosCompensacao) {
        saldoPrejPdf = r.compensacao.resumo.saldosPosCompensacao.prejuizoOperacional || r.compensacao.resumo.saldosPosCompensacao.prejuizoFiscal || 0;
      }
      if (saldoPrejPdf > 0) parteBRows.push({ cells: ['Prejuízos Fiscais', _m(saldoPrejPdf), '30% do lucro ajustado por período'] });
      var saldoBNPdf = 0;
      if (r.compensacao && r.compensacao.resumo && r.compensacao.resumo.saldosPosCompensacao) {
        saldoBNPdf = r.compensacao.resumo.saldosPosCompensacao.baseNegativaCSLL || 0;
      }
      if (saldoBNPdf > 0) parteBRows.push({ cells: ['Base Negativa CSLL', _m(saldoBNPdf), '30% da base positiva'] });
      if (parteBRows.length > 0) {
        h += tabelaHTML(['Controle', 'Saldo', 'Projeção Reversão'], parteBRows);
      }
    }

    // ═════════════════════════════════════════════════════
    //  SEÇÃO NOVA PDF 10 — ALÍQUOTAS APLICÁVEIS (PARTE 5B)
    // ═════════════════════════════════════════════════════

    if (LR.aliquotas) {
      h += secaoTitulo('📊', 'ALÍQUOTAS APLICÁVEIS — REFERÊNCIA');
      var aliqRowsPdf = [];
      var aIRPJ = LR.aliquotas.irpj || {};
      var aCSLL = LR.aliquotas.csll || {};
      var aPC = LR.aliquotas.pisCofins || {};
      aliqRowsPdf.push({ cells: ['IRPJ Normal', _pp((aIRPJ.normal || 0.15) * 100), aIRPJ.artigoBase || 'Art. 225'] });
      aliqRowsPdf.push({ cells: ['IRPJ Adicional', _pp((aIRPJ.adicional || 0.10) * 100), 'Excedente R$ 20.000/mês'] });
      aliqRowsPdf.push({ cells: ['CSLL Geral', _pp((aCSLL.geral || 0.09) * 100), aCSLL.artigoBase || 'Lei 7.689'] });
      aliqRowsPdf.push({ cells: ['CSLL Financeiras', _pp((aCSLL.financeiras || 0.15) * 100), 'Lei 13.169/2015'] });
      aliqRowsPdf.push({ cells: ['PIS NC', _pp((aPC.pisNaoCumulativo || 0.0165) * 100), 'Lei 10.637/02'] });
      aliqRowsPdf.push({ cells: ['COFINS NC', _pp((aPC.cofinsNaoCumulativo || 0.076) * 100), 'Lei 10.833/03'] });
      aliqRowsPdf.push({ cells: ['JCP IRRF', '17,50%', 'Art. 355-358 + LC 224/2025'] });
      aliqRowsPdf.push({ cells: ['Trava Compensação', '30,00%', 'Art. 580-590'] });
      h += tabelaHTML(['Tributo', 'Alíquota', 'Base Legal'], aliqRowsPdf, { noAlignRight: true });
    }

    // ═════════════════════════════════════════════════════
    //  SEÇÃO NOVA PDF 11 — HIPÓTESES OBRIGATORIEDADE (PARTE 5B)
    // ═════════════════════════════════════════════════════

    if (LR.obrigatoriedadeLucroReal && LR.obrigatoriedadeLucroReal.hipoteses) {
      h += secaoTitulo('📋', 'HIPÓTESES DE OBRIGATORIEDADE DO LUCRO REAL');
      var hipRowsPdf = [];
      LR.obrigatoriedadeLucroReal.hipoteses.forEach(function (hip) {
        var apl = false;
        if (hip.id === 'RECEITA' && _n(d.receitaBrutaAnual) > (hip.valor || 78000000)) apl = true;
        else if (hip.id === 'FINANCEIRA' && (d.ehInstituicaoFinanceira === true || d.ehInstituicaoFinanceira === "true")) apl = true;
        else if (hip.id === 'LUCRO_EXTERIOR' && (d.temLucroExterior === true || d.temLucroExterior === "true")) apl = true;
        else if (hip.id === 'BENEFICIO_FISCAL' && (d.temBeneficioFiscalIsencao === true || d.temBeneficioFiscalIsencao === "true")) apl = true;
        else if (hip.id === 'FACTORING' && (d.ehFactoring === true || d.ehFactoring === "true")) apl = true;
        else if (hip.id === 'SECURITIZADORA' && (d.ehSecuritizadora === true || d.ehSecuritizadora === "true")) apl = true;
        hipRowsPdf.push({ cells: [hip.inciso || '', hip.descricao || '', apl ? '✅ SIM' : '—'] });
      });
      h += tabelaHTML(['Inciso', 'Hipótese', 'Aplicável?'], hipRowsPdf, { noAlignRight: true });
    }


    // ═════════════════════════════════════════════════════
    //  SEÇÃO NOVA PDF 12 — ACRÉSCIMOS MORATÓRIOS (Bloco H)
    // ═════════════════════════════════════════════════════

    if (r.acrescimosMoratorios || r.multaOficio || LR.multasEMora) {
      h += pageBreak();
      h += secaoTitulo('⚖️', 'ACRÉSCIMOS MORATÓRIOS E MULTAS (Arts. 44, 47, 61, 63)');

      if (LR.multasEMora) {
        var mmPdf = LR.multasEMora;
        var moraRefRows = [];
        if (mmPdf.multaMora) {
          moraRefRows.push({ cells: ['Multa de Mora (diária)', _pp((mmPdf.multaMora.taxaDiaria || 0.0033) * 100), mmPdf.multaMora.artigo || 'Art. 61'] });
          moraRefRows.push({ cells: ['Teto Multa de Mora', _pp((mmPdf.multaMora.teto || 0.20) * 100), 'Art. 61'] });
        }
        if (mmPdf.jurosMora) {
          moraRefRows.push({ cells: ['Juros de Mora', 'SELIC + 1%/mês', mmPdf.jurosMora.artigo || 'Art. 61, §3º'] });
        }
        if (mmPdf.multaOficio) {
          moraRefRows.push({ cells: ['Multa Ofício Padrão', _pp((mmPdf.multaOficio.padrao || 0.75) * 100), mmPdf.multaOficio.artigo || 'Art. 44'] });
          moraRefRows.push({ cells: ['Multa Ofício Fraude', _pp((mmPdf.multaOficio.fraude || 1.50) * 100), 'Art. 44, §1º'] });
          if (mmPdf.multaOficio.reducoes && mmPdf.multaOficio.reducoes.conformidadeLei14689) {
            moraRefRows.push({ cells: ['Redução Lei 14.689/2023', 'Até -' + _pp((mmPdf.multaOficio.reducoes.conformidadeLei14689.comTransacao || 0.50) * 100), mmPdf.multaOficio.reducoes.conformidadeLei14689.artigo || 'Lei 14.689/2023'] });
          }
        }
        if (mmPdf.prazoEspontaneo) {
          moraRefRows.push({ cells: ['Prazo Espontâneo', (mmPdf.prazoEspontaneo.diasAposTermoFiscalizacao || 20) + ' dias', mmPdf.prazoEspontaneo.artigo || 'Art. 47'] });
        }
        if (moraRefRows.length > 0) {
          h += '<div style="font-weight:700;font-size:10px;margin:8px 0 4px;">Parâmetros Legais</div>';
          h += tabelaHTML(['Parâmetro', 'Valor', 'Base Legal'], moraRefRows, { noAlignRight: true });
        }
      }

      if (r.acrescimosMoratorios) {
        var amPdf = r.acrescimosMoratorios;
        h += '<div style="font-weight:700;font-size:10px;margin:12px 0 4px;">Simulação de Acréscimos Moratórios</div>';
        var amRows = [];
        amRows.push({ cells: ['Valor Original', _m(amPdf.valorOriginal || 0)] });
        amRows.push({ cells: ['(+) Multa de Mora', _m(amPdf.multaMora || 0)] });
        amRows.push({ cells: ['(+) Juros SELIC', _m(amPdf.jurosMora || 0)] });
        amRows.push({ cells: ['(=) Total a Pagar', _m(amPdf.valorTotal || 0)], _highlight: true });
        h += tabelaHTML(['Item', 'Valor'], amRows);
      }

      if (r.multaOficio) {
        var moPdf = r.multaOficio;
        h += '<div style="font-weight:700;font-size:10px;margin:12px 0 4px;">Simulação de Multa de Ofício</div>';
        h += '<div style="font-size:9px;color:' + COR.text + ';">Percentual: ' + _pp((moPdf.percentualAplicado || 0.75) * 100) + ' — Multa: ' + _m(moPdf.multaOficio || moPdf.valorFinal || 0) + '</div>';
        if (moPdf.reducoes && moPdf.reducoes.length > 0) {
          h += '<div style="font-size:9px;color:' + COR.acento + ';margin-top:4px;">Reduções: ' + moPdf.reducoes.join('; ') + '</div>';
        }
      }

      if (r.suspensaoMulta && r.suspensaoMulta.suspensa) {
        h += '<div style="font-size:9px;color:' + COR.acento + ';margin-top:6px;">✅ Multa de ofício suspensa — ' + (r.suspensaoMulta.motivo || 'Liminar/Tutela') + ' (Art. 63)</div>';
      }
    }


    // ═════════════════════════════════════════════════════
    //  SEÇÃO NOVA PDF 13 — COMPENSAÇÃO PER/DCOMP (Bloco I)
    // ═════════════════════════════════════════════════════

    if (r.compensacaoPERDCOMP || r.compensacaoJudicial || LR.compensacaoPERDCOMP) {
      h += pageBreak();
      h += secaoTitulo('🔄', 'COMPENSAÇÃO PER/DCOMP (Arts. 73, 74, 74-A)');

      if (LR.compensacaoPERDCOMP) {
        var cpPdf = LR.compensacaoPERDCOMP;
        if (cpPdf.vedacoes && cpPdf.vedacoes.length > 0) {
          h += '<div style="font-weight:700;font-size:10px;margin:8px 0 4px;">Vedações (§3º do Art. 74)</div>';
          var vedRows = [];
          cpPdf.vedacoes.forEach(function (v) {
            vedRows.push({ cells: [v.id || '', v.descricao || '', v.artigo || ''] });
          });
          h += tabelaHTML(['Hipótese', 'Descrição', 'Artigo'], vedRows, { noAlignRight: true });
        }
        if (cpPdf.multaCompensacaoIndevida) {
          h += '<div style="font-size:9px;color:#e74c3c;margin:6px 0;">⚠️ Multa compensação indevida: ' + _pp((cpPdf.multaCompensacaoIndevida.percentual || 0.50) * 100) + ' sobre valor não homologado (' + (cpPdf.multaCompensacaoIndevida.artigo || '§17') + ')</div>';
        }
      }

      if (r.compensacaoPERDCOMP) {
        var pdcPdf = r.compensacaoPERDCOMP;
        h += '<div style="font-weight:700;font-size:10px;margin:12px 0 4px;">Análise da Compensação</div>';
        h += '<div style="font-size:9px;color:' + (pdcPdf.compensacaoPermitida ? COR.acento : '#e74c3c') + ';">' + (pdcPdf.compensacaoPermitida ? '✅ Compensação Permitida' : '❌ Compensação Vedada') + '</div>';
        if (pdcPdf.vedacoes && pdcPdf.vedacoes.length > 0) {
          h += '<div style="font-size:9px;color:#e74c3c;margin-top:4px;">Vedações: ' + pdcPdf.vedacoes.join(', ') + '</div>';
        }
        if (pdcPdf.riscoMulta50 && pdcPdf.riscoMulta50.aplicavel) {
          h += '<div style="font-size:9px;color:#e74c3c;margin-top:4px;">Risco multa 50%: ' + _m(pdcPdf.riscoMulta50.valor || 0) + '</div>';
        }
      }

      if (r.compensacaoJudicial && r.compensacaoJudicial.sujeito) {
        var cjPdf = r.compensacaoJudicial;
        h += '<div style="font-weight:700;font-size:10px;margin:12px 0 4px;">Compensação Judicial (Art. 74-A)</div>';
        h += '<div style="font-size:9px;color:' + COR.text + ';">Limite mensal: ' + _m(cjPdf.limiteMensal || 0) + ' — Prazo: ' + (cjPdf.prazoTotal || 60) + ' meses</div>';
        if (cjPdf.cronograma && cjPdf.cronograma.length > 0 && cjPdf.cronograma.length <= 12) {
          var cjRows = [];
          cjPdf.cronograma.forEach(function (p) {
            cjRows.push({ cells: [p.mes || p.parcela || '', _m(p.valor || p.compensacao || 0), _m(p.saldo || p.saldoRemanescente || 0)] });
          });
          h += tabelaHTML(['Mês', 'Compensação', 'Saldo'], cjRows);
        }
      }
    }


    // ═════════════════════════════════════════════════════
    //  SEÇÃO 14 — DISCLAIMER + RODAPÉ
    // ═════════════════════════════════════════════════════

    h += pageBreak();
    h += secaoTitulo('📜', 'SEÇÃO 14 — NOTAS FINAIS E DISCLAIMER');
    h += pdfFooter(r);


    // GERAR PDF
    var filename = 'relatorio-completo-' + (d.razaoSocial || 'empresa').replace(/[^a-zA-Z0-9]/g, '-').substring(0, 40) + '-' + _dataCurta() + '.pdf';
    gerarPDF(h, filename, function () { hideLoading(); });
  }


  // ═══════════════════════════════════════════════════════════════════════════════
  // ███████████████████████████████████████████████████████████████████████████████
  //  EXPORTAR EXCEL — 6 abas com SheetJS
  // ███████████████████████████████████████████████████████████████████████████████
  // ═══════════════════════════════════════════════════════════════════════════════

  function exportarExcel() {
    var r = window.LucroRealEstudos ? window.LucroRealEstudos.getResultados() : null;
    if (!r) { alert('Gere o estudo antes de exportar.'); return; }
    if (typeof XLSX === 'undefined') { alert('SheetJS (XLSX) não foi carregado.'); return; }

    showLoading('Gerando planilha Excel...');

    var d = r.dadosEmpresa || {};
    var res = r.resumo || {};
    var eco = r.economia || {};
    var dre = r.dre || {};
    var lalur = r.lalur || {};
    var irpj = r.irpj || {};
    var csll = r.csll || {};
    var pc = r.pisCofins || {};
    var iss = r.iss || {};
    var comp = r.composicao || {};
    var ops = r.oportunidades || [];
    var fc = r.fluxoCaixa || {};
    var cen = r.cenarios || [];
    var proj = r.projecao || {};

    var wb = XLSX.utils.book_new();

    // Helper: criar worksheet com largura de colunas
    function addSheet(name, aoa, colWidths) {
      var ws = XLSX.utils.aoa_to_sheet(aoa);
      if (colWidths) ws['!cols'] = colWidths.map(function (w) { return { wch: w }; });
      XLSX.utils.book_append_sheet(wb, ws, name);
    }

    // Formatador numérico para Excel
    function mv(v) { return _r(v || 0); }
    function pv(v) { return _r((v || 0) * 100); }

    // ═════════════════════════════════════════════════════
    //  ABA 1 — RESUMO
    // ═════════════════════════════════════════════════════

    var aba1 = [];
    aba1.push(['ESTUDO DE LUCRO REAL — RESUMO EXECUTIVO']);
    aba1.push([]);
    aba1.push(['DADOS DA EMPRESA']);
    aba1.push(['Razão Social', d.razaoSocial || '']);
    aba1.push(['CNPJ', d.cnpj || '']);
    aba1.push(['CNAE', d.cnaePrincipal || '']);
    aba1.push(['UF/Município', (d.municipio || '') + '/' + (d.uf || '')]);
    aba1.push(['Atividade', d.tipoAtividade || '']);
    aba1.push(['Apuração', d.apuracaoLR === 'anual' ? 'Anual por Estimativa' : 'Trimestral']);
    aba1.push(['Ano-base', d.anoBase || '']);
    aba1.push(['Receita Bruta Anual', mv(d.receitaBrutaAnual)]);
    aba1.push([]);
    aba1.push(['INDICADORES PRINCIPAIS']);
    aba1.push(['Economia Total Identificada', mv(res.economiaTotal)]);
    aba1.push(['Carga Tributária Bruta', mv(res.cargaBruta)]);
    aba1.push(['Carga Tributária Mensal', mv(res.cargaBrutaMensal)]);
    aba1.push(['Alíquota Efetiva (%)', pv(res.aliquotaEfetiva / 100)]);
    aba1.push(['Carga Otimizada', mv(res.cargaOtimizada)]);
    aba1.push(['Alíquota Otimizada (%)', pv(res.aliquotaOtimizada / 100)]);
    aba1.push(['Retenções a Compensar', mv(res.totalRetencoes)]);
    aba1.push(['Saldo Federal a Pagar', mv(res.saldoEfetivo)]);
    aba1.push([]);
    aba1.push(['FONTES DE ECONOMIA', 'Valor Anual', 'Base Legal']);
    var ecoKeys3 = ['jcp', 'prejuizo', 'sudam', 'incentivos', 'depreciacao', 'pisCofinsCreditos', 'gratificacao', 'cprb', 'pddFiscal'];
    ecoKeys3.forEach(function (k) {
      if (eco[k] > 0) {
        var info = ECONOMIA_NOMES[k] || {};
        aba1.push([info.nome || k, mv(eco[k]), info.base || '']);
      }
    });
    aba1.push(['ECONOMIA TOTAL', mv(eco.total || res.economiaTotal), '']);
    addSheet('Resumo', aba1, [40, 18, 30]);


    // ═════════════════════════════════════════════════════
    //  ABA 2 — DRE-LALUR
    // ═════════════════════════════════════════════════════

    var aba2 = [];
    aba2.push(['DRE — DEMONSTRAÇÃO DO RESULTADO DO EXERCÍCIO']);
    aba2.push(['Item', 'Valor']);
    aba2.push(['Receita Bruta', mv(dre.receitaBruta)]);
    var xlDeducoesRec = r.pisCofins ? _r((r.pisCofins.debitoPIS || 0) + (r.pisCofins.debitoCOFINS || 0)) : (dre.pisCofinsDebitos || 0);
    aba2.push(['(-) PIS/COFINS sobre Receita', mv(-xlDeducoesRec)]);
    aba2.push(['= RECEITA LÍQUIDA', mv(_r(dre.receitaBruta - xlDeducoesRec))]);
    aba2.push(['(-) Custos Totais', mv(-(dre.custosTotais || 0))]);
    if (dre.cmv) aba2.push(['    CMV / CPV', mv(-dre.cmv)]);
    if (dre.folhaPagamento) aba2.push(['    Folha de Pagamento', mv(-dre.folhaPagamento)]);
    if (dre.servicosTerceiros) aba2.push(['    Serviços de Terceiros', mv(-dre.servicosTerceiros)]);
    aba2.push(['= LUCRO BRUTO', mv(dre.lucroBruto || _r(dre.receitaBruta - xlDeducoesRec - dre.custosTotais))]);
    aba2.push(['(-) Despesas Totais', mv(-(dre.despesasTotais || 0))]);
    if (dre.depreciacao) aba2.push(['    Depreciação', mv(-dre.depreciacao)]);
    if (dre.receitaFinanceiras) aba2.push(['(+) Receitas Financeiras', mv(dre.receitaFinanceiras)]);
    aba2.push(['= LUCRO LÍQUIDO CONTÁBIL', mv(dre.lucroLiquido)]);
    if (dre.margemLucro !== undefined) aba2.push(['Margem de Lucro (%)', pv(dre.margemLucro / 100)]);
    aba2.push([]);
    aba2.push(['LALUR — LIVRO DE APURAÇÃO DO LUCRO REAL']);
    aba2.push(['Descrição', 'Valor', 'Base Legal']);
    aba2.push(['Lucro Líquido Contábil', mv(lalur.lucroLiquido), '']);
    if (lalur.adicoes && lalur.adicoes.length > 0) {
      aba2.push(['--- ADIÇÕES ---', '', '']);
      lalur.adicoes.forEach(function (a) {
        aba2.push(['(+) ' + (a.desc || a.descricao || ''), mv(a.valor), a.artigo || '']);
      });
      aba2.push(['Total Adições', mv(lalur.totalAdicoes), '']);
    }
    if (lalur.exclusoes && lalur.exclusoes.length > 0) {
      aba2.push(['--- EXCLUSÕES ---', '', '']);
      lalur.exclusoes.forEach(function (e) {
        aba2.push(['(-) ' + (e.desc || e.descricao || ''), mv(e.valor), e.artigo || '']);
      });
      aba2.push(['Total Exclusões', mv(lalur.totalExclusoes), '']);
    }
    aba2.push(['= LUCRO AJUSTADO', mv(lalur.lucroAjustado), '']);
    aba2.push(['= LUCRO REAL FINAL', mv(r.lucroRealFinal), '']);
    if (r.baseCSLLFinal !== undefined) aba2.push(['Base CSLL Final', mv((r.csll && r.csll.baseCalculo !== undefined) ? r.csll.baseCalculo : r.baseCSLLFinal), '']);
    addSheet('DRE-LALUR', aba2, [40, 18, 30]);


    // ═════════════════════════════════════════════════════
    //  ABA 3 — TRIBUTOS
    // ═════════════════════════════════════════════════════

    var aba3 = [];
    aba3.push(['CÁLCULO DETALHADO DE TRIBUTOS']);
    aba3.push([]);
    aba3.push(['IRPJ']);
    var xlBaseIRPJ = (r.irpj && r.irpj.lucroReal !== undefined) ? r.irpj.lucroReal : r.lucroRealFinal;
    aba3.push(['Lucro Real (Base de Cálculo)', mv(xlBaseIRPJ)]);
    aba3.push(['IRPJ Normal (15%)', mv(irpj.irpjNormal)]);
    aba3.push(['IRPJ Adicional (10%)', mv(irpj.adicional)]);
    aba3.push(['IRPJ Bruto', mv(irpj.totalBruto || (irpj.irpjNormal || 0) + (irpj.adicional || 0))]);
    if (r.reducaoSUDAM > 0) aba3.push(['(-) Redução SUDAM/SUDENE', mv(-r.reducaoSUDAM)]);
    if (r.incentivosFiscais && r.incentivosFiscais.economiaTotal > 0) aba3.push(['(-) Incentivos Fiscais', mv(-r.incentivosFiscais.economiaTotal)]);
    aba3.push(['IRPJ FINAL', mv(r.irpjAposReducao)]);
    aba3.push([]);
    aba3.push(['CSLL']);
    aba3.push(['Base CSLL', mv((r.csll && r.csll.baseCalculo !== undefined) ? r.csll.baseCalculo : (r.baseCSLLFinal || r.lucroRealFinal))]);
    aba3.push(['Alíquota (%)', pv(csll.aliquota)]);
    aba3.push(['CSLL Devida', mv(csll.csllDevida)]);
    aba3.push([]);
    aba3.push(['PIS/COFINS (Não-Cumulativo)']);
    aba3.push(['Receita Tributável', mv(pc.receitaTributavel)]);
    aba3.push(['Débito PIS (1,65%)', mv(pc.debitoPIS)]);
    aba3.push(['Débito COFINS (7,6%)', mv(pc.debitoCOFINS)]);
    aba3.push(['(-) Crédito PIS', mv(-(pc.creditoPIS || 0))]);
    aba3.push(['(-) Crédito COFINS', mv(-(pc.creditoCOFINS || 0))]);
    var xlPisRet = _n(d.pisRetido), xlCofRet = _n(d.cofinsRetido);
    if (xlPisRet > 0) aba3.push(['(-) PIS Retido na Fonte', mv(-xlPisRet)]);
    if (xlCofRet > 0) aba3.push(['(-) COFINS Retido na Fonte', mv(-xlCofRet)]);
    aba3.push(['PIS/COFINS a Pagar', mv(Math.max(pc.totalAPagarBruto - xlPisRet - xlCofRet, 0))]);
    if (pc.economiaCreditos > 0) aba3.push(['Economia com Créditos', mv(pc.economiaCreditos)]);
    aba3.push([]);
    aba3.push(['ISS']);
    if (iss) {
      aba3.push(['Receita de Serviços', mv(iss.receitaServicos)]);
      aba3.push(['Alíquota ISS (%)', pv(iss.aliquota)]);
      aba3.push(['ISS Anual', mv(iss.issAnual)]);
      aba3.push(['ISS Mensal', mv(iss.issMensal)]);
    }
    aba3.push([]);
    aba3.push(['COMPOSIÇÃO DA CARGA']);
    aba3.push(['Tributo', 'Valor Anual', '% da Carga']);
    aba3.push(['IRPJ', mv(comp.irpj ? comp.irpj.valor : 0), pv((comp.irpj ? comp.irpj.percentual : 0) / 100)]);
    aba3.push(['CSLL', mv(comp.csll ? comp.csll.valor : 0), pv((comp.csll ? comp.csll.percentual : 0) / 100)]);
    aba3.push(['PIS/COFINS', mv(comp.pisCofins ? comp.pisCofins.valor : 0), pv((comp.pisCofins ? comp.pisCofins.percentual : 0) / 100)]);
    aba3.push(['ISS', mv(comp.iss ? comp.iss.valor : 0), pv((comp.iss ? comp.iss.percentual : 0) / 100)]);
    aba3.push(['TOTAL', mv(res.cargaBruta), '100.00']);
    addSheet('Tributos', aba3, [35, 18, 14]);


    // ═════════════════════════════════════════════════════
    //  ABA 4 — OPORTUNIDADES
    // ═════════════════════════════════════════════════════

    var aba4 = [];
    aba4.push(['OPORTUNIDADES DE ECONOMIA TRIBUTÁRIA']);
    aba4.push(['#', 'Título', 'Tipo', 'Economia Anual', 'Complexidade', 'Risco', 'Prazo', 'Base Legal', 'Descrição', 'Ação Recomendada']);
    ops.forEach(function (op, i) {
      aba4.push([
        op.ranking || i + 1,
        op.titulo || '',
        op.tipo || '',
        mv(op.economiaAnual),
        op.complexidade || '',
        op.risco || '',
        op.prazoImplementacao || '',
        op.baseLegal || '',
        op.descricao || '',
        op.acaoRecomendada || ''
      ]);
    });
    addSheet('Oportunidades', aba4, [5, 30, 12, 16, 12, 10, 12, 25, 50, 50]);


    // ═════════════════════════════════════════════════════
    //  ABA 5 — FLUXO MENSAL
    // ═════════════════════════════════════════════════════

    var aba5 = [];
    aba5.push(['FLUXO DE CAIXA TRIBUTÁRIO MENSAL']);
    aba5.push(['Mês', 'IRPJ', 'CSLL', 'PIS', 'COFINS', 'ISS', 'TOTAL']);
    if (fc.meses) {
      fc.meses.forEach(function (m, i) {
        aba5.push([MESES[i] || m.mes, mv(m.irpj), mv(m.csll), mv(m.pis), mv(m.cofins), mv(m.iss), mv(m.total)]);
      });
      // ═══ FIX BUG #3: Usar valores anuais exatos nos totais do Excel ═══
      var _fcXlsIRPJ = fc.irpjAnualExato !== undefined ? fc.irpjAnualExato : fc.meses.reduce(function (s, m) { return s + (m.irpj || 0); }, 0);
      var _fcXlsCSLL = fc.csllAnualExato !== undefined ? fc.csllAnualExato : fc.meses.reduce(function (s, m) { return s + (m.csll || 0); }, 0);
      var _fcXlsPIS = fc.pisAnualExato !== undefined ? fc.pisAnualExato : fc.meses.reduce(function (s, m) { return s + (m.pis || 0); }, 0);
      var _fcXlsCOF = fc.cofinsAnualExato !== undefined ? fc.cofinsAnualExato : fc.meses.reduce(function (s, m) { return s + (m.cofins || 0); }, 0);
      var _fcXlsISS = fc.meses.reduce(function (s, m) { return s + (m.iss || 0); }, 0);
      aba5.push([
        'TOTAL ANUAL',
        mv(_r(_fcXlsIRPJ)),
        mv(_r(_fcXlsCSLL)),
        mv(_r(_fcXlsPIS)),
        mv(_r(_fcXlsCOF)),
        mv(_r(_fcXlsISS)),
        mv(fc.totalAnual || 0)
      ]);
      if (fc.mediaMensal) {
        aba5.push(['Média Mensal', '', '', '', '', '', mv(fc.mediaMensal)]);
      }
    }
    addSheet('Fluxo Mensal', aba5, [14, 14, 14, 14, 14, 14, 16]);


    // ═════════════════════════════════════════════════════
    //  ABA 6 — CENÁRIOS + PROJEÇÃO
    // ═════════════════════════════════════════════════════

    var aba6 = [];
    if (cen && cen.length > 0) {
      aba6.push(['CENÁRIOS — ANÁLISE DE SENSIBILIDADE']);
      var cenH = ['Indicador'];
      cen.forEach(function (c) { cenH.push(c.nome || ''); });
      aba6.push(cenH);
      var indicadores2 = [
        { k: 'margem', l: 'Margem (%)' },
        { k: 'lucro', l: 'Lucro' },
        { k: 'irpjCSLL', l: 'IRPJ + CSLL' },
        { k: 'pisCofins', l: 'PIS/COFINS' },
        { k: 'iss', l: 'ISS' },
        { k: 'cargaTotal', l: 'Carga Total' },
        { k: 'aliquotaEfetiva', l: 'Alíquota Efetiva (%)' }
      ];
      indicadores2.forEach(function (ind) {
        var row = [ind.l];
        cen.forEach(function (c) {
          if (ind.k === 'margem' || ind.k === 'aliquotaEfetiva') row.push(pv(c[ind.k] / 100));
          else row.push(mv(c[ind.k]));
        });
        aba6.push(row);
      });
      aba6.push([]);
    }

    if (proj.projecaoCarga && proj.projecaoCarga.length > 0) {
      aba6.push(['PROJEÇÃO PLURIANUAL']);
      aba6.push(['Ano', 'Receita', 'Carga', 'Economia Ano', 'Economia Acumulada']);
      proj.projecaoCarga.forEach(function (p) {
        aba6.push(['Ano ' + p.ano, mv(p.receita), mv(p.carga), mv(p.economiaAno), mv(p.economiaAcumulada)]);
      });
    }

    if (aba6.length === 0) {
      aba6.push(['Cenários e projeção não gerados']);
      aba6.push(['Ative as opções "Gerar Cenários" e "Gerar Projeção" na Etapa 7 do wizard.']);
    }
    addSheet('Cenários-Projeção', aba6, [20, 18, 18, 18, 20]);


    // ═════════════════════════════════════════════════════
    //  ABA 7 — DESPESAS LIMITES
    // ═════════════════════════════════════════════════════

    var aba7 = [];
    aba7.push(['DESPESAS COM LIMITES LEGAIS']);
    aba7.push(['Despesa', 'Valor Informado', 'Limite Legal', 'Excesso Indedutível']);
    var vdlXls = r.validacaoDespesasLimites;
    if (vdlXls) {
      if (vdlXls.doacoes) {
        aba7.push(['Doações', mv(vdlXls.doacoes.totalInformado || 0), mv(vdlXls.doacoes.limiteCalculado || vdlXls.doacoes.limiteTotal || 0), mv(vdlXls.doacoes.excesso || vdlXls.doacoes.excedenteTotal || 0)]);
      }
      if (vdlXls.previdencia) {
        aba7.push(['Previdência Complementar', mv(vdlXls.previdencia.contribuicao || vdlXls.previdencia.totalInformado || 0), mv(vdlXls.previdencia.limite || vdlXls.previdencia.limiteCalculado || 0), mv(vdlXls.previdencia.excesso || vdlXls.previdencia.excedente || 0)]);
      }
      if (vdlXls.royalties) {
        aba7.push(['Royalties', mv(vdlXls.royalties.royaltiesPagos || vdlXls.royalties.totalInformado || 0), mv(vdlXls.royalties.limite || vdlXls.royalties.limiteCalculado || 0), mv(vdlXls.royalties.excesso || vdlXls.royalties.excedente || 0)]);
      }
    } else {
      aba7.push(['Nenhuma despesa com limite informada', '', '', '']);
    }
    addSheet('Despesas Limites', aba7, [30, 18, 18, 18]);


    // ═════════════════════════════════════════════════════
    //  ABA 8 — INDEDUTÍVEIS
    // ═════════════════════════════════════════════════════

    var aba8 = [];
    aba8.push(['DESPESAS INDEDUTÍVEIS']);
    aba8.push(['Descrição', 'Artigo', 'Valor', 'Impacto Fiscal (34%)']);
    var diXls = r.despesasIndedutivelDetalhe;
    if (diXls && diXls.length > 0) {
      var totalIndXls = 0;
      var totalImpXls = 0;
      diXls.forEach(function (di) {
        var impXls = _r((di.valor || 0) * 0.34);
        totalIndXls += (di.valor || 0);
        totalImpXls += impXls;
        aba8.push([di.descricao || di.desc || '', di.artigo || '', mv(di.valor), mv(impXls)]);
      });
      aba8.push(['TOTAL', '', mv(totalIndXls), mv(totalImpXls)]);
    } else {
      aba8.push(['Nenhuma despesa indedutível identificada', '', '', '']);
    }
    addSheet('Indedutíveis', aba8, [40, 25, 18, 18]);


    // ═════════════════════════════════════════════════════
    //  ABA 9 — SUBCAPITALIZAÇÃO
    // ═════════════════════════════════════════════════════

    var aba9 = [];
    aba9.push(['ANÁLISE DE SUBCAPITALIZAÇÃO']);
    aba9.push([]);
    if (r.subcapResult) {
      aba9.push(['Limite Excedido?', r.subcapResult.excedeu ? 'SIM' : 'NÃO']);
      if (r.subcapResult.excedeu) {
        aba9.push(['Juros Indedutíveis', mv(r.subcapResult.jurosIndedutiveis || 0)]);
      }
      aba9.push([]);
      aba9.push(['LIMITES DE SUBCAPITALIZAÇÃO (Art. 249-251)']);
      aba9.push(['Tipo', 'Regra', 'Artigo']);
      if (LR.subcapitalizacao) {
        if (LR.subcapitalizacao.vinculadaComParticipacao) {
          aba9.push(['Vinculada c/ Participação', LR.subcapitalizacao.vinculadaComParticipacao.descricao || '', LR.subcapitalizacao.vinculadaComParticipacao.artigo || '']);
        }
        if (LR.subcapitalizacao.vinculadaSemParticipacao) {
          aba9.push(['Vinculada s/ Participação', LR.subcapitalizacao.vinculadaSemParticipacao.descricao || '', LR.subcapitalizacao.vinculadaSemParticipacao.artigo || '']);
        }
        if (LR.subcapitalizacao.paraisoFiscal) {
          aba9.push(['Paraíso Fiscal', LR.subcapitalizacao.paraisoFiscal.descricao || '', LR.subcapitalizacao.paraisoFiscal.artigo || '']);
        }
      }
    } else {
      aba9.push(['Dados de subcapitalização não informados']);
    }
    addSheet('Subcapitalização', aba9, [30, 50, 15]);


    // ═════════════════════════════════════════════════════
    //  ABA 10 — LALUR
    // ═════════════════════════════════════════════════════

    var aba10 = [];
    aba10.push(['LALUR — PARTE A E PARTE B']);
    aba10.push([]);
    aba10.push(['PARTE A — Adições e Exclusões Efetivas']);
    aba10.push(['Tipo', 'Descrição', 'Valor', 'Artigo']);
    if (lalur.adicoes && lalur.adicoes.length > 0) {
      lalur.adicoes.forEach(function (a) {
        aba10.push(['(+) Adição', a.desc || a.descricao || '', mv(a.valor), a.artigo || '']);
      });
      aba10.push(['Total Adições', '', mv(lalur.totalAdicoes), '']);
    }
    if (lalur.exclusoes && lalur.exclusoes.length > 0) {
      lalur.exclusoes.forEach(function (e) {
        aba10.push(['(-) Exclusão', e.desc || e.descricao || '', mv(e.valor), e.artigo || '']);
      });
      aba10.push(['Total Exclusões', '', mv(lalur.totalExclusoes), '']);
    }
    aba10.push([]);
    aba10.push(['PARTE B — Controles Futuros']);
    aba10.push(['Controle', 'Saldo Remanescente', 'Projeção']);
    var saldoPrejXls = 0;
    if (r.compensacao && r.compensacao.resumo && r.compensacao.resumo.saldosPosCompensacao) {
      saldoPrejXls = r.compensacao.resumo.saldosPosCompensacao.prejuizoOperacional || r.compensacao.resumo.saldosPosCompensacao.prejuizoFiscal || 0;
    }
    if (saldoPrejXls > 0) aba10.push(['Prejuízos Fiscais a Compensar', mv(saldoPrejXls), 'Compensável a 30% do lucro ajustado']);
    var saldoBNXls = 0;
    if (r.compensacao && r.compensacao.resumo && r.compensacao.resumo.saldosPosCompensacao) {
      saldoBNXls = r.compensacao.resumo.saldosPosCompensacao.baseNegativaCSLL || 0;
    }
    if (saldoBNXls > 0) aba10.push(['Base Negativa CSLL', mv(saldoBNXls), 'Compensável a 30% da base positiva']);
    var provNDXls = _n(d.provisoesContingencias) + _n(d.provisoesGarantias);
    if (provNDXls > 0) aba10.push(['Provisões Não Dedutíveis', mv(provNDXls), 'Exclusão na reversão/liquidação']);
    addSheet('LALUR', aba10, [15, 40, 18, 25]);


    // ═════════════════════════════════════════════════════
    //  ABA 11 — MAPA ECONOMIA
    // ═════════════════════════════════════════════════════

    var aba11 = [];
    aba11.push(['MAPA DE ECONOMIA — OPORTUNIDADES RANQUEADAS']);
    aba11.push(['#', 'Título', 'Tipo', 'Economia Anual', 'Complexidade', 'Risco', 'Base Legal', 'Descrição']);
    var opsRank = (r.oportunidades || []).slice().sort(function (a, b) { return (b.economiaAnual || 0) - (a.economiaAnual || 0); });
    opsRank.forEach(function (op, i) {
      aba11.push([
        op._isConsolidada ? '⊕' : (i + 1),
        (op._isConsolidada ? '[CONSOLIDAÇÃO] ' : '') + (op.titulo || ''),
        op.tipo || '',
        mv(op.economiaAnual),
        op.complexidade || '',
        op.risco || '',
        op.baseLegal || '',
        op.descricao || ''
      ]);
    });
    if (opsRank.length > 0) {
      var econTotalXls = 0;
      opsRank.forEach(function (op) { if (!op._isConsolidada) econTotalXls += (op.economiaAnual || 0); });
      aba11.push(['', 'TOTAL', '', mv(econTotalXls), '', '', '', '']);
    }
    addSheet('Mapa Economia', aba11, [5, 30, 12, 16, 12, 10, 25, 50]);


    // ═════════════════════════════════════════════════════
    //  ABA 12 — ALÍQUOTAS REFERÊNCIA (PARTE 5B)
    // ═════════════════════════════════════════════════════

    if (LR.aliquotas) {
      var aba12 = [];
      aba12.push(['ALÍQUOTAS APLICÁVEIS — REFERÊNCIA']);
      aba12.push(['Tributo', 'Alíquota (%)', 'Base Legal']);
      var aI = LR.aliquotas.irpj || {};
      var aC = LR.aliquotas.csll || {};
      var aP = LR.aliquotas.pisCofins || {};
      aba12.push(['IRPJ Normal', pv(aI.normal || 0.15), aI.artigoBase || 'Art. 225']);
      aba12.push(['IRPJ Adicional', pv(aI.adicional || 0.10), 'Excedente R$ 20.000/mês']);
      aba12.push(['CSLL Geral', pv(aC.geral || 0.09), aC.artigoBase || 'Lei 7.689']);
      aba12.push(['CSLL Financeiras', pv(aC.financeiras || 0.15), 'Lei 13.169/2015']);
      aba12.push(['PIS NC', pv(aP.pisNaoCumulativo || 0.0165), 'Lei 10.637/02']);
      aba12.push(['COFINS NC', pv(aP.cofinsNaoCumulativo || 0.076), 'Lei 10.833/03']);
      aba12.push(['JCP IRRF', 17.50, 'Art. 355-358 + LC 224/2025']);
      aba12.push(['Trava Compensação', 30.00, 'Art. 580-590']);
      addSheet('Alíquotas', aba12, [25, 15, 30]);
    }

    // ═════════════════════════════════════════════════════
    //  ABA 13 — HIPÓTESES OBRIGATORIEDADE (PARTE 5B)
    // ═════════════════════════════════════════════════════

    if (LR.obrigatoriedadeLucroReal && LR.obrigatoriedadeLucroReal.hipoteses) {
      var aba13 = [];
      aba13.push(['HIPÓTESES DE OBRIGATORIEDADE DO LUCRO REAL']);
      aba13.push(['Inciso', 'Hipótese', 'Aplicável?']);
      LR.obrigatoriedadeLucroReal.hipoteses.forEach(function (hip) {
        var aplXls = false;
        if (hip.id === 'RECEITA' && _n(d.receitaBrutaAnual) > (hip.valor || 78000000)) aplXls = true;
        else if (hip.id === 'FINANCEIRA' && (d.ehInstituicaoFinanceira === true || d.ehInstituicaoFinanceira === "true")) aplXls = true;
        else if (hip.id === 'LUCRO_EXTERIOR' && (d.temLucroExterior === true || d.temLucroExterior === "true")) aplXls = true;
        else if (hip.id === 'BENEFICIO_FISCAL' && (d.temBeneficioFiscalIsencao === true || d.temBeneficioFiscalIsencao === "true")) aplXls = true;
        else if (hip.id === 'FACTORING' && (d.ehFactoring === true || d.ehFactoring === "true")) aplXls = true;
        else if (hip.id === 'SECURITIZADORA' && (d.ehSecuritizadora === true || d.ehSecuritizadora === "true")) aplXls = true;
        aba13.push([hip.inciso || '', hip.descricao || '', aplXls ? 'SIM' : '—']);
      });
      addSheet('Obrigatoriedade', aba13, [10, 60, 12]);
    }

    // ═════════════════════════════════════════════════════
    //  ABA 14 — RELATÓRIO CONSOLIDADO (PARTE 5B)
    // ═════════════════════════════════════════════════════

    if (r.relatorioConsolidado) {
      var aba14 = [];
      aba14.push(['RELATÓRIO CONSOLIDADO']);
      aba14.push([]);
      if (r.relatorioConsolidado.resumo) {
        var rcRes = r.relatorioConsolidado.resumo;
        Object.keys(rcRes).forEach(function (k) {
          var val = rcRes[k];
          aba14.push([k, typeof val === 'number' ? mv(val) : String(val || '')]);
        });
      } else {
        aba14.push(['Dados consolidados disponíveis', 'Sim']);
      }
      addSheet('Consolidado', aba14, [35, 25]);
    }


    // ═════════════════════════════════════════════════════
    //  ABA 15 — ACRÉSCIMOS MORATÓRIOS E MULTAS (Bloco H)
    // ═════════════════════════════════════════════════════

    if (r.acrescimosMoratorios || r.multaOficio || LR.multasEMora) {
      var aba15 = [];
      aba15.push(['ACRÉSCIMOS MORATÓRIOS E MULTAS — Arts. 44, 47, 61, 63']);
      aba15.push([]);

      // Parâmetros legais
      if (LR.multasEMora) {
        var mmXls = LR.multasEMora;
        aba15.push(['PARÂMETROS LEGAIS']);
        aba15.push(['Parâmetro', 'Valor', 'Base Legal']);
        if (mmXls.multaMora) {
          aba15.push(['Multa de Mora (diária)', pv(mmXls.multaMora.taxaDiaria || 0.0033), mmXls.multaMora.artigo || 'Art. 61']);
          aba15.push(['Teto Multa de Mora', pv(mmXls.multaMora.teto || 0.20), 'Art. 61']);
        }
        if (mmXls.jurosMora) {
          aba15.push(['Juros de Mora', 'SELIC acum. + 1%/mês', mmXls.jurosMora.artigo || 'Art. 61, §3º']);
        }
        if (mmXls.multaOficio) {
          aba15.push(['Multa Ofício Padrão', pv(mmXls.multaOficio.padrao || 0.75), mmXls.multaOficio.artigo || 'Art. 44']);
          aba15.push(['Multa Ofício Fraude', pv(mmXls.multaOficio.fraude || 1.50), 'Art. 44, §1º']);
          if (mmXls.multaOficio.reducoes && mmXls.multaOficio.reducoes.pagamentoOuParcelamento30dias) {
            aba15.push(['Redução pgto 30 dias', '-' + pv(mmXls.multaOficio.reducoes.pagamentoOuParcelamento30dias || 0.50), 'Art. 44, §3º']);
          }
          if (mmXls.multaOficio.reducoes && mmXls.multaOficio.reducoes.conformidadeLei14689) {
            aba15.push(['Redução Lei 14.689/2023', 'Até -' + pv(mmXls.multaOficio.reducoes.conformidadeLei14689.comTransacao || 0.50), mmXls.multaOficio.reducoes.conformidadeLei14689.artigo || 'Lei 14.689/2023']);
          }
        }
        if (mmXls.prazoEspontaneo) {
          aba15.push(['Prazo Espontâneo', (mmXls.prazoEspontaneo.diasAposTermoFiscalizacao || 20) + ' dias', mmXls.prazoEspontaneo.artigo || 'Art. 47']);
        }
      }

      // Simulação calculada
      if (r.acrescimosMoratorios) {
        var amXls = r.acrescimosMoratorios;
        aba15.push([]);
        aba15.push(['SIMULAÇÃO — ACRÉSCIMOS MORATÓRIOS']);
        aba15.push(['Item', 'Valor']);
        aba15.push(['Valor Original', mv(amXls.valorOriginal || 0)]);
        aba15.push(['(+) Multa de Mora', mv(amXls.multaMora || 0)]);
        aba15.push(['(+) Juros SELIC', mv(amXls.jurosMora || 0)]);
        aba15.push(['(=) Total a Pagar', mv(amXls.valorTotal || 0)]);
        aba15.push(['Pagamento Espontâneo?', amXls.espontaneo ? 'Sim' : 'Não']);
      }

      // Multa de ofício
      if (r.multaOficio) {
        var moXls = r.multaOficio;
        aba15.push([]);
        aba15.push(['SIMULAÇÃO — MULTA DE OFÍCIO']);
        aba15.push(['Percentual Aplicado', pv(moXls.percentualAplicado || 0.75)]);
        aba15.push(['Multa Calculada', mv(moXls.multaOficio || moXls.valorFinal || 0)]);
        if (moXls.reducoes && moXls.reducoes.length > 0) {
          aba15.push(['Reduções', moXls.reducoes.join('; ')]);
        }
      }

      // Suspensão
      if (r.suspensaoMulta && r.suspensaoMulta.suspensa) {
        aba15.push([]);
        aba15.push(['SUSPENSÃO MULTA DE OFÍCIO', 'Sim — ' + (r.suspensaoMulta.motivo || 'Liminar/Tutela'), 'Art. 63']);
      }

      addSheet('Mora e Multas', aba15, [30, 25, 30]);
    }


    // ═════════════════════════════════════════════════════
    //  ABA 16 — COMPENSAÇÃO PER/DCOMP (Bloco I)
    // ═════════════════════════════════════════════════════

    if (r.compensacaoPERDCOMP || r.compensacaoJudicial || LR.compensacaoPERDCOMP) {
      var aba16 = [];
      aba16.push(['COMPENSAÇÃO PER/DCOMP — Arts. 73, 74, 74-A']);
      aba16.push([]);

      // Vedações — referência
      if (LR.compensacaoPERDCOMP && LR.compensacaoPERDCOMP.vedacoes) {
        aba16.push(['VEDAÇÕES À COMPENSAÇÃO (§3º do Art. 74)']);
        aba16.push(['Hipótese', 'Descrição', 'Artigo']);
        LR.compensacaoPERDCOMP.vedacoes.forEach(function (v) {
          aba16.push([v.id || '', v.descricao || '', v.artigo || '']);
        });
        aba16.push([]);
      }

      // Hipóteses "não declarada"
      if (LR.compensacaoPERDCOMP && LR.compensacaoPERDCOMP.hipotesesNaoDeclarada) {
        aba16.push(['HIPÓTESES DE "NÃO DECLARADA" (§12 do Art. 74)']);
        aba16.push(['Hipótese', 'Descrição', 'Artigo']);
        LR.compensacaoPERDCOMP.hipotesesNaoDeclarada.forEach(function (h) {
          aba16.push([h.id || '', h.descricao || '', h.artigo || '']);
        });
        aba16.push([]);
      }

      // Multa compensação indevida
      if (LR.compensacaoPERDCOMP && LR.compensacaoPERDCOMP.multaCompensacaoIndevida) {
        aba16.push(['Multa compensação indevida', pv(LR.compensacaoPERDCOMP.multaCompensacaoIndevida.percentual || 0.50), LR.compensacaoPERDCOMP.multaCompensacaoIndevida.artigo || '§17']);
      }

      // Análise calculada
      if (r.compensacaoPERDCOMP) {
        var pdcXls = r.compensacaoPERDCOMP;
        aba16.push([]);
        aba16.push(['ANÁLISE DA COMPENSAÇÃO']);
        aba16.push(['Compensação Permitida?', pdcXls.compensacaoPermitida ? 'SIM' : 'NÃO']);
        if (pdcXls.vedacoes && pdcXls.vedacoes.length > 0) {
          aba16.push(['Vedações Identificadas', pdcXls.vedacoes.join(', ')]);
        }
        if (pdcXls.hipotesesNaoDeclarada && pdcXls.hipotesesNaoDeclarada.length > 0) {
          aba16.push(['Risco "Não Declarada"', pdcXls.hipotesesNaoDeclarada.join(', ')]);
        }
        if (pdcXls.riscoMulta50 && pdcXls.riscoMulta50.aplicavel) {
          aba16.push(['Risco Multa 50%', mv(pdcXls.riscoMulta50.valor || 0)]);
        }
        if (pdcXls.impactoLucroReal) {
          if ((pdcXls.impactoLucroReal.reducaoIRPJ || 0) > 0) aba16.push(['Redução IRPJ', mv(pdcXls.impactoLucroReal.reducaoIRPJ)]);
          if ((pdcXls.impactoLucroReal.reducaoCSLL || 0) > 0) aba16.push(['Redução CSLL', mv(pdcXls.impactoLucroReal.reducaoCSLL)]);
        }
      }

      // Cronograma judicial
      if (r.compensacaoJudicial && r.compensacaoJudicial.sujeito) {
        var cjXls = r.compensacaoJudicial;
        aba16.push([]);
        aba16.push(['COMPENSAÇÃO JUDICIAL (Art. 74-A, Lei 14.873/2024)']);
        aba16.push(['Limite Mensal', mv(cjXls.limiteMensal || 0)]);
        aba16.push(['Prazo Total', (cjXls.prazoTotal || 60) + ' meses']);
        if (cjXls.cronograma && cjXls.cronograma.length > 0) {
          aba16.push([]);
          aba16.push(['Mês', 'Compensação', 'Saldo Remanescente']);
          cjXls.cronograma.forEach(function (p) {
            aba16.push([p.mes || p.parcela || '', mv(p.valor || p.compensacao || 0), mv(p.saldo || p.saldoRemanescente || 0)]);
          });
        }
      }

      addSheet('PER-DCOMP', aba16, [25, 40, 20]);
    }


    // ═════════════════════════════════════════════════════
    //  SALVAR ARQUIVO
    // ═════════════════════════════════════════════════════

    try {
      var filename = 'estudo-lucro-real-' + (d.razaoSocial || 'empresa').replace(/[^a-zA-Z0-9]/g, '-').substring(0, 40) + '-' + _dataCurta() + '.xlsx';
      XLSX.writeFile(wb, filename);
    } catch (err) {
      console.error('Erro Excel:', err);
      alert('Erro ao gerar Excel. Veja o console.');
    }

    hideLoading();
  }


  // ═══════════════════════════════════════════════════════════════════════════
  //  EXPORT PÚBLICO
  // ═══════════════════════════════════════════════════════════════════════════



  // ═══════════════════════════════════════════════════════════════════════════
  //  EXPORT PÚBLICO (Wizard + Motor + Exportação PDF/Excel)
  // ═══════════════════════════════════════════════════════════════════════════

  window.LucroRealEstudos = {
    VERSAO: VERSAO,
    init: init,
    nextStep: nextStep,
    prevStep: prevStep,
    goToStep: goToStep,
    analisar: analisar,
    voltarWizard: voltarWizard,
    saveField: saveField,
    saveMoney: saveMoney,
    onMunicipioChanged: onMunicipioChanged,
    preencherExemplo: preencherExemplo,
    novoEstudo: novoEstudo,
    getDados: function () { return dadosEmpresa; },
    getResultados: function () { return resultadosCache; },
    exportarJSON: exportarJSON,
    imprimir: imprimir,
    // ── Exportação PDF / Excel (integrado) ──
    pdfSimplificado: pdfSimplificado,
    pdfCompleto: pdfCompleto,
    exportarExcel: exportarExcel
  };

  // Aliases globais para compatibilidade com onclick nos botões do relatório
  window.IMPOSTExport = {
    pdfSimplificado: pdfSimplificado,
    pdfCompleto: pdfCompleto,
    exportarExcel: exportarExcel
  };
  window.pdfSimplificado = pdfSimplificado;
  window.pdfCompleto = pdfCompleto;
  window.exportarExcel = exportarExcel;

  document.addEventListener("DOMContentLoaded", init);
})();
  </script>

  <!-- Sincronizar versão do badge com o JS -->
  <script>
  (function() {
    'use strict';
    function syncVersion() {
      var badge = document.getElementById('versionBadge');
      if (!badge) return;
      if (typeof LucroRealEstudos !== 'undefined' && LucroRealEstudos.VERSAO) {
        badge.textContent = 'v' + LucroRealEstudos.VERSAO;
      }
    }
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', syncVersion);
    } else {
      setTimeout(syncVersion, 50);
    }
  })();
  </script>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       BARRA DE AÇÕES — Injeção via MutationObserver
       (Exportação PDF/Excel delegada ao lucro-real-estudos.js v2.1.0)
       ═══════════════════════════════════════════════════════════════════════════ -->
  <script>
  (function () {
    'use strict';

    // ═══════════════════════════════════════════════════════════════════════
    //  HELPERS
    //  NOTA v1.1: _m e _pp removidos — eram cópias de LR.helpers.formatarMoeda()
    //  e LR.helpers.formatarPercentual(), nunca utilizados neste inline.
    // ═══════════════════════════════════════════════════════════════════════

    // ═══════════════════════════════════════════════════════════════════════
    //  INJETAR BARRA DE AÇÕES QUANDO RESULTADOS APARECEM
    // ═══════════════════════════════════════════════════════════════════════

    // REMOVIDO v1.1: var originalRender = null; — código morto da refatoração v2.0

    function injectActionBar() {
      var resContainer = document.getElementById('resultadosContainer');
      if (!resContainer) return;

      // Observar quando resultados ficam visíveis
      var observer = new MutationObserver(function (mutations) {
        mutations.forEach(function (m) {
          if (m.attributeName === 'style') {
            var visible = resContainer.style.display !== 'none';
            var existingBar = document.getElementById('actionBar');
            if (visible && !existingBar) {
              createActionBar(resContainer);
            } else if (!visible && existingBar) {
              existingBar.remove();
            }
          }
        });
      });
      observer.observe(resContainer, { attributes: true, attributeFilter: ['style'] });

      // Observar childList para quando innerHTML é setado
      var childObserver = new MutationObserver(function () {
        if (resContainer.style.display !== 'none' && resContainer.children.length > 0) {
          if (!document.getElementById('actionBar')) {
            createActionBar(resContainer);
          }
        }
      });
      childObserver.observe(resContainer, { childList: true });
    }

    function createActionBar(container) {
      var bar = document.createElement('div');
      bar.id = 'actionBar';
      bar.className = 'action-bar';
      bar.innerHTML =
        '<span class="action-label">AÇÕES</span>' +
        '<button class="ab-btn" onclick="typeof LucroRealEstudos!==\'undefined\'&&LucroRealEstudos.voltarWizard()" title="Voltar ao formulário">← Editar Dados</button>' +
        '<button class="ab-btn ab-btn-primary" onclick="typeof LucroRealEstudos!==\'undefined\'&&LucroRealEstudos.pdfSimplificado()" title="PDF resumido para o empresário">📄 Relatório Simplificado</button>' +
        '<button class="ab-btn ab-btn-primary" onclick="typeof LucroRealEstudos!==\'undefined\'&&LucroRealEstudos.pdfCompleto()" title="PDF técnico completo para o contador">📋 Relatório Completo</button>' +
        '<button class="ab-btn ab-btn-success" onclick="typeof LucroRealEstudos!==\'undefined\'&&LucroRealEstudos.exportarExcel()" title="Planilha com 14 abas">📊 Exportar Excel</button>' +
        '<span class="ab-spacer"></span>' +
        '<button class="ab-btn" onclick="typeof LucroRealEstudos!==\'undefined\'&&LucroRealEstudos.exportarJSON()" title="Dados brutos em JSON">💾 JSON</button>' +
        '<button class="ab-btn" onclick="typeof LucroRealEstudos!==\'undefined\'&&LucroRealEstudos.novoEstudo()" title="Limpar e iniciar novo">🔄 Novo Estudo</button>';
      container.insertBefore(bar, container.firstChild);
    }

    // ═══════════════════════════════════════════════════════════════════════
    //  NOTA: Funções de exportação (pdfSimplificado, pdfCompleto,
    //  exportarExcel, pdfHeader, pdfFooter) removidas deste inline.
    //  São fornecidas pelo lucro-real-estudos.js v2.1.0 via
    //  window.LucroRealEstudos e window.IMPOSTExport.
    // ═══════════════════════════════════════════════════════════════════════

    // Iniciar observação quando DOM estiver pronto
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', injectActionBar);
    } else {
      injectActionBar();
    }
  })();
  </script>

  <!-- 9. Ponte HTML ↔ Mapeamento v3.4: Integração de estado dinâmico -->
  <script>
  (function() {
    'use strict';

    // ═══════════════════════════════════════════════════════════════════════
    //  PONTE: Seleção de estado → LR.setEstado()
    //
    //  O wizard (lucro-real-estudos.js) gera o <select> de estado dinamicamente.
    //  Este bloco observa quando o select é criado e conecta ao LR.setEstado().
    //  Assim, ISS, SUDAM, SUDENE e todos os dados estaduais ficam dinâmicos.
    // ═══════════════════════════════════════════════════════════════════════

    /**
     * IDs possíveis do select de estado no wizard.
     * O lucro-real-estudos.js pode usar qualquer um desses.
     * Adicione mais IDs aqui se o wizard mudar no futuro.
     */
    var ESTADO_SELECT_IDS = [
      'campo-estado',
      'estado',
      'select-estado',
      'empresa-estado',
      'uf'
    ];

    /**
     * Tenta encontrar o select de estado no DOM
     * @returns {HTMLSelectElement|null}
     */
    function encontrarSelectEstado() {
      for (var i = 0; i < ESTADO_SELECT_IDS.length; i++) {
        var el = document.getElementById(ESTADO_SELECT_IDS[i]);
        if (el && el.tagName === 'SELECT') return el;
      }
      // Fallback: procurar qualquer select com name contendo 'estado' ou 'uf'
      var selects = document.querySelectorAll('select[name*="estado"], select[name*="uf"], select[data-field="estado"]');
      return selects.length > 0 ? selects[0] : null;
    }

    /**
     * Conecta o select de estado ao LR.setEstado()
     * @param {HTMLSelectElement} selectEl
     */
    function conectarSelectEstado(selectEl) {
      if (selectEl._lrConectado) return; // Evitar duplicação

      selectEl.addEventListener('change', function() {
        var sigla = this.value;
        if (sigla && typeof LR !== 'undefined' && typeof LR.setEstado === 'function') {
          var ok = LR.setEstado(sigla);
          console.log('[HTML→LR] Estado definido:', sigla, ok ? '✓' : '✗ (estados.js ausente)');
        }
      });

      // Se já tem valor selecionado, carregar imediatamente
      if (selectEl.value && typeof LR !== 'undefined' && typeof LR.setEstado === 'function') {
        LR.setEstado(selectEl.value);
      }

      // v3.3 FIX BUG MÉDIO 1: Observar mudanças no select para capturar preenchimento via JS
      // Quando o wizard restaura dados do localStorage, select.value é definido via JS
      // sem disparar evento 'change'. Este observer detecta options sendo adicionadas
      // ou atributos mudando e sincroniza o estado.
      var selectObserver = new MutationObserver(function() {
        if (selectEl.value && typeof LR !== 'undefined' && typeof LR.setEstado === 'function') {
          var estadoAtual = (typeof LR._estadoAtual !== 'undefined') ? LR._estadoAtual : '';
          if (estadoAtual !== selectEl.value) {
            LR.setEstado(selectEl.value);
            console.log('[HTML→LR] Estado sincronizado via observer:', selectEl.value);
          }
        }
      });
      selectObserver.observe(selectEl, { childList: true, attributes: true, subtree: true });

      // Fallback: polling por 5 segundos para capturar preenchimento tardio via JS
      var _checkCount = 0;
      var _checkInterval = setInterval(function() {
        _checkCount++;
        if (selectEl.value && typeof LR !== 'undefined' && typeof LR.setEstado === 'function') {
          var estadoAtual = (typeof LR._estadoAtual !== 'undefined') ? LR._estadoAtual : '';
          if (estadoAtual !== selectEl.value) {
            LR.setEstado(selectEl.value);
            console.log('[HTML→LR] Estado sincronizado via polling:', selectEl.value);
          }
          clearInterval(_checkInterval);
        }
        if (_checkCount > 10) clearInterval(_checkInterval);
      }, 500);

      selectEl._lrConectado = true;
    }

    /**
     * Observer: fica escutando o DOM para quando o wizard criar o select
     */
    function iniciarObservacao() {
      // Tentar imediatamente (caso o select já exista)
      var sel = encontrarSelectEstado();
      if (sel) {
        conectarSelectEstado(sel);
        return;
      }

      // Observar o wizardContainer para quando o select for criado
      var wizardContainer = document.getElementById('wizardContainer');
      if (!wizardContainer) return;

      var observer = new MutationObserver(function() {
        var sel = encontrarSelectEstado();
        if (sel && !sel._lrConectado) {
          conectarSelectEstado(sel);
        }
        // v3.3 FIX BUG MÉDIO 1: Verificar se select já conectado teve valor definido via JS
        if (sel && sel._lrConectado && sel.value) {
          if (typeof LR !== 'undefined' && typeof LR.setEstado === 'function') {
            var estadoAtual = (typeof LR._estadoAtual !== 'undefined') ? LR._estadoAtual : '';
            if (estadoAtual !== sel.value) {
              LR.setEstado(sel.value);
            }
          }
        }
      });

      observer.observe(wizardContainer, { childList: true, subtree: true });
    }

    // Iniciar quando DOM estiver pronto
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', iniciarObservacao);
    } else {
      iniciarObservacao();
    }
  })();
  </script>

  <!-- v3.3 FIX E2#5 + E3#1: Banner de aviso quando motor fiscal não carregou -->
  <script>
  (function() {
    'use strict';
    function verificarDependencias() {
      var falhas = window._depFalha || [];
      var motorFalhou = window._motorFiscalFalhou || (typeof MotorLR === 'undefined');
      
      if (falhas.length > 0 || motorFalhou) {
        var banner = document.createElement('div');
        banner.id = 'fallbackBanner';
        banner.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:9999;padding:10px 20px;'
          + 'background:#FEF3CD;border-bottom:2px solid #F0AD4E;color:#856404;font-size:14px;'
          + 'font-family:DM Sans,sans-serif;display:flex;align-items:center;justify-content:space-between;';
        
        var msg = '⚠ Modo simplificado ativo';
        if (motorFalhou) {
          msg += ' — motor fiscal não carregado. Resultados podem divergir do cálculo fiscal completo.';
        }
        if (falhas.length > 0) {
          msg += ' Dependências ausentes: ' + falhas.join(', ') + '.';
        }
        
        banner.innerHTML = '<span>' + msg + '</span>'
          + '<button onclick="this.parentElement.remove()" style="background:none;border:1px solid #856404;'
          + 'border-radius:4px;padding:2px 8px;cursor:pointer;color:#856404;font-size:12px;">✕ Fechar</button>';
        
        document.body.insertBefore(banner, document.body.firstChild);
      }
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', verificarDependencias);
    } else {
      // Atraso mínimo para scripts async terminarem
      setTimeout(verificarDependencias, 100);
    }
  })();
  </script>
</body>
</html>
