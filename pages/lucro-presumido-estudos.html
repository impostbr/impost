<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Estudo Lucro Presumido | IMPOST.</title>
<meta name="description" content="Simulador tribut√°rio completo para Lucro Presumido: IRPJ, CSLL, PIS/COFINS, distribui√ß√£o de lucros, break-even, calend√°rio tribut√°rio e otimiza√ß√£o fiscal.">
<meta name="version" content="1.0">
<meta property="og:title" content="Estudo Lucro Presumido ‚Äî Simulador Tribut√°rio | IMPOST.">
<meta property="og:description" content="Simulador tribut√°rio completo para Lucro Presumido com c√°lculos detalhados, comparativos e recomenda√ß√µes de otimiza√ß√£o fiscal.">
<meta name="robots" content="index, follow">
<link rel="canonical" href="https://impost.com.br/pages/lucro-presumido-estudos.html">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><text y='28' font-size='28'>üìä</text></svg>" type="image/svg+xml">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
<style>
:root {
  --bg:#0f172a;--bg2:#1e293b;--bg-card:#1e293b;--bg-card-h:#334155;--surface:#334155;
  --border:#475569;--border-l:rgba(100,116,139,.2);
  --text:#f1f5f9;--text2:#94a3b8;--text3:#64748b;
  --accent:#f59e0b;--accent-h:#d97706;--accent-l:rgba(245,158,11,.12);
  --success:#10b981;--success-l:rgba(16,185,129,.12);--success-b:rgba(16,185,129,.25);
  --warn:#f59e0b;--warn-l:rgba(245,158,11,.12);--warn-b:rgba(245,158,11,.25);
  --danger:#ef4444;--danger-l:rgba(239,68,68,.12);--danger-b:rgba(239,68,68,.25);
  --info:#3b82f6;--info-l:rgba(59,130,246,.12);--info-b:rgba(59,130,246,.25);
  --simples:#8b5cf6;--presumido:#f59e0b;--real:#3b82f6;--sudam:#10b981;
  --r:8px;--rl:12px;--font:'Inter',sans-serif;--mono:'JetBrains Mono',monospace;
  --t:.2s ease;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{font-family:var(--font);background:var(--bg);color:var(--text);line-height:1.6;min-height:100vh;-webkit-font-smoothing:antialiased}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--surface);border-radius:3px}

/* LOADING */
#loadingOverlay{position:fixed;inset:0;z-index:9999;background:var(--bg);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px;transition:opacity .4s}
#loadingOverlay.hide{opacity:0;pointer-events:none}
.ld-spinner{width:44px;height:44px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.ld-text{color:var(--text3);font-size:14px}
.ld-brand{font-size:28px;font-weight:800;letter-spacing:-.5px;margin-bottom:8px}
.ld-brand span{color:var(--accent)}

/* TOPBAR */
.topbar{background:var(--bg2);border-bottom:1px solid var(--border-l);padding:0 28px;display:flex;align-items:center;justify-content:space-between;height:56px;position:sticky;top:0;z-index:100}
.tb-left{display:flex;align-items:center;gap:14px}
.tb-brand{font-size:20px;font-weight:800;letter-spacing:-.5px}
.tb-brand span{color:var(--accent)}
.tb-sep{width:1px;height:22px;background:var(--border)}
.tb-page{font-size:13px;color:var(--text3)}
.tb-right{display:flex;gap:8px}
.tb-btn{padding:7px 18px;border-radius:var(--r);font-size:12px;font-weight:600;font-family:var(--font);cursor:pointer;transition:var(--t);border:1px solid var(--border);background:transparent;color:var(--text2)}
.tb-btn:hover{border-color:var(--accent);color:var(--accent)}
.tb-btn-p{background:var(--accent);color:#000;border-color:var(--accent);font-weight:700}
.tb-btn-p:hover{background:var(--accent-h)}

/* LAYOUT */
.layout{display:flex;min-height:calc(100vh - 56px)}

/* SIDEBAR */
.sidebar{width:260px;background:var(--bg2);border-right:1px solid var(--border-l);padding:20px 16px;position:sticky;top:56px;height:calc(100vh - 56px);overflow-y:auto;flex-shrink:0}
.sb-title{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:12px;font-weight:600}
.sb-card{background:rgba(51,65,85,.6);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);border-radius:var(--r);padding:14px;margin-bottom:10px}
.sb-label{font-size:11px;color:var(--text3);margin-bottom:2px}
.sb-value{font-size:16px;font-weight:700;font-family:var(--mono);color:var(--text)}
.sb-value.accent{color:var(--accent)}
.sb-value.success{color:var(--success)}
.sb-regime{display:inline-block;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:700;margin-top:4px}
.sb-divider{height:1px;background:var(--border-l);margin:12px 0}

/* MAIN */
.main-area{flex:1;padding:24px 32px 80px;max-width:960px;margin:0 auto;width:100%}

/* STEPPER */
.stepper{display:flex;align-items:center;margin-bottom:28px;overflow-x:auto;padding-bottom:4px}
.st-item{display:flex;flex-direction:column;align-items:center;min-width:72px;flex-shrink:0;cursor:pointer;background:none;border:none;padding:0;font:inherit;color:inherit;outline:none}
.st-num{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;background:var(--surface);border:2px solid var(--border);color:var(--text3);transition:var(--t)}
.st-item.active .st-num{background:var(--accent);border-color:var(--accent);color:#000;box-shadow:0 2px 12px rgba(245,158,11,.35)}
.st-item.done .st-num{background:var(--success);border-color:var(--success);color:#fff}
.st-label{font-size:10px;color:var(--text3);margin-top:5px;text-align:center;white-space:nowrap;font-weight:500}
.st-item.active .st-label{color:var(--accent);font-weight:600}
.st-item.done .st-label{color:var(--success)}
.st-item.locked{opacity:.4;cursor:not-allowed}
.st-line{flex:1;height:2px;background:var(--border);min-width:16px;margin:0 2px;margin-bottom:18px}
.st-line.done{background:var(--success)}

/* WIZARD PANEL */
.wz-panel{display:none;animation:fadeUp .3s ease-out}
.wz-panel.active{display:block}
@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.wz-card{background:rgba(30,41,59,.75);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid rgba(100,116,139,.15);border-radius:var(--rl);padding:28px 32px;margin-bottom:20px}
.wz-header{display:flex;align-items:center;gap:14px;margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid var(--border-l)}
.wz-icon{font-size:28px}
.wz-title{font-size:18px;font-weight:700}
.wz-sub{font-size:13px;color:var(--text3);margin-top:2px}

/* FORMS */
.fm-grid{display:grid;gap:16px}.fm-2{grid-template-columns:1fr 1fr}.fm-3{grid-template-columns:1fr 1fr 1fr}
@media(max-width:700px){.fm-2,.fm-3{grid-template-columns:1fr}}
.fm-group{display:flex;flex-direction:column;gap:4px}
.fm-group label{font-size:12px;font-weight:600;color:var(--text2);display:flex;align-items:center;gap:6px}
.fm-tip{font-size:11px;color:var(--text3);line-height:1.4}
.fm-input{padding:9px 13px;background:var(--surface);border:1px solid var(--border-l);border-radius:var(--r);color:var(--text);font-size:14px;font-family:var(--font);transition:var(--t);outline:none;width:100%}
.fm-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-l)}
.fm-input::placeholder{color:var(--text3)}
select.fm-input{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2394a3b8' d='M6 8L1 3h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:32px}
.fm-prefix{display:flex;align-items:center;background:var(--surface);border:1px solid var(--border-l);border-radius:var(--r);overflow:hidden;transition:var(--t)}
.fm-prefix:focus-within{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-l)}
.fm-prefix span{padding:0 11px;font-size:12px;font-weight:600;color:var(--text3);background:var(--bg2);min-height:38px;display:flex;align-items:center;border-right:1px solid var(--border-l)}
.fm-prefix .fm-input{border:none;background:transparent;box-shadow:none!important}
.fm-error{font-size:11px;color:var(--danger)}

/* TOGGLE */
.toggle-wrap{display:flex;background:var(--surface);border-radius:var(--r);padding:3px;gap:2px;margin-bottom:16px}
.toggle-btn{flex:1;padding:8px 16px;border:none;border-radius:6px;font-size:13px;font-weight:600;font-family:var(--font);cursor:pointer;transition:var(--t);background:transparent;color:var(--text3)}
.toggle-btn.active{background:var(--accent);color:#000}

/* CHECKBOX CARD */
.chk-card{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--surface);border:1px solid var(--border-l);border-radius:var(--r);cursor:pointer;transition:var(--t);font-size:13px;color:var(--text2)}
.chk-card:hover{border-color:var(--accent)}
.chk-card input{display:none}
.chk-mark{width:18px;height:18px;flex-shrink:0;border:2px solid var(--border);border-radius:4px;display:flex;align-items:center;justify-content:center;transition:var(--t);font-size:10px}
.chk-card input:checked+.chk-mark{background:var(--danger);border-color:var(--danger);color:#fff}
.chk-card input:checked+.chk-mark::after{content:'\2713'}

/* INFO BOX */
.info-box{padding:12px 16px;border-radius:var(--r);font-size:12px;line-height:1.6;margin-top:8px}
.info-box.success{background:var(--success-l);border:1px solid var(--success-b);color:var(--success)}
.info-box.danger{background:var(--danger-l);border:1px solid var(--danger-b);color:var(--danger)}
.info-box.warn{background:var(--warn-l);border:1px solid var(--warn-b);color:var(--warn)}
.info-box.info{background:var(--info-l);border:1px solid var(--info-b);color:var(--info)}

/* BADGE */
.badge{display:inline-block;padding:2px 10px;border-radius:12px;font-size:11px;font-weight:600}
.badge-success{background:var(--success-l);color:var(--success)}
.badge-danger{background:var(--danger-l);color:var(--danger)}
.badge-warn{background:var(--warn-l);color:var(--warn)}
.badge-info{background:var(--info-l);color:var(--info)}

/* SEARCH RESULTS */
.search-results{max-height:220px;overflow-y:auto;background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);margin-top:4px;display:none}
.search-results.open{display:block}
.sr-item{padding:10px 14px;cursor:pointer;border-bottom:1px solid var(--border-l);transition:var(--t);font-size:13px}
.sr-item:hover{background:var(--accent-l)}
.sr-item .sr-code{font-family:var(--mono);color:var(--accent);font-size:12px;font-weight:700}
.sr-item .sr-desc{color:var(--text2);margin-left:8px}
.sr-item .sr-cat{font-size:11px;color:var(--text3);display:block;margin-top:2px}

/* DYNAMIC TABLE */
.dyn-table{width:100%;border-collapse:collapse;font-size:13px}
.dyn-table th{text-align:left;padding:10px 12px;background:var(--bg);color:var(--text3);font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border)}
.dyn-table td{padding:9px 12px;border-bottom:1px solid var(--border-l)}
.dyn-table tr:hover td{background:var(--bg-card-h)}
.dyn-table .mono{font-family:var(--mono);font-size:12px}
.dyn-table .right{text-align:right}
.dyn-table .btn-rm{background:none;border:none;color:var(--danger);cursor:pointer;font-size:16px;padding:2px 6px}
.btn-add-row{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;background:var(--accent-l);border:1px dashed var(--accent);border-radius:var(--r);color:var(--accent);font-size:12px;font-weight:600;cursor:pointer;transition:var(--t);margin-top:8px;font-family:var(--font)}
.btn-add-row:hover{background:var(--accent);color:#000}

/* RESULT TABS */
.res-tabs{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:20px;padding:4px;background:var(--bg);border-radius:var(--r)}
.res-tab{padding:7px 14px;border:none;border-radius:6px;font-size:11px;font-weight:600;font-family:var(--font);cursor:pointer;transition:var(--t);background:transparent;color:var(--text3);white-space:nowrap}
.res-tab.active{background:var(--accent);color:#000}
.res-tab:hover:not(.active){background:var(--surface)}
.tab-panel{display:none}.tab-panel.active{display:block}

/* KPI CARDS */
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:20px}
.kpi{background:rgba(51,65,85,.5);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);border:1px solid rgba(100,116,139,.1);border-radius:var(--r);padding:16px;text-align:center}
.kpi-label{font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.kpi-value{font-size:22px;font-weight:800;font-family:var(--mono)}
.kpi-sub{font-size:11px;color:var(--text3);margin-top:2px}

/* REGIME COMPARISON CARDS */
.regime-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin-bottom:20px}
.regime-card{border-radius:var(--rl);padding:20px;border:2px solid var(--border-l);position:relative;transition:var(--t)}
.regime-card.best{border-color:var(--success);box-shadow:0 0 20px rgba(16,185,129,.15)}
.regime-card .rc-badge{position:absolute;top:-10px;right:12px;padding:2px 12px;border-radius:12px;font-size:11px;font-weight:700}
.rc-name{font-size:14px;font-weight:700;margin-bottom:12px}
.rc-total{font-size:24px;font-weight:800;font-family:var(--mono);margin-bottom:4px}
.rc-pct{font-size:12px;color:var(--text3);margin-bottom:12px}
.rc-detail{font-size:12px;color:var(--text2);line-height:1.8}
.rc-detail span{font-family:var(--mono);float:right}
.rc-economy{margin-top:12px;padding:8px;background:var(--success-l);border-radius:6px;text-align:center;font-size:12px;font-weight:700;color:var(--success)}

/* RISK CARDS */
.risk-grid{display:flex;flex-direction:column;gap:10px}
.risk-card{padding:16px;border-radius:var(--r);border-left:4px solid}
.risk-card.critica{background:var(--danger-l);border-color:var(--danger)}
.risk-card.alta{background:var(--warn-l);border-color:var(--warn)}
.risk-card.media{background:var(--info-l);border-color:var(--info)}
.risk-title{font-size:14px;font-weight:700;margin-bottom:4px}
.risk-desc{font-size:12px;color:var(--text2);margin-bottom:6px}
.risk-prev{font-size:11px;color:var(--text3);font-style:italic}

/* ADVANTAGE/DISADVANTAGE CARDS */
.adv-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media(max-width:700px){.adv-grid{grid-template-columns:1fr}}
.adv-card{padding:16px;border-radius:var(--r);border:1px solid}
.adv-card.pro{background:var(--success-l);border-color:var(--success-b)}
.adv-card.con{background:var(--danger-l);border-color:var(--danger-b)}
.adv-title{font-size:13px;font-weight:700;margin-bottom:4px}
.adv-desc{font-size:12px;color:var(--text2)}
.adv-impact{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-top:6px}

/* OBLIGATION TIMELINE */
.obl-list{display:flex;flex-direction:column;gap:10px}
.obl-item{display:flex;gap:14px;padding:14px;background:var(--surface);border-radius:var(--r);align-items:flex-start}
.obl-period{min-width:80px;font-size:11px;font-weight:700;color:var(--accent);text-transform:uppercase}
.obl-name{font-size:13px;font-weight:600;color:var(--text)}
.obl-detail{font-size:11px;color:var(--text3);margin-top:2px}

/* CHART */
.chart-wrap{background:rgba(51,65,85,.5);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);border:1px solid rgba(100,116,139,.1);border-radius:var(--r);padding:16px;margin-bottom:16px;position:relative}
.chart-wrap canvas{max-height:320px}
.chart-title{font-size:13px;font-weight:700;color:var(--text2);margin-bottom:10px}

/* TRANSITION */
.trans-card{background:var(--surface);border-radius:var(--r);padding:20px;margin-bottom:14px}
.trans-title{font-size:15px;font-weight:700;margin-bottom:10px;color:var(--accent)}
.trans-steps{list-style:decimal;padding-left:20px;font-size:13px;color:var(--text2);line-height:2}
.trans-alert{display:flex;align-items:flex-start;gap:8px;padding:8px 12px;background:var(--warn-l);border-radius:6px;font-size:12px;color:var(--warn);margin-top:8px}

/* TIPS */
.tip-card{padding:14px 18px;background:var(--surface);border-radius:var(--r);margin-bottom:10px;border-left:3px solid var(--accent)}
.tip-title{font-size:13px;font-weight:700;color:var(--accent);margin-bottom:4px}
.tip-desc{font-size:12px;color:var(--text2);line-height:1.6}

/* SOCIOS TABLE */
.soc-row{display:grid;grid-template-columns:1fr 100px 40px;gap:8px;margin-bottom:6px;align-items:center}

/* EXPORT SECTION */
.export-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px}
button.export-card{font-family:var(--font);font-size:inherit;color:var(--text)}
.export-card{background:rgba(51,65,85,.5);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);border-radius:var(--rl);padding:24px;text-align:center;cursor:pointer;transition:all .25s ease;border:1px solid rgba(100,116,139,.15)}
.export-card.pro{border-color:rgba(245,158,11,.3);background:rgba(245,158,11,.08)}
.export-card.pro:hover{border-color:var(--accent);box-shadow:0 8px 32px rgba(245,158,11,.2)}
.export-card:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.3)}
.export-icon{font-size:32px;margin-bottom:8px}
.export-icon i{font-size:28px}
.export-label{font-size:14px;font-weight:700}
.export-desc{font-size:11px;color:var(--text3);margin-top:4px}
.export-badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;background:var(--accent);color:#000;margin-left:6px;vertical-align:middle}
.export-opts{margin-top:20px;padding:20px;background:rgba(51,65,85,.4);border-radius:var(--r);border:1px solid var(--border-l)}
.export-opts-title{font-size:13px;font-weight:700;color:var(--accent);margin-bottom:12px;display:flex;align-items:center;gap:8px}
.export-opts-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
@media(max-width:600px){.export-opts-grid{grid-template-columns:1fr}}
.export-opt{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text2);cursor:pointer}
.export-opt input[type=checkbox]{accent-color:var(--accent);width:16px;height:16px}

/* NAV FOOTER */
.wz-nav{display:flex;justify-content:space-between;margin-top:24px;padding-top:20px;border-top:1px solid var(--border-l)}
.wz-btn{padding:10px 26px;border:none;border-radius:var(--r);font-size:13px;font-weight:600;font-family:var(--font);cursor:pointer;transition:var(--t)}
.wz-btn:disabled{opacity:.4;cursor:not-allowed}
.wz-btn-back{background:var(--surface);color:var(--text2);border:1px solid var(--border)}
.wz-btn-back:hover:not(:disabled){color:var(--text);border-color:var(--text3)}
.wz-btn-next{background:var(--accent);color:#000;font-weight:700}
.wz-btn-next:hover:not(:disabled){background:var(--accent-h);box-shadow:0 2px 12px rgba(245,158,11,.3)}
.wz-btn-calc{background:var(--success);color:#fff;font-size:14px;padding:12px 32px}
.wz-btn-calc:hover{background:#059669;box-shadow:0 4px 20px rgba(16,185,129,.3)}

/* TOOLTIP */
.tt{position:relative;cursor:help;display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;background:var(--border-l);border-radius:50%;font-size:10px;font-weight:700;color:var(--text3)}
.tt:hover::after{content:attr(data-tip);position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:8px 12px;font-size:11px;font-weight:400;color:var(--text2);white-space:normal;width:260px;max-width:80vw;z-index:50;box-shadow:0 4px 12px rgba(0,0,0,.4);line-height:1.5;pointer-events:none}

/* PRINT */
@media print{
  body{background:#fff;color:#000}
  .topbar,.sidebar,.stepper,.wz-nav,.tb-right,.toggle-wrap,.btn-add-row,.btn-rm,.export-grid,.res-tabs{display:none!important}
  #step1,#step2,#step3,#step4{display:none!important}
  .layout{display:block}.main-area{max-width:100%;padding:0}
  #step5,#step6{display:block!important}
  #step5 .wz-card{box-shadow:none;border:none;padding:0}
  .tab-panel{display:block!important;break-inside:avoid;margin-bottom:20px;page-break-inside:avoid}
  .wz-card,.kpi,.regime-card,.risk-card,.adv-card,.chart-wrap,.tip-card{background:#fff;border:1px solid #ddd;color:#000;break-inside:avoid}
  .kpi-value,.rc-total{color:#000}
  .fm-input,.fm-prefix{background:#f5f5f5;border:1px solid #ccc;color:#000}
  .tab-panel .chart-wrap canvas{max-height:240px}
}

/* RESPONSIVE */
@media(max-width:900px){
  .sidebar{display:none}
  .main-area{padding:16px}
  .wz-card{padding:20px 16px}
  .regime-grid{grid-template-columns:1fr}
  .kpi-grid{grid-template-columns:repeat(2,1fr)}
}
@media(max-width:500px){
  .topbar{padding:0 12px}
  .kpi-grid{grid-template-columns:1fr}
  .stepper{gap:0}
}

/* SECTION TITLE */
.sec-title{font-size:15px;font-weight:700;color:var(--accent);margin:20px 0 12px;padding-top:16px;border-top:1px solid var(--border-l)}
.sec-title:first-child{border-top:none;padding-top:0;margin-top:0}

/* DESPESAS GRID */
.desp-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:600px){.desp-grid{grid-template-columns:1fr}}

/* CHARTS RESPONSIVE */
.chart-grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
@media(max-width:700px){.chart-grid-2{grid-template-columns:1fr}}
</style>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "IMPOST. ‚Äî Estudo Lucro Presumido",
  "description": "Simulador tribut√°rio completo para Lucro Presumido com c√°lculos detalhados, comparativos e recomenda√ß√µes.",
  "applicationCategory": "FinanceApplication",
  "operatingSystem": "Web",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "BRL"
  }
}
</script>
</head>
<body>

<!-- LOADING -->
<div id="loadingOverlay">
  <div class="ld-brand">IMPOST<span>.</span></div>
  <div class="ld-spinner"></div>
  <div class="ld-text">Carregando motores de c√°lculo...</div>
</div>

<!-- TOPBAR -->
<header class="topbar">
  <div class="tb-left">
    <div class="tb-brand">IMPOST<span>.</span></div>
    <div class="tb-sep"></div>
    <div class="tb-page">Estudo Lucro Presumido</div>
  </div>
  <div class="tb-right">
    <button class="tb-btn" onclick="carregarEstudo()"><i class="fa-solid fa-folder-open"></i> Carregar Estudo</button>
    <button class="tb-btn tb-btn-p" onclick="salvarEstudo()"><i class="fa-solid fa-floppy-disk"></i> Salvar</button>
  </div>
</header>

<!-- LAYOUT -->
<div class="layout">

<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
  <div class="sb-title">Resumo do Estudo</div>
  <div class="sb-card">
    <div class="sb-label">Empresa</div>
    <div class="sb-value" id="sbEmpresa" style="font-size:13px;font-family:var(--font)">--</div>
  </div>
  <div class="sb-card">
    <div class="sb-label">CNAE Principal</div>
    <div class="sb-value" id="sbCnae" style="font-size:12px">--</div>
  </div>
  <div class="sb-card">
    <div class="sb-label">Receita Bruta Anual</div>
    <div class="sb-value accent" id="sbReceita">R$ 0,00</div>
  </div>
  <div class="sb-divider"></div>
  <div class="sb-card">
    <div class="sb-label">Regime Recomendado</div>
    <div class="sb-value success" id="sbRegime" style="font-size:13px">--</div>
  </div>
  <div class="sb-card">
    <div class="sb-label">Carga Tribut√°ria Total</div>
    <div class="sb-value" id="sbCarga">--</div>
    <div class="sb-label" id="sbCargaPct" style="margin-top:4px">--</div>
  </div>
  <div class="sb-card">
    <div class="sb-label">Economia Potencial</div>
    <div class="sb-value success" id="sbEconomia">--</div>
  </div>
  <div class="sb-divider"></div>
  <div class="sb-card">
    <div class="sb-label">Elegibilidade</div>
    <div id="sbElegibilidade"><span class="badge badge-info">Pendente</span></div>
  </div>
</aside>

<!-- MAIN -->
<div class="main-area">

<!-- STEPPER -->
<div class="stepper" id="stepper">
  <button type="button" class="st-item active" data-step="1" onclick="goToStep(1)" aria-label="Etapa 1: Empresa"><div class="st-num">1</div><div class="st-label">Empresa</div></button>
  <div class="st-line"></div>
  <button type="button" class="st-item" data-step="2" onclick="goToStep(2)" aria-label="Etapa 2: Elegibilidade"><div class="st-num">2</div><div class="st-label">Elegibilidade</div></button>
  <div class="st-line"></div>
  <button type="button" class="st-item" data-step="3" onclick="goToStep(3)" aria-label="Etapa 3: Financeiro"><div class="st-num">3</div><div class="st-label">Financeiro</div></button>
  <div class="st-line"></div>
  <button type="button" class="st-item" data-step="4" onclick="goToStep(4)" aria-label="Etapa 4: Complementar"><div class="st-num">4</div><div class="st-label">Complementar</div></button>
  <div class="st-line"></div>
  <button type="button" class="st-item" data-step="5" onclick="goToStep(5)" aria-label="Etapa 5: Resultados"><div class="st-num">5</div><div class="st-label">Resultados</div></button>
  <div class="st-line"></div>
  <button type="button" class="st-item locked" data-step="6" onclick="goToStep(6)" aria-label="Etapa 6: Exportar"><div class="st-num">6</div><div class="st-label">Exportar</div></button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- STEP 1: IDENTIFICACAO DA EMPRESA -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<section class="wz-panel active" id="step1">
<div class="wz-card">
  <div class="wz-header">
    <div class="wz-icon"><i class="fa-solid fa-building"></i></div>
    <div><div class="wz-title">Identifica√ß√£o da Empresa</div><div class="wz-sub">Dados cadastrais e localiza√ß√£o</div></div>
  </div>

  <div class="fm-grid fm-2">
    <div class="fm-group">
      <label for="razaoSocial">Raz√£o Social</label>
      <input class="fm-input" id="razaoSocial" placeholder="Nome da empresa">
    </div>
    <div class="fm-group">
      <label for="cnpj">CNPJ</label>
      <input class="fm-input" id="cnpj" placeholder="XX.XXX.XXX/XXXX-XX" maxlength="18">
    </div>
  </div>

  <div class="sec-title">CNAE Principal</div>
  <div class="fm-group">
    <label for="cnaeBusca">Buscar CNAE <span class="tt" data-tip="Digite o c√≥digo CNAE ou uma descri√ß√£o da atividade. Ex: 7119, consultoria, restaurante">?</span></label>
    <input class="fm-input" id="cnaeBusca" placeholder="Digite o c√≥digo ou descri√ß√£o da atividade..." autocomplete="off">
    <div class="search-results" id="cnaeResults"></div>
    <div id="cnaeInfo" style="display:none"></div>
  </div>
  <input type="hidden" id="cnaePrincipal" value="">
  <input type="hidden" id="atividadeId" value="">

  <div class="sec-title">CNAEs Secund√°rios</div>
  <div id="cnaesSecContainer">
    <div class="fm-tip" style="margin-bottom:8px">Adicione CNAEs secund√°rios se a empresa possui atividades mistas com percentuais de presun√ß√£o diferentes.</div>
  </div>
  <button class="btn-add-row" onclick="addCnaeSecundario()">+ Adicionar CNAE Secund√°rio</button>

  <div class="sec-title">Localiza√ß√£o</div>
  <div class="fm-grid fm-2">
    <div class="fm-group">
      <label for="estado">Estado (UF) <span class="tt" data-tip="Selecione o estado para carregar dados tribut√°rios (ICMS, incentivos fiscais, sublimite Simples)">?</span></label>
      <select class="fm-input" id="estado"><option value="">Selecione o estado...</option></select>
      <div id="estadoInfo"></div>
    </div>
    <div class="fm-group">
      <label for="municipio">Munic√≠pio</label>
      <select class="fm-input" id="municipio" disabled><option value="">Selecione o estado primeiro...</option></select>
      <div id="municipioInfo"></div>
    </div>
  </div>
  <div class="fm-grid fm-2" style="margin-top:12px">
    <div class="fm-group">
      <label for="aliquotaISS">Al√≠quota ISS (%) <span class="tt" data-tip="M√≠nimo 2%, m√°ximo 5% (LC 116/2003). Ajust√°vel manualmente.">?</span></label>
      <div class="fm-prefix"><span>%</span><input class="fm-input" id="aliquotaISS" type="number" min="2" max="5" step="0.1" value="5"></div>
    </div>
  </div>

  <div class="sec-title">Dados Complementares</div>
  <div class="fm-grid fm-2">
    <div class="fm-group">
      <label for="dataConstituicao">Data de Constitui√ß√£o</label>
      <input class="fm-input" id="dataConstituicao" type="date">
    </div>
    <div class="fm-group">
      <label for="porte">Porte da Empresa <span class="tt" data-tip="ME: Receita at√© R$ 360.000/ano. EPP: at√© R$ 4.800.000/ano. Demais: acima.">?</span></label>
      <select class="fm-input" id="porte">
        <option value="ME">ME - Microempresa</option>
        <option value="EPP">EPP - Empresa de Pequeno Porte</option>
        <option value="DEMAIS" selected>Demais</option>
      </select>
    </div>
  </div>
</div>
</section>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- STEP 2: ELEGIBILIDADE -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<section class="wz-panel" id="step2">
<div class="wz-card">
  <div class="wz-header">
    <div class="wz-icon"><i class="fa-solid fa-clipboard-check"></i></div>
    <div><div class="wz-title">Verifica√ß√£o de Elegibilidade</div><div class="wz-sub">Verifica√ß√£o autom√°tica dos requisitos para Lucro Presumido</div></div>
  </div>

  <div class="fm-grid fm-2">
    <div class="fm-group">
      <label for="receitaAnterior">Receita bruta do ano anterior <span class="tt" data-tip="Receita bruta total no ano-calend√°rio anterior. Limite: R$ 78.000.000,00 (Lei 9.718/1998, Art. 13)">?</span></label>
      <div class="fm-prefix"><span>R$</span><input class="fm-input money" id="receitaAnterior" placeholder="0,00"></div>
    </div>
    <div class="fm-group">
      <label for="mesesAtividade">Meses de atividade no ano anterior</label>
      <select class="fm-input" id="mesesAtividade">
        <option value="12" selected>12 meses (ano completo)</option>
        <option value="11">11 meses</option><option value="10">10 meses</option>
        <option value="9">9 meses</option><option value="8">8 meses</option>
        <option value="7">7 meses</option><option value="6">6 meses</option>
        <option value="5">5 meses</option><option value="4">4 meses</option>
        <option value="3">3 meses</option><option value="2">2 meses</option>
        <option value="1">1 m√™s (empresa nova)</option>
      </select>
    </div>
  </div>

  <div class="sec-title">Impedimentos Legais (RIR/2018, Art. 257)</div>
  <div class="fm-tip" style="margin-bottom:10px">Marque SIM apenas se a situa√ß√£o se aplica √† empresa. Qualquer marca√ß√£o pode impedir o Lucro Presumido.</div>
  <div class="fm-grid" style="gap:8px">
    <label class="chk-card"><input type="checkbox" id="impInstFinanceira"><span class="chk-mark"></span> √â institui√ß√£o financeira? (bancos, corretoras)</label>
    <label class="chk-card"><input type="checkbox" id="impFactoring"><span class="chk-mark"></span> √â empresa de factoring?</label>
    <label class="chk-card"><input type="checkbox" id="impExterior"><span class="chk-mark"></span> Tem rendimentos/lucros do exterior?</label>
    <label class="chk-card"><input type="checkbox" id="impIsencao"><span class="chk-mark"></span> Tem isen√ß√£o/redu√ß√£o de IR sobre lucro da explora√ß√£o?</label>
    <label class="chk-card"><input type="checkbox" id="impSCP"><span class="chk-mark"></span> √â Sociedade em Conta de Participa√ß√£o (SCP)?</label>
  </div>

  <div id="elegibilidadeResult" style="margin-top:20px"></div>
</div>
</section>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- STEP 3: DADOS FINANCEIROS -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<section class="wz-panel" id="step3">
<div class="wz-card">
  <div class="wz-header">
    <div class="wz-icon"><i class="fa-solid fa-chart-line"></i></div>
    <div><div class="wz-title">Dados Financeiros Detalhados</div><div class="wz-sub">Receitas, dedu√ß√µes e reten√ß√µes para c√°lculo preciso</div></div>
  </div>

  <div class="toggle-wrap">
    <button class="toggle-btn active" onclick="setModoFinanceiro('simplificado')">Modo Simplificado</button>
    <button class="toggle-btn" onclick="setModoFinanceiro('detalhado')">Modo Detalhado (Trimestral)</button>
  </div>

  <!-- MODO SIMPLIFICADO -->
  <div id="modoSimplificado">
    <div class="sec-title">Receita Bruta Anual por Atividade</div>
    <div class="fm-tip" style="margin-bottom:10px">Informe a receita anual estimada para cada atividade. O percentual de presun√ß√£o ser√° aplicado automaticamente.</div>
    <table class="dyn-table" id="tblReceitasSimp">
      <thead><tr><th>Atividade</th><th>% IRPJ</th><th>% CSLL</th><th style="width:180px">Receita Anual (R$)</th><th></th></tr></thead>
      <tbody id="tbodyReceitasSimp"></tbody>
    </table>
    <button class="btn-add-row" onclick="addLinhaReceita()">+ Adicionar Atividade</button>

    <div class="sec-title">Dedu√ß√µes da Receita Bruta</div>
    <div class="fm-grid fm-3">
      <div class="fm-group"><label for="devolucoes">Devolu√ß√µes de vendas</label><div class="fm-prefix"><span>R$</span><input class="fm-input money" id="devolucoes" placeholder="0,00"></div></div>
      <div class="fm-group"><label for="cancelamentos">Vendas canceladas</label><div class="fm-prefix"><span>R$</span><input class="fm-input money" id="cancelamentos" placeholder="0,00"></div></div>
      <div class="fm-group"><label for="descontos">Descontos incondicionais</label><div class="fm-prefix"><span>R$</span><input class="fm-input money" id="descontos" placeholder="0,00"></div></div>
    </div>

    <div class="sec-title">Adi√ß√µes Obrigat√≥rias √† Base (Art. 595 RIR/2018) <span class="tt" data-tip="Estas receitas s√£o adicionadas INTEGRALMENTE √† base de c√°lculo (100%), n√£o passam pela presun√ß√£o.">?</span></div>
    <div class="fm-grid fm-2">
      <div class="fm-group"><label for="ganhosCapital">Ganhos de capital</label><div class="fm-prefix"><span>R$</span><input class="fm-input money" id="ganhosCapital" placeholder="0,00"></div></div>
      <div class="fm-group"><label for="rendFinanceiros">Rendimentos financeiros</label><div class="fm-prefix"><span>R$</span><input class="fm-input money" id="rendFinanceiros" placeholder="0,00"></div></div>
      <div class="fm-group"><label for="jcpRecebido">JCP recebido</label><div class="fm-prefix"><span>R$</span><input class="fm-input money" id="jcpRecebido" placeholder="0,00"></div></div>
      <div class="fm-group"><label for="multasContratuais">Multas contratuais recebidas</label><div class="fm-prefix"><span>R$</span><input class="fm-input money" id="multasContratuais" placeholder="0,00"></div></div>
      <div class="fm-group"><label for="recFinDiversas">Receitas financeiras diversas</label><div class="fm-prefix"><span>R$</span><input class="fm-input money" id="recFinDiversas" placeholder="0,00"></div></div>
      <div class="fm-group"><label for="valoresRecuperados">Valores recuperados</label><div class="fm-prefix"><span>R$</span><input class="fm-input money" id="valoresRecuperados" placeholder="0,00"></div></div>
      <div class="fm-group"><label for="demaisReceitas">Demais receitas</label><div class="fm-prefix"><span>R$</span><input class="fm-input money" id="demaisReceitas" placeholder="0,00"></div></div>
    </div>

    <div class="sec-title">Reten√ß√µes na Fonte</div>
    <div class="fm-grid fm-2">
      <div class="fm-group"><label for="irrfRetido">IRRF retido (anual)</label><div class="fm-prefix"><span>R$</span><input class="fm-input money" id="irrfRetido" placeholder="0,00"></div></div>
      <div class="fm-group"><label for="csllRetida">CSLL retida (anual)</label><div class="fm-prefix"><span>R$</span><input class="fm-input money" id="csllRetida" placeholder="0,00"></div></div>
      <div class="fm-group"><label for="pisRetido">PIS retido (anual)</label><div class="fm-prefix"><span>R$</span><input class="fm-input money" id="pisRetido" placeholder="0,00"></div></div>
      <div class="fm-group"><label for="cofinsRetida">COFINS retida (anual)</label><div class="fm-prefix"><span>R$</span><input class="fm-input money" id="cofinsRetida" placeholder="0,00"></div></div>
    </div>
  </div>

  <!-- MODO DETALHADO (trimestral) -->
  <div id="modoDetalhado" style="display:none">
    <div class="fm-tip" style="margin-bottom:16px">Preencha os dados para cada trimestre separadamente. Os campos seguem a mesma estrutura do modo simplificado.</div>
    <div class="toggle-wrap" id="trimToggle">
      <button class="toggle-btn active" onclick="setTrimestre(1)">1o Trim</button>
      <button class="toggle-btn" onclick="setTrimestre(2)">2o Trim</button>
      <button class="toggle-btn" onclick="setTrimestre(3)">3o Trim</button>
      <button class="toggle-btn" onclick="setTrimestre(4)">4o Trim</button>
    </div>
    <div id="trimContent"></div>
  </div>
</div>
</section>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- STEP 4: DADOS COMPLEMENTARES -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<section class="wz-panel" id="step4">
<div class="wz-card">
  <div class="wz-header">
    <div class="wz-icon"><i class="fa-solid fa-sliders"></i></div>
    <div><div class="wz-title">Dados Complementares para Compara√ß√£o</div><div class="wz-sub">Informa√ß√µes adicionais para comparativo entre regimes tribut√°rios</div></div>
  </div>

  <div class="sec-title">Folha de Pagamento e Encargos</div>
  <div class="fm-grid fm-3">
    <div class="fm-group"><label for="folhaPagamento">Folha de pagamento anual <span class="tt" data-tip="Total bruto anual (sal√°rios + pr√≥-labore). Usado para calcular INSS patronal e Fator R do Simples.">?</span></label><div class="fm-prefix"><span>R$</span><input class="fm-input money" id="folhaPagamento" placeholder="0,00"></div></div>
    <div class="fm-group"><label for="aliquotaRAT">Al√≠quota RAT (%)</label><div class="fm-prefix"><span>%</span><input class="fm-input" id="aliquotaRAT" type="number" min="1" max="3" step="0.1" value="3"></div></div>
    <div class="fm-group"><label for="aliquotaTerceiros">Contribui√ß√£o a terceiros (%)</label><div class="fm-prefix"><span>%</span><input class="fm-input" id="aliquotaTerceiros" type="number" min="0" max="5.8" step="0.1" value="0.5"></div></div>
  </div>

  <div class="sec-title">Despesas Operacionais Anuais</div>
  <div class="fm-tip" style="margin-bottom:10px">Detalhamento para estimativa de lucro real. Total ser√° calculado automaticamente.</div>
  <div class="desp-grid">
    <div class="fm-group"><label for="despAluguel">Aluguel</label><div class="fm-prefix"><span>R$</span><input class="fm-input money desp" id="despAluguel" placeholder="0,00"></div></div>
    <div class="fm-group"><label for="despUtilidades">Energia / √Ågua / Telefone</label><div class="fm-prefix"><span>R$</span><input class="fm-input money desp" id="despUtilidades" placeholder="0,00"></div></div>
    <div class="fm-group"><label for="despCombustivel">Combust√≠vel e manuten√ß√£o</label><div class="fm-prefix"><span>R$</span><input class="fm-input money desp" id="despCombustivel" placeholder="0,00"></div></div>
    <div class="fm-group"><label for="despMaterial">Material de consumo</label><div class="fm-prefix"><span>R$</span><input class="fm-input money desp" id="despMaterial" placeholder="0,00"></div></div>
    <div class="fm-group"><label for="despServicos">Servi√ßos de terceiros</label><div class="fm-prefix"><span>R$</span><input class="fm-input money desp" id="despServicos" placeholder="0,00"></div></div>
    <div class="fm-group"><label for="despProlabore">Pro-labore</label><div class="fm-prefix"><span>R$</span><input class="fm-input money desp" id="despProlabore" placeholder="0,00"></div></div>
    <div class="fm-group"><label for="despSalarios">Sal√°rios e encargos</label><div class="fm-prefix"><span>R$</span><input class="fm-input money desp" id="despSalarios" placeholder="0,00"></div></div>
    <div class="fm-group"><label for="despDepreciacao">Deprecia√ß√£o</label><div class="fm-prefix"><span>R$</span><input class="fm-input money desp" id="despDepreciacao" placeholder="0,00"></div></div>
    <div class="fm-group"><label for="despOutras">Outras despesas</label><div class="fm-prefix"><span>R$</span><input class="fm-input money desp" id="despOutras" placeholder="0,00"></div></div>
  </div>
  <div class="fm-group" style="margin-top:10px">
    <label for="totalDespesas">Total Despesas Operacionais</label>
    <div class="fm-prefix"><span>R$</span><input class="fm-input" id="totalDespesas" readonly style="font-weight:700;color:var(--accent)"></div>
  </div>

  <div class="sec-title">Dados para Compara√ß√£o de Regimes</div>
  <div class="fm-grid fm-2">
    <div class="fm-group"><label for="creditosPISCOFINS">Cr√©ditos PIS/COFINS estimados (Lucro Real) <span class="tt" data-tip="Estimativa de cr√©ditos sobre insumos no regime n√£o-cumulativo. Reduz o PIS/COFINS no Lucro Real.">?</span></label><div class="fm-prefix"><span>R$</span><input class="fm-input money" id="creditosPISCOFINS" placeholder="0,00"></div></div>
    <div class="fm-group"><label for="aliquotaSimples">Al√≠quota efetiva Simples Nacional (%) <span class="tt" data-tip="Se a empresa for eleg√≠vel ao Simples, informe a al√≠quota efetiva estimada para compara√ß√£o.">?</span></label><div class="fm-prefix"><span>%</span><input class="fm-input" id="aliquotaSimples" type="number" min="4" max="33" step="0.1" value="15"></div></div>
    <div class="fm-group"><label for="lucroContabil">Lucro cont√°bil efetivo (R$) <span class="tt" data-tip="Lucro apurado pela contabilidade. Se informado e houver escritura√ß√£o completa, permite distribuir lucros acima da base presumida.">?</span></label><div class="fm-prefix"><span>R$</span><input class="fm-input money" id="lucroContabil" placeholder="0,00 (opcional)"></div></div>
    <div class="fm-group"><label for="prejuizosFiscais">Preju√≠zos fiscais acumulados (R$)</label><div class="fm-prefix"><span>R$</span><input class="fm-input money" id="prejuizosFiscais" placeholder="0,00"></div></div>
  </div>

  <div class="sec-title">Caracter√≠sticas da Empresa</div>
  <div class="fm-grid" style="gap:8px">
    <label class="chk-card" style="border-color:var(--success-b)"><input type="checkbox" id="temEscrituracao"><span class="chk-mark" style="border-color:var(--success)"></span> Possui escritura√ß√£o cont√°bil completa (ECD)</label>
    <label class="chk-card" style="border-color:var(--success-b)"><input type="checkbox" id="temEquipamentos"><span class="chk-mark" style="border-color:var(--success)"></span> Tem investimentos em equipamentos (deprecia√ß√£o acelerada)</label>
    <label class="chk-card" style="border-color:var(--success-b)"><input type="checkbox" id="temPD"><span class="chk-mark" style="border-color:var(--success)"></span> Faz pesquisa e desenvolvimento (Lei do Bem)</label>
    <label class="chk-card" style="border-color:var(--success-b)"><input type="checkbox" id="receitaSazonal"><span class="chk-mark" style="border-color:var(--success)"></span> Receitas s√£o sazonais</label>
  </div>

  <div class="sec-title">Composi√ß√£o Societ√°ria</div>
  <div id="sociosContainer"></div>
  <button class="btn-add-row" onclick="addSocio()">+ Adicionar S√≥cio</button>
</div>
</section>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- STEP 5: RESULTADOS -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<section class="wz-panel" id="step5">
<div class="wz-card" style="padding:20px">
  <div class="wz-header" style="margin-bottom:16px;padding-bottom:12px">
    <div class="wz-icon"><i class="fa-solid fa-chart-pie"></i></div>
    <div><div class="wz-title">Resultados e An√°lise Completa</div><div class="wz-sub">C√°lculos detalhados, comparativos e recomenda√ß√µes</div></div>
  </div>

  <div class="res-tabs" id="resTabs">
    <button class="res-tab active" data-tab="sim" onclick="showTab('sim')">Simula√ß√£o</button>
    <button class="res-tab" data-tab="trim" onclick="showTab('trim')">Trimestral</button>
    <button class="res-tab" data-tab="piscofins" onclick="showTab('piscofins')">PIS/COFINS</button>
    <button class="res-tab" data-tab="anual" onclick="showTab('anual')">Anual</button>
    <!-- Aba Comparativo removida na v3.0.0 ‚Äî ferramenta exclusiva LP -->
    <button class="res-tab" data-tab="vantagens" onclick="showTab('vantagens')">Vantagens</button>
    <button class="res-tab" data-tab="distribuicao" onclick="showTab('distribuicao')">Distribui√ß√£o</button>
    <button class="res-tab" data-tab="riscos" onclick="showTab('riscos')">Riscos</button>
    <button class="res-tab" data-tab="obrigacoes" onclick="showTab('obrigacoes')">Obriga√ß√µes</button>
    <button class="res-tab" data-tab="transicao" onclick="showTab('transicao')">Transi√ß√£o</button>
    <button class="res-tab" data-tab="dicas" onclick="showTab('dicas')">Dicas</button>
    <!-- Etapa 3: Otimiza√ß√£o -->
    <button class="res-tab" data-tab="prolabore" onclick="showTab('prolabore')" style="border-left:2px solid var(--accent);margin-left:4px">Pro-Labore</button>
    <button class="res-tab" data-tab="jcpEcd" onclick="showTab('jcpEcd')">JCP / ECD</button>
    <button class="res-tab" data-tab="caixaComp" onclick="showTab('caixaComp')">Caixa vs Comp.</button>
    <!-- Etapa 4: Break-Even e Calendario -->
    <button class="res-tab" data-tab="breakeven" onclick="showTab('breakeven')" style="border-left:2px solid var(--success);margin-left:4px">Break-Even</button>
    <button class="res-tab" data-tab="calendario" onclick="showTab('calendario')">Calend√°rio</button>
  </div>

  <div class="tab-panel active" id="tabSim"></div>
  <div class="tab-panel" id="tabTrim"></div>
  <div class="tab-panel" id="tabPiscofins"></div>
  <div class="tab-panel" id="tabAnual"></div>
  <!-- tabComparativo removido na v3.0.0 -->
  <div class="tab-panel" id="tabVantagens"></div>
  <div class="tab-panel" id="tabDistribuicao"></div>
  <div class="tab-panel" id="tabRiscos"></div>
  <div class="tab-panel" id="tabObrigacoes"></div>
  <div class="tab-panel" id="tabTransicao"></div>
  <div class="tab-panel" id="tabDicas"></div>
  <!-- Etapa 3: Otimizacao -->
  <div class="tab-panel" id="tabProlabore"></div>
  <div class="tab-panel" id="tabJcpEcd"></div>
  <div class="tab-panel" id="tabCaixaComp"></div>
  <!-- Etapa 4: Break-Even e Calendario -->
  <div class="tab-panel" id="tabBreakeven"></div>
  <div class="tab-panel" id="tabCalendario"></div>
</div>
</section>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- STEP 6: EXPORTACAO -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<section class="wz-panel" id="step6">
<div class="wz-card">
  <div class="wz-header">
    <div class="wz-icon"><i class="fa-solid fa-file-export"></i></div>
    <div><div class="wz-title">Exporta√ß√£o e Relat√≥rio</div><div class="wz-sub">Salve, exporte ou imprima seu estudo tribut√°rio</div></div>
  </div>
  <div class="export-grid">
    <button type="button" class="export-card pro" id="btnExportPDF" onclick="exportPDF()">
      <div class="export-icon"><i class="fa-solid fa-file-pdf" style="color:var(--accent)"></i></div>
      <div class="export-label">Exportar PDF<span class="export-badge">Pro</span></div>
      <div class="export-desc">Relat√≥rio profissional com 23 se√ß√µes, gr√°ficos e base legal</div>
    </button>
    <button type="button" class="export-card pro" id="btnExportExcel" onclick="exportExcelProfissional()">
      <div class="export-icon"><i class="fa-solid fa-file-excel" style="color:var(--success)"></i></div>
      <div class="export-label">Exportar Excel<span class="export-badge">Pro</span></div>
      <div class="export-desc">Planilha XLSX com 15 abas de dados estruturados</div>
    </button>
    <button type="button" class="export-card" onclick="exportCSV()">
      <div class="export-icon"><i class="fa-solid fa-file-csv"></i></div>
      <div class="export-label">Exportar CSV</div>
      <div class="export-desc">Planilha CSV compat√≠vel com Excel</div>
    </button>
    <button type="button" class="export-card" onclick="window.print()">
      <div class="export-icon"><i class="fa-solid fa-print"></i></div>
      <div class="export-label">Imprimir</div>
      <div class="export-desc">Layout otimizado para impress√£o</div>
    </button>
    <button type="button" class="export-card" onclick="salvarEstudo()">
      <div class="export-icon"><i class="fa-solid fa-floppy-disk"></i></div>
      <div class="export-label">Salvar Estudo</div>
      <div class="export-desc">Salvar no navegador (localStorage)</div>
    </button>
    <button type="button" class="export-card" onclick="novoEstudo()">
      <div class="export-icon"><i class="fa-solid fa-rotate-right"></i></div>
      <div class="export-label">Novo Estudo</div>
      <div class="export-desc">Limpar tudo e recome√ßar</div>
    </button>
  </div>

  <div class="export-opts">
    <div class="export-opts-title"><i class="fa-solid fa-gear"></i> Op√ß√µes de Exporta√ß√£o</div>
    <div class="export-opts-grid">
      <label class="export-opt"><input type="checkbox" id="optCapa" checked> P√°gina de capa</label>
      <label class="export-opt"><input type="checkbox" id="optSumario" checked> Sum√°rio</label>
      <label class="export-opt"><input type="checkbox" id="optGraficos" checked> Gr√°ficos e charts</label>
      <label class="export-opt"><input type="checkbox" id="optAnexoLegal" checked> Anexo com base legal</label>
      <label class="export-opt"><input type="checkbox" id="optDisclaimer" checked> Disclaimer jur√≠dico</label>
      <label class="export-opt"><input type="checkbox" id="optMarcaDagua"> Marca d'√°gua RASCUNHO</label>
    </div>
  </div>
</div>
</section>

<!-- NAV FOOTER -->
<div class="wz-nav" id="wzNav">
  <button class="wz-btn wz-btn-back" id="btnPrev" onclick="prevStep()" disabled><i class="fa-solid fa-arrow-left"></i> Anterior</button>
  <button class="wz-btn wz-btn-next" id="btnNext" onclick="nextStep()">Pr√≥ximo <i class="fa-solid fa-arrow-right"></i></button>
</div>

</div><!-- /main-area -->
</div><!-- /layout -->

<!-- ‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê -->
<script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore-compat.js"></script>
<script src="../scripts/auth/firebase-config.js"></script>
<script src="../scripts/auth/auth-guard.js"></script>
<script src="../scripts/auth/user-service.js"></script>

<!-- SCRIPT IMPORTS -->
<script src="../scripts/dados/impostos_federais.js"></script>
<script src="../scripts/cnae/cnae-mapeamento.js"></script>
<script src="../scripts/estados/acre.js"></script>
<script src="../scripts/estados/alagoas.js"></script>
<script src="../scripts/estados/amapa.js"></script>
<script src="../scripts/estados/amazonas.js"></script>
<script src="../scripts/estados/bahia.js"></script>
<script src="../scripts/estados/ceara.js"></script>
<script src="../scripts/estados/distrito_federal.js"></script>
<script src="../scripts/estados/espirito_santo.js"></script>
<script src="../scripts/estados/goias.js"></script>
<script src="../scripts/estados/maranhao.js"></script>
<script src="../scripts/estados/mato_grosso.js"></script>
<script src="../scripts/estados/mato_grosso_do_sul.js"></script>
<script src="../scripts/estados/minas_gerais.js"></script>
<script src="../scripts/estados/para.js"></script>
<script src="../scripts/estados/paraiba.js"></script>
<script src="../scripts/estados/parana.js"></script>
<script src="../scripts/estados/pernambuco.js"></script>
<script src="../scripts/estados/piaui.js"></script>
<script src="../scripts/estados/rio_de_janeiro.js"></script>
<script src="../scripts/estados/rio_grande_do_norte.js"></script>
<script src="../scripts/estados/rio_grande_do_sul.js"></script>
<script src="../scripts/estados/rondonia.js"></script>
<script src="../scripts/estados/roraima.js"></script>
<script src="../scripts/estados/santa_catarina.js"></script>
<script src="../scripts/estados/sao_paulo.js"></script>
<script src="../scripts/estados/sergipe.js"></script>
<script src="../scripts/estados/tocantins.js"></script>
<script src="../scripts/dados/estados.js"></script>
<script src="../scripts/dados/municipios.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.2/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.4/jspdf.plugin.autotable.min.js"></script>
<script src="../scripts/calculadoras/lucro-presumido/lucro_presumido.js"></script>
<script src="../scripts/calculadoras/lucro-presumido/lucro-presumido-estudos.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<script src="../scripts/calculadoras/lucro-presumido/lucro-presumido-exportar.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.7/chart.umd.min.js"></script>

<!-- CNAE DB (ES6 module) -->
<script type="module">
import { BANCO_CNAE } from '../scripts/cnae/cnae.js';
window.BANCO_CNAE = BANCO_CNAE;
window.dispatchEvent(new Event('cnae-loaded'));
</script>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- MAIN APP SCRIPT -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ESTUDO LUCRO PRESUMIDO ‚Äî APPLICATION SCRIPT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 1. APP STATE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const App = {
  currentStep: 1,
  totalSteps: 6,
  modoFinanceiro: 'simplificado',
  trimestreAtivo: 1,
  formData: {},
  results: {},
  charts: {},
  cnaeLoaded: false,
  autoSaveTimer: null,
  socioCount: 0,
  receitaRowCount: 0,
  cnaeSecCount: 0
};

const UFS = ['AC','AL','AP','AM','BA','CE','DF','ES','GO','MA','MT','MS','MG','PA','PB','PR','PE','PI','RJ','RN','RS','RO','RR','SC','SP','SE','TO'];

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 2. UTILITY FUNCTIONS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function escapeHtml(str) {
  if (str == null) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function formatMoney(value) {
  if (value == null || isNaN(value)) return 'R$ 0,00';
  return 'R$ ' + Number(value).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function parseMoney(str) {
  if (typeof str === 'number') return str;
  if (!str) return 0;
  var s = String(str).replace(/[R$\s]/g, '');
  // Detectar formato: se tem v√≠rgula, √© BR (ponto = milhar, v√≠rgula = decimal)
  // Se N√ÉO tem v√≠rgula e tem ponto com 1-2 d√≠gitos depois, √© formato americano (ponto = decimal)
  if (s.indexOf(',') >= 0) {
    // Formato brasileiro: 1.200.300,50
    return parseFloat(s.replace(/\./g, '').replace(',', '.')) || 0;
  }
  // Sem v√≠rgula: verificar se √∫ltimo ponto parece decimal (1-2 d√≠gitos ap√≥s)
  var lastDot = s.lastIndexOf('.');
  if (lastDot >= 0 && s.length - lastDot <= 3) {
    // Ponto decimal americano: 1000.00 ou 1000.5
    return parseFloat(s) || 0;
  }
  // Sem v√≠rgula e ponto n√£o parece decimal (ex: "1.200.300"): pontos = milhar
  return parseFloat(s.replace(/\./g, '')) || 0;
}

function maskCNPJ(input) {
  if (!input || !input.value) return;
  let v = input.value.replace(/\D/g, '').slice(0, 14);
  if (v.length > 12) v = v.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{0,2})/, '$1.$2.$3/$4-$5');
  else if (v.length > 8) v = v.replace(/^(\d{2})(\d{3})(\d{3})(\d{0,4})/, '$1.$2.$3/$4');
  else if (v.length > 5) v = v.replace(/^(\d{2})(\d{3})(\d{0,3})/, '$1.$2.$3');
  else if (v.length > 2) v = v.replace(/^(\d{2})(\d{0,3})/, '$1.$2');
  input.value = v;
  // Validar quando completo (14 d√≠gitos)
  var digits = v.replace(/\D/g, '');
  var errEl = input.parentElement && input.parentElement.querySelector('.fm-error');
  if (digits.length === 14) {
    if (!validateCNPJ(digits)) {
      if (!errEl) { errEl = document.createElement('div'); errEl.className = 'fm-error'; input.parentElement.appendChild(errEl); }
      errEl.textContent = 'CNPJ inv√°lido ‚Äî d√≠gitos verificadores n√£o conferem';
      input.style.borderColor = 'var(--danger)';
    } else {
      if (errEl) errEl.remove();
      input.style.borderColor = '';
    }
  } else {
    if (errEl) errEl.remove();
    input.style.borderColor = '';
  }
}

function validateCNPJ(cnpj) {
  var d = (cnpj || '').replace(/\D/g, '');
  if (d.length !== 14) return false;
  // Rejeitar CNPJs com todos os d√≠gitos iguais
  if (/^(\d)\1{13}$/.test(d)) return false;
  // Calcular 1o d√≠gito verificador
  var pesos1 = [5,4,3,2,9,8,7,6,5,4,3,2];
  var soma = 0;
  for (var i = 0; i < 12; i++) soma += parseInt(d[i]) * pesos1[i];
  var resto = soma % 11;
  var dig1 = resto < 2 ? 0 : 11 - resto;
  if (parseInt(d[12]) !== dig1) return false;
  // Calcular 2o d√≠gito verificador
  var pesos2 = [6,5,4,3,2,9,8,7,6,5,4,3,2];
  soma = 0;
  for (var j = 0; j < 13; j++) soma += parseInt(d[j]) * pesos2[j];
  resto = soma % 11;
  var dig2 = resto < 2 ? 0 : 11 - resto;
  return parseInt(d[13]) === dig2;
}

function maskMoney(input) {
  var raw = input.value.replace(/[^0-9]/g, '');
  if (!raw) { input.value = ''; return; }
  if (raw.length > 15) raw = raw.slice(0, 15);
  while (raw.length < 3) raw = '0' + raw;
  var inteiro = raw.slice(0, -2).replace(/^0+/, '') || '0';
  var centavos = raw.slice(-2);
  var partes = [];
  var i = inteiro.length;
  while (i > 0) { partes.unshift(inteiro.slice(Math.max(0, i - 3), i)); i -= 3; }
  input.value = partes.join('.') + ',' + centavos;
}

function debounce(fn, ms) {
  let t;
  return function(...args) { clearTimeout(t); t = setTimeout(() => fn.apply(this, args), ms); };
}

/** Formata percentual sem decimais desnecess√°rios: 8% fica "8%", 1.6% fica "1,6%", 38.4% fica "38,4%" */
function fmtPct(v) { const p = v * 100; return (p % 1 === 0 ? p.toFixed(0) : p.toFixed(1).replace('.', ',')) + '%'; }

function $(id) { return document.getElementById(id); }
function $$(sel) { return document.querySelectorAll(sel); }

/** Converte mensagens de erro t√©cnicas em mensagens amig√°veis para o usu√°rio */
function humanizarErro(msg) {
  if (!msg) return 'Ocorreu um erro inesperado. Tente novamente.';
  var mapa = {
    'calcularLucroPresumidoTrimestral': 'Erro no c√°lculo trimestral. Verifique os dados informados.',
    'calcularAnualConsolidado': 'Erro ao consolidar o c√°lculo anual. Verifique os dados.',
    'calcularEstudoCompleto': 'Erro no estudo completo. Verifique os dados informados.',
    'receitaBrutaTrimestral deve ser': 'A receita bruta trimestral deve ser um valor positivo.',
    'receitaBrutaAnual deve ser': 'A receita bruta anual deve ser um valor positivo.',
    'campo obrigat√≥rio': 'H√° campos obrigat√≥rios n√£o preenchidos.',
    'Atividade n√£o encontrada': 'Atividade econ√¥mica n√£o reconhecida. Selecione outra.',
    'Motor lucro_presumido.js n√£o carregado': 'Erro interno ‚Äî recarregue a p√°gina.',
    'params deve ser um objeto': 'Erro interno ‚Äî recarregue a p√°gina.',
    'LucroPresumido is not defined': 'Motor de c√°lculo n√£o carregado. Recarregue a p√°gina.',
    'Cannot read prop': 'Dados incompletos para o c√°lculo. Verifique os campos.',
    'is not a function': 'Erro interno ‚Äî recarregue a p√°gina.'
  };
  for (var chave in mapa) {
    if (msg.indexOf(chave) !== -1) return mapa[chave];
  }
  // Fallback: se mensagem parece t√©cnica, substituir
  if (msg.length > 120 || msg.indexOf('()') !== -1 || msg.indexOf('undefined') !== -1 || msg.indexOf('null') !== -1) {
    return 'Ocorreu um erro no c√°lculo. Verifique os dados informados e tente novamente. Se o problema persistir, recarregue a p√°gina.';
  }
  return msg;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 3. WIZARD NAVIGATION
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function goToStep(n) {
  if (n < 1 || n > App.totalSteps) return;

  // Bloquear Step 6 se resultados n√£o foram calculados
  if (n === 6 && !App.results.anual) {
    alert('Calcule os resultados primeiro (etapa 5) antes de exportar.');
    return;
  }
  // Bloquear Step 5 via clique direto no stepper se n√£o h√° receita
  if (n === 5 && App.currentStep < 5) {
    gatherFormData();
    if (!App.formData.receitaBrutaAnual || App.formData.receitaBrutaAnual <= 0) {
      alert('Informe ao menos uma receita na etapa financeira antes de calcular.');
      return;
    }
  }

  // Loading visual para step 5 (c√°lculos pesados)
  if (n === 5) {
    var mainArea = document.querySelector('.main-area');
    if (mainArea) { mainArea.style.opacity = '0.6'; mainArea.style.pointerEvents = 'none'; }
  }

  // Scroll instant√¢neo antes de trocar painel (evita flash branco)
  window.scrollTo({ top: 0, behavior: 'instant' });

  // Mark previous steps done
  const items = $$('.st-item');
  const lines = $$('.st-line');
  items.forEach((el, i) => {
    const step = i + 1;
    el.classList.remove('active', 'done');
    if (step < n) el.classList.add('done');
    if (step === n) el.classList.add('active');
  });
  lines.forEach((el, i) => {
    el.classList.toggle('done', i < n - 1);
  });

  // Show panel via requestAnimationFrame para evitar flash branco
  requestAnimationFrame(function() {
    $$('.wz-panel').forEach(p => p.classList.remove('active'));
    const panel = $('step' + n);
    if (panel) panel.classList.add('active');

    // Restaurar opacidade
    var mainArea = document.querySelector('.main-area');
    if (mainArea) { mainArea.style.opacity = '1'; mainArea.style.pointerEvents = 'auto'; }
  });

  App.currentStep = n;
  // Nav buttons
  $('btnPrev').disabled = n === 1;
  const btnNext = $('btnNext');
  if (n === 4) {
    btnNext.textContent = 'Calcular Resultados';
    btnNext.className = 'wz-btn wz-btn-calc';
  } else if (n >= 5) {
    btnNext.textContent = 'Pr√≥ximo \u2192';
    btnNext.className = 'wz-btn wz-btn-next';
  } else {
    btnNext.textContent = 'Pr√≥ximo \u2192';
    btnNext.className = 'wz-btn wz-btn-next';
  }
  if (n === App.totalSteps) btnNext.disabled = true;
  else btnNext.disabled = false;
  // Run calculations when entering step 5
  if (n === 5) runAllCalculations();
  updateSidebar();
}

function validarStep(step) {
  var erros = [];
  if (step === 1) {
    // Raz√£o Social obrigat√≥ria
    var razaoSocial = ($('razaoSocial').value || '').trim();
    if (!razaoSocial) {
      erros.push('Raz√£o Social √© obrigat√≥ria.');
    }
    // CNPJ obrigat√≥rio e v√°lido
    var cnpjVal = ($('cnpj').value || '').replace(/\D/g, '');
    if (cnpjVal.length === 0) {
      erros.push('CNPJ √© obrigat√≥rio.');
    } else if (cnpjVal.length < 14) {
      erros.push('CNPJ incompleto ‚Äî deve ter 14 d√≠gitos.');
    } else if (!validateCNPJ(cnpjVal)) {
      erros.push('CNPJ inv√°lido ‚Äî d√≠gitos verificadores n√£o conferem.');
    }
    // CNAE Principal obrigat√≥rio
    var cnaePrincipal = ($('cnaePrincipal').value || '').trim();
    if (!cnaePrincipal) {
      erros.push('Selecione o CNAE principal da empresa.');
    }
  }
  if (step === 3) {
    // Pelo menos uma receita informada
    var temReceita = false;
    $$('#tbodyReceitasSimp tr').forEach(function(tr) {
      var inp = tr.querySelector('.money');
      if (inp && parseMoney(inp.value) > 0) temReceita = true;
    });
    if (!temReceita) {
      erros.push('Informe pelo menos uma receita com valor positivo.');
    }
  }
  if (step === 4) {
    // Receita bruta anual obrigat√≥ria para calcular
    if (!App.formData.receitaBrutaAnual || App.formData.receitaBrutaAnual <= 0) {
      erros.push('Informe pelo menos uma receita na etapa 3 (Dados Financeiros) antes de calcular.');
    }
  }
  return erros;
}

function nextStep() {
  // Sempre coleta dados do formul√°rio antes de navegar (mant√©m sidebar atualizado)
  gatherFormData();
  // Validar step atual antes de avan√ßar
  var erros = validarStep(App.currentStep);
  if (erros.length > 0) {
    alert(erros.join('\n'));
    return;
  }
  if (App.currentStep === 4) {
    goToStep(5);
    return;
  }
  goToStep(App.currentStep + 1);
}

function prevStep() {
  gatherFormData();
  goToStep(App.currentStep - 1);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 4. STEP 1 ‚Äî CNAE SEARCH
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function normalizeCnae(str) {
  return (str || '').replace(/[.\-\/\s]/g, '').toLowerCase();
}

function initCnaeSearch() {
  const input = $('cnaeBusca');
  const results = $('cnaeResults');
  if (!input || !results) return;
  const search = debounce(function() {
    const raw = input.value.trim().toLowerCase();
    const qNorm = normalizeCnae(raw);
    if (raw.length < 2 || !window.BANCO_CNAE) { results.classList.remove('open'); return; }
    const matches = window.BANCO_CNAE.filter(c => {
      const codNorm = normalizeCnae(c.codigo);
      const desc = (c.descricao || '').toLowerCase();
      return codNorm.includes(qNorm) || desc.includes(raw);
    }).sort((a, b) => {
      const aNorm = normalizeCnae(a.codigo);
      const bNorm = normalizeCnae(b.codigo);
      // 1. Correspond√™ncia exata do c√≥digo (come√ßa com a busca)
      const aStartsCode = aNorm.startsWith(qNorm) ? 0 : 1;
      const bStartsCode = bNorm.startsWith(qNorm) ? 0 : 1;
      if (aStartsCode !== bStartsCode) return aStartsCode - bStartsCode;
      // 2. C√≥digo cont√©m a busca
      const aHasCode = aNorm.includes(qNorm) ? 0 : 1;
      const bHasCode = bNorm.includes(qNorm) ? 0 : 1;
      if (aHasCode !== bHasCode) return aHasCode - bHasCode;
      // 3. Descri√ß√£o come√ßa com a busca
      const aDescStart = (a.descricao || '').toLowerCase().startsWith(raw) ? 0 : 1;
      const bDescStart = (b.descricao || '').toLowerCase().startsWith(raw) ? 0 : 1;
      if (aDescStart !== bDescStart) return aDescStart - bDescStart;
      // 4. Ordem natural do c√≥digo
      return aNorm.localeCompare(bNorm);
    }).slice(0, 30);
    if (!matches.length) { results.innerHTML = '<div class="sr-item" style="color:var(--text3)">Nenhum resultado encontrado</div>'; results.classList.add('open'); return; }
    results.innerHTML = matches.map(c => `<div class="sr-item" data-codigo="${c.codigo}" data-desc="${c.descricao}" data-cat="${c.categoria || ''}"><span class="sr-code">${c.codigo}</span><span class="sr-desc">${c.descricao}</span><span class="sr-cat">${c.categoria || ''}</span></div>`).join('');
    results.classList.add('open');
    results.querySelectorAll('.sr-item').forEach(el => {
      el.addEventListener('click', () => selectCnae(el.dataset.codigo, el.dataset.desc, el.dataset.cat));
    });
  }, 300);
  input.addEventListener('input', search);
  document.addEventListener('click', e => { if (!input.contains(e.target) && !results.contains(e.target)) results.classList.remove('open'); });
}

function selectCnae(codigo, descricao, categoria) {
  $('cnaeBusca').value = codigo + ' - ' + descricao;
  $('cnaePrincipal').value = codigo;
  $('cnaeResults').classList.remove('open');
  // Try to identify activity
  try {
    const ativ = LucroPresumido.identificarAtividadePorCNAE(codigo);
    if (ativ) {
      $('atividadeId').value = ativ.atividadeId;
      $('cnaeInfo').style.display = 'block';
      let infoHtml = `<div class="info-box success"><strong>${ativ.descricao}</strong><br>Presun√ß√£o IRPJ: <strong>${(ativ.percentualIRPJ * 100).toFixed(1)}%</strong> | Presun√ß√£o CSLL: <strong>${(ativ.percentualCSLL * 100).toFixed(1)}%</strong><br><span style="opacity:.7">${ativ.baseLegal || ''}</span> | Categoria: ${categoria || 'N/A'}</div>`;
      if (ativ.atividadeId === 'locacao_cessao') {
        infoHtml += `<div class="info-box warn" style="margin-top:6px"><strong>‚ö† Diverg√™ncia interpretativa ‚Äî CSLL 32% (abordagem conservadora)</strong><br>A presun√ß√£o de CSLL a 32% para loca√ß√£o de bens m√≥veis √© a abordagem mais conservadora. A interpreta√ß√£o majorit√°ria da RFB e da jurisprud√™ncia entende que loca√ß√£o de bens m√≥veis <strong>n√£o √© presta√ß√£o de servi√ßos</strong>, cabendo CSLL a 12% (regra geral). H√° solu√ß√µes de consulta divergentes (SC COSIT 7/2021 aplica 32%). <strong>Consulte seu advogado tributarista</strong> para avaliar a posi√ß√£o mais adequada.</div>`;
      }
      // Alerta CNAE-espec√≠fico do motor (ex: CNAE 62.01-5 software 16% vs 32%)
      if (ativ.alertaCNAE) {
        const codigoNorm = codigo.replace(/[.\-\/\s]/g, '');
        Object.entries(ativ.alertaCNAE).forEach(function(entry) {
          var cnaeKey = entry[0], msg = entry[1];
          var keyNorm = cnaeKey.replace(/[.\-\/\s]/g, '');
          if (codigoNorm.startsWith(keyNorm)) {
            infoHtml += `<div class="info-box warn" style="margin-top:6px"><strong>‚ö† ATEN√á√ÉO ‚Äî CNAE ${cnaeKey}:</strong><br>${msg}</div>`;
          }
        });
      }
      $('cnaeInfo').innerHTML = infoHtml;
    } else {
      $('atividadeId').value = 'servicos_gerais';
      $('cnaeInfo').style.display = 'block';
      $('cnaeInfo').innerHTML = `<div class="info-box warn">CNAE n√£o mapeado automaticamente. Usando <strong>Servi√ßos Gerais (32%)</strong> como padr√£o. Ajuste manualmente na etapa financeira se necess√°rio.</div>`;
    }
  } catch(e) {
    $('atividadeId').value = 'servicos_gerais';
    $('cnaeInfo').style.display = 'block';
    $('cnaeInfo').innerHTML = `<div class="info-box warn">Usando percentual padr√£o de Servi√ßos Gerais (32%). Ajuste conforme necess√°rio.</div>`;
  }
  triggerAutoSave();
  updateSidebar();
}

function addCnaeSecundario() {
  App.cnaeSecCount++;
  const id = App.cnaeSecCount;
  const container = $('cnaesSecContainer');
  const row = document.createElement('div');
  row.id = 'cnaeSec' + id;
  row.style.cssText = 'display:flex;gap:8px;align-items:center;margin-bottom:8px;';
  row.innerHTML = `<input class="fm-input" placeholder="Buscar CNAE secund√°rio..." style="flex:1" id="cnaeSecBusca${id}" autocomplete="off"><button class="btn-rm" onclick="document.getElementById('cnaeSec${id}').remove()" style="background:none;border:none;color:var(--danger);font-size:18px;cursor:pointer">&times;</button><div class="search-results" id="cnaeSecResults${id}" style="position:absolute;z-index:50;width:400px;margin-top:40px"></div>`;
  container.appendChild(row);
  const inp = $('cnaeSecBusca' + id);
  const res = $('cnaeSecResults' + id);
  const searchSec = debounce(function() {
    const raw = inp.value.trim().toLowerCase();
    const qNorm = normalizeCnae(raw);
    if (raw.length < 2 || !window.BANCO_CNAE) { res.classList.remove('open'); return; }
    const matches = window.BANCO_CNAE.filter(c => normalizeCnae(c.codigo).includes(qNorm) || (c.descricao || '').toLowerCase().includes(raw)).slice(0, 15);
    if (!matches.length) { res.innerHTML = '<div class="sr-item">Nenhum resultado</div>'; res.classList.add('open'); return; }
    res.innerHTML = matches.map(c => `<div class="sr-item" data-codigo="${c.codigo}" data-desc="${c.descricao}"><span class="sr-code">${c.codigo}</span><span class="sr-desc">${c.descricao}</span></div>`).join('');
    res.classList.add('open');
    res.querySelectorAll('.sr-item').forEach(el => el.addEventListener('click', () => { inp.value = el.dataset.codigo + ' - ' + el.dataset.desc; res.classList.remove('open'); }));
  }, 300);
  inp.addEventListener('input', searchSec);
  document.addEventListener('click', function(e) { if (!inp.contains(e.target) && !res.contains(e.target)) res.classList.remove('open'); });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 5. STEP 1 ‚Äî STATE / MUNICIPALITY
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function populateEstados() {
  const sel = $('estado');

  // Preferir UF_REGISTRY (leve, sem carregar dados completos de cada estado)
  var api = (typeof Estados !== 'undefined' && Estados.UF_REGISTRY) ? Estados
          : (typeof EstadosBR !== 'undefined' && EstadosBR.UF_REGISTRY) ? EstadosBR
          : null;

  if (api && api.UF_REGISTRY) {
    Object.keys(api.UF_REGISTRY).sort().forEach(uf => {
      const opt = document.createElement('option');
      opt.value = uf;
      opt.textContent = `${uf} - ${api.UF_REGISTRY[uf].nome}`;
      sel.appendChild(opt);
    });
  } else {
    // Fallback: array est√°tico UFS
    UFS.forEach(uf => {
      const opt = document.createElement('option');
      opt.value = uf;
      const estado = getEstadoData(uf);
      opt.textContent = estado ? `${uf} - ${estado.nome}` : uf;
      sel.appendChild(opt);
    });
  }
}

function getEstadoData(uf) {
  if (!uf) return null;

  // API de m√©todos (estados.js v1.0+)
  var api = (typeof Estados !== 'undefined' && typeof Estados.getEstado === 'function') ? Estados
          : (typeof EstadosBR !== 'undefined' && typeof EstadosBR.getEstado === 'function') ? EstadosBR
          : null;

  if (api) {
    var completo = api.getEstadoCompleto(uf);
    if (!completo) return null;

    var icmsNorm = api.getICMSNormalizado(uf);
    var incNorm  = api.getIncentivosNormalizado(uf);

    return {
      nome: completo.nome,
      sigla: completo.sigla,
      regiao: completo.regiao,
      icms: {
        padrao: icmsNorm ? icmsNorm.aliquota_padrao : null,
        padrao_percentual: icmsNorm ? icmsNorm.aliquota_padrao_percentual : 'N/D',
        fecop: icmsNorm ? icmsNorm.fecop : null,
        efetiva: icmsNorm ? icmsNorm.aliquota_efetiva : null
      },
      beneficios: {
        tem_sudam:    incNorm && incNorm.sudam       ? !!incNorm.sudam.ativo       : false,
        tem_sudene:   incNorm && incNorm.sudene      ? !!incNorm.sudene.ativo      : false,
        tem_sudeco:   incNorm && incNorm.sudeco       ? !!incNorm.sudeco.ativo      : false,
        zona_franca:  incNorm && incNorm.zona_franca ? !!(incNorm.zona_franca.ativo || incNorm.zona_franca.existe) : false,
        suframa:      incNorm && incNorm.suframa      ? !!incNorm.suframa.ativo     : false
      },
      _raw: completo.dados
    };
  }

  // Fallback: dicion√°rio legado
  if (typeof ESTADOS !== 'undefined' && ESTADOS[uf]) return ESTADOS[uf];

  return null;
}

async function onEstadoChange() {
  const uf = $('estado').value;
  const munSel = $('municipio');
  const estadoInfo = $('estadoInfo');
  if (!uf) {
    munSel.innerHTML = '<option value="">Selecione o estado primeiro...</option>';
    munSel.disabled = true;
    estadoInfo.innerHTML = '';
    return;
  }
  const estado = getEstadoData(uf);
  // Show state info
  if (estado) {
    let info = `<div class="info-box info">ICMS padr√£o: <strong>${estado.icms && estado.icms.padrao != null ? (estado.icms.padrao * 100).toFixed(1) + '%' : 'N/D'}</strong>`;
    if (estado.beneficios) {
      if (estado.beneficios.tem_sudam) info += ' | <strong style="color:var(--success)">Area SUDAM</strong>';
      if (estado.beneficios.tem_sudene) info += ' | <strong style="color:var(--success)">Area SUDENE</strong>';
      if (estado.beneficios.zona_franca) info += ' | <strong style="color:var(--success)">Zona Franca</strong>';
    }
    info += '</div>';
    estadoInfo.innerHTML = info;
  }
  // Load municipalities
  munSel.innerHTML = '<option value="">Carregando munic√≠pios...</option>';
  munSel.disabled = true;
  // Adapter: MunicipiosIBGE espera estadosRef[uf] (dicion√°rio), n√£o API de m√©todos
  var _estadoRef = null;
  var _api = (typeof Estados !== 'undefined' && typeof Estados.getEstado === 'function') ? Estados
           : (typeof EstadosBR !== 'undefined' && typeof EstadosBR.getEstado === 'function') ? EstadosBR
           : null;
  if (_api) {
    _estadoRef = {};
    _estadoRef[uf] = _api.getEstado(uf);
  } else if (typeof ESTADOS !== 'undefined') {
    _estadoRef = ESTADOS;
  }
  try {
    const municipios = await MunicipiosIBGE.buscarMunicipios(uf, _estadoRef);
    MunicipiosIBGE.renderizarSelect(munSel, municipios);
  } catch(e) {
    try {
      const fallback = MunicipiosIBGE.fallbackEstadosJS(uf, _estadoRef);
      if (fallback.length) {
        MunicipiosIBGE.renderizarSelect(munSel, fallback);
      } else {
        munSel.innerHTML = '<option value="">Nenhum munic√≠pio encontrado</option>';
        munSel.disabled = false;
      }
    } catch(e2) {
      munSel.innerHTML = '<option value="">Erro ao carregar munic√≠pios</option>';
      munSel.disabled = false;
    }
  }
  triggerAutoSave();
  updateSidebar();
}

function onMunicipioChange() {
  const munSel = $('municipio');
  const opt = munSel.options[munSel.selectedIndex];
  if (!opt || !opt.value) return;
  const iss = opt.dataset.iss;
  const issConhecido = opt.dataset.issConhecido === '1';
  if (iss) $('aliquotaISS').value = parseFloat(iss).toFixed(1);
  const munInfo = $('municipioInfo');
  munInfo.innerHTML = '<div class="info-box ' + (issConhecido ? 'success' : 'warn') + '">' + MunicipiosIBGE.gerarDicaISS(issConhecido, opt.value) + '</div>';
  triggerAutoSave();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 6. STEP 2 ‚Äî ELIGIBILITY
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function checkElegibilidade() {
  try {
    const result = LucroPresumido.verificarElegibilidade({
      receitaBrutaAnualAnterior: parseMoney($('receitaAnterior').value),
      mesesAtividadeAnoAnterior: parseInt($('mesesAtividade').value) || 12,
      isInstituicaoFinanceira: $('impInstFinanceira').checked,
      isFactoring: $('impFactoring').checked,
      temRendimentosExterior: $('impExterior').checked,
      temIsencaoReducaoIR: $('impIsencao').checked,
      isSCP: $('impSCP').checked
    });
    const div = $('elegibilidadeResult');
    const alertas = result.alertas || [];
    if (result.elegivel) {
      let html = '<div class="info-box success"><strong>ELEG√çVEL ao Lucro Presumido</strong>';
      html += `<br>Limite aplic√°vel: ${formatMoney(result.limiteAplicavel)}`;
      if (alertas.length) {
        html += '<br><br>';
        alertas.forEach(a => { html += `<div style="margin-top:4px"><span class="badge badge-warn">${a.tipo}</span> ${a.mensagem}</div>`; });
      }
      html += '</div>';
      div.innerHTML = html;
      $('sbElegibilidade').innerHTML = '<span class="badge badge-success">Eleg√≠vel</span>';
    } else {
      let html = '<div class="info-box danger"><strong>N√ÉO ELEG√çVEL ao Lucro Presumido</strong><br><br>';
      (result.impedimentos || []).forEach(imp => {
        html += `<div style="margin-top:6px"><strong>${imp.descricao}</strong><br><span style="opacity:.7">${imp.baseLegal}</span></div>`;
      });
      if (alertas.length) {
        html += '<br>';
        alertas.forEach(a => { html += `<div style="margin-top:4px"><span class="badge badge-warn">${a.tipo}</span> ${a.mensagem}</div>`; });
      }
      html += '</div>';
      div.innerHTML = html;
      $('sbElegibilidade').innerHTML = '<span class="badge badge-danger">Ineleg√≠vel</span>';
    }
    if (alertas.length && result.elegivel) {
      $('sbElegibilidade').innerHTML = '<span class="badge badge-warn">Eleg√≠vel (alertas)</span>';
    }
  } catch(e) {
    console.error('[IMPOST] Erro elegibilidade:', e);
    $('elegibilidadeResult').innerHTML = `<div class="info-box danger">${escapeHtml(humanizarErro(e.message))}</div>`;
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 7. STEP 3 ‚Äî FINANCIAL DATA
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setModoFinanceiro(modo) {
  App.modoFinanceiro = modo;
  $$('#step3 .toggle-wrap')[0].querySelectorAll('.toggle-btn').forEach((btn, i) => {
    btn.classList.toggle('active', (i === 0 && modo === 'simplificado') || (i === 1 && modo === 'detalhado'));
  });
  $('modoSimplificado').style.display = modo === 'simplificado' ? 'block' : 'none';
  $('modoDetalhado').style.display = modo === 'detalhado' ? 'block' : 'none';
  var firstBuild = !$('trimContent').children.length;
  if (modo === 'detalhado' && firstBuild) buildTrimestralForms();
  // Herdar dados do simplificado para o detalhado ao trocar de modo
  if (modo === 'detalhado') preencherDetalhado();
}

function preencherDetalhado() {
  // Ler receitas do modo simplificado
  var receitasSimp = [];
  $$('#tbodyReceitasSimp tr').forEach(function(tr) {
    var sel = tr.querySelector('.rec-ativ');
    var inp = tr.querySelector('.money');
    if (sel && inp) {
      var valor = parseMoney(inp.value);
      if (valor > 0) receitasSimp.push({ atividadeId: sel.value, valor: valor });
    }
  });
  if (receitasSimp.length === 0) return;
  // Para cada trimestre, pr√©-preencher se a primeira linha estiver vazia
  for (var q = 1; q <= 4; q++) {
    var tbody = $('tbodyRecTrim' + q);
    if (!tbody) continue;
    var rows = tbody.querySelectorAll('tr');
    // Se j√° tem dados (receita > 0), n√£o sobrescrever
    var temDados = false;
    rows.forEach(function(tr) {
      var inp = tr.querySelector('.money');
      if (inp && parseMoney(inp.value) > 0) temDados = true;
    });
    if (temDados) continue;
    // Preencher: para cada receita simplificada, dividir por 4
    receitasSimp.forEach(function(rec, idx) {
      // Primeira receita vai na row existente, as demais adicionam nova row
      if (idx > 0) addLinhaReceita('tbodyRecTrim' + q, rec.atividadeId);
      var updatedRows = tbody.querySelectorAll('tr');
      var tr = updatedRows[idx];
      if (!tr) return;
      var sel = tr.querySelector('.rec-ativ');
      var inp = tr.querySelector('.money');
      if (sel) sel.value = rec.atividadeId;
      if (inp) {
        var valorTrim = Math.round(rec.valor / 4 * 100) / 100;
        inp.value = valorTrim.toFixed(2).replace('.', ',');
        maskMoney(inp);
      }
    });
  }
  // Pr√©-preencher dedu√ß√µes trimestrais (dividir por 4)
  var camposDeducao = [
    { simpId: 'devolucoes', trimPrefixo: 'trimDev' },
    { simpId: 'cancelamentos', trimPrefixo: 'trimCanc' },
    { simpId: 'descontos', trimPrefixo: 'trimDesc' },
    { simpId: 'ganhosCapital', trimPrefixo: 'trimGanhos' },
    { simpId: 'rendFinanceiros', trimPrefixo: 'trimRendFin' },
    { simpId: 'irrfRetido', trimPrefixo: 'trimIRRF' },
    { simpId: 'csllRetida', trimPrefixo: 'trimCSLL' }
  ];
  camposDeducao.forEach(function(c) {
    var valorAnual = parseMoney($(c.simpId) ? $(c.simpId).value : '');
    if (valorAnual <= 0) return;
    var valorTrim = Math.round(valorAnual / 4 * 100) / 100;
    for (var q = 1; q <= 4; q++) {
      var campo = $(c.trimPrefixo + q);
      if (campo && !parseMoney(campo.value)) {
        campo.value = valorTrim.toFixed(2).replace('.', ',');
        maskMoney(campo);
      }
    }
  });
}

function buildActivitySelect(selectedId) {
  const atividades = LucroPresumido.getAtividadesDisponiveis();
  return atividades.map(a => `<option value="${a.id}" ${a.id === selectedId ? 'selected' : ''}>${a.descricao} (IRPJ ${fmtPct(a.percentualIRPJ)} / CSLL ${fmtPct(a.percentualCSLL)})</option>`).join('');
}

function addLinhaReceita(tableBodyId, defaultAtivId) {
  const tbody = $(tableBodyId || 'tbodyReceitasSimp');
  if (!tbody) return;
  App.receitaRowCount++;
  const id = App.receitaRowCount;
  const atividadeId = defaultAtivId || $('atividadeId').value || 'servicos_gerais';
  const atividades = LucroPresumido.getAtividadesDisponiveis();
  const ativIRPJ = atividades.find(a => a.id === atividadeId);
  const ativCSLL = atividades.find(a => a.id === atividadeId);
  const tr = document.createElement('tr');
  tr.id = 'recRow' + id;
  tr.innerHTML = `<td><select class="fm-input rec-ativ" id="recAtiv${id}" onchange="updateReceitaRow(${id})" style="font-size:12px">${buildActivitySelect(atividadeId)}</select></td><td class="mono" id="recIRPJ${id}">${ativIRPJ ? fmtPct(ativIRPJ.percentualIRPJ) : '32%'}</td><td class="mono" id="recCSLL${id}">${ativCSLL ? fmtPct(ativCSLL.percentualCSLL) : '32%'}</td><td><input class="fm-input money" id="recValor${id}" placeholder="0,00" oninput="maskMoney(this);triggerAutoSave()"></td><td><button class="btn-rm" onclick="document.getElementById('recRow${id}').remove()">&times;</button></td>`;
  tbody.appendChild(tr);
}

function updateReceitaRow(id) {
  const sel = $('recAtiv' + id);
  if (!sel) return;
  const atividades = LucroPresumido.getAtividadesDisponiveis();
  const ativ = atividades.find(a => a.id === sel.value);
  if (ativ) {
    $('recIRPJ' + id).textContent = fmtPct(ativ.percentualIRPJ);
    $('recCSLL' + id).textContent = fmtPct(ativ.percentualCSLL);
  }
}

function buildTrimestralForms() {
  const container = $('trimContent');
  let html = '';
  for (let q = 1; q <= 4; q++) {
    html += `<div class="trim-panel" id="trimPanel${q}" style="${q === 1 ? '' : 'display:none'}">
      <div class="sec-title">${q}o Trimestre ‚Äî Receitas</div>
      <table class="dyn-table"><thead><tr><th>Atividade</th><th>% IRPJ</th><th>% CSLL</th><th style="width:180px">Receita (R$)</th><th></th></tr></thead>
      <tbody id="tbodyRecTrim${q}"></tbody></table>
      <button class="btn-add-row" onclick="addLinhaReceita('tbodyRecTrim${q}')">+ Adicionar Atividade</button>
      <div class="fm-grid fm-2" style="margin-top:12px">
        <div class="fm-group"><label for="trimDev${q}">Devolu√ß√µes</label><div class="fm-prefix"><span>R$</span><input class="fm-input money" id="trimDev${q}" placeholder="0,00"></div></div>
        <div class="fm-group"><label for="trimCanc${q}">Cancelamentos</label><div class="fm-prefix"><span>R$</span><input class="fm-input money" id="trimCanc${q}" placeholder="0,00"></div></div>
        <div class="fm-group"><label for="trimDesc${q}">Descontos incondicionais</label><div class="fm-prefix"><span>R$</span><input class="fm-input money" id="trimDesc${q}" placeholder="0,00"></div></div>
        <div class="fm-group"><label for="trimGanhos${q}">Ganhos de capital</label><div class="fm-prefix"><span>R$</span><input class="fm-input money" id="trimGanhos${q}" placeholder="0,00"></div></div>
        <div class="fm-group"><label for="trimRendFin${q}">Rendimentos financeiros</label><div class="fm-prefix"><span>R$</span><input class="fm-input money" id="trimRendFin${q}" placeholder="0,00"></div></div>
        <div class="fm-group"><label for="trimIRRF${q}">IRRF retido</label><div class="fm-prefix"><span>R$</span><input class="fm-input money" id="trimIRRF${q}" placeholder="0,00"></div></div>
        <div class="fm-group"><label for="trimCSLL${q}">CSLL retida</label><div class="fm-prefix"><span>R$</span><input class="fm-input money" id="trimCSLL${q}" placeholder="0,00"></div></div>
      </div>
    </div>`;
  }
  container.innerHTML = html;
  for (let q = 1; q <= 4; q++) addLinhaReceita('tbodyRecTrim' + q);
}

function setTrimestre(n) {
  App.trimestreAtivo = n;
  $('trimToggle').querySelectorAll('.toggle-btn').forEach((btn, i) => btn.classList.toggle('active', i === n - 1));
  for (let q = 1; q <= 4; q++) {
    const panel = $('trimPanel' + q);
    if (panel) panel.style.display = q === n ? 'block' : 'none';
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 8. STEP 4 ‚Äî COMPLEMENTARY DATA
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function calcTotalDespesas() {
  let total = 0;
  $$('.desp').forEach(inp => { total += parseMoney(inp.value); });
  $('totalDespesas').value = Number(total).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function addSocio() {
  App.socioCount++;
  const id = App.socioCount;
  const container = $('sociosContainer');
  const row = document.createElement('div');
  row.className = 'soc-row';
  row.id = 'socRow' + id;
  row.innerHTML = `<input class="fm-input" id="socNome${id}" placeholder="Nome do s√≥cio"><input class="fm-input" id="socPct${id}" type="number" min="0" max="100" step="0.1" placeholder="%" style="text-align:center"><button class="btn-rm" onclick="document.getElementById('socRow${id}').remove()">&times;</button>`;
  container.appendChild(row);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 9. GATHER FORM DATA
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function gatherFormData() {
  const d = {};
  d.razaoSocial = ($('razaoSocial').value || '').trim();
  d.cnpj = ($('cnpj').value || '').trim();
  d.cnaePrincipal = ($('cnaePrincipal').value || '').trim();
  d.atividadeId = $('atividadeId').value || 'servicos_gerais';
  d.estado = $('estado').value;
  d.municipio = $('municipio').value;
  d.aliquotaISS = Math.max(2, Math.min(5, parseFloat($('aliquotaISS').value) || 5));
  d.porte = $('porte').value;
  d.receitaAnterior = parseMoney($('receitaAnterior').value);
  d.folhaPagamento = parseMoney($('folhaPagamento').value);
  d.aliquotaRAT = Math.max(1, Math.min(3, parseFloat($('aliquotaRAT').value) || 3));
  d.aliquotaTerceiros = Math.max(0, Math.min(5.8, parseFloat($('aliquotaTerceiros').value) || 0.5));
  // Vers√µes decimais das al√≠quotas (convertidas UMA VEZ aqui)
  d.aliquotaISSDecimal = d.aliquotaISS / 100;
  d.aliquotaRATDecimal = d.aliquotaRAT / 100;
  d.aliquotaTerceirosDecimal = d.aliquotaTerceiros / 100;
  d.creditosPISCOFINS = parseMoney($('creditosPISCOFINS').value);
  d.aliquotaSimples = parseFloat($('aliquotaSimples').value) || 15;
  d.lucroContabil = parseMoney($('lucroContabil').value);
  d.prejuizosFiscais = parseMoney($('prejuizosFiscais').value);
  d.temEscrituracao = $('temEscrituracao').checked;
  d.temEquipamentos = $('temEquipamentos').checked;
  d.temPD = $('temPD').checked;
  d.receitaSazonal = $('receitaSazonal').checked;
  // Impedimentos legais (para restaura√ß√£o via autoSave)
  d.impInstFinanceira = $('impInstFinanceira').checked;
  d.impFactoring = $('impFactoring').checked;
  d.impExterior = $('impExterior').checked;
  d.impIsencao = $('impIsencao').checked;
  d.impSCP = $('impSCP').checked;
  // Deductions (annual)
  d.devolucoes = parseMoney($('devolucoes').value);
  d.cancelamentos = parseMoney($('cancelamentos').value);
  d.descontos = parseMoney($('descontos').value);
  d.ganhosCapital = parseMoney($('ganhosCapital').value);
  d.rendFinanceiros = parseMoney($('rendFinanceiros').value);
  d.jcpRecebido = parseMoney($('jcpRecebido').value);
  d.multasContratuais = parseMoney($('multasContratuais').value);
  d.recFinDiversas = parseMoney($('recFinDiversas').value);
  d.valoresRecuperados = parseMoney($('valoresRecuperados').value);
  d.demaisReceitas = parseMoney($('demaisReceitas').value);
  d.irrfRetido = parseMoney($('irrfRetido').value);
  d.csllRetida = parseMoney($('csllRetida').value);
  d.pisRetido = parseMoney($('pisRetido').value);
  d.cofinsRetida = parseMoney($('cofinsRetida').value);
  // Despesas
  calcTotalDespesas();
  d.totalDespesas = parseMoney($('totalDespesas').value);
  d.despAluguel = parseMoney($('despAluguel').value);
  d.despUtilidades = parseMoney($('despUtilidades').value);
  d.despCombustivel = parseMoney($('despCombustivel').value);
  d.despMaterial = parseMoney($('despMaterial').value);
  d.despServicos = parseMoney($('despServicos').value);
  d.despProlabore = parseMoney($('despProlabore').value);
  d.despSalarios = parseMoney($('despSalarios').value);
  d.despDepreciacao = parseMoney($('despDepreciacao').value);
  d.despOutras = parseMoney($('despOutras').value);
  // Receitas por atividade (simplified)
  d.receitas = [];
  $$('#tbodyReceitasSimp tr').forEach(tr => {
    const sel = tr.querySelector('.rec-ativ');
    const inp = tr.querySelector('.money');
    if (sel && inp) {
      const valor = parseMoney(inp.value);
      if (valor > 0) {
        d.receitas.push({ atividadeId: sel.value, valor: Math.max(0, valor) });
      }
    }
  });
  // Garantir pelo menos uma receita (evita divisao por zero no motor)
  if (d.receitas.length === 0) {
    d.receitas.push({ atividadeId: d.atividadeId, valor: 0 });
  }
  d.receitaBrutaAnual = d.receitas.reduce((s, r) => s + r.valor, 0);
  // Socios
  d.socios = [];
  $$('.soc-row').forEach(row => {
    const nome = row.querySelector('input[type="text"], input:not([type])');
    const pct = row.querySelector('input[type="number"]');
    if (nome && pct && nome.value) {
      d.socios.push({ nome: nome.value, percentual: (parseFloat(pct.value) || 0) / 100 });
    }
  });
  // Estado/SUDAM/SUDENE/ZFM
  const estadoData = getEstadoData(d.estado);
  d.areaAtuacaoSUDAM = estadoData && estadoData.beneficios && estadoData.beneficios.tem_sudam ? true : false;
  d.areaAtuacaoSUDENE = estadoData && estadoData.beneficios && estadoData.beneficios.tem_sudene ? true : false;
  d.zonaFranca = estadoData && estadoData.beneficios && estadoData.beneficios.zona_franca ? true : false;
  // Elegibilidade Simples: verifica receita, porte E impedimentos legais
  const temImpedimentoSimples = $('impInstFinanceira').checked || $('impFactoring').checked || $('impExterior').checked;
  d.elegivelSimples = d.receitaBrutaAnual <= 4800000 && d.porte !== 'DEMAIS' && !temImpedimentoSimples;
  App.formData = d;
  return d;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 9A. HELPERS ‚Äî Distribui√ß√£o uniforme de dados anuais
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/**
 * Distribui dados anuais uniformemente em dados trimestrais.
 * Transforma√ß√£o de dados de entrada (n√£o √© c√°lculo tribut√°rio).
 */
function distribuirAnualParaTrimestral(d) {
  return {
    receitas: d.receitas.map(r => ({ atividadeId: r.atividadeId, valor: r.valor / 4 })),
    devolucoes: (d.devolucoes || 0) / 4,
    cancelamentos: (d.cancelamentos || 0) / 4,
    descontosIncondicionais: (d.descontos || 0) / 4,
    ganhosCapital: (d.ganhosCapital || 0) / 4,
    rendimentosFinanceiros: (d.rendFinanceiros || 0) / 4,
    jcpRecebidos: (d.jcpRecebido || 0) / 4,
    multasContratuais: (d.multasContratuais || 0) / 4,
    receitasFinanceirasDiversas: (d.recFinDiversas || 0) / 4,
    valoresRecuperados: (d.valoresRecuperados || 0) / 4,
    demaisReceitas: (d.demaisReceitas || 0) / 4,
    irrfRetidoFonte: (d.irrfRetido || 0) / 4,
    csllRetidaFonte: (d.csllRetida || 0) / 4
  };
}

/**
 * Distribui dados anuais uniformemente em dados mensais para PIS/COFINS.
 */
function distribuirAnualParaMensal(d) {
  return {
    receitaBrutaMensal: (d.receitaBrutaAnual || 0) / 12,
    vendasCanceladas: ((d.devolucoes || 0) + (d.cancelamentos || 0)) / 12,
    descontosIncondicionais: (d.descontos || 0) / 12,
    pisRetidoFonte: (d.pisRetido || 0) / 12,
    cofinsRetidaFonte: (d.cofinsRetida || 0) / 12
  };
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 10. RESULTS ‚Äî RUN ALL CALCULATIONS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function runAllCalculations() {
  const d = gatherFormData();
  // Validar receita minima
  if (!d.receitaBrutaAnual || d.receitaBrutaAnual <= 0) {
    alert('Informe ao menos uma receita com valor positivo na etapa financeira antes de calcular.');
    return;
  }
  // Validar limite de receita para Lucro Presumido (R$ 78M conforme Lei 10.637/2002)
  if (d.receitaBrutaAnual > 78000000) {
    if (!confirm('A receita bruta anual de ' + formatMoney(d.receitaBrutaAnual) + ' excede o limite de R$ 78.000.000 para o Lucro Presumido (Lei 10.637/2002, Art. 46). A empresa seria OBRIGADA ao Lucro Real. Deseja continuar a simula√ß√£o mesmo assim?')) return;
  }
  // Validar composi√ß√£o societ√°ria
  if (d.socios.length > 0) {
    const totalPct = d.socios.reduce((s, sc) => s + sc.percentual, 0);
    if (Math.abs(totalPct - 1) > 0.01) {
      const pctFmt = (totalPct * 100).toFixed(1);
      if (!confirm(`A composi√ß√£o societ√°ria soma ${pctFmt}% (deveria ser 100%). Deseja continuar mesmo assim?`)) return;
    }
  }
  // Atualizar elegibilidade na sidebar (H07)
  try { checkElegibilidade(); } catch(e) { /* silencioso */ }
  try {
    renderSimulacao(d);
    renderTrimestral(d);
    renderPISCOFINS(d);
    renderAnual(d);
    // renderComparativo(d); // Removido v3.0.0 ‚Äî ferramenta exclusiva LP
    renderVantagens(d);
    renderDistribuicao(d);
    renderRiscos();
    renderObrigacoes();
    renderTransicao(d);
    renderDicas(d);
    renderProLabore(d);
    renderJcpEcd(d);
    renderCaixaComp(d);
    renderBreakeven(d);
    // Guardar resultado do EstudoLP para uso na sidebar e exports
    if (typeof EstudoLP !== 'undefined' && App.results.breakeven) {
      try {
        App.results.dicas = EstudoLP.gerarDicasInteligentes({
          receitaBrutaAnual: d.receitaBrutaAnual,
          atividadeId: d.atividadeId,
          folhaPagamentoAnual: d.folhaPagamento || 0,
          totalDespesasOperacionais: d.totalDespesas || 0,
          creditosPISCOFINS: d.creditosPISCOFINS || 0,
          temEscrituracao: !!d.temEscrituracao,
          temEquipamentos: !!d.temEquipamentos,
          temPD: !!d.temPD,
          receitaSazonal: !!d.receitaSazonal,
          areaAtuacaoSUDAM: !!d.areaAtuacaoSUDAM,
          numReceitas: d.receitas ? d.receitas.length : 1,
          breakeven: App.results.breakeven
        });
      } catch(e) { /* silencioso */ }
      // Calcular economia potencial consolidada (alinhada com o motor EstudoLP)
      try {
        App.results.economiaPotencial = EstudoLP.calcularEconomiaPotencial({
          proLabore: App.results.proLabore || null,
          ecd: App.results.ecd || null,
          caixaComp: App.results.caixaComp || null,
          breakeven: App.results.breakeven || null,
          dicas: App.results.dicas || []
        });
      } catch(e) { /* silencioso */ }
    }
    renderCalendario(d);
    updateSidebar();
    // Desbloquear Step 6 no stepper ap√≥s c√°lculos
    var step6Item = document.querySelector('.st-item[data-step="6"]');
    if (step6Item) step6Item.classList.remove('locked');
  } catch(e) {
    console.error('Erro nos calculos:', e);
    console.error('[IMPOST] Erro nos c√°lculos:', e);
    $('tabSim').innerHTML = `<div class="info-box danger">${escapeHtml(humanizarErro(e.message))}</div>`;
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TAB: SIMULACAO
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderSimulacao(d) {
  const receitaTrim = d.receitaBrutaAnual / 4;
  if (receitaTrim <= 0) { $('tabSim').innerHTML = '<div class="info-box warn">Informe ao menos uma receita na etapa financeira.</div>'; return; }
  try {
    const sim = LucroPresumido.simulacaoRapida(receitaTrim, d.atividadeId);
    App.results.simulacao = sim;
    $('tabSim').innerHTML = `
      <div class="info-box warn" style="margin-bottom:16px"><strong>ESTIMATIVA SIMPLIFICADA:</strong> Esta aba apresenta uma estimativa r√°pida que <strong>N√ÉO considera</strong> dedu√ß√µes da receita bruta (devolu√ß√µes, cancelamentos), adi√ß√µes obrigat√≥rias (rendimentos financeiros, ganhos de capital) nem reten√ß√µes na fonte (IRRF, CSRF). Para valores precisos e detalhados, consulte as abas <strong>Trimestral</strong>, <strong>PIS/COFINS</strong> e <strong>Anual</strong>.</div>
      <div class="kpi-grid">
        <div class="kpi"><div class="kpi-label">Receita Trimestral</div><div class="kpi-value" style="color:var(--accent)">${formatMoney(sim.receitaBrutaTrimestral)}</div></div>
        <div class="kpi"><div class="kpi-label">Base IRPJ</div><div class="kpi-value">${formatMoney(sim.baseIRPJ)}</div><div class="kpi-sub">${sim.percentualPresuncaoIRPJ}</div></div>
        <div class="kpi"><div class="kpi-label">IRPJ</div><div class="kpi-value" style="color:var(--danger)">${formatMoney(sim.irpj.total)}</div><div class="kpi-sub">Normal ${formatMoney(sim.irpj.normal)} + Adic. ${formatMoney(sim.irpj.adicional)}</div></div>
        <div class="kpi"><div class="kpi-label">CSLL</div><div class="kpi-value" style="color:var(--danger)">${formatMoney(sim.csll)}</div></div>
        <div class="kpi"><div class="kpi-label">PIS + COFINS</div><div class="kpi-value" style="color:var(--warn)">${formatMoney(sim.pisTrimestral + sim.cofinsTrimestral)}</div><div class="kpi-sub">PIS ${formatMoney(sim.pisTrimestral)} | COFINS ${formatMoney(sim.cofinsTrimestral)}</div></div>
        <div class="kpi"><div class="kpi-label">Total Tributos Federais</div><div class="kpi-value" style="color:var(--danger)">${formatMoney(sim.totalTributosFederais)}</div><div class="kpi-sub">IRPJ + CSLL + PIS + COFINS</div></div>
        <div class="kpi"><div class="kpi-label">Al√≠quota Efetiva Federal</div><div class="kpi-value" style="color:var(--info)">${sim.aliquotaEfetiva}</div><div class="kpi-sub">N√£o inclui ISS nem INSS patronal</div></div>
      </div>
      <div class="info-box info" style="margin-top:12px"><strong>Atividade:</strong> ${sim.atividade}<br>${((sim.observacao || '').indexOf('()') !== -1 || (sim.observacao || '').indexOf('Use ') !== -1) ? 'Para carga tribut√°ria completa incluindo ISS, consulte as abas Trimestral e Anual.' : escapeHtml(sim.observacao)}</div>
      <div style="margin-top:16px;padding:12px;background:rgba(100,116,139,.08);border-radius:6px;border-left:3px solid var(--text3)">
        <p style="font-size:10px;color:var(--text3);line-height:1.5;margin:0"><strong>AVISO LEGAL:</strong> Os c√°lculos apresentados s√£o estimativas baseadas na legisla√ß√£o vigente (RIR/2018, IN RFB 1.700/2017, LC 224/2025) e nos dados informados pelo usu√°rio. Este sistema N√ÉO substitui a orienta√ß√£o de um contador ou advogado tributarista. Os resultados devem ser validados por profissional habilitado antes de qualquer tomada de decis√£o fiscal. O IMPOST n√£o se responsabiliza por decis√µes tomadas com base exclusivamente nesta simula√ß√£o.</p>
      </div>`;
  } catch(e) {
    $('tabSim').innerHTML = `<div class="info-box danger">${escapeHtml(humanizarErro(e.message))}</div>`;
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TAB: TRIMESTRAL
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTrimestral(d) {
  if (d.receitaBrutaAnual <= 0) { $('tabTrim').innerHTML = '<div class="info-box warn">Informe receitas na etapa financeira.</div>'; return; }
  try {
    const trimResults = [];
    const dadosTrim = distribuirAnualParaTrimestral(d);
    for (let q = 0; q < 4; q++) {
      const result = LucroPresumido.calcularLucroPresumidoTrimestral(dadosTrim);
      trimResults.push(result);
    }
    App.results.trimestral = trimResults;
    let html = '<table class="dyn-table"><thead><tr><th>Item</th><th class="right">1o Trim</th><th class="right">2o Trim</th><th class="right">3o Trim</th><th class="right">4o Trim</th><th class="right">Total</th></tr></thead><tbody>';
    const fields = [
      ['Receita Bruta', 'receitaBrutaTotal'],
      ['(-) Dedu√ß√µes', 'deducoesDaReceita'],
      ['Receita Ajustada', 'receitaBrutaAjustada'],
      ['Base Presumida IRPJ', 'basePresumidaIRPJ'],
      ['Base Presumida CSLL', 'basePresumidaCSLL'],
      ['(+) Adi√ß√µes Obrigat√≥rias', 'adicoesObrigatorias'],
      ['Base C√°lculo IRPJ', 'baseCalculoIRPJ'],
      ['Base C√°lculo CSLL', 'baseCalculoCSLL'],
      ['IRPJ Normal (15%)', 'irpjNormal'],
      ['IRPJ Adicional (10%)', 'irpjAdicional'],
      ['(-) IRRF Retido', 'irrfRetidoFonte'],
      ['IRPJ Devido', 'irpjDevido'],
      ['CSLL (9%)', 'csllBruta'],
      ['(-) CSLL Retida', 'csllRetidaFonte'],
      ['CSLL Devida', 'csllDevida'],
      ['Total IRPJ + CSLL', 'totalIRPJCSLL'],
    ];
    fields.forEach(([label, key]) => {
      let total = 0;
      html += `<tr><td>${label}</td>`;
      trimResults.forEach(r => {
        const v = r.resumo[key] || 0;
        total += v;
        html += `<td class="right mono">${formatMoney(v)}</td>`;
      });
      html += `<td class="right mono" style="font-weight:700">${formatMoney(total)}</td></tr>`;
    });
    html += '</tbody></table>';
    html += `<div class="info-box info" style="margin-top:12px"><strong>DARF IRPJ:</strong> C√≥digo ${trimResults[0].resumo.codigoDARF_IRPJ} | <strong>DARF CSLL:</strong> C√≥digo ${trimResults[0].resumo.codigoDARF_CSLL}<br>Al√≠quota efetiva federal sobre receita: ${trimResults[0].resumo.aliquotaEfetivaReceita} <small style="color:var(--text3)">(IRPJ + CSLL + PIS + COFINS ‚Äî n√£o inclui ISS nem INSS)</small></div>`;

    // LC 224/2025 ‚Äî Impacto na base presumida (s√≥ se receita > R$5M/ano)
    if (d.receitaBrutaAnual > 5000000 && typeof LucroPresumido.calcularBasePresumidaLC224 === 'function') {
      const atividades = LucroPresumido.getAtividadesDisponiveis();
      const ativPrincipal = atividades.find(a => a.id === d.atividadeId) || atividades[0];
      let lc224Html = '<div class="sec-title" style="margin-top:20px">Impacto LC 224/2025 (Receita > R$ 5M)</div>';
      lc224Html += '<table class="dyn-table"><thead><tr><th>Trimestre</th><th class="right">Base sem LC 224</th><th class="right">Base com LC 224</th><th class="right">Impacto (+)</th></tr></thead><tbody>';
      let totalSem = 0, totalCom = 0, totalImpacto = 0, totalImpostoExtra = 0;
      for (let q = 1; q <= 4; q++) {
        const recTrim = d.receitaBrutaAnual / 4;
        const acumulado = recTrim * q;
        const lc224 = LucroPresumido.calcularBasePresumidaLC224({
          receitaBrutaTrimestral: recTrim,
          receitaBrutaAcumuladaAnoAte: acumulado,
          percentualPresuncaoOriginal: ativPrincipal.percentualIRPJ,
          trimestreAtual: q,
          anoCalendario: 2026
        });
        const baseSem = recTrim * ativPrincipal.percentualIRPJ;
        totalSem += baseSem;
        totalCom += lc224.basePresumida;
        totalImpacto += lc224.impactoLC224;
        totalImpostoExtra += lc224.impostoEstimadoExtra || 0;
        const impColor = lc224.impactoLC224 > 0 ? 'color:var(--danger)' : '';
        lc224Html += `<tr><td>${q}o Trim</td><td class="right mono">${formatMoney(baseSem)}</td><td class="right mono">${formatMoney(lc224.basePresumida)}</td><td class="right mono" style="${impColor};font-weight:600">${lc224.impactoLC224 > 0 ? '+' : ''}${formatMoney(lc224.impactoLC224)}</td></tr>`;
      }
      lc224Html += `<tr style="background:var(--bg);font-weight:700"><td>TOTAL</td><td class="right mono">${formatMoney(totalSem)}</td><td class="right mono">${formatMoney(totalCom)}</td><td class="right mono" style="color:var(--danger)">${totalImpacto > 0 ? '+' : ''}${formatMoney(totalImpacto)}</td></tr>`;
      lc224Html += '</tbody></table>';
      if (totalImpacto > 0) {
        lc224Html += `<div class="info-box warn" style="margin-top:8px"><strong>LC 224/2025:</strong> A receita anual de ${formatMoney(d.receitaBrutaAnual)} excede o limite de R$ 5.000.000. A base presumida IRPJ aumenta em ${formatMoney(totalImpacto)}, gerando ~${formatMoney(totalImpostoExtra)} a mais em IRPJ+CSLL.<br><small>Vigencia: A partir do 2o trimestre de 2026 (01/04/2026). LC 224/2025, Art. 14.</small></div>`;
        lc224Html += `<div class="info-box danger" style="margin-top:8px"><strong>INSEGURANCA JURIDICA:</strong> A majoracao da base de calculo do lucro presumido pela LC 224/2025 e objeto de questionamentos judiciais. Ha liminares concedidas suspendendo a aplicacao do acrescimo de 10% para empresas com receita acima de R$ 5M. Consulte seu advogado tributarista sobre a viabilidade de medida judicial para sua empresa.<br><small>Referencia: Acoes judiciais contra Art. 14 da LC 224/2025. Situacao sujeita a alteracao.</small></div>`;
      } else {
        lc224Html += `<div class="info-box info" style="margin-top:8px">A LC 224/2025 so se aplica a partir do 2o trimestre de 2026 (vigencia 01/04/2026). Nos trimestres anteriores, nao ha impacto.</div>`;
      }
      html += lc224Html;
    }

    $('tabTrim').innerHTML = html;
  } catch(e) {
    $('tabTrim').innerHTML = `<div class="info-box danger">${escapeHtml(humanizarErro(e.message))}</div>`;
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TAB: PIS/COFINS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderPISCOFINS(d) {
  if (d.receitaBrutaAnual <= 0) { $('tabPiscofins').innerHTML = '<div class="info-box warn">Informe receitas.</div>'; return; }
  try {
    const dadosMensal = distribuirAnualParaMensal(d);
    const csllRetidaMensal = (d.csllRetida || 0) / 12;
    const irrfRetidoMensal = (d.irrfRetido || 0) / 12;
    const mesesResults = [];
    const mesesNomes = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
    for (let m = 0; m < 12; m++) {
      const result = LucroPresumido.calcularPISCOFINSMensal({
        ...dadosMensal,
        csllRetidaFonteMensal: csllRetidaMensal,
        irrfRetidoFonteMensal: irrfRetidoMensal
      });
      mesesResults.push(result);
    }
    App.results.piscofins = mesesResults;
    // Verificar se h√° reten√ß√µes para decidir o layout da tabela
    const temRetencoesPIS = mesesResults.some(r => r.pis.retidoFonte > 0);
    const temRetencoesCOFINS = mesesResults.some(r => r.cofins.retidaFonte > 0);
    const temRetencoes = temRetencoesPIS || temRetencoesCOFINS;
    let html = '';
    if (temRetencoes) {
      // Tabela expandida com Bruto / Retido / Devido
      html += '<table class="dyn-table"><thead><tr><th>Mes</th><th class="right">Receita</th><th class="right">Base</th><th class="right">PIS Bruto</th><th class="right">PIS Retido</th><th class="right">PIS Devido</th><th class="right">COFINS Bruta</th><th class="right">COFINS Retida</th><th class="right">COFINS Devida</th><th class="right">Total Devido</th></tr></thead><tbody>';
      let totRec = 0, totBase = 0, totPISB = 0, totPISR = 0, totPISD = 0, totCOFB = 0, totCOFR = 0, totCOFD = 0, totT = 0;
      mesesResults.forEach((r, i) => {
        const total = r.pis.devido + r.cofins.devida;
        totRec += r.receitaBrutaMensal; totBase += r.baseCalculo;
        totPISB += r.pis.bruto; totPISR += r.pis.retidoFonte; totPISD += r.pis.devido;
        totCOFB += r.cofins.bruta; totCOFR += r.cofins.retidaFonte; totCOFD += r.cofins.devida;
        totT += total;
        html += `<tr><td>${mesesNomes[i]}</td><td class="right mono">${formatMoney(r.receitaBrutaMensal)}</td><td class="right mono">${formatMoney(r.baseCalculo)}</td><td class="right mono">${formatMoney(r.pis.bruto)}</td><td class="right mono" style="color:var(--success)">${formatMoney(r.pis.retidoFonte)}</td><td class="right mono">${formatMoney(r.pis.devido)}</td><td class="right mono">${formatMoney(r.cofins.bruta)}</td><td class="right mono" style="color:var(--success)">${formatMoney(r.cofins.retidaFonte)}</td><td class="right mono">${formatMoney(r.cofins.devida)}</td><td class="right mono" style="font-weight:700">${formatMoney(total)}</td></tr>`;
      });
      html += `<tr style="background:var(--bg);font-weight:700"><td>TOTAL</td><td class="right mono">${formatMoney(totRec)}</td><td class="right mono">${formatMoney(totBase)}</td><td class="right mono">${formatMoney(totPISB)}</td><td class="right mono" style="color:var(--success)">${formatMoney(totPISR)}</td><td class="right mono">${formatMoney(totPISD)}</td><td class="right mono">${formatMoney(totCOFB)}</td><td class="right mono" style="color:var(--success)">${formatMoney(totCOFR)}</td><td class="right mono">${formatMoney(totCOFD)}</td><td class="right mono">${formatMoney(totT)}</td></tr>`;
      html += '</tbody></table>';
    } else {
      // Tabela simplificada (sem reten√ß√µes)
      html += '<table class="dyn-table"><thead><tr><th>Mes</th><th class="right">Receita</th><th class="right">Base</th><th class="right">PIS 0,65%</th><th class="right">COFINS 3,00%</th><th class="right">Total 3,65%</th></tr></thead><tbody>';
      let totRec = 0, totBase = 0, totPIS = 0, totCOF = 0, totT = 0;
      mesesResults.forEach((r, i) => {
        const total = r.pis.devido + r.cofins.devida;
        totRec += r.receitaBrutaMensal; totBase += r.baseCalculo; totPIS += r.pis.devido; totCOF += r.cofins.devida; totT += total;
        html += `<tr><td>${mesesNomes[i]}</td><td class="right mono">${formatMoney(r.receitaBrutaMensal)}</td><td class="right mono">${formatMoney(r.baseCalculo)}</td><td class="right mono">${formatMoney(r.pis.devido)}</td><td class="right mono">${formatMoney(r.cofins.devida)}</td><td class="right mono" style="font-weight:700">${formatMoney(total)}</td></tr>`;
      });
      html += `<tr style="background:var(--bg);font-weight:700"><td>TOTAL</td><td class="right mono">${formatMoney(totRec)}</td><td class="right mono">${formatMoney(totBase)}</td><td class="right mono">${formatMoney(totPIS)}</td><td class="right mono">${formatMoney(totCOF)}</td><td class="right mono">${formatMoney(totT)}</td></tr>`;
      html += '</tbody></table>';
    }
    html += `<div class="info-box info" style="margin-top:12px"><strong>Regime:</strong> Cumulativo | <strong>DARF PIS:</strong> ${mesesResults[0].pis.codigoDARF} | <strong>DARF COFINS:</strong> ${mesesResults[0].cofins.codigoDARF}<br>Vencimento: Dia 25 do mes seguinte ao fato gerador.</div>`;

    // CSRF ‚Äî Retencoes na fonte (Lei 10.833/2003, Arts. 30-35)
    const ret = mesesResults[0].retencoesFonte;
    const totalCSRFAnual = (ret.totalCSRF || 0) * 12;
    if (ret && (ret.pisRetido > 0 || ret.cofinsRetida > 0 || ret.csllRetida > 0 || ret.irrfRetido > 0)) {
      html += `<div class="sec-title" style="margin-top:20px">Retencoes na Fonte (CSRF)</div>`;
      html += `<div class="kpi-grid">
        <div class="kpi"><div class="kpi-label">PIS Retido/mes</div><div class="kpi-value mono">${formatMoney(ret.pisRetido)}</div></div>
        <div class="kpi"><div class="kpi-label">COFINS Retida/mes</div><div class="kpi-value mono">${formatMoney(ret.cofinsRetida)}</div></div>
        <div class="kpi"><div class="kpi-label">CSLL Retida/mes</div><div class="kpi-value mono">${formatMoney(ret.csllRetida)}</div></div>
        <div class="kpi"><div class="kpi-label">Total CSRF/mes</div><div class="kpi-value mono" style="color:var(--accent)">${formatMoney(ret.totalCSRF)}</div><div class="kpi-sub">DARF ${ret.codigoDARFCSRF}</div></div>
      </div>`;
      html += `<div class="info-box warn" style="margin-top:8px">${ret.dispensaCSRF}</div>`;
    }

    // PER/DCOMP ‚Äî Saldo credor
    const perDcomp = mesesResults[0].perDcomp;
    if (perDcomp && perDcomp.temSaldo) {
      html += `<div class="sec-title" style="margin-top:20px">Saldo Credor ‚Äî PER/DCOMP</div>`;
      html += `<div class="kpi-grid">
        <div class="kpi"><div class="kpi-label">Saldo PIS</div><div class="kpi-value mono" style="color:var(--success)">${formatMoney(perDcomp.saldoPIS)}/mes</div></div>
        <div class="kpi"><div class="kpi-label">Saldo COFINS</div><div class="kpi-value mono" style="color:var(--success)">${formatMoney(perDcomp.saldoCOFINS)}/mes</div></div>
        <div class="kpi"><div class="kpi-label">Saldo Anual Estimado</div><div class="kpi-value mono" style="color:var(--success)">${formatMoney((perDcomp.saldoPIS + perDcomp.saldoCOFINS) * 12)}</div></div>
      </div>`;
      html += `<div class="info-box success" style="margin-top:8px"><strong>Credito recuperavel!</strong> ${perDcomp.instrucao}<br><small>${perDcomp.baseLegal}</small></div>`;
    }

    $('tabPiscofins').innerHTML = html;
  } catch(e) {
    $('tabPiscofins').innerHTML = `<div class="info-box danger">${escapeHtml(humanizarErro(e.message))}</div>`;
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TAB: ANUAL
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAnual(d) {
  if (d.receitaBrutaAnual <= 0) { $('tabAnual').innerHTML = '<div class="info-box warn">Informe receitas.</div>'; return; }
  try {
    const dadosTrim = distribuirAnualParaTrimestral(d);
    const dadosMensal = distribuirAnualParaMensal(d);
    const trimestres = [];
    for (let q = 0; q < 4; q++) {
      trimestres.push(dadosTrim);
    }
    const meses = [];
    for (let m = 0; m < 12; m++) {
      meses.push(dadosMensal);
    }
    const socios = d.socios.length ? d.socios : [{ nome: 'S√≥cio √önico', participacao: 1 }];
    const anual = LucroPresumido.calcularAnualConsolidado({
      trimestres,
      meses,
      aliquotaISS: d.aliquotaISSDecimal,
      folhaPagamentoAnual: d.folhaPagamento,
      aliquotaRAT: d.aliquotaRATDecimal,
      aliquotaTerceiros: d.aliquotaTerceirosDecimal,
      lucroContabilEfetivo: d.lucroContabil || null,
      socios
    });
    App.results.anual = anual;
    // KPI cards
    let html = `<div class="kpi-grid">
      <div class="kpi"><div class="kpi-label">Receita Bruta Informada</div><div class="kpi-value" style="color:var(--accent)">${formatMoney(d.receitaBrutaAnual)}</div></div>
      <div class="kpi"><div class="kpi-label">Receita L√≠quida (Base)</div><div class="kpi-value" style="color:var(--accent)">${formatMoney(anual.receitaBrutaAnual)}</div><div class="kpi-sub">Ap√≥s dedu√ß√µes (devolu√ß√µes, cancelamentos, descontos)</div></div>
      <div class="kpi"><div class="kpi-label">Carga Tribut√°ria Total</div><div class="kpi-value" style="color:var(--danger)">${formatMoney(anual.consolidacao.cargaTributariaTotal)}</div><div class="kpi-sub">IRPJ + CSLL + PIS + COFINS + ISS + INSS patronal</div></div>
      <div class="kpi"><div class="kpi-label">% sobre Receita</div><div class="kpi-value" style="color:var(--warn)">${anual.consolidacao.percentualCargaTributaria}</div><div class="kpi-sub">Carga total (todos os tributos)</div></div>
      <div class="kpi"><div class="kpi-label">Lucro Distribu√≠vel Isento</div><div class="kpi-value" style="color:var(--success)">${formatMoney(anual.distribuicaoLucros.lucroDistribuivelFinal)}</div></div>
    </div>`;
    // Tax composition
    html += `<div class="kpi-grid" style="margin-top:8px">
      <div class="kpi"><div class="kpi-label">IRPJ</div><div class="kpi-value mono">${formatMoney(anual.tributos.irpj.anual)}</div></div>
      <div class="kpi"><div class="kpi-label">CSLL</div><div class="kpi-value mono">${formatMoney(anual.tributos.csll.anual)}</div></div>
      <div class="kpi"><div class="kpi-label">PIS</div><div class="kpi-value mono">${formatMoney(anual.tributos.pis.anual)}</div></div>
      <div class="kpi"><div class="kpi-label">COFINS</div><div class="kpi-value mono">${formatMoney(anual.tributos.cofins.anual)}</div></div>
      <div class="kpi"><div class="kpi-label">ISS</div><div class="kpi-value mono">${formatMoney(anual.tributos.iss.anual)}</div></div>
      <div class="kpi"><div class="kpi-label">INSS Patronal</div><div class="kpi-value mono">${formatMoney(anual.tributos.inssPatronal.anual)}</div></div>
    </div>`;
    // Charts
    // LC 224/2025 ‚Äî Resumo no painel anual (s√≥ se receita > R$5M)
    if (d.receitaBrutaAnual > 5000000 && typeof LucroPresumido.calcularBasePresumidaLC224 === 'function') {
      const atividades = LucroPresumido.getAtividadesDisponiveis();
      const ativP = atividades.find(a => a.id === d.atividadeId) || atividades[0];
      let impactoTotal = 0, impostoExtraTotal = 0;
      for (let q = 1; q <= 4; q++) {
        const recTrim = d.receitaBrutaAnual / 4;
        const lc224 = LucroPresumido.calcularBasePresumidaLC224({
          receitaBrutaTrimestral: recTrim,
          receitaBrutaAcumuladaAnoAte: recTrim * q,
          percentualPresuncaoOriginal: ativP.percentualIRPJ,
          trimestreAtual: q,
          anoCalendario: 2026
        });
        impactoTotal += lc224.impactoLC224;
        impostoExtraTotal += lc224.impostoEstimadoExtra || 0;
      }
      if (impactoTotal > 0) {
        html += `<div class="info-box warn" style="margin-top:16px"><strong>LC 224/2025:</strong> Receita acima de R$ 5M gera acrescimo de 10% na base presumida. Impacto anual na base: <strong>+${formatMoney(impactoTotal)}</strong> | Impacto estimado em IRPJ+CSLL: <strong>+${formatMoney(impostoExtraTotal)}</strong><br><small>Vigencia a partir de 01/04/2026. Veja detalhes na aba Trimestral.</small></div>`;
        html += `<div class="info-box danger" style="margin-top:8px"><strong>INSEGURANCA JURIDICA:</strong> A majoracao pela LC 224/2025 e objeto de questionamentos judiciais com liminares concedidas. Consulte advogado tributarista sobre medida judicial para sua empresa.</div>`;
      }
    }

    html += '<div class="chart-grid-2">';
    html += '<div class="chart-wrap"><div class="chart-title">Carga Tribut√°ria por Trimestre</div><canvas id="chartTrimAnual"></canvas></div>';
    html += '<div class="chart-wrap"><div class="chart-title">Composi√ß√£o dos Tributos</div><canvas id="chartComposicao"></canvas></div>';
    html += '</div>';
    html += '<div style="margin-top:16px;padding:12px;background:rgba(100,116,139,.08);border-radius:6px;border-left:3px solid var(--text3)"><p style="font-size:10px;color:var(--text3);line-height:1.5;margin:0"><strong>AVISO LEGAL:</strong> Simula√ß√£o baseada na legisla√ß√£o vigente e nos dados informados. N√ÉO substitui orienta√ß√£o profissional. Valide com contador habilitado antes de qualquer decis√£o fiscal.</p></div>';
    $('tabAnual').innerHTML = html;
    // Render charts
    renderQuarterlyChart(anual);
    renderCompositionChart(anual);
  } catch(e) {
    $('tabAnual').innerHTML = `<div class="info-box danger">${escapeHtml(humanizarErro(e.message))}</div>`;
  }
}

function renderQuarterlyChart(anual) {
  destroyChart('trimAnual');
  const ctx = $('chartTrimAnual');
  if (!ctx || typeof Chart === 'undefined') return;
  const trimData = anual.detalhamentoTrimestral || [];
  const irpjData = trimData.map(t => t.irpjDevido || 0);
  const csllData = trimData.map(t => t.csllDevida || 0);
  App.charts.trimAnual = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['1o Trim', '2o Trim', '3o Trim', '4o Trim'],
      datasets: [
        { label: 'IRPJ', data: irpjData, backgroundColor: 'rgba(239,68,68,.7)' },
        { label: 'CSLL', data: csllData, backgroundColor: 'rgba(245,158,11,.7)' }
      ]
    },
    options: chartOptions('Carga por Trimestre')
  });
}

function renderCompositionChart(anual) {
  destroyChart('composicao');
  const ctx = $('chartComposicao');
  if (!ctx || typeof Chart === 'undefined') return;
  App.charts.composicao = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: ['IRPJ', 'CSLL', 'PIS', 'COFINS', 'ISS', 'INSS Patronal'],
      datasets: [{
        data: [
          anual.tributos.irpj.anual,
          anual.tributos.csll.anual,
          anual.tributos.pis.anual,
          anual.tributos.cofins.anual,
          anual.tributos.iss.anual,
          anual.tributos.inssPatronal.anual
        ],
        backgroundColor: ['#ef4444','#f59e0b','#3b82f6','#8b5cf6','#10b981','#ec4899']
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom', labels: { color: '#94a3b8', font: { size: 11 } } },
        tooltip: { callbacks: { label: ctx => `${ctx.label}: ${formatMoney(ctx.raw)}` } }
      }
    }
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TAB: COMPARATIVO ‚Äî Removido v3.0.0 (ferramenta exclusiva LP)

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TAB: VANTAGENS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderVantagens(d) {
  try {
    const analise = LucroPresumido.analisarVantagensDesvantagens({
      receitaBrutaAnual: d.receitaBrutaAnual,
      despesasOperacionaisAnuais: d.totalDespesas + d.folhaPagamento,
      atividadeId: d.atividadeId,
      areaAtuacaoSUDAM: d.areaAtuacaoSUDAM,
      temInvestimentosEquipamentos: d.temEquipamentos,
      temPesquisaDesenvolvimento: d.temPD,
      temReceitasSazonais: d.receitaSazonal
    });
    App.results.vantagens = analise;
    let html = `<div class="info-box ${analise.analise.startsWith('FAVORAVEL') ? 'success' : 'warn'}" style="margin-bottom:16px"><strong>${analise.analise}</strong><br>Atividade: ${analise.atividade} | Presun√ß√£o: ${analise.percentualPresuncao} | Margem Real: ${analise.margemLucroReal}</div>`;
    html += '<div class="adv-grid">';
    // Vantagens
    html += '<div>';
    html += '<h3 style="color:var(--success);margin-bottom:10px;font-size:14px">Vantagens (' + analise.vantagens.length + ')</h3>';
    analise.vantagens.forEach(v => {
      html += `<div class="adv-card pro" style="margin-bottom:8px"><div class="adv-title">${v.titulo}</div><div class="adv-desc">${v.descricao}</div><div class="adv-impact" style="color:var(--success)">Impacto: ${v.impacto}</div></div>`;
    });
    html += '</div>';
    // Desvantagens
    html += '<div>';
    html += '<h3 style="color:var(--danger);margin-bottom:10px;font-size:14px">Desvantagens (' + analise.desvantagens.length + ')</h3>';
    analise.desvantagens.forEach(v => {
      html += `<div class="adv-card con" style="margin-bottom:8px"><div class="adv-title">${v.titulo}</div><div class="adv-desc">${v.descricao}</div><div class="adv-impact" style="color:var(--danger)">Impacto: ${v.impacto}${v.valorImpacto ? ' | ' + formatMoney(v.valorImpacto) : ''}</div></div>`;
    });
    html += '</div>';
    html += '</div>';
    // Score
    html += `<div style="margin-top:16px;display:flex;gap:12px"><div class="kpi" style="flex:1"><div class="kpi-label">Vantagens Aplic√°veis</div><div class="kpi-value" style="color:var(--success)">${analise.pontuacao.vantagensAplicaveis}</div></div><div class="kpi" style="flex:1"><div class="kpi-label">Desvantagens Aplic√°veis</div><div class="kpi-value" style="color:var(--danger)">${analise.pontuacao.desvantagensAplicaveis}</div></div><div class="kpi" style="flex:1"><div class="kpi-label">Desvantagens Cr√≠ticas</div><div class="kpi-value" style="color:var(--danger)">${analise.pontuacao.desvantagensCriticas}</div></div></div>`;
    $('tabVantagens').innerHTML = html;
  } catch(e) {
    $('tabVantagens').innerHTML = `<div class="info-box danger">${escapeHtml(humanizarErro(e.message))}</div>`;
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TAB: DISTRIBUICAO
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderDistribuicao(d) {
  const anual = App.results.anual;
  if (!anual) { $('tabDistribuicao').innerHTML = '<div class="info-box warn">Calcule os resultados anuais primeiro.</div>'; return; }
  const dist = anual.distribuicaoLucros;
  let html = `<div class="kpi-grid">
    <div class="kpi"><div class="kpi-label">Base Presumida IRPJ (Anual)</div><div class="kpi-value mono">${formatMoney(dist.basePresumidaAnual)}</div></div>
    <div class="kpi"><div class="kpi-label">(-) IRPJ + CSLL Devidos</div><div class="kpi-value mono" style="color:var(--danger)">${formatMoney(dist.tributosDescontados)}</div><div class="kpi-sub">Somente IRPJ e CSLL (Art. 725 RIR/2018)</div></div>
    <div class="kpi"><div class="kpi-label">(=) Lucro Distribu√≠vel Presumido</div><div class="kpi-value mono" style="color:var(--success)">${formatMoney(dist.lucroDistribuivelPresumido)}</div></div>`;
  if (dist.lucroDistribuivelContabil != null) {
    html += `<div class="kpi"><div class="kpi-label">Lucro Cont√°bil Efetivo</div><div class="kpi-value mono">${formatMoney(dist.lucroContabilEfetivo)}</div></div>`;
    html += `<div class="kpi"><div class="kpi-label">Lucro Distribu√≠vel Cont√°bil</div><div class="kpi-value mono" style="color:var(--success)">${formatMoney(dist.lucroDistribuivelContabil)}</div></div>`;
  }
  html += `<div class="kpi"><div class="kpi-label">Lucro Distribu√≠vel Final (Isento IR)</div><div class="kpi-value" style="color:var(--success);font-size:20px">${formatMoney(dist.lucroDistribuivelFinal)}</div><div class="kpi-sub">Base: ${dist.tipoBase}</div></div>`;
  html += '</div>';
  // Per partner table
  if (dist.porSocio && dist.porSocio.length) {
    html += '<table class="dyn-table" style="margin-top:16px"><thead><tr><th>Socio</th><th class="right">%</th><th class="right">Valor Isento</th><th>Base Legal</th></tr></thead><tbody>';
    dist.porSocio.forEach(s => {
      html += `<tr><td>${s.nome}</td><td class="right mono">${s.percentualFormatado}</td><td class="right mono" style="color:var(--success);font-weight:700">${formatMoney(s.valorIsento)}</td><td style="font-size:11px;color:var(--text3)">${s.observacao}</td></tr>`;
    });
    html += '</tbody></table>';
  }
  if (dist.alertaDistribuicao) {
    html += `<div class="info-box warn" style="margin-top:16px"><strong>‚ö† ATEN√á√ÉO ‚Äî Distribui√ß√£o baseada em presun√ß√£o:</strong><br>${dist.alertaDistribuicao}</div>`;
  }
  html += `<div class="info-box info" style="margin-top:16px"><strong>Base legal:</strong> ${dist.baseLegal}<br><br><strong>Base presumida:</strong> Lucro distribuivel isento = Base presumida IRPJ - IRPJ - CSLL devidos (Art. 725 RIR/2018). PIS e COFINS nao entram neste calculo.<br><strong>Base contabil:</strong> Se a empresa possui escrituracao contabil completa (ECD), pode distribuir o lucro contabil efetivo (se maior que o presumido) com isencao de IR. Excedente sem escrituracao e tributado.</div>`;
  $('tabDistribuicao').innerHTML = html;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TAB: RISCOS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderRiscos() {
  const riscos = LucroPresumido.RISCOS_FISCAIS;
  if (!riscos || !riscos.length) { $('tabRiscos').innerHTML = '<div class="info-box info">Nenhum risco fiscal cadastrado.</div>'; return; }
  let html = '<div class="risk-grid">';
  riscos.forEach(r => {
    const sevClass = r.gravidade === 'critica' ? 'critica' : r.gravidade === 'alta' ? 'alta' : 'media';
    const sevColor = r.gravidade === 'critica' ? 'var(--danger)' : r.gravidade === 'alta' ? 'var(--warn)' : 'var(--info)';
    html += `<div class="risk-card ${sevClass}"><div style="display:flex;justify-content:space-between;align-items:center"><div class="risk-title">${r.titulo}</div><span class="badge badge-${r.gravidade === 'critica' ? 'danger' : r.gravidade === 'alta' ? 'warn' : 'info'}">${r.gravidade.toUpperCase()}</span></div><div class="risk-desc">${r.descricao}</div><div style="font-size:12px;color:${sevColor};margin:4px 0"><strong>Consequ√™ncia:</strong> ${r.consequencia}</div><div class="risk-prev"><strong>Preven√ß√£o:</strong> ${r.prevencao}</div></div>`;
  });
  html += '</div>';
  $('tabRiscos').innerHTML = html;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TAB: OBRIGACOES
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderObrigacoes() {
  const obr = LucroPresumido.OBRIGACOES_ACESSORIAS;
  if (!obr) { $('tabObrigacoes').innerHTML = '<div class="info-box info">Dados de obriga√ß√µes n√£o dispon√≠veis.</div>'; return; }
  let html = '<div class="obl-list">';
  Object.entries(obr).forEach(([key, o]) => {
    let alertHtml = '';
    if (o.alerta) {
      alertHtml = `<div style="margin-top:6px;padding:6px 10px;background:rgba(234,179,8,0.12);border-left:3px solid #eab308;border-radius:4px;font-size:11px;color:#eab308">&#9888; ${o.alerta}</div>`;
    }
    html += `<div class="obl-item"><div class="obl-period">${o.periodicidade || 'N/A'}</div><div><div class="obl-name">${o.nome}</div><div class="obl-detail">${o.descricao || ''}<br>Prazo: ${o.prazo || 'N/A'}${o.baseLegal ? '<br><span style="font-size:10px;color:var(--text3)">Base legal: ' + o.baseLegal + '</span>' : ''}${alertHtml}</div></div></div>`;
  });
  html += '</div>';
  // DARF schedule
  html += '<div class="sec-title" style="margin-top:20px">Calend√°rio de DARFs</div>';
  html += '<table class="dyn-table"><thead><tr><th>Tributo</th><th>Codigo DARF</th><th>Periodicidade</th><th>Vencimento</th></tr></thead><tbody>';
  html += `<tr><td>IRPJ Presumido</td><td class="mono">${LucroPresumido.CODIGOS_DARF.IRPJ_PRESUMIDO}</td><td>Trimestral</td><td>Ultimo dia util do mes seguinte ao trimestre</td></tr>`;
  html += `<tr><td>CSLL Presumido</td><td class="mono">${LucroPresumido.CODIGOS_DARF.CSLL_PRESUMIDO}</td><td>Trimestral</td><td>Ultimo dia util do mes seguinte ao trimestre</td></tr>`;
  html += `<tr><td>PIS Cumulativo</td><td class="mono">${LucroPresumido.CODIGOS_DARF.PIS_CUMULATIVO}</td><td>Mensal</td><td>Dia 25 do mes seguinte</td></tr>`;
  html += `<tr><td>COFINS Cumulativo</td><td class="mono">${LucroPresumido.CODIGOS_DARF.COFINS_CUMULATIVO}</td><td>Mensal</td><td>Dia 25 do mes seguinte</td></tr>`;
  if (LucroPresumido.CODIGOS_DARF_RETENCAO) {
    html += `<tr><td>CSRF Retida (PIS+COFINS+CSLL)</td><td class="mono">${LucroPresumido.CODIGOS_DARF_RETENCAO.CSRF_UNIFICADA}</td><td>Mensal</td><td>Dia 20 do mes seguinte ao pagamento</td></tr>`;
    html += `<tr><td>IRRF Servicos</td><td class="mono">${LucroPresumido.CODIGOS_DARF_RETENCAO.IRRF_SERVICOS}</td><td>Mensal</td><td>Dia 20 do mes seguinte ao pagamento</td></tr>`;
  }
  html += '</tbody></table>';
  $('tabObrigacoes').innerHTML = html;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TAB: TRANSICAO
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTransicao(d) {
  const transicoes = LucroPresumido.TRANSICOES;
  if (!transicoes) { $('tabTransicao').innerHTML = '<div class="info-box info">Dados de transi√ß√£o n√£o dispon√≠veis.</div>'; return; }
  let html = '';
  // Show all transitions (comparativo removed in v3.0.0)
  const keysToShow = Object.keys(transicoes);
  keysToShow.forEach(key => {
    const t = transicoes[key];
    if (!t) return;
    html += `<div class="trans-card"><div class="trans-title">${t.descricao}</div><ol class="trans-steps">`;
    (t.procedimentos || []).forEach(p => { html += `<li>${p}</li>`; });
    html += '</ol>';
    if (t.alertas && t.alertas.length) {
      t.alertas.forEach(a => { html += `<div class="trans-alert"><span style="flex-shrink:0">&#9888;</span><span>${a}</span></div>`; });
    }
    if (t.baseLegal) html += `<div style="margin-top:8px;font-size:11px;color:var(--text3)">Base legal: ${t.baseLegal}</div>`;
    html += '</div>';
  });
  if (!html) html = '<div class="info-box info">Nenhuma transi√ß√£o relevante para o cen√°rio atual.</div>';
  $('tabTransicao').innerHTML = html;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TAB: DICAS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderDicas(d) {
  let tips = [];

  // Tentar usar EstudoLP para dicas inteligentes
  if (typeof EstudoLP !== 'undefined' && EstudoLP.gerarDicasInteligentes) {
    try {
      const dicasEstudo = EstudoLP.gerarDicasInteligentes({
        receitaBrutaAnual: d.receitaBrutaAnual,
        atividadeId: d.atividadeId,
        folhaPagamentoAnual: d.folhaPagamento || 0,
        totalDespesasOperacionais: d.totalDespesas || 0,
        creditosPISCOFINS: d.creditosPISCOFINS || 0,
        temEscrituracao: !!d.temEscrituracao,
        temEquipamentos: !!d.temEquipamentos,
        temPD: !!d.temPD,
        receitaSazonal: !!d.receitaSazonal,
        areaAtuacaoSUDAM: !!d.areaAtuacaoSUDAM,
        numReceitas: d.receitas ? d.receitas.length : 1,
        breakeven: App.results.breakeven || null
      });
      // Converter formato EstudoLP ‚Üí formato esperado pelo render
      tips = dicasEstudo.map(dica => ({
        title: dica.titulo,
        desc: dica.descricao + (dica.impactoEstimado ? ' (Impacto estimado: ' + formatMoney(dica.impactoEstimado) + '/ano)' : '')
      }));
    } catch(e) {
      console.warn('EstudoLP.gerarDicasInteligentes falhou, usando fallback:', e.message);
      tips = [];
    }
  }

  // Fallback: se EstudoLP n√£o dispon√≠vel ou retornou vazio, mostrar apenas dicas gen√©ricas (sem c√°lculos)
  if (tips.length === 0) {
    if (d.areaAtuacaoSUDAM) {
      tips.push({ title: 'Voc√™ Est√° em √Årea SUDAM', desc: 'Empresas em √°rea SUDAM podem obter redu√ß√£o de 75% no IRPJ optando pelo Lucro Real.' });
    }
    if (d.areaAtuacaoSUDENE) {
      tips.push({ title: 'Voc√™ Est√° em √Årea SUDENE', desc: 'Empresas em √°rea SUDENE podem obter redu√ß√£o de 75% no IRPJ optando pelo Lucro Real, similar ao benef√≠cio SUDAM.' });
    }
    if (d.zonaFranca) {
      tips.push({ title: 'Zona Franca de Manaus', desc: 'Empresas na ZFM possuem benef√≠cios fiscais espec√≠ficos em ICMS, IPI e PIS/COFINS. Avalie o impacto no planejamento tribut√°rio.' });
    }
    tips.push({ title: 'Regime de Caixa', desc: 'No LP voc√™ pode optar pelo regime de caixa para reconhecimento de receitas (IN RFB 1.700/2017, Art. 223).' });
    if (d.receitas.length > 1) {
      tips.push({ title: 'Atividades Mistas', desc: 'Certifique-se de que cada receita est√° classificada no percentual correto.' });
    }
    tips.push({ title: 'Reforma Tribut√°ria 2026-2033', desc: 'A CBS come√ßa em 2026 com al√≠quota teste de 0,9%. Acompanhe as mudan√ßas.' });
    if (!d.temEscrituracao) {
      tips.push({ title: 'Escritura√ß√£o Cont√°bil Completa', desc: 'Manter a ECD permite distribuir lucros isentos acima da base presumida.' });
    }
    tips.push({ title: 'Motor de Dicas Indispon√≠vel', desc: 'Para an√°lise completa com c√°lculos personalizados, verifique se o arquivo lucro-presumido-estudos.js est√° carregado.' });
  }
  // Render
  let html = '';
  tips.forEach(t => {
    html += `<div class="tip-card"><div class="tip-title">${t.title}</div><div class="tip-desc">${t.desc}</div></div>`;
  });
  $('tabDicas').innerHTML = html;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TAB: PRO-LABORE OTIMO (Etapa 3)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderProLabore(d) {
  const anual = App.results.anual;
  const lucroDistribuivel = anual ? (anual.distribuicaoLucros.lucroDistribuivelFinal || 0) : 0;
  const socios = d.socios && d.socios.length ? d.socios : [{ nome: 'S√≥cio √önico', participacao: 1 }];

  let html = `<div class="info-box warn" style="margin-bottom:16px"><strong>ALERTA LEGAL:</strong> Todo s√≥cio-administrador DEVE receber pr√≥-labore de pelo menos 1 sal√°rio m√≠nimo (R$ 1.621,00 em 2026). A aus√™ncia gera risco de autua√ß√£o pelo INSS com cobran√ßa retroativa.<br><small>Base: IN RFB 971/2009, Art. 57; Decreto 3.048/99, Art. 201</small></div>`;

  // Interactive inputs
  html += `<div style="background:var(--surface);border-radius:var(--r);padding:20px;margin-bottom:20px">
    <h3 style="color:var(--accent);margin-bottom:12px;font-size:14px">Dados do S√≥cio para Simula√ß√£o</h3>
    <div class="fm-grid fm-3">
      <div><label class="fm-label">Socio</label><select class="fm-input" id="plSocioSelect" onchange="recalcProLabore()">`;
  socios.forEach((s, i) => { html += `<option value="${i}">${s.nome || ('S√≥cio ' + (i+1))}</option>`; });
  html += `</select></div>
      <div><label class="fm-label">Pro-labore Atual (R$/mes)</label><div class="fm-prefix"><span>R$</span><input class="fm-input money" id="plAtual" value="5.000,00" oninput="maskMoney(this)"></div></div>
      <div><label class="fm-label">Dependentes IRPF</label><input class="fm-input" id="plDependentes" type="number" min="0" max="10" value="0"></div>
    </div>
    <div class="fm-grid fm-3" style="margin-top:8px">
      <div class="chk-card"><label><input type="checkbox" id="plAdministrador" checked> Socio-administrador</label></div>
      <div class="chk-card"><label><input type="checkbox" id="plOutroVinculo"> Tem outro vinculo CLT</label></div>
      <div><button class="btn-calc" onclick="recalcProLabore()" style="width:100%;margin-top:6px;padding:10px;background:var(--accent);color:#000;border:none;border-radius:6px;font-weight:700;cursor:pointer">Simular</button></div>
    </div>
  </div>`;

  html += '<div id="plResultados"></div>';
  $('tabProlabore').innerHTML = html;

  // Auto-run simulation
  recalcProLabore();
}

function recalcProLabore() {
  const anual = App.results.anual;
  const lucroDistribuivel = anual ? (anual.distribuicaoLucros.lucroDistribuivelFinal || 0) : 0;
  const d = App.formData || {};
  const socios = d.socios && d.socios.length ? d.socios : [{ nome: 'S√≥cio √önico', participacao: 1 }];
  const idx = parseInt($('plSocioSelect') ? $('plSocioSelect').value : '0') || 0;
  const socio = socios[idx] || socios[0];

  const socioData = {
    nome: socio.nome || 'Socio',
    participacao: socio.participacao || 1,
    isAdministrador: $('plAdministrador') ? $('plAdministrador').checked : true,
    proLaboreAtual: parseMoney($('plAtual') ? $('plAtual').value : '5000'),
    temOutroVinculoCLT: $('plOutroVinculo') ? $('plOutroVinculo').checked : false,
    dependentesIRPF: parseInt($('plDependentes') ? $('plDependentes').value : '0') || 0
  };

  try {
    const result = LucroPresumido.simularProLaboreOtimo(socioData, lucroDistribuivel);
    App.results.proLabore = result;
    let html = '';

    // KPIs
    html += `<div class="kpi-grid">
      <div class="kpi"><div class="kpi-label">Pro-Labore Otimo</div><div class="kpi-value" style="color:var(--success)">${formatMoney(result.otimo.proLaboreMensal)}/mes</div></div>
      <div class="kpi"><div class="kpi-label">Economia Anual</div><div class="kpi-value" style="color:${result.economiaAnual > 0 ? 'var(--success)' : 'var(--text2)'}">${formatMoney(result.economiaAnual)}</div></div>
      <div class="kpi"><div class="kpi-label">Tributos Anuais (Otimo)</div><div class="kpi-value" style="color:var(--danger)">${formatMoney(result.otimo.tributosAnuais)}</div></div>
      <div class="kpi"><div class="kpi-label">Liquido Anual (Otimo)</div><div class="kpi-value" style="color:var(--accent)">${formatMoney(result.otimo.liquidoSocioAnual)}</div></div>
    </div>`;

    // Recomendacao
    html += `<div class="info-box success" style="margin:16px 0"><strong>Recomenda√ß√£o:</strong> ${result.recomendacao}</div>`;

    // Alerta de riscos do pro-labore minimo
    if (result.otimo && result.otimo.proLaboreMensal <= 1621) {
      html += `<div class="info-box warn" style="margin:0 0 16px 0"><strong>ATEN√á√ÉO ‚Äî RISCOS DO PR√ì-LABORE M√çNIMO:</strong><br>
        1. <strong>Risco previdenci√°rio:</strong> Pr√≥-labore no sal√°rio m√≠nimo resulta em aposentadoria no piso. Se o s√≥cio n√£o tem outro v√≠nculo CLT ou contribui√ß√£o complementar ao INSS, o benef√≠cio previdenci√°rio ser√° limitado a 1 sal√°rio m√≠nimo.<br>
        2. <strong>Risco de autua√ß√£o:</strong> A RFB pode questionar pr√≥-labore muito baixo em empresas com alta lucratividade, caracterizando distribui√ß√£o disfar√ßada de lucros (Art. 528 RIR/2018). Recomenda-se manter proporcionalidade entre pr√≥-labore e fun√ß√µes exercidas.<br>
        3. <strong>Contribui√ß√£o complementar:</strong> Para garantir benef√≠cios previdenci√°rios maiores, o s√≥cio pode complementar a contribui√ß√£o ao INSS como contribuinte individual (al√≠quota de 20% sobre valor entre o m√≠nimo e o teto).<br>
        <small>Base: IN RFB 971/2009, Art. 57; RIR/2018, Art. 528; Decreto 3.048/99</small></div>`;
    }

    // Tabela de cen√°rios-chave
    html += `<h3 style="color:var(--text);margin:16px 0 8px;font-size:14px">Cenarios-Chave</h3>`;
    html += `<div style="overflow-x:auto"><table class="dyn-table"><thead><tr>
      <th>Cenario</th><th class="right">Pro-Labore</th><th class="right">INSS Patronal</th>
      <th class="right">INSS Retido</th><th class="right">IRPF</th><th class="right">Liquido/mes</th>
      <th class="right">Tributos/ano</th><th class="right">Eficiencia</th>
    </tr></thead><tbody>`;
    result.cenariosChave.forEach(c => {
      const isOtimo = c.proLaboreMensal === result.otimo.proLaboreMensal;
      const rowStyle = isOtimo ? 'background:rgba(16,185,129,.12);font-weight:600' : '';
      html += `<tr style="${rowStyle}">
        <td>${c.label}${isOtimo ? ' ‚òÖ' : ''}</td>
        <td class="right mono">${formatMoney(c.proLaboreMensal)}</td>
        <td class="right mono">${formatMoney(c.inssPatronalMensal)}</td>
        <td class="right mono">${formatMoney(c.inssRetidoMensal)}</td>
        <td class="right mono">${formatMoney(c.irpfMensal)}</td>
        <td class="right mono" style="color:var(--success)">${formatMoney(c.liquidoMensal)}</td>
        <td class="right mono" style="color:var(--danger)">${formatMoney(c.tributosAnuais)}</td>
        <td class="right mono">${c.eficienciaFormatada || '‚Äî'}</td>
      </tr>`;
    });
    html += '</tbody></table></div>';

    // Grafico custo total vs pro-labore
    html += '<div class="chart-wrap" style="margin-top:20px"><div class="chart-title">Custo Total Empresa vs Pro-Labore</div><canvas id="chartProLabore"></canvas></div>';

    // Base legal
    html += `<div class="info-box info" style="margin-top:16px"><strong>Base legal:</strong> ${result.baseLegal}</div>`;

    $('plResultados').innerHTML = html;

    // Render chart
    renderProLaboreChart(result);
  } catch(e) {
    console.error('[IMPOST] Erro pr√≥-labore:', e);
    $('plResultados').innerHTML = `<div class="info-box danger">${escapeHtml(humanizarErro(e.message))}</div>`;
  }
}

function renderProLaboreChart(result) {
  destroyChart('proLabore');
  const ctx = $('chartProLabore');
  if (!ctx || typeof Chart === 'undefined') return;
  // Sample every 4th scenario for readability
  const sampled = result.cenarios.filter((_, i) => i % 4 === 0 || i === result.cenarios.length - 1);
  App.charts.proLabore = new Chart(ctx, {
    type: 'line',
    data: {
      labels: sampled.map(c => 'R$ ' + (c.proLaboreMensal/1000).toFixed(1) + 'k'),
      datasets: [
        {
          label: 'Custo Empresa (anual)',
          data: sampled.map(c => c.custoEmpresaAnual),
          borderColor: '#ef4444',
          backgroundColor: 'rgba(239,68,68,.1)',
          fill: true,
          tension: 0.3
        },
        {
          label: 'Tributos (anual)',
          data: sampled.map(c => c.tributosAnuais),
          borderColor: '#f59e0b',
          backgroundColor: 'rgba(245,158,11,.1)',
          fill: true,
          tension: 0.3
        },
        {
          label: 'L√≠quido S√≥cio (anual)',
          data: sampled.map(c => c.liquidoSocioAnual),
          borderColor: '#10b981',
          backgroundColor: 'rgba(16,185,129,.1)',
          fill: true,
          tension: 0.3
        }
      ]
    },
    options: chartOptions('Custo vs Pro-Labore')
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TAB: JCP / ECD (Etapa 3)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderJcpEcd(d) {
  const anual = App.results.anual;
  const lucroDistribuivel = anual ? (anual.distribuicaoLucros.lucroDistribuivelFinal || 0) : 0;
  const tributosFederais = anual ? (anual.consolidacao.cargaTributariaTotal || 0) : 0;

  let html = '';

  // === SECAO JCP ===
  html += `<h3 style="color:var(--accent);margin-bottom:12px;font-size:16px;border-bottom:1px solid var(--surface);padding-bottom:8px">Simulador de JCP (Juros sobre Capital Proprio)</h3>`;
  html += `<div style="background:var(--surface);border-radius:var(--r);padding:20px;margin-bottom:20px">
    <div class="fm-grid fm-3">
      <div><label class="fm-label">Patrimonio Liquido (PL)</label><div class="fm-prefix"><span>R$</span><input class="fm-input money" id="jcpPL" value="500.000,00" oninput="maskMoney(this)"></div></div>
      <div><label class="fm-label">Taxa TJLP (% a.a.)</label><input class="fm-input" id="jcpTJLP" type="number" min="0" max="30" step="0.01" value="6.12"></div>
      <div><label class="fm-label">Lucro Liquido / Reservas</label><div class="fm-prefix"><span>R$</span><input class="fm-input money" id="jcpLucroReservas" value="300.000,00" oninput="maskMoney(this)"></div></div>
    </div>
    <div class="fm-grid fm-3" style="margin-top:8px">
      <div><label class="fm-label">Data de Referencia</label><input class="fm-input" id="jcpData" type="date" value="2026-06-30"></div>
      <div><label class="fm-label">Lucro Isento Restante</label><div class="fm-prefix"><span>R$</span><input class="fm-input money" id="jcpIsentoRestante" value="${lucroDistribuivel > 0 ? Number(lucroDistribuivel).toLocaleString('pt-BR', {minimumFractionDigits:2}) : '0,00'}" oninput="maskMoney(this)"></div></div>
      <div><button class="btn-calc" onclick="recalcJCP()" style="width:100%;margin-top:18px;padding:10px;background:var(--accent);color:#000;border:none;border-radius:6px;font-weight:700;cursor:pointer">Simular JCP</button></div>
    </div>
  </div>`;
  html += '<div id="jcpResultados"></div>';

  // === SEPARADOR ===
  html += '<hr style="border:none;border-top:2px solid var(--surface);margin:32px 0">';

  // === SECAO ECD ===
  html += `<h3 style="color:var(--accent);margin-bottom:12px;font-size:16px;border-bottom:1px solid var(--surface);padding-bottom:8px">Escritura√ß√£o Completa (ECD) ‚Äî Distribui√ß√£o Ampliada</h3>`;

  // Buscar base presumida para pre-preencher
  const basePresumida = anual && anual.distribuicaoLucros ? (anual.distribuicaoLucros.basePresumidaAnual || 0) : 0;

  html += `<div style="background:var(--surface);border-radius:var(--r);padding:20px;margin-bottom:20px">
    <div class="fm-grid fm-2">
      <div><label class="fm-label">Lucro Cont√°bil Real (do balan√ßo)</label><div class="fm-prefix"><span>R$</span><input class="fm-input money" id="ecdLucroContabil" value="${d.lucroContabil > 0 ? Number(d.lucroContabil).toLocaleString('pt-BR', {minimumFractionDigits:2}) : '0,00'}" oninput="maskMoney(this)"></div></div>
      <div><label class="fm-label">Custo Anual da ECD (honorarios)</label><div class="fm-prefix"><span>R$</span><input class="fm-input money" id="ecdCusto" value="6.000,00" oninput="maskMoney(this)"></div></div>
    </div>
    <div style="margin-top:8px"><button class="btn-calc" onclick="recalcECD()" style="padding:10px 24px;background:var(--accent);color:#000;border:none;border-radius:6px;font-weight:700;cursor:pointer">Calcular Beneficio ECD</button></div>
  </div>`;
  html += '<div id="ecdResultados"></div>';

  $('tabJcpEcd').innerHTML = html;

  // Auto-run
  recalcJCP();
  recalcECD();
}

function recalcJCP() {
  try {
    const result = LucroPresumido.simularJCP({
      patrimonioLiquido: parseMoney($('jcpPL').value),
      taxaTJLP: (parseFloat($('jcpTJLP').value) || 6.12) / 100,
      lucroLiquidoOuReservas: parseMoney($('jcpLucroReservas').value),
      lucroDistribuivelIsentoRestante: parseMoney($('jcpIsentoRestante').value),
      dataReferencia: $('jcpData').value || '2026-06-30'
    });
    App.results.jcp = result;

    let html = `<div class="kpi-grid">
      <div class="kpi"><div class="kpi-label">JCP Maximo Permitido</div><div class="kpi-value" style="color:var(--accent)">${formatMoney(result.jcpBruto)}</div></div>
      <div class="kpi"><div class="kpi-label">IRRF (${result.aliquotaIRRFPercentual}%)</div><div class="kpi-value" style="color:var(--danger)">${formatMoney(result.irrfRetido)}</div></div>
      <div class="kpi"><div class="kpi-label">JCP Liquido</div><div class="kpi-value" style="color:var(--success)">${formatMoney(result.jcpLiquido)}</div></div>
    </div>`;

    // Comparativo 3 vias
    html += `<h4 style="color:var(--text);margin:16px 0 8px;font-size:13px">Comparativo: 3 Formas de Remuneracao</h4>`;
    html += `<div style="overflow-x:auto"><table class="dyn-table"><thead><tr>
      <th>Via</th><th class="right">Valor Bruto</th><th class="right">Custo/Imposto</th>
      <th class="right">Liquido</th><th class="right">Aliq. Efetiva</th>
    </tr></thead><tbody>`;
    const comp = result.comparativo;
    // Distribuicao isenta
    html += `<tr style="background:rgba(16,185,129,.08)">
      <td style="font-weight:600">1. Distribui√ß√£o Isenta</td>
      <td class="right mono">${formatMoney(comp.viaDistribuicaoIsenta.valorBruto)}</td>
      <td class="right mono" style="color:var(--success)">${formatMoney(comp.viaDistribuicaoIsenta.custo)}</td>
      <td class="right mono" style="color:var(--success);font-weight:700">${formatMoney(comp.viaDistribuicaoIsenta.liquido)}</td>
      <td class="right mono">0%</td>
    </tr>`;
    // JCP
    html += `<tr>
      <td style="font-weight:600">2. JCP</td>
      <td class="right mono">${formatMoney(comp.viaJCP.valorBruto)}</td>
      <td class="right mono" style="color:var(--danger)">${formatMoney(comp.viaJCP.custo)}</td>
      <td class="right mono">${formatMoney(comp.viaJCP.liquido)}</td>
      <td class="right mono">${(comp.viaJCP.aliquotaEfetiva * 100).toFixed(1)}%</td>
    </tr>`;
    // Pro-labore
    html += `<tr>
      <td style="font-weight:600">3. Pro-labore Adicional</td>
      <td class="right mono">${formatMoney(comp.viaProlabore.valorBruto)}</td>
      <td class="right mono" style="color:var(--danger)">${formatMoney(comp.viaProlabore.custo)}</td>
      <td class="right mono">${formatMoney(comp.viaProlabore.liquido)}</td>
      <td class="right mono">${(comp.viaProlabore.aliquotaEfetiva * 100).toFixed(1)}%</td>
    </tr>`;
    html += '</tbody></table></div>';

    html += `<div class="info-box ${comp.viaDistribuicaoIsenta.liquido > 0 ? 'success' : 'info'}" style="margin-top:12px"><strong>Recomenda√ß√£o:</strong> ${result.recomendacao}</div>`;
    html += `<div class="info-box info" style="margin-top:8px"><strong>Base legal:</strong> ${result.baseLegal}<br><small>No Lucro Presumido, o JCP NAO reduz a base do IRPJ/CSLL (a base e presumida). E util apenas quando o lucro distribuivel isento ja se esgotou.</small></div>`;

    $('jcpResultados').innerHTML = html;
  } catch(e) {
    $('jcpResultados').innerHTML = `<div class="info-box danger">${escapeHtml(humanizarErro(e.message))}</div>`;
  }
}

function recalcECD() {
  const anual = App.results.anual;
  const tributosDistribuicao = anual ? (
    (anual.tributos.irpj.anual || 0) +
    (anual.tributos.csll.anual || 0)
  ) : 0;
  const basePresumida = anual && anual.distribuicaoLucros ? (anual.distribuicaoLucros.basePresumidaAnual || 0) : 0;

  try {
    const result = LucroPresumido.calcularBeneficioECD({
      basePresumidaAnual: basePresumida,
      lucroContabilReal: parseMoney($('ecdLucroContabil').value),
      tributosFederaisAnuais: tributosDistribuicao,
      custoAnualECD: parseMoney($('ecdCusto').value)
    });
    App.results.ecd = result;

    let html = `<div class="kpi-grid">
      <div class="kpi"><div class="kpi-label">Limite Presumido</div><div class="kpi-value mono">${formatMoney(result.limitePresumido)}</div><div class="kpi-sub">Sem ECD</div></div>
      <div class="kpi"><div class="kpi-label">Limite Contabil</div><div class="kpi-value mono" style="color:var(--accent)">${formatMoney(result.limiteContabil)}</div><div class="kpi-sub">Com ECD</div></div>
      <div class="kpi"><div class="kpi-label">Distribui√ß√£o Extra</div><div class="kpi-value" style="color:${result.distribuicaoExtra > 0 ? 'var(--success)' : 'var(--text3)'}">${formatMoney(result.distribuicaoExtra)}</div><div class="kpi-sub">${result.percentualGanho > 0 ? '+' + result.percentualGanho + '%' : 'Sem ganho'}</div></div>
      <div class="kpi"><div class="kpi-label">Dist. Isenta Adicional (l√≠q.)</div><div class="kpi-value" style="color:${result.valeAPena ? 'var(--success)' : 'var(--danger)'}; font-weight:700">${formatMoney(result.beneficioLiquido)}</div><div class="kpi-sub">${result.valeAPena ? 'VALE A PENA' : 'NAO COMPENSA'}</div></div>
    </div>`;

    html += `<div style="margin-top:8px;padding:10px 14px;background:rgba(100,116,139,.08);border-left:3px solid var(--info);border-radius:4px;font-size:12px;color:var(--text2)">` +
      `<strong>O que significa este valor:</strong> √â o valor adicional que poder√° ser distribu√≠do aos s√≥cios ` +
      `<strong>sem incid√™ncia de IRPF</strong>, descontado o custo da escritura√ß√£o. N√£o √© uma redu√ß√£o direta de impostos da empresa ‚Äî ` +
      `√© uma amplia√ß√£o da distribui√ß√£o isenta de lucros (Art. 725, ¬ß2¬∫ RIR/2018). A economia real depende da faixa de IRPF de cada s√≥cio.</div>`;
    html += `<div class="info-box ${result.valeAPena ? 'success' : 'warn'}" style="margin-top:12px"><strong>Resultado:</strong> ${result.recomendacao}</div>`;
    html += `<div class="info-box info" style="margin-top:8px"><strong>Base legal:</strong> ${result.baseLegal}<br><small>Sem ECD, a distribui√ß√£o isenta fica limitada √† base PRESUMIDA. Com ECD (escritura√ß√£o cont√°bil completa), o limite passa a ser o lucro CONT√ÅBIL REAL ‚Äî vantajoso quando a margem real supera a presun√ß√£o.</small></div>`;

    $('ecdResultados').innerHTML = html;
  } catch(e) {
    $('ecdResultados').innerHTML = `<div class="info-box danger">${escapeHtml(humanizarErro(e.message))}</div>`;
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TAB: CAIXA vs COMPETENCIA (Etapa 3)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCaixaComp(d) {
  const meses = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
  const receitaMensal = d.receitaBrutaAnual / 12;

  let html = `<h3 style="color:var(--accent);margin-bottom:12px;font-size:16px">Regime de Caixa vs Competencia</h3>`;
  html += `<div class="info-box info" style="margin-bottom:16px">Empresas no LP podem optar por reconhecer receitas pelo <strong>recebimento (caixa)</strong> em vez do <strong>faturamento (competencia)</strong>. Nao muda o total de impostos, mas posterga o pagamento.<br><small>Base: IN RFB 1.700/2017, Art. 223</small></div>`;

  // Estimativa inteligente de recebimentos: 70% no m√™s, 30% no m√™s seguinte
  const recEstimados = [];
  for (let i = 0; i < 12; i++) {
    const recebidoMes = receitaMensal * 0.70; // 70% √† vista
    const recebidoAnterior = i > 0 ? receitaMensal * 0.30 : 0; // 30% do m√™s anterior
    recEstimados.push(recebidoMes + recebidoAnterior);
  }

  html += `<div class="info-box warn" style="margin-bottom:12px"><strong>Estimativa automatica:</strong> Os recebimentos foram preenchidos com defasagem de 30 dias (70% no mes do faturamento + 30% no mes seguinte). Ajuste conforme sua realidade. Mude os valores ou clique "Exemplo com defasagem" para cenario padrao.</div>`;

  // Inputs: 2 columns, 12 months
  html += `<div style="background:var(--surface);border-radius:var(--r);padding:20px;margin-bottom:20px">
    <div style="display:grid;grid-template-columns:60px 1fr 1fr;gap:4px;align-items:center">
      <div style="font-weight:600;font-size:11px;color:var(--text3)">Mes</div>
      <div style="font-weight:600;font-size:11px;color:var(--text3);text-align:center">Faturado (R$)</div>
      <div style="font-weight:600;font-size:11px;color:var(--text3);text-align:center">Recebido (R$)</div>`;
  for (let i = 0; i < 12; i++) {
    const valFat = Number(receitaMensal).toLocaleString('pt-BR', {minimumFractionDigits:2});
    const valRec = Number(recEstimados[i]).toLocaleString('pt-BR', {minimumFractionDigits:2});
    html += `<div style="font-size:12px;font-weight:600;color:var(--text2)">${meses[i]}</div>
      <input class="fm-input money" id="cxFat${i}" value="${valFat}" oninput="maskMoney(this)" style="font-size:12px;padding:6px 8px;text-align:right">
      <input class="fm-input money" id="cxRec${i}" value="${valRec}" oninput="maskMoney(this)" style="font-size:12px;padding:6px 8px;text-align:right">`;
  }
  html += `</div>
    <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
      <button class="btn-calc" onclick="recalcCaixaComp()" style="padding:10px 24px;background:var(--accent);color:#000;border:none;border-radius:6px;font-weight:700;cursor:pointer">Calcular</button>
      <button onclick="preencherCaixaExemplo()" style="padding:10px 16px;background:var(--surface);color:var(--text2);border:1px solid var(--text3);border-radius:6px;cursor:pointer;font-size:12px">Exemplo com defasagem</button>
    </div>
  </div>`;

  html += '<div id="cxResultados"></div>';
  $('tabCaixaComp').innerHTML = html;

  // Auto-run
  recalcCaixaComp();
}

function preencherCaixaExemplo() {
  const d = App.formData || {};
  const mensal = d.receitaBrutaAnual / 12 || 100000;
  // Faturado: uniforme; Recebido: defasado 30-60 dias (30% vem no mes seguinte)
  for (let i = 0; i < 12; i++) {
    const fatEl = $('cxFat' + i);
    if (fatEl) fatEl.value = Number(mensal).toLocaleString('pt-BR', {minimumFractionDigits:2});
    const recEl = $('cxRec' + i);
    if (recEl) {
      const recebido = i === 0
        ? mensal * 0.70  // primeiro mes: so 70%
        : i === 11
          ? mensal * 1.30  // ultimo mes: recebe atrasados
          : mensal;
      recEl.value = Number(recebido).toLocaleString('pt-BR', {minimumFractionDigits:2});
    }
  }
  recalcCaixaComp();
}

function recalcCaixaComp() {
  const fat = [];
  const rec = [];
  for (let i = 0; i < 12; i++) {
    fat.push(parseMoney($('cxFat' + i) ? $('cxFat' + i).value : '0'));
    rec.push(parseMoney($('cxRec' + i) ? $('cxRec' + i).value : '0'));
  }

  const d = App.formData || {};
  try {
    const result = LucroPresumido.simularRegimeCaixa({
      faturamentoMensal: fat,
      recebimentoMensal: rec,
      atividadeId: d.atividadeId || 'servicos_gerais'
    });
    App.results.caixaComp = result;

    let html = '';

    // KPIs
    html += `<div class="kpi-grid">
      <div class="kpi"><div class="kpi-label">Total Faturado</div><div class="kpi-value mono">${formatMoney(result.totalFaturado)}</div></div>
      <div class="kpi"><div class="kpi-label">Total Recebido</div><div class="kpi-value mono">${formatMoney(result.totalRecebido)}</div></div>
      <div class="kpi"><div class="kpi-label">Total Diferido</div><div class="kpi-value" style="color:${result.totalDiferido > 0 ? 'var(--success)' : 'var(--warn)'};font-weight:700">${formatMoney(result.totalDiferido)}</div><div class="kpi-sub">Postergacao de tributos</div></div>
    </div>`;

    // Recomendacao
    html += `<div class="info-box ${result.totalDiferido > 0 ? 'success' : 'warn'}" style="margin:12px 0"><strong>Resultado:</strong> ${result.recomendacao}</div>`;

    // Tabela trimestral comparativa
    html += `<h4 style="color:var(--text);margin:16px 0 8px;font-size:13px">Comparativo Trimestral (IRPJ + CSLL + PIS + COFINS)</h4>`;
    html += `<div style="overflow-x:auto"><table class="dyn-table"><thead><tr>
      <th>Trimestre</th><th class="right">Competencia</th><th class="right">Caixa</th><th class="right">Diferenca</th>
    </tr></thead><tbody>`;
    let totalComp = 0, totalCaixa = 0;
    result.trimestresComparativo.forEach(t => {
      totalComp += t.competencia.total;
      totalCaixa += t.caixa.total;
      const dif = t.diferenca;
      html += `<tr>
        <td>${t.trimestre}o Trimestre</td>
        <td class="right mono">${formatMoney(t.competencia.total)}</td>
        <td class="right mono">${formatMoney(t.caixa.total)}</td>
        <td class="right mono" style="color:${dif > 0 ? 'var(--success)' : dif < 0 ? 'var(--danger)' : 'var(--text3)'}">${dif > 0 ? '+' : ''}${formatMoney(dif)}</td>
      </tr>`;
    });
    html += `<tr style="font-weight:700;border-top:2px solid var(--accent)">
      <td>TOTAL ANUAL</td>
      <td class="right mono">${formatMoney(totalComp)}</td>
      <td class="right mono">${formatMoney(totalCaixa)}</td>
      <td class="right mono" style="color:${result.totalDiferido > 0 ? 'var(--success)' : 'var(--text3)'}">${result.totalDiferido > 0 ? '+' : ''}${formatMoney(result.totalDiferido)}</td>
    </tr>`;
    html += '</tbody></table></div>';

    // Grafico
    html += '<div class="chart-wrap" style="margin-top:20px"><div class="chart-title">PIS/COFINS Mensal: Competencia vs Caixa</div><canvas id="chartCaixaComp"></canvas></div>';

    // Requisitos
    html += `<div class="info-box warn" style="margin-top:16px"><strong>Requisitos para optar pelo Regime de Caixa:</strong><ul style="margin:8px 0 0 16px">`;
    result.requisitos.forEach(r => { html += `<li style="margin-bottom:4px">${r}</li>`; });
    html += `</ul></div>`;
    html += `<div class="info-box info" style="margin-top:8px"><strong>Base legal:</strong> ${result.baseLegal}</div>`;

    $('cxResultados').innerHTML = html;

    // Render chart
    renderCaixaCompChart(result);
  } catch(e) {
    $('cxResultados').innerHTML = `<div class="info-box danger">${escapeHtml(humanizarErro(e.message))}</div>`;
  }
}

function renderCaixaCompChart(result) {
  destroyChart('caixaComp');
  const ctx = $('chartCaixaComp');
  if (!ctx || typeof Chart === 'undefined') return;
  const meses = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
  App.charts.caixaComp = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: meses,
      datasets: [
        {
          label: 'Competencia',
          data: result.competencia.tributosMensais.map(t => t.totalPisCofins),
          backgroundColor: 'rgba(239,68,68,.6)'
        },
        {
          label: 'Caixa',
          data: result.caixa.tributosMensais.map(t => t.totalPisCofins),
          backgroundColor: 'rgba(16,185,129,.6)'
        }
      ]
    },
    options: chartOptions('PIS/COFINS Mensal')
  });
}

function renderBreakeven(d) {
  const fd = App.formData || d || {};
  const anual = App.results.anual;
  if (!anual) { $('tabBreakeven').innerHTML = '<p style="color:var(--text3)">Calcule os resultados primeiro.</p>'; return; }

  try {
    if (typeof EstudoLP === 'undefined' || !EstudoLP.calcularBreakEven) {
      $('tabBreakeven').innerHTML = '<div class="info-box danger">Motor EstudoLP n√£o dispon√≠vel. Verifique se o arquivo lucro-presumido-estudos.js est√° carregado corretamente.</div>';
      return;
    }
    const cargaLP = anual.consolidacao ? anual.consolidacao.cargaTributariaTotal : 0;
    const resultado = EstudoLP.calcularBreakEven({
      receitaBrutaAnual: fd.receitaBrutaAnual,
      cargaTributariaLP: cargaLP,
      folhaPagamentoAnual: fd.folhaPagamento || 0,
      totalDespesasOperacionais: fd.totalDespesas || 0,
      creditosPISCOFINS: fd.creditosPISCOFINS || 0,
      aliquotaISS: fd.aliquotaISS || 5,
      aliquotaRAT: fd.aliquotaRAT || 3,
      aliquotaTerceiros: fd.aliquotaTerceiros || 0.5
    });
    if (!resultado) { $('tabBreakeven').innerHTML = '<div class="info-box warn">Informe receitas para calcular o break-even.</div>'; return; }
    App.results.breakeven = resultado;

    let html = '<div class="wz-card"><h3 style="color:var(--accent);margin-bottom:16px">Break-Even: LP vs Lucro Real</h3>';

    // Alerta inteligente
    if (resultado.alerta) {
      html += `<div style="background:var(--danger-l);border:1px solid var(--danger-b);border-radius:var(--r);padding:14px;margin-bottom:16px">
        <strong style="color:var(--danger)">ALERTA</strong>
        <p style="color:var(--text);margin-top:4px;font-size:13px">${resultado.alerta}</p>
      </div>`;
    }

    // KPI cards - Break-Even, Carga LP, Margem Real
    const beLabel = resultado.breakEvenMargem ? resultado.breakEvenMargem + '%' : (resultado.lpSempreVantajoso ? 'LP sempre melhor' : (resultado.lrSempreVantajoso ? 'LR sempre melhor' : 'N/A'));
    const beColor = resultado.lpSempreVantajoso ? 'var(--success)' : (resultado.lrSempreVantajoso ? 'var(--danger)' : 'var(--warn)');
    const beFontSize = resultado.breakEvenMargem ? '22px' : '14px';
    // Margem real: verde se acima do break-even (LP OK), vermelho se abaixo
    const margemReal = resultado.margemOperacionalBruta != null ? resultado.margemOperacionalBruta : resultado.margemRealAtual;
    const mrColor = margemReal != null && resultado.breakEvenMargem
      ? (margemReal >= resultado.breakEvenMargem ? 'var(--success)' : 'var(--danger)')
      : 'var(--info)';
    html += `<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:20px">
      <div style="background:var(--surface);border-radius:var(--r);padding:16px;text-align:center">
        <div style="font-size:11px;color:var(--text3)">Carga no LP (fixa)</div>
        <div style="font-size:22px;font-weight:700;font-family:var(--mono);color:var(--accent)">${formatMoney(resultado.cargaTributariaLP)}</div>
      </div>
      <div style="background:var(--surface);border-radius:var(--r);padding:16px;text-align:center">
        <div style="font-size:11px;color:var(--text3)">Break-Even</div>
        <div style="font-size:${beFontSize};font-weight:700;font-family:var(--mono);color:${beColor}">${beLabel}</div>
        ${resultado.breakEvenMargem ? '<div style="font-size:10px;color:var(--text3)">Abaixo: LR melhor | Acima: LP melhor</div>' : ''}
      </div>
      <div style="background:var(--surface);border-radius:var(--r);padding:16px;text-align:center">
        <div style="font-size:11px;color:var(--text3)">Margem Real Estimada</div>
        <div style="font-size:22px;font-weight:700;font-family:var(--mono);color:${mrColor}">${margemReal != null ? margemReal + '%' : '-'}</div>
      </div>
    </div>`;

    // Recomenda√ß√£o
    html += `<div style="background:var(--info-l);border:1px solid var(--info-b);border-radius:var(--r);padding:14px;margin-bottom:16px">
      <p style="color:var(--text);font-size:13px">${resultado.recomendacao}</p>
      <p style="color:var(--text3);font-size:11px;margin-top:6px">${resultado.baseLegal}</p>
    </div>`;

    // Gr√°fico
    html += '<div style="margin-top:16px"><canvas id="chartBreakeven" height="200"></canvas></div>';
    html += '</div>';

    $('tabBreakeven').innerHTML = html;
    renderBreakevenChart(resultado);
  } catch(e) {
    console.error('[IMPOST] Erro break-even:', e);
    $('tabBreakeven').innerHTML = '<div class="wz-card"><p style="color:var(--danger)">' + escapeHtml(humanizarErro(e.message)) + '</p></div>';
  }
}

function renderBreakevenChart(resultado) {
  destroyChart('breakeven');
  const ctx = $('chartBreakeven');
  if (!ctx || typeof Chart === 'undefined') return;

  // Filtrar margens a cada 5% para legibilidade
  const margensFiltered = resultado.margens.filter(m => m.margem % 5 === 0 || m.margem === resultado.breakEvenMargem);
  const labels = margensFiltered.map(m => m.margem + '%');

  App.charts.breakeven = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Carga LP (fixa)',
          data: margensFiltered.map(m => m.cargaLP),
          borderColor: '#f59e0b',
          backgroundColor: 'rgba(245,158,11,.1)',
          borderWidth: 2,
          fill: false,
          pointRadius: 2
        },
        {
          label: 'Carga LR (variavel)',
          data: margensFiltered.map(m => m.cargaLR),
          borderColor: '#3b82f6',
          backgroundColor: 'rgba(59,130,246,.1)',
          borderWidth: 2,
          fill: false,
          pointRadius: 2
        }
      ]
    },
    options: {
      ...chartOptions('LP vs LR por Margem'),
      plugins: {
        ...chartOptions('').plugins,
        annotation: resultado.breakEvenMargem ? {
          annotations: { breakeven: {
            type: 'line', xMin: resultado.breakEvenMargem + '%', xMax: resultado.breakEvenMargem + '%',
            borderColor: '#ef4444', borderWidth: 2, borderDash: [5,5],
            label: { display: true, content: 'Break-Even', position: 'start', color: '#ef4444' }
          }}
        } : undefined
      }
    }
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 9C. CALENDARIO TRIBUTARIO (Etapa 4)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCalendario(d) {
  const fd = App.formData || d || {};
  const anual = App.results.anual;
  if (!anual) { $('tabCalendario').innerHTML = '<p style="color:var(--text3)">Calcule os resultados primeiro.</p>'; return; }

  try {
    const folhaMensal = (fd.folhaPagamento || 0) / 12;
    const inssPatronalDecimal = LucroPresumido.ALIQUOTA_INSS_PATRONAL || 0.20;
    const aliqINSSTotal = (fd.aliquotaRATDecimal || 0.03) + (fd.aliquotaTerceirosDecimal || 0.005) + inssPatronalDecimal;
    const taxaSelic = LucroPresumido.TAXA_SELIC_MENSAL_ESTIMADA || 0.01;

    const resultado = LucroPresumido.gerarCalendarioTributario({
      anualConsolidado: anual,
      anoCalendario: 2026,
      aliquotaISS: fd.aliquotaISSDecimal || 0.05,
      folhaPagamentoMensal: folhaMensal,
      aliquotaINSSTotal: aliqINSSTotal,
      diaVencimentoISS: 15,
      parcelarIRPJCSLL: !!$('chkParcelar') && $('chkParcelar').checked,
      taxaSelicMensal: taxaSelic
    });
    App.results.calendario = resultado;

    let html = '<div class="wz-card"><h3 style="color:var(--accent);margin-bottom:16px">Calend√°rio Tribut√°rio ' + resultado.anoCalendario + '</h3>';

    // Toggle parcelamento
    html += `<div style="margin-bottom:16px">
      <div style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="chkParcelar" onchange="renderCalendario(App)" ${resultado.parcelamento ? 'checked' : ''}>
        <label for="chkParcelar" style="font-size:13px;color:var(--text2)">Parcelar IRPJ/CSLL em at√© 3 quotas</label>
      </div>
      <div style="font-size:11px;color:var(--text3);margin-top:4px;margin-left:24px">Quota √∫nica: sem acr√©scimo. 2¬™ e 3¬™ quotas: acrescidas de juros SELIC acumulada + 1% (Lei 9.430/96, Art. 6¬∫, ¬ß2¬∫). Quota m√≠nima: R$ 1.000,00. Taxa SELIC estimada: 1%/m√™s.</div>
    </div>`;

    // Resumo
    html += `<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px">
      <div style="background:var(--surface);border-radius:var(--r);padding:14px;text-align:center">
        <div style="font-size:11px;color:var(--text3)">Total Anual</div>
        <div style="font-size:20px;font-weight:700;font-family:var(--mono);color:var(--accent)">${formatMoney(resultado.totais.total)}</div>
      </div>
      <div style="background:var(--surface);border-radius:var(--r);padding:14px;text-align:center">
        <div style="font-size:11px;color:var(--text3)">Media Mensal</div>
        <div style="font-size:20px;font-weight:700;font-family:var(--mono);color:var(--text)">${formatMoney(resultado.mediaMensal)}</div>
      </div>
      <div style="background:var(--surface);border-radius:var(--r);padding:14px;text-align:center">
        <div style="font-size:11px;color:var(--text3)">Pico de Caixa</div>
        <div style="font-size:20px;font-weight:700;font-family:var(--mono);color:var(--danger)">${resultado.picosCaixa[0] ? formatMoney(resultado.picosCaixa[0].valor) : '-'}</div>
        <div style="font-size:10px;color:var(--text3)">${resultado.picosCaixa[0] ? resultado.picosCaixa[0].mes : ''}</div>
      </div>
    </div>`;

    // Tabela 12 meses x tributos
    html += '<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:12px">';
    html += '<thead><tr style="background:var(--surface)">';
    html += '<th style="padding:8px;text-align:left;color:var(--text3);border-bottom:1px solid var(--border-l)">Mes</th>';
    html += '<th style="padding:8px;text-align:right;color:var(--text3);border-bottom:1px solid var(--border-l)">PIS<br><small>8109</small></th>';
    html += '<th style="padding:8px;text-align:right;color:var(--text3);border-bottom:1px solid var(--border-l)">COFINS<br><small>2172</small></th>';
    html += '<th style="padding:8px;text-align:right;color:var(--text3);border-bottom:1px solid var(--border-l)">IRPJ<br><small>2089</small></th>';
    html += '<th style="padding:8px;text-align:right;color:var(--text3);border-bottom:1px solid var(--border-l)">CSLL<br><small>2372</small></th>';
    html += '<th style="padding:8px;text-align:right;color:var(--text3);border-bottom:1px solid var(--border-l)">ISS</th>';
    html += '<th style="padding:8px;text-align:right;color:var(--text3);border-bottom:1px solid var(--border-l)">INSS<br><small>GPS</small></th>';
    html += '<th style="padding:8px;text-align:right;color:var(--accent);border-bottom:1px solid var(--border-l);font-weight:700">TOTAL</th>';
    html += '<th style="padding:8px;text-align:right;color:var(--text3);border-bottom:1px solid var(--border-l)">Acumulado</th>';
    html += '</tr></thead><tbody>';

    resultado.calendario.forEach(m => {
      const isQuarterly = m.tributos.irpj.valor > 0;
      const bgRow = isQuarterly ? 'background:rgba(245,158,11,.05)' : '';
      html += `<tr style="${bgRow}">`;
      html += `<td style="padding:8px;font-weight:600;border-bottom:1px solid var(--border-l)">${m.mesNome.substring(0,3)}</td>`;
      html += `<td style="padding:8px;text-align:right;font-family:var(--mono);border-bottom:1px solid var(--border-l)">${formatMoney(m.tributos.pis.valor)}</td>`;
      html += `<td style="padding:8px;text-align:right;font-family:var(--mono);border-bottom:1px solid var(--border-l)">${formatMoney(m.tributos.cofins.valor)}</td>`;
      html += `<td style="padding:8px;text-align:right;font-family:var(--mono);border-bottom:1px solid var(--border-l);${m.tributos.irpj.valor > 0 ? 'color:var(--warn);font-weight:700' : ''}">${m.tributos.irpj.valor > 0 ? formatMoney(m.tributos.irpj.valor) : '-'}</td>`;
      html += `<td style="padding:8px;text-align:right;font-family:var(--mono);border-bottom:1px solid var(--border-l);${m.tributos.csll.valor > 0 ? 'color:var(--warn);font-weight:700' : ''}">${m.tributos.csll.valor > 0 ? formatMoney(m.tributos.csll.valor) : '-'}</td>`;
      html += `<td style="padding:8px;text-align:right;font-family:var(--mono);border-bottom:1px solid var(--border-l)">${formatMoney(m.tributos.iss.valor)}</td>`;
      html += `<td style="padding:8px;text-align:right;font-family:var(--mono);border-bottom:1px solid var(--border-l)">${formatMoney(m.tributos.inssPatronal.valor)}</td>`;
      html += `<td style="padding:8px;text-align:right;font-family:var(--mono);font-weight:700;color:var(--accent);border-bottom:1px solid var(--border-l)">${formatMoney(m.totalMes)}</td>`;
      html += `<td style="padding:8px;text-align:right;font-family:var(--mono);color:var(--text3);border-bottom:1px solid var(--border-l)">${formatMoney(m.totalAcumulado)}</td>`;
      html += '</tr>';
    });

    // Totais
    const t = resultado.totais;
    html += `<tr style="background:var(--surface);font-weight:700">`;
    html += `<td style="padding:8px;border-top:2px solid var(--border)">TOTAL</td>`;
    html += `<td style="padding:8px;text-align:right;font-family:var(--mono);border-top:2px solid var(--border)">${formatMoney(t.pis)}</td>`;
    html += `<td style="padding:8px;text-align:right;font-family:var(--mono);border-top:2px solid var(--border)">${formatMoney(t.cofins)}</td>`;
    html += `<td style="padding:8px;text-align:right;font-family:var(--mono);border-top:2px solid var(--border)">${formatMoney(t.irpj)}</td>`;
    html += `<td style="padding:8px;text-align:right;font-family:var(--mono);border-top:2px solid var(--border)">${formatMoney(t.csll)}</td>`;
    html += `<td style="padding:8px;text-align:right;font-family:var(--mono);border-top:2px solid var(--border)">${formatMoney(t.iss)}</td>`;
    html += `<td style="padding:8px;text-align:right;font-family:var(--mono);border-top:2px solid var(--border)">${formatMoney(t.inssPatronal)}</td>`;
    html += `<td style="padding:8px;text-align:right;font-family:var(--mono);color:var(--accent);border-top:2px solid var(--border)">${formatMoney(t.total)}</td>`;
    html += `<td style="padding:8px;border-top:2px solid var(--border)"></td>`;
    html += '</tr></tbody></table></div>';

    // C√≥digos DARF
    html += `<div style="margin-top:16px;padding:12px;background:var(--info-l);border:1px solid var(--info-b);border-radius:var(--r)">
      <p style="font-size:12px;color:var(--text2);margin-bottom:4px"><strong>C√≥digos DARF:</strong> PIS: 8109 | COFINS: 2172 | IRPJ: 2089 | CSLL: 2372</p>
      <p style="font-size:11px;color:var(--text3)">CSRF Retencoes: 5952 (PIS 0,65% + COFINS 3% + CSLL 1%). Dispensa: pagamentos &#8804; R$ 5.000/mes ao mesmo fornecedor.</p>
    </div>`;

    // Nota explicativa: diferen√ßa entre total do calend√°rio e carga tribut√°ria total
    const cargaTotalConsolidado = anual && anual.consolidacao ? anual.consolidacao.cargaTributariaTotal : 0;
    const diffCalendario = Math.abs(t.total - cargaTotalConsolidado);
    if (diffCalendario > 1) {
      html += `<div style="margin-top:12px;padding:10px 14px;background:rgba(255,243,205,.1);border-left:4px solid #FFC107;border-radius:4px;font-size:12px;color:var(--text2)">` +
        `<strong style="color:#FFC107">Nota:</strong> O total do calend√°rio (${formatMoney(t.total)}) pode diferir da carga tribut√°ria consolidada (${formatMoney(cargaTotalConsolidado)}) ` +
        `devido a acr√©scimos de SELIC no parcelamento de quotas, arredondamentos trimestrais ou diferen√ßas no rateio mensal do INSS patronal (GPS/eSocial). ` +
        `A carga na aba <strong>Anual</strong> √© o valor de refer√™ncia.</div>`;
    }

    // Obriga√ß√µes Acess√≥rias com prazos
    const obrigacoes = LucroPresumido.OBRIGACOES_ACESSORIAS;
    if (obrigacoes) {
      html += '<div style="margin-top:24px;padding-top:16px;border-top:2px solid var(--surface)">';
      html += '<h4 style="color:var(--accent);margin-bottom:12px;font-size:14px">Obriga√ß√µes Acess√≥rias ‚Äî Prazos</h4>';
      html += '<table class="dyn-table"><thead><tr><th>Obrigacao</th><th>Periodicidade</th><th>Prazo</th><th>Base Legal</th></tr></thead><tbody>';
      Object.entries(obrigacoes).forEach(([key, o]) => {
        const hasAlert = o.alerta ? `<div style="margin-top:4px;font-size:10px;color:var(--warn)">&#9888; ${o.alerta}</div>` : '';
        html += `<tr><td style="font-weight:600">${o.nome}${hasAlert}</td><td>${o.periodicidade || 'N/A'}</td><td style="font-family:var(--mono);font-size:12px">${o.prazo || 'N/A'}</td><td style="font-size:11px;color:var(--text3)">${o.baseLegal || ''}</td></tr>`;
      });
      html += '</tbody></table>';

      // Alerta DIRF substitu√≠da
      if (obrigacoes.DIRF && obrigacoes.DIRF.alerta) {
        html += `<div class="info-box warn" style="margin-top:12px"><strong>ATENCAO ‚Äî DIRF:</strong> ${obrigacoes.DIRF.alerta}<br><small>A partir de 2025, as informacoes da DIRF sao prestadas via EFD-Reinf (eventos R-4000) e eSocial. Mantenha ambas as obrigacoes em dia.</small></div>`;
      }

      // EFD-Reinf destaque
      if (obrigacoes.EFD_REINF) {
        html += `<div class="info-box info" style="margin-top:8px"><strong>EFD-Reinf:</strong> ${obrigacoes.EFD_REINF.nome} ‚Äî ${obrigacoes.EFD_REINF.prazo}. ${obrigacoes.EFD_REINF.descricao || ''}<br><small>${obrigacoes.EFD_REINF.baseLegal || ''}</small></div>`;
      }
      html += '</div>';
    }

    // Observa√ß√µes
    html += '<div style="margin-top:12px">';
    resultado.observacoes.forEach(obs => {
      html += `<p style="font-size:11px;color:var(--text3);margin-bottom:2px">‚Ä¢ ${obs}</p>`;
    });
    html += '</div>';

    // Gr√°fico barras
    html += '<div style="margin-top:20px"><canvas id="chartCalendario" height="180"></canvas></div>';
    html += '</div>';

    $('tabCalendario').innerHTML = html;
    renderCalendarioChart(resultado);
  } catch(e) {
    console.error('[IMPOST] Erro calend√°rio:', e);
    $('tabCalendario').innerHTML = '<div class="wz-card"><p style="color:var(--danger)">' + escapeHtml(humanizarErro(e.message)) + '</p></div>';
  }
}

function renderCalendarioChart(resultado) {
  destroyChart('calendario');
  const ctx = $('chartCalendario');
  if (!ctx || typeof Chart === 'undefined') return;
  const labels = resultado.calendario.map(m => m.mesNome.substring(0,3));
  App.charts.calendario = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        { label: 'PIS+COFINS', data: resultado.calendario.map(m => m.tributos.pis.valor + m.tributos.cofins.valor), backgroundColor: 'rgba(59,130,246,.6)', stack: 'a' },
        { label: 'IRPJ', data: resultado.calendario.map(m => m.tributos.irpj.valor), backgroundColor: 'rgba(245,158,11,.6)', stack: 'a' },
        { label: 'CSLL', data: resultado.calendario.map(m => m.tributos.csll.valor), backgroundColor: 'rgba(239,68,68,.6)', stack: 'a' },
        { label: 'ISS', data: resultado.calendario.map(m => m.tributos.iss.valor), backgroundColor: 'rgba(139,92,246,.6)', stack: 'a' },
        { label: 'INSS', data: resultado.calendario.map(m => m.tributos.inssPatronal.valor), backgroundColor: 'rgba(16,185,129,.6)', stack: 'a' }
      ]
    },
    options: { ...chartOptions('Sa√≠da de Caixa Mensal'), scales: { ...chartOptions('').scales, x: { stacked: true, ticks: { color: '#64748b' }, grid: { color: 'rgba(100,116,139,.15)' } }, y: { stacked: true, ticks: { color: '#64748b', callback: v => formatMoney(v) }, grid: { color: 'rgba(100,116,139,.15)' } } } }
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 10. TAB NAVIGATION
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showTab(tabId) {
  $$('.res-tab').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabId));
  $$('.tab-panel').forEach(p => p.classList.toggle('active', p.id === 'tab' + tabId.charAt(0).toUpperCase() + tabId.slice(1)));
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 11. CHART.JS HELPERS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function chartOptions(title) {
  return {
    responsive: true,
    plugins: {
      title: title ? { display: true, text: title, color: '#e2e8f0', font: { size: 14, family: 'Inter' } } : { display: false },
      legend: { labels: { color: '#94a3b8', font: { size: 11 } } },
      tooltip: { callbacks: { label: ctx => formatMoney(ctx.raw) } }
    },
    scales: {
      x: { ticks: { color: '#64748b' }, grid: { color: 'rgba(100,116,139,.15)' } },
      y: { ticks: { color: '#64748b', callback: v => formatMoney(v) }, grid: { color: 'rgba(100,116,139,.15)' } }
    }
  };
}

function destroyChart(name) {
  if (App.charts[name]) {
    App.charts[name].destroy();
    delete App.charts[name];
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 12. SIDEBAR UPDATES
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateSidebar() {
  const d = App.formData || {};
  $('sbEmpresa').textContent = d.razaoSocial || '--';
  var cnaeCod = $('cnaePrincipal').value || '';
  var cnaeBuscaVal = $('cnaeBusca').value || '';
  if (cnaeCod && cnaeBuscaVal.indexOf(cnaeCod) === 0) {
    $('sbCnae').textContent = cnaeBuscaVal.substring(0, 40);
  } else if (cnaeCod) {
    $('sbCnae').textContent = cnaeCod + ' ' + cnaeBuscaVal.substring(0, 30);
  } else {
    $('sbCnae').textContent = '--';
  }
  const receita = d.receitaBrutaAnual || 0;
  $('sbReceita').textContent = formatMoney(receita);
  $('sbRegime').textContent = 'Lucro Presumido';
  const anual = App.results.anual;
  if (anual && anual.consolidacao) {
    $('sbCarga').textContent = formatMoney(anual.consolidacao.cargaTributariaTotal);
    $('sbCargaPct').textContent = anual.consolidacao.percentualCargaTributaria + ' da receita';
  }
  // Economia Potencial ‚Äî usar c√°lculo consolidado do EstudoLP quando dispon√≠vel
  let economiaPotencial = 0;
  if (App.results.economiaPotencial && App.results.economiaPotencial.totalEconomiaAnual > 0) {
    // Usar o valor calculado pelo motor oficial (inclui pr√≥-labore, ECD, caixa, breakeven, dicas)
    economiaPotencial = App.results.economiaPotencial.totalEconomiaAnual;
  } else {
    // Fallback: soma local das estrat√©gias de otimiza√ß√£o
    // 1) Economia pr√≥-labore √≥timo
    if (App.results.proLabore && App.results.proLabore.economiaAnual > 0) {
      economiaPotencial += App.results.proLabore.economiaAnual;
    }
    // 2) Benef√≠cio ECD
    if (App.results.ecd && App.results.ecd.beneficioLiquido > 0 && App.results.ecd.valeAPena) {
      economiaPotencial += App.results.ecd.beneficioLiquido;
    }
    // 3) Diferimento regime de caixa
    if (App.results.caixaComp && App.results.caixaComp.totalDiferido > 0) {
      economiaPotencial += App.results.caixaComp.totalDiferido;
    }
  }
  // Enriquecer com dados do EstudoLP se dispon√≠vel
  if (typeof EstudoLP !== 'undefined' && EstudoLP.gerarResumoExecutivo && anual) {
    try {
      const resumo = EstudoLP.gerarResumoExecutivo({
        anual: anual,
        breakeven: App.results.breakeven || { breakEvenMargem: null, lpSempreVantajoso: false, lrSempreVantajoso: false, margemRealAtual: null },
        economia: App.results.economiaPotencial || { totalEconomiaAnual: 0, nivelOportunidade: 'baixo', recomendacaoPrincipal: '' },
        dicas: App.results.dicas || [],
        razaoSocial: App.formData.razaoSocial || '',
        cnpj: App.formData.cnpj || '',
        atividadeId: App.formData.atividadeId || 'servicos_gerais'
      });
      App.results.resumoExecutivo = resumo;
      // Atualizar regime recomendado na sidebar
      if (resumo.regimeRecomendado) {
        $('sbRegime').textContent = resumo.regimeRecomendado;
        $('sbRegime').style.color = resumo.regimeRecomendado === 'Lucro Presumido' ? 'var(--success)' : resumo.regimeRecomendado === 'Lucro Real' ? 'var(--info)' : 'var(--warn)';
      }
    } catch(e) {
      // Silencioso ‚Äî sidebar continua funcionando sem EstudoLP
    }
  }
  $('sbEconomia').textContent = economiaPotencial > 0 ? formatMoney(economiaPotencial) : '--';
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 13. AUTO-SAVE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function triggerAutoSave() {
  clearTimeout(App.autoSaveTimer);
  App.autoSaveTimer = setTimeout(() => {
    try {
      gatherFormData();
      localStorage.setItem('lp_autosave', JSON.stringify({ ts: Date.now(), data: App.formData }));
    } catch(e) { /* ignore */ }
  }, 2000);
}

function loadAutoSave() {
  try {
    const raw = localStorage.getItem('lp_autosave');
    if (!raw) return false;
    const saved = JSON.parse(raw);
    if (!saved.data) return false;
    const d = saved.data;
    if (d.razaoSocial) $('razaoSocial').value = d.razaoSocial;
    if (d.cnpj) $('cnpj').value = d.cnpj;
    if (d.estado) {
      $('estado').value = d.estado;
      onEstadoChange().then(function() {
        if (d.municipio) {
          $('municipio').value = d.municipio;
          onMunicipioChange();
        }
      }).catch(function() {
        if (d.municipio) {
          setTimeout(function() { $('municipio').value = d.municipio; onMunicipioChange(); }, 2000);
        }
      });
    }
    if (d.aliquotaISS) $('aliquotaISS').value = d.aliquotaISS;
    if (d.porte) $('porte').value = d.porte;
    // Restore money fields
    const moneyFields = ['receitaAnterior','folhaPagamento','devolucoes','cancelamentos','descontos',
      'ganhosCapital','rendFinanceiros','jcpRecebido','multasContratuais','recFinDiversas',
      'valoresRecuperados','demaisReceitas','irrfRetido','csllRetida','pisRetido','cofinsRetida',
      'creditosPISCOFINS','lucroContabil','prejuizosFiscais'];
    moneyFields.forEach(field => {
      if (d[field] && $(field)) $(field).value = Number(d[field]).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
    });
    // Despesas
    const despFields = ['despAluguel','despUtilidades','despCombustivel','despMaterial',
      'despServicos','despProlabore','despSalarios','despDepreciacao','despOutras'];
    despFields.forEach(field => {
      if (d[field] && $(field)) $(field).value = Number(d[field]).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
    });
    if (d.aliquotaRAT) $('aliquotaRAT').value = d.aliquotaRAT;
    if (d.aliquotaTerceiros) $('aliquotaTerceiros').value = d.aliquotaTerceiros;
    if (d.aliquotaSimples) $('aliquotaSimples').value = d.aliquotaSimples;
    if (d.temEscrituracao) $('temEscrituracao').checked = d.temEscrituracao;
    if (d.temEquipamentos) $('temEquipamentos').checked = d.temEquipamentos;
    if (d.temPD) $('temPD').checked = d.temPD;
    if (d.receitaSazonal) $('receitaSazonal').checked = d.receitaSazonal;
    // Restaurar CNAE principal (H25)
    if (d.cnaePrincipal) {
      $('cnaePrincipal').value = d.cnaePrincipal;
      if (d.atividadeId) $('atividadeId').value = d.atividadeId;
      // Restaurar texto de busca do CNAE
      if (window.BANCO_CNAE) {
        var cnaeItem = window.BANCO_CNAE.find(function(c) { return c.codigo === d.cnaePrincipal; });
        if (cnaeItem) {
          $('cnaeBusca').value = cnaeItem.codigo + ' - ' + cnaeItem.descricao;
          try { selectCnae(cnaeItem.codigo, cnaeItem.descricao, cnaeItem.categoria || ''); } catch(e2) {}
        } else {
          $('cnaeBusca').value = d.cnaePrincipal;
        }
      } else {
        $('cnaeBusca').value = d.cnaePrincipal;
      }
    }
    // Restaurar receitas (H01)
    if (d.receitas && d.receitas.length > 0) {
      // Remover a linha de receita padr√£o criada pelo initApp
      var existingRows = document.querySelectorAll('#tbodyReceitasSimp tr');
      existingRows.forEach(function(row) { row.remove(); });
      d.receitas.forEach(function(rec) {
        addLinhaReceita('tbodyReceitasSimp', rec.atividadeId);
        var lastRow = App.receitaRowCount;
        var valEl = $('recValor' + lastRow);
        if (valEl && rec.valor > 0) {
          valEl.value = Number(rec.valor).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
        }
      });
    }
    // Restaurar s√≥cios (H23)
    if (d.socios && d.socios.length > 0) {
      // Remover o s√≥cio padr√£o criado pelo initApp
      var existingSocios = document.querySelectorAll('.soc-row');
      existingSocios.forEach(function(row) { row.remove(); });
      App.socioCount = 0;
      d.socios.forEach(function(soc) {
        addSocio();
        var lastId = App.socioCount;
        var nomeEl = $('socNome' + lastId);
        var pctEl = $('socPct' + lastId);
        if (nomeEl && soc.nome) nomeEl.value = soc.nome;
        if (pctEl && soc.percentual != null) pctEl.value = (soc.percentual * 100).toFixed(1);
      });
    }
    // Impedimentos legais
    if (d.impInstFinanceira) $('impInstFinanceira').checked = true;
    if (d.impFactoring) $('impFactoring').checked = true;
    if (d.impExterior) $('impExterior').checked = true;
    if (d.impIsencao) $('impIsencao').checked = true;
    if (d.impSCP) $('impSCP').checked = true;
    calcTotalDespesas();
    // Atualizar formData e sidebar ap√≥s restaura√ß√£o completa (H02)
    gatherFormData();
    updateSidebar();
    return true;
  } catch(e) { return false; }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 14. EXPORT FUNCTIONS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function salvarEstudo() {
  try {
    gatherFormData();
    const study = { ts: Date.now(), version: '1.0', formData: App.formData, results: {} };
    // Store all serializable result data
    var resultKeys = ['simulacao','trimestral','piscofins','anual','proLabore','jcp','ecd','caixaComp','breakeven','calendario'];
    resultKeys.forEach(function(key) {
      if (App.results[key]) study.results[key] = App.results[key];
    });
    try {
      localStorage.setItem('lp_estudo_salvo', JSON.stringify(study));
      alert('Estudo salvo com sucesso! (' + new Date().toLocaleString('pt-BR') + ')');
    } catch(storageErr) {
      // localStorage cheio ou indisponivel
      alert('Erro ao salvar no navegador (armazenamento cheio ou indisponivel). Tente exportar como PDF ou CSV.');
    }
  } catch(e) {
    console.error('[IMPOST] Erro ao salvar:', e); alert('Erro ao salvar o estudo. Tente novamente.');
  }
}

function carregarEstudo() {
  try {
    const raw = localStorage.getItem('lp_estudo_salvo');
    if (!raw) { alert('Nenhum estudo salvo encontrado.'); return; }
    const study = JSON.parse(raw);
    if (!study.formData) { alert('Dados invalidos.'); return; }
    const d = study.formData;
    // Dados basicos
    if (d.razaoSocial) $('razaoSocial').value = d.razaoSocial;
    if (d.cnpj) $('cnpj').value = d.cnpj;
    if (d.estado) {
      $('estado').value = d.estado;
      onEstadoChange().then(function() {
        if (d.municipio) {
          $('municipio').value = d.municipio;
          onMunicipioChange();
        }
      }).catch(function() {
        if (d.municipio) {
          setTimeout(function() { $('municipio').value = d.municipio; onMunicipioChange(); }, 2000);
        }
      });
    }
    if (d.aliquotaISS) $('aliquotaISS').value = d.aliquotaISS;
    if (d.porte) $('porte').value = d.porte;
    // Financeiros
    const moneyFields = ['receitaAnterior','folhaPagamento','devolucoes','cancelamentos','descontos',
      'ganhosCapital','rendFinanceiros','jcpRecebido','multasContratuais','recFinDiversas',
      'valoresRecuperados','demaisReceitas','irrfRetido','csllRetida','pisRetido','cofinsRetida',
      'creditosPISCOFINS','lucroContabil','prejuizosFiscais'];
    moneyFields.forEach(field => {
      if (d[field] && $(field)) $( field).value = Number(d[field]).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
    });
    // Despesas
    const despFields = ['despAluguel','despUtilidades','despCombustivel','despMaterial',
      'despServicos','despProlabore','despSalarios','despDepreciacao','despOutras'];
    despFields.forEach(field => {
      if (d[field] && $(field)) $(field).value = Number(d[field]).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
    });
    // Numeros
    if (d.aliquotaRAT) $('aliquotaRAT').value = d.aliquotaRAT;
    if (d.aliquotaTerceiros) $('aliquotaTerceiros').value = d.aliquotaTerceiros;
    if (d.aliquotaSimples) $('aliquotaSimples').value = d.aliquotaSimples;
    // Checkboxes
    if (d.temEscrituracao) $('temEscrituracao').checked = d.temEscrituracao;
    if (d.temEquipamentos) $('temEquipamentos').checked = d.temEquipamentos;
    if (d.temPD) $('temPD').checked = d.temPD;
    if (d.receitaSazonal) $('receitaSazonal').checked = d.receitaSazonal;
    // Impedimentos legais
    if (d.impInstFinanceira) $('impInstFinanceira').checked = true;
    if (d.impFactoring) $('impFactoring').checked = true;
    if (d.impExterior) $('impExterior').checked = true;
    if (d.impIsencao) $('impIsencao').checked = true;
    if (d.impSCP) $('impSCP').checked = true;
    // Restaurar CNAE principal (H25/H26)
    if (d.cnaePrincipal) {
      $('cnaePrincipal').value = d.cnaePrincipal;
      if (d.atividadeId) $('atividadeId').value = d.atividadeId;
      if (window.BANCO_CNAE) {
        var cnaeItem = window.BANCO_CNAE.find(function(c) { return c.codigo === d.cnaePrincipal; });
        if (cnaeItem) {
          $('cnaeBusca').value = cnaeItem.codigo + ' - ' + cnaeItem.descricao;
          try { selectCnae(cnaeItem.codigo, cnaeItem.descricao, cnaeItem.categoria || ''); } catch(e2) {}
        } else {
          $('cnaeBusca').value = d.cnaePrincipal;
        }
      }
    }
    // Restaurar receitas (H26)
    if (d.receitas && d.receitas.length > 0) {
      var existingRows = document.querySelectorAll('#tbodyReceitasSimp tr');
      existingRows.forEach(function(row) { row.remove(); });
      d.receitas.forEach(function(rec) {
        addLinhaReceita('tbodyReceitasSimp', rec.atividadeId);
        var lastRow = App.receitaRowCount;
        var valEl = $('recValor' + lastRow);
        if (valEl && rec.valor > 0) {
          valEl.value = Number(rec.valor).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
        }
      });
    }
    // Restaurar s√≥cios (H26)
    if (d.socios && d.socios.length > 0) {
      var existingSocios = document.querySelectorAll('.soc-row');
      existingSocios.forEach(function(row) { row.remove(); });
      App.socioCount = 0;
      d.socios.forEach(function(soc) {
        addSocio();
        var lastId = App.socioCount;
        var nomeEl = $('socNome' + lastId);
        var pctEl = $('socPct' + lastId);
        if (nomeEl && soc.nome) nomeEl.value = soc.nome;
        if (pctEl && soc.percentual != null) pctEl.value = (soc.percentual * 100).toFixed(1);
      });
    }
    calcTotalDespesas();
    gatherFormData();
    updateSidebar();
    alert('Estudo carregado! Salvo em: ' + new Date(study.ts).toLocaleString('pt-BR'));
  } catch(e) {
    console.error('[IMPOST] Erro ao carregar:', e); alert('Erro ao carregar o estudo salvo. Os dados podem estar corrompidos.');
  }
}

function getExportOpcoes() {
  return {
    incluirCapa: document.getElementById('optCapa') ? document.getElementById('optCapa').checked : true,
    incluirSumario: document.getElementById('optSumario') ? document.getElementById('optSumario').checked : true,
    incluirGraficos: document.getElementById('optGraficos') ? document.getElementById('optGraficos').checked : true,
    incluirAnexoLegal: document.getElementById('optAnexoLegal') ? document.getElementById('optAnexoLegal').checked : true,
    incluirDisclaimer: document.getElementById('optDisclaimer') ? document.getElementById('optDisclaimer').checked : true,
    incluirMarcaDagua: document.getElementById('optMarcaDagua') ? document.getElementById('optMarcaDagua').checked : false,
    qualidadeGraficos: 2
  };
}

function exportPDF() {
  try {
    gatherFormData();
    var d = App.formData;
    if (!d.receitaBrutaAnual || d.receitaBrutaAnual <= 0) {
      alert('Calcule os resultados primeiro (etapa 5) antes de exportar o PDF.');
      return;
    }
    // Tenta ExportadorLP profissional primeiro
    if (typeof ExportadorLP !== 'undefined' && typeof ExportadorLP.gerarPDF === 'function') {
      var opcoes = getExportOpcoes();
      opcoes.nomeArquivoPDF = 'estudo_lp_' + (d.razaoSocial || 'empresa').replace(/\s+/g, '_') + '.pdf';
      ExportadorLP.gerarPDF(App, opcoes);
    } else if (typeof LucroPresumido !== 'undefined' && typeof LucroPresumido.exportPDF === 'function') {
      LucroPresumido.exportPDF(App);
    } else if (typeof LucroPresumido !== 'undefined' && typeof LucroPresumido.gerarRelatorioPDF === 'function') {
      LucroPresumido.gerarRelatorioPDF(App);
    } else {
      // Fallback: impressao do navegador com estilo otimizado
      var style = document.createElement('style');
      style.id = 'printStyle';
      style.textContent = '@media print { .topbar, .sidebar, .stepper, .wz-nav, .res-tabs, .tb-btn, .export-grid, .export-opts { display: none !important; } .layout { display: block; } .main-area { max-width: 100%; padding: 0; } .wz-panel { display: block !important; } .tab-panel { display: block !important; page-break-inside: avoid; margin-bottom: 20px; } body { background: #fff; color: #000; } .wz-card, .kpi, .regime-card, .risk-card, .adv-card, .tip-card { background: #f8f8f8; border: 1px solid #ddd; color: #000; } .sb-value, .kpi-value, .rc-total { color: #000; } .print-disclaimer { display: block !important; } }';
      document.head.appendChild(style);
      var disclaimer = document.createElement('div');
      disclaimer.className = 'print-disclaimer';
      disclaimer.style.cssText = 'display:none;margin-top:40px;padding:16px;border-top:2px solid #ccc;font-size:9px;color:#666;line-height:1.5';
      disclaimer.innerHTML = '<strong>AVISO LEGAL:</strong> Este relatorio foi gerado pelo sistema IMPOST e contem estimativas baseadas na legislacao vigente (RIR/2018, IN RFB 1.700/2017, LC 224/2025) e nos dados informados pelo usuario. NAO constitui parecer contabil ou juridico. Os resultados devem ser validados por contador ou advogado tributarista habilitado antes de qualquer tomada de decisao fiscal. Gerado em: ' + new Date().toLocaleString('pt-BR');
      document.body.appendChild(disclaimer);
      window.print();
      setTimeout(function() { var ps = document.getElementById('printStyle'); if (ps) ps.remove(); if (disclaimer.parentNode) disclaimer.remove(); }, 1000);
    }
  } catch(e) {
    console.error('[IMPOST] Erro PDF:', e);
    if (confirm('Erro ao gerar o PDF.\n\nDeseja usar a impressao do navegador como alternativa?')) {
      window.print();
    }
  }
}

function exportExcelProfissional() {
  try {
    gatherFormData();
    var d = App.formData;
    if (!d.receitaBrutaAnual || d.receitaBrutaAnual <= 0) {
      alert('Calcule os resultados primeiro (etapa 5) antes de exportar o Excel.');
      return;
    }
    if (typeof ExportadorLP !== 'undefined' && typeof ExportadorLP.gerarExcel === 'function') {
      var opcoes = getExportOpcoes();
      opcoes.nomeArquivoExcel = 'estudo_lp_' + (d.razaoSocial || 'empresa').replace(/\s+/g, '_') + '.xlsx';
      ExportadorLP.gerarExcel(App, opcoes);
    } else {
      alert('Modulo de exportacao Excel nao carregado. Verifique sua conexao ou use a opcao CSV.');
      exportCSV();
    }
  } catch(e) {
    console.error('[IMPOST] Erro Excel:', e);
    alert('Erro ao gerar o Excel. Tente novamente ou exporte como CSV.');
  }
}

function _csvSafe(val) {
  if (val == null) return '';
  var s = String(val);
  if (/^[=+\-@\t\r]/.test(s)) s = "'" + s;
  if (s.indexOf(';') !== -1 || s.indexOf('"') !== -1) s = '"' + s.replace(/"/g, '""') + '"';
  return s;
}

function exportCSV() {
  try {
    gatherFormData();
    const d = App.formData;
    const anual = App.results.anual;
    let csv = 'sep=;\n';
    csv += 'ESTUDO LUCRO PRESUMIDO ‚Äî IMPOST.;;\n';
    csv += `Data do Estudo;${new Date().toLocaleString('pt-BR')}\n`;
    csv += `Empresa;${_csvSafe(d.razaoSocial)}\n`;
    csv += `CNPJ;${_csvSafe(d.cnpj)}\n`;
    csv += `CNAE;${_csvSafe(d.cnaePrincipal)}\n`;
    const _csvEstado = getEstadoData(d.estado);
    csv += `Estado;${_csvSafe((d.estado || '') + (_csvEstado ? ' - ' + _csvEstado.nome : ''))}\n`;
    csv += `Munic√≠pio;${_csvSafe(d.municipio)}\n`;
    csv += `Area SUDAM;${d.areaAtuacaoSUDAM ? 'Sim' : 'Nao'}\n`;
    csv += `Area SUDENE;${d.areaAtuacaoSUDENE ? 'Sim' : 'Nao'}\n`;
    csv += `Zona Franca;${d.zonaFranca ? 'Sim' : 'Nao'}\n`;
    csv += `Receita Bruta Informada;${d.receitaBrutaAnual || 0}\n`;
    csv += `Receita L√≠quida (Base);${anual ? anual.receitaBrutaAnual : (d.receitaBrutaAnual || 0)}\n`;
    csv += `Folha de Pagamento Anual;${d.folhaPagamento || 0}\n`;
    csv += `Total Despesas;${d.totalDespesas || 0}\n`;
    csv += '\n';
    if (anual) {
      csv += 'TRIBUTOS ANUAIS - LUCRO PRESUMIDO;;\n';
      csv += `IRPJ;${anual.tributos.irpj.anual}\n`;
      csv += `CSLL;${anual.tributos.csll.anual}\n`;
      csv += `PIS;${anual.tributos.pis.anual}\n`;
      csv += `COFINS;${anual.tributos.cofins.anual}\n`;
      csv += `ISS;${anual.tributos.iss.anual}\n`;
      csv += `INSS Patronal;${anual.tributos.inssPatronal.anual}\n`;
      csv += `Carga Total;${anual.consolidacao.cargaTributariaTotal}\n`;
      csv += `% Carga;${anual.consolidacao.percentualCargaTributaria}\n`;
      csv += `Lucro Distribu√≠vel Isento;${anual.distribuicaoLucros.lucroDistribuivelFinal}\n`;
      csv += '\n';
    }
    csv += '\n';
    csv += 'AVISO LEGAL;\n';
    csv += 'Os c√°lculos s√£o estimativas baseadas na legisla√ß√£o vigente e nos dados informados.;\n';
    csv += 'N√ÉO substitui orienta√ß√£o de contador ou advogado tributarista habilitado.;\n';
    csv += 'Gerado em;' + new Date().toLocaleString('pt-BR') + '\n';
    const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `estudo_lucro_presumido_${(d.razaoSocial || 'empresa').replace(/\s+/g, '_')}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  } catch(e) {
    console.error('[IMPOST] Erro ao exportar:', e); alert('Erro ao exportar o arquivo. Tente novamente.');
  }
}

var exportExcel = typeof ExportadorLP !== 'undefined' ? exportExcelProfissional : exportCSV; // backward-compatible alias

function novoEstudo() {
  if (!confirm('Tem certeza que deseja limpar todos os dados e iniciar um novo estudo?')) return;
  try {
    localStorage.removeItem('lp_autosave');
    localStorage.removeItem('lp_estudo_salvo');
  } catch(e) { /* ignore storage errors */ }
  location.reload();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 15. INITIALIZATION
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initApp() {
  if (App.initialized) return;
  App.initialized = true;
  // Populate estados
  populateEstados();
  // Wire state/municipality change
  $('estado').addEventListener('change', onEstadoChange);
  $('municipio').addEventListener('change', onMunicipioChange);
  // CNPJ mask
  $('cnpj').addEventListener('input', function() { maskCNPJ(this); });
  // Money masks
  document.addEventListener('input', function(e) {
    if (e.target.classList.contains('money')) maskMoney(e.target);
  });
  // Real-time sidebar update on financial field changes
  document.addEventListener('input', debounce(function(e) {
    if (e.target.classList.contains('money') || e.target.classList.contains('rec-ativ')) {
      gatherFormData();
      updateSidebar();
    }
  }, 500));
  // Despesas auto-total
  document.addEventListener('input', function(e) {
    if (e.target.classList.contains('desp')) {
      maskMoney(e.target);
      calcTotalDespesas();
    }
  });
  // Auto-save on any input
  document.addEventListener('input', debounce(triggerAutoSave, 2000));
  // Eligibility checks
  ['receitaAnterior', 'mesesAtividade', 'impInstFinanceira', 'impFactoring', 'impExterior', 'impIsencao', 'impSCP'].forEach(id => {
    const el = $(id);
    if (el) el.addEventListener('change', checkElegibilidade);
    if (el) el.addEventListener('input', checkElegibilidade);
  });
  // Add first revenue row
  addLinhaReceita();
  // Add first socio
  addSocio();
  // Initialize CNAE search
  initCnaeSearch();
  // Load saved data
  loadAutoSave();
  // Hide loading
  setTimeout(() => {
    const overlay = $('loadingOverlay');
    if (overlay) overlay.classList.add('hide');
  }, 600);
}

// Wrapper com loading feedback para exportPDF
const _originalExportPDF = window.exportPDF;
if (_originalExportPDF) {
  window.exportPDF = function() {
    const btn = document.getElementById('btnExportPDF');
    if (btn) {
      const orig = btn.innerHTML;
      btn.innerHTML = '<div class="export-icon"><i class="fa-solid fa-spinner fa-spin" style="color:var(--accent)"></i></div><div class="export-label">Gerando PDF...</div><div class="export-desc">Aguarde alguns segundos</div>';
      btn.style.opacity = '0.6';
      btn.style.pointerEvents = 'none';
      setTimeout(() => {
        try { _originalExportPDF(); }
        catch(e) { console.error('[IMPOST] Erro PDF:', e); alert('Erro ao gerar o PDF. Tente novamente ou exporte como CSV.'); }
        finally {
          setTimeout(() => {
            btn.innerHTML = orig;
            btn.style.opacity = '1';
            btn.style.pointerEvents = 'auto';
          }, 500);
        }
      }, 100);
    } else {
      _originalExportPDF();
    }
  };
}

// Wrapper com loading feedback para exportExcelProfissional
const _originalExportExcel = window.exportExcelProfissional;
if (_originalExportExcel) {
  window.exportExcelProfissional = function() {
    const btn = document.getElementById('btnExportExcel');
    if (btn) {
      const orig = btn.innerHTML;
      btn.innerHTML = '<div class="export-icon"><i class="fa-solid fa-spinner fa-spin" style="color:var(--success)"></i></div><div class="export-label">Gerando Excel...</div><div class="export-desc">Aguarde alguns segundos</div>';
      btn.style.opacity = '0.6';
      btn.style.pointerEvents = 'none';
      setTimeout(() => {
        try { _originalExportExcel(); }
        catch(e) { console.error('[IMPOST] Erro Excel:', e); alert('Erro ao gerar o Excel. Tente novamente ou exporte como CSV.'); }
        finally {
          setTimeout(() => {
            btn.innerHTML = orig;
            btn.style.opacity = '1';
            btn.style.pointerEvents = 'auto';
          }, 500);
        }
      }, 100);
    } else {
      _originalExportExcel();
    }
  };
}

// Wait for DOM and CNAE data
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    if (window.BANCO_CNAE) { App.cnaeLoaded = true; initApp(); }
    else window.addEventListener('cnae-loaded', () => { App.cnaeLoaded = true; initApp(); });
  });
} else {
  if (window.BANCO_CNAE) { App.cnaeLoaded = true; initApp(); }
  else window.addEventListener('cnae-loaded', () => { App.cnaeLoaded = true; initApp(); });
}
// Fallback: init after 3s even without CNAE
setTimeout(() => { if (!App.cnaeLoaded) { App.cnaeLoaded = true; initApp(); } }, 3000);
</script>

</body>
</html>
