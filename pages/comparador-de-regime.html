<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMPOST. — Comparador de Regimes Tributários v3.0 | Brasil 2026</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;0,9..40,800&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ═══════════════════════════════════════════ */
        /*  CSS VARIABLES                              */
        /* ═══════════════════════════════════════════ */
        :root {
            --bg-deepest: #f5f3ee;
            --bg-deep: #faf8f4;
            --bg-base: #ffffff;
            --bg-card: #ffffff;
            --bg-card-hover: #f9f7f2;
            --bg-input: #ffffff;
            --border-subtle: #e8e3d8;
            --border-base: #ddd7ca;
            --border-active: rgba(22,163,74,0.35);
            --text-primary: #1a1a1a;
            --text-secondary: #555555;
            --text-muted: #8a8578;
            --accent: #16a34a;
            --accent-dim: rgba(22,163,74,0.08);
            --accent-glow: rgba(22,163,74,0.18);
            --accent-bright: #15803d;
            --blue: #2563eb;
            --purple: #7c3aed;
            --orange: #ea580c;
            --amber: #d97706;
            --red: #dc2626;
            --cyan: #0891b2;
            --font-body: 'DM Sans', system-ui, sans-serif;
            --font-mono: 'JetBrains Mono', 'Courier New', monospace;
            --transition-fast: 0.2s cubic-bezier(.4,0,.2,1);
            --transition-base: 0.3s cubic-bezier(.4,0,.2,1);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
        }

        /* ═══════════════════════════════════════════ */
        /*  RESET & BASE                               */
        /* ═══════════════════════════════════════════ */
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-body);
            background: var(--bg-deepest);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }
        .mono { font-family: var(--font-mono); }

        /* ═══════════════════════════════════════════ */
        /*  LAYOUT                                     */
        /* ═══════════════════════════════════════════ */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px 16px 60px;
        }

        /* ═══════════════════════════════════════════ */
        /*  NAVBAR                                     */
        /* ═══════════════════════════════════════════ */
        .navbar {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-subtle);
            padding: 12px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .navbar .inner {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .navbar .logo {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--text-primary);
            text-decoration: none;
            letter-spacing: -0.02em;
        }
        .navbar .logo b { color: var(--accent); }
        .navbar .nav-sep { color: var(--border-base); margin: 0 12px; font-weight: 300; }
        .navbar .nav-sub { font-size: 0.88rem; color: var(--text-muted); }
        .navbar .btn-back {
            font-size: 0.82rem;
            font-weight: 600;
            color: #fff;
            background: var(--accent);
            padding: 8px 18px;
            border-radius: 8px;
            text-decoration: none;
            transition: background 0.15s;
        }
        .navbar .btn-back:hover { background: var(--accent-bright); }

        /* ═══════════════════════════════════════════ */
        /*  HEADER                                     */
        /* ═══════════════════════════════════════════ */
        .header {
            text-align: center;
            padding: 32px 0 24px;
        }
        .header h1 {
            font-size: 2rem;
            font-weight: 800;
            letter-spacing: -0.02em;
        }
        .header h1 span { color: var(--accent); }
        .header p {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-top: 4px;
        }
        .header .version-badge {
            display: inline-block;
            background: var(--accent);
            color: #fff;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 6px;
            vertical-align: super;
        }

        /* ═══════════════════════════════════════════ */
        /*  SECTIONS & CARDS                           */
        /* ═══════════════════════════════════════════ */
        .section {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
        }
        .section-title {
            font-size: 1.05rem;
            font-weight: 700;
            color: var(--accent-bright);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .section-title .num {
            background: var(--accent);
            color: #fff;
            font-family: var(--font-mono);
            font-size: 0.8rem;
            font-weight: 700;
            width: 26px; height: 26px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
        }

        /* ═══════════════════════════════════════════ */
        /*  FORM ELEMENTS                              */
        /* ═══════════════════════════════════════════ */
        .field { margin-bottom: 16px; }
        .field-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        @media (max-width: 600px) {
            .field-row { grid-template-columns: 1fr; }
        }
        label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }
        label .hint {
            font-weight: 400;
            color: var(--text-muted);
            font-size: 0.78rem;
        }
        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-input);
            border: 1.5px solid var(--border-base);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: var(--font-body);
            font-size: 0.95rem;
            outline: none;
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
        }
        input:focus, select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }
        input.money {
            font-family: var(--font-mono);
            font-weight: 600;
            font-size: 1rem;
        }
        select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23555555' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }
        input::placeholder { color: var(--text-muted); }

        /* Checkbox */
        .check-group { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 4px; }
        .check-item {
            display: flex; align-items: center; gap: 8px;
            font-size: 0.88rem; color: var(--text-secondary);
            cursor: pointer;
        }
        .check-item input[type="checkbox"] {
            width: 18px; height: 18px;
            accent-color: var(--accent);
            cursor: pointer;
        }

        /* Slider */
        .slider-group {
            display: flex; align-items: center; gap: 12px;
        }
        .slider-group input[type="range"] {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--border-base);
            border-radius: 3px;
            outline: none;
        }
        .slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px; height: 18px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            box-shadow: 0 1px 4px rgba(22,163,74,0.3);
        }
        .slider-group .slider-value {
            font-family: var(--font-mono);
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--accent);
            min-width: 50px;
            text-align: right;
        }

        /* ═══════════════════════════════════════════ */
        /*  CNAE AUTOCOMPLETE                          */
        /* ═══════════════════════════════════════════ */
        .cnae-wrapper { position: relative; }
        #cnaeDropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0; right: 0;
            background: var(--bg-base);
            border: 1px solid var(--border-active);
            border-radius: 0 0 var(--radius-sm) var(--radius-sm);
            max-height: 320px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }
        .cnae-item {
            padding: 10px 14px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            transition: background var(--transition-fast);
        }
        .cnae-item:hover, .cnae-item.active {
            background: var(--accent-dim);
        }
        .cnae-item .cnae-text {
            font-size: 0.88rem;
            color: var(--text-primary);
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .cnae-item .cnae-text .code {
            font-family: var(--font-mono);
            color: var(--accent);
            font-size: 0.82rem;
        }
        .cnae-badge {
            font-size: 0.7rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 10px;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .cnae-badge.comercio { background: rgba(22,163,74,0.10); color: #15803d; }
        .cnae-badge.industria { background: rgba(37,99,235,0.10); color: #1d4ed8; }
        .cnae-badge.servico { background: rgba(124,58,237,0.10); color: #6d28d9; }

        /* CNAE Info Card */
        #cnaeInfo {
            display: none;
            background: var(--bg-deep);
            border: 1px solid var(--border-active);
            border-radius: var(--radius-sm);
            padding: 14px;
            margin-top: 10px;
            font-size: 0.88rem;
        }
        #cnaeInfo .cnae-info-title {
            font-weight: 700;
            color: var(--accent-bright);
            margin-bottom: 8px;
        }
        #cnaeInfo .cnae-info-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            color: var(--text-secondary);
        }
        #cnaeInfo .cnae-info-row span:last-child {
            font-weight: 600;
            color: var(--text-primary);
            font-family: var(--font-mono);
            font-size: 0.85rem;
        }
        .badge-warn {
            background: rgba(217,119,6,0.10);
            color: var(--amber);
            font-size: 0.75rem;
            font-weight: 700;
            padding: 3px 10px;
            border-radius: 10px;
            display: inline-block;
            margin-top: 8px;
        }
        .badge-ok {
            background: rgba(22,163,74,0.10);
            color: var(--accent);
            font-size: 0.75rem;
            font-weight: 700;
            padding: 3px 10px;
            border-radius: 10px;
            display: inline-block;
            margin-top: 8px;
        }
        .badge-vedado {
            background: rgba(220,38,38,0.10);
            color: var(--red);
            font-size: 0.75rem;
            font-weight: 700;
            padding: 3px 10px;
            border-radius: 10px;
            display: inline-block;
            margin-top: 8px;
        }

        /* ═══════════════════════════════════════════ */
        /*  INDICATOR BARS                             */
        /* ═══════════════════════════════════════════ */
        .bar-container {
            display: none;
            background: var(--bg-deep);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            padding: 14px;
            margin-top: 10px;
        }
        .bar-label {
            font-size: 0.82rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }
        .bar-track {
            height: 10px;
            background: var(--border-base);
            border-radius: 5px;
            position: relative;
            overflow: visible;
        }
        .bar-fill {
            height: 100%;
            border-radius: 5px;
            transition: width var(--transition-base), background var(--transition-base);
        }
        .bar-marker {
            position: absolute;
            top: -4px;
            width: 2px; height: 18px;
            background: var(--text-muted);
            border-radius: 1px;
        }
        .bar-marker-label {
            position: absolute;
            top: 18px;
            font-size: 0.65rem;
            color: var(--text-muted);
            white-space: nowrap;
            transform: translateX(-50%);
        }
        .bar-value {
            font-family: var(--font-mono);
            font-size: 0.9rem;
            font-weight: 700;
            margin-top: 6px;
        }

        /* ═══════════════════════════════════════════ */
        /*  ISS HINT & MUNICÍPIO LOADING — v1.0       */
        /* ═══════════════════════════════════════════ */
        .iss-hint {
            margin-top: 8px;
            padding: 10px 14px;
            font-size: 0.82rem;
            line-height: 1.55;
            border-radius: var(--radius-sm);
            background: var(--bg-deep);
            border-left: 3px solid var(--amber);
            color: var(--text-secondary);
        }
        .iss-hint strong { color: var(--text-primary); }
        #munLoading svg { color: var(--accent); }
        /* Município com ISS aproximado */
        #selectMunicipio option[data-iss-conhecido="0"] {
            color: #8a8578;
            font-style: italic;
        }

        /* ═══════════════════════════════════════════ */
        /*  DICA BANNER                                */
        /* ═══════════════════════════════════════════ */
        #dicaBanner {
            display: none;
            background: rgba(22,163,74,0.06);
            border: 1px solid rgba(22,163,74,0.15);
            border-radius: var(--radius-sm);
            padding: 14px;
            margin-bottom: 16px;
            font-size: 0.88rem;
            color: var(--text-secondary);
        }
        #dicaBanner strong { color: var(--accent-bright); }

        /* ═══════════════════════════════════════════ */
        /*  SÓCIOS CONFIG — v1.0                  */
        /* ═══════════════════════════════════════════ */
        #sociosSection {
            display: none;
            margin-top: 16px;
        }
        .socios-section-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--accent-bright);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .socios-section-title .hint {
            font-weight: 400;
            color: var(--text-muted);
            font-size: 0.78rem;
        }
        .socio-row {
            display: grid;
            grid-template-columns: 1fr 80px 1fr;
            gap: 10px;
            margin-bottom: 8px;
            align-items: center;
        }
        @media (max-width: 500px) {
            .socio-row {
                grid-template-columns: 1fr;
                gap: 6px;
                padding-bottom: 10px;
                border-bottom: 1px solid var(--border-subtle);
                margin-bottom: 10px;
            }
        }
        .socio-field input {
            width: 100%;
            padding: 8px 10px;
            background: var(--bg-input);
            border: 1px solid var(--border-base);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: var(--font-body);
            font-size: 0.85rem;
            outline: none;
            transition: border-color var(--transition-fast);
        }
        .socio-field input:focus {
            border-color: var(--accent);
        }
        .socio-input-group {
            display: flex;
            align-items: center;
        }
        .socio-input-group input {
            border-radius: 6px 0 0 6px;
            text-align: center;
        }
        .socio-suffix {
            background: var(--bg-deepest);
            color: var(--text-muted);
            padding: 8px 8px;
            border-radius: 0 6px 6px 0;
            font-size: 0.82rem;
            font-weight: 600;
            border: 1.5px solid var(--border-base);
            border-left: none;
        }
        .socios-total {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.82rem;
            font-weight: 600;
            margin-top: 8px;
        }
        .socios-total.valid {
            background: rgba(22,163,74,0.06);
            color: var(--accent);
        }
        .socios-total.invalid {
            background: rgba(220,38,38,0.06);
            color: var(--red);
        }
        .socios-total span:first-child {
            color: var(--text-muted);
        }
        .socios-total .socios-status {
            margin-left: auto;
            font-weight: 700;
        }
        .socios-presets {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .socios-presets button {
            padding: 5px 14px;
            font-size: 0.78rem;
            font-weight: 600;
            font-family: var(--font-body);
            background: var(--bg-deepest);
            border: 1.5px solid var(--border-base);
            border-radius: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        .socios-presets button:hover {
            border-color: var(--accent);
            color: #fff;
            background: var(--accent);
        }

        /* Socio column headers */
        .socios-header {
            display: grid;
            grid-template-columns: 1fr 80px 1fr;
            gap: 10px;
            margin-bottom: 6px;
            font-size: 0.72rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        @media (max-width: 500px) {
            .socios-header { display: none; }
        }

        /* ═══════════════════════════════════════════ */
        /*  BUTTON                                     */
        /* ═══════════════════════════════════════════ */
        .btn-calcular {
            width: 100%;
            padding: 16px;
            font-size: 1.1rem;
            font-weight: 700;
            font-family: var(--font-body);
            color: #fff;
            background: linear-gradient(135deg, var(--accent), #22c55e);
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
        }
        .btn-calcular:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 8px 24px var(--accent-glow);
        }
        .btn-calcular:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .btn-calcular::after {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
            transition: left 0.6s ease;
        }
        .btn-calcular:hover:not(:disabled)::after { left: 100%; }

        .btn-secondary {
            padding: 12px 24px;
            font-size: 0.95rem;
            font-weight: 600;
            font-family: var(--font-body);
            color: var(--text-primary);
            background: var(--bg-card);
            border: 1.5px solid var(--border-base);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        .btn-secondary:hover:not(:disabled) {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(22,163,74,0.04);
        }
        .btn-secondary:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* ═══════════════════════════════════════════ */
        /*  RESULTS AREA                               */
        /* ═══════════════════════════════════════════ */
        #formArea, #resultArea { transition: opacity var(--transition-base); }
        #resultArea { display: none; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-deepest);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            padding: 4px;
            margin-bottom: 20px;
            overflow-x: auto;
        }
        .tab-btn {
            flex: 1;
            padding: 10px 8px;
            font-size: 0.82rem;
            font-weight: 600;
            font-family: var(--font-body);
            color: var(--text-muted);
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all var(--transition-fast);
            white-space: nowrap;
            text-align: center;
        }
        .tab-btn.active {
            background: var(--accent);
            color: #fff;
        }
        .tab-btn:hover:not(.active) { color: var(--text-secondary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Winner Card */
        .winner-card {
            background: linear-gradient(135deg, rgba(22,163,74,0.06), rgba(22,163,74,0.02));
            border: 2px solid var(--accent);
            border-radius: var(--radius-lg);
            padding: 28px;
            text-align: center;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }
        .winner-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent), #22c55e);
        }
        .winner-label {
            font-size: 0.8rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            color: var(--accent);
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        .winner-regime {
            font-size: 1.6rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        .winner-value {
            font-family: var(--font-mono);
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--accent-bright);
        }
        .winner-sub {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 6px;
        }

        /* Regime Cards */
        .regime-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .regime-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: 20px;
            position: relative;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
        }
        .regime-card.pos-1 { border-color: var(--accent); }
        .regime-card.pos-2 { border-color: var(--border-base); }
        .regime-card.pos-3 { border-color: var(--border-base); }
        .regime-card .medal {
            font-size: 1.4rem;
            position: absolute;
            top: 14px; right: 16px;
        }
        .regime-card .regime-name {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 12px;
        }
        .regime-card .regime-total {
            font-family: var(--font-mono);
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent-bright);
            margin-bottom: 4px;
        }
        .regime-card .regime-aliq {
            font-size: 0.82rem;
            color: var(--text-muted);
            font-family: var(--font-mono);
        }
        .regime-card .regime-breakdown {
            margin-top: 14px;
            border-top: 1px solid var(--border-subtle);
            padding-top: 12px;
        }
        .regime-card .regime-breakdown .bk-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            font-size: 0.82rem;
        }
        .regime-card .regime-breakdown .bk-row span:first-child { color: var(--text-muted); }
        .regime-card .regime-breakdown .bk-row span:last-child { font-family: var(--font-mono); font-weight: 600; }
        .regime-card .regime-ineligible {
            color: var(--red);
            font-size: 0.88rem;
            font-weight: 600;
            text-align: center;
            padding: 20px 0;
        }

        /* Alerts */
        .alert-list { margin-top: 12px; }
        .alert-item {
            background: rgba(217,119,6,0.06);
            border-left: 3px solid var(--amber);
            padding: 8px 12px;
            font-size: 0.82rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        }
        .alert-item.danger, .alert-item.error {
            background: rgba(220,38,38,0.06);
            border-left-color: var(--red);
        }
        .alert-item.info {
            background: rgba(37,99,235,0.06);
            border-left-color: var(--blue);
        }
        .validacao-alertas {
            margin-bottom: 16px;
        }

        /* Detail Table */
        .detail-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.82rem;
            margin: 20px 0;
        }
        .detail-table th {
            text-align: left;
            padding: 10px 12px;
            background: var(--bg-deep);
            color: var(--text-muted);
            font-weight: 600;
            border-bottom: 1px solid var(--border-subtle);
        }
        .detail-table td {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-subtle);
            font-family: var(--font-mono);
            font-size: 0.82rem;
        }
        .detail-table tr:last-child td {
            font-weight: 700;
            color: var(--accent-bright);
            border-bottom: 2px solid var(--accent);
        }
        .detail-table.socios-detail tr:last-child td {
            font-weight: 400;
            color: inherit;
            border-bottom: 1px solid var(--border-subtle);
        }
        .detail-table tr.row-warning {
            background: rgba(217,119,6,0.05);
        }
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* CSS Bar Chart */
        .chart-bars {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 20px;
            height: 200px;
            padding: 20px;
            margin: 20px 0;
        }
        .chart-bar-item { text-align: center; flex: 1; max-width: 140px; }
        .chart-bar {
            width: 100%;
            border-radius: 6px 6px 0 0;
            transition: height var(--transition-base);
            min-height: 4px;
            position: relative;
        }
        .chart-bar-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 8px;
            font-weight: 600;
        }
        .chart-bar-value {
            font-family: var(--font-mono);
            font-size: 0.78rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-top: 4px;
        }

        /* Donut SVG */
        .donut-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .donut-legend {
            font-size: 0.82rem;
        }
        .donut-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            color: var(--text-secondary);
        }
        .donut-legend-item .dot {
            width: 10px; height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        /* TEA / Personal / Projection cards */
        .info-card {
            background: var(--bg-deep);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            padding: 16px;
            margin-bottom: 16px;
        }
        .info-card h4 {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--accent-bright);
            margin-bottom: 12px;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 0.85rem;
        }
        .info-row span:first-child { color: var(--text-muted); }
        .info-row span:last-child { font-family: var(--font-mono); font-weight: 600; }
        .info-row.total { border-top: 1px solid var(--border-base); padding-top: 8px; margin-top: 4px; }
        .info-row.total span:last-child { color: var(--accent-bright); font-size: 1rem; }

        /* ═══════════════════════════════════════════ */
        /*  ALERTA R$ 50K — v1.0                  */
        /* ═══════════════════════════════════════════ */
        .alerta-50k {
            display: flex;
            gap: 12px;
            background: rgba(217,119,6,0.06);
            border: 1px solid rgba(217,119,6,0.25);
            border-radius: var(--radius-sm);
            padding: 14px;
            margin-top: 12px;
        }
        .alerta-50k-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        .alerta-50k-content {
            font-size: 0.82rem;
            color: var(--text-secondary);
        }
        .alerta-50k-content strong {
            color: var(--amber);
            display: block;
            margin-bottom: 4px;
        }
        .alerta-50k-content p {
            margin-top: 4px;
        }

        /* ═══════════════════════════════════════════ */
        /*  CENÁRIOS DE DISTRIBUIÇÃO — v1.0       */
        /* ═══════════════════════════════════════════ */
        .cenarios-card {
            border-color: rgba(22,163,74,0.18);
        }
        .cenario-item {
            background: var(--bg-deep);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            padding: 14px;
            margin-bottom: 10px;
            transition: border-color var(--transition-fast);
        }
        .cenario-item.cenario-melhor {
            border-color: var(--accent);
            background: rgba(22,163,74,0.03);
        }
        .cenario-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        .cenario-nome {
            font-weight: 700;
            font-size: 0.88rem;
            color: var(--text-primary);
        }
        .cenario-ir {
            font-family: var(--font-mono);
            font-size: 0.82rem;
            font-weight: 600;
            color: var(--red);
        }
        .cenario-desc {
            font-size: 0.78rem;
            color: var(--text-muted);
            margin-bottom: 10px;
        }
        .cenario-grid {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .cenario-socio {
            flex: 1;
            min-width: 120px;
            background: var(--bg-deep);
            border-radius: 6px;
            padding: 10px;
            text-align: center;
        }
        .cenario-socio-nome {
            display: block;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        .cenario-socio-valor {
            display: block;
            font-family: var(--font-mono);
            font-weight: 700;
            font-size: 0.88rem;
            color: var(--text-primary);
        }
        .cenario-socio-ir {
            display: block;
            font-size: 0.72rem;
            color: var(--red);
            margin-top: 2px;
        }
        .cenario-socio-isento {
            display: block;
            font-size: 0.72rem;
            color: var(--accent);
            margin-top: 2px;
        }
        .cenario-socio-reinv {
            display: block;
            font-size: 0.72rem;
            color: var(--blue);
            margin-top: 2px;
        }
        .cenario-economia {
            background: rgba(22,163,74,0.06);
            border: 1px solid rgba(22,163,74,0.15);
            border-radius: var(--radius-sm);
            padding: 12px;
            font-size: 0.85rem;
            color: var(--accent);
            margin-top: 12px;
        }

        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            flex-wrap: wrap;
        }
        .action-buttons .btn-secondary { flex: 1; text-align: center; min-width: 120px; }

        /* Projection bars */
        .proj-month {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
            font-size: 0.82rem;
        }
        .proj-month .proj-label {
            width: 60px;
            color: var(--text-muted);
            font-family: var(--font-mono);
            flex-shrink: 0;
        }
        .proj-month .proj-bar-track {
            flex: 1;
            height: 8px;
            background: var(--border-base);
            border-radius: 4px;
            overflow: hidden;
        }
        .proj-month .proj-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width var(--transition-base);
        }
        .proj-month .proj-value {
            font-family: var(--font-mono);
            font-weight: 600;
            font-size: 0.78rem;
            width: 100px;
            text-align: right;
            flex-shrink: 0;
        }
        .proj-alert {
            background: rgba(220,38,38,0.06);
            border: 1px solid rgba(220,38,38,0.15);
            border-radius: var(--radius-sm);
            padding: 10px 14px;
            font-size: 0.82rem;
            color: var(--red);
            margin-top: 12px;
        }

        /* Loading overlay */
        #loadingOverlay {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            color: var(--text-muted);
            font-size: 1rem;
        }
        .spinner {
            width: 32px; height: 32px;
            border: 3px solid var(--border-base);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 12px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-base); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        /* Error highlight */
        .field-error input, .field-error select {
            border-color: var(--red) !important;
            box-shadow: 0 0 0 3px rgba(220,38,38,0.15) !important;
        }

        /* Hidden */
        .hidden { display: none !important; }

        /* ═══════════════════════════════════════════ */
        /*  CENÁRIOS COMPARADOR AVANÇADO — v1.0        */
        /* ═══════════════════════════════════════════ */
        .cenario-variacao {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            padding: 14px 16px;
            margin-bottom: 8px;
            display: grid;
            grid-template-columns: 80px 1fr 140px 120px;
            gap: 12px;
            align-items: center;
            transition: all var(--transition-fast);
        }
        @media (max-width: 600px) {
            .cenario-variacao {
                grid-template-columns: 1fr;
                gap: 6px;
            }
        }
        .cenario-variacao:hover {
            border-color: var(--accent);
            background: var(--bg-card-hover);
        }
        .cenario-variacao.cenario-atual {
            border-color: var(--accent);
            background: rgba(22,163,74,0.04);
        }
        .cenario-variacao .cv-variacao {
            font-family: var(--font-mono);
            font-size: 0.95rem;
            font-weight: 700;
        }
        .cenario-variacao .cv-variacao.positiva { color: var(--accent); }
        .cenario-variacao .cv-variacao.negativa { color: var(--red); }
        .cenario-variacao .cv-variacao.neutra { color: var(--blue); }
        .cenario-variacao .cv-faturamento {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .cenario-variacao .cv-faturamento span {
            font-family: var(--font-mono);
            font-weight: 600;
        }
        .cenario-variacao .cv-regime {
            font-size: 0.88rem;
            font-weight: 700;
            text-align: center;
            padding: 4px 12px;
            border-radius: 20px;
        }
        .cenario-variacao .cv-regime.simples { background: rgba(22,163,74,0.10); color: var(--accent-bright); }
        .cenario-variacao .cv-regime.presumido { background: rgba(37,99,235,0.10); color: var(--blue); }
        .cenario-variacao .cv-regime.lucro_real { background: rgba(124,58,237,0.10); color: var(--purple); }
        .cenario-variacao .cv-carga {
            font-family: var(--font-mono);
            font-size: 0.85rem;
            font-weight: 600;
            text-align: right;
            color: var(--text-primary);
        }
        .cenarios-header-row {
            display: grid;
            grid-template-columns: 80px 1fr 140px 120px;
            gap: 12px;
            padding: 8px 16px;
            font-size: 0.72rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border-subtle);
            margin-bottom: 8px;
        }
        @media (max-width: 600px) {
            .cenarios-header-row { display: none; }
        }
        .comparador-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(22,163,74,0.06);
            border: 1px solid rgba(22,163,74,0.15);
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 0.72rem;
            font-weight: 700;
            color: var(--accent);
            margin-top: 12px;
        }
        .comparador-badge code {
            font-family: var(--font-mono);
            background: rgba(22,163,74,0.10);
            padding: 1px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
        }

        /* ═══════════════════════════════════════════ */
        /*  LUCRO REAL ADVANTAGES PANEL — v1.0         */
        /* ═══════════════════════════════════════════ */
        .lr-vantagens-card {
            background: linear-gradient(135deg, rgba(22,163,74,0.04), rgba(37,99,235,0.03));
            border: 2px solid rgba(22,163,74,0.20);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin: 20px 0;
        }
        .lr-vantagens-card h4 {
            font-size: 1rem;
            font-weight: 700;
            color: var(--accent-bright);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .lr-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 4px;
            font-size: 0.88rem;
            transition: background 0.15s;
        }
        .lr-item:hover { background: rgba(22,163,74,0.04); }
        .lr-item .lr-label { color: var(--text-secondary); display: flex; align-items: center; gap: 6px; }
        .lr-item .lr-value { font-family: var(--font-mono); font-weight: 700; color: var(--accent-bright); }
        .lr-item .lr-value.negative { color: var(--red); }
        .lr-item.lr-total {
            border-top: 2px solid var(--accent);
            margin-top: 8px;
            padding-top: 12px;
            font-weight: 700;
        }
        .lr-item.lr-total .lr-value { font-size: 1.05rem; }
        .lr-item.lr-custo { background: rgba(220,38,38,0.04); }
        .lr-item.lr-economia-liq { background: rgba(22,163,74,0.06); border-radius: 8px; padding: 12px; }
        .lr-item.lr-economia-liq .lr-value { font-size: 1.1rem; color: var(--accent); }

        /* Score Badge */
        .score-container {
            display: flex;
            align-items: center;
            gap: 16px;
            margin: 16px 0;
            padding: 16px;
            background: var(--bg-deep);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-subtle);
        }
        .score-ring {
            width: 80px; height: 80px;
            position: relative;
            flex-shrink: 0;
        }
        .score-ring svg { transform: rotate(-90deg); }
        .score-ring .score-text {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-family: var(--font-mono);
            font-size: 1.2rem;
            font-weight: 800;
        }
        .score-details { flex: 1; }
        .score-details h5 { font-size: 0.9rem; font-weight: 700; margin-bottom: 4px; }
        .score-details p { font-size: 0.82rem; color: var(--text-muted); }

        /* Tooltip helper */
        .field-help {
            display: inline-block;
            width: 16px; height: 16px;
            background: var(--accent-dim);
            color: var(--accent);
            border-radius: 50%;
            text-align: center;
            font-size: 0.68rem;
            font-weight: 800;
            line-height: 16px;
            cursor: help;
            margin-left: 4px;
            position: relative;
        }
        .field-help:hover::after {
            content: attr(data-tip);
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-primary);
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 400;
            white-space: normal;
            width: 260px;
            z-index: 200;
            line-height: 1.4;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }

        /* Break-even card */
        .breakeven-card {
            background: var(--bg-deep);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: 16px;
            margin: 16px 0;
        }
        .breakeven-card h5 { font-size: 0.88rem; font-weight: 700; color: var(--blue); margin-bottom: 10px; }

        .bolso-comparison {
            background: var(--bg-deep);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: 20px;
            margin: 20px 0;
        }
        .bolso-comparison .regime-cards {
            gap: 12px;
        }

        .breakeven-bar {
            height: 24px;
            background: var(--border-base);
            border-radius: 12px;
            position: relative;
            overflow: visible;
            margin: 12px 0 8px;
        }
        .breakeven-bar-fill {
            height: 100%;
            border-radius: 12px;
            transition: width 0.5s ease;
        }
        .breakeven-marker {
            position: absolute;
            top: -6px;
            width: 3px;
            height: 36px;
            background: var(--text-primary);
            border-radius: 2px;
        }
        .breakeven-marker-label {
            position: absolute;
            top: 34px;
            font-size: 0.68rem;
            font-weight: 700;
            white-space: nowrap;
            transform: translateX(-50%);
        }

        /* Collapsible Section */
        .section-collapsible { cursor: pointer; user-select: none; }
        .section-collapsible .toggle-icon {
            transition: transform 0.2s;
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        .section-collapsible.collapsed .toggle-icon { transform: rotate(-90deg); }
        .section-collapsible.collapsed + .section-body { display: none; }
        .section.collapsed .section-body { display: none; }
        .section-header { cursor: pointer; display: flex; align-items: center; justify-content: space-between; }
        .section-header h3 { font-size: 1rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .section-header .section-num { background: var(--accent); color: #fff; font-family: var(--font-mono); font-size: 0.75rem; font-weight: 700; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .section-header .section-tag { font-size: 0.72rem; font-weight: 600; color: var(--text-muted); background: var(--bg-deepest); padding: 2px 8px; border-radius: 10px; margin-left: 8px; }
        .section-header .chevron { font-size: 0.8rem; color: var(--text-muted); transition: transform 0.2s; }
        .section.collapsed .chevron { transform: rotate(-90deg); }
        .field-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        @media (max-width: 600px) { .field-grid { grid-template-columns: 1fr; } }
        .check-label { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--text-secondary); cursor: pointer; }
        .check-label input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--accent); }

        /* Obrigacoes comparison */
        .obrig-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            font-size: 0.78rem;
            margin-top: 12px;
        }
        @media (max-width: 600px) { .obrig-grid { grid-template-columns: 1fr; } }
        .obrig-col h6 {
            font-size: 0.72rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 6px;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--border-subtle);
        }
        .obrig-item { padding: 3px 0; color: var(--text-secondary); }

        /* ═══════════════════════════════════════════ */
        /*  ESTADO INFO PANEL — v1.0                   */
        /* ═══════════════════════════════════════════ */
        #estadoInfoPanel {
            display: none;
            background: var(--bg-deep);
            border: 1px solid var(--border-active);
            border-radius: var(--radius-md);
            padding: 18px;
            margin-top: 14px;
            animation: fadeSlideIn 0.3s ease;
        }
        @keyframes fadeSlideIn {
            from { opacity: 0; transform: translateY(-6px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .estado-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 14px;
        }
        .estado-panel-header h4 {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--accent-bright);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .estado-panel-header .regiao-badge {
            font-size: 0.68rem;
            font-weight: 700;
            padding: 2px 10px;
            border-radius: 10px;
            background: rgba(22,163,74,0.08);
            color: var(--accent);
        }
        .estado-panel-header .status-badge {
            font-size: 0.68rem;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
        }
        .estado-panel-header .status-badge.ok {
            background: rgba(22,163,74,0.08);
            color: var(--accent);
        }
        .estado-panel-header .status-badge.warn {
            background: rgba(217,119,6,0.08);
            color: var(--amber);
        }
        .estado-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        @media (max-width: 600px) {
            .estado-grid { grid-template-columns: 1fr; }
        }
        .estado-imposto-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            padding: 12px;
            transition: border-color var(--transition-fast);
        }
        .estado-imposto-card:hover {
            border-color: var(--accent);
        }
        .estado-imposto-card .card-label {
            font-size: 0.72rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 4px;
        }
        .estado-imposto-card .card-value {
            font-family: var(--font-mono);
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .estado-imposto-card .card-detail {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 2px;
        }
        .estado-imposto-card .card-value.destaque {
            color: var(--accent-bright);
        }
        .estado-imposto-card .card-value.alerta {
            color: var(--red);
        }
        .estado-incentivos {
            margin-top: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .incentivo-tag {
            font-size: 0.7rem;
            font-weight: 700;
            padding: 3px 10px;
            border-radius: 10px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .incentivo-tag.ativo {
            background: rgba(22,163,74,0.08);
            color: var(--accent);
        }
        .incentivo-tag.inativo {
            background: rgba(138,133,120,0.08);
            color: var(--text-muted);
        }
        /* Comparativo Ranking Mini */
        .ranking-mini {
            background: var(--bg-deep);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            padding: 12px;
            margin-top: 14px;
        }
        .ranking-mini h5 {
            font-size: 0.82rem;
            font-weight: 700;
            color: var(--accent-bright);
            margin-bottom: 10px;
        }
        .ranking-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            font-size: 0.8rem;
        }
        .ranking-row .rank-pos {
            font-family: var(--font-mono);
            font-size: 0.72rem;
            font-weight: 700;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .ranking-row .rank-pos.pos-1 { background: rgba(22,163,74,0.12); color: var(--accent); }
        .ranking-row .rank-pos.pos-2 { background: rgba(37,99,235,0.10); color: var(--blue); }
        .ranking-row .rank-pos.pos-3 { background: rgba(217,119,6,0.10); color: var(--amber); }
        .ranking-row .rank-pos.pos-other { background: var(--bg-deepest); color: var(--text-muted); }
        .ranking-row .rank-uf {
            font-weight: 600;
            color: var(--text-primary);
            min-width: 32px;
        }
        .ranking-row .rank-bar {
            flex: 1;
            height: 6px;
            background: var(--border-base);
            border-radius: 3px;
            overflow: hidden;
        }
        .ranking-row .rank-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        .ranking-row .rank-value {
            font-family: var(--font-mono);
            font-weight: 600;
            font-size: 0.78rem;
            min-width: 50px;
            text-align: right;
        }
        .ranking-row.current {
            background: rgba(22,163,74,0.04);
            border-radius: 4px;
            padding: 4px 6px;
        }
        .ranking-row.current .rank-uf { color: var(--accent-bright); }
        /* Estado - alertas e dicas */
        .estado-dicas {
            margin-top: 12px;
            padding: 10px 14px;
            background: rgba(37,99,235,0.04);
            border-left: 3px solid var(--blue);
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
            font-size: 0.82rem;
            color: var(--text-secondary);
        }
        .estado-dicas strong { color: var(--blue); }
        .estado-st-alert {
            margin-top: 8px;
            padding: 8px 12px;
            background: rgba(217,119,6,0.06);
            border-left: 3px solid var(--amber);
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
            font-size: 0.78rem;
            color: var(--text-secondary);
        }

        /* ═══════════════════════════════════════════ */
        /*  PRINT STYLES — v1.0                   */
        /* ═══════════════════════════════════════════ */
        @media print {
            body { background: #fff; color: #111; }
            .container { max-width: 100%; padding: 0; }
            .action-buttons, .tabs { display: none !important; }
            .tab-content { display: block !important; page-break-inside: avoid; }
            .section, .info-card, .regime-card, .winner-card {
                background: #fff;
                border-color: #ddd;
                color: #111;
                box-shadow: none;
            }
            .detail-table th { background: #f5f5f5; }
            :root {
                --text-primary: #111;
                --text-secondary: #444;
                --text-muted: #777;
                --accent-bright: #15803d;
                --accent: #16a34a;
                --red: #dc2626;
            }
        }
    </style>
</head>
<body>
    <!-- NAVBAR -->
    <nav class="navbar">
        <div class="inner">
            <div style="display:flex;align-items:center">
                <a href="dashboard.html" class="logo">IMPOST<b>.</b></a>
                <span class="nav-sep">|</span>
                <span class="nav-sub">Comparador de Regimes</span>
            </div>
            <a href="dashboard.html" class="btn-back">← Dashboard</a>
        </div>
    </nav>

    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1>IMPOST<span>.</span> <span class="version-badge">v3.0</span></h1>
            <p>Comparador Inteligente de Regimes Tributários — Brasil 2026</p>
        </div>

        <!-- LOADING -->
        <div id="loadingOverlay">
            <div class="spinner"></div>
            <span>Carregando dados tributários...</span>
        </div>

        <!-- ═══ FORM AREA ═══ -->
        <div id="formArea" style="display:none;">

            <!-- SEÇÃO 1: Identificação -->
            <div class="section">
                <div class="section-title">
                    <span class="num">1</span> Identificação da Empresa
                </div>

                <div class="field-row">
                    <div class="field">
                        <label for="selectEstado">Estado (UF)</label>
                        <select id="selectEstado">
                            <option value="">Selecione o estado...</option>
                        </select>
                    </div>
                    <div class="field">
                        <label for="selectMunicipio">
                            Município
                            <span id="munLoading" style="display:none; margin-left:6px;">
                                <svg width="14" height="14" viewBox="0 0 24 24" style="animation:spin 1s linear infinite; vertical-align:middle;">
                                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" opacity="0.25"/>
                                    <path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="3" fill="none" stroke-linecap="round"/>
                                </svg>
                                <span style="font-size:0.75em; opacity:0.6;">carregando...</span>
                            </span>
                        </label>
                        <select id="selectMunicipio" disabled>
                            <option value="">Selecione o estado primeiro...</option>
                        </select>
                    </div>
                </div>

                <!-- ═══ Painel de Informações Tributárias do Estado ═══ -->
                <div id="estadoInfoPanel">
                    <div class="estado-panel-header">
                        <h4>
                            <span id="estadoNomePanel">—</span>
                            <span id="estadoRegiaoPanel" class="regiao-badge"></span>
                        </h4>
                        <span id="estadoStatusPanel" class="status-badge"></span>
                    </div>
                    <div class="estado-grid">
                        <div class="estado-imposto-card">
                            <div class="card-label">ICMS Padrão</div>
                            <div class="card-value" id="estadoICMS">—</div>
                            <div class="card-detail" id="estadoICMSDetail"></div>
                        </div>
                        <div class="estado-imposto-card">
                            <div class="card-label">ICMS Efetivo (c/ FECOP)</div>
                            <div class="card-value" id="estadoICMSEfetivo">—</div>
                            <div class="card-detail" id="estadoFECOPDetail"></div>
                        </div>
                        <div class="estado-imposto-card">
                            <div class="card-label">ISS (Capital)</div>
                            <div class="card-value" id="estadoISS">—</div>
                            <div class="card-detail" id="estadoISSDetail"></div>
                        </div>
                        <div class="estado-imposto-card">
                            <div class="card-label">Sublimite Simples</div>
                            <div class="card-value" id="estadoSublimite">—</div>
                            <div class="card-detail" id="estadoSublimiteDetail"></div>
                        </div>
                        <div class="estado-imposto-card">
                            <div class="card-label">IPVA Automóvel</div>
                            <div class="card-value" id="estadoIPVA">—</div>
                            <div class="card-detail" id="estadoIPVADetail"></div>
                        </div>
                        <div class="estado-imposto-card">
                            <div class="card-label">ITBI (Capital)</div>
                            <div class="card-value" id="estadoITBI">—</div>
                            <div class="card-detail" id="estadoITBIDetail"></div>
                        </div>
                    </div>
                    <div class="estado-incentivos" id="estadoIncentivos"></div>
                    <div id="estadoDicas" class="estado-dicas" style="display:none;"></div>
                    <div id="estadoSTAlert" class="estado-st-alert" style="display:none;"></div>
                    <!-- Mini Ranking ICMS -->
                    <div class="ranking-mini" id="rankingICMSMini">
                        <h5>📊 Ranking ICMS — Menor Carga (Top 5 + sua UF)</h5>
                        <div id="rankingICMSRows"></div>
                    </div>
                </div>

                <div class="field">
                    <label for="inputCNAE">CNAE — Atividade Econômica</label>
                    <div class="cnae-wrapper">
                        <input type="text" id="inputCNAE" placeholder="Digite o código ou nome da atividade..." autocomplete="off">
                        <div id="cnaeDropdown"></div>
                    </div>
                    <div id="cnaeInfo"></div>
                </div>

                <div class="field">
                    <label for="selectTipoAtividade">Tipo de Atividade <span class="hint">(inferido do CNAE)</span></label>
                    <select id="selectTipoAtividade">
                        <option value="">Selecione o CNAE primeiro...</option>
                        <option value="Comércio">Comércio</option>
                        <option value="Indústria">Indústria</option>
                        <option value="Serviço">Serviço</option>
                    </select>
                </div>
            </div>

            <!-- SEÇÃO 2: Dados Financeiros -->
            <div class="section">
                <div class="section-title">
                    <span class="num">2</span> Dados Financeiros
                </div>

                <div class="field-row">
                    <div class="field">
                        <label for="inputFaturamento">Faturamento Bruto Mensal <span class="hint">(obrigatório)</span></label>
                        <input type="text" id="inputFaturamento" class="money" placeholder="R$ 0,00" data-type="money">
                    </div>
                    <div class="field">
                        <label for="inputFolha">Folha de Pagamento Mensal <span class="hint">(salários + pró-labore)</span></label>
                        <input type="text" id="inputFolha" class="money" placeholder="R$ 0,00" data-type="money">
                    </div>
                </div>

                <div class="field-row">
                    <div class="field">
                        <label for="inputProLabore">Pró-labore Total dos Sócios <span class="hint">(já incluído na folha)</span></label>
                        <input type="text" id="inputProLabore" class="money" placeholder="R$ 0,00" data-type="money">
                    </div>
                    <div class="field">
                        <label for="inputCMV">CMV / CSV <span class="hint">(Custo de Mercadorias/Serviços)</span></label>
                        <input type="text" id="inputCMV" class="money" placeholder="R$ 0,00" data-type="money">
                    </div>
                </div>

                <div class="field">
                    <label for="inputDespesas">Despesas Operacionais <span class="hint">(aluguel, energia, internet, etc.)</span></label>
                    <input type="text" id="inputDespesas" class="money" placeholder="R$ 0,00" data-type="money">
                </div>

                <div class="field-row">
                    <div class="field">
                        <label for="inputCreditosPISCOFINS">
                            Despesas Elegíveis Crédito PIS/COFINS
                            <span class="field-help" data-tip="Aluguel, energia, combustível, equipamentos (depreciação), serviços PJ, telecomunicações, seguros, insumos. Essas despesas geram crédito de 9,25% no Lucro Real.">?</span>
                        </label>
                        <input type="text" id="inputCreditosPISCOFINS" class="money" placeholder="R$ 0,00 (mensal)" data-type="money">
                    </div>
                    <div class="field">
                        <label for="inputPctOrgaoPublico">
                            % Faturamento Órgãos Públicos
                            <span class="field-help" data-tip="Retenção de 9,45% na NF (IRRF 4,8% + CSRF 4,65%). No Lucro Real, 100% é compensável como antecipação.">?</span>
                        </label>
                        <div class="slider-group">
                            <input type="range" id="sliderOrgaoPublico" min="0" max="100" value="0" step="5">
                            <span class="slider-value" id="orgaoPublicoValue">0%</span>
                        </div>
                    </div>
                </div>

                <div class="field">
                    <label>Margem de Lucro Líquido</label>
                    <div class="slider-group">
                        <input type="range" id="sliderMargem" min="0" max="80" value="20" step="1">
                        <input type="text" id="inputMargem" style="width:70px;text-align:center;" value="20%">
                        <span id="margemBadge" class="hidden" style="font-size:0.7rem;color:var(--amber);">manual</span>
                    </div>
                </div>

                <!-- Indicator Bars -->
                <div id="barFatorR" class="bar-container">
                    <div class="bar-label">Fator R (Folha / Faturamento)</div>
                    <div class="bar-track">
                        <div id="barFatorRFill" class="bar-fill" style="width:0%;background:var(--red);"></div>
                        <div class="bar-marker" style="left:28%;">
                            <span class="bar-marker-label">28%</span>
                        </div>
                    </div>
                    <div id="barFatorRValue" class="bar-value" style="color:var(--red);">0,0%</div>
                    <div id="barFatorRMsg" style="font-size:0.78rem;color:var(--text-muted);margin-top:2px;"></div>
                </div>

                <div id="barRBT12" class="bar-container">
                    <div class="bar-label">Receita Bruta 12 meses (RBT12)</div>
                    <div class="bar-track">
                        <div id="barRBT12Fill" class="bar-fill" style="width:0%;background:var(--accent);"></div>
                        <div id="barRBT12MarkerSub" class="bar-marker" style="left:75%;">
                            <span class="bar-marker-label">Sublimite</span>
                        </div>
                        <div class="bar-marker" style="left:100%;">
                            <span class="bar-marker-label">4,8M</span>
                        </div>
                    </div>
                    <div id="barRBT12Value" class="bar-value" style="color:var(--accent);">R$ 0</div>
                </div>
            </div>

            <!-- SEÇÃO 3: Estratégia e Opções -->
            <div class="section">
                <div class="section-title">
                    <span class="num">3</span> Estratégia e Opções
                </div>

                <div id="dicaBanner">
                    <strong id="dicaTitulo"></strong><br>
                    <span id="dicaTexto"></span>
                </div>

                <div class="field-row">
                    <div class="field">
                        <label for="inputFuncionarios">Quantidade de Funcionários</label>
                        <input type="number" id="inputFuncionarios" min="0" value="0" placeholder="0">
                    </div>
                    <div class="field">
                        <label for="sliderSocios">Sócios com Pró-labore</label>
                        <div class="slider-group">
                            <input type="range" id="sliderSocios" min="1" max="6" value="1" step="1">
                            <span class="slider-value" id="sociosValue">1</span>
                        </div>
                    </div>
                </div>

                <!-- SEÇÃO SÓCIOS — v1.0 -->
                <div id="sociosSection">
                    <div class="socios-section-title">
                        👥 Configuração dos Sócios <span class="hint">(participação e pró-labore individual)</span>
                    </div>
                    <div class="socios-header">
                        <span>Nome</span>
                        <span>Part. (%)</span>
                        <span>Pró-labore</span>
                    </div>
                    <div id="sociosList"></div>
                </div>

                <div class="field-row" style="margin-top:16px;">
                    <div class="field">
                        <label for="inputCrescimento">Crescimento previsto 12 meses</label>
                        <div class="slider-group">
                            <input type="range" id="sliderCrescimento" min="0" max="100" value="10" step="1">
                            <span class="slider-value" id="crescimentoValue">10%</span>
                        </div>
                    </div>
                    <div class="field">
                        <label for="selectDestinoLucro">Destino do Lucro</label>
                        <select id="selectDestinoLucro">
                            <option value="retira">Retira tudo</option>
                            <option value="parcial" selected>Parcial (50%)</option>
                            <option value="reinveste">Reinveste tudo</option>
                        </select>
                    </div>
                </div>

                <div class="field-row">
                    <div class="field">
                        <label for="selectCliente">Tipo de Cliente Principal</label>
                        <select id="selectCliente">
                            <option value="b2c">B2C (Pessoa Física)</option>
                            <option value="b2b">B2B (Pessoa Jurídica)</option>
                            <option value="misto" selected>Misto</option>
                        </select>
                    </div>
                    <div class="field">
                        <label for="inputISS">Alíquota ISS <span class="hint">(%)</span></label>
                        <input type="text" id="inputISS" value="5,00" placeholder="Ex: 5,00" maxlength="5" style="font-family:var(--font-mono); max-width:120px;">
                        <div id="issHint" class="iss-hint">
                            <span style="color:var(--amber);">ℹ</span>
                            A alíquota de ISS geralmente varia entre <strong>2% e 5%</strong>
                            conforme a legislação municipal (LC 116/2003).
                            Se não informada, será usado <strong>5%</strong> (teto legal).
                        </div>
                    </div>
                </div>

                <div class="field">
                    <label>Opções Especiais</label>
                    <div class="check-group">
                        <label class="check-item">
                            <input type="checkbox" id="checkST"> Substituição Tributária
                        </label>
                        <label class="check-item">
                            <input type="checkbox" id="checkCesta"> Produto Cesta Básica
                        </label>
                        <label class="check-item">
                            <input type="checkbox" id="checkSudam"> Incentivo SUDAM/SUDENE (-75% IRPJ)
                        </label>
                        <label class="check-item">
                            <input type="checkbox" id="checkInterestadual"> Vendas Interestaduais
                        </label>
                    </div>
                </div>
            </div>

            <!-- SEÇÃO 4: Dados Avançados Lucro Real (colapsável) -->
            <div class="section">
                <div class="section-title section-collapsible collapsed" onclick="this.classList.toggle('collapsed')">
                    <span class="num">4</span> Dados Avançados — Lucro Real
                    <span class="hint" style="margin-left:auto;">(opcional, melhora precisão)</span>
                    <span class="toggle-icon">▼</span>
                </div>
                <div class="section-body">
                    <div class="field-row">
                        <div class="field">
                            <label for="inputPatrimonioLiquido">
                                Patrimônio Líquido (PL)
                                <span class="field-help" data-tip="Capital social + Reservas + Lucros acumulados. Usado para calcular JCP (Juros sobre Capital Próprio) — dedutível no Lucro Real.">?</span>
                            </label>
                            <input type="text" id="inputPatrimonioLiquido" class="money" placeholder="R$ 0,00" data-type="money">
                        </div>
                        <div class="field">
                            <label for="inputLucrosAcumulados">
                                Lucros Acumulados / Reservas
                                <span class="field-help" data-tip="Limite do JCP: 50% do lucro líquido OU 50% de lucros acumulados + reservas (o menor).">?</span>
                            </label>
                            <input type="text" id="inputLucrosAcumulados" class="money" placeholder="R$ 0,00" data-type="money">
                        </div>
                    </div>

                    <div class="field-row">
                        <div class="field">
                            <label for="inputPrejuizoFiscal">
                                Prejuízo Fiscal Acumulado
                                <span class="field-help" data-tip="Compensável até 30% do lucro ajustado por período. Exclusivo do Lucro Real — Simples e Presumido não permitem.">?</span>
                            </label>
                            <input type="text" id="inputPrejuizoFiscal" class="money" placeholder="R$ 0,00" data-type="money">
                        </div>
                        <div class="field">
                            <label for="inputBaseNegativaCSLL">
                                Base Negativa CSLL
                                <span class="field-help" data-tip="Similar ao prejuízo fiscal, mas para CSLL. Compensável até 30% da base positiva.">?</span>
                            </label>
                            <input type="text" id="inputBaseNegativaCSLL" class="money" placeholder="R$ 0,00" data-type="money">
                        </div>
                    </div>

                    <div class="field-row">
                        <div class="field">
                            <label for="inputInvestimentoAtivos">
                                Investimento em Ativos Fixos (12 meses)
                                <span class="field-help" data-tip="GPS, drones, veículos, computadores, equipamentos. Na SUDAM: depreciação 100% no ano. Gera crédito de PIS/COFINS + redução do lucro tributável.">?</span>
                            </label>
                            <input type="text" id="inputInvestimentoAtivos" class="money" placeholder="R$ 0,00" data-type="money">
                        </div>
                        <div class="field">
                            <label for="inputCustoContabilLR">
                                Custo Contábil Adicional LR (mensal)
                                <span class="field-help" data-tip="LALUR, ECD, ECF, EFD-Contribuições exigem contabilidade mais detalhada. Típico: R$ 1.500-3.000/mês a mais que Simples.">?</span>
                            </label>
                            <input type="text" id="inputCustoContabilLR" class="money" placeholder="R$ 2.000,00" data-type="money">
                        </div>
                    </div>

                    <div class="field-row">
                        <div class="field">
                            <label for="selectApuracaoLR">Tipo de Apuração Lucro Real</label>
                            <select id="selectApuracaoLR">
                                <option value="trimestral" selected>Trimestral</option>
                                <option value="anual">Anual (Estimativa Mensal)</option>
                            </select>
                        </div>
                        <div class="field">
                            <label for="inputTJLP">
                                TJLP Anual (%)
                                <span class="field-help" data-tip="Taxa de Juros de Longo Prazo. Usada no cálculo do JCP. Padrão: 6% a.a.">?</span>
                            </label>
                            <input type="text" id="inputTJLP" value="6,00" placeholder="6,00" maxlength="5" style="font-family:var(--font-mono); max-width:120px;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- SEÇÃO 5: DADOS LUCRO PRESUMIDO -->
            <div class="section">
                <div class="section-header" onclick="this.parentElement.classList.toggle('collapsed')">
                    <h3><span class="section-num">5</span> Dados Lucro Presumido <span class="section-tag">Opcional</span></h3>
                    <span class="chevron">▾</span>
                </div>
                <div class="section-body">
                    <p style="font-size:0.82rem;color:var(--text-muted);margin-bottom:16px;">
                        Preencha para cálculo preciso do Lucro Presumido usando o motor completo. Campos vazios usam valores padrão.
                    </p>
                    <div class="field-grid">
                        <div class="field">
                            <label for="inputDevolucoesLP">
                                Devoluções / Cancelamentos (trimestral)
                                <span class="field-help" data-tip="Devoluções de vendas e cancelamentos. Reduzem a receita bruta para cálculo da base presumida.">?</span>
                            </label>
                            <input type="text" id="inputDevolucoesLP" class="money" placeholder="R$ 0,00" oninput="window._IMPOST?.mascaraMoney?.(this)" onblur="window._IMPOST?.blurMoney?.(this)">
                        </div>
                        <div class="field">
                            <label for="inputDescontosIncondLP">
                                Descontos Incondicionais (trimestral)
                                <span class="field-help" data-tip="Descontos concedidos incondicionalmente na NF. Reduzem a base de cálculo.">?</span>
                            </label>
                            <input type="text" id="inputDescontosIncondLP" class="money" placeholder="R$ 0,00" oninput="window._IMPOST?.mascaraMoney?.(this)" onblur="window._IMPOST?.blurMoney?.(this)">
                        </div>
                        <div class="field">
                            <label for="inputGanhosCapitalLP">
                                Ganhos de Capital (trimestral)
                                <span class="field-help" data-tip="Lucro na venda de ativos (imóveis, veículos, equipamentos). Adicionado 100% à base de IRPJ e CSLL.">?</span>
                            </label>
                            <input type="text" id="inputGanhosCapitalLP" class="money" placeholder="R$ 0,00" oninput="window._IMPOST?.mascaraMoney?.(this)" onblur="window._IMPOST?.blurMoney?.(this)">
                        </div>
                        <div class="field">
                            <label for="inputRendimentosFinancLP">
                                Rendimentos Financeiros (trimestral)
                                <span class="field-help" data-tip="Rendimentos de aplicações financeiras, juros recebidos. ATENÇÃO: Adicionado 100% à base (risco fiscal comum quando esquecido).">?</span>
                            </label>
                            <input type="text" id="inputRendimentosFinancLP" class="money" placeholder="R$ 0,00" oninput="window._IMPOST?.mascaraMoney?.(this)" onblur="window._IMPOST?.blurMoney?.(this)">
                        </div>
                        <div class="field">
                            <label for="inputIRRFRetidoLP">
                                IRRF Retido na Fonte (trimestral)
                                <span class="field-help" data-tip="Imposto de renda retido na fonte sobre suas receitas (ex: serviços para órgãos públicos). Compensável do IRPJ devido.">?</span>
                            </label>
                            <input type="text" id="inputIRRFRetidoLP" class="money" placeholder="R$ 0,00" oninput="window._IMPOST?.mascaraMoney?.(this)" onblur="window._IMPOST?.blurMoney?.(this)">
                        </div>
                        <div class="field">
                            <label for="inputCSLLRetidaLP">
                                CSLL Retida na Fonte (trimestral)
                                <span class="field-help" data-tip="CSLL retida na fonte sobre suas receitas. Compensável da CSLL devida.">?</span>
                            </label>
                            <input type="text" id="inputCSLLRetidaLP" class="money" placeholder="R$ 0,00" oninput="window._IMPOST?.mascaraMoney?.(this)" onblur="window._IMPOST?.blurMoney?.(this)">
                        </div>
                        <div class="field">
                            <label for="inputLucroContabilLP">
                                Lucro Contábil Efetivo (anual)
                                <span class="field-help" data-tip="Se a empresa mantém escrituração contábil completa, informar o lucro contábil. Permite distribuir dividendos acima da base presumida.">?</span>
                            </label>
                            <input type="text" id="inputLucroContabilLP" class="money" placeholder="R$ 0,00" oninput="window._IMPOST?.mascaraMoney?.(this)" onblur="window._IMPOST?.blurMoney?.(this)">
                        </div>
                        <div class="field">
                            <label for="selectMesesAtividadeLP">
                                Meses de Atividade (ano anterior)
                                <span class="field-help" data-tip="Se a empresa iniciou atividades no ano anterior com menos de 12 meses, o limite de receita é proporcional (R$ 6,5M/mês).">?</span>
                            </label>
                            <select id="selectMesesAtividadeLP">
                                <option value="12" selected>12 meses (normal)</option>
                                <option value="11">11 meses</option>
                                <option value="10">10 meses</option>
                                <option value="9">9 meses</option>
                                <option value="8">8 meses</option>
                                <option value="7">7 meses</option>
                                <option value="6">6 meses</option>
                                <option value="5">5 meses</option>
                                <option value="4">4 meses</option>
                                <option value="3">3 meses</option>
                                <option value="2">2 meses</option>
                                <option value="1">1 mês</option>
                            </select>
                        </div>
                    </div>
                    <!-- Impedimentos -->
                    <div style="margin-top:16px;">
                        <label style="font-size:0.85rem;font-weight:600;color:var(--text-secondary);margin-bottom:8px;display:block;">Verificação de Impedimentos</label>
                        <div class="checkbox-group" style="display:flex;flex-direction:column;gap:8px;">
                            <label class="check-label"><input type="checkbox" id="checkInstFinanceira"> Instituição financeira ou equiparada</label>
                            <label class="check-label"><input type="checkbox" id="checkFactoring"> Factoring (fomento comercial)</label>
                            <label class="check-label"><input type="checkbox" id="checkRendaExterior"> Lucros, rendimentos ou ganhos de capital do exterior</label>
                            <label class="check-label"><input type="checkbox" id="checkIsencaoIR"> Benefício de isenção ou redução de IR</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- BOTÃO CALCULAR -->
            <button id="btnCalcular" class="btn-calcular" disabled>
                Comparar Regimes Tributários
            </button>
        </div>

        <!-- ═══ RESULTS AREA ═══ -->
        <div id="resultArea">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" data-tab="tabTributaria">Tributária</button>
                <button class="tab-btn" data-tab="tabSimplesNacional">Simples Nacional</button>
                <button class="tab-btn" data-tab="tabLucroPresumido">Lucro Presumido</button>
                <button class="tab-btn" data-tab="tabLucroReal">Lucro Real</button>
                <button class="tab-btn" data-tab="tabTEA">TEA</button>
                <button class="tab-btn" data-tab="tabPessoal">Pessoal</button>
                <button class="tab-btn" data-tab="tabReforma">Reforma</button>
                <button class="tab-btn" data-tab="tabProjecoes">Projeções</button>
                <button class="tab-btn" data-tab="tabCenarios">Cenários</button>
            </div>

            <!-- Tab 1: Análise Tributária -->
            <div id="tabTributaria" class="tab-content active"></div>

            <!-- Tab 2: Simples Nacional Detalhado -->
            <div id="tabSimplesNacional" class="tab-content"></div>

            <!-- Tab 3: Lucro Presumido Detalhado -->
            <div id="tabLucroPresumido" class="tab-content"></div>

            <!-- Tab 3: Lucro Real Detalhado -->
            <div id="tabLucroReal" class="tab-content"></div>

            <!-- Tab 3: Análise TEA -->
            <div id="tabTEA" class="tab-content"></div>

            <!-- Tab 3: Impacto Pessoal -->
            <div id="tabPessoal" class="tab-content"></div>

            <!-- Tab 4: Reforma Tributária (IBS/CBS) -->
            <div id="tabReforma" class="tab-content"></div>

            <!-- Tab 5: Projeções -->
            <div id="tabProjecoes" class="tab-content"></div>

            <!-- Tab 6: Cenários (Motor Avançado) -->
            <div id="tabCenarios" class="tab-content">
                <div class="section">
                    <div class="section-title">
                        <span class="num">📊</span> Simulação de Cenários — Variação de Faturamento
                    </div>
                    <p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:16px;">
                        O motor avançado (<strong>ComparadorRegimes v3.0</strong>) simula como o regime ideal muda
                        conforme seu faturamento varia. Inclui dados reais por UF, incentivos SUDAM/SUDENE,
                        FECOP/FECOEP, sublimites estaduais e alíquotas de ICMS/ISS por estado.
                    </p>
                    <div id="cenariosResultado">
                        <div style="text-align:center;padding:30px;color:var(--text-muted);">
                            <p>Os cenários serão calculados automaticamente após o cálculo principal.</p>
                            <p style="font-size:0.82rem;margin-top:8px;">Motor: <code style="font-family:var(--font-mono);background:var(--bg-deepest);padding:2px 6px;border-radius:4px;">comparador-regimes.js v3.0</code></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button id="btnVoltar" class="btn-secondary">← Refazer Simulação</button>
                <button id="btnPDF" class="btn-secondary" disabled>📄 Exportar PDF</button>
                <button id="btnExcel" class="btn-secondary" disabled>📊 Exportar Excel</button>
            </div>
        </div>
    </div>

    <!-- ═══ AUTH ═══ -->
    <script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore-compat.js"></script>
    <script src="../scripts/auth/firebase-config.js"></script>
    <script src="../scripts/auth/auth-guard.js"></script>
    <script src="../scripts/auth/user-service.js"></script>

    <!-- ═══ SCRIPTS ═══ -->
    <script src="../scripts/dados/impostos_federais.js"></script>
    <script src="../scripts/cnae/cnae-mapeamento.js"></script>
    <script src="../scripts/calculadoras/lucro-real-mapeamento.js"></script>

    <!-- ═══ Scripts de Estados — Base Tributária Completa (27 UFs) ═══ -->
    <script src="../scripts/estados/acre.js"></script>
    <script src="../scripts/estados/alagoas.js"></script>
    <script src="../scripts/estados/amapa.js"></script>
    <script src="../scripts/estados/amazonas.js"></script>
    <script src="../scripts/estados/bahia.js"></script>
    <script src="../scripts/estados/ceara.js"></script>
    <script src="../scripts/estados/distrito_federal.js"></script>
    <script src="../scripts/estados/espirito_santo.js"></script>
    <script src="../scripts/estados/goias.js"></script>
    <script src="../scripts/estados/maranhao.js"></script>
    <script src="../scripts/estados/mato_grosso.js"></script>
    <script src="../scripts/estados/mato_grosso_do_sul.js"></script>
    <script src="../scripts/estados/minas_gerais.js"></script>
    <script src="../scripts/estados/para.js"></script>
    <script src="../scripts/estados/paraiba.js"></script>
    <script src="../scripts/estados/parana.js"></script>
    <script src="../scripts/estados/pernambuco.js"></script>
    <script src="../scripts/estados/piaui.js"></script>
    <script src="../scripts/estados/rio_de_janeiro.js"></script>
    <script src="../scripts/estados/rio_grande_do_norte.js"></script>
    <script src="../scripts/estados/rio_grande_do_sul.js"></script>
    <script src="../scripts/estados/rondonia.js"></script>
    <script src="../scripts/estados/roraima.js"></script>
    <script src="../scripts/estados/santa_catarina.js"></script>
    <script src="../scripts/estados/sao_paulo.js"></script>
    <script src="../scripts/estados/sergipe.js"></script>
    <script src="../scripts/estados/tocantins.js"></script>
    <script src="../scripts/dados/estados.js"></script>

    <script src="../scripts/dados/municipios.js"></script>
    <script type="module">
        import { BANCO_CNAE } from '../scripts/cnae/cnae.js';
        window.BANCO_CNAE = BANCO_CNAE;
        window.dispatchEvent(new Event('cnae-loaded'));
    </script>
    <script src="../scripts/calculadoras/lucro_presumido.js"></script>
    <script src="../scripts/calculadoras/simples_nacional.js"></script>
    <script src="../scripts/calculadoras/comparador-regimes.js"></script>
    <script src="../scripts/calculadoras/reforma-tributaria.js"></script>

    <!-- ═══════════════════════════════════════════════════════════════════ -->
    <!-- MOTOR INTEGRADO v3.0 — Substitui analise.js                        -->
    <!-- Usa ComparadorRegimes.comparar() como fonte única de verdade       -->
    <!-- ═══════════════════════════════════════════════════════════════════ -->
    <script>
    (function() {
        'use strict';

        // ═══════════════════════════════════════════════════
        //  UTILITÁRIOS
        // ═══════════════════════════════════════════════════
        var $ = function(id) { return document.getElementById(id); };
        var $$ = function(sel) { return document.querySelectorAll(sel); };

        function formatBRL(v) {
            return 'R$ ' + (v || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        function formatPct(v) {
            if (v == null || isNaN(v)) return 'N/D';
            return (v * 100).toFixed(2).replace('.', ',') + '%';
        }
        function formatPctShort(v) {
            if (v == null || isNaN(v)) return 'N/D';
            var n = (v * 100);
            return (n % 1 === 0 ? n.toFixed(0) : n.toFixed(1)).replace('.', ',') + '%';
        }

        // ═══ Money mask ═══
        function mascaraMoney(el) {
            var val = el.value.replace(/\D/g, '');
            if (!val) { el.value = ''; return; }
            var num = parseInt(val, 10);
            el.value = (num / 100).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }
        function parseMoney(el) {
            if (!el || !el.value) return 0;
            var raw = el.value.replace(/[^\d,.-]/g, '').replace(/\./g, '').replace(',', '.');
            return parseFloat(raw) || 0;
        }
        // Expose for inline handlers
        window._IMPOST = {
            mascaraMoney: mascaraMoney,
            blurMoney: function(el) { if (el && el.value) mascaraMoney(el); }
        };

        // ═══════════════════════════════════════════════════
        //  VARIÁVEIS GLOBAIS
        // ═══════════════════════════════════════════════════
        var CR = null; // ComparadorRegimes
        var ES = null; // Estados
        var ultimoResultado = null;
        var sociosConfig = [{ nome: 'Sócio 1', participacao: 100, proLabore: 0 }];

        // ═══════════════════════════════════════════════════
        //  INICIALIZAÇÃO
        // ═══════════════════════════════════════════════════
        function init() {
            // Aguardar ComparadorRegimes
            var attempts = 0;
            var iv = setInterval(function() {
                attempts++;
                if (window.ComparadorRegimes) {
                    clearInterval(iv);
                    CR = window.ComparadorRegimes;
                    ES = window.Estados || window.EstadosBR || null;
                    console.log('[IMPOST v3] ComparadorRegimes v' + (CR.VERSAO || '?') + ' carregado.');
                    onReady();
                } else if (attempts > 100) {
                    clearInterval(iv);
                    console.error('[IMPOST v3] ComparadorRegimes não encontrado!');
                    $('loadingOverlay').innerHTML = '<div style="color:var(--red);text-align:center;">Erro: comparador-regimes.js não carregou. Verifique a console.</div>';
                }
            }, 50);
        }

        function onReady() {
            $('loadingOverlay').style.display = 'none';
            $('formArea').style.display = 'block';

            setupMoneyInputs();
            setupSliders();
            setupEstadoSelect();
            setupCNAE();
            setupSocios();
            setupValidacao();
            setupTabs();
            setupButtons();
            updateBars();

            console.log('[IMPOST v3] Interface pronta.');
        }

        // ═══════════════════════════════════════════════════
        //  SETUP MONEY INPUTS
        // ═══════════════════════════════════════════════════
        function setupMoneyInputs() {
            $$('input.money, input[data-type="money"]').forEach(function(el) {
                el.addEventListener('input', function() { mascaraMoney(this); });
                el.addEventListener('blur', function() { if (this.value) mascaraMoney(this); });
            });
        }

        // ═══════════════════════════════════════════════════
        //  SETUP SLIDERS
        // ═══════════════════════════════════════════════════
        function setupSliders() {
            bindSlider('sliderMargem', 'inputMargem', '%', function(v) {
                $('inputMargem').value = v + '%';
            });
            bindSlider('sliderOrgaoPublico', 'orgaoPublicoValue', '%');
            bindSlider('sliderSocios', 'sociosValue', '', function(v) {
                updateSociosSection(parseInt(v));
            });
            bindSlider('sliderCrescimento', 'crescimentoValue', '%');

            // Margem input manual
            var inputMargem = $('inputMargem');
            if (inputMargem) {
                inputMargem.addEventListener('change', function() {
                    var val = parseInt(this.value);
                    if (!isNaN(val) && val >= 0 && val <= 80) {
                        $('sliderMargem').value = val;
                    }
                });
            }
        }
        function bindSlider(sliderId, displayId, suffix, cb) {
            var slider = $(sliderId);
            var display = $(displayId);
            if (!slider) return;
            slider.addEventListener('input', function() {
                if (display) {
                    if (display.tagName === 'INPUT') display.value = this.value + suffix;
                    else display.textContent = this.value + suffix;
                }
                if (cb) cb(this.value);
                updateBars();
                validarFormulario();
            });
        }

        // ═══════════════════════════════════════════════════
        //  SETUP ESTADO SELECT + PAINEL
        // ═══════════════════════════════════════════════════
        function setupEstadoSelect() {
            var sel = $('selectEstado');
            if (!sel) return;

            // Preencher com estados do ComparadorRegimes
            var ufs = [
                ['AC','Acre'],['AL','Alagoas'],['AP','Amapá'],['AM','Amazonas'],
                ['BA','Bahia'],['CE','Ceará'],['DF','Distrito Federal'],['ES','Espírito Santo'],
                ['GO','Goiás'],['MA','Maranhão'],['MT','Mato Grosso'],['MS','Mato Grosso do Sul'],
                ['MG','Minas Gerais'],['PA','Pará'],['PB','Paraíba'],['PR','Paraná'],
                ['PE','Pernambuco'],['PI','Piauí'],['RJ','Rio de Janeiro'],['RN','Rio Grande do Norte'],
                ['RS','Rio Grande do Sul'],['RO','Rondônia'],['RR','Roraima'],['SC','Santa Catarina'],
                ['SP','São Paulo'],['SE','Sergipe'],['TO','Tocantins']
            ];
            sel.innerHTML = '<option value="">Selecione o estado...</option>';
            ufs.forEach(function(u) {
                sel.innerHTML += '<option value="' + u[0] + '">' + u[0] + ' — ' + u[1] + '</option>';
            });

            sel.addEventListener('change', function() {
                atualizarPainelEstado(this.value);
                setupMunicipio(this.value);
                validarFormulario();
            });
        }

        function atualizarPainelEstado(uf) {
            var panel = $('estadoInfoPanel');
            if (!panel || !uf || !CR) { if (panel) panel.style.display = 'none'; return; }

            var dados = CR.extrairDadosEstado(uf);
            panel.style.display = 'block';

            // Header
            $('estadoNomePanel').textContent = dados.nome || uf;
            $('estadoRegiaoPanel').textContent = dados.regiao || '';
            var status = $('estadoStatusPanel');
            if (dados.fonte === 'estados.js') {
                status.textContent = '✅ Dados reais';
                status.className = 'status-badge ok';
            } else {
                status.textContent = '⚠️ Estimativa';
                status.className = 'status-badge warn';
            }

            // Cards
            $('estadoICMS').textContent = dados.icms.aliquotaPadraoPerc || 'N/D';
            $('estadoICMSDetail').textContent = 'Alíquota modal padrão';
            $('estadoICMSEfetivo').textContent = dados.icms.aliquotaEfetivaPerc || 'N/D';
            var fecopTxt = dados.icms.fecop.existe ? dados.icms.fecop.nome + ': +' + dados.icms.fecop.adicionalPerc : 'Sem FECOP';
            $('estadoFECOPDetail').textContent = fecopTxt;
            $('estadoISS').textContent = dados.iss.aliquotaGeralPerc || 'N/D';
            $('estadoISSDetail').textContent = dados.iss.municipioReferencia || 'Capital';
            $('estadoSublimite').textContent = dados.simplesNacional.sublimiteFormatado || 'N/D';
            $('estadoSublimiteDetail').textContent = 'ICMS/ISS por fora acima disso';

            // IPVA
            var ipva = dados.ipva && dados.ipva.automovel;
            $('estadoIPVA').textContent = ipva ? formatPctShort(ipva) : 'N/D';
            $('estadoIPVADetail').textContent = 'Automóvel';

            // ITBI
            var itbi = dados.itbi && dados.itbi.aliquota;
            $('estadoITBI').textContent = itbi ? formatPctShort(itbi) : 'N/D';
            $('estadoITBIDetail').textContent = 'Capital';

            // Incentivos
            var incHtml = '';
            var inc = dados.incentivos;
            incHtml += '<span class="incentivo-tag ' + (inc.sudam ? 'ativo' : 'inativo') + '">' + (inc.sudam ? '✅' : '—') + ' SUDAM</span>';
            incHtml += '<span class="incentivo-tag ' + (inc.sudene ? 'ativo' : 'inativo') + '">' + (inc.sudene ? '✅' : '—') + ' SUDENE</span>';
            incHtml += '<span class="incentivo-tag ' + (inc.zfm ? 'ativo' : 'inativo') + '">' + (inc.zfm ? '✅' : '—') + ' ZFM</span>';
            if (inc.totalProgramasEstaduais > 0) {
                incHtml += '<span class="incentivo-tag ativo">📜 ' + inc.totalProgramasEstaduais + ' programa(s) estadual(is)</span>';
            }
            $('estadoIncentivos').innerHTML = incHtml;

            // Auto-check SUDAM
            var checkSudam = $('checkSudam');
            if (checkSudam) checkSudam.checked = inc.sudam || inc.sudene;

            // ISS auto-fill
            var issInput = $('inputISS');
            if (issInput && dados.iss.aliquotaGeral) {
                issInput.value = (dados.iss.aliquotaGeral * 100).toFixed(2).replace('.', ',');
            }
        }

        function setupMunicipio(uf) {
            var sel = $('selectMunicipio');
            if (!sel) return;
            sel.innerHTML = '<option value="">Selecione...</option>';
            sel.disabled = !uf;

            // Tentar usar municipios.js se disponível
            if (uf && window.MunicipiosIBGE && typeof window.MunicipiosIBGE.buscarPorUF === 'function') {
                var loading = $('munLoading');
                if (loading) loading.style.display = 'inline';
                sel.disabled = true;
                window.MunicipiosIBGE.buscarPorUF(uf).then(function(munis) {
                    sel.innerHTML = '<option value="">Selecione o município...</option>';
                    munis.forEach(function(m) {
                        sel.innerHTML += '<option value="' + m.nome + '">' + m.nome + '</option>';
                    });
                    sel.disabled = false;
                    if (loading) loading.style.display = 'none';
                }).catch(function() {
                    sel.innerHTML = '<option value="">Não foi possível carregar</option>';
                    if (loading) loading.style.display = 'none';
                });
            }
        }

        // ═══════════════════════════════════════════════════
        //  SETUP CNAE AUTOCOMPLETE
        // ═══════════════════════════════════════════════════
        function setupCNAE() {
            var input = $('inputCNAE');
            var dropdown = $('cnaeDropdown');
            var info = $('cnaeInfo');
            if (!input || !dropdown) return;

            // Aguardar BANCO_CNAE ou CM
            window.addEventListener('cnae-loaded', function() {
                console.log('[IMPOST v3] CNAE database carregada.');
            });

            var debounce = null;
            input.addEventListener('input', function() {
                clearTimeout(debounce);
                var q = this.value.trim();
                if (q.length < 2) { dropdown.style.display = 'none'; return; }
                debounce = setTimeout(function() { buscarCNAE(q); }, 200);
            });

            input.addEventListener('blur', function() {
                setTimeout(function() { dropdown.style.display = 'none'; }, 200);
            });

            function buscarCNAE(query) {
                var banco = window.BANCO_CNAE;
                if (!banco) { dropdown.style.display = 'none'; return; }

                var results = [];
                var qLower = query.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');

                banco.forEach(function(item) {
                    if (results.length >= 15) return;
                    var cod = item.codigo || item.code || '';
                    var desc = item.descricao || item.description || item.nome || '';
                    var cat = item.categoria || '';
                    var descNorm = desc.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');

                    if (cod.indexOf(query) >= 0 || descNorm.indexOf(qLower) >= 0) {
                        results.push({ codigo: cod, descricao: desc, categoria: cat });
                    }
                });

                if (results.length === 0) { dropdown.style.display = 'none'; return; }

                var html = '';
                results.forEach(function(r) {
                    var catClass = (r.categoria || '').toLowerCase().indexOf('com') >= 0 ? 'comercio' :
                                   (r.categoria || '').toLowerCase().indexOf('ind') >= 0 ? 'industria' : 'servico';
                    html += '<div class="cnae-item" data-code="' + r.codigo + '" data-desc="' + r.descricao.replace(/"/g, '&quot;') + '" data-cat="' + (r.categoria || '') + '">';
                    html += '<span class="cnae-text"><span class="code">' + r.codigo + '</span> ' + r.descricao + '</span>';
                    if (r.categoria) html += '<span class="cnae-badge ' + catClass + '">' + r.categoria + '</span>';
                    html += '</div>';
                });

                dropdown.innerHTML = html;
                dropdown.style.display = 'block';

                dropdown.querySelectorAll('.cnae-item').forEach(function(el) {
                    el.addEventListener('mousedown', function(e) {
                        e.preventDefault();
                        selecionarCNAE(this.dataset.code, this.dataset.desc, this.dataset.cat);
                    });
                });
            }

            function selecionarCNAE(code, desc, cat) {
                input.value = code + ' — ' + desc;
                input.dataset.code = code;
                input.dataset.desc = desc;
                dropdown.style.display = 'none';

                // Auto-select tipo atividade
                var tipoSel = $('selectTipoAtividade');
                if (tipoSel && cat) {
                    var catLow = cat.toLowerCase();
                    if (catLow.indexOf('com') >= 0) tipoSel.value = 'Comércio';
                    else if (catLow.indexOf('ind') >= 0) tipoSel.value = 'Indústria';
                    else tipoSel.value = 'Serviço';
                }

                // Mostrar info CNAE
                if (info && CR) {
                    var regras = CR.obterRegras(code, tipoSel ? tipoSel.value : cat);
                    var presLabel = CR.PRESUNCAO[regras.presuncao] ? CR.PRESUNCAO[regras.presuncao].descricao : regras.presuncao;
                    info.style.display = 'block';
                    info.innerHTML =
                        '<div class="cnae-info-title">' + code + ' — ' + desc + '</div>' +
                        '<div class="cnae-info-row"><span>Categoria</span><span>' + regras.categoria + '</span></div>' +
                        '<div class="cnae-info-row"><span>Anexo Simples</span><span>' + regras.anexo + (regras.fatorR ? ' (Fator R)' : '') + '</span></div>' +
                        '<div class="cnae-info-row"><span>Presunção IRPJ</span><span>' + formatPct(regras.presuncaoIRPJ) + '</span></div>' +
                        '<div class="cnae-info-row"><span>Presunção CSLL</span><span>' + formatPct(regras.presuncaoCSLL) + '</span></div>' +
                        '<div class="cnae-info-row"><span>Tributo Principal</span><span>' + regras.tipoTributo + '</span></div>' +
                        (regras.vedado ? '<span class="badge-vedado">⛔ VEDADO no Simples</span>' :
                         regras.fatorR ? '<span class="badge-warn">⚡ Sujeito ao Fator R (Folha ≥ 28% → Anexo III)</span>' :
                         '<span class="badge-ok">✅ Sem restrições</span>') +
                        (regras.nota ? '<div style="margin-top:6px;font-size:0.78rem;color:var(--text-muted);">' + regras.nota + '</div>' : '');
                }

                validarFormulario();
            }
        }

        // ═══════════════════════════════════════════════════
        //  SETUP SÓCIOS
        // ═══════════════════════════════════════════════════
        function setupSocios() {
            updateSociosSection(1);
        }
        function updateSociosSection(numSocios) {
            var section = $('sociosSection');
            var list = $('sociosList');
            if (!section || !list) return;

            section.style.display = numSocios > 1 ? 'block' : 'none';
            if (numSocios <= 1) {
                sociosConfig = [{ nome: 'Sócio 1', participacao: 100, proLabore: 0 }];
                return;
            }

            while (sociosConfig.length < numSocios) sociosConfig.push({ nome: 'Sócio ' + (sociosConfig.length + 1), participacao: 0, proLabore: 0 });
            sociosConfig = sociosConfig.slice(0, numSocios);
            // Equalizar participação
            var partEach = Math.floor(100 / numSocios);
            sociosConfig.forEach(function(s, i) { s.participacao = i === 0 ? 100 - partEach * (numSocios - 1) : partEach; });

            var html = '';
            sociosConfig.forEach(function(s, i) {
                html += '<div class="socio-row">';
                html += '<div class="socio-field"><input type="text" value="' + s.nome + '" data-idx="' + i + '" data-field="nome" placeholder="Nome"></div>';
                html += '<div class="socio-field"><div class="socio-input-group"><input type="number" value="' + s.participacao + '" data-idx="' + i + '" data-field="participacao" min="0" max="100" style="width:60px;text-align:center;"><span class="socio-suffix">%</span></div></div>';
                html += '<div class="socio-field"><input type="text" class="money" value="" data-idx="' + i + '" data-field="proLabore" placeholder="R$ 0,00"></div>';
                html += '</div>';
            });
            list.innerHTML = html;

            // Bind events
            list.querySelectorAll('input').forEach(function(el) {
                el.addEventListener('change', function() {
                    var idx = parseInt(this.dataset.idx);
                    var field = this.dataset.field;
                    if (field === 'nome') sociosConfig[idx].nome = this.value;
                    else if (field === 'participacao') sociosConfig[idx].participacao = parseInt(this.value) || 0;
                    else if (field === 'proLabore') sociosConfig[idx].proLabore = parseMoney(this);
                });
                if (el.classList.contains('money')) {
                    el.addEventListener('input', function() { mascaraMoney(this); });
                }
            });
        }

        // ═══════════════════════════════════════════════════
        //  BARS: Fator R e RBT12
        // ═══════════════════════════════════════════════════
        function updateBars() {
            var fat = parseMoney($('inputFaturamento'));
            var folha = parseMoney($('inputFolha'));

            // Fator R
            var barFR = $('barFatorR');
            if (barFR && fat > 0 && folha > 0) {
                barFR.style.display = 'block';
                var fatorR = folha / fat;
                var pct = Math.min(fatorR * 100, 100);
                var fill = $('barFatorRFill');
                fill.style.width = (pct / 0.6) + '%'; // scale 60% = 100% visual
                fill.style.background = fatorR >= 0.28 ? 'var(--accent)' : 'var(--red)';
                $('barFatorRValue').textContent = formatPct(fatorR);
                $('barFatorRValue').style.color = fatorR >= 0.28 ? 'var(--accent)' : 'var(--red)';
                var msg = $('barFatorRMsg');
                if (msg) msg.textContent = fatorR >= 0.28 ? '✅ Acima de 28% → Anexo III (menor carga)' : '⚠️ Abaixo de 28% → Anexo V (carga maior)';
            } else if (barFR) { barFR.style.display = 'none'; }

            // RBT12
            var barRBT = $('barRBT12');
            if (barRBT && fat > 0) {
                barRBT.style.display = 'block';
                var rbt12 = fat * 12;
                var pctRbt = Math.min((rbt12 / 4800000) * 100, 100);
                $('barRBT12Fill').style.width = pctRbt + '%';
                $('barRBT12Fill').style.background = rbt12 > 4800000 ? 'var(--red)' : rbt12 > 3600000 ? 'var(--amber)' : 'var(--accent)';
                $('barRBT12Value').textContent = formatBRL(rbt12);
            } else if (barRBT) { barRBT.style.display = 'none'; }
        }

        // ═══════════════════════════════════════════════════
        //  VALIDAÇÃO DO FORMULÁRIO
        // ═══════════════════════════════════════════════════
        function setupValidacao() {
            ['selectEstado', 'selectTipoAtividade'].forEach(function(id) {
                var el = $(id);
                if (el) el.addEventListener('change', validarFormulario);
            });
            var fatInput = $('inputFaturamento');
            if (fatInput) {
                fatInput.addEventListener('input', function() { updateBars(); validarFormulario(); });
                fatInput.addEventListener('keyup', function() { updateBars(); validarFormulario(); });
            }
            var folhaInput = $('inputFolha');
            if (folhaInput) {
                folhaInput.addEventListener('input', updateBars);
                folhaInput.addEventListener('keyup', updateBars);
            }
            setInterval(validarFormulario, 1500);
        }
        function validarFormulario() {
            var uf = $('selectEstado') ? $('selectEstado').value : '';
            var tipo = $('selectTipoAtividade') ? $('selectTipoAtividade').value : '';
            var fat = parseMoney($('inputFaturamento'));
            var btn = $('btnCalcular');
            if (btn) btn.disabled = !(uf && tipo && fat > 0);
        }

        // ═══════════════════════════════════════════════════
        //  TABS
        // ═══════════════════════════════════════════════════
        function setupTabs() {
            $$('.tabs .tab-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var tabId = this.dataset.tab;
                    $$('.tabs .tab-btn').forEach(function(b) { b.classList.remove('active'); });
                    $$('.tab-content').forEach(function(c) { c.classList.remove('active'); });
                    this.classList.add('active');
                    var tab = $(tabId);
                    if (tab) tab.classList.add('active');
                });
            });
        }

        // ═══════════════════════════════════════════════════
        //  BUTTONS
        // ═══════════════════════════════════════════════════
        function setupButtons() {
            $('btnCalcular').addEventListener('click', calcular);
            $('btnVoltar').addEventListener('click', function() {
                $('resultArea').style.display = 'none';
                $('formArea').style.display = 'block';
                $$('.tabs .tab-btn').forEach(function(b, i) { b.classList.toggle('active', i === 0); });
                $$('.tab-content').forEach(function(c, i) { c.classList.toggle('active', i === 0); });
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }

        // ═══════════════════════════════════════════════════
        //  CALCULAR — Função principal
        // ═══════════════════════════════════════════════════
        function calcular() {
            if (!CR) { alert('Motor não carregado.'); return; }

            var uf = $('selectEstado').value;
            var tipo = $('selectTipoAtividade').value;
            var cnaeInput = $('inputCNAE');
            var cnae = (cnaeInput && cnaeInput.dataset.code) || cnaeInput.value.split(' ')[0] || '';
            var fat = parseMoney($('inputFaturamento'));
            var folha = parseMoney($('inputFolha'));
            var proLabore = parseMoney($('inputProLabore'));
            var cmv = parseMoney($('inputCMV'));
            var despesas = parseMoney($('inputDespesas'));
            var margem = parseInt($('sliderMargem').value) / 100;
            var crescimento = parseInt($('sliderCrescimento') ? $('sliderCrescimento').value : '10') / 100;
            var numSocios = parseInt($('sliderSocios') ? $('sliderSocios').value : '1');

            // ISS override
            var issInput = $('inputISS');
            var issOverride = null;
            if (issInput && issInput.value) {
                var iv = parseFloat(issInput.value.replace(',', '.'));
                if (!isNaN(iv) && iv > 0 && iv <= 5) issOverride = iv / 100;
            }

            // Créditos
            var creditosPISCOFINS = parseMoney($('inputCreditosPISCOFINS'));

            // ═══ CHAMAR MOTOR (v3.0.3: passa valores absolutos — motor faz a conversão) ═══
            var res = CR.comparar({
                faturamentoMensal: fat,
                folhaMensal: folha,
                cnae: cnae,
                categoria: tipo,
                uf: uf,
                opcoes: {
                    margemLucro: margem,
                    aliquotaISS: issOverride,
                    // v3.0.3: passa CMV para cálculo dinâmico de crédito ICMS (Bug #5)
                    cmv: cmv > 0 ? cmv : null,
                    // v3.0.3: passa despesas elegíveis para crédito PIS/COFINS (Bug #3)
                    despesasElegiveis: creditosPISCOFINS > 0 ? creditosPISCOFINS : null
                }
            });

            // Enriquecer com dados extras
            res._extras = {
                proLabore: proLabore,
                cmv: cmv,
                despesas: despesas,
                numSocios: numSocios,
                socios: sociosConfig.slice(0, numSocios),
                crescimento: crescimento,
                creditosPISCOFINS: creditosPISCOFINS
            };

            ultimoResultado = res;
            window._lastComparadorResult = res;
            console.log('[IMPOST v3] Resultado:', res);

            // Renderizar todas as tabs
            renderTabTributaria(res);
            renderTabSimples(res);
            renderTabPresumido(res);
            renderTabReal(res);
            renderTabTEA(res);
            renderTabPessoal(res);
            renderTabReforma(res);
            renderTabProjecoes(res);
            renderTabCenarios(res);

            // Show results
            $('formArea').style.display = 'none';
            $('resultArea').style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ═══════════════════════════════════════════════════
        //  HELPERS DE RENDER
        // ═══════════════════════════════════════════════════
        function infoRow(label, value) { return '<div class="info-row"><span>' + label + '</span><span>' + value + '</span></div>'; }
        function infoRowTotal(label, value) { return '<div class="info-row total"><span>' + label + '</span><span style="color:var(--red);">' + value + '</span></div>'; }
        function tableRow(label, m, a) { return '<tr><td>' + label + '</td><td style="font-family:var(--font-mono);text-align:right;">' + formatBRL(m) + '</td><td style="font-family:var(--font-mono);text-align:right;">' + formatBRL(a) + '</td></tr>'; }
        function bkRow(l, v) { return '<div class="bk-row"><span>' + l + '</span><span>' + formatBRL(v) + '</span></div>'; }

        // ═══════════════════════════════════════════════════
        //  TAB 1: ANÁLISE TRIBUTÁRIA (RANKING)
        // ═══════════════════════════════════════════════════
        function renderTabTributaria(res) {
            var tab = $('tabTributaria');
            var melhor = res.ranking[0];
            var pior = res.ranking[res.ranking.length - 1];
            var econAnual = res.economiaAnual;
            var medals = ['🥇', '🥈', '🥉'];

            var html = '';

            // Winner Card
            html += '<div class="winner-card"><div class="winner-label">REGIME MAIS VANTAJOSO</div>';
            html += '<div class="winner-regime">' + melhor.nome + '</div>';
            html += '<div class="winner-value">' + formatBRL(melhor.total) + '/mês</div>';
            html += '<div class="winner-sub">' + formatPct(melhor.aliqEfetiva) + ' do faturamento' + (econAnual > 0 ? ' · Economia de ' + formatBRL(econAnual) + '/ano vs ' + pior.nome : '') + '</div></div>';

            // Regime Cards
            html += '<div class="regime-cards">';
            res.ranking.forEach(function(r, i) {
                var d = r.detalhes;
                html += '<div class="regime-card pos-' + (i + 1) + '"><span class="medal">' + (medals[i] || '') + '</span>';
                html += '<div class="regime-name">' + r.nome + '</div>';
                html += '<div class="regime-total">' + formatBRL(r.total) + '/mês</div>';
                html += '<div class="regime-aliq">' + formatPct(r.aliqEfetiva) + ' efetiva</div>';
                if (d) {
                    html += '<div class="regime-breakdown">';
                    if (d.das !== undefined) html += bkRow('DAS', d.das);
                    if (d.cppFora > 0) html += bkRow('CPP fora DAS', d.cppFora);
                    if (d.irpjFinal !== undefined && d.irpjFinal > 0) html += bkRow('IRPJ', d.irpjFinal);
                    if (d.csll > 0) html += bkRow('CSLL', d.csll);
                    if (d.pis > 0) html += bkRow('PIS', d.pis);
                    if (d.cofins > 0) html += bkRow('COFINS', d.cofins);
                    if (d.iss > 0) html += bkRow('ISS', d.iss);
                    if (d.icms > 0) html += bkRow('ICMS', d.icms);
                    if (d.cpp > 0) html += bkRow('Encargos (27,80%)', d.cpp);
                    if (d.fgts > 0) html += bkRow('FGTS (8%)', d.fgts);
                    if (d.irpjReducao > 0) html += '<div class="bk-row"><span>Redução ' + (d.tipoIncentivo || 'SUDAM') + '</span><span style="color:var(--accent);">-' + formatBRL(d.irpjReducao) + '</span></div>';
                    html += '</div>';
                }
                html += '</div>';
            });
            // Inelegível
            if (!res.ranking.find(function(r) { return r.id === 'simples'; })) {
                html += '<div class="regime-card"><div class="regime-name">Simples Nacional</div><div class="regime-ineligible">⛔ ' + (res.regras.vedado ? 'CNAE vedado' : 'Faturamento acima de R$ 4.800.000/ano') + '</div></div>';
            }
            html += '</div>';

            // CSS bar chart
            var maxVal = Math.max.apply(null, res.ranking.map(function(r) { return r.total; }));
            var colors = { simples: 'var(--accent)', presumido: 'var(--blue)', real: 'var(--purple)' };
            html += '<div class="chart-bars">';
            res.ranking.forEach(function(r) {
                var h = Math.round((r.total / maxVal) * 160);
                html += '<div class="chart-bar-item"><div class="chart-bar" style="height:' + h + 'px;background:' + (colors[r.id] || 'var(--accent)') + ';"></div>';
                html += '<div class="chart-bar-label">' + r.nomeAbreviado + '</div>';
                html += '<div class="chart-bar-value">' + formatBRL(r.total) + '</div></div>';
            });
            html += '</div>';

            // Recomendação
            html += '<div style="background:rgba(22,163,74,0.04);border:1px solid rgba(22,163,74,0.15);border-radius:var(--radius-md);padding:20px;margin:16px 0;font-size:0.88rem;line-height:1.7;color:var(--text-secondary);">';
            html += '<strong style="color:var(--accent-bright);">📋 Recomendação:</strong> ' + res.recomendacao + '</div>';

            // Comparativo tabela
            html += '<table class="detail-table"><thead><tr><th>Regime</th><th style="text-align:right;">Mensal</th><th style="text-align:right;">Anual</th><th style="text-align:right;">Alíq. Efetiva</th></tr></thead><tbody>';
            res.ranking.forEach(function(r) {
                html += '<tr><td>' + r.nome + '</td><td style="font-family:var(--font-mono);text-align:right;">' + formatBRL(r.total) + '</td><td style="font-family:var(--font-mono);text-align:right;">' + formatBRL(r.total * 12) + '</td><td style="font-family:var(--font-mono);text-align:right;">' + formatPct(r.aliqEfetiva) + '</td></tr>';
            });
            html += '</tbody></table>';

            tab.innerHTML = html;
        }

        // ═══════════════════════════════════════════════════
        //  TAB 2: SIMPLES NACIONAL
        // ═══════════════════════════════════════════════════
        function renderTabSimples(res) {
            var tab = $('tabSimplesNacional');
            var s = res.simples;
            if (!s) { tab.innerHTML = '<div class="info-card" style="border-color:rgba(220,38,38,0.2);"><h4 style="color:var(--red);">⛔ Inelegível para o Simples Nacional</h4><p style="font-size:0.88rem;color:var(--text-secondary);">' + (res.regras.vedado ? 'CNAE vedado ao Simples Nacional (Art. 17, LC 123/2006).' : 'Faturamento anual acima de R$ 4.800.000,00.') + '</p></div>'; return; }

            var html = '<h3 style="font-size:1.1rem;font-weight:700;margin-bottom:16px;">Análise Detalhada — Simples Nacional</h3>';
            html += '<div class="info-card"><h4>Enquadramento</h4>';
            html += infoRow('Anexo', 'Anexo ' + s.anexoEfetivo + ' — ' + s.nomeAnexo);
            html += infoRow('Faixa', s.faixa + 'ª faixa');
            html += infoRow('RBT12', formatBRL(s.rbt12));
            if (res.regras.fatorR) html += infoRow('Fator "r"', s.fatorRFormatado + (s.fatorR >= 0.28 ? ' ✅ (≥28% → Anexo III)' : ' ⚠️ (<28% → Anexo V)'));
            html += infoRow('CPP no DAS', s.cppInclusa ? 'Sim' : 'Não (INSS por fora)');
            html += infoRow('Sublimite Estadual', formatBRL(s.sublimiteEstadual) + (s.sublimiteAlerta ? ' ⚠️ ULTRAPASSADO' : ''));
            html += '</div>';

            html += '<div class="info-card"><h4>Composição Mensal</h4>';
            html += infoRow('DAS (Guia Única)', formatBRL(s.das));
            if (s.cppFora > 0) html += infoRow('CPP fora DAS (Anexo IV)', formatBRL(s.cppFora));
            if (s.icmsIssPorFora > 0) html += infoRow('ICMS/ISS por fora (sublimite)', formatBRL(s.icmsIssPorFora));
            html += infoRowTotal('Total Mensal', formatBRL(s.total));
            html += infoRow('Alíquota Efetiva', s.aliqEfetivaFormatada);
            html += '</div>';

            html += '<div class="info-card" style="border-color:rgba(37,99,235,0.15);"><h4>📊 Consolidação Anual</h4>';
            html += '<table class="detail-table"><thead><tr><th>Item</th><th style="text-align:right;">Mensal</th><th style="text-align:right;">Anual</th></tr></thead><tbody>';
            html += tableRow('DAS', s.das, s.das * 12);
            if (s.cppFora > 0) html += tableRow('CPP fora DAS', s.cppFora, s.cppFora * 12);
            if (s.icmsIssPorFora > 0) html += tableRow('ICMS/ISS por fora', s.icmsIssPorFora, s.icmsIssPorFora * 12);
            html += tableRow('TOTAL', s.total, s.total * 12);
            html += '</tbody></table></div>';
            html += '<div style="font-size:0.78rem;color:var(--text-muted);">Base Legal: ' + s.baseLegal + '</div>';
            tab.innerHTML = html;
        }

        // ═══════════════════════════════════════════════════
        //  TAB 3: LUCRO PRESUMIDO
        // ═══════════════════════════════════════════════════
        function renderTabPresumido(res) {
            var tab = $('tabLucroPresumido');
            var p = res.presumido;
            if (!p) { tab.innerHTML = '<p>Dados não disponíveis.</p>'; return; }
            var regras = res.regras, fat = res.faturamentoMensal, folha = res.folhaMensal;
            var baseIRPJ = fat * regras.presuncaoIRPJ, baseCSLL = fat * regras.presuncaoCSLL;

            var html = '<h3 style="font-size:1.1rem;font-weight:700;margin-bottom:16px;">Análise Detalhada — Lucro Presumido</h3>';

            // Presunção
            html += '<div class="info-card"><h4>Percentuais de Presunção</h4>';
            html += infoRow('Atividade', regras.categoria.charAt(0).toUpperCase() + regras.categoria.slice(1) + (regras.nota ? ' (' + regras.nota + ')' : ''));
            html += infoRow('Presunção IRPJ', formatPct(regras.presuncaoIRPJ));
            html += infoRow('Presunção CSLL', formatPct(regras.presuncaoCSLL));
            html += infoRow('Tributo Principal', regras.tipoTributo);
            html += '</div>';

            // IRPJ + CSLL
            html += '<div class="info-card"><h4>IRPJ + CSLL (Mensal)</h4>';
            html += infoRow('Receita Bruta', formatBRL(fat));
            html += infoRow('Base Presumida IRPJ (' + formatPct(regras.presuncaoIRPJ) + ')', formatBRL(baseIRPJ));
            html += infoRow('IRPJ Bruto (15%' + (baseIRPJ > 20000 ? ' + 10% adicional' : '') + ')', formatBRL(p.irpj));
            if (p.irpjReducao > 0) html += '<div class="info-row"><span>(-) Redução ' + p.tipoIncentivo + ' (75%)</span><span style="color:var(--accent);font-family:var(--font-mono);font-weight:600;">-' + formatBRL(p.irpjReducao) + '</span></div>';
            html += infoRowTotal('IRPJ Devido', formatBRL(p.irpjFinal));
            html += '<div style="height:8px;"></div>';
            html += infoRow('Base Presumida CSLL (' + formatPct(regras.presuncaoCSLL) + ')', formatBRL(baseCSLL));
            html += infoRow('CSLL (9%)', formatBRL(p.csll));
            html += '</div>';

            // PIS/COFINS
            html += '<div class="info-card"><h4>PIS/COFINS — Cumulativo</h4>';
            html += infoRow('PIS (0,65%)', formatBRL(p.pis));
            html += infoRow('COFINS (3,00%)', formatBRL(p.cofins));
            html += infoRowTotal('Total PIS + COFINS', formatBRL(p.pis + p.cofins));
            html += '</div>';

            // ISS ou ICMS
            if (p.iss > 0) { html += '<div class="info-card"><h4>ISS</h4>' + infoRow('ISS (' + p.dadosEstadoUsados.issAliquotaPerc + ')', formatBRL(p.iss)) + '</div>'; }
            if (p.icms > 0) {
                html += '<div class="info-card"><h4>ICMS</h4>';
                html += infoRow('ICMS Bruto (' + p.dadosEstadoUsados.icmsAliquotaPerc + ')', formatBRL(fat * p.dadosEstadoUsados.icmsAliquota));
                html += infoRow('ICMS Líquido (após créditos)', formatBRL(p.icms));
                if (p.fecop > 0) html += infoRow('FECOP', formatBRL(p.fecop));
                html += '</div>';
            }

            // Encargos
            html += '<div class="info-card"><h4>Encargos Trabalhistas</h4>';
            html += infoRow('INSS Patronal (20,00%)', formatBRL(folha * 0.20));
            html += infoRow('RAT (2,00%)', formatBRL(folha * 0.02));
            html += infoRow('Terceiros (5,80%)', formatBRL(folha * 0.058));
            html += infoRow('FGTS (8,00%)', formatBRL(p.fgts));
            html += infoRowTotal('Total Encargos', formatBRL(p.cpp + p.fgts));
            html += '</div>';

            // Consolidação Anual
            html += '<div class="info-card" style="border-color:rgba(37,99,235,0.15);"><h4>📊 Consolidação Anual</h4>';
            html += '<table class="detail-table"><thead><tr><th>Tributo</th><th style="text-align:right;">Mensal</th><th style="text-align:right;">Anual</th></tr></thead><tbody>';
            html += tableRow('IRPJ', p.irpjFinal, p.irpjFinal * 12);
            html += tableRow('CSLL', p.csll, p.csll * 12);
            html += tableRow('PIS', p.pis, p.pis * 12);
            html += tableRow('COFINS', p.cofins, p.cofins * 12);
            if (p.iss > 0) html += tableRow('ISS (' + p.dadosEstadoUsados.issAliquotaPerc + ')', p.iss, p.iss * 12);
            if (p.icms > 0) html += tableRow('ICMS (líquido)', p.icms, p.icms * 12);
            if (p.fecop > 0) html += tableRow('FECOP', p.fecop, p.fecop * 12);
            html += tableRow('INSS+RAT+Terceiros (27,80%)', p.cpp, p.cpp * 12);
            html += tableRow('FGTS (8,00%)', p.fgts, p.fgts * 12);
            html += tableRow('CARGA TOTAL', p.total, p.total * 12);
            html += '</tbody></table>';
            html += '<div style="margin-top:8px;font-size:0.82rem;color:var(--text-muted);">Alíquota efetiva: <strong>' + p.aliqEfetivaFormatada + '</strong></div>';
            html += '</div>';

            tab.innerHTML = html;
        }

        // ═══════════════════════════════════════════════════
        //  TAB 4: LUCRO REAL
        // ═══════════════════════════════════════════════════
        function renderTabReal(res) {
            var tab = $('tabLucroReal');
            var r = res.real, fat = res.faturamentoMensal, folha = res.folhaMensal;
            if (!r) { tab.innerHTML = '<p>Dados não disponíveis.</p>'; return; }
            var lucro = fat * r.margemLucroUsada;

            var html = '<h3 style="font-size:1.1rem;font-weight:700;margin-bottom:16px;">Análise Detalhada — Lucro Real</h3>';

            html += '<div class="info-card"><h4>Premissas</h4>';
            html += infoRow('Margem de lucro', formatPct(r.margemLucroUsada));
            html += infoRow('Lucro mensal estimado', formatBRL(lucro));
            html += infoRow('Créditos PIS/COFINS', formatPct(r.creditosPISCOFINSUsado));
            html += '<div style="font-size:0.78rem;color:var(--amber);margin-top:8px;">⚠️ Valores estimados. O Lucro Real depende da contabilidade completa.</div></div>';

            html += '<div class="info-card"><h4>IRPJ + CSLL sobre Lucro Real</h4>';
            html += infoRow('Lucro tributável', formatBRL(lucro));
            html += infoRow('IRPJ Bruto', formatBRL(r.irpj));
            if (r.irpjReducao > 0) html += '<div class="info-row"><span>(-) Redução ' + r.tipoIncentivo + '</span><span style="color:var(--accent);font-family:var(--font-mono);font-weight:600;">-' + formatBRL(r.irpjReducao) + '</span></div>';
            html += infoRowTotal('IRPJ Devido', formatBRL(r.irpjFinal));
            html += infoRow('CSLL (9%)', formatBRL(r.csll));
            html += '</div>';

            html += '<div class="info-card"><h4>PIS/COFINS — Não Cumulativo</h4>';
            html += infoRow('PIS (1,65% c/ créditos)', formatBRL(r.pis));
            html += infoRow('COFINS (7,60% c/ créditos)', formatBRL(r.cofins));
            html += infoRowTotal('Total PIS + COFINS', formatBRL(r.pis + r.cofins));
            html += '</div>';

            if (r.iss > 0) html += '<div class="info-card"><h4>ISS</h4>' + infoRow('ISS', formatBRL(r.iss)) + '</div>';
            if (r.icms > 0) html += '<div class="info-card"><h4>ICMS</h4>' + infoRow('ICMS líquido', formatBRL(r.icms)) + (r.fecop > 0 ? infoRow('FECOP', formatBRL(r.fecop)) : '') + '</div>';

            html += '<div class="info-card"><h4>Encargos</h4>' + infoRow('INSS+RAT+Terceiros (27,80%)', formatBRL(r.cpp)) + infoRow('FGTS (8%)', formatBRL(r.fgts)) + infoRowTotal('Total', formatBRL(r.cpp + r.fgts)) + '</div>';

            // Otimizações
            html += '<div class="info-card" style="border-color:rgba(22,163,74,0.15);"><h4>💡 Otimizações Disponíveis</h4>';
            if (r.otimizacoes.jcpDisponivel) html += infoRow('JCP', '✅ Disponível');
            if (r.otimizacoes.compensacaoPrejuizo) html += infoRow('Compensação Prejuízos', '✅ Até 30%/período');
            if (r.otimizacoes.depreciacaoAcelerada) html += infoRow('Depreciação Acelerada', '✅ Incentivo regional');
            html += infoRow('Créditos PIS/COFINS', '✅ Não cumulativo');
            html += '</div>';

            // Consolidação
            html += '<div class="info-card" style="border-color:rgba(37,99,235,0.15);"><h4>📊 Consolidação Anual</h4>';
            html += '<table class="detail-table"><thead><tr><th>Tributo</th><th style="text-align:right;">Mensal</th><th style="text-align:right;">Anual</th></tr></thead><tbody>';
            html += tableRow('IRPJ', r.irpjFinal, r.irpjFinal * 12);
            html += tableRow('CSLL', r.csll, r.csll * 12);
            html += tableRow('PIS', r.pis, r.pis * 12);
            html += tableRow('COFINS', r.cofins, r.cofins * 12);
            if (r.iss > 0) html += tableRow('ISS', r.iss, r.iss * 12);
            if (r.icms > 0) html += tableRow('ICMS', r.icms, r.icms * 12);
            html += tableRow('Encargos', r.cpp, r.cpp * 12);
            html += tableRow('FGTS', r.fgts, r.fgts * 12);
            html += tableRow('CARGA TOTAL', r.total, r.total * 12);
            html += '</tbody></table></div>';
            tab.innerHTML = html;
        }

        // ═══════════════════════════════════════════════════
        //  TAB 5: TEA (Taxa Efetiva Anual)
        // ═══════════════════════════════════════════════════
        function renderTabTEA(res) {
            var tab = $('tabTEA');
            var fat = res.faturamentoMensal;
            var html = '<h3 style="font-size:1.1rem;font-weight:700;margin-bottom:16px;">📊 Análise TEA — Taxa Efetiva Anual</h3>';

            html += '<div class="info-card"><h4>Comparativo de Alíquotas Efetivas</h4>';
            html += '<table class="detail-table"><thead><tr><th>Regime</th><th style="text-align:right;">Carga Mensal</th><th style="text-align:right;">Carga Anual</th><th style="text-align:right;">Alíquota Efetiva</th><th style="text-align:right;">% do Lucro</th></tr></thead><tbody>';

            var margem = res.real ? res.real.margemLucroUsada : 0.20;
            var lucroMensal = fat * margem;
            res.ranking.forEach(function(r) {
                var pctLucro = lucroMensal > 0 ? r.total / lucroMensal : 0;
                html += '<tr><td>' + r.nome + '</td>';
                html += '<td style="font-family:var(--font-mono);text-align:right;">' + formatBRL(r.total) + '</td>';
                html += '<td style="font-family:var(--font-mono);text-align:right;">' + formatBRL(r.total * 12) + '</td>';
                html += '<td style="font-family:var(--font-mono);text-align:right;">' + formatPct(r.aliqEfetiva) + '</td>';
                html += '<td style="font-family:var(--font-mono);text-align:right;">' + formatPct(pctLucro) + '</td></tr>';
            });
            html += '</tbody></table></div>';

            // Custo por R$ 1.000
            html += '<div class="info-card"><h4>💰 Custo Tributário por R$ 1.000 de Faturamento</h4>';
            res.ranking.forEach(function(r) {
                var custo1k = fat > 0 ? (r.total / fat) * 1000 : 0;
                html += infoRow(r.nome, 'R$ ' + custo1k.toFixed(2).replace('.', ','));
            });
            html += '</div>';

            // Economia acumulada
            if (res.ranking.length >= 2) {
                var melhor = res.ranking[0], pior = res.ranking[res.ranking.length - 1];
                var econMensal = pior.total - melhor.total;
                html += '<div class="info-card" style="border-color:rgba(22,163,74,0.15);"><h4>🏦 Economia Acumulada: ' + melhor.nome + '</h4>';
                html += infoRow('Economia mensal', formatBRL(econMensal));
                html += infoRow('Economia anual', formatBRL(econMensal * 12));
                html += infoRow('Economia em 5 anos', formatBRL(econMensal * 60));
                html += infoRow('Economia em 10 anos', formatBRL(econMensal * 120));
                html += '</div>';
            }

            tab.innerHTML = html;
        }

        // ═══════════════════════════════════════════════════
        //  TAB 6: IMPACTO PESSOAL
        // ═══════════════════════════════════════════════════
        function renderTabPessoal(res) {
            var tab = $('tabPessoal');
            var fat = res.faturamentoMensal;
            var extras = res._extras || {};
            var proLabore = extras.proLabore || 0;
            var numSocios = extras.numSocios || 1;
            var plPorSocio = numSocios > 0 ? proLabore / numSocios : proLabore;

            var html = '<h3 style="font-size:1.1rem;font-weight:700;margin-bottom:16px;">👤 Impacto Pessoal dos Sócios</h3>';

            // INSS do sócio
            var tetoINSS = 908.85; // 2026 estimado
            var inssSocio = Math.min(plPorSocio * 0.11, tetoINSS);
            var irpfPL = calcularIRPF(plPorSocio - inssSocio);

            html += '<div class="info-card"><h4>Pró-labore por Sócio</h4>';
            html += infoRow('Pró-labore bruto', formatBRL(plPorSocio));
            html += infoRow('INSS Sócio (11% até teto)', formatBRL(inssSocio));
            html += infoRow('Base IRPF', formatBRL(plPorSocio - inssSocio));
            html += infoRow('IRPF Retido', formatBRL(irpfPL));
            html += infoRowTotal('Pró-labore líquido', formatBRL(plPorSocio - inssSocio - irpfPL));
            html += '</div>';

            // Distribuição de lucros por regime
            html += '<div class="info-card"><h4>💰 Estimativa de Distribuição de Lucros (Mensal)</h4>';
            html += '<table class="detail-table"><thead><tr><th>Regime</th><th style="text-align:right;">Lucro Distribuível</th><th style="text-align:right;">Por Sócio</th><th style="text-align:right;">Isento IR?</th></tr></thead><tbody>';

            res.ranking.forEach(function(r) {
                var lucro = fat - r.total - (extras.cmv || 0) - (extras.despesas || 0);
                if (lucro < 0) lucro = 0;
                var porSocio = numSocios > 0 ? lucro / numSocios : lucro;
                html += '<tr><td>' + r.nome + '</td>';
                html += '<td style="font-family:var(--font-mono);text-align:right;">' + formatBRL(lucro) + '</td>';
                html += '<td style="font-family:var(--font-mono);text-align:right;">' + formatBRL(porSocio) + '</td>';
                html += '<td style="text-align:right;">✅ Isento</td></tr>';
            });
            html += '</tbody></table>';
            html += '<div style="font-size:0.78rem;color:var(--text-muted);margin-top:8px;">Lucros distribuídos a sócios são isentos de IR na pessoa física (Lei 9.249/95, Art. 10). Estimativa: Faturamento - Tributos - CMV - Despesas.</div>';
            html += '</div>';

            // Bolso total
            html += '<div class="info-card" style="border-color:rgba(22,163,74,0.15);"><h4>🏦 No Bolso do Sócio — Resumo Mensal</h4>';
            res.ranking.forEach(function(r) {
                var lucro = fat - r.total - (extras.cmv || 0) - (extras.despesas || 0);
                if (lucro < 0) lucro = 0;
                var porSocio = numSocios > 0 ? lucro / numSocios : lucro;
                var plLiq = plPorSocio - inssSocio - irpfPL;
                var totalBolso = plLiq + porSocio;
                html += infoRow(r.nome + ' → no bolso', formatBRL(totalBolso) + '/mês (' + formatBRL(totalBolso * 12) + '/ano)');
            });
            html += '</div>';

            tab.innerHTML = html;
        }

        function calcularIRPF(base) {
            if (base <= 2259.20) return 0;
            if (base <= 2826.65) return base * 0.075 - 169.44;
            if (base <= 3751.05) return base * 0.15 - 381.44;
            if (base <= 4664.68) return base * 0.225 - 662.77;
            return base * 0.275 - 896.00;
        }

        // ═══════════════════════════════════════════════════
        //  TAB 7: REFORMA TRIBUTÁRIA
        // ═══════════════════════════════════════════════════
        function renderTabReforma(res) {
            var tab = $('tabReforma');
            // Tentar usar módulo ReformaTributaria se disponível
            if (typeof ReformaTributaria !== 'undefined' && ReformaTributaria.render) {
                try {
                    ReformaTributaria.render({
                        faturamento: res.faturamentoMensal,
                        folha: res.folhaMensal,
                        uf: res.uf,
                        regime: res.melhorRegimeId || 'presumido',
                        cnaeCode: res.cnae || '',
                        cnaeCat: res.regras.categoria || '',
                        issRate: res.presumido ? res.presumido.dadosEstadoUsados.issAliquota : 0.05,
                        ES: window.Estados || null,
                        containerID: 'tabReforma'
                    });
                    return;
                } catch (e) { console.warn('[Reforma] Erro:', e); }
            }

            // Fallback
            var html = '<h3 style="font-size:1.1rem;font-weight:700;margin-bottom:16px;">📜 Reforma Tributária (LC 214/2025)</h3>';
            html += '<div class="info-card"><h4>IBS + CBS substituirão ICMS, ISS, PIS, COFINS e IPI</h4>';
            html += infoRow('Período de transição', '2026 – 2033');
            html += infoRow('Alíquota IBS+CBS estimada', '~26,5%');
            html += infoRow('Impacto no Simples', 'Optantes podem manter regime atual, mas sem créditos para compradores');
            html += infoRow('Impacto LP/LR', 'IVA não cumulativo com créditos amplos');
            html += '</div>';
            html += '<div class="info-card"><h4>Cronograma</h4>';
            html += infoRow('2026', 'CBS 0,9% e IBS 0,1% (teste)');
            html += infoRow('2027', 'CBS integral, PIS/COFINS extintos');
            html += infoRow('2029-2032', 'IBS gradual, ICMS/ISS diminuem');
            html += infoRow('2033', 'IBS integral, ICMS/ISS extintos');
            html += '</div>';
            tab.innerHTML = html;
        }

        // ═══════════════════════════════════════════════════
        //  TAB 8: PROJEÇÕES
        // ═══════════════════════════════════════════════════
        function renderTabProjecoes(res) {
            var tab = $('tabProjecoes');
            var fat = res.faturamentoMensal;
            var cresc = res._extras ? res._extras.crescimento : 0.10;
            var meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];

            var html = '<h3 style="font-size:1.1rem;font-weight:700;margin-bottom:16px;">📈 Projeção 12 Meses (Crescimento: ' + formatPct(cresc) + ')</h3>';

            // Calcular projeção
            var projecao = [];
            var maxFat = 0;
            for (var i = 0; i < 12; i++) {
                var fator = 1 + cresc * (i / 12);
                var fatMes = Math.round(fat * fator);
                if (fatMes > maxFat) maxFat = fatMes;
                projecao.push({ mes: meses[i], faturamento: fatMes });
            }

            // Barras de projeção
            projecao.forEach(function(p) {
                var pctW = maxFat > 0 ? (p.faturamento / maxFat) * 100 : 0;
                var rbt12 = p.faturamento * 12;
                var corBarra = rbt12 > 4800000 ? 'var(--red)' : rbt12 > 3600000 ? 'var(--amber)' : 'var(--accent)';
                html += '<div class="proj-month">';
                html += '<span class="proj-label">' + p.mes + '</span>';
                html += '<div class="proj-bar-track"><div class="proj-bar-fill" style="width:' + pctW + '%;background:' + corBarra + ';"></div></div>';
                html += '<span class="proj-value">' + formatBRL(p.faturamento) + '</span>';
                html += '</div>';
            });

            // Alerta se ultrapassa limite
            var fatFinal = projecao[11].faturamento;
            if (fatFinal * 12 > 4800000) {
                html += '<div class="proj-alert">⚠️ Com crescimento de ' + formatPct(cresc) + ', o faturamento projetado de ' + formatBRL(fatFinal) + '/mês (RBT12 ' + formatBRL(fatFinal * 12) + ') ultrapassará o limite do Simples Nacional em R$ 4.800.000/ano.</div>';
            }

            // Regime melhor em cada faixa
            html += '<div class="info-card" style="margin-top:20px;"><h4>Regime ideal por faixa de faturamento</h4>';
            html += '<table class="detail-table"><thead><tr><th>Mês</th><th style="text-align:right;">Faturamento</th><th>Regime Ideal</th><th style="text-align:right;">Carga</th></tr></thead><tbody>';
            [0, 3, 6, 9, 11].forEach(function(i) {
                var p = projecao[i];
                if (CR) {
                    var r = CR.comparar({
                        faturamentoMensal: p.faturamento,
                        folhaMensal: res.folhaMensal,
                        cnae: res.cnae, categoria: res.regras.categoria,
                        uf: res.uf
                    });
                    html += '<tr><td>' + p.mes + '</td><td style="font-family:var(--font-mono);text-align:right;">' + formatBRL(p.faturamento) + '</td><td>' + r.melhorRegime + '</td><td style="font-family:var(--font-mono);text-align:right;">' + formatBRL(r.cargaMenorMensal) + '</td></tr>';
                }
            });
            html += '</tbody></table></div>';

            tab.innerHTML = html;
        }

        // ═══════════════════════════════════════════════════
        //  TAB 9: CENÁRIOS
        // ═══════════════════════════════════════════════════
        function renderTabCenarios(res) {
            var container = $('cenariosResultado');
            if (!container || !CR) return;

            var fat = res.faturamentoMensal;
            var variacoes = [-30, -15, 0, 15, 30, 50, 100];

            var html = '<div class="cenarios-header-row"><span>Variação</span><span>Faturamento</span><span>Regime Ideal</span><span>Carga/mês</span></div>';

            variacoes.forEach(function(v) {
                var fatCen = Math.round(fat * (1 + v / 100));
                var r = CR.comparar({
                    faturamentoMensal: fatCen,
                    folhaMensal: res.folhaMensal * (1 + v / 200), // folha cresce metade
                    cnae: res.cnae, categoria: res.regras.categoria, uf: res.uf
                });

                var varClass = v === 0 ? 'neutra' : v > 0 ? 'positiva' : 'negativa';
                var isAtual = v === 0;
                var regClass = r.melhorRegimeId === 'simples' ? 'simples' : r.melhorRegimeId === 'presumido' ? 'presumido' : 'lucro_real';

                html += '<div class="cenario-variacao' + (isAtual ? ' cenario-atual' : '') + '">';
                html += '<span class="cv-variacao ' + varClass + '">' + (v >= 0 ? '+' : '') + v + '%</span>';
                html += '<span class="cv-faturamento">Faturamento: <span>' + formatBRL(fatCen) + '</span></span>';
                html += '<span class="cv-regime ' + regClass + '">' + r.melhorRegime + '</span>';
                html += '<span class="cv-carga">' + formatBRL(r.cargaMenorMensal) + '</span>';
                html += '</div>';
            });

            html += '<div class="comparador-badge">🔧 Motor: <code>ComparadorRegimes v' + (CR.VERSAO || '3.0') + '</code></div>';

            container.innerHTML = html;
        }

        // ═══════════════════════════════════════════════════
        //  INICIAR
        // ═══════════════════════════════════════════════════
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    })();
    </script>
</body>
</html>
